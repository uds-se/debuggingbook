
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Learning from Failures &#8212; The Debugging Book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=d5c2cecb" />
    <link rel="stylesheet" type="text/css" href="_static/mastodon-timeline.css?v=f82c2b23" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Alhazen';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Debugging Performance Issues" href="PerformanceDebugger.html" />
    <link rel="prev" title="Generalizing Failure Circumstances" href="DDSetDebugger.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content"><p>This is a beta version of debuggingbook.org, currently in development. See the <a href="https://debuggingbook.org/classic/"  style="color:white!important;">classic site</a> for the 2024 version.</p></div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/debuggingbook.png" class="logo__image only-light" alt="The Debugging Book - Home"/>
    <script>document.write(`<img src="_static/debuggingbook.png" class="logo__image only-dark" alt="The Debugging Book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    The Debugging Book
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tours.html">Sitemap</a></li>
<li class="toctree-l1"><a class="reference internal" href="Intro_Debugging.html">Introduction to Debugging</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Observing Executions</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tracer.html">Tracing Executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="Debugger.html">How Debuggers Work</a></li>
<li class="toctree-l1"><a class="reference internal" href="Assertions.html">Asserting Expectations</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Flows and Dependencies</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Slicer.html">Tracking Failure Origins</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Reducing Failure Causes</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="DeltaDebugger.html">Reducing Failure-Inducing Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ChangeDebugger.html">Isolating Failure-Inducing Changes</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Abstracting Failures</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="StatisticalDebugger.html">Statistical Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="DynamicInvariants.html">Mining Function Specifications</a></li>
<li class="toctree-l1"><a class="reference internal" href="DDSetDebugger.html">Generalizing Failure Circumstances</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Learning from Failures</a></li>
<li class="toctree-l1"><a class="reference internal" href="PerformanceDebugger.html">Debugging Performance Issues</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Automatic Repair</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Repairer.html">Repairing Code Automatically</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Debugging in the Large</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tracking.html">Tracking Bugs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ChangeCounter.html">Where the Bugs are</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ExpectError.html">Error Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timer.html">Timer</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timeout.html">Timeout</a></li>
<li class="toctree-l1"><a class="reference internal" href="ClassDiagram.html">Class Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="StackInspector.html">Inspecting Call Stacks</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">About This Book</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ReleaseNotes.html">Release Notes for The Debugging Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="Importing.html">Downloads and Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Guide_for_Authors.html">Guide for Authors</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/uds-se/debuggingbook/master?urlpath=tree/docs/notebooks/Alhazen.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/uds-se/debuggingbook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/uds-se/debuggingbook/issues/new?title=Issue%20on%20page%20%2FAlhazen.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
    <li><a href="../code/Alhazen.py" target="_blank"
       class="btn btn-sm btn-download-source-button dropdown-item"
       title="Download Python code"
       data-bs-placement="left" data-bs-toggle="tooltip"
    >
  

    <span class="btn__icon-container">
      <i class="fas fa-file"></i>
      </span>
    <span class="btn__text-container">.py</span>
    </a>
    </li>
    
      
      
      
      <li><a href="_sources/Alhazen.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download notebook"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  
    <li><a href="Importing.html" target="_blank"
       class="btn btn-sm btn-download-source-button dropdown-item"
       title="All downloads"
       data-bs-placement="left" data-bs-toggle="tooltip"
    >
  

    <span class="btn__icon-container">
      <i class="fas fa-file"></i>
      </span>
    <span class="btn__text-container">All downloads</span>
    </a>
    </li>
    </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Learning from Failures</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#machine-learning-for-automated-debugging">Machine Learning for Automated Debugging</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-alhazen-approach">The Alhazen Approach</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#structure-of-this-chapter">Structure of this Chapter</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#inputs-and-grammars">Inputs and Grammars</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-extracting-features">Step 1: Extracting Features</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#internal-and-friendly-feature-names">Internal and “Friendly” Feature Names</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implementing-feature-classes">Implementing Feature Classes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-feature-sets-from-grammars">Extracting Feature Sets from Grammars</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-feature-values-from-inputs">Extracting Feature Values from Inputs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-transforming-grammars">Excursion: Transforming Grammars</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#end-of-excursion">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-train-classification-model">Step 2: Train Classification Model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decision-trees">Decision Trees</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-a-decision-tree">Learning a Decision Tree</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-extract-feature-requirements">Step 3: Extract Feature Requirements</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-tree-helper-functions">Excursion: Tree helper functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-converting-trees-to-paths">Excursion: Converting Trees to Paths</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-4-generating-new-samples">Step 4: Generating New Samples</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#negating-requirements">Negating Requirements</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#systematically-negating-paths">Systematically Negating Paths</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#input-specification-parser">Input Specification Parser</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-validating-the-parser">Excursion: Validating the Parser</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#retrieving-new-input-specifications">Retrieving New input Specifications</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-testing-specifications">Excursion: Testing Specifications</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-some-tests">Excursion: Some Tests</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-5-executing-new-inputs">Step 5: Executing New Inputs</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-alhazen-class">The Alhazen Class</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-sample-run">A Sample Run</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="learning-from-failures">
<h1>Learning from Failures<a class="headerlink" href="#learning-from-failures" title="Link to this heading">#</a></h1>
<p>Given the many executions we can generate, it is only natural that these executions would also be subject to <em>machine learning</em> in order to learn which features of the input (or the execution) would be associated with failures.</p>
<p>In this chapter, we study the <em>Alhazen</em> approach, one of the first of this kind.
Alhazen by Kampmann et al. \cite{Kampmann2020} automatically learns the associations between the failure of a program and <em>features of the input data</em>, say “The error occurs whenever the <code class="docutils literal notranslate"><span class="pre">&lt;expr&gt;</span></code> element is negative”</p>
<p>This chapter is based on an Alhazen implementation contributed by <a class="reference external" href="https://martineberlein.github.io">Martin Eberlein</a> of TU Berlin. Thanks a lot, Martin!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># from bookutils import YouTubeVideo</span>
<span class="c1"># YouTubeVideo(&quot;w4u5gCgPlmg&quot;)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Prerequisites</strong></p>
<ul class="simple">
<li><p>This chapter extends the ideas from <a class="reference internal" href="DDSetDebugger.html"><span class="std std-doc">the chapter on Generalizing Failure Circumstances</span></a>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">bookutils.setup</span>
</pre></div>
</div>
</div>
</div>
<section id="synopsis">
<h2>Synopsis<a class="headerlink" href="#synopsis" title="Link to this heading">#</a></h2>
<p>To <a class="reference internal" href="Importing.html"><span class="std std-doc">use the code provided in this chapter</span></a>, write</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">debuggingbook.Alhazen</span><span class="w"> </span><span class="kn">import</span> <span class="o">&lt;</span><span class="n">identifier</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>and then make use of the following features.</p>
<p><strong>Note</strong>: The examples in this section only work after the rest of the cells have been executed.</p>
<p>This chapter provides an implementation of the <em>Alhazen</em> approach \cite{Kampmann2020}, which trains machine learning <em>classifiers</em> from input features.
Given a test function, a grammar, and a set of inputs, the <code class="docutils literal notranslate"><span class="pre">Alhazen</span></code> class produces a decision tree that <em>characterizes failure circumstances</em>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">alhazen</span> <span class="o">=</span> <span class="n">Alhazen</span><span class="p">(</span><span class="n">sample_runner</span><span class="p">,</span> <span class="n">CALC_GRAMMAR</span><span class="p">,</span> <span class="n">initial_sample_list</span><span class="p">,</span>
                  <span class="n">max_iterations</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">alhazen</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The final decision tree can be accessed using <code class="docutils literal notranslate"><span class="pre">last_tree()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># alhazen.last_tree()</span>
</pre></div>
</div>
</div>
</div>
<p>We can visualize the resulting decision tree using <code class="docutils literal notranslate"><span class="pre">Alhazen.show_decision_tree()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">alhazen</span><span class="o">.</span><span class="n">show_decision_tree</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b44f3247b3c6beb1c392638ac8d4aa8cdd09f11a49c9c3c980ac7594055b5e3c.svg" src="_images/b44f3247b3c6beb1c392638ac8d4aa8cdd09f11a49c9c3c980ac7594055b5e3c.svg" />
</div>
</div>
<p>A decision tree is read from top to bottom.
Decision nodes (with two children) come with a <em>predicate</em> on top.
This predicate is either</p>
<ul class="simple">
<li><p><em>numeric</em>, such as <code class="docutils literal notranslate"><span class="pre">&lt;value&gt;</span> <span class="pre">&gt;</span> <span class="pre">20</span></code>, indicating the numeric value of the given symbol, or</p></li>
<li><p><em>existential</em>, such as <code class="docutils literal notranslate"><span class="pre">&lt;digit&gt;</span> <span class="pre">==</span> <span class="pre">'1'</span></code>, which has a <em>negative</em> value when False, and a <em>positive</em> value when True.</p></li>
</ul>
<p>If the predicate evaluates to <code class="docutils literal notranslate"><span class="pre">True</span></code>, follow the left path; if it evaluates to <code class="docutils literal notranslate"><span class="pre">False</span></code>, follow the right path.
A leaf node (no children) will give you the final decision <code class="docutils literal notranslate"><span class="pre">class</span> <span class="pre">=</span> <span class="pre">BUG</span></code> or <code class="docutils literal notranslate"><span class="pre">class</span> <span class="pre">=</span> <span class="pre">NO_BUG</span></code>.</p>
<p>So if the predicate states <code class="docutils literal notranslate"><span class="pre">&lt;function&gt;</span> <span class="pre">==</span> <span class="pre">'sqrt'</span> <span class="pre">&lt;=</span> <span class="pre">0.5</span></code>, this means that</p>
<ul class="simple">
<li><p>If the function is <em>not</em> <code class="docutils literal notranslate"><span class="pre">sqrt</span></code> (the predicate <code class="docutils literal notranslate"><span class="pre">&lt;function&gt;</span> <span class="pre">==</span> <span class="pre">'sqrt'</span></code> is negative, see above, and hence less than 0.5), follow the left (<code class="docutils literal notranslate"><span class="pre">True</span></code>) path.</p></li>
<li><p>If the function <em>is</em> <code class="docutils literal notranslate"><span class="pre">sqrt</span></code> (the predicate <code class="docutils literal notranslate"><span class="pre">&lt;function&gt;</span> <span class="pre">==</span> <span class="pre">'sqrt'</span></code> is positive), follow the right (<code class="docutils literal notranslate"><span class="pre">False</span></code>) path.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">samples</span></code> field shows the number of sample inputs that contributed to this decision.
The <code class="docutils literal notranslate"><span class="pre">gini</span></code> field (aka Gini impurity) indicates how many samples fall into the displayed class (<code class="docutils literal notranslate"><span class="pre">BUG</span></code> or <code class="docutils literal notranslate"><span class="pre">NO_BUG</span></code>).
A <code class="docutils literal notranslate"><span class="pre">gini</span></code> value of <code class="docutils literal notranslate"><span class="pre">0.0</span></code> means <em>purity</em> - all samples fall into the displayed class.
The <em>saturation</em> of nodes also indicates purity – the higher the saturation, the higher the purity.</p>
<p>There is also a text version available, with much fewer (but hopefully still essential) details:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">alhazen</span><span class="o">.</span><span class="n">friendly_decision_tree</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>if &lt;lead-digit&gt; &lt;= 3.5000:
  if &lt;function&gt; == &#39;sqrt&#39;:
    if &lt;term&gt; &lt;= -11.5000:
      if &lt;value&gt; &lt;= 81.5200:
        BUG
      else:
        NO_BUG
    else:
      NO_BUG
  else:
    NO_BUG
else:
  if &lt;lead-digit&gt; == &#39;4&#39;:
    if &lt;value&gt; &lt;= 41.9500:
      if &lt;function&gt; == &#39;sqrt&#39;:
        if &lt;term&gt; == &#39;-&lt;value&gt;&#39;:
          BUG
        else:
          NO_BUG
      else:
        NO_BUG
    else:
      NO_BUG
  else:
    NO_BUG
</pre></div>
</div>
</div>
</div>
<p>In both representations, we see that the present failure is associated with a negative value for the <code class="docutils literal notranslate"><span class="pre">sqrt</span></code> function and precise boundaries for its value.
In fact, the error conditions are given in the source code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">task_sqrt</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>def task_sqrt(x):
    &quot;&quot;&quot;Computes the square root of x, using the Newton-Raphson method&quot;&quot;&quot;
    if x &lt;= -12 and x &gt;= -42:
        x = 0  # Guess where the bug is :-)
    else:
        x = 1
    x = max(x, 0)
    approx = None
    guess = x / 2
    while approx != guess:
        approx = guess
        guess = (approx + x / approx) / 2
    return approx
</pre></div>
</div>
</div>
</div>
<p>Try out Alhazen on your own code and your own examples!</p>
</section>
<section id="machine-learning-for-automated-debugging">
<h2>Machine Learning for Automated Debugging<a class="headerlink" href="#machine-learning-for-automated-debugging" title="Link to this heading">#</a></h2>
<p>When diagnosing why a program fails, the first step is to determine the circumstances under which the program fails.
In past chapters, we have examined approaches that <a class="reference internal" href="StatisticalDebugger.html"><span class="std std-doc">correlate execution features with failures</span></a>
as well as tools that systematically <em>generate inputs</em> to <a class="reference internal" href="DeltaDebugger.html"><span class="std std-doc">reduce failure-inducing inputs</span></a> or <a class="reference internal" href="DDSetDebugger.html"><span class="std std-doc">generalize failure circumstances</span></a>.
In this chapter, we will go one step further and make use of full-fledged <em>machine learning</em> to identify failure circumstances (and causes).</p>
<section id="the-alhazen-approach">
<h3>The Alhazen Approach<a class="headerlink" href="#the-alhazen-approach" title="Link to this heading">#</a></h3>
<p>In 2020, Kampmann et al. \cite{Kampmann2020} presented one of the first approaches to automatically learn circumstances of (failing) program behavior.
Their approach associates the program’s failure with the <em>syntactical features</em> of the input data, allowing them to learn and extract the properties that result in the specific behavior.</p>
<p>Their reference implementation <em>Alhazen</em> can generate a diagnosis and explain why, for instance, a particular bug occurs.
Alhazen forms a hypothetical model based on the observed inputs.
Additional test inputs are generated and executed to refine or refute the hypothesis, eventually obtaining a prediction model of the circumstances of why the behavior in question takes place.</p>
<p>The tool is named after <a class="reference external" href="https://en.wikipedia.org/wiki/Ibn_al-Haytham">Ḥasan Ibn al-Haytham</a> (latinized name: Alhazen).
Often referred to as the “Father of modern optics”, Ibn al-Haytham made significant contributions to the principles of optics and visual perception.
Most notably, he was an early proponent of the concept that a hypothesis must be supported by experiments, and thus
one of the inventors of the <em>scientific method</em>, the key process in the Alhazen tool.</p>
<p><img alt="title" src="_images/Alhazen.png" /></p>
<p>Let us give a high-level description of how Alhazen works, illustrated above.</p>
<p>Alhazen is given an <em>input grammar</em> and a number of <em>input files</em> (whose format is given by the grammar),
and produces a <em>decision tree</em> – a machine learning model that explains under which circumstances the program fails.</p>
<p>Alhazen determines and refines these decision trees in five steps:</p>
<ol class="arabic simple">
<li><p>For each input file, Alhazen extracts a number of <em>input features</em> that apply.
These input features are predicates over the individual elements of the input grammar, such as <code class="docutils literal notranslate"><span class="pre">&lt;expr&gt;</span> <span class="pre">&gt;</span> <span class="pre">0</span></code> (an <code class="docutils literal notranslate"><span class="pre">&lt;expr&gt;</span></code> element is larger than zero) or <code class="docutils literal notranslate"><span class="pre">exists(&lt;minus-sign&gt;)</span></code> (the input contains a minus sign).</p></li>
<li><p>The test outcomes of the input files <em>label</em> these input files as <em>buggy</em> or <em>non-buggy</em>.
From the respective input features and the labels, Alhazen trains a <em>decision tree</em> that associates these features with the labels - that is, the decision tree explains which features lead to <em>buggy</em> or <em>non-buggy</em>.</p></li>
<li><p>As it is typically trained on few samples only, the initial classification model may be imprecise.
Hence, Alhazen extracts further <em>requirements</em> for additional test cases that may help in increasing precision, such as <code class="docutils literal notranslate"><span class="pre">&lt;digit&gt;</span> <span class="pre">==</span> <span class="pre">'6'</span></code> (we need more inputs in which the <code class="docutils literal notranslate"><span class="pre">&lt;digit&gt;</span></code> field has a value of <code class="docutils literal notranslate"><span class="pre">6</span></code>.)</p></li>
<li><p>Satisfying these requirements, Alhazen then generates additional inputs…</p></li>
<li><p>…which it executes, thus again labeling them as <em>buggy</em> or <em>non-buggy</em>.
From the new inputs, we can again extract the features, and repeat the cycle.</p></li>
</ol>
<p>The whole process keeps on refining decision trees with more and more inputs.
Eventually, the decision trees are supposed to be precise enough that they can become <em>theory</em> - that is, an explanation of why the program fails with high predictive power for future inputs.</p>
<p>The Alhazen process thus automates the <em>scientific method of debugging</em>:</p>
<ul class="simple">
<li><p>making initial <em>observations</em> (Steps 1 and 2),</p></li>
<li><p>coming up with <em>hypotheses</em> that explain the observations (Step 3),</p></li>
<li><p>designing <em>experiments</em> to further <em>support</em> or <em>refute</em> the hypotheses (Steps 4 and 5),</p></li>
<li><p>and repeating the entire process until we have a <em>predicting theory</em> on why the program fails.</p></li>
</ul>
</section>
<section id="structure-of-this-chapter">
<h3>Structure of this Chapter<a class="headerlink" href="#structure-of-this-chapter" title="Link to this heading">#</a></h3>
<p>In the remainder of this chapter, we will first introduce <a class="reference internal" href="#Inputs-and-Grammars"><span class="xref myst">grammars</span></a>.</p>
<p>We then explore and implement the individual steps of Alhazen:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#Step-1:-Extracting-Features"><span class="xref myst">Step 1: Extracting Features</span></a></p></li>
<li><p><a class="reference internal" href="#Step-2:-Train-Classification-Model"><span class="xref myst">Step 2: Train Classification Model</span></a></p></li>
<li><p><a class="reference internal" href="#Step-3:-Extract-Feature-Requirements"><span class="xref myst">Step 3: Extract Feature Requirements</span></a></p></li>
<li><p><a class="reference internal" href="#Step-4:-Generating-New-Samples"><span class="xref myst">Step 4: Generating New Samples</span></a></p></li>
<li><p><a class="reference internal" href="#Step-5:-Generating-New-Inputs"><span class="xref myst">Step 5: Executing New Inputs</span></a></p></li>
</ul>
<p>After this is done, we can compose all these into a single <code class="docutils literal notranslate"><span class="pre">Alhazen</span></code> class and <a class="reference internal" href="#A-Sample-Run"><span class="xref myst">run it on a sample input</span></a>.
If you want to see Alhazen in action first (before going into all the details, check out the sample run.)</p>
</section>
</section>
<section id="inputs-and-grammars">
<h2>Inputs and Grammars<a class="headerlink" href="#inputs-and-grammars" title="Link to this heading">#</a></h2>
<p>Alhazen heavily builds on <em>grammars</em> as a means to decompose inputs into individual elements, such that it can reason about these elements, and also generate new ones automatically.</p>
<p>To work with grammars, we use the framework provided by <a class="reference external" href="https://www.fuzzingbook.org">The Fuzzing Book</a>.
For a more detailed description of Grammars and how to use them for production, have a look at the chapter <a class="reference external" href="https://www.fuzzingbook.org/html/Grammars.html">“Fuzzing with Grammars”</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">fuzzingbook.Grammars</span><span class="w"> </span><span class="kn">import</span> <span class="n">Grammar</span><span class="p">,</span> <span class="n">EXPR_GRAMMAR</span><span class="p">,</span> <span class="n">reachable_nonterminals</span><span class="p">,</span> <span class="n">is_valid_grammar</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fuzzingbook.GrammarFuzzer</span><span class="w"> </span><span class="kn">import</span> <span class="n">GrammarFuzzer</span><span class="p">,</span> <span class="n">expansion_to_children</span><span class="p">,</span> <span class="n">DerivationTree</span><span class="p">,</span> <span class="n">tree_to_string</span><span class="p">,</span> <span class="n">display_tree</span><span class="p">,</span> <span class="n">is_nonterminal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fuzzingbook.Parser</span><span class="w"> </span><span class="kn">import</span> <span class="n">EarleyParser</span>
</pre></div>
</div>
</div>
</div>
<p>Let us build a simple grammar for a calculator.
The calculator code is listed below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">tan</span> <span class="k">as</span> <span class="n">rtan</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">cos</span> <span class="k">as</span> <span class="n">rcos</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">sin</span> <span class="k">as</span> <span class="n">rsin</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This file contains the code under test for the example bug.</span>
<span class="sd">The sqrt() method fails on x &lt;= 0.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="k">def</span><span class="w"> </span><span class="nf">task_sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes the square root of x, using the Newton-Raphson method&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">12</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">42</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Guess where the bug is :-)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">approx</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">guess</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">while</span> <span class="n">approx</span> <span class="o">!=</span> <span class="n">guess</span><span class="p">:</span>
        <span class="n">approx</span> <span class="o">=</span> <span class="n">guess</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="p">(</span><span class="n">approx</span> <span class="o">+</span> <span class="n">x</span> <span class="o">/</span> <span class="n">approx</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">approx</span>


<span class="k">def</span><span class="w"> </span><span class="nf">task_tan</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">rtan</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">task_cos</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">rcos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">task_sin</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">rsin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The language consists of functions (<code class="docutils literal notranslate"><span class="pre">&lt;function&gt;</span></code>) that are being invoked on a numerical value (<code class="docutils literal notranslate"><span class="pre">&lt;term&gt;</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CALC_GRAMMAR</span><span class="p">:</span> <span class="n">Grammar</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;&lt;function&gt;(&lt;term&gt;)&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;function&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;sqrt&quot;</span><span class="p">,</span> <span class="s2">&quot;tan&quot;</span><span class="p">,</span> <span class="s2">&quot;cos&quot;</span><span class="p">,</span> <span class="s2">&quot;sin&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;term&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;-&lt;value&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;value&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;value&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;&lt;integer&gt;.&lt;digits&gt;&quot;</span><span class="p">,</span>
         <span class="s2">&quot;&lt;integer&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;integer&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;&lt;lead-digit&gt;&lt;digits&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;digit&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;digits&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;&lt;digit&gt;&lt;digits&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;digit&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;lead-digit&gt;&quot;</span><span class="p">:</span>  <span class="c1"># First digit cannot be zero</span>
        <span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span> <span class="s2">&quot;6&quot;</span><span class="p">,</span> <span class="s2">&quot;7&quot;</span><span class="p">,</span> <span class="s2">&quot;8&quot;</span><span class="p">,</span> <span class="s2">&quot;9&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;digit&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span> <span class="s2">&quot;6&quot;</span><span class="p">,</span> <span class="s2">&quot;7&quot;</span><span class="p">,</span> <span class="s2">&quot;8&quot;</span><span class="p">,</span> <span class="s2">&quot;9&quot;</span><span class="p">],</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>We see that the <code class="docutils literal notranslate"><span class="pre">CALC_GRAMMAR</span></code> consists of several production rules. The calculator subject will only accept inputs that conform to this grammar definition.</p>
<p>Let us load two initial input samples:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sqrt(-16)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sqrt(4)</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load initial input files</span>
<span class="n">initial_sample_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sqrt(-16)&#39;</span><span class="p">,</span> <span class="s1">&#39;sqrt(4)&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s execute our two input samples and observe the calculator’s behavior.
We implement the function <code class="docutils literal notranslate"><span class="pre">sample_runner(sample)</span></code> that lets us execute the calculator for a single sample. <code class="docutils literal notranslate"><span class="pre">sample_runner(sample)</span></code> returns an <code class="docutils literal notranslate"><span class="pre">OracleResult</span></code> for the sample.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">OracleResult</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">BUG</span> <span class="o">=</span> <span class="s2">&quot;BUG&quot;</span>
    <span class="n">NO_BUG</span> <span class="o">=</span> <span class="s2">&quot;NO_BUG&quot;</span>
    <span class="n">UNDEF</span> <span class="o">=</span> <span class="s2">&quot;UNDEF&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">SUBJECT</span> <span class="o">=</span> <span class="s2">&quot;calculator&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">sample_runner</span><span class="p">(</span><span class="n">sample</span><span class="p">):</span>
    <span class="n">testcode</span> <span class="o">=</span> <span class="n">sample</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Simply execute the calculator code, with the functions replaced</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">testcode</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;sqrt&quot;</span><span class="p">:</span> <span class="n">task_sqrt</span><span class="p">,</span> <span class="s2">&quot;tan&quot;</span><span class="p">:</span> <span class="n">task_tan</span><span class="p">,</span> <span class="s2">&quot;sin&quot;</span><span class="p">:</span> <span class="n">task_sin</span><span class="p">,</span> <span class="s2">&quot;cos&quot;</span><span class="p">:</span> <span class="n">task_cos</span><span class="p">},</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="n">OracleResult</span><span class="o">.</span><span class="n">NO_BUG</span>
    <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">OracleResult</span><span class="o">.</span><span class="n">BUG</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">OracleResult</span><span class="o">.</span><span class="n">UNDEF</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s test the function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample</span> <span class="o">=</span> <span class="s2">&quot;sqrt(-16)&quot;</span>
<span class="n">sample_runner</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;OracleResult.BUG: &#39;BUG&#39;&gt;
</pre></div>
</div>
</div>
</div>
<p>As expected, the sample <code class="docutils literal notranslate"><span class="pre">sqrt(-16)</span></code> triggers the calculator bug. Let’s try some more samples:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">sample_runner</span><span class="p">(</span><span class="s2">&quot;sqrt(-23)&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">OracleResult</span><span class="o">.</span><span class="n">BUG</span>
<span class="k">assert</span> <span class="n">sample_runner</span><span class="p">(</span><span class="s2">&quot;sqrt(44)&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">OracleResult</span><span class="o">.</span><span class="n">NO_BUG</span>
<span class="k">assert</span> <span class="n">sample_runner</span><span class="p">(</span><span class="s2">&quot;cos(-9)&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">OracleResult</span><span class="o">.</span><span class="n">NO_BUG</span>
</pre></div>
</div>
</div>
</div>
<p>What happens if we parse inputs to calculator that do not conform to its input format?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample_runner</span><span class="p">(</span><span class="s2">&quot;undef_function(QUERY)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>name &#39;undef_function&#39; is not defined
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;OracleResult.UNDEF: &#39;UNDEF&#39;&gt;
</pre></div>
</div>
</div>
</div>
<p>The function <code class="docutils literal notranslate"><span class="pre">sample_runner(sample)</span></code> returns an <code class="docutils literal notranslate"><span class="pre">OracleResult.UNDEF</span></code> whenever the runner is not able to execute the sample.</p>
<p>Finally, we provide the function <code class="docutils literal notranslate"><span class="pre">execute_samples(sample_list)</span></code> that obtains the oracle/label for a list of samples.
We use the <code class="docutils literal notranslate"><span class="pre">pandas</span></code> module to place these in a data frame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Executes a list of samples and return the execution outcome (label)</span>
<span class="c1"># The function returns a pandas dataframe</span>
<span class="k">def</span><span class="w"> </span><span class="nf">execute_samples</span><span class="p">(</span><span class="n">sample_list</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">sample_list</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">sample_runner</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;oracle&quot;</span><span class="p">:</span> <span class="n">result</span> <span class="p">})</span>

    <span class="k">return</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let us define a bigger list of samples to execute…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sqrt(-20)&quot;</span><span class="p">,</span> <span class="s2">&quot;cos(2)&quot;</span><span class="p">,</span> <span class="s2">&quot;sqrt(-100)&quot;</span><span class="p">,</span> <span class="s2">&quot;undef_function(foo)&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>… and obtain the execution outcome</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="n">execute_samples</span><span class="p">(</span><span class="n">sample_list</span><span class="p">)</span>
<span class="n">labels</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>name &#39;undef_function&#39; is not defined
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>oracle</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>BUG</td>
    </tr>
    <tr>
      <th>1</th>
      <td>NO_BUG</td>
    </tr>
    <tr>
      <th>2</th>
      <td>NO_BUG</td>
    </tr>
    <tr>
      <th>3</th>
      <td>UNDEF</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can combine these with the <code class="docutils literal notranslate"><span class="pre">sample_list</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="s1">&#39;oracle&#39;</span><span class="p">]):</span> <span class="nb">print</span><span class="p">(</span><span class="n">sample_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sqrt(-20)                     BUG
cos(2)                        NO_BUG
sqrt(-100)                    NO_BUG
undef_function(foo)           UNDEF
</pre></div>
</div>
</div>
</div>
<p>We can remove the undefined input samples like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clean_data</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">labels</span><span class="o">.</span><span class="n">oracle</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;UNDEF&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">clean_data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>oracle</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>BUG</td>
    </tr>
    <tr>
      <th>1</th>
      <td>NO_BUG</td>
    </tr>
    <tr>
      <th>2</th>
      <td>NO_BUG</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can combine sample and labels by iterating over the obtained oracle:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">oracle</span> <span class="o">=</span> <span class="n">execute_samples</span><span class="p">(</span><span class="n">sample_list</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">oracle</span><span class="p">[</span><span class="s1">&#39;oracle&#39;</span><span class="p">]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sample_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sqrt(-20)                     BUG
cos(2)                        NO_BUG
sqrt(-100)                    NO_BUG
undef_function(foo)           UNDEF
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>name &#39;undef_function&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>We observe that the sample <code class="docutils literal notranslate"><span class="pre">sqrt(-16)</span></code> triggers a bug in the calculator, whereas the sample <code class="docutils literal notranslate"><span class="pre">sqrt(4)</span></code> does not show unusual behavior. Of course, we want to know why the sample fails the program. In a typical use case, the developers of the calculator program would now try other input samples and evaluate if similar inputs also trigger the program’s failure. Let’s try some more input samples; maybe we can refine our understanding of why the calculator crashes:</p>
<p>Our guesses - maybe the failure is also in the <code class="docutils literal notranslate"><span class="pre">cos()</span></code> or <code class="docutils literal notranslate"><span class="pre">tan()</span></code> function?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">guess_samples</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cos(-16)&#39;</span><span class="p">,</span> <span class="s1">&#39;tan(-16)&#39;</span><span class="p">,</span> <span class="s1">&#39;sqrt(-100)&#39;</span><span class="p">,</span> <span class="s1">&#39;sqrt(-20.23412431234123)&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s obtain the execution outcome for each of our guesses:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">guess_oracle</span> <span class="o">=</span> <span class="n">execute_samples</span><span class="p">(</span><span class="n">guess_samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here come the results:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">guess_oracle</span><span class="p">[</span><span class="s1">&#39;oracle&#39;</span><span class="p">]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">guess_samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>cos(-16)                      NO_BUG
tan(-16)                      NO_BUG
sqrt(-100)                    NO_BUG
sqrt(-20.23412431234123)      BUG
</pre></div>
</div>
</div>
</div>
<p>It looks like the failure only occurs in the <code class="docutils literal notranslate"><span class="pre">sqrt()</span></code> function, however, only for specific <code class="docutils literal notranslate"><span class="pre">x</span></code> values.
We could now try other values for <code class="docutils literal notranslate"><span class="pre">x</span></code> and repeat the process.
However, this would be highly time-consuming and not an efficient debugging technique for a larger and more complex test subject.</p>
<p>Wouldn’t it be great if there was a tool that automatically does this for us?
And this is exactly what <em>Alhazen</em> is there for.
It helps us explain why specific input features cause a program to fail.</p>
</section>
<section id="step-1-extracting-features">
<h2>Step 1: Extracting Features<a class="headerlink" href="#step-1-extracting-features" title="Link to this heading">#</a></h2>
<p>In this section, we are concerned with the problem of extracting semantic features from inputs. In particular, Alhazen defines various features based on the input grammar, such as <em>existence</em> and <em>numeric interpretation</em>. These features are then extracted from the parse trees of the inputs (see Section 3 of \cite{Kampmann2020} for more details).</p>
<p>The implementation of the feature extraction module consists of the following three tasks:</p>
<ol class="arabic simple">
<li><p>Implementation of individual <em>feature classes</em>, whose instances allow deriving specific feature values from inputs</p></li>
<li><p><em>Extraction of features from the grammar</em> through instantiation of the aforementioned feature classes</p></li>
<li><p>Computation of <em>feature vectors</em> from a set of inputs, which will then be used as input for the decision tree</p></li>
</ol>
<section id="internal-and-friendly-feature-names">
<h3>Internal and “Friendly” Feature Names<a class="headerlink" href="#internal-and-friendly-feature-names" title="Link to this heading">#</a></h3>
<p>We use two kinds of <em>names</em> for features:</p>
<ul class="simple">
<li><p><em>internal</em> names have the form <code class="docutils literal notranslate"><span class="pre">&lt;SYMBOL&gt;&#64;N</span></code> and refer to the <code class="docutils literal notranslate"><span class="pre">N</span></code>-th expansion of symbol (starting with 0).
In <code class="docutils literal notranslate"><span class="pre">CALC_GRAMMAR</span></code>, for instance, <code class="docutils literal notranslate"><span class="pre">&lt;function&gt;&#64;0</span></code> refers to the expansion of <code class="docutils literal notranslate"><span class="pre">&lt;function&gt;</span></code> to <code class="docutils literal notranslate"><span class="pre">&quot;sqrt&quot;</span></code></p></li>
<li><p><em>friendly</em> names are more user-friendly (hence the name).
The above feature <code class="docutils literal notranslate"><span class="pre">&lt;function&gt;&#64;0</span></code> has the “friendly” name <code class="docutils literal notranslate"><span class="pre">&lt;function&gt;</span> <span class="pre">==</span> <span class="pre">&quot;sqrt&quot;</span></code>.</p></li>
</ul>
<p>We use internal names in all our interaction with the machine learner, as they are unambiguous and do not contain whitespace.
When showing the final results, we switch to “friendly” names.</p>
</section>
<section id="implementing-feature-classes">
<h3>Implementing Feature Classes<a class="headerlink" href="#implementing-feature-classes" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Feature</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The abstract base class for grammar features.</span>

<span class="sd">    Args:</span>
<span class="sd">        name : A unique identifier name for this feature. Should not contain Whitespaces.</span>
<span class="sd">               e.g., &#39;type(&lt;feature&gt;@1)&#39;</span>
<span class="sd">        rule : The production rule (e.g., &#39;&lt;function&gt;&#39; or &#39;&lt;value&gt;&#39;).</span>
<span class="sd">        key  : The feature key (e.g., the chosen alternative or rule itself).</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rule</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span>
                 <span class="n">friendly_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rule</span> <span class="o">=</span> <span class="n">rule</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_friendly_name</span> <span class="o">=</span> <span class="n">friendly_name</span> <span class="ow">or</span> <span class="n">name</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns a printable string representation of the feature.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_rep</span><span class="p">()</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name_rep</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">friendly_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_friendly_name</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_feature_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">derivation_tree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns the feature value for a given derivation tree of an input.&#39;&#39;&#39;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Feature&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns a new feature with the same name but a different key.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule</span><span class="p">,</span> <span class="n">new_key</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ExistenceFeature</span><span class="p">(</span><span class="n">Feature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This class represents existence features of a grammar. Existence features indicate</span>
<span class="sd">    whether a particular production rule was used in the derivation sequence of an input.</span>
<span class="sd">    For a given production rule P -&gt; A | B, a production existence feature for P and</span>
<span class="sd">    alternative existence features for each alternative (i.e., A and B) are defined.</span>

<span class="sd">    name : A unique identifier name for this feature. Should not contain Whitespaces.</span>
<span class="sd">           e.g., &#39;exist(&lt;digit&gt;@1)&#39;</span>
<span class="sd">    rule : The production rule.</span>
<span class="sd">    key  : The feature key, equal to the rule attribute for production features,</span>
<span class="sd">           or equal to the corresponding alternative for alternative features.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rule</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">friendly_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">friendly_name</span><span class="o">=</span><span class="n">friendly_name</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">name_rep</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;exists(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rule</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;exists(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rule</span><span class="si">}</span><span class="s2"> == </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_feature_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">derivation_tree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns the feature value for a given derivation tree of an input.&#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_feature_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">derivation_tree</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Counts the number of times this feature was matched in the derivation tree.&#39;&#39;&#39;</span>
        <span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">children</span><span class="p">)</span> <span class="o">=</span> <span class="n">derivation_tree</span>

        <span class="c1"># The local match count (1 if the feature is matched for the current node, 0 if not)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># First check if the current node can be matched with the rule</span>
        <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule</span><span class="p">:</span>

            <span class="c1"># Production existance feature</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="c1"># Production alternative existance feature</span>
            <span class="c1"># We compare the children of the expansion with the actual children</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">expansion_children</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">expansion_to_children</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)))</span>
                <span class="n">node_children</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">children</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">expansion_children</span> <span class="o">==</span> <span class="n">node_children</span><span class="p">:</span>
                    <span class="n">count</span><span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Recursively compute the counts for all children and return the sum for the whole tree</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_feature_value</span><span class="p">(</span><span class="n">child</span><span class="p">))</span> 

        <span class="k">return</span> <span class="n">count</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">NumericInterpretation</span><span class="p">(</span><span class="n">Feature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This class represents numeric interpretation features of a grammar. These features</span>
<span class="sd">    are defined for productions that only derive words composed of the characters</span>
<span class="sd">    [0-9], &#39;.&#39;, and &#39;-&#39;. The returned feature value corresponds to the maximum</span>
<span class="sd">    floating-point number interpretation of the derived words of a production.</span>

<span class="sd">    name : A unique identifier name for this feature. Should not contain Whitespaces.</span>
<span class="sd">           e.g., &#39;num(&lt;integer&gt;)&#39;</span>
<span class="sd">    rule : The production rule.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rule</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> 
                 <span class="n">friendly_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">friendly_name</span><span class="o">=</span><span class="n">friendly_name</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">name_rep</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;num(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_feature_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">derivation_tree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns the feature value for a given derivation tree of an input.&#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_feature_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">derivation_tree</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Determines the maximum float of this feature in the derivation tree.&#39;&#39;&#39;</span>
        <span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">children</span><span class="p">)</span> <span class="o">=</span> <span class="n">derivation_tree</span>

        <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1">#print(self.name, float(tree_to_string(derivation_tree)))</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tree_to_string</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c1">#print(self.name, float(tree_to_string(derivation_tree)), &quot;err&quot;)</span>
                <span class="k">pass</span>

        <span class="c1"># Return maximum value encountered in tree, ignoring all NaNs</span>
        <span class="n">tree_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_feature_value</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">children</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">tree_values</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">tree_values</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="extracting-feature-sets-from-grammars">
<h3>Extracting Feature Sets from Grammars<a class="headerlink" href="#extracting-feature-sets-from-grammars" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">extract_existence_features</span><span class="p">(</span><span class="n">grammar</span><span class="p">:</span> <span class="n">Grammar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ExistenceFeature</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Extracts all existence features from the grammar and returns them as a list.</span>
<span class="sd">        grammar : The input grammar.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">grammar</span><span class="p">:</span>
        <span class="c1"># add the rule</span>
        <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ExistenceFeature</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;exists(</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">rule</span><span class="p">))</span>
        <span class="c1"># add all alternatives</span>
        <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">expansion</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grammar</span><span class="p">[</span><span class="n">rule</span><span class="p">]):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;exists(</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="n">friendly_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s2"> == </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">expansion</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">feature</span> <span class="o">=</span> <span class="n">ExistenceFeature</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">expansion</span><span class="p">,</span>
                                       <span class="n">friendly_name</span><span class="o">=</span><span class="n">friendly_name</span><span class="p">)</span>
            <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">features</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Regex for non-terminal symbols in expansions</span>
<span class="n">RE_NONTERMINAL</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(&lt;[^&lt;&gt; ]*&gt;)&#39;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">extract_numeric_features</span><span class="p">(</span><span class="n">grammar</span><span class="p">:</span> <span class="n">Grammar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">NumericInterpretation</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Extracts all numeric interpretation features from the grammar and returns them as a list.</span>

<span class="sd">        grammar : The input grammar.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Mapping from non-terminals to derivable terminal chars</span>
    <span class="n">derivable_chars</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">grammar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">expansion</span> <span class="ow">in</span> <span class="n">grammar</span><span class="p">[</span><span class="n">rule</span><span class="p">]:</span>
            <span class="c1"># Remove non-terminal symbols and whitespace from expansion</span>
            <span class="n">terminals</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">RE_NONTERMINAL</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">expansion</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="c1"># Add each terminal char to the set of derivable chars</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">terminals</span><span class="p">:</span>
                <span class="n">derivable_chars</span><span class="p">[</span><span class="n">rule</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="c1"># Repeatedly update the mapping until convergence</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">updated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">grammar</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">reachable_nonterminals</span><span class="p">(</span><span class="n">grammar</span><span class="p">,</span> <span class="n">rule</span><span class="p">):</span>
                <span class="n">before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">derivable_chars</span><span class="p">[</span><span class="n">rule</span><span class="p">])</span>
                <span class="n">derivable_chars</span><span class="p">[</span><span class="n">rule</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">derivable_chars</span><span class="p">[</span><span class="n">r</span><span class="p">])</span>
                <span class="n">after</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">derivable_chars</span><span class="p">[</span><span class="n">rule</span><span class="p">])</span>

                <span class="c1"># Set of derivable chars was updated</span>
                <span class="k">if</span> <span class="n">after</span> <span class="o">&gt;</span> <span class="n">before</span><span class="p">:</span>
                    <span class="n">updated</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">updated</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="n">numeric_chars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="s1">&#39;4&#39;</span><span class="p">,</span><span class="s1">&#39;5&#39;</span><span class="p">,</span><span class="s1">&#39;6&#39;</span><span class="p">,</span><span class="s1">&#39;7&#39;</span><span class="p">,</span><span class="s1">&#39;8&#39;</span><span class="p">,</span><span class="s1">&#39;9&#39;</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">derivable_chars</span><span class="p">:</span>
        <span class="c1"># Check if derivable chars contain only numeric chars</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">derivable_chars</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">-</span> <span class="n">numeric_chars</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;num(</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="n">friendly_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NumericInterpretation</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;num(</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span>
                                                  <span class="n">friendly_name</span><span class="o">=</span><span class="n">friendly_name</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">features</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">extract_all_features</span><span class="p">(</span><span class="n">grammar</span><span class="p">:</span> <span class="n">Grammar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Feature</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">extract_existence_features</span><span class="p">(</span><span class="n">grammar</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">extract_numeric_features</span><span class="p">(</span><span class="n">grammar</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Here are all the features from our calculator grammar:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">extract_all_features</span><span class="p">(</span><span class="n">CALC_GRAMMAR</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[exists(&lt;start&gt;),
 exists(&lt;start&gt; == &lt;function&gt;(&lt;term&gt;)),
 exists(&lt;function&gt;),
 exists(&lt;function&gt; == sqrt),
 exists(&lt;function&gt; == tan),
 exists(&lt;function&gt; == cos),
 exists(&lt;function&gt; == sin),
 exists(&lt;term&gt;),
 exists(&lt;term&gt; == -&lt;value&gt;),
 exists(&lt;term&gt; == &lt;value&gt;),
 exists(&lt;value&gt;),
 exists(&lt;value&gt; == &lt;integer&gt;.&lt;digits&gt;),
 exists(&lt;value&gt; == &lt;integer&gt;),
 exists(&lt;integer&gt;),
 exists(&lt;integer&gt; == &lt;lead-digit&gt;&lt;digits&gt;),
 exists(&lt;integer&gt; == &lt;digit&gt;),
 exists(&lt;digits&gt;),
 exists(&lt;digits&gt; == &lt;digit&gt;&lt;digits&gt;),
 exists(&lt;digits&gt; == &lt;digit&gt;),
 exists(&lt;lead-digit&gt;),
 exists(&lt;lead-digit&gt; == 1),
 exists(&lt;lead-digit&gt; == 2),
 exists(&lt;lead-digit&gt; == 3),
 exists(&lt;lead-digit&gt; == 4),
 exists(&lt;lead-digit&gt; == 5),
 exists(&lt;lead-digit&gt; == 6),
 exists(&lt;lead-digit&gt; == 7),
 exists(&lt;lead-digit&gt; == 8),
 exists(&lt;lead-digit&gt; == 9),
 exists(&lt;digit&gt;),
 exists(&lt;digit&gt; == 0),
 exists(&lt;digit&gt; == 1),
 exists(&lt;digit&gt; == 2),
 exists(&lt;digit&gt; == 3),
 exists(&lt;digit&gt; == 4),
 exists(&lt;digit&gt; == 5),
 exists(&lt;digit&gt; == 6),
 exists(&lt;digit&gt; == 7),
 exists(&lt;digit&gt; == 8),
 exists(&lt;digit&gt; == 9),
 num(&lt;term&gt;),
 num(&lt;value&gt;),
 num(&lt;lead-digit&gt;),
 num(&lt;digit&gt;),
 num(&lt;integer&gt;),
 num(&lt;digits&gt;)]
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">friendly</span></code> representation is a bit more concise and more readable:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">friendly_name</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">extract_all_features</span><span class="p">(</span><span class="n">CALC_GRAMMAR</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;exists(&lt;start&gt;)&#39;,
 &quot;&lt;start&gt; == &#39;&lt;function&gt;(&lt;term&gt;)&#39;&quot;,
 &#39;exists(&lt;function&gt;)&#39;,
 &quot;&lt;function&gt; == &#39;sqrt&#39;&quot;,
 &quot;&lt;function&gt; == &#39;tan&#39;&quot;,
 &quot;&lt;function&gt; == &#39;cos&#39;&quot;,
 &quot;&lt;function&gt; == &#39;sin&#39;&quot;,
 &#39;exists(&lt;term&gt;)&#39;,
 &quot;&lt;term&gt; == &#39;-&lt;value&gt;&#39;&quot;,
 &quot;&lt;term&gt; == &#39;&lt;value&gt;&#39;&quot;,
 &#39;exists(&lt;value&gt;)&#39;,
 &quot;&lt;value&gt; == &#39;&lt;integer&gt;.&lt;digits&gt;&#39;&quot;,
 &quot;&lt;value&gt; == &#39;&lt;integer&gt;&#39;&quot;,
 &#39;exists(&lt;integer&gt;)&#39;,
 &quot;&lt;integer&gt; == &#39;&lt;lead-digit&gt;&lt;digits&gt;&#39;&quot;,
 &quot;&lt;integer&gt; == &#39;&lt;digit&gt;&#39;&quot;,
 &#39;exists(&lt;digits&gt;)&#39;,
 &quot;&lt;digits&gt; == &#39;&lt;digit&gt;&lt;digits&gt;&#39;&quot;,
 &quot;&lt;digits&gt; == &#39;&lt;digit&gt;&#39;&quot;,
 &#39;exists(&lt;lead-digit&gt;)&#39;,
 &quot;&lt;lead-digit&gt; == &#39;1&#39;&quot;,
 &quot;&lt;lead-digit&gt; == &#39;2&#39;&quot;,
 &quot;&lt;lead-digit&gt; == &#39;3&#39;&quot;,
 &quot;&lt;lead-digit&gt; == &#39;4&#39;&quot;,
 &quot;&lt;lead-digit&gt; == &#39;5&#39;&quot;,
 &quot;&lt;lead-digit&gt; == &#39;6&#39;&quot;,
 &quot;&lt;lead-digit&gt; == &#39;7&#39;&quot;,
 &quot;&lt;lead-digit&gt; == &#39;8&#39;&quot;,
 &quot;&lt;lead-digit&gt; == &#39;9&#39;&quot;,
 &#39;exists(&lt;digit&gt;)&#39;,
 &quot;&lt;digit&gt; == &#39;0&#39;&quot;,
 &quot;&lt;digit&gt; == &#39;1&#39;&quot;,
 &quot;&lt;digit&gt; == &#39;2&#39;&quot;,
 &quot;&lt;digit&gt; == &#39;3&#39;&quot;,
 &quot;&lt;digit&gt; == &#39;4&#39;&quot;,
 &quot;&lt;digit&gt; == &#39;5&#39;&quot;,
 &quot;&lt;digit&gt; == &#39;6&#39;&quot;,
 &quot;&lt;digit&gt; == &#39;7&#39;&quot;,
 &quot;&lt;digit&gt; == &#39;8&#39;&quot;,
 &quot;&lt;digit&gt; == &#39;9&#39;&quot;,
 &#39;&lt;term&gt;&#39;,
 &#39;&lt;value&gt;&#39;,
 &#39;&lt;lead-digit&gt;&#39;,
 &#39;&lt;digit&gt;&#39;,
 &#39;&lt;integer&gt;&#39;,
 &#39;&lt;digits&gt;&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="extracting-feature-values-from-inputs">
<h3>Extracting Feature Values from Inputs<a class="headerlink" href="#extracting-feature-values-from-inputs" title="Link to this heading">#</a></h3>
<p>This is a rather slow implementation.
For many grammars with many syntactically features, the feature collection can be optimized.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">collect_features</span><span class="p">(</span><span class="n">sample_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                     <span class="n">grammar</span><span class="p">:</span> <span class="n">Grammar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># parse grammar and extract features</span>
    <span class="n">all_features</span> <span class="o">=</span> <span class="n">extract_all_features</span><span class="p">(</span><span class="n">grammar</span><span class="p">)</span>

    <span class="c1"># iterate over all samples</span>
    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">sample_list</span><span class="p">:</span>
        <span class="n">parsed_features</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">parsed_features</span><span class="p">[</span><span class="s2">&quot;sample&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample</span>
        <span class="c1"># initate dictionary</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">all_features</span><span class="p">:</span>
            <span class="n">parsed_features</span><span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Obtain the parse tree for each input file</span>
        <span class="n">earley</span> <span class="o">=</span> <span class="n">EarleyParser</span><span class="p">(</span><span class="n">grammar</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">earley</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">sample</span><span class="p">):</span>

            <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">all_features</span><span class="p">:</span>
                <span class="n">parsed_features</span><span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">get_feature_value</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>

        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parsed_features</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sqrt(-900)&quot;</span><span class="p">,</span> <span class="s2">&quot;sin(24)&quot;</span><span class="p">,</span> <span class="s2">&quot;cos(-3.14)&quot;</span><span class="p">]</span>
<span class="n">collect_features</span><span class="p">(</span><span class="n">sample_list</span><span class="p">,</span> <span class="n">CALC_GRAMMAR</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sample</th>
      <th>exists(&lt;start&gt;)</th>
      <th>exists(&lt;start&gt;@0)</th>
      <th>exists(&lt;function&gt;)</th>
      <th>exists(&lt;function&gt;@0)</th>
      <th>exists(&lt;function&gt;@1)</th>
      <th>exists(&lt;function&gt;@2)</th>
      <th>exists(&lt;function&gt;@3)</th>
      <th>exists(&lt;term&gt;)</th>
      <th>exists(&lt;term&gt;@0)</th>
      <th>...</th>
      <th>exists(&lt;digit&gt;@6)</th>
      <th>exists(&lt;digit&gt;@7)</th>
      <th>exists(&lt;digit&gt;@8)</th>
      <th>exists(&lt;digit&gt;@9)</th>
      <th>num(&lt;term&gt;)</th>
      <th>num(&lt;value&gt;)</th>
      <th>num(&lt;lead-digit&gt;)</th>
      <th>num(&lt;digit&gt;)</th>
      <th>num(&lt;integer&gt;)</th>
      <th>num(&lt;digits&gt;)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>sqrt(-900)</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>-900.00</td>
      <td>900.00</td>
      <td>9.0</td>
      <td>0.0</td>
      <td>900.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>sin(24)</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>24.00</td>
      <td>24.00</td>
      <td>2.0</td>
      <td>4.0</td>
      <td>24.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>cos(-3.14)</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>-3.14</td>
      <td>3.14</td>
      <td>NaN</td>
      <td>4.0</td>
      <td>3.0</td>
      <td>14.0</td>
    </tr>
  </tbody>
</table>
<p>3 rows × 47 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO: handle multiple trees</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_feature_values</span><span class="p">(</span><span class="n">sample</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">grammar</span><span class="p">:</span> <span class="n">Grammar</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Feature</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Extracts all feature values from an input.</span>

<span class="sd">        sample   : The input.</span>
<span class="sd">        grammar  : The input grammar.</span>
<span class="sd">        features : The list of input features extracted from the grammar.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">earley</span> <span class="o">=</span> <span class="n">EarleyParser</span><span class="p">(</span><span class="n">CALC_GRAMMAR</span><span class="p">)</span>

    <span class="n">features</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">earley</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">sample</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">extract_all_features</span><span class="p">(</span><span class="n">CALC_GRAMMAR</span><span class="p">):</span>
            <span class="n">features</span><span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">name_rep</span><span class="p">()]</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">get_feature_value</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">features</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_features</span> <span class="o">=</span> <span class="n">extract_all_features</span><span class="p">(</span><span class="n">CALC_GRAMMAR</span><span class="p">)</span>
<span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">sample_list</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Features of </span><span class="si">{</span><span class="n">sample</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">compute_feature_values</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">CALC_GRAMMAR</span><span class="p">,</span> <span class="n">all_features</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Features of sqrt(-900):
    exists(&lt;start&gt;): 1
    exists(&lt;start&gt; == &lt;function&gt;(&lt;term&gt;)): 1
    exists(&lt;function&gt;): 1
    exists(&lt;function&gt; == sqrt): 1
    exists(&lt;function&gt; == tan): 0
    exists(&lt;function&gt; == cos): 0
    exists(&lt;function&gt; == sin): 0
    exists(&lt;term&gt;): 1
    exists(&lt;term&gt; == -&lt;value&gt;): 1
    exists(&lt;term&gt; == &lt;value&gt;): 0
    exists(&lt;value&gt;): 1
    exists(&lt;value&gt; == &lt;integer&gt;.&lt;digits&gt;): 0
    exists(&lt;value&gt; == &lt;integer&gt;): 1
    exists(&lt;integer&gt;): 1
    exists(&lt;integer&gt; == &lt;lead-digit&gt;&lt;digits&gt;): 1
    exists(&lt;integer&gt; == &lt;digit&gt;): 0
    exists(&lt;digits&gt;): 1
    exists(&lt;digits&gt; == &lt;digit&gt;&lt;digits&gt;): 1
    exists(&lt;digits&gt; == &lt;digit&gt;): 1
    exists(&lt;lead-digit&gt;): 1
    exists(&lt;lead-digit&gt; == 1): 0
    exists(&lt;lead-digit&gt; == 2): 0
    exists(&lt;lead-digit&gt; == 3): 0
    exists(&lt;lead-digit&gt; == 4): 0
    exists(&lt;lead-digit&gt; == 5): 0
    exists(&lt;lead-digit&gt; == 6): 0
    exists(&lt;lead-digit&gt; == 7): 0
    exists(&lt;lead-digit&gt; == 8): 0
    exists(&lt;lead-digit&gt; == 9): 1
    exists(&lt;digit&gt;): 1
    exists(&lt;digit&gt; == 0): 1
    exists(&lt;digit&gt; == 1): 0
    exists(&lt;digit&gt; == 2): 0
    exists(&lt;digit&gt; == 3): 0
    exists(&lt;digit&gt; == 4): 0
    exists(&lt;digit&gt; == 5): 0
    exists(&lt;digit&gt; == 6): 0
    exists(&lt;digit&gt; == 7): 0
    exists(&lt;digit&gt; == 8): 0
    exists(&lt;digit&gt; == 9): 0
    num(&lt;term&gt;): -900.0
    num(&lt;value&gt;): 900.0
    num(&lt;lead-digit&gt;): 9.0
    num(&lt;digit&gt;): 0.0
    num(&lt;integer&gt;): 900.0
    num(&lt;digits&gt;): 0.0
Features of sin(24):
    exists(&lt;start&gt;): 1
    exists(&lt;start&gt; == &lt;function&gt;(&lt;term&gt;)): 1
    exists(&lt;function&gt;): 1
    exists(&lt;function&gt; == sqrt): 0
    exists(&lt;function&gt; == tan): 0
    exists(&lt;function&gt; == cos): 0
    exists(&lt;function&gt; == sin): 1
    exists(&lt;term&gt;): 1
    exists(&lt;term&gt; == -&lt;value&gt;): 0
    exists(&lt;term&gt; == &lt;value&gt;): 1
    exists(&lt;value&gt;): 1
    exists(&lt;value&gt; == &lt;integer&gt;.&lt;digits&gt;): 0
    exists(&lt;value&gt; == &lt;integer&gt;): 1
    exists(&lt;integer&gt;): 1
    exists(&lt;integer&gt; == &lt;lead-digit&gt;&lt;digits&gt;): 1
    exists(&lt;integer&gt; == &lt;digit&gt;): 0
    exists(&lt;digits&gt;): 1
    exists(&lt;digits&gt; == &lt;digit&gt;&lt;digits&gt;): 0
    exists(&lt;digits&gt; == &lt;digit&gt;): 1
    exists(&lt;lead-digit&gt;): 1
    exists(&lt;lead-digit&gt; == 1): 0
    exists(&lt;lead-digit&gt; == 2): 1
    exists(&lt;lead-digit&gt; == 3): 0
    exists(&lt;lead-digit&gt; == 4): 0
    exists(&lt;lead-digit&gt; == 5): 0
    exists(&lt;lead-digit&gt; == 6): 0
    exists(&lt;lead-digit&gt; == 7): 0
    exists(&lt;lead-digit&gt; == 8): 0
    exists(&lt;lead-digit&gt; == 9): 0
    exists(&lt;digit&gt;): 1
    exists(&lt;digit&gt; == 0): 0
    exists(&lt;digit&gt; == 1): 0
    exists(&lt;digit&gt; == 2): 0
    exists(&lt;digit&gt; == 3): 0
    exists(&lt;digit&gt; == 4): 1
    exists(&lt;digit&gt; == 5): 0
    exists(&lt;digit&gt; == 6): 0
    exists(&lt;digit&gt; == 7): 0
    exists(&lt;digit&gt; == 8): 0
    exists(&lt;digit&gt; == 9): 0
    num(&lt;term&gt;): 24.0
    num(&lt;value&gt;): 24.0
    num(&lt;lead-digit&gt;): 2.0
    num(&lt;digit&gt;): 4.0
    num(&lt;integer&gt;): 24.0
    num(&lt;digits&gt;): 4.0
Features of cos(-3.14):
    exists(&lt;start&gt;): 1
    exists(&lt;start&gt; == &lt;function&gt;(&lt;term&gt;)): 1
    exists(&lt;function&gt;): 1
    exists(&lt;function&gt; == sqrt): 0
    exists(&lt;function&gt; == tan): 0
    exists(&lt;function&gt; == cos): 1
    exists(&lt;function&gt; == sin): 0
    exists(&lt;term&gt;): 1
    exists(&lt;term&gt; == -&lt;value&gt;): 1
    exists(&lt;term&gt; == &lt;value&gt;): 0
    exists(&lt;value&gt;): 1
    exists(&lt;value&gt; == &lt;integer&gt;.&lt;digits&gt;): 1
    exists(&lt;value&gt; == &lt;integer&gt;): 0
    exists(&lt;integer&gt;): 1
    exists(&lt;integer&gt; == &lt;lead-digit&gt;&lt;digits&gt;): 0
    exists(&lt;integer&gt; == &lt;digit&gt;): 1
    exists(&lt;digits&gt;): 1
    exists(&lt;digits&gt; == &lt;digit&gt;&lt;digits&gt;): 1
    exists(&lt;digits&gt; == &lt;digit&gt;): 1
    exists(&lt;lead-digit&gt;): 0
    exists(&lt;lead-digit&gt; == 1): 0
    exists(&lt;lead-digit&gt; == 2): 0
    exists(&lt;lead-digit&gt; == 3): 0
    exists(&lt;lead-digit&gt; == 4): 0
    exists(&lt;lead-digit&gt; == 5): 0
    exists(&lt;lead-digit&gt; == 6): 0
    exists(&lt;lead-digit&gt; == 7): 0
    exists(&lt;lead-digit&gt; == 8): 0
    exists(&lt;lead-digit&gt; == 9): 0
    exists(&lt;digit&gt;): 1
    exists(&lt;digit&gt; == 0): 0
    exists(&lt;digit&gt; == 1): 1
    exists(&lt;digit&gt; == 2): 0
    exists(&lt;digit&gt; == 3): 1
    exists(&lt;digit&gt; == 4): 1
    exists(&lt;digit&gt; == 5): 0
    exists(&lt;digit&gt; == 6): 0
    exists(&lt;digit&gt; == 7): 0
    exists(&lt;digit&gt; == 8): 0
    exists(&lt;digit&gt; == 9): 0
    num(&lt;term&gt;): -3.14
    num(&lt;value&gt;): 3.14
    num(&lt;lead-digit&gt;): nan
    num(&lt;digit&gt;): 4.0
    num(&lt;integer&gt;): 3.0
    num(&lt;digits&gt;): 14.0
</pre></div>
</div>
</div>
</div>
</section>
<section id="excursion-transforming-grammars">
<h3>Excursion: Transforming Grammars<a class="headerlink" href="#excursion-transforming-grammars" title="Link to this heading">#</a></h3>
<p>Alhazen requires grammars to be transformed, such that for each non-terminal symbol in the grammar, the word derived by this symbol in the input is added as an alternative to the symbol (as written in \cite{Kampmann2020}). Here, we iterate through the derivation tree of the input and add the derived word of each nonterminal as alternatives to the grammar.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For this example, fix the random seed so that the produced output is deterministic</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">EXPR_GRAMMAR</span><span class="p">,</span> <span class="n">max_nonterminals</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">test_input</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
<span class="k">assert</span><span class="p">(</span><span class="n">test_input</span> <span class="o">==</span> <span class="n">tree_to_string</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">derivation_tree</span><span class="p">))</span>

<span class="n">display_tree</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7ea3b163c194aeb6b29a89ea0a956c215eb7985bf2f86b0ddc008ac5c2c6d8b5.svg" src="_images/7ea3b163c194aeb6b29a89ea0a956c215eb7985bf2f86b0ddc008ac5c2c6d8b5.svg" />
</div>
</div>
<p>Let us write a function <code class="docutils literal notranslate"><span class="pre">transform_grammar()</span></code> that given a sample input and a grammar, transforms it according to Kampmann et al.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="k">def</span><span class="w"> </span><span class="nf">transform_grammar</span><span class="p">(</span><span class="n">sample</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                     <span class="n">grammar</span><span class="p">:</span> <span class="n">Grammar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Grammar</span>

</pre></div>
</div>
<p>The function requires the following input parameter:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sample</span></code>: an input sample</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">grammar</span></code>: the grammar that should be transformed/extended</p></li>
</ul>
<p>The function returns the transformed and extended grammar.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Recursively iterate through the derivation tree and for each non-terminal,</span>
<span class="c1"># add the derived word to the grammar</span>

<span class="k">def</span><span class="w"> </span><span class="nf">extend_grammar</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">,</span> <span class="n">grammar</span><span class="p">):</span>
    <span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">children</span><span class="p">)</span> <span class="o">=</span> <span class="n">derivation_tree</span>

    <span class="k">if</span> <span class="n">is_nonterminal</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">node</span> <span class="ow">in</span> <span class="n">grammar</span><span class="p">)</span>
        <span class="n">word</span> <span class="o">=</span> <span class="n">tree_to_string</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>

        <span class="c1"># Only add to grammar if not already existent</span>
        <span class="k">if</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grammar</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span>
            <span class="n">grammar</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
        <span class="n">extend_grammar</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">grammar</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">transform_grammar</span><span class="p">(</span><span class="n">sample</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">grammar</span><span class="p">:</span> <span class="n">Grammar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Grammar</span><span class="p">:</span>
    <span class="c1"># copy of the grammar</span>
    <span class="n">transformed_grammar</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">grammar</span><span class="p">)</span>

    <span class="c1"># parse sample</span>
    <span class="n">earley</span> <span class="o">=</span> <span class="n">EarleyParser</span><span class="p">(</span><span class="n">grammar</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">derivation_tree</span> <span class="ow">in</span> <span class="n">earley</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">sample</span><span class="p">):</span>
        <span class="n">extend_grammar</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">,</span> <span class="n">transformed_grammar</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">transformed_grammar</span>
</pre></div>
</div>
</div>
</div>
<p>Here is an example of a transformed grammar:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">transformed_grammar</span> <span class="o">=</span> <span class="n">transform_grammar</span><span class="p">(</span><span class="s2">&quot;1 + 2&quot;</span><span class="p">,</span> <span class="n">EXPR_GRAMMAR</span><span class="p">)</span>
<span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">transformed_grammar</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">transformed_grammar</span><span class="p">[</span><span class="n">rule</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;start&gt;    [&#39;&lt;expr&gt;&#39;, &#39;1 + 2&#39;]
&lt;expr&gt;     [&#39;&lt;term&gt; + &lt;expr&gt;&#39;, &#39;&lt;term&gt; - &lt;expr&gt;&#39;, &#39;&lt;term&gt;&#39;, &#39;1 + 2&#39;, &#39;2&#39;]
&lt;term&gt;     [&#39;&lt;factor&gt; * &lt;term&gt;&#39;, &#39;&lt;factor&gt; / &lt;term&gt;&#39;, &#39;&lt;factor&gt;&#39;, &#39;1&#39;, &#39;2&#39;]
&lt;factor&gt;   [&#39;+&lt;factor&gt;&#39;, &#39;-&lt;factor&gt;&#39;, &#39;(&lt;expr&gt;)&#39;, &#39;&lt;integer&gt;.&lt;integer&gt;&#39;, &#39;&lt;integer&gt;&#39;, &#39;1&#39;, &#39;2&#39;]
&lt;integer&gt;  [&#39;&lt;digit&gt;&lt;integer&gt;&#39;, &#39;&lt;digit&gt;&#39;, &#39;1&#39;, &#39;2&#39;]
&lt;digit&gt;    [&#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;, &#39;8&#39;, &#39;9&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="end-of-excursion">
<h3>End of Excursion<a class="headerlink" href="#end-of-excursion" title="Link to this heading">#</a></h3>
</section>
</section>
<section id="step-2-train-classification-model">
<h2>Step 2: Train Classification Model<a class="headerlink" href="#step-2-train-classification-model" title="Link to this heading">#</a></h2>
<p>Now that we have all the input features and the test outcomes, we can start training a machine learner from these.
Although other machine learning models have much higher accuracy, we use <em>decision trees</em> as machine learning models because they are easy to interpret by humans.
This is crucial as it will be these very same humans that have to fix the code.</p>
<p>Before we start with our actual implementation, let us first illustrate how training such a classifier works, again using our calculator as an example.</p>
<section id="decision-trees">
<h3>Decision Trees<a class="headerlink" href="#decision-trees" title="Link to this heading">#</a></h3>
<p>We will use <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code> as the machine learning library.
The <code class="docutils literal notranslate"><span class="pre">DecisionTreeClassifier</span></code> can then learn the syntactical input features that are responsible for the bug-triggering behavior of our Calculator.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sklearn</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.tree</span><span class="w"> </span><span class="kn">import</span> <span class="n">DecisionTreeClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.feature_extraction</span><span class="w"> </span><span class="kn">import</span> <span class="n">DictVectorizer</span>
</pre></div>
</div>
</div>
</div>
<p>First, we transform the individual input features (represented as Python dictionaries) into a NumPy array.
For this example, we use the following four features (<code class="docutils literal notranslate"><span class="pre">function-sqrt</span></code>, <code class="docutils literal notranslate"><span class="pre">function-cos</span></code>, <code class="docutils literal notranslate"><span class="pre">function-sin</span></code>, <code class="docutils literal notranslate"><span class="pre">number</span></code>) to describe an input feature.
(Please note that this is an extremely reduced example; this is not the complete list of features that should be extracted from the <code class="docutils literal notranslate"><span class="pre">CALC_GRAMMAR</span></code> Grammar.)</p>
<p>The features <code class="docutils literal notranslate"><span class="pre">function-sqrt</span></code>, <code class="docutils literal notranslate"><span class="pre">function-cos</span></code>, <code class="docutils literal notranslate"><span class="pre">function-sin</span></code> state whether the function <em>sqrt</em>, <em>cos</em>, or <em>sin</em> was used.
A <code class="docutils literal notranslate"><span class="pre">1</span></code> is given if the sample contains the respective function, otherwise the feature contains a <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p>
<p>For each <code class="docutils literal notranslate"><span class="pre">&lt;function&gt;(x)</span></code>, the <code class="docutils literal notranslate"><span class="pre">number</span></code> feature describes which value was used for <code class="docutils literal notranslate"><span class="pre">x</span></code>. For instance, the first input <code class="docutils literal notranslate"><span class="pre">sqrt(-900)</span></code> corresponds to ‘function-sqrt’: 1 and ‘number’: -900.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Features for each input, one dict per input</span>
<span class="n">features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">&#39;function-sqrt&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;function-cos&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;function-sin&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">900</span><span class="p">},</span> <span class="c1"># sqrt(-900)</span>
    <span class="p">{</span><span class="s1">&#39;function-sqrt&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;function-cos&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;function-sin&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">},</span> <span class="c1"># cos(300)</span>
    <span class="p">{</span><span class="s1">&#39;function-sqrt&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;function-cos&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;function-sin&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="c1"># sqrt(-1)</span>
    <span class="p">{</span><span class="s1">&#39;function-sqrt&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;function-cos&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;function-sin&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">10</span><span class="p">},</span> <span class="c1"># cos(-10)</span>
    <span class="p">{</span><span class="s1">&#39;function-sqrt&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;function-cos&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;function-sin&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">:</span> <span class="mi">36</span><span class="p">},</span> <span class="c1"># sin(36)</span>
    <span class="p">{</span><span class="s1">&#39;function-sqrt&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;function-cos&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;function-sin&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">58</span><span class="p">},</span> <span class="c1"># sin(-58)</span>
    <span class="p">{</span><span class="s1">&#39;function-sqrt&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;function-cos&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;function-sin&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">:</span> <span class="mi">27</span><span class="p">},</span> <span class="c1"># sqrt(27)</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We define a list of labels (or oracles) that state whether the specific input file resulted in a bug or not. We use the <code class="docutils literal notranslate"><span class="pre">OracleResult</span></code>-Class to keep everything tidy and clean.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Labels for each input</span>
<span class="n">oracle</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">OracleResult</span><span class="o">.</span><span class="n">BUG</span><span class="p">,</span>
    <span class="n">OracleResult</span><span class="o">.</span><span class="n">NO_BUG</span><span class="p">,</span>
    <span class="n">OracleResult</span><span class="o">.</span><span class="n">BUG</span><span class="p">,</span>
    <span class="n">OracleResult</span><span class="o">.</span><span class="n">NO_BUG</span><span class="p">,</span>
    <span class="n">OracleResult</span><span class="o">.</span><span class="n">NO_BUG</span><span class="p">,</span>
    <span class="n">OracleResult</span><span class="o">.</span><span class="n">NO_BUG</span><span class="p">,</span>
    <span class="n">OracleResult</span><span class="o">.</span><span class="n">NO_BUG</span>
<span class="p">]</span>

<span class="c1"># Transform to numpy array</span>
<span class="n">vec</span> <span class="o">=</span> <span class="n">DictVectorizer</span><span class="p">()</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">vec</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">features</span><span class="p">)</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Using the feature array and labels, we can now train a decision tree classifier as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fix the random state to produce a deterministic result (for illustration purposes only)</span>
<span class="n">clf</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># sci-kit learn requires an array of strings</span>
<span class="n">oracle_clean</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">oracle</span><span class="p">]</span>
<span class="n">clf</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">oracle_clean</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s have a look at the learned decision tree:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">graphviz</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">show_decision_tree</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">):</span>
    <span class="n">dot_data</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">export_graphviz</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">out_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                                    <span class="n">feature_names</span><span class="o">=</span><span class="n">feature_names</span><span class="p">,</span>
                                    <span class="n">class_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;BUG&quot;</span><span class="p">,</span> <span class="s2">&quot;NO_BUG&quot;</span><span class="p">],</span>  
                                    <span class="n">filled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rounded</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
    <span class="k">return</span> <span class="n">graphviz</span><span class="o">.</span><span class="n">Source</span><span class="p">(</span><span class="n">dot_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_decision_tree</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">vec</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/a425630ef95032cb39bc1daad1c5f5bfe3509831ee1342218ab2abdebd790ef2.svg" src="_images/a425630ef95032cb39bc1daad1c5f5bfe3509831ee1342218ab2abdebd790ef2.svg" />
</div>
</div>
<p>Here is a much reduced textual variant, still retaining the essential features:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">friendly_decision_tree</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span>
                           <span class="n">class_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NO_BUG&#39;</span><span class="p">,</span> <span class="s1">&#39;BUG&#39;</span><span class="p">],</span>
                           <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_tree</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">indent</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">feature</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">feature</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">feature_name</span> <span class="o">=</span> <span class="n">feature_names</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">threshold</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">class_</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">class_name</span> <span class="o">=</span> <span class="n">class_names</span><span class="p">[</span><span class="n">class_</span><span class="p">]</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">children_left</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">children_right</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">left</span> <span class="o">==</span> <span class="n">right</span><span class="p">:</span>
            <span class="c1"># Leaf node</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span> <span class="o">+</span> <span class="n">class_name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;if </span><span class="si">{</span><span class="n">feature_name</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">_tree</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;else:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">_tree</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;if </span><span class="si">{</span><span class="n">feature_name</span><span class="si">}</span><span class="s2"> &lt;= </span><span class="si">{</span><span class="n">threshold</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">_tree</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;else:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">_tree</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="n">ROOT_INDEX</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">_tree</span><span class="p">(</span><span class="n">ROOT_INDEX</span><span class="p">,</span> <span class="n">indent</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">friendly_decision_tree</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">vec</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>if function-sqrt:
  if number &lt;= 13.0000:
    BUG
  else:
    NO_BUG
else:
  NO_BUG
</pre></div>
</div>
</div>
</div>
<p>We can see that our initial hypothesis is that the feature <code class="docutils literal notranslate"><span class="pre">function-sqrt</span></code> must be greater than 0.5 (i.e., present) and the feature <code class="docutils literal notranslate"><span class="pre">number</span></code> must be less or equal than 13 in order to produce a bug. The decision rule is not yet perfect, thus we need to refine our decision tree!</p>
</section>
<section id="learning-a-decision-tree">
<h3>Learning a Decision Tree<a class="headerlink" href="#learning-a-decision-tree" title="Link to this heading">#</a></h3>
<p>For <em>Alhazen’s</em> second step (Train Classification Model), we write a function <code class="docutils literal notranslate"><span class="pre">train_tree(data)</span></code> that trains a decision tree on a given data frame:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="k">def</span><span class="w"> </span><span class="nf">train_tree</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">_classes</span><span class="o">.</span><span class="n">DecisionTreeClassifier</span>

</pre></div>
</div>
<p>The function requires the following parameter:</p>
<ul class="simple">
<li><p>data: a <code class="docutils literal notranslate"><span class="pre">pandas</span></code> data frame containing the parsed and extracted features and the outcome of the executed input sample (oracle).</p></li>
</ul>
<p>For instance, the data frame may look similar to this:</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>feature_1</p></th>
<th class="head"><p>feature_2</p></th>
<th class="head"><p>…</p></th>
<th class="head"><p>oracle</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>0</p></td>
<td><p>…</p></td>
<td><p>‘BUG’</p></td>
</tr>
<tr class="row-odd"><td><p>0</p></td>
<td><p>1</p></td>
<td><p>…</p></td>
<td><p>‘NO_BUG’</p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>Note:</strong> Each row of <code class="docutils literal notranslate"><span class="pre">data['oracle']</span></code> is of type <code class="docutils literal notranslate"><span class="pre">OracleResult</span></code>.
However, sci-kit learn requires an array of strings.
We have to convert them to learn the decision tree.</p>
<p><strong>OUTPUT</strong>: the function returns a learned decision tree of type <code class="docutils literal notranslate"><span class="pre">_sklearn.tree._classes.DecisionTreeClassifier_</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">train_tree</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">sample_bug_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;oracle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;BUG&quot;</span><span class="p">)])</span>
    <span class="k">assert</span> <span class="n">sample_bug_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;No bug samples found&quot;</span>
    <span class="n">sample_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="n">clf</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                     <span class="n">min_samples_split</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>  <span class="c1"># minimal value</span>
                                     <span class="n">max_features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                     <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="c1"># max depth of the decision tree</span>
                                     <span class="n">class_weight</span><span class="o">=</span><span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="s2">&quot;BUG&quot;</span><span class="p">):</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">sample_bug_count</span><span class="p">),</span>
                                                   <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;NO_BUG&quot;</span><span class="p">):</span>
                                                       <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">sample_count</span> <span class="o">-</span> <span class="n">sample_bug_count</span><span class="p">))})</span>
    <span class="n">clf</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;oracle&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;oracle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
    <span class="c1"># MARTIN: This is optional, but is a nice extesion that results in nicer decision trees</span>
    <span class="c1"># clf = treetools.remove_infeasible(clf, features)</span>
    <span class="k">return</span> <span class="n">clf</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="step-3-extract-feature-requirements">
<h2>Step 3: Extract Feature Requirements<a class="headerlink" href="#step-3-extract-feature-requirements" title="Link to this heading">#</a></h2>
<p>In this section, we will extract the learned features from the decision tree.
Again, let us first test this manually on our calculator example.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Features for each input, one dict per input</span>
<span class="n">features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">&#39;function-sqrt&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;function-cos&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;function-sin&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">900</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;function-sqrt&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;function-cos&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;function-sin&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;function-sqrt&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;function-cos&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;function-sin&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;function-sqrt&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;function-cos&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;function-sin&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">10</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;function-sqrt&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;function-cos&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;function-sin&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">:</span> <span class="mi">36</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;function-sqrt&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;function-cos&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;function-sin&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">58</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;function-sqrt&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;function-cos&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;function-sin&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">:</span> <span class="mi">27</span><span class="p">},</span>
<span class="p">]</span>

<span class="c1"># Labels for each input</span>
<span class="n">oracle</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;BUG&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NO_BUG&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BUG&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NO_BUG&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NO_BUG&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NO_BUG&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NO_BUG&quot;</span>
<span class="p">]</span>

<span class="c1"># We can use the sklearn DictVectorizer to transform the features to numpy array:</span>
<span class="c1"># Notice: Use the correct labeling of the feature_names</span>

<span class="c1"># vec = DictVectorizer()</span>
<span class="c1"># X_vec = vec.fit_transform(features).toarray()</span>
<span class="c1"># feature_names = vec.get_feature_names_out()</span>

<span class="c1"># We can also use a pandas DataFrame and directly parse it to the decision tree learner</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;function-sqrt&#39;</span><span class="p">,</span> <span class="s1">&#39;function-cos&#39;</span><span class="p">,</span> <span class="s1">&#39;function-sin&#39;</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">]</span>
<span class="n">X_data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>

<span class="c1"># Fix the random state to produce a deterministic result (for illustration purposes only)</span>
<span class="n">clf</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Train with DictVectorizer</span>
<span class="c1"># **Note:** The sklearn `DictVectorizer` uses an internal sort function as default. This will result in different feature_name indices. If you want to use the `Dictvectorizer` please ensure that you only access the feature_names with the function `vec.get_feature_names_out()`.</span>
<span class="c1"># We recommend that you use the `pandas` data frame, since this is also the format used in the feedback loop.</span>
<span class="c1"># clf = clf.fit(X_vec, oracle)</span>

<span class="c1"># Train with Pandas Dataframe</span>
<span class="n">clf</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_data</span><span class="p">,</span> <span class="n">oracle</span><span class="p">)</span>

<span class="n">dot_data</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">export_graphviz</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">out_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">feature_names</span><span class="o">=</span><span class="n">feature_names</span><span class="p">,</span>
                                <span class="n">class_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;BUG&quot;</span><span class="p">,</span> <span class="s2">&quot;NO BUG&quot;</span><span class="p">],</span>
                                <span class="n">filled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rounded</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">graphviz</span><span class="o">.</span><span class="n">Source</span><span class="p">(</span><span class="n">dot_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">graph</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/a0f9f9730402506724964fe0baf5da2db7596d5d56a3791ba51f2540ef1a772d.svg" src="_images/a0f9f9730402506724964fe0baf5da2db7596d5d56a3791ba51f2540ef1a772d.svg" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">friendly_decision_tree</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">class_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NO_BUG&#39;</span><span class="p">,</span> <span class="s1">&#39;BUG&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>if function-sqrt:
  if number &lt;= 13.0000:
    BUG
  else:
    NO_BUG
else:
  NO_BUG
</pre></div>
</div>
</div>
</div>
<section id="excursion-tree-helper-functions">
<h3>Excursion: Tree helper functions<a class="headerlink" href="#excursion-tree-helper-functions" title="Link to this heading">#</a></h3>
<p>We bundle several functions that are helpful when working with decision trees.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">all_path</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Iterate over all path in a decision tree. Path will be represented as</span>
<span class="sd">    a list of integers, each integer is the index of a node in the clf.tree_ structure.&quot;&quot;&quot;</span>
    <span class="n">left</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">children_left</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
    <span class="n">right</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">children_right</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">left</span> <span class="o">==</span> <span class="n">right</span><span class="p">:</span>
        <span class="k">yield</span> <span class="p">[</span><span class="n">node</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">all_path</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">left</span><span class="p">):</span>
            <span class="k">yield</span> <span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">+</span> <span class="n">path</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">all_path</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
            <span class="k">yield</span> <span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">+</span> <span class="n">path</span>


<span class="k">def</span><span class="w"> </span><span class="nf">path_samples</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the number of samples for this path. &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">n_node_samples</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">generic_feature_names</span><span class="p">(</span><span class="n">clf</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gives a list of feature names of the form f1, f2, ...&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;f</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">n_features</span><span class="p">)]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">box</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;For a decision tree classifier clf and a path path (as returned, e.g. by all_path),</span>
<span class="sd">    this method gives a pandas DataFrame with the min and max of each feature value on the given path.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">feature_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">feature_names</span> <span class="o">=</span> <span class="n">generic_feature_names</span><span class="p">(</span><span class="n">clf</span><span class="p">)</span>
    <span class="n">check_for_duplicates</span><span class="p">(</span><span class="n">feature_names</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span><span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">inf</span><span class="p">}</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">feature_names</span><span class="p">],</span>
                                  <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;feature&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span><span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()}</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">feature_names</span><span class="p">],</span>
                                  <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;feature&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="n">child</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">feature</span> <span class="o">=</span> <span class="n">feature_names</span><span class="p">[</span><span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">feature</span><span class="p">[</span><span class="n">node</span><span class="p">]]</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">threshold</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">child</span> <span class="o">==</span> <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">children_left</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span>
            <span class="n">bounds</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bounds</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">threshold</span>
    <span class="k">return</span> <span class="n">bounds</span>


<span class="k">def</span><span class="w"> </span><span class="nf">rectangles</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">colormap</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;yields matplotlib.patches rectangle objects. Each object represents a leaf of the tree.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">feature_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">feature_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;in_x&#39;</span><span class="p">,</span> <span class="s1">&#39;in_y&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="mi">2</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_names</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Rectangles can only be generated if there are at most 2 features.&quot;</span><span class="p">)</span>

    <span class="n">x_feature</span> <span class="o">=</span> <span class="n">feature_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y_feature</span> <span class="o">=</span> <span class="n">feature_names</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">all_path</span><span class="p">(</span><span class="n">clf</span><span class="p">):</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="n">feature_names</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">prediction_for_path</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">b</span><span class="p">[</span><span class="n">x_feature</span><span class="p">][</span><span class="s1">&#39;min&#39;</span><span class="p">],</span> 
                                             <span class="n">b</span><span class="p">[</span><span class="n">y_feature</span><span class="p">][</span><span class="s1">&#39;min&#39;</span><span class="p">]),</span>
                             <span class="c1"># coordinates</span>
                             <span class="n">b</span><span class="p">[</span><span class="n">x_feature</span><span class="p">][</span><span class="s1">&#39;max&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span><span class="p">[</span><span class="n">x_feature</span><span class="p">][</span><span class="s1">&#39;min&#39;</span><span class="p">],</span>  <span class="c1"># width</span>
                             <span class="n">b</span><span class="p">[</span><span class="n">y_feature</span><span class="p">][</span><span class="s1">&#39;max&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span><span class="p">[</span><span class="n">y_feature</span><span class="p">][</span><span class="s1">&#39;min&#39;</span><span class="p">],</span>  <span class="c1"># height</span>
                             <span class="n">alpha</span><span class="o">=</span><span class="mf">.2</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">rect</span>


<span class="k">def</span><span class="w"> </span><span class="nf">prediction_for_path</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OracleResult</span><span class="p">:</span>
    <span class="n">last_value</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">p_class</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">last_value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">OracleResult</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">classes_</span><span class="p">[</span><span class="n">p_class</span><span class="p">])</span>


<span class="k">def</span><span class="w"> </span><span class="nf">rule</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">class_names</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a rule from one path in the decision tree.&quot;&quot;&quot;</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="n">feature_names</span><span class="p">)</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction_for_path</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">class_names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="n">class_names</span><span class="p">[</span><span class="n">prediction</span><span class="p">]</span>

    <span class="n">feature_rules</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">feature_names</span><span class="p">:</span>
        <span class="n">min_</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="n">fname</span><span class="p">][</span><span class="s1">&#39;min&#39;</span><span class="p">]</span>
        <span class="n">max_</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="n">fname</span><span class="p">][</span><span class="s1">&#39;max&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">min_</span><span class="p">)</span> <span class="ow">and</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">max_</span><span class="p">):</span>
            <span class="k">pass</span>  <span class="c1"># no rule if both are unbound</span>
        <span class="k">elif</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">min_</span><span class="p">):</span>
            <span class="n">feature_rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> &lt;= </span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">max_</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">max_</span><span class="p">):</span>
            <span class="n">feature_rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> &gt; </span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">min_</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">feature_rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> in </span><span class="si">{:.4f}</span><span class="s2"> to </span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">min_</span><span class="p">,</span> <span class="n">max_</span><span class="p">))</span>

    <span class="k">return</span> <span class="s2">&quot; AND &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">feature_rules</span><span class="p">),</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">impurity</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">n_node_samples</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">rules</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">class_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Formats Decision trees in a rule-like representation.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">feature_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">feature_names</span> <span class="o">=</span> <span class="n">generic_feature_names</span><span class="p">(</span><span class="n">clf</span><span class="p">)</span>

    <span class="n">samples</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">n_node_samples</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;IF </span><span class="si">{2}</span><span class="s2"> THEN PREDICT &#39;</span><span class="si">{3}</span><span class="s2">&#39; (</span><span class="si">{0}</span><span class="s2">: </span><span class="si">{4:.4f}</span><span class="s2">, support: </span><span class="si">{5}</span><span class="s2"> / </span><span class="si">{1}</span><span class="s2">)&quot;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">criterion</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span>
                             <span class="o">*</span><span class="n">rule</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">class_names</span><span class="o">=</span><span class="n">class_names</span><span class="p">))</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">all_path</span><span class="p">(</span><span class="n">clf</span><span class="p">)])</span>


<span class="k">def</span><span class="w"> </span><span class="nf">grouped_rules</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">class_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Formats decision trees in a rule-like representation, grouped by class.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">feature_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">feature_names</span> <span class="o">=</span> <span class="n">generic_feature_names</span><span class="p">(</span><span class="n">clf</span><span class="p">)</span>

    <span class="n">rules</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">all_path</span><span class="p">(</span><span class="n">clf</span><span class="p">):</span>
        <span class="n">rulestr</span><span class="p">,</span> <span class="n">clz</span><span class="p">,</span> <span class="n">impurity</span><span class="p">,</span> <span class="n">support</span> <span class="o">=</span> <span class="n">rule</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">class_names</span><span class="o">=</span><span class="n">class_names</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="n">feature_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">clz</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
            <span class="n">rules</span><span class="p">[</span><span class="n">clz</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rules</span><span class="p">[</span><span class="n">clz</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">rulestr</span><span class="p">,</span> <span class="n">impurity</span><span class="p">,</span> <span class="n">support</span><span class="p">))</span>

    <span class="n">res</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">n_node_samples</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">clz</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
        <span class="n">rulelist</span> <span class="o">=</span> <span class="n">rules</span><span class="p">[</span><span class="n">clz</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">{}</span><span class="s2">:</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">clz</span><span class="p">)</span>
        <span class="n">rl</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">: </span><span class="si">{:.4f}</span><span class="s2">, support: </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">clf</span><span class="o">.</span><span class="n">criterion</span><span class="p">,</span> <span class="n">impurity</span><span class="p">,</span> <span class="n">support</span><span class="p">,</span> <span class="n">samples</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">impurity</span><span class="p">,</span> <span class="n">support</span> <span class="ow">in</span> <span class="n">rulelist</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">or &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rl</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">check_for_duplicates</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Duplicate name: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">is_leaf</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;returns true if the given node is a leaf.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">children_left</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">==</span> <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">children_right</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">leaf_label</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;returns the index of the class at this node. The node must be a leaf.&quot;&quot;&quot;</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">is_leaf</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">node</span><span class="p">))</span>
    <span class="n">occs</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">maxi</span> <span class="o">=</span> <span class="n">occs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">occs</span><span class="p">)),</span> <span class="n">occs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">maxi</span> <span class="o">&lt;</span> <span class="n">o</span><span class="p">:</span>
            <span class="n">maxi</span> <span class="o">=</span> <span class="n">o</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">i</span>
    <span class="k">return</span> <span class="n">idx</span>


<span class="k">def</span><span class="w"> </span><span class="nf">find_existence_index</span><span class="p">(</span><span class="n">features</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Feature</span><span class="p">],</span> <span class="n">feature</span><span class="p">:</span> <span class="n">Feature</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">features</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ExistenceFeature</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">key</span><span class="p">()</span> <span class="o">==</span> <span class="n">feature</span><span class="o">.</span><span class="n">key</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">idx</span>
    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;There is no existence feature with this key!&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">remove_infeasible</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Feature</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">node_count</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_leaf</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
            <span class="n">feature</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">feature</span><span class="p">[</span><span class="n">node</span><span class="p">]]</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">threshold</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">feature</span><span class="o">.</span><span class="n">is_feasible</span><span class="p">(</span><span class="n">threshold</span><span class="p">):</span>
                <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">feature</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">find_existence_index</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">feature</span><span class="p">)</span>
                <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">threshold</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="k">return</span> <span class="n">clf</span>


<span class="k">def</span><span class="w"> </span><span class="nf">iterate_nodes</span><span class="p">(</span><span class="n">clf</span><span class="p">):</span>
    <span class="n">stack</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">while</span> <span class="mi">0</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">yield</span> <span class="n">node</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_leaf</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">children_left</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">children_right</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>


<span class="k">def</span><span class="w"> </span><span class="nf">count_nodes</span><span class="p">(</span><span class="n">clf</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">iterate_nodes</span><span class="p">(</span><span class="n">clf</span><span class="p">)))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">count_leaves</span><span class="p">(</span><span class="n">clf</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">([</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">iterate_nodes</span><span class="p">(</span><span class="n">clf</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_leaf</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">n</span><span class="p">)])</span>


<span class="k">def</span><span class="w"> </span><span class="nf">list_features</span><span class="p">(</span><span class="n">clf</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">feature</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">iterate_nodes</span><span class="p">(</span><span class="n">clf</span><span class="p">)]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">remove_unequal_decisions</span><span class="p">(</span><span class="n">clf</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method rewrites a decision tree classifier to remove nodes where the same</span>
<span class="sd">    decision is taken on both sides.</span>

<span class="sd">    :param clf: a decision tree classifier</span>
<span class="sd">    :return: the same classifier, rewritten</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">while</span> <span class="n">changed</span><span class="p">:</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">node_count</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_leaf</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">is_leaf</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">children_left</span><span class="p">[</span><span class="n">node</span><span class="p">])</span> <span class="ow">and</span> <span class="n">is_leaf</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">children_right</span><span class="p">[</span><span class="n">node</span><span class="p">])):</span>
                <span class="c1"># both children of this node are leaves</span>
                <span class="n">left_label</span> <span class="o">=</span> <span class="n">leaf_label</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">children_left</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
                <span class="n">right_label</span> <span class="o">=</span> <span class="n">leaf_label</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">children_right</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">left_label</span> <span class="o">==</span> <span class="n">right_label</span><span class="p">:</span>
                    <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">children_left</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">children_right</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">clf</span><span class="o">.</span><span class="n">tree_</span><span class="o">.</span><span class="n">feature</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
                    <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">assert</span><span class="p">(</span><span class="n">left_label</span> <span class="o">==</span> <span class="n">leaf_label</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">node</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">clf</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id1">
<h3>End of Excursion<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
</section>
<section id="excursion-converting-trees-to-paths">
<h3>Excursion: Converting Trees to Paths<a class="headerlink" href="#excursion-converting-trees-to-paths" title="Link to this heading">#</a></h3>
<p>We bundle a number of helper functions that extract paths from trees.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TreeRequirement</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature</span><span class="p">:</span> <span class="n">Feature</span><span class="p">,</span> <span class="n">mini</span><span class="p">,</span> <span class="n">maxi</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__feature</span><span class="p">:</span> <span class="n">Feature</span> <span class="o">=</span> <span class="n">feature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__mini</span> <span class="o">=</span> <span class="n">mini</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__maxi</span> <span class="o">=</span> <span class="n">maxi</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">feature</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Feature</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__feature</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a vector of booleans, suitable for selecting in a pandas data frame.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mini</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__feature</span><span class="o">.</span><span class="n">name</span><span class="p">()]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__maxi</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__maxi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mini</span> <span class="o">&lt;=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__feature</span><span class="o">.</span><span class="n">name</span><span class="p">()]</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__mini</span> <span class="o">&lt;=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__feature</span><span class="o">.</span><span class="n">name</span><span class="p">()])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__feature</span><span class="o">.</span><span class="n">name</span><span class="p">()]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__maxi</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">mini</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mini</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">maxi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__maxi</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_key</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__feature</span><span class="o">.</span><span class="n">key</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_binary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__feature</span><span class="o">.</span><span class="n">is_binary</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bounds</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_binary</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mini</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__maxi</span><span class="p">:</span>
                <span class="c1"># feature is NOT included</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;!</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__feature</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mini</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__maxi</span><span class="p">:</span>
                <span class="c1"># feature is included</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__feature</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;How is this possible?&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__mini</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__maxi</span><span class="p">)):</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__feature</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">}</span><span class="s2"> in [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__mini</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__maxi</span><span class="si">}</span><span class="s2">]&quot;</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__maxi</span><span class="p">):</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__feature</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">}</span><span class="s2"> &lt;= </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__maxi</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__feature</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__mini</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_str_ext</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__mini</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__maxi</span><span class="p">)):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__feature</span><span class="si">}</span><span class="s2"> in [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__mini</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__maxi</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__maxi</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__feature</span><span class="si">}</span><span class="s2"> &lt;= </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__maxi</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__feature</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__mini</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_neg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bounds</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_binary</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mini</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__maxi</span><span class="p">:</span>
                <span class="c1"># feature is NOT included, so, the negated condition is to include it</span>
                <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__feature</span><span class="o">.</span><span class="n">name</span><span class="p">()]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mini</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__maxi</span><span class="p">:</span>
                <span class="c1"># feature is included, so exclude it</span>
                <span class="k">return</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;!</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__feature</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;How is this possible?&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__mini</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__maxi</span><span class="p">)):</span>
                <span class="k">return</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__feature</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">}</span><span class="s2"> in [</span><span class="si">{</span><span class="n">bounds</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">__feature</span><span class="o">.</span><span class="n">name</span><span class="p">()]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__mini</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__feature</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">}</span><span class="s2"> in [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__maxi</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">bounds</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">__feature</span><span class="o">.</span><span class="n">name</span><span class="p">()]</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__maxi</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__feature</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">}</span><span class="s2"> &lt;= </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__maxi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__feature</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__mini</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_neg_ext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bounds</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__mini</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__maxi</span><span class="p">)):</span>
            <span class="k">return</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__feature</span><span class="si">}</span><span class="s2"> in [</span><span class="si">{</span><span class="n">bounds</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">__feature</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__mini</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__feature</span><span class="si">}</span><span class="s2"> in [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__maxi</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">bounds</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">__feature</span><span class="p">]</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__maxi</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__feature</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__maxi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__feature</span><span class="si">}</span><span class="s2"> &lt;= </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__mini</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TreePath</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samplefile</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="n">is_bug</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">requirements</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">TreeRequirement</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sample</span> <span class="o">=</span> <span class="n">samplefile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__is_bug</span> <span class="o">=</span> <span class="n">is_bug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__requirements</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">TreeRequirement</span><span class="p">]</span> <span class="o">=</span> <span class="n">requirements</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_bug</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_bug</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requirements</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__requirements</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;abs_file&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__requirements</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">lower_middle</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="n">end</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">start</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">start</span> <span class="o">+</span> <span class="p">((</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">upper_middle</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="n">end</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">end</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">start</span> <span class="o">+</span> <span class="p">((</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">min_digits</span><span class="p">(</span><span class="n">mini</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="s2">&quot;1&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">mini</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">max_digits</span><span class="p">(</span><span class="n">maxi</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="mi">9</span><span class="p">]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">maxi</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">tree_to_paths</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Feature</span><span class="p">]):</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># go through tree leaf by leaf</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">all_path</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
        <span class="n">requirements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">is_bug</span> <span class="o">=</span> <span class="n">OracleResult</span><span class="o">.</span><span class="n">BUG</span> <span class="o">==</span> <span class="n">prediction_for_path</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="c1"># find the requirements</span>
        <span class="n">box_</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="n">features</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">box_</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">mini</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span>
            <span class="n">maxi</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">mini</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">maxi</span><span class="p">)):</span>
                <span class="n">requirements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TreeRequirement</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">mini</span><span class="p">,</span> <span class="n">maxi</span><span class="p">))</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TreePath</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_bug</span><span class="p">,</span> <span class="n">requirements</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">paths</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We provide a functionallity to extract the paths from a decision tree.</span>
<span class="n">all_paths</span> <span class="o">=</span> <span class="n">tree_to_paths</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here is an example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_paths</span><span class="p">):</span>
    <span class="n">string_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">get_str_ext</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">box_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
        <span class="n">string_path</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">path</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">box_</span><span class="p">)</span><span class="o">.</span><span class="n">get_str_ext</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Path </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">string_path</span><span class="si">}</span><span class="s2">, is_bug: </span><span class="si">{</span><span class="n">path</span><span class="o">.</span><span class="n">is_bug</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Path 0: function-sqrt &lt;= 0.5, is_bug: False
Path 1: function-sqrt &gt; 0.5 number &lt;= 13.0, is_bug: True
Path 2: function-sqrt &gt; 0.5 number &gt; 13.0, is_bug: False
</pre></div>
</div>
</div>
</div>
</section>
<section id="id2">
<h3>End of Excursion<a class="headerlink" href="#id2" title="Link to this heading">#</a></h3>
</section>
</section>
<section id="step-4-generating-new-samples">
<h2>Step 4: Generating New Samples<a class="headerlink" href="#step-4-generating-new-samples" title="Link to this heading">#</a></h2>
<p>The next step is to generate new samples.
For this purpose, we <em>negate</em> the requirements on a path to refine and refute the decision tree.</p>
<section id="negating-requirements">
<h3>Negating Requirements<a class="headerlink" href="#negating-requirements" title="Link to this heading">#</a></h3>
<p>First we will determine some boundaries to obtain better path negations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span><span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()}</span>
                           <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">feature_names</span><span class="p">],</span>
                          <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;feature&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We can use the function <code class="docutils literal notranslate"><span class="pre">path.get(i).get_neg_ext(bounds)</span></code> to obtain a negation for a single requirement on a path (indexed with <code class="docutils literal notranslate"><span class="pre">i</span></code>).</p>
<p>Let’s verify if we can negate a whole path.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_paths</span><span class="p">):</span>
    <span class="n">negated_string_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">get_neg_ext</span><span class="p">(</span><span class="n">bounds</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">box_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
        <span class="n">negated_string_path</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">box_</span><span class="p">)</span><span class="o">.</span><span class="n">get_neg_ext</span><span class="p">(</span><span class="n">bounds</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Path </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">negated_string_path</span><span class="si">}</span><span class="s2">, is_bug: </span><span class="si">{</span><span class="n">path</span><span class="o">.</span><span class="n">is_bug</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Path 0: function-sqrt &gt; 0.5, is_bug: False
Path 1: function-sqrt &lt;= 0.5 number &gt; 13.0, is_bug: True
Path 2: function-sqrt &lt;= 0.5 number &lt;= 13.0, is_bug: False
</pre></div>
</div>
</div>
</div>
</section>
<section id="systematically-negating-paths">
<h3>Systematically Negating Paths<a class="headerlink" href="#systematically-negating-paths" title="Link to this heading">#</a></h3>
<p>We will use the Decision tree and extract new input specifications to refine or refute our hypothesis (See Section 4.1 “Extracting Prediction Paths” in \cite{Kampmann2020}).
These input specifications will be parsed to the input generator that tries to generate new inputs that fulfill the defined input specifications.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">extracting_prediction_paths</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="c1"># determine the bounds</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span><span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()}</span>
                           <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">feature_names</span><span class="p">],</span>
                          <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;feature&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

    <span class="c1"># go through tree leaf by leaf</span>
    <span class="n">all_reqs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">tree_to_paths</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">):</span>
        <span class="c1"># generate conditions</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">reqs_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="nb">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;#0</span><span class="si">{}</span><span class="s2">b&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">))[</span><span class="mi">2</span><span class="p">:]</span>
            <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)),</span> <span class="n">bins</span><span class="p">):</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;1&#39;</span> <span class="o">==</span> <span class="n">b</span><span class="p">:</span>
                    <span class="n">reqs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get_neg_ext</span><span class="p">(</span><span class="n">bounds</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">reqs_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">get_str_ext</span><span class="p">()])</span>
            <span class="k">for</span> <span class="n">reqs</span> <span class="ow">in</span> <span class="n">all_combinations</span><span class="p">(</span><span class="n">reqs_list</span><span class="p">):</span>
                <span class="n">all_reqs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">reqs</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">all_reqs</span>

<span class="k">def</span><span class="w"> </span><span class="nf">all_combinations</span><span class="p">(</span><span class="n">reqs_lists</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[[]]</span>
    <span class="k">for</span> <span class="n">reqs</span> <span class="ow">in</span> <span class="n">reqs_lists</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">reqs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="p">[</span><span class="n">r</span><span class="p">])</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">t</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</div>
</div>
<p>We will use the Decision tree and extract new input specifications to refine or refute our hypothesis (See paper Section 4.1 - Extracting Prediction Paths). These input specifications will be parsed to the input generator that tries to generate new inputs that fulfill the defined input specifications.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_prediction_paths</span> <span class="o">=</span> <span class="n">extracting_prediction_paths</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">new_prediction_paths</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>function-sqrt &lt;= 0.5, number &lt;= 13.0
function-sqrt &gt; 0.5, number &gt; 13.0
function-sqrt &lt;= 0.5
function-sqrt &lt;= 0.5, number &gt; 13.0
function-sqrt &gt; 0.5, number &lt;= 13.0
function-sqrt &gt; 0.5
</pre></div>
</div>
</div>
</div>
</section>
<section id="input-specification-parser">
<h3>Input Specification Parser<a class="headerlink" href="#input-specification-parser" title="Link to this heading">#</a></h3>
<p>Once we have input specifications, we must again extract them from the decision tree so we can interpret them.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">string</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">SPEC_GRAMMAR</span><span class="p">:</span> <span class="n">Grammar</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;&lt;req_list&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;req_list&gt;&quot;</span><span class="p">:</span> 
        <span class="p">[</span><span class="s2">&quot;&lt;req&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;req&gt;&quot;&quot;, &quot;&quot;&lt;req_list&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;req&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;&lt;feature&gt;&quot;&quot; &quot;&quot;&lt;quant&gt;&quot;&quot; &quot;&quot;&lt;num&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;feature&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;exists(&lt;string&gt;)&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;num(&lt;string&gt;)&quot;</span><span class="p">,</span>
                  <span class="c1"># currently not used</span>
                  <span class="s2">&quot;char(&lt;string&gt;)&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;length(&lt;string&gt;)&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;quant&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;=&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;=&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;num&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;-&lt;value&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;value&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;value&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;&lt;integer&gt;.&lt;integer&gt;&quot;</span><span class="p">,</span>
         <span class="s2">&quot;&lt;integer&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;integer&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;&lt;digit&gt;&lt;integer&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;digit&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;digit&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span> <span class="s2">&quot;6&quot;</span><span class="p">,</span> <span class="s2">&quot;7&quot;</span><span class="p">,</span> <span class="s2">&quot;8&quot;</span><span class="p">,</span> <span class="s2">&quot;9&quot;</span><span class="p">],</span>

    <span class="s1">&#39;&lt;string&gt;&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&lt;letters&gt;&#39;</span><span class="p">],</span>
    <span class="s1">&#39;&lt;letters&gt;&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&lt;letter&gt;&lt;letters&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;letter&gt;&#39;</span><span class="p">],</span>
    <span class="s1">&#39;&lt;letter&gt;&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">SPEC_GRAMMAR</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="excursion-validating-the-parser">
<h3>Excursion: Validating the Parser<a class="headerlink" href="#excursion-validating-the-parser" title="Link to this heading">#</a></h3>
<p>Let’s validate our grammar, by using the grammar to produce 100 sample requirement specifications</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">g</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">SPEC_GRAMMAR</span><span class="p">,</span> <span class="n">max_nonterminals</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">earley</span> <span class="o">=</span> <span class="n">EarleyParser</span><span class="p">(</span><span class="n">SPEC_GRAMMAR</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>char(o/vy) &gt;= 7
exists(E) &lt;= 822.9
length(VnMoy) &gt; -6460.3, exists(T) &gt; 6, num(b) &gt;= -1.03
length(f) &gt;= -7677, char(O:t) &lt; -6
length(x`) &lt;= 08
num(@) &gt;= 1.695, exists(=7&amp;) &gt; 23
exists(rV) &gt;= -5.9, exists(|) &lt;= 6969.0
length(bd) &gt;= 4.8
num(8) &lt;= 44.870, length(8xz&#39;) &lt;= 13
exists(H) &gt;= 0.4, num(#) &gt; 1, exists(Q) &gt;= -600.19
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">g</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">SPEC_GRAMMAR</span><span class="p">,</span> <span class="n">max_nonterminals</span><span class="o">=</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">earley</span> <span class="o">=</span> <span class="n">EarleyParser</span><span class="p">(</span><span class="n">SPEC_GRAMMAR</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">earley</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">sample</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">tree_to_string</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span> <span class="o">==</span> <span class="n">sample</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tree_to_string</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">sample</span><span class="si">}</span><span class="s2"> are not equal&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s also try with some real requirement specifications:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">earley</span> <span class="o">=</span> <span class="n">EarleyParser</span><span class="p">(</span><span class="n">SPEC_GRAMMAR</span><span class="p">)</span>
<span class="n">teststrings</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;exists(&lt;function&gt;@0) &gt; 0.5, exists(&lt;term&gt;@0) &lt;= 0.5, exists(&lt;value&gt;@1) &lt;= 0.5&#39;</span><span class="p">,</span>
               <span class="s1">&#39;exists(&lt;digit&gt;@9) &lt;= 0.5, exists(&lt;function&gt;@0) &gt; 0.5, num(&lt;term&gt;) &gt; 0.05000000074505806&#39;</span><span class="p">,</span>
               <span class="s1">&#39;exists(&lt;digit&gt;@2) &lt;= 0.5, exists(&lt;function&gt;@0) &lt; 0.5, num(&lt;term&gt;) &lt;= 0.05000000074505806&#39;</span><span class="p">,</span>
               <span class="s1">&#39;exists(&lt;function&gt;@0) &gt; 0.5, num(&lt;term&gt;) &gt; -3965678.1875&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">teststrings</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">earley</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">sample</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">tree_to_string</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span> <span class="o">==</span> <span class="n">teststrings</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> \
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tree_to_string</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">teststrings</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="si">}</span><span class="s2"> are not equal&quot;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id3">
<h3>End of Excursion<a class="headerlink" href="#id3" title="Link to this heading">#</a></h3>
</section>
<section id="retrieving-new-input-specifications">
<h3>Retrieving New input Specifications<a class="headerlink" href="#retrieving-new-input-specifications" title="Link to this heading">#</a></h3>
<p>The following classes represent requirements for the test cases to be generated.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SpecRequirement</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This class represents a requirement for a new input sample that should be generated.</span>
<span class="sd">    This class contains the feature that should be fullfiled (Feature), a quantifier</span>
<span class="sd">    (&quot;&lt;&quot;, &quot;&gt;&quot;, &quot;&lt;=&quot;, &quot;&gt;=&quot;) and a value. For instance exist(feature) &gt;= 0.5 states that</span>
<span class="sd">    the syntactical existence feature should be used to produce a new input.</span>

<span class="sd">    feature  : Is the associated feature class</span>
<span class="sd">    quant    : The quantifier</span>
<span class="sd">    value    : The value of the requirement. Note that for existence features this value</span>
<span class="sd">                is allways between 0 and 1.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature</span><span class="p">:</span> <span class="n">Feature</span><span class="p">,</span> <span class="n">quantificator</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="p">:</span> <span class="n">Feature</span> <span class="o">=</span> <span class="n">feature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quant</span> <span class="o">=</span> <span class="n">quantificator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Requirement(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quant</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Requirement(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quant</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">friendly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="p">,</span> <span class="n">ExistenceFeature</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">friendly_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="n">value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;not </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">friendly_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">friendly_name</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quant</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">InputSpecification</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This class represents a complete input specification of a new input. A input specification</span>
<span class="sd">    consists of one or more requirements.</span>
<span class="sd">    requirements  : Is a list of all requirements that must be used.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requirements</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SpecRequirement</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirements</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SpecRequirement</span><span class="p">]</span> <span class="o">=</span> <span class="n">requirements</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requirements</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;InputSpecification(</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">friendly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot; and &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">friendly</span><span class="p">()</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requirements</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_all_subtrees</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">,</span> <span class="n">non_terminal</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Iteratively returns a list of subtrees that start with a given non_terminal.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">subtrees</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">children</span><span class="p">)</span> <span class="o">=</span> <span class="n">derivation_tree</span>

    <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="n">non_terminal</span><span class="p">:</span>
        <span class="n">subtrees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
        <span class="n">subtrees</span> <span class="o">=</span> <span class="n">subtrees</span> <span class="o">+</span> <span class="n">get_all_subtrees</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">non_terminal</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">subtrees</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">create_new_input_specification</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">,</span> <span class="n">all_features</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InputSpecification</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function creates a new input specification for a parsed decision tree path.</span>
<span class="sd">    The input derivation_tree corresponds to a already negated path in the decision tree.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">requirement_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">get_all_subtrees</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">,</span> <span class="s1">&#39;&lt;req&gt;&#39;</span><span class="p">):</span>
        <span class="n">feature_name</span> <span class="o">=</span> <span class="n">tree_to_string</span><span class="p">(</span><span class="n">get_all_subtrees</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="s1">&#39;&lt;feature&gt;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">quant</span> <span class="o">=</span> <span class="n">tree_to_string</span><span class="p">(</span><span class="n">get_all_subtrees</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="s1">&#39;&lt;quant&gt;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">tree_to_string</span><span class="p">(</span><span class="n">get_all_subtrees</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="s1">&#39;&lt;num&gt;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">feature_class</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_features</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">feature_name</span><span class="p">:</span>
                <span class="n">feature_class</span> <span class="o">=</span> <span class="n">f</span>

        <span class="n">requirement_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SpecRequirement</span><span class="p">(</span><span class="n">feature_class</span><span class="p">,</span> <span class="n">quant</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">InputSpecification</span><span class="p">(</span><span class="n">requirement_list</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_all_input_specifications</span><span class="p">(</span><span class="n">dec_tree</span><span class="p">,</span>
                                 <span class="n">all_features</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Feature</span><span class="p">],</span>
                                 <span class="n">feature_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                                 <span class="n">data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">InputSpecification</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Returns a complete list new input specification that were extracted from a learned decision tree.</span>

<span class="sd">    INPUT:</span>
<span class="sd">        - dec_tree       : The learned decision tree.</span>
<span class="sd">        - all_features   : A list of all features</span>
<span class="sd">        - feature_names  : The list of the feature names (feature.name)</span>
<span class="sd">        - data.          : The data that was used to learn the decision tree</span>

<span class="sd">    OUTPUT:</span>
<span class="sd">        - Returns a list of InputSpecifications</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">prediction_paths</span> <span class="o">=</span> <span class="n">extracting_prediction_paths</span><span class="p">(</span><span class="n">dec_tree</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">input_specifications</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># parse all extracted paths</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">prediction_paths</span><span class="p">:</span>
        <span class="n">earley</span> <span class="o">=</span> <span class="n">EarleyParser</span><span class="p">(</span><span class="n">SPEC_GRAMMAR</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">earley</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                <span class="n">input_specifications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">create_new_input_specification</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">all_features</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
            <span class="c1"># Catch Parsing Syntax Errors: num(&lt;term&gt;) in [-900, 0] will fail; Might fix later</span>
            <span class="c1"># For now, inputs following that form will be ignored</span>
            <span class="k">pass</span>

    <span class="k">return</span> <span class="n">input_specifications</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="excursion-testing-specifications">
<h3>Excursion: Testing Specifications<a class="headerlink" href="#excursion-testing-specifications" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample_prediction_paths</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;exists(&lt;function&gt;@0) &gt; 0.5, num(&lt;term&gt;) &lt;= -38244758.0&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;exists(&lt;digit&gt;@7) &lt;= 0.5, exists(&lt;function&gt;@0) &gt; 0.5, num(&lt;term&gt;) &lt;= 0.05000000074505806&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;exists(&lt;digit&gt;) &gt; 1.5, exists(&lt;function&gt;@0) &gt; 0.5, num(&lt;term&gt;) &lt;= 0.21850000321865082&#39;</span><span class="p">,</span> 
                        <span class="s1">&#39;exists(&lt;function&gt;@0) &gt; 0.5&#39;</span><span class="p">]</span>

<span class="n">expected_input_specifications</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;InputSpecification(Requirement(exists(&lt;function&gt;@0) &gt; 0.5), Requirement(num(&lt;term&gt;) &lt;= -38244758.0))&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;InputSpecification(Requirement(exists(&lt;digit&gt;@7) &lt;= 0.5), Requirement(exists(&lt;function&gt;@0) &gt; 0.5), Requirement(num(&lt;term&gt;) &lt;= 0.05000000074505806))&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;InputSpecification(Requirement(exists(&lt;digit&gt;) &gt; 1.5), Requirement(exists(&lt;function&gt;@0) &gt; 0.5), Requirement(num(&lt;term&gt;) &lt;= 0.21850000321865082))&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;InputSpecification(Requirement(exists(&lt;function&gt;@0) &gt; 0.5))&#39;</span><span class="p">]</span>

<span class="n">all_features</span> <span class="o">=</span> <span class="n">extract_all_features</span><span class="p">(</span><span class="n">CALC_GRAMMAR</span><span class="p">)</span>

<span class="n">earley</span> <span class="o">=</span> <span class="n">EarleyParser</span><span class="p">(</span><span class="n">SPEC_GRAMMAR</span><span class="p">)</span>
<span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample_prediction_paths</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">earley</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">sample</span><span class="p">):</span>
        <span class="n">input_specification</span> <span class="o">=</span> <span class="n">create_new_input_specification</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">all_features</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">input_specification</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected_input_specifications</span><span class="p">[</span><span class="n">count</span><span class="p">],</span> \
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">input_specification</span><span class="p">)</span><span class="si">}</span><span class="s2"> is not equal to </span><span class="si">{</span><span class="n">expected_input_specifications</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>If no assertion is triggered, then everything seems to work.</p>
</section>
<section id="id4">
<h3>End of Excursion<a class="headerlink" href="#id4" title="Link to this heading">#</a></h3>
<p>We implement a <em>Grammar-Based Input Generator</em> that generates new input samples from a List of <code class="docutils literal notranslate"><span class="pre">InputSpecifications</span></code>.
The input specifications are extracted from the decision tree boundaries in the previous Step 3: <code class="docutils literal notranslate"><span class="pre">RequirementExtraction</span></code>.</p>
<p>An <code class="docutils literal notranslate"><span class="pre">InputSpecification</span></code> consists of <strong>1 to n</strong> many predicates or requirements (e.g. <code class="docutils literal notranslate"><span class="pre">&lt;feature&gt;</span> <span class="pre">&gt;=</span> <span class="pre">value</span></code>, or <code class="docutils literal notranslate"><span class="pre">num(&lt;term&gt;)</span> <span class="pre">&lt;=</span> <span class="pre">13</span></code>).
We generate a new input for each <code class="docutils literal notranslate"><span class="pre">InputSpecification</span></code>.
The new input fulfills all the given requirements of an <code class="docutils literal notranslate"><span class="pre">InputSpecification</span></code>.</p>
<p>For further details, please refer to Section 4.4 and 4.5 of \cite{Kampmann2020} and the Chapter <a class="reference external" href="https://www.fuzzingbook.org/html/GrammarFuzzer.html">Efficient Grammar Fuzzing</a> in the Fuzzing Book.</p>
<p>We define a function <code class="docutils literal notranslate"><span class="pre">generate_samples()</span></code> with the following input parameters:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">grammar</span></code>: the grammar used to produce new inputs (e.g. the CALCULATOR-Grammar)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">new_input_specification</span></code>: a List of new inputs specifications (type <code class="docutils literal notranslate"><span class="pre">List[InputSpecification]</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">timeout</span></code>: a max time budget. Return the generated inputs when the time budget is exceeded.</p></li>
</ul>
<p>The function returns a list of new inputs that are specified by the given input specifications.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">chain</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">best_trees</span><span class="p">(</span><span class="n">forest</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">grammar</span><span class="p">):</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">tree_to_string</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">forest</span><span class="p">]</span>
    <span class="n">fulfilled_fractions</span><span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
        <span class="n">gen_features</span> <span class="o">=</span> <span class="n">collect_features</span><span class="p">([</span><span class="n">sample</span><span class="p">],</span> <span class="n">grammar</span><span class="p">)</span>

        <span class="c1"># calculate percentage of fulfilled requirements (used to rank the sample)</span>
        <span class="n">fulfilled_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">requirements</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">requirements</span><span class="p">:</span>
            <span class="c1"># for now, interpret requirement(exists(&lt;...&gt;) &lt;= number) as false and requirement(exists(&lt;...&gt;) &gt; number) as true</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">feature</span><span class="p">,</span> <span class="n">ExistenceFeature</span><span class="p">):</span>
                <span class="n">expected</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">quant</span> <span class="o">==</span> <span class="s1">&#39;&gt;&#39;</span> <span class="ow">or</span> <span class="n">req</span><span class="o">.</span><span class="n">quant</span> <span class="o">==</span> <span class="s1">&#39;&gt;=&#39;</span> <span class="k">else</span> <span class="mf">0.0</span>
                <span class="n">actual</span> <span class="o">=</span> <span class="n">gen_features</span><span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">actual</span> <span class="o">==</span> <span class="n">expected</span><span class="p">:</span>
                    <span class="n">fulfilled_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>
                    <span class="c1"># print(f&#39;{req.feature} expected: {expected}, actual:{actual}&#39;)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">feature</span><span class="p">,</span> <span class="n">NumericInterpretation</span><span class="p">):</span>
                <span class="n">expected_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="n">actual_value</span> <span class="o">=</span> <span class="n">gen_features</span><span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">fulfilled</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">quant</span> <span class="o">==</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span>
                    <span class="n">fulfilled</span> <span class="o">=</span> <span class="n">actual_value</span> <span class="o">&lt;</span> <span class="n">expected_value</span>
                <span class="k">elif</span> <span class="n">req</span><span class="o">.</span><span class="n">quant</span> <span class="o">==</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">:</span>
                    <span class="n">fulfilled</span> <span class="o">=</span> <span class="n">actual_value</span> <span class="o">&lt;=</span> <span class="n">expected_value</span>
                <span class="k">elif</span> <span class="n">req</span><span class="o">.</span><span class="n">quant</span> <span class="o">==</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span>
                    <span class="n">fulfilled</span> <span class="o">=</span> <span class="n">actual_value</span> <span class="o">&gt;</span> <span class="n">expected_value</span>
                <span class="k">elif</span> <span class="n">req</span><span class="o">.</span><span class="n">quant</span> <span class="o">==</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">:</span>
                    <span class="n">fulfilled</span> <span class="o">=</span> <span class="n">actual_value</span> <span class="o">&gt;=</span> <span class="n">expected_value</span>

                <span class="k">if</span> <span class="n">fulfilled</span><span class="p">:</span>
                    <span class="n">fulfilled_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>
                    <span class="c1"># print(f&#39;{req.feature} expected: {expected_value}, actual:{actual_value}&#39;)</span>
        <span class="n">fulfilled_fractions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fulfilled_count</span> <span class="o">/</span> <span class="n">total_count</span><span class="p">)</span>
        <span class="c1"># print(f&#39;Fraction of fulfilled requirements: {fulfilled_count / total_count}&#39;)</span>
    <span class="n">max_frac</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">fulfilled_fractions</span><span class="p">)</span>
    <span class="n">best_chosen</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">max_frac</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">forest</span><span class="p">[</span><span class="n">fulfilled_fractions</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">forest</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fulfilled_fractions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">max_frac</span><span class="p">:</span>
            <span class="n">best_chosen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">best_chosen</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># well, not perfect and probably not very robust. but it works :)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_samples_advanced</span><span class="p">(</span><span class="n">grammar</span><span class="p">:</span> <span class="n">Grammar</span><span class="p">,</span>
                     <span class="n">new_input_specifications</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">InputSpecification</span><span class="p">],</span>
                     <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>

    <span class="c1"># if there are no input specifications: generate some random samples</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_input_specifications</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">fuzzer</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">grammar</span><span class="p">)</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">samples</span>

    <span class="n">final_samples</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">each_spec_timeout</span> <span class="o">=</span> <span class="n">timeout</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_input_specifications</span><span class="p">)</span>

    <span class="n">rhs_nonterminals</span> <span class="o">=</span> <span class="n">grammar</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="c1"># list(chain(*[nonterminals(expansion) for expansion in grammar[rule]]))</span>

    <span class="n">fuzzer</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">grammar</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">new_input_specifications</span><span class="p">:</span>
        <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">best_chosen</span> <span class="o">=</span> <span class="p">[</span><span class="n">fuzzer</span><span class="o">.</span><span class="n">fuzz_tree</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span>
        <span class="n">done</span><span class="p">,</span> <span class="n">best_chosen</span> <span class="o">=</span> <span class="n">best_trees</span><span class="p">(</span><span class="n">best_chosen</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">grammar</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
            <span class="n">final_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree_to_string</span><span class="p">(</span><span class="n">best_chosen</span><span class="p">))</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span> <span class="ow">and</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">starttime</span> <span class="o">&lt;</span> <span class="n">each_spec_timeout</span><span class="p">:</span>
            <span class="c1"># split in prefix, postfix and try to reach targets</span>
            <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">best_chosen</span><span class="p">:</span>
                <span class="n">prefix_len</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">curr</span> <span class="o">=</span> <span class="n">tree</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">prefix_len</span><span class="p">):</span>
                    <span class="n">nt</span><span class="p">,</span> <span class="n">children</span> <span class="o">=</span> <span class="n">curr</span>
                    <span class="n">poss_desc_idxs</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">c_idx</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">children</span><span class="p">):</span>
                        <span class="n">s</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">c</span>
                        <span class="n">possible_descend</span> <span class="o">=</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">rhs_nonterminals</span>
                        <span class="k">if</span> <span class="n">possible_descend</span><span class="p">:</span>
                            <span class="n">poss_desc_idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_idx</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">poss_desc_idxs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="n">desc</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">poss_desc_idxs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">curr</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="n">poss_desc_idxs</span><span class="p">[</span><span class="n">desc</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">valid</span><span class="p">:</span>
                    <span class="n">nt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curr</span>
                    <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">requirements</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">feature</span><span class="p">,</span> <span class="n">NumericInterpretation</span><span class="p">)</span> <span class="ow">and</span> <span class="n">nt</span> <span class="o">==</span> <span class="n">req</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
                            <span class="c1"># hacky: generate a derivation tree for this numeric interpretation</span>
                            <span class="n">hacky_grammar</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">grammar</span><span class="p">)</span>
                            <span class="n">hacky_grammar</span><span class="p">[</span><span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">nt</span><span class="p">]</span>
                            <span class="n">parser</span> <span class="o">=</span> <span class="n">EarleyParser</span><span class="p">(</span><span class="n">hacky_grammar</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">test</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                                <span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">test</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">_</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">x</span>
                                <span class="c1"># print(str(s[0]))</span>
                                <span class="c1"># replace curr in tree with this new tree</span>
                                <span class="n">curr</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
                                <span class="k">pass</span>
            <span class="n">done</span><span class="p">,</span> <span class="n">best_chosen</span> <span class="o">=</span> <span class="n">best_trees</span><span class="p">(</span><span class="n">best_chosen</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">grammar</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                <span class="n">final_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree_to_string</span><span class="p">(</span><span class="n">best_chosen</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
            <span class="n">final_samples</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">tree_to_string</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">best_chosen</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">final_samples</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s another interesting generator function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">generate_samples_random</span><span class="p">(</span><span class="n">grammar</span><span class="p">:</span> <span class="n">Grammar</span><span class="p">,</span>
                     <span class="n">new_input_specifications</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">InputSpecification</span><span class="p">],</span>
                     <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">grammar</span><span class="p">,</span> <span class="n">max_nonterminals</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
        <span class="n">new_input</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_input</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
</div>
</div>
<p>This is what we use as default:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">generate_samples</span><span class="p">(</span><span class="n">grammar</span><span class="p">:</span> <span class="n">Grammar</span><span class="p">,</span>
                     <span class="n">new_input_specifications</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">InputSpecification</span><span class="p">],</span>
                     <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="c1"># Could also be generate_samples_random()</span>
    <span class="k">return</span> <span class="n">generate_samples_advanced</span><span class="p">(</span><span class="n">grammar</span><span class="p">,</span> <span class="n">new_input_specifications</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="excursion-some-tests">
<h3>Excursion: Some Tests<a class="headerlink" href="#excursion-some-tests" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exsqrt</span> <span class="o">=</span> <span class="n">ExistenceFeature</span><span class="p">(</span><span class="s1">&#39;exists(&lt;function&gt;@0)&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;function&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;sqrt&#39;</span><span class="p">)</span>
<span class="n">exdigit</span> <span class="o">=</span> <span class="n">ExistenceFeature</span><span class="p">(</span><span class="s1">&#39;exists(&lt;digit&gt;)&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;digit&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;digit&gt;&#39;</span><span class="p">)</span>

<span class="n">reqDigit</span> <span class="o">=</span> <span class="n">SpecRequirement</span><span class="p">(</span><span class="n">exdigit</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;0.5&#39;</span><span class="p">)</span>
<span class="n">fbdDigit</span> <span class="o">=</span> <span class="n">SpecRequirement</span><span class="p">(</span><span class="n">exdigit</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="s1">&#39;0.5&#39;</span><span class="p">)</span>

<span class="n">req0</span> <span class="o">=</span> <span class="n">SpecRequirement</span><span class="p">(</span><span class="n">exsqrt</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;-6.0&#39;</span><span class="p">)</span>
<span class="n">testspec0</span> <span class="o">=</span> <span class="n">InputSpecification</span><span class="p">([</span><span class="n">req0</span><span class="p">,</span> <span class="n">reqDigit</span><span class="p">])</span>
<span class="n">req1</span> <span class="o">=</span> <span class="n">SpecRequirement</span><span class="p">(</span><span class="n">exsqrt</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="s1">&#39;-6.0&#39;</span><span class="p">)</span>
<span class="n">testspec1</span> <span class="o">=</span> <span class="n">InputSpecification</span><span class="p">([</span><span class="n">req1</span><span class="p">,</span> <span class="n">fbdDigit</span><span class="p">])</span>

<span class="n">numterm</span> <span class="o">=</span> <span class="n">NumericInterpretation</span><span class="p">(</span><span class="s1">&#39;num(&lt;term&gt;)&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;term&gt;&#39;</span><span class="p">)</span>
<span class="n">req2</span> <span class="o">=</span> <span class="n">SpecRequirement</span><span class="p">(</span><span class="n">numterm</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;-31.0&#39;</span><span class="p">)</span>
<span class="n">testspec2</span> <span class="o">=</span> <span class="n">InputSpecification</span><span class="p">([</span><span class="n">req2</span><span class="p">,</span> <span class="n">req0</span><span class="p">,</span> <span class="n">reqDigit</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--generating samples--&#39;</span><span class="p">)</span>
<span class="c1"># samples = generate_samples(CALC_GRAMMAR, [testspec0, testspec1], 10)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">generate_samples</span><span class="p">(</span><span class="n">CALC_GRAMMAR</span><span class="p">,</span> <span class="p">[</span><span class="n">testspec2</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">samples</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--generating samples--
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;sqrt(-81743)&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="id5">
<h3>End of Excursion<a class="headerlink" href="#id5" title="Link to this heading">#</a></h3>
</section>
</section>
<section id="step-5-executing-new-inputs">
<h2>Step 5: Executing New Inputs<a class="headerlink" href="#step-5-executing-new-inputs" title="Link to this heading">#</a></h2>
<p>We are almost done! All that is left is putting the above pieces together and create a <em>loop</em> around them.</p>
<section id="the-alhazen-class">
<h3>The Alhazen Class<a class="headerlink" href="#the-alhazen-class" title="Link to this heading">#</a></h3>
<p>We implement a class <code class="docutils literal notranslate"><span class="pre">Alhazen</span></code> that serves as main entry point for our approach.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Alhazen</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">runner</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
                 <span class="n">grammar</span><span class="p">:</span> <span class="n">Grammar</span><span class="p">,</span>
                 <span class="n">initial_inputs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">/</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">max_iterations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                 <span class="n">generator_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initial_inputs</span> <span class="o">=</span> <span class="n">initial_inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_runner</span> <span class="o">=</span> <span class="n">runner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_grammar</span> <span class="o">=</span> <span class="n">grammar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_iter</span> <span class="o">=</span> <span class="n">max_iterations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_previous_samples</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trees</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generator_timeout</span> <span class="o">=</span> <span class="n">generator_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Alhazen</span><span class="p">(</span><span class="n">Alhazen</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_previous_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initial_inputs</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_all_features</span> <span class="o">=</span> <span class="n">extract_all_features</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_grammar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_feature_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_features</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Features:&quot;</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">friendly_name</span><span class="p">()</span>
                                         <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_features</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Alhazen</span><span class="p">(</span><span class="n">Alhazen</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_new_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exec_data</span><span class="p">,</span> <span class="n">feature_data</span><span class="p">):</span>
        <span class="n">joined_data</span> <span class="o">=</span> <span class="n">exec_data</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">feature_data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;sample&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Only add valid data</span>
        <span class="n">new_data</span> <span class="o">=</span> <span class="n">joined_data</span><span class="p">[(</span><span class="n">joined_data</span><span class="p">[</span><span class="s1">&#39;oracle&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">OracleResult</span><span class="o">.</span><span class="n">UNDEF</span><span class="p">)]</span>
        <span class="n">new_data</span> <span class="o">=</span> <span class="n">joined_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">joined_data</span><span class="p">[</span><span class="n">joined_data</span><span class="o">.</span><span class="n">oracle</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;UNDEF&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_data</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">new_data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="n">new_data</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Alhazen</span><span class="p">(</span><span class="n">Alhazen</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sample_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sample_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initial_inputs</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">sample_list</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runner</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;oracle&quot;</span><span class="p">:</span> <span class="n">result</span> <span class="p">})</span>

        <span class="k">return</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Alhazen</span><span class="p">(</span><span class="n">Alhazen</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_iter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Iteration #</span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_iterate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_previous_samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Alhazen</span><span class="p">(</span><span class="n">Alhazen</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">all_trees</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="n">prune</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">trees</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trees</span>
        <span class="k">if</span> <span class="n">prune</span><span class="p">:</span>
            <span class="n">trees</span> <span class="o">=</span> <span class="p">[</span><span class="n">remove_unequal_decisions</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trees</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">trees</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">last_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="n">prune</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_trees</span><span class="p">(</span><span class="n">prune</span><span class="o">=</span><span class="n">prune</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Alhazen</span><span class="p">(</span><span class="n">Alhazen</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_iterate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_list</span><span class="p">):</span>
        <span class="c1"># Run samples, obtain test outcomes</span>
        <span class="n">exec_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_samples</span><span class="p">(</span><span class="n">sample_list</span><span class="p">)</span>

        <span class="c1"># Step 1: Extract features from the new samples</span>
        <span class="n">feature_data</span> <span class="o">=</span> <span class="n">collect_features</span><span class="p">(</span><span class="n">sample_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grammar</span><span class="p">)</span>

        <span class="c1"># Combine the new data with the already existing data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_new_data</span><span class="p">(</span><span class="n">exec_data</span><span class="p">,</span> <span class="n">feature_data</span><span class="p">)</span>
        <span class="c1"># display(self._data)</span>

        <span class="c1"># Step 2: Train the Decision Tree Classifier</span>
        <span class="n">dec_tree</span> <span class="o">=</span> <span class="n">train_tree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dec_tree</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Decision Tree:&quot;</span><span class="p">)</span>
            <span class="n">all_features</span> <span class="o">=</span> <span class="n">extract_all_features</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_grammar</span><span class="p">)</span>
            <span class="n">all_feature_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">friendly_name</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_features</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">friendly_decision_tree</span><span class="p">(</span><span class="n">dec_tree</span><span class="p">,</span> <span class="n">all_feature_names</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>

        <span class="c1"># Step 3: Extract new requirements from the tree</span>
        <span class="n">new_input_specifications</span> <span class="o">=</span> <span class="n">get_all_input_specifications</span><span class="p">(</span><span class="n">dec_tree</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">_all_features</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">_feature_names</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;oracle&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  New input specifications:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">new_input_specifications</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">friendly</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Step 4: Generate new inputs according to the new input specifications</span>
        <span class="n">new_samples</span> <span class="o">=</span> <span class="n">generate_samples</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_grammar</span><span class="p">,</span>
                                       <span class="n">new_input_specifications</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_generator_timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  New samples:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_samples</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_previous_samples</span> <span class="o">=</span> <span class="n">new_samples</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Alhazen</span><span class="p">(</span><span class="n">Alhazen</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">all_feature_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">friendly</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">friendly</span><span class="p">:</span>
            <span class="n">all_feature_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">friendly_name</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_features</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_feature_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_features</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">all_feature_names</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Alhazen</span><span class="p">(</span><span class="n">Alhazen</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">show_decision_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">friendly</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">show_decision_tree</span><span class="p">(</span><span class="n">tree</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_tree</span><span class="p">(),</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">all_feature_names</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Alhazen</span><span class="p">(</span><span class="n">Alhazen</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">friendly_decision_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">friendly_decision_tree</span><span class="p">(</span><span class="n">tree</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_tree</span><span class="p">(),</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">all_feature_names</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="a-sample-run">
<h2>A Sample Run<a class="headerlink" href="#a-sample-run" title="Link to this heading">#</a></h2>
<p>We can finally run <em>Alhazen</em>!</p>
<p>Set the number of refinement iterations and the timeout for the input generator.
The execution time of Alhazen mainly depends on the number of iterations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">MAX_ITERATIONS</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">GENERATOR_TIMEOUT</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># timeout in seconds</span>
</pre></div>
</div>
</div>
</div>
<p>We initialize Alhazen with the previously used <code class="docutils literal notranslate"><span class="pre">initial_sample_list</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">initial_sample_list</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;sqrt(-16)&#39;, &#39;sqrt(4)&#39;]
</pre></div>
</div>
</div>
</div>
<p>And here we go! When initialized with <code class="docutils literal notranslate"><span class="pre">verbose=True</span></code>, Alhazen prints its progress during execution, issuing for each iteration</p>
<ul class="simple">
<li><p>the last decision tree</p></li>
<li><p>the new input specification resulting from the tree</p></li>
<li><p>the new samples satisfying the input specification.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">alhazen</span> <span class="o">=</span> <span class="n">Alhazen</span><span class="p">(</span><span class="n">sample_runner</span><span class="p">,</span> <span class="n">CALC_GRAMMAR</span><span class="p">,</span> <span class="n">initial_sample_list</span><span class="p">,</span>
                  <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">max_iterations</span><span class="o">=</span><span class="n">MAX_ITERATIONS</span><span class="p">,</span>
                  <span class="n">generator_timeout</span><span class="o">=</span><span class="n">GENERATOR_TIMEOUT</span><span class="p">)</span>
<span class="n">alhazen</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Features: exists(&lt;start&gt;), &lt;start&gt; == &#39;&lt;function&gt;(&lt;term&gt;)&#39;, exists(&lt;function&gt;), &lt;function&gt; == &#39;sqrt&#39;, &lt;function&gt; == &#39;tan&#39;, &lt;function&gt; == &#39;cos&#39;, &lt;function&gt; == &#39;sin&#39;, exists(&lt;term&gt;), &lt;term&gt; == &#39;-&lt;value&gt;&#39;, &lt;term&gt; == &#39;&lt;value&gt;&#39;, exists(&lt;value&gt;), &lt;value&gt; == &#39;&lt;integer&gt;.&lt;digits&gt;&#39;, &lt;value&gt; == &#39;&lt;integer&gt;&#39;, exists(&lt;integer&gt;), &lt;integer&gt; == &#39;&lt;lead-digit&gt;&lt;digits&gt;&#39;, &lt;integer&gt; == &#39;&lt;digit&gt;&#39;, exists(&lt;digits&gt;), &lt;digits&gt; == &#39;&lt;digit&gt;&lt;digits&gt;&#39;, &lt;digits&gt; == &#39;&lt;digit&gt;&#39;, exists(&lt;lead-digit&gt;), &lt;lead-digit&gt; == &#39;1&#39;, &lt;lead-digit&gt; == &#39;2&#39;, &lt;lead-digit&gt; == &#39;3&#39;, &lt;lead-digit&gt; == &#39;4&#39;, &lt;lead-digit&gt; == &#39;5&#39;, &lt;lead-digit&gt; == &#39;6&#39;, &lt;lead-digit&gt; == &#39;7&#39;, &lt;lead-digit&gt; == &#39;8&#39;, &lt;lead-digit&gt; == &#39;9&#39;, exists(&lt;digit&gt;), &lt;digit&gt; == &#39;0&#39;, &lt;digit&gt; == &#39;1&#39;, &lt;digit&gt; == &#39;2&#39;, &lt;digit&gt; == &#39;3&#39;, &lt;digit&gt; == &#39;4&#39;, &lt;digit&gt; == &#39;5&#39;, &lt;digit&gt; == &#39;6&#39;, &lt;digit&gt; == &#39;7&#39;, &lt;digit&gt; == &#39;8&#39;, &lt;digit&gt; == &#39;9&#39;, &lt;term&gt;, &lt;value&gt;, &lt;lead-digit&gt;, &lt;digit&gt;, &lt;integer&gt;, &lt;digits&gt;

Iteration #1
  Decision Tree:
    if &lt;digits&gt; == &#39;&lt;digit&gt;&#39;:
      BUG
    else:
      NO_BUG

  New input specifications:
    &lt;digits&gt; == &#39;&lt;digit&gt;&#39;
    &lt;digits&gt; == &#39;&lt;digit&gt;&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  New samples:
    sqrt(-5), sqrt(8.90)

Iteration #2
  Decision Tree:
    if &lt;integer&gt; == &#39;&lt;digit&gt;&#39;:
      NO_BUG
    else:
      BUG

  New input specifications:
    &lt;integer&gt; == &#39;&lt;digit&gt;&#39;
    &lt;integer&gt; == &#39;&lt;digit&gt;&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  New samples:
    sqrt(-8), tan(-856427.34926)

Iteration #3
  Decision Tree:
    if &lt;digits&gt; &lt;= 48.0000:
      BUG
    else:
      NO_BUG

  New input specifications:
    &lt;digits&gt; &lt;= 48.0
    &lt;digits&gt; &gt; 48.0
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  New samples:
    tan(0.38), cos(-3424.3)

Iteration #4
  Decision Tree:
    if &lt;digits&gt; &lt;= 22.0000:
      BUG
    else:
      NO_BUG

  New input specifications:
    &lt;digits&gt; &gt; 22.0
    &lt;digits&gt; &lt;= 22.0
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  New samples:
    sqrt(-7.274), sin(9.0)

Iteration #5
  Decision Tree:
    if &lt;lead-digit&gt; == &#39;1&#39;:
      BUG
    else:
      if exists(&lt;lead-digit&gt;):
        NO_BUG
      else:
        NO_BUG

  New input specifications:
    exists(&lt;lead-digit&gt;) and &lt;lead-digit&gt; == &#39;1&#39;
    exists(&lt;lead-digit&gt;) and &lt;lead-digit&gt; == &#39;1&#39;
    &lt;lead-digit&gt; == &#39;1&#39;
    &lt;lead-digit&gt; == &#39;1&#39;
    exists(&lt;lead-digit&gt;) and &lt;lead-digit&gt; == &#39;1&#39;
    exists(&lt;lead-digit&gt;) and &lt;lead-digit&gt; == &#39;1&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  New samples:
    tan(4.9), sin(15.1), tan(-66.4333), cos(-15111.0), sqrt(-422.2), tan(1), sin(-3), cos(-5), tan(-6.9), tan(-4), cos(0), cos(3), tan(9), cos(-1.5), sin(-3), sqrt(163156.5), tan(0), sqrt(-9.8), tan(5.7), sin(9.1), cos(-0.7), sqrt(-5.039), sqrt(-2.40), tan(114), cos(0.448), tan(4), sqrt(8), cos(0.1), sin(1), cos(0.3782941), tan(-3.5), sqrt(5), tan(-5.8751), cos(8), sin(-3), sqrt(7.7), tan(-3.8), sqrt(4), sqrt(-9), sin(-4), cos(-9), cos(-9), cos(-8), cos(2.65276), tan(0), cos(-6), sin(9), sin(15.93), tan(-5), cos(-1.5), cos(0), tan(8.1), tan(-7.59102), cos(-0), tan(-3), tan(-6.0), sin(4)

Iteration #6
  Decision Tree:
    if &lt;lead-digit&gt; &lt;= 2.0000:
      if &lt;value&gt; == &#39;&lt;integer&gt;.&lt;digits&gt;&#39;:
        NO_BUG
      else:
        BUG
    else:
      NO_BUG

  New input specifications:
    &lt;lead-digit&gt; &lt;= 2.0
    &lt;value&gt; == &#39;&lt;integer&gt;.&lt;digits&gt;&#39; and &lt;lead-digit&gt; &gt; 2.0
    &lt;value&gt; == &#39;&lt;integer&gt;.&lt;digits&gt;&#39; and &lt;lead-digit&gt; &lt;= 2.0
    &lt;value&gt; == &#39;&lt;integer&gt;.&lt;digits&gt;&#39; and &lt;lead-digit&gt; &gt; 2.0
    &lt;value&gt; == &#39;&lt;integer&gt;.&lt;digits&gt;&#39; and &lt;lead-digit&gt; &lt;= 2.0
    &lt;lead-digit&gt; &gt; 2.0
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  New samples:
    tan(244), sqrt(-32970), sqrt(208), sin(31.44), sqrt(296.2), sqrt(-567)

Iteration #7
  Decision Tree:
    if &lt;lead-digit&gt; == &#39;1&#39;:
      if &lt;digit&gt; == &#39;6&#39;:
        if &lt;digit&gt; == &#39;3&#39;:
          NO_BUG
        else:
          BUG
      else:
        NO_BUG
    else:
      NO_BUG

  New input specifications:
    &lt;digit&gt; == &#39;3&#39; and &lt;digit&gt; == &#39;6&#39; and &lt;lead-digit&gt; == &#39;1&#39;
    &lt;lead-digit&gt; == &#39;1&#39;
    &lt;digit&gt; == &#39;6&#39; and &lt;lead-digit&gt; == &#39;1&#39;
    &lt;digit&gt; == &#39;3&#39; and &lt;digit&gt; == &#39;6&#39; and &lt;lead-digit&gt; == &#39;1&#39;
    &lt;digit&gt; == &#39;3&#39; and &lt;digit&gt; == &#39;6&#39; and &lt;lead-digit&gt; == &#39;1&#39;
    &lt;lead-digit&gt; == &#39;1&#39;
    &lt;digit&gt; == &#39;6&#39; and &lt;lead-digit&gt; == &#39;1&#39;
    &lt;digit&gt; == &#39;3&#39; and &lt;digit&gt; == &#39;6&#39; and &lt;lead-digit&gt; == &#39;1&#39;
    &lt;digit&gt; == &#39;6&#39; and &lt;lead-digit&gt; == &#39;1&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  New samples:
    cos(17), sqrt(9652445237), sqrt(16.308), sqrt(1037.4), cos(-11), cos(76), tan(-4006.8), tan(-986), cos(-4.86), tan(84.6), cos(-2998.861), cos(-142.8), cos(-2.61), sqrt(-916.0), sqrt(52.64), sqrt(-6), cos(6.9), tan(97.614), tan(-12), cos(-762), tan(-0.8006), sqrt(-467), sin(5.64), sin(6.9), cos(62.2), tan(7.115), sin(6.2), tan(-4), tan(9.0), tan(-8), sin(-28.95), sin(-57.3), tan(-774), cos(3.94), sin(-1.289), sin(-2420.476499), sqrt(-2), sin(96), sqrt(49), sqrt(61922), sqrt(4152), tan(-211.0), sin(4), sin(1), tan(6), sin(582626), tan(-6), sin(1), sin(-287), cos(-72.5), cos(9.994), cos(-53), sqrt(-1.922956), sqrt(-8), sqrt(-41.6), sqrt(6), sqrt(3585), cos(4284), sqrt(-1.2), cos(2), sin(-0), sqrt(2), sin(6680), cos(74), sqrt(-5786), tan(3.448), sqrt(-5.76), sqrt(1.6), cos(-75.772), tan(9.7), sqrt(-209.40), cos(-493), tan(-9), tan(-788.47), cos(7), cos(8), sqrt(0), sqrt(8275), sin(3.0), sqrt(-1), sin(-943468113), sin(-37), sqrt(-7), sqrt(91), sin(54), sqrt(-84), sqrt(-4), sin(-9.17), cos(224.07), cos(-6.617), cos(30.0), tan(-907.159), sin(-7), tan(-2), sqrt(-7.5), sin(5.0769091), cos(-8), sin(6), sqrt(47.2843), sqrt(85.51), cos(-2), cos(3.5), tan(1), sin(-3), tan(8.25), cos(5710.203), sin(38), tan(72.638), tan(7126.02582), tan(2.0), tan(-46), sin(9), cos(78.5), sin(9), cos(-9), cos(3), sqrt(63.568), sqrt(6), cos(-7), tan(4.54), cos(-7.081602), sqrt(4.9219), cos(-80010.04), tan(37), tan(-448), sqrt(-936.3), cos(-881.536), tan(-1538.5), tan(-14.66), tan(-193.5), sin(-133), tan(1904)

Iteration #8
  Decision Tree:
    if &lt;digits&gt; &lt;= 6.5000:
      if &lt;term&gt; &lt;= -14.0000:
        if &lt;integer&gt; &lt;= 43.5000:
          BUG
        else:
          NO_BUG
      else:
        if &lt;digit&gt; == &#39;1&#39;:
          NO_BUG
        else:
          NO_BUG
    else:
      if &lt;lead-digit&gt; == &#39;6&#39;:
        NO_BUG
      else:
        NO_BUG
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  New input specifications:
    &lt;lead-digit&gt; == &#39;6&#39; and &lt;digits&gt; &lt;= 6.5
    &lt;lead-digit&gt; == &#39;6&#39; and &lt;digits&gt; &lt;= 6.5
    &lt;digits&gt; &gt; 6.5 and &lt;integer&gt; &lt;= 43.5 and &lt;term&gt; &lt;= -14.0
    &lt;digit&gt; == &#39;1&#39; and &lt;digits&gt; &gt; 6.5 and &lt;term&gt; &lt;= -14.0
    &lt;digit&gt; == &#39;1&#39; and &lt;digits&gt; &gt; 6.5 and &lt;term&gt; &gt; -14.0
    &lt;lead-digit&gt; == &#39;6&#39; and &lt;digits&gt; &gt; 6.5
    &lt;digit&gt; == &#39;1&#39; and &lt;digits&gt; &lt;= 6.5 and &lt;term&gt; &gt; -14.0
    &lt;digits&gt; &gt; 6.5 and &lt;integer&gt; &gt; 43.5 and &lt;term&gt; &lt;= -14.0
    &lt;digit&gt; == &#39;1&#39; and &lt;digits&gt; &lt;= 6.5 and &lt;term&gt; &lt;= -14.0
    &lt;digits&gt; &lt;= 6.5 and &lt;integer&gt; &gt; 43.5 and &lt;term&gt; &lt;= -14.0
    &lt;digits&gt; &lt;= 6.5 and &lt;integer&gt; &lt;= 43.5 and &lt;term&gt; &lt;= -14.0
    &lt;digit&gt; == &#39;1&#39; and &lt;digits&gt; &lt;= 6.5 and &lt;term&gt; &gt; -14.0
    &lt;digit&gt; == &#39;1&#39; and &lt;digits&gt; &gt; 6.5 and &lt;term&gt; &gt; -14.0
    &lt;lead-digit&gt; == &#39;6&#39; and &lt;digits&gt; &gt; 6.5
    &lt;digit&gt; == &#39;1&#39; and &lt;digits&gt; &gt; 6.5 and &lt;term&gt; &lt;= -14.0
    &lt;digit&gt; == &#39;1&#39; and &lt;digits&gt; &lt;= 6.5 and &lt;term&gt; &lt;= -14.0
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  New samples:
    sqrt(62.4), sqrt(11), sin(-17), sin(-19.70), sqrt(46.1713), sqrt(-614609.5), cos(75.1), sin(-99), cos(-46.0), tan(-53), cos(-24.0), cos(3.5), sin(18.244), sqrt(-1098), sin(-69.31), sin(-151.74), cos(-66.13), sqrt(-61056.0), cos(-319.8), sin(-31115.15), sin(-904), tan(-1153.8289), cos(-7201), tan(-74)

Iteration #9
  Decision Tree:
    if &lt;digits&gt; &lt;= 6.5000:
      if &lt;digits&gt; &lt;= 5.5000:
        NO_BUG
      else:
        if &lt;function&gt; == &#39;sqrt&#39;:
          if &lt;value&gt; &lt;= 8.8000:
            NO_BUG
          else:
            BUG
        else:
          if &lt;function&gt; == &#39;tan&#39;:
            NO_BUG
          else:
            NO_BUG
    else:
      if exists(&lt;lead-digit&gt;):
        NO_BUG
      else:
        NO_BUG

  New input specifications:
    exists(&lt;lead-digit&gt;) and &lt;digits&gt; &gt; 6.5
    exists(&lt;lead-digit&gt;) and &lt;digits&gt; &lt;= 6.5
    &lt;digits&gt; &gt; 5.5
    &lt;digits&gt; &lt;= 5.5
    exists(&lt;lead-digit&gt;) and &lt;digits&gt; &gt; 6.5
    exists(&lt;lead-digit&gt;) and &lt;digits&gt; &lt;= 6.5
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  New samples:
    sin(46.438), sin(-36), cos(7.59), tan(9.3), sin(5.807), sqrt(0.3)

Iteration #10
  Decision Tree:
    if &lt;digits&gt; &lt;= 6.5000:
      if &lt;digits&gt; &lt;= 5.5000:
        if &lt;value&gt; == &#39;&lt;integer&gt;&#39;:
          NO_BUG
        else:
          NO_BUG
      else:
        if &lt;function&gt; == &#39;sqrt&#39;:
          if &lt;lead-digit&gt; &lt;= inf:
            BUG
          else:
            NO_BUG
        else:
          if &lt;value&gt; == &#39;&lt;integer&gt;.&lt;digits&gt;&#39;:
            NO_BUG
          else:
            NO_BUG
    else:
      if &lt;lead-digit&gt; == &#39;9&#39;:
        NO_BUG
      else:
        NO_BUG

  New input specifications:
    &lt;lead-digit&gt; == &#39;9&#39; and &lt;digits&gt; &gt; 6.5
    &lt;lead-digit&gt; == &#39;9&#39; and &lt;digits&gt; &lt;= 6.5
    &lt;value&gt; == &#39;&lt;integer&gt;&#39; and &lt;digits&gt; &gt; 5.5
    &lt;lead-digit&gt; == &#39;9&#39; and &lt;digits&gt; &gt; 6.5
    &lt;lead-digit&gt; == &#39;9&#39; and &lt;digits&gt; &lt;= 6.5
    &lt;value&gt; == &#39;&lt;integer&gt;&#39; and &lt;digits&gt; &gt; 5.5
    &lt;value&gt; == &#39;&lt;integer&gt;&#39; and &lt;digits&gt; &lt;= 5.5
    &lt;value&gt; == &#39;&lt;integer&gt;&#39; and &lt;digits&gt; &lt;= 5.5
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  New samples:
    sqrt(-9.82), tan(-82), sqrt(8259910893), sin(-91.317), cos(90), tan(-39.77), tan(8.5), tan(85)

Iteration #11
  Decision Tree:
    if &lt;digits&gt; &lt;= 6.5000:
      if &lt;digits&gt; &lt;= 5.5000:
        NO_BUG
      else:
        if &lt;function&gt; == &#39;sqrt&#39;:
          if &lt;integer&gt; == &#39;&lt;digit&gt;&#39;:
            NO_BUG
          else:
            BUG
        else:
          NO_BUG
    else:
      NO_BUG

  New input specifications:
    &lt;digits&gt; &lt;= 6.5
    &lt;digits&gt; &gt; 5.5
    &lt;digits&gt; &lt;= 5.5
    &lt;digits&gt; &gt; 6.5
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  New samples:
    sin(6.6), sin(-5.6), sin(-23), sin(-48.61172)

Iteration #12
  Decision Tree:
    if &lt;digits&gt; &lt;= 6.5000:
      if &lt;function&gt; == &#39;sqrt&#39;:
        if &lt;digit&gt; == &#39;6&#39;:
          if &lt;integer&gt; &lt;= 8.5000:
            NO_BUG
          else:
            BUG
        else:
          NO_BUG
      else:
        if &lt;lead-digit&gt; == &#39;9&#39;:
          NO_BUG
        else:
          NO_BUG
    else:
      if &lt;digit&gt;:
        NO_BUG
      else:
        NO_BUG
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  New input specifications:
    &lt;digit&gt; == &#39;6&#39; and &lt;function&gt; == &#39;sqrt&#39; and &lt;digits&gt; &lt;= 6.5
    &lt;digit&gt; == &#39;6&#39; and &lt;function&gt; == &#39;sqrt&#39; and &lt;digits&gt; &gt; 6.5
    &lt;digit&gt; == &#39;6&#39; and &lt;function&gt; == &#39;sqrt&#39; and &lt;digits&gt; &lt;= 6.5 and &lt;integer&gt; &lt;= 8.5
    &lt;digit&gt; == &#39;6&#39; and &lt;function&gt; == &#39;sqrt&#39; and &lt;digits&gt; &lt;= 6.5
    &lt;digit&gt; == &#39;6&#39; and &lt;function&gt; == &#39;sqrt&#39; and &lt;digits&gt; &lt;= 6.5 and &lt;integer&gt; &gt; 8.5
    &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; == &#39;9&#39; and &lt;digits&gt; &lt;= 6.5
    &lt;digit&gt; == &#39;6&#39; and &lt;function&gt; == &#39;sqrt&#39; and &lt;digits&gt; &lt;= 6.5 and &lt;integer&gt; &lt;= 8.5
    &lt;digit&gt; == &#39;6&#39; and &lt;function&gt; == &#39;sqrt&#39; and &lt;digits&gt; &gt; 6.5 and &lt;integer&gt; &gt; 8.5
    &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; == &#39;9&#39; and &lt;digits&gt; &lt;= 6.5
    &lt;digit&gt; == &#39;6&#39; and &lt;function&gt; == &#39;sqrt&#39; and &lt;digits&gt; &lt;= 6.5 and &lt;integer&gt; &gt; 8.5
    &lt;digit&gt; &gt; 0.5 and &lt;digits&gt; &lt;= 6.5
    &lt;digit&gt; == &#39;6&#39; and &lt;function&gt; == &#39;sqrt&#39; and &lt;digits&gt; &gt; 6.5
    &lt;digit&gt; &lt;= 0.5 and &lt;digits&gt; &gt; 6.5
    &lt;digit&gt; &gt; 0.5 and &lt;digits&gt; &gt; 6.5
    &lt;digit&gt; == &#39;6&#39; and &lt;function&gt; == &#39;sqrt&#39; and &lt;digits&gt; &gt; 6.5 and &lt;integer&gt; &lt;= 8.5
    &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; == &#39;9&#39; and &lt;digits&gt; &gt; 6.5
    &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; == &#39;9&#39; and &lt;digits&gt; &gt; 6.5
    &lt;digit&gt; &lt;= 0.5 and &lt;digits&gt; &lt;= 6.5
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  New samples:
    sqrt(4.4), sqrt(-2.7), sqrt(6.2), sqrt(86), sqrt(64.5), sqrt(53), sqrt(22), sqrt(-3576), tan(26), sqrt(11), sqrt(50), tan(66), sin(-53), sqrt(-3.0), sqrt(3098648.4), cos(94), sqrt(-9.1), sqrt(86), sqrt(6.8), sin(-2.1601), sqrt(-85.9), cos(-0), cos(-229.14), sqrt(583), tan(5.459), cos(-920.1075), sin(-9.9), sin(-58.75), tan(97039207), sin(-0.800), cos(-509.3), cos(89), cos(-0), cos(981506.59177), sqrt(20107806.9), sin(72484.8647), sqrt(-837739), cos(-88.0650), tan(-69), sin(98), sin(-0), sqrt(-8.07), sin(5.55), sin(-871.2206), tan(85045.3015), sqrt(-0.8711), sin(-9791), sqrt(-4.47), sin(465), cos(7.886), sqrt(8.52), tan(-88.74507), cos(-568.1), tan(-26.53), cos(63.695), cos(615), sin(-86.25), tan(652.850), tan(13.57), cos(23.23), cos(-4172.2), sin(-59), sqrt(-0), sin(40.456), tan(4691880.944), sqrt(-80), sin(-3784.2), sin(-2.98), sqrt(6216.2), cos(-30), sqrt(-736.34), cos(-37.1), tan(-93.3335), cos(57.6), tan(6.9), cos(-1.61), sqrt(-6), sqrt(2.77), sqrt(-7.298), sin(6.4804), sqrt(2.7), cos(-5.8), tan(97.9), sin(0.0)

Iteration #13
  Decision Tree:
    if &lt;digits&gt; &lt;= 6.5000:
      if &lt;digits&gt; &lt;= 5.5000:
        if exists(&lt;lead-digit&gt;):
          NO_BUG
        else:
          NO_BUG
      else:
        if &lt;term&gt; &lt;= -10.8000:
          if &lt;function&gt; == &#39;sqrt&#39;:
            BUG
          else:
            NO_BUG
        else:
          if &lt;digit&gt; == &#39;5&#39;:
            NO_BUG
          else:
            NO_BUG
    else:
      if &lt;digit&gt; == &#39;9&#39;:
        NO_BUG
      else:
        NO_BUG
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  New input specifications:
    exists(&lt;lead-digit&gt;) and &lt;digits&gt; &lt;= 5.5
    &lt;digit&gt; == &#39;9&#39; and &lt;digits&gt; &lt;= 6.5
    exists(&lt;lead-digit&gt;) and &lt;digits&gt; &gt; 5.5
    &lt;digit&gt; == &#39;9&#39; and &lt;digits&gt; &gt; 6.5
    exists(&lt;lead-digit&gt;) and &lt;digits&gt; &lt;= 5.5
    exists(&lt;lead-digit&gt;) and &lt;digits&gt; &gt; 5.5
    &lt;digit&gt; == &#39;9&#39; and &lt;digits&gt; &lt;= 6.5
    &lt;digit&gt; == &#39;9&#39; and &lt;digits&gt; &gt; 6.5
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  New samples:
    cos(2.1), sqrt(9.2), tan(-113), sqrt(194), tan(70), cos(2.191135), sin(-74.2), tan(-445)

Iteration #14
  Decision Tree:
    if &lt;digits&gt; &lt;= 6.5000:
      if &lt;digits&gt; &lt;= 5.5000:
        NO_BUG
      else:
        if &lt;function&gt; == &#39;sqrt&#39;:
          if &lt;term&gt; == &#39;&lt;value&gt;&#39;:
            NO_BUG
          else:
            BUG
        else:
          NO_BUG
    else:
      NO_BUG

  New input specifications:
    &lt;digits&gt; &lt;= 6.5
    &lt;digits&gt; &gt; 5.5
    &lt;digits&gt; &lt;= 5.5
    &lt;digits&gt; &gt; 6.5
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  New samples:
    sqrt(-64), sin(214), sqrt(41), sin(2.8)

Iteration #15
  Decision Tree:
    if &lt;digits&gt; &lt;= 6.5000:
      if &lt;digits&gt; &lt;= 5.5000:
        NO_BUG
      else:
        if &lt;function&gt; == &#39;sqrt&#39;:
          if &lt;term&gt; &lt;= -7.2000:
            BUG
          else:
            NO_BUG
        else:
          NO_BUG
    else:
      NO_BUG

  New input specifications:
    &lt;digits&gt; &lt;= 6.5
    &lt;digits&gt; &gt; 5.5
    &lt;digits&gt; &lt;= 5.5
    &lt;digits&gt; &gt; 6.5
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  New samples:
    sqrt(30), cos(-0.71), tan(-81.4), sqrt(-67.1)

Iteration #16
  Decision Tree:
    if &lt;digits&gt; &lt;= 6.5000:
      if &lt;digits&gt; &lt;= 5.5000:
        if &lt;digit&gt; == &#39;4&#39;:
          NO_BUG
        else:
          NO_BUG
      else:
        if &lt;term&gt; &lt;= -10.8000:
          if &lt;function&gt; == &#39;sqrt&#39;:
            BUG
          else:
            NO_BUG
        else:
          if &lt;integer&gt; &lt;= 3.0000:
            NO_BUG
          else:
            NO_BUG
    else:
      if &lt;digit&gt; == &#39;9&#39;:
        NO_BUG
      else:
        NO_BUG

  New input specifications:
    &lt;digit&gt; == &#39;4&#39; and &lt;digits&gt; &lt;= 5.5
    &lt;digit&gt; == &#39;9&#39; and &lt;digits&gt; &lt;= 6.5
    &lt;digit&gt; == &#39;4&#39; and &lt;digits&gt; &lt;= 5.5
    &lt;digit&gt; == &#39;9&#39; and &lt;digits&gt; &gt; 6.5
    &lt;digit&gt; == &#39;4&#39; and &lt;digits&gt; &gt; 5.5
    &lt;digit&gt; == &#39;9&#39; and &lt;digits&gt; &gt; 6.5
    &lt;digit&gt; == &#39;4&#39; and &lt;digits&gt; &gt; 5.5
    &lt;digit&gt; == &#39;9&#39; and &lt;digits&gt; &lt;= 6.5
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  New samples:
    sqrt(-7.3), sin(-3.4), tan(-94), sin(35), sqrt(-99.4), sqrt(42.4), tan(91.1), tan(-39.1), sqrt(-69), cos(89253237), sin(-10), sin(-4.1), tan(-4299), sin(-0.3), cos(-4.1), tan(3.3), sin(86912), cos(0.6), cos(-84.59), sqrt(839), cos(7931.22), sqrt(653.7943), tan(-3.5), tan(-42), sin(43), tan(2940.0), cos(73.946976), tan(73.96), sin(-21.6), sqrt(49.4), cos(-9), cos(-74), sqrt(-85), tan(-30), sin(3.04), cos(8.392), cos(48), cos(3721676.4), sin(-81.6249), cos(-21.1)

Iteration #17
  Decision Tree:
    if &lt;digits&gt; &lt;= 6.5000:
      if &lt;digits&gt; &lt;= 5.5000:
        NO_BUG
      else:
        if &lt;function&gt; == &#39;sqrt&#39;:
          if &lt;term&gt; &lt;= -7.2000:
            BUG
          else:
            NO_BUG
        else:
          NO_BUG
    else:
      NO_BUG

  New input specifications:
    &lt;digits&gt; &lt;= 6.5
    &lt;digits&gt; &gt; 5.5
    &lt;digits&gt; &lt;= 5.5
    &lt;digits&gt; &gt; 6.5
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  New samples:
    sin(-92.6), tan(9.5787), sqrt(11), sqrt(85.8)

Iteration #18
  Decision Tree:
    if &lt;lead-digit&gt; &lt;= 4.5000:
      if &lt;digit&gt; == &#39;6&#39;:
        if &lt;digits&gt; == &#39;&lt;digit&gt;&lt;digits&gt;&#39;:
          if &lt;lead-digit&gt; == &#39;4&#39;:
            NO_BUG
          else:
            NO_BUG
        else:
          if &lt;function&gt; == &#39;sqrt&#39;:
            BUG
          else:
            if &lt;integer&gt; &lt;= 23.5000:
              NO_BUG
            else:
              NO_BUG
      else:
        if &lt;digit&gt; == &#39;9&#39;:
          NO_BUG
        else:
          NO_BUG
    else:
      NO_BUG
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  New input specifications:
    &lt;digit&gt; == &#39;6&#39; and &lt;digits&gt; == &#39;&lt;digit&gt;&lt;digits&gt;&#39; and &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &lt;= 4.5
    &lt;digit&gt; == &#39;6&#39; and &lt;digits&gt; == &#39;&lt;digit&gt;&lt;digits&gt;&#39; and &lt;lead-digit&gt; == &#39;4&#39; and &lt;lead-digit&gt; &gt; 4.5
    &lt;digit&gt; == &#39;6&#39; and &lt;digits&gt; == &#39;&lt;digit&gt;&lt;digits&gt;&#39; and &lt;function&gt; == &#39;sqrt&#39; and &lt;integer&gt; &gt; 23.5 and &lt;lead-digit&gt; &lt;= 4.5
    &lt;digit&gt; == &#39;6&#39; and &lt;digits&gt; == &#39;&lt;digit&gt;&lt;digits&gt;&#39; and &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &lt;= 4.5
    &lt;digit&gt; == &#39;6&#39; and &lt;digit&gt; == &#39;9&#39; and &lt;lead-digit&gt; &lt;= 4.5
    &lt;digit&gt; == &#39;6&#39; and &lt;digit&gt; == &#39;9&#39; and &lt;lead-digit&gt; &gt; 4.5
    &lt;digit&gt; == &#39;6&#39; and &lt;digit&gt; == &#39;9&#39; and &lt;lead-digit&gt; &gt; 4.5
    &lt;digit&gt; == &#39;6&#39; and &lt;digits&gt; == &#39;&lt;digit&gt;&lt;digits&gt;&#39; and &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &gt; 4.5
    &lt;lead-digit&gt; &gt; 4.5
    &lt;digit&gt; == &#39;6&#39; and &lt;digits&gt; == &#39;&lt;digit&gt;&lt;digits&gt;&#39; and &lt;function&gt; == &#39;sqrt&#39; and &lt;integer&gt; &lt;= 23.5 and &lt;lead-digit&gt; &lt;= 4.5
    &lt;digit&gt; == &#39;6&#39; and &lt;digits&gt; == &#39;&lt;digit&gt;&lt;digits&gt;&#39; and &lt;lead-digit&gt; == &#39;4&#39; and &lt;lead-digit&gt; &gt; 4.5
    &lt;digit&gt; == &#39;6&#39; and &lt;digits&gt; == &#39;&lt;digit&gt;&lt;digits&gt;&#39; and &lt;function&gt; == &#39;sqrt&#39; and &lt;integer&gt; &gt; 23.5 and &lt;lead-digit&gt; &lt;= 4.5
    &lt;digit&gt; == &#39;6&#39; and &lt;digits&gt; == &#39;&lt;digit&gt;&lt;digits&gt;&#39; and &lt;lead-digit&gt; == &#39;4&#39; and &lt;lead-digit&gt; &lt;= 4.5
    &lt;digit&gt; == &#39;6&#39; and &lt;digits&gt; == &#39;&lt;digit&gt;&lt;digits&gt;&#39; and &lt;lead-digit&gt; == &#39;4&#39; and &lt;lead-digit&gt; &lt;= 4.5
    &lt;digit&gt; == &#39;6&#39; and &lt;digits&gt; == &#39;&lt;digit&gt;&lt;digits&gt;&#39; and &lt;function&gt; == &#39;sqrt&#39; and &lt;integer&gt; &lt;= 23.5 and &lt;lead-digit&gt; &lt;= 4.5
    &lt;digit&gt; == &#39;6&#39; and &lt;digits&gt; == &#39;&lt;digit&gt;&lt;digits&gt;&#39; and &lt;lead-digit&gt; == &#39;4&#39; and &lt;lead-digit&gt; &gt; 4.5
    &lt;digit&gt; == &#39;6&#39; and &lt;digits&gt; == &#39;&lt;digit&gt;&lt;digits&gt;&#39; and &lt;lead-digit&gt; == &#39;4&#39; and &lt;lead-digit&gt; &gt; 4.5
    &lt;digit&gt; == &#39;6&#39; and &lt;digits&gt; == &#39;&lt;digit&gt;&lt;digits&gt;&#39; and &lt;function&gt; == &#39;sqrt&#39; and &lt;integer&gt; &gt; 23.5 and &lt;lead-digit&gt; &gt; 4.5
    &lt;digit&gt; == &#39;6&#39; and &lt;digits&gt; == &#39;&lt;digit&gt;&lt;digits&gt;&#39; and &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &gt; 4.5
    &lt;digit&gt; == &#39;6&#39; and &lt;digits&gt; == &#39;&lt;digit&gt;&lt;digits&gt;&#39; and &lt;lead-digit&gt; == &#39;4&#39; and &lt;lead-digit&gt; &lt;= 4.5
    &lt;digit&gt; == &#39;6&#39; and &lt;digit&gt; == &#39;9&#39; and &lt;lead-digit&gt; &lt;= 4.5
    &lt;digit&gt; == &#39;6&#39; and &lt;digits&gt; == &#39;&lt;digit&gt;&lt;digits&gt;&#39; and &lt;function&gt; == &#39;sqrt&#39; and &lt;integer&gt; &lt;= 23.5 and &lt;lead-digit&gt; &gt; 4.5
    &lt;digit&gt; == &#39;6&#39; and &lt;digits&gt; == &#39;&lt;digit&gt;&lt;digits&gt;&#39; and &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &lt;= 4.5
    &lt;lead-digit&gt; &lt;= 4.5
    &lt;digit&gt; == &#39;6&#39; and &lt;digits&gt; == &#39;&lt;digit&gt;&lt;digits&gt;&#39; and &lt;lead-digit&gt; == &#39;4&#39; and &lt;lead-digit&gt; &lt;= 4.5
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  New samples:
    sqrt(-32.6), sin(8549), sin(4239.8), sin(4155749), tan(521.9), tan(704), sin(-799), cos(-609), tan(-859), sin(7724.7), sqrt(4073.1), sin(8450), cos(-9597.437), sin(8484575), tan(841), tan(-39), sqrt(-286630.6), cos(-281), sqrt(83), tan(-75.90), sqrt(-62), sqrt(74), tan(3), sin(3), cos(4), cos(3), sin(-0.7), sqrt(-15), tan(9), tan(1), tan(4), tan(8), tan(1), tan(-8.9), tan(-3), tan(-3), sin(-2), tan(1.4), cos(-0), cos(-7), sin(7), tan(0), sqrt(-20.4), sin(-0), cos(0), cos(-0), sin(-5), tan(-5), tan(5422.5), tan(-26), sqrt(434), tan(-37.7568), cos(-26), cos(-55670), sqrt(-70.286), cos(-6126753.966), cos(-47.67751), sin(-51.436), sqrt(90.69), sin(-700.6), sqrt(-84.156), sqrt(-561.380), sqrt(964.53), sin(-99), tan(80561), cos(-8865.9), sqrt(-59.6), sin(-88), sin(-9550.76), cos(64.0), cos(94.4), tan(-71), sqrt(6924434683), cos(-86.8), sqrt(-60.4), sqrt(78.7), sqrt(-0.6), sqrt(-69), sqrt(-44.62), sin(195280.4), cos(-96), cos(-6), tan(6.8), tan(6.7), sin(-56), sin(6.2), sqrt(-35.7), tan(-135.25), cos(25994)

Iteration #19
  Decision Tree:
    if &lt;lead-digit&gt; &lt;= 4.5000:
      if &lt;function&gt; == &#39;sqrt&#39;:
        if &lt;value&gt; &lt;= 42.0000:
          if &lt;term&gt; == &#39;&lt;value&gt;&#39;:
            NO_BUG
          else:
            BUG
        else:
          NO_BUG
      else:
        NO_BUG
    else:
      if &lt;lead-digit&gt; == &#39;1&#39;:
        BUG
      else:
        NO_BUG
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  New input specifications:
    &lt;lead-digit&gt; == &#39;1&#39; and &lt;lead-digit&gt; &gt; 4.5
    &lt;function&gt; == &#39;sqrt&#39; and &lt;term&gt; == &#39;&lt;value&gt;&#39; and &lt;lead-digit&gt; &lt;= 4.5 and &lt;value&gt; &lt;= 42.0
    &lt;function&gt; == &#39;sqrt&#39; and &lt;term&gt; == &#39;&lt;value&gt;&#39; and &lt;lead-digit&gt; &gt; 4.5 and &lt;value&gt; &lt;= 42.0
    &lt;function&gt; == &#39;sqrt&#39; and &lt;term&gt; == &#39;&lt;value&gt;&#39; and &lt;lead-digit&gt; &lt;= 4.5 and &lt;value&gt; &lt;= 42.0
    &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &gt; 4.5 and &lt;value&gt; &lt;= 42.0
    &lt;lead-digit&gt; == &#39;1&#39; and &lt;lead-digit&gt; &gt; 4.5
    &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &lt;= 4.5
    &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &gt; 4.5
    &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &lt;= 4.5 and &lt;value&gt; &lt;= 42.0
    &lt;function&gt; == &#39;sqrt&#39; and &lt;term&gt; == &#39;&lt;value&gt;&#39; and &lt;lead-digit&gt; &lt;= 4.5 and &lt;value&gt; &gt; 42.0
    &lt;function&gt; == &#39;sqrt&#39; and &lt;term&gt; == &#39;&lt;value&gt;&#39; and &lt;lead-digit&gt; &gt; 4.5 and &lt;value&gt; &gt; 42.0
    &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &gt; 4.5 and &lt;value&gt; &gt; 42.0
    &lt;function&gt; == &#39;sqrt&#39; and &lt;term&gt; == &#39;&lt;value&gt;&#39; and &lt;lead-digit&gt; &gt; 4.5 and &lt;value&gt; &gt; 42.0
    &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &lt;= 4.5 and &lt;value&gt; &gt; 42.0
    &lt;function&gt; == &#39;sqrt&#39; and &lt;term&gt; == &#39;&lt;value&gt;&#39; and &lt;lead-digit&gt; &gt; 4.5 and &lt;value&gt; &lt;= 42.0
    &lt;lead-digit&gt; == &#39;1&#39; and &lt;lead-digit&gt; &lt;= 4.5
    &lt;function&gt; == &#39;sqrt&#39; and &lt;term&gt; == &#39;&lt;value&gt;&#39; and &lt;lead-digit&gt; &lt;= 4.5 and &lt;value&gt; &gt; 42.0
    &lt;lead-digit&gt; == &#39;1&#39; and &lt;lead-digit&gt; &lt;= 4.5
    &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &lt;= 4.5
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  New samples:
    sqrt(680.890597), sqrt(-0), sqrt(-5), sqrt(-5), sqrt(-4.0), sin(-31), cos(-18.04), sqrt(-4.46), sqrt(-435), sqrt(-8.9), sqrt(-49), tan(-11.8), sqrt(-6), cos(-41), sqrt(-0), sqrt(-4.85), sqrt(9.5), sqrt(5), sqrt(5), sqrt(1), sqrt(56780.6), sqrt(1), sqrt(17), sqrt(29), sqrt(-911), sqrt(72.9527), sqrt(8514.0), sqrt(1.3), sqrt(-1), sqrt(-627), sqrt(79.48886), sqrt(-97163), sqrt(-31.52), sqrt(9.72), sqrt(16.46), sqrt(-6), sqrt(7), sqrt(0), sqrt(38), sqrt(-7.7), sqrt(-1), sqrt(-3.8), sin(54), cos(787188.6), sqrt(5379722545), tan(-766.3), tan(-708), sin(11.3), cos(-7507080), tan(-5414065.9), tan(-5690.9), cos(-52), sin(-550.916), cos(-701), sin(-89), sqrt(-52844.30), sqrt(95.1), cos(-11), cos(73.3), cos(-5914), cos(81), tan(-62.14), cos(68), sqrt(637.7), sqrt(-92), sqrt(90.3), cos(686.5), cos(-1662.16), cos(-50.4), cos(-99), sqrt(75.60250), sin(192), cos(94262.8), sin(135.52), sqrt(-52), sqrt(-57.6839), cos(-81.9), sin(8973), sqrt(47), cos(-963.188), sqrt(-16), sqrt(-44636081.9), sqrt(951), sqrt(-73.2), sin(-551.3), sqrt(54), sqrt(64.8), sqrt(-42.5), sqrt(52), tan(-559), tan(-8948), tan(-83), sin(-63.4), sin(-76), sqrt(576003), sin(-854.7), sqrt(656.6), cos(-89.9), cos(-96.44), sqrt(8471.101), sqrt(-376), sin(-55297), sin(-94.589), cos(-8570), sqrt(371), sqrt(-87.378), sqrt(-6), sqrt(-2.896), sqrt(-8), sqrt(-5), sqrt(-728.781), sqrt(-2), sqrt(-991.2299), sqrt(-3), cos(46.29), sqrt(155353.04), sqrt(18), cos(15)

Iteration #20
  Decision Tree:
    if &lt;lead-digit&gt; &lt;= 4.5000:
      if &lt;function&gt; == &#39;sqrt&#39;:
        if &lt;value&gt; &lt;= 42.0000:
          if &lt;term&gt; &lt;= -2.0000:
            BUG
          else:
            if &lt;value&gt; &lt;= 13.6540:
              NO_BUG
            else:
              NO_BUG
        else:
          NO_BUG
      else:
        if &lt;digit&gt; == &#39;4&#39;:
          NO_BUG
        else:
          NO_BUG
    else:
      if &lt;digit&gt; == &#39;9&#39;:
        NO_BUG
      else:
        NO_BUG
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  New input specifications:
    &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &lt;= 4.5 and &lt;term&gt; &gt; -2.0 and &lt;value&gt; &gt; 13.654000282287598
    &lt;digit&gt; == &#39;4&#39; and &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &lt;= 4.5
    &lt;digit&gt; == &#39;9&#39; and &lt;lead-digit&gt; &gt; 4.5
    &lt;digit&gt; == &#39;9&#39; and &lt;lead-digit&gt; &lt;= 4.5
    &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &gt; 4.5 and &lt;term&gt; &gt; -2.0 and &lt;value&gt; &lt;= 13.654000282287598
    &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &lt;= 4.5 and &lt;term&gt; &gt; -2.0 and &lt;value&gt; &lt;= 13.654000282287598
    &lt;digit&gt; == &#39;4&#39; and &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &gt; 4.5
    &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &gt; 4.5 and &lt;value&gt; &lt;= 42.0
    &lt;digit&gt; == &#39;4&#39; and &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &gt; 4.5
    &lt;digit&gt; == &#39;9&#39; and &lt;lead-digit&gt; &lt;= 4.5
    &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &lt;= 4.5 and &lt;term&gt; &gt; -2.0 and &lt;value&gt; &lt;= 42.0
    &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &lt;= 4.5 and &lt;value&gt; &lt;= 42.0
    &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &gt; 4.5 and &lt;term&gt; &lt;= -2.0 and &lt;value&gt; &gt; 42.0
    &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &gt; 4.5 and &lt;value&gt; &gt; 42.0
    &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &gt; 4.5 and &lt;term&gt; &gt; -2.0 and &lt;value&gt; &gt; 13.654000282287598
    &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &lt;= 4.5 and &lt;term&gt; &lt;= -2.0 and &lt;value&gt; &lt;= 42.0
    &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &lt;= 4.5 and &lt;term&gt; &lt;= -2.0 and &lt;value&gt; &gt; 42.0
    &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &lt;= 4.5 and &lt;value&gt; &gt; 42.0
    &lt;digit&gt; == &#39;4&#39; and &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &lt;= 4.5
    &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &gt; 4.5 and &lt;term&gt; &lt;= -2.0 and &lt;value&gt; &lt;= 42.0
    &lt;function&gt; == &#39;sqrt&#39; and &lt;lead-digit&gt; &lt;= 4.5 and &lt;term&gt; &lt;= -2.0 and &lt;value&gt; &lt;= 13.654000282287598
    &lt;digit&gt; == &#39;9&#39; and &lt;lead-digit&gt; &gt; 4.5
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  New samples:
    sqrt(125616), tan(-1347), sqrt(995.6), sqrt(-413), sqrt(8605.5), sqrt(9), sqrt(41), sqrt(7.486), sqrt(2.2), sqrt(5), sqrt(5), sqrt(6), sqrt(1), tan(-73.9297), sqrt(6.1), sqrt(-0), sqrt(-7.821), sqrt(7.9), sqrt(3.0), sqrt(537), sqrt(699.1), sqrt(1.4), sqrt(-2), sqrt(4.224), sqrt(-69), sqrt(7), sqrt(-0), sqrt(4), sqrt(-9.7), sqrt(80), sqrt(-7.19), sqrt(7.56), sqrt(-5.4), sqrt(-989.9154), sqrt(1.4), sqrt(55), sqrt(26), sqrt(9), sqrt(968), sin(-742.634), sin(189.0), sqrt(28), sqrt(14), sqrt(-75.276177528), sqrt(-915), sqrt(59), sqrt(-27.8), sqrt(-513), sin(-427.742), sqrt(-99.5), sqrt(-97), sin(-43.39), sqrt(247.6), sqrt(317.17), cos(-490), sqrt(2944), tan(-11), sqrt(-8.16), sqrt(-2), sqrt(-78.2), sqrt(-3.72), sqrt(-8.4), sqrt(-907.5), sqrt(-2814.9), sqrt(-8.1286), sqrt(-429.60), sqrt(-308), sqrt(-6.0), sqrt(-7.7), sqrt(-6), sqrt(-9), sqrt(-48.6), sqrt(-7.83), sqrt(-5), sqrt(-9), sqrt(-4), sqrt(-3), sqrt(-46.75), sqrt(-816)
</pre></div>
</div>
</div>
</div>
<p>To access the final decision tree learned by Alhazen, use:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">alhazen</span><span class="o">.</span><span class="n">last_tree</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>#sk-container-id-1 {
  /* Definition of color scheme common for light and dark mode */
  --sklearn-color-text: #000;
  --sklearn-color-text-muted: #666;
  --sklearn-color-line: gray;
  /* Definition of color scheme for unfitted estimators */
  --sklearn-color-unfitted-level-0: #fff5e6;
  --sklearn-color-unfitted-level-1: #f6e4d2;
  --sklearn-color-unfitted-level-2: #ffe0b3;
  --sklearn-color-unfitted-level-3: chocolate;
  /* Definition of color scheme for fitted estimators */
  --sklearn-color-fitted-level-0: #f0f8ff;
  --sklearn-color-fitted-level-1: #d4ebff;
  --sklearn-color-fitted-level-2: #b3dbfd;
  --sklearn-color-fitted-level-3: cornflowerblue;

  /* Specific color for light theme */
  --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, white)));
  --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-icon: #696969;

  @media (prefers-color-scheme: dark) {
    /* Redefinition of color scheme for dark theme */
    --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, #111)));
    --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-icon: #878787;
  }
}

#sk-container-id-1 {
  color: var(--sklearn-color-text);
}

#sk-container-id-1 pre {
  padding: 0;
}

#sk-container-id-1 input.sk-hidden--visually {
  border: 0;
  clip: rect(1px 1px 1px 1px);
  clip: rect(1px, 1px, 1px, 1px);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

#sk-container-id-1 div.sk-dashed-wrapped {
  border: 1px dashed var(--sklearn-color-line);
  margin: 0 0.4em 0.5em 0.4em;
  box-sizing: border-box;
  padding-bottom: 0.4em;
  background-color: var(--sklearn-color-background);
}

#sk-container-id-1 div.sk-container {
  /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
     but bootstrap.min.css set `[hidden] { display: none !important; }`
     so we also need the `!important` here to be able to override the
     default hidden behavior on the sphinx rendered scikit-learn.org.
     See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
  display: inline-block !important;
  position: relative;
}

#sk-container-id-1 div.sk-text-repr-fallback {
  display: none;
}

div.sk-parallel-item,
div.sk-serial,
div.sk-item {
  /* draw centered vertical line to link estimators */
  background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
  background-size: 2px 100%;
  background-repeat: no-repeat;
  background-position: center center;
}

/* Parallel-specific style estimator block */

#sk-container-id-1 div.sk-parallel-item::after {
  content: "";
  width: 100%;
  border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
  flex-grow: 1;
}

#sk-container-id-1 div.sk-parallel {
  display: flex;
  align-items: stretch;
  justify-content: center;
  background-color: var(--sklearn-color-background);
  position: relative;
}

#sk-container-id-1 div.sk-parallel-item {
  display: flex;
  flex-direction: column;
}

#sk-container-id-1 div.sk-parallel-item:first-child::after {
  align-self: flex-end;
  width: 50%;
}

#sk-container-id-1 div.sk-parallel-item:last-child::after {
  align-self: flex-start;
  width: 50%;
}

#sk-container-id-1 div.sk-parallel-item:only-child::after {
  width: 0;
}

/* Serial-specific style estimator block */

#sk-container-id-1 div.sk-serial {
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: var(--sklearn-color-background);
  padding-right: 1em;
  padding-left: 1em;
}


/* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
clickable and can be expanded/collapsed.
- Pipeline and ColumnTransformer use this feature and define the default style
- Estimators will overwrite some part of the style using the `sk-estimator` class
*/

/* Pipeline and ColumnTransformer style (default) */

#sk-container-id-1 div.sk-toggleable {
  /* Default theme specific background. It is overwritten whether we have a
  specific estimator or a Pipeline/ColumnTransformer */
  background-color: var(--sklearn-color-background);
}

/* Toggleable label */
#sk-container-id-1 label.sk-toggleable__label {
  cursor: pointer;
  display: flex;
  width: 100%;
  margin-bottom: 0;
  padding: 0.5em;
  box-sizing: border-box;
  text-align: center;
  align-items: start;
  justify-content: space-between;
  gap: 0.5em;
}

#sk-container-id-1 label.sk-toggleable__label .caption {
  font-size: 0.6rem;
  font-weight: lighter;
  color: var(--sklearn-color-text-muted);
}

#sk-container-id-1 label.sk-toggleable__label-arrow:before {
  /* Arrow on the left of the label */
  content: "▸";
  float: left;
  margin-right: 0.25em;
  color: var(--sklearn-color-icon);
}

#sk-container-id-1 label.sk-toggleable__label-arrow:hover:before {
  color: var(--sklearn-color-text);
}

/* Toggleable content - dropdown */

#sk-container-id-1 div.sk-toggleable__content {
  display: none;
  text-align: left;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content pre {
  margin: 0.2em;
  border-radius: 0.25em;
  color: var(--sklearn-color-text);
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content.fitted pre {
  /* unfitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-1 input.sk-toggleable__control:checked~div.sk-toggleable__content {
  /* Expand drop-down */
  display: block;
  width: 100%;
  overflow: visible;
}

#sk-container-id-1 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
  content: "▾";
}

/* Pipeline/ColumnTransformer-specific style */

#sk-container-id-1 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-label.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator-specific style */

/* Colorize estimator box */
#sk-container-id-1 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-estimator.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

#sk-container-id-1 div.sk-label label.sk-toggleable__label,
#sk-container-id-1 div.sk-label label {
  /* The background is the default theme color */
  color: var(--sklearn-color-text-on-default-background);
}

/* On hover, darken the color of the background */
#sk-container-id-1 div.sk-label:hover label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

/* Label box, darken color on hover, fitted */
#sk-container-id-1 div.sk-label.fitted:hover label.sk-toggleable__label.fitted {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator label */

#sk-container-id-1 div.sk-label label {
  font-family: monospace;
  font-weight: bold;
  display: inline-block;
  line-height: 1.2em;
}

#sk-container-id-1 div.sk-label-container {
  text-align: center;
}

/* Estimator-specific */
#sk-container-id-1 div.sk-estimator {
  font-family: monospace;
  border: 1px dotted var(--sklearn-color-border-box);
  border-radius: 0.25em;
  box-sizing: border-box;
  margin-bottom: 0.5em;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-estimator.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

/* on hover */
#sk-container-id-1 div.sk-estimator:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-estimator.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Specification for estimator info (e.g. "i" and "?") */

/* Common style for "i" and "?" */

.sk-estimator-doc-link,
a:link.sk-estimator-doc-link,
a:visited.sk-estimator-doc-link {
  float: right;
  font-size: smaller;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1em;
  height: 1em;
  width: 1em;
  text-decoration: none !important;
  margin-left: 0.5em;
  text-align: center;
  /* unfitted */
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
  color: var(--sklearn-color-unfitted-level-1);
}

.sk-estimator-doc-link.fitted,
a:link.sk-estimator-doc-link.fitted,
a:visited.sk-estimator-doc-link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
div.sk-estimator:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover,
div.sk-label-container:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

div.sk-estimator.fitted:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover,
div.sk-label-container:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

/* Span, style for the box shown on hovering the info icon */
.sk-estimator-doc-link span {
  display: none;
  z-index: 9999;
  position: relative;
  font-weight: normal;
  right: .2ex;
  padding: .5ex;
  margin: .5ex;
  width: min-content;
  min-width: 20ex;
  max-width: 50ex;
  color: var(--sklearn-color-text);
  box-shadow: 2pt 2pt 4pt #999;
  /* unfitted */
  background: var(--sklearn-color-unfitted-level-0);
  border: .5pt solid var(--sklearn-color-unfitted-level-3);
}

.sk-estimator-doc-link.fitted span {
  /* fitted */
  background: var(--sklearn-color-fitted-level-0);
  border: var(--sklearn-color-fitted-level-3);
}

.sk-estimator-doc-link:hover span {
  display: block;
}

/* "?"-specific style due to the `<a>` HTML tag */

#sk-container-id-1 a.estimator_doc_link {
  float: right;
  font-size: 1rem;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1rem;
  height: 1rem;
  width: 1rem;
  text-decoration: none;
  /* unfitted */
  color: var(--sklearn-color-unfitted-level-1);
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
}

#sk-container-id-1 a.estimator_doc_link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
#sk-container-id-1 a.estimator_doc_link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

#sk-container-id-1 a.estimator_doc_link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
}

.estimator-table summary {
    padding: .5rem;
    font-family: monospace;
    cursor: pointer;
}

.estimator-table details[open] {
    padding-left: 0.1rem;
    padding-right: 0.1rem;
    padding-bottom: 0.3rem;
}

.estimator-table .parameters-table {
    margin-left: auto !important;
    margin-right: auto !important;
}

.estimator-table .parameters-table tr:nth-child(odd) {
    background-color: #fff;
}

.estimator-table .parameters-table tr:nth-child(even) {
    background-color: #f6f6f6;
}

.estimator-table .parameters-table tr:hover {
    background-color: #e0e0e0;
}

.estimator-table table td {
    border: 1px solid rgba(106, 105, 104, 0.232);
}

.user-set td {
    color:rgb(255, 94, 0);
    text-align: left;
}

.user-set td.value pre {
    color:rgb(255, 94, 0) !important;
    background-color: transparent !important;
}

.default td {
    color: black;
    text-align: left;
}

.user-set td i,
.default td i {
    color: black;
}

.copy-paste-icon {
    background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0NDggNTEyIj48IS0tIUZvbnQgQXdlc29tZSBGcmVlIDYuNy4yIGJ5IEBmb250YXdlc29tZSAtIGh0dHBzOi8vZm9udGF3ZXNvbWUuY29tIExpY2Vuc2UgLSBodHRwczovL2ZvbnRhd2Vzb21lLmNvbS9saWNlbnNlL2ZyZWUgQ29weXJpZ2h0IDIwMjUgRm9udGljb25zLCBJbmMuLS0+PHBhdGggZD0iTTIwOCAwTDMzMi4xIDBjMTIuNyAwIDI0LjkgNS4xIDMzLjkgMTQuMWw2Ny45IDY3LjljOSA5IDE0LjEgMjEuMiAxNC4xIDMzLjlMNDQ4IDMzNmMwIDI2LjUtMjEuNSA0OC00OCA0OGwtMTkyIDBjLTI2LjUgMC00OC0yMS41LTQ4LTQ4bDAtMjg4YzAtMjYuNSAyMS41LTQ4IDQ4LTQ4ek00OCAxMjhsODAgMCAwIDY0LTY0IDAgMCAyNTYgMTkyIDAgMC0zMiA2NCAwIDAgNDhjMCAyNi41LTIxLjUgNDgtNDggNDhMNDggNTEyYy0yNi41IDAtNDgtMjEuNS00OC00OEwwIDE3NmMwLTI2LjUgMjEuNS00OCA0OC00OHoiLz48L3N2Zz4=);
    background-repeat: no-repeat;
    background-size: 14px 14px;
    background-position: 0;
    display: inline-block;
    width: 14px;
    height: 14px;
    cursor: pointer;
}
</style><body><div id="sk-container-id-1" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>DecisionTreeClassifier(class_weight={&#x27;BUG&#x27;: 0.125,
                                     &#x27;NO_BUG&#x27;: 0.001694915254237288},
                       max_depth=5)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-1" type="checkbox" checked><label for="sk-estimator-id-1" class="sk-toggleable__label fitted sk-toggleable__label-arrow"><div><div>DecisionTreeClassifier</div></div><div><a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.7/modules/generated/sklearn.tree.DecisionTreeClassifier.html">?<span>Documentation for DecisionTreeClassifier</span></a><span class="sk-estimator-doc-link fitted">i<span>Fitted</span></span></div></label><div class="sk-toggleable__content fitted" data-param-prefix="">
        <div class="estimator-table">
            <details>
                <summary>Parameters</summary>
                <table class="parameters-table">
                  <tbody>
                    
        <tr class="default">
            <td><i class="copy-paste-icon"
                 onclick="copyToClipboard('criterion',
                          this.parentElement.nextElementSibling)"
            ></i></td>
            <td class="param">criterion&nbsp;</td>
            <td class="value">&#x27;gini&#x27;</td>
        </tr>
    

        <tr class="default">
            <td><i class="copy-paste-icon"
                 onclick="copyToClipboard('splitter',
                          this.parentElement.nextElementSibling)"
            ></i></td>
            <td class="param">splitter&nbsp;</td>
            <td class="value">&#x27;best&#x27;</td>
        </tr>
    

        <tr class="user-set">
            <td><i class="copy-paste-icon"
                 onclick="copyToClipboard('max_depth',
                          this.parentElement.nextElementSibling)"
            ></i></td>
            <td class="param">max_depth&nbsp;</td>
            <td class="value">5</td>
        </tr>
    

        <tr class="default">
            <td><i class="copy-paste-icon"
                 onclick="copyToClipboard('min_samples_split',
                          this.parentElement.nextElementSibling)"
            ></i></td>
            <td class="param">min_samples_split&nbsp;</td>
            <td class="value">2</td>
        </tr>
    

        <tr class="default">
            <td><i class="copy-paste-icon"
                 onclick="copyToClipboard('min_samples_leaf',
                          this.parentElement.nextElementSibling)"
            ></i></td>
            <td class="param">min_samples_leaf&nbsp;</td>
            <td class="value">1</td>
        </tr>
    

        <tr class="default">
            <td><i class="copy-paste-icon"
                 onclick="copyToClipboard('min_weight_fraction_leaf',
                          this.parentElement.nextElementSibling)"
            ></i></td>
            <td class="param">min_weight_fraction_leaf&nbsp;</td>
            <td class="value">0.0</td>
        </tr>
    

        <tr class="default">
            <td><i class="copy-paste-icon"
                 onclick="copyToClipboard('max_features',
                          this.parentElement.nextElementSibling)"
            ></i></td>
            <td class="param">max_features&nbsp;</td>
            <td class="value">None</td>
        </tr>
    

        <tr class="default">
            <td><i class="copy-paste-icon"
                 onclick="copyToClipboard('random_state',
                          this.parentElement.nextElementSibling)"
            ></i></td>
            <td class="param">random_state&nbsp;</td>
            <td class="value">None</td>
        </tr>
    

        <tr class="default">
            <td><i class="copy-paste-icon"
                 onclick="copyToClipboard('max_leaf_nodes',
                          this.parentElement.nextElementSibling)"
            ></i></td>
            <td class="param">max_leaf_nodes&nbsp;</td>
            <td class="value">None</td>
        </tr>
    

        <tr class="default">
            <td><i class="copy-paste-icon"
                 onclick="copyToClipboard('min_impurity_decrease',
                          this.parentElement.nextElementSibling)"
            ></i></td>
            <td class="param">min_impurity_decrease&nbsp;</td>
            <td class="value">0.0</td>
        </tr>
    

        <tr class="user-set">
            <td><i class="copy-paste-icon"
                 onclick="copyToClipboard('class_weight',
                          this.parentElement.nextElementSibling)"
            ></i></td>
            <td class="param">class_weight&nbsp;</td>
            <td class="value">{&#x27;BUG&#x27;: 0.125, &#x27;NO_BUG&#x27;: 0.001694915254237288}</td>
        </tr>
    

        <tr class="default">
            <td><i class="copy-paste-icon"
                 onclick="copyToClipboard('ccp_alpha',
                          this.parentElement.nextElementSibling)"
            ></i></td>
            <td class="param">ccp_alpha&nbsp;</td>
            <td class="value">0.0</td>
        </tr>
    

        <tr class="default">
            <td><i class="copy-paste-icon"
                 onclick="copyToClipboard('monotonic_cst',
                          this.parentElement.nextElementSibling)"
            ></i></td>
            <td class="param">monotonic_cst&nbsp;</td>
            <td class="value">None</td>
        </tr>
    
                  </tbody>
                </table>
            </details>
        </div>
    </div></div></div></div></div><script>function copyToClipboard(text, element) {
    // Get the parameter prefix from the closest toggleable content
    const toggleableContent = element.closest('.sk-toggleable__content');
    const paramPrefix = toggleableContent ? toggleableContent.dataset.paramPrefix : '';
    const fullParamName = paramPrefix ? `${paramPrefix}${text}` : text;

    const originalStyle = element.style;
    const computedStyle = window.getComputedStyle(element);
    const originalWidth = computedStyle.width;
    const originalHTML = element.innerHTML.replace('Copied!', '');

    navigator.clipboard.writeText(fullParamName)
        .then(() => {
            element.style.width = originalWidth;
            element.style.color = 'green';
            element.innerHTML = "Copied!";

            setTimeout(() => {
                element.innerHTML = originalHTML;
                element.style = originalStyle;
            }, 2000);
        })
        .catch(err => {
            console.error('Failed to copy:', err);
            element.style.color = 'red';
            element.innerHTML = "Failed!";
            setTimeout(() => {
                element.innerHTML = originalHTML;
                element.style = originalStyle;
            }, 2000);
        });
    return false;
}

document.querySelectorAll('.fa-regular.fa-copy').forEach(function(element) {
    const toggleableContent = element.closest('.sk-toggleable__content');
    const paramPrefix = toggleableContent ? toggleableContent.dataset.paramPrefix : '';
    const paramName = element.parentElement.nextElementSibling.textContent.trim();
    const fullParamName = paramPrefix ? `${paramPrefix}${paramName}` : paramName;

    element.setAttribute('title', fullParamName);
});
</script></body></div></div>
</div>
<p>Let’s display it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">alhazen</span><span class="o">.</span><span class="n">show_decision_tree</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5f32cc5a8e2b499fd17870a2ca24db8305b6d28e1332db5e2bc304efc63a3c28.svg" src="_images/5f32cc5a8e2b499fd17870a2ca24db8305b6d28e1332db5e2bc304efc63a3c28.svg" />
</div>
</div>
<p>We can also view the tree as text:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">alhazen</span><span class="o">.</span><span class="n">friendly_decision_tree</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>if &lt;lead-digit&gt; &lt;= 4.5000:
  if &lt;function&gt; == &#39;sqrt&#39;:
    if &lt;value&gt; &lt;= 42.0000:
      if &lt;term&gt; &lt;= -2.0000:
        BUG
      else:
        NO_BUG
    else:
      NO_BUG
  else:
    NO_BUG
else:
  NO_BUG
</pre></div>
</div>
</div>
</div>
<p>In both views, we see that the failure is related to the <code class="docutils literal notranslate"><span class="pre">sqrt()</span></code> function being called with a negative value.
But what’s the deal with the <code class="docutils literal notranslate"><span class="pre">&lt;lead-digit&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">&lt;value&gt;</span></code> fields?
For this, let’s have a look at our sqrt function code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">task_sqrt</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>def task_sqrt(x):
    &quot;&quot;&quot;Computes the square root of x, using the Newton-Raphson method&quot;&quot;&quot;
    if x &lt;= -12 and x &gt;= -42:
        x = 0  # Guess where the bug is :-)
    else:
        x = 1
    x = max(x, 0)
    approx = None
    guess = x / 2
    while approx != guess:
        approx = guess
        guess = (approx + x / approx) / 2
    return approx
</pre></div>
</div>
</div>
</div>
<p>We see that Alhazen has correctly determined the boundaries of <code class="docutils literal notranslate"><span class="pre">x</span></code> for the bug - the <code class="docutils literal notranslate"><span class="pre">&lt;lead-digit&gt;</span></code> value must be <code class="docutils literal notranslate"><span class="pre">4</span></code> or less (otherwise, the value of <code class="docutils literal notranslate"><span class="pre">x</span></code> will not trigger the bug); and <code class="docutils literal notranslate"><span class="pre">&lt;value&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">&lt;term&gt;</span></code> correctly reflect the boundaries.
(Note that <code class="docutils literal notranslate"><span class="pre">&lt;term&gt;</span></code> comes with a sign, whereas <code class="docutils literal notranslate"><span class="pre">&lt;value&gt;</span></code> has no sign.)
Not too bad for a machine learning approach :-)</p>
</section>
<section id="lessons-learned">
<h2>Lessons Learned<a class="headerlink" href="#lessons-learned" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Training <em>machine learners from input features</em> can give important insights on failure circumstances.</p></li>
<li><p>Generating <em>additional inputs</em> based on feedback from the machine learner can greatly enhance precision.</p></li>
<li><p>Applying machine learners on input and execution features is still at its infancy.</p></li>
</ul>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Link to this heading">#</a></h2>
<p>Our <a class="reference internal" href="Repairer.html"><span class="std std-doc">next chapter</span></a> introduces <em>automated repair</em> of programs, building on the fault localization and generalization mechanisms introduced so far.</p>
</section>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">#</a></h2>
<p>This chapter is built on the Alhazen paper by Kampmann et al. \cite{Kampmann2020}.</p>
<p>In \cite{Eberlein2023}, Eberlein et al. introduced <em>Avicenna</em>, a new interpretation of Alhazen that makes use of the ISLa framework \cite{Steinhoefel2022} to learn and produce input features.
Avicenna improves over Alhazen in terms of performance, expressiveness, and precision.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="DDSetDebugger.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Generalizing Failure Circumstances</p>
      </div>
    </a>
    <a class="right-next"
       href="PerformanceDebugger.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Debugging Performance Issues</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#machine-learning-for-automated-debugging">Machine Learning for Automated Debugging</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-alhazen-approach">The Alhazen Approach</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#structure-of-this-chapter">Structure of this Chapter</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#inputs-and-grammars">Inputs and Grammars</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-extracting-features">Step 1: Extracting Features</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#internal-and-friendly-feature-names">Internal and “Friendly” Feature Names</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implementing-feature-classes">Implementing Feature Classes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-feature-sets-from-grammars">Extracting Feature Sets from Grammars</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-feature-values-from-inputs">Extracting Feature Values from Inputs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-transforming-grammars">Excursion: Transforming Grammars</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#end-of-excursion">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-train-classification-model">Step 2: Train Classification Model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decision-trees">Decision Trees</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-a-decision-tree">Learning a Decision Tree</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-extract-feature-requirements">Step 3: Extract Feature Requirements</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-tree-helper-functions">Excursion: Tree helper functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-converting-trees-to-paths">Excursion: Converting Trees to Paths</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-4-generating-new-samples">Step 4: Generating New Samples</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#negating-requirements">Negating Requirements</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#systematically-negating-paths">Systematically Negating Paths</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#input-specification-parser">Input Specification Parser</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-validating-the-parser">Excursion: Validating the Parser</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#retrieving-new-input-specifications">Retrieving New input Specifications</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-testing-specifications">Excursion: Testing Specifications</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-some-tests">Excursion: Some Tests</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-5-executing-new-inputs">Step 5: Executing New Inputs</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-alhazen-class">The Alhazen Class</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-sample-run">A Sample Run</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Andreas Zeller
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <div>
  Copyright &copy; 2021–2025 <a href="https://www.cispa.de/">CISPA Helmholtz Center for Information Security</a>.
  The <strong>content</strong> of this project is licensed under the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
  The <strong>source code</strong> that is part of the content, as well as the source code used to format and display that content is licensed under the <a href="https://github.com/uds-se/debuggingbook/blob/master/LICENSE.md#mit-license">MIT License</a>.
  <br>
  <a href="https://cispa.de/en/impressum">Imprint</a> &middot; <a href="/html/index.html#how-do-i-cite-your-work">Cite</a>
</div>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>