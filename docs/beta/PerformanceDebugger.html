
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Debugging Performance Issues &#8212; The Debugging Book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=d5c2cecb" />
    <link rel="stylesheet" type="text/css" href="_static/mastodon-timeline.css?v=f82c2b23" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'PerformanceDebugger';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Repairing Code Automatically" href="Repairer.html" />
    <link rel="prev" title="Learning from Failures" href="Alhazen.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content"><p>This is a beta version of debuggingbook.org, currently in development. See the <a href="https://debuggingbook.org/classic/"  style="color:white!important;">classic site</a> for the 2024 version.</p></div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/debuggingbook.png" class="logo__image only-light" alt="The Debugging Book - Home"/>
    <script>document.write(`<img src="_static/debuggingbook.png" class="logo__image only-dark" alt="The Debugging Book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    The Debugging Book
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tours.html">Sitemap</a></li>
<li class="toctree-l1"><a class="reference internal" href="Intro_Debugging.html">Introduction to Debugging</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Observing Executions</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tracer.html">Tracing Executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="Debugger.html">How Debuggers Work</a></li>
<li class="toctree-l1"><a class="reference internal" href="Assertions.html">Asserting Expectations</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Flows and Dependencies</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Slicer.html">Tracking Failure Origins</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Reducing Failure Causes</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="DeltaDebugger.html">Reducing Failure-Inducing Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ChangeDebugger.html">Isolating Failure-Inducing Changes</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Abstracting Failures</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="StatisticalDebugger.html">Statistical Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="DynamicInvariants.html">Mining Function Specifications</a></li>
<li class="toctree-l1"><a class="reference internal" href="DDSetDebugger.html">Generalizing Failure Circumstances</a></li>
<li class="toctree-l1"><a class="reference internal" href="Alhazen.html">Learning from Failures</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Debugging Performance Issues</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Automatic Repair</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Repairer.html">Repairing Code Automatically</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Debugging in the Large</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tracking.html">Tracking Bugs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ChangeCounter.html">Where the Bugs are</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ExpectError.html">Error Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timer.html">Timer</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timeout.html">Timeout</a></li>
<li class="toctree-l1"><a class="reference internal" href="ClassDiagram.html">Class Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="StackInspector.html">Inspecting Call Stacks</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">About This Book</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ReleaseNotes.html">Release Notes for The Debugging Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="Importing.html">Downloads and Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Guide_for_Authors.html">Guide for Authors</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/uds-se/debuggingbook/master?urlpath=tree/docs/notebooks/PerformanceDebugger.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/uds-se/debuggingbook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/uds-se/debuggingbook/issues/new?title=Issue%20on%20page%20%2FPerformanceDebugger.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
    <li><a href="../code/PerformanceDebugger.py" target="_blank"
       class="btn btn-sm btn-download-source-button dropdown-item"
       title="Download Python code"
       data-bs-placement="left" data-bs-toggle="tooltip"
    >
  

    <span class="btn__icon-container">
      <i class="fas fa-file"></i>
      </span>
    <span class="btn__text-container">.py</span>
    </a>
    </li>
    
      
      
      
      <li><a href="_sources/PerformanceDebugger.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download notebook"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  
    <li><a href="Importing.html" target="_blank"
       class="btn btn-sm btn-download-source-button dropdown-item"
       title="All downloads"
       data-bs-placement="left" data-bs-toggle="tooltip"
    >
  

    <span class="btn__icon-container">
      <i class="fas fa-file"></i>
      </span>
    <span class="btn__text-container">All downloads</span>
    </a>
    </li>
    </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Debugging Performance Issues</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#measuring-performance">Measuring Performance</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tracing-execution-profiles">Tracing Execution Profiles</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sampling-execution-profiles">Sampling Execution Profiles</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#improving-performance">Improving Performance</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#building-a-profiler">Building a Profiler</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-performance-metrics">Visualizing Performance Metrics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#collecting-time-spent">Collecting Time Spent</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-time-spent">Visualizing Time Spent</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#other-metrics">Other Metrics</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#integrating-with-delta-debugging">Integrating with Delta Debugging</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-profiling-memory-usage">Exercise 1: Profiling Memory Usage</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-statistical-performance-debugging">Exercise 2: Statistical Performance Debugging</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="debugging-performance-issues">
<h1>Debugging Performance Issues<a class="headerlink" href="#debugging-performance-issues" title="Link to this heading">#</a></h1>
<p>Most chapters of this book deal with <em>functional</em> issues – that is, issues related to the <em>functionality</em> (or its absence) of the code in question. However, debugging can also involve <em>nonfunctional</em> issues, however – performance, usability, reliability, and more. In this chapter, we give a short introduction on how to debug such nonfunctional issues, notably <em>performance</em> issues.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">YouTubeVideo</span>
<span class="n">YouTubeVideo</span><span class="p">(</span><span class="s2">&quot;0tMeB9G0uUI&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <iframe
            width="640"
            height="360"
            src="https://www.youtube-nocookie.com/embed/0tMeB9G0uUI"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
<p><strong>Prerequisites</strong></p>
<ul class="simple">
<li><p>This chapter leverages visualization capabilities from <a class="reference internal" href="StatisticalDebugger.html"><span class="std std-doc">the chapter on statistical debugging</span></a>.</p></li>
<li><p>We also show how to debug nonfunctional issues using <a class="reference internal" href="DeltaDebugger.html"><span class="std std-doc">delta debugging</span></a>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">bookutils.setup</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">StatisticalDebugger</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">DeltaDebugger</span>
</pre></div>
</div>
</div>
</div>
<section id="synopsis">
<h2>Synopsis<a class="headerlink" href="#synopsis" title="Link to this heading">#</a></h2>
<p>To <a class="reference internal" href="Importing.html"><span class="std std-doc">use the code provided in this chapter</span></a>, write</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">debuggingbook.PerformanceDebugger</span><span class="w"> </span><span class="kn">import</span> <span class="o">&lt;</span><span class="n">identifier</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>and then make use of the following features.</p>
<p><strong>Note</strong>: The examples in this section only work after the rest of the cells have been executed.</p>
<p>This chapter provides a class <code class="docutils literal notranslate"><span class="pre">PerformanceDebugger</span></code> that allows measuring and visualizing the time taken per line in a function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">PerformanceDebugger</span><span class="p">(</span><span class="n">TimeCollector</span><span class="p">)</span> <span class="k">as</span> <span class="n">debugger</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&lt;b&gt;foo&lt;/b&gt;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The distribution of executed time within each function can be obtained by printing out the debugger:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">debugger</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 238   1% def remove_html_markup(s):  # type: ignore
 239   1%     tag = False
 240   1%     quote = False
 241   1%     out = &quot;&quot;
 242   0%
 243  16%     for c in s:
 244  15%         assert tag or not quote
 245   0%
 246  15%         if c == &#39;&lt;&#39; and not quote:
 247   3%             tag = True
 248  12%         elif c == &#39;&gt;&#39; and not quote:
 249   2%             tag = False
 250   8%         elif (c == &#39;&quot;&#39; or c == &quot;&#39;&quot;) and tag:
 251   0%             quote = not quote
 252   8%         elif not tag:
 253   7%             out = out + c
 254   0%
 255   3%     return out
</pre></div>
</div>
</div>
</div>
<p>The sum of all percentages in a function should always be 100%.</p>
<p>These percentages can also be visualized, where darker shades represent higher percentage values:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">debugger</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="background-color:hsl(240, 100%, 97.03869523003347%)"
                    title="Line 238:   1% 0.00016483914805576205"> 238 def remove_html_markup(s):  # type: ignore</pre>
<pre style="background-color:hsl(240, 100%, 97.66153842936339%)"
                    title="Line 239:   1% 0.00013016897719353437"> 239     tag = False</pre>
<pre style="background-color:hsl(240, 100%, 97.58894298010105%)"
                    title="Line 240:   1% 0.00013420995674096048"> 240     quote = False</pre>
<pre style="background-color:hsl(240, 100%, 97.67715162450533%)"
                    title="Line 241:   1% 0.0001292998786084354"> 241     out = &quot;&quot;</pre>
<pre style="background-color:hsl(240, 100%, 100.0%)"
                    title="Line 242:   0% 0.0"> 242 &nbsp;</pre>
<pre style="background-color:hsl(240, 100%, 75.0%)"
                    title="Line 243:  16% 0.0013916091120336205"> 243     for c in s:</pre>
<pre style="background-color:hsl(240, 100%, 76.57003952184786%)"
                    title="Line 244:  15% 0.0013042138598393649"> 244         assert tag or not quote</pre>
<pre style="background-color:hsl(240, 100%, 100.0%)"
                    title="Line 245:   0% 0.0"> 245 &nbsp;</pre>
<pre style="background-color:hsl(240, 100%, 77.03739752893031%)"
                    title="Line 246:  15% 0.001278198673389852"> 246         if c == &#x27;&lt;&#x27; and not quote:</pre>
<pre style="background-color:hsl(240, 100%, 95.4000924389827%)"
                    title="Line 247:   3% 0.0002560509310569614"> 247             tag = True</pre>
<pre style="background-color:hsl(240, 100%, 81.41888819118138%)"
                    title="Line 248:  12% 0.0010343057801946998"> 248         elif c == &#x27;&gt;&#x27; and not quote:</pre>
<pre style="background-color:hsl(240, 100%, 95.47670908856104%)"
                    title="Line 249:   2% 0.0002517861139494926"> 249             tag = False</pre>
<pre style="background-color:hsl(240, 100%, 86.41214767441191%)"
                    title="Line 250:   8% 0.0007563591643702239"> 250         elif (c == &#x27;&quot;&#x27; or c == &quot;&#x27;&quot;) and tag:</pre>
<pre style="background-color:hsl(240, 100%, 100.0%)"
                    title="Line 251:   0% 0.0"> 251             quote = not quote</pre>
<pre style="background-color:hsl(240, 100%, 86.29332332259584%)"
                    title="Line 252:   8% 0.0007629734463989735"> 252         elif not tag:</pre>
<pre style="background-color:hsl(240, 100%, 88.48993026817239%)"
                    title="Line 253:   7% 0.0006407007167581469"> 253             out = out + c</pre>
<pre style="background-color:hsl(240, 100%, 100.0%)"
                    title="Line 254:   0% 0.0"> 254 &nbsp;</pre>
<pre style="background-color:hsl(240, 100%, 95.1517248915489%)"
                    title="Line 255:   3% 0.0002698761527426541"> 255     return out</pre>
</div></div>
</div>
<p>The abstract <code class="docutils literal notranslate"><span class="pre">MetricCollector</span></code> class allows subclassing to build more collectors, such as <code class="docutils literal notranslate"><span class="pre">HitCollector</span></code>.</p>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 14.0.2 (20251019.1705)
 -->
<!-- Pages: 1 -->
<svg width="573pt" height="590pt"
 viewBox="0.00 0.00 573.00 590.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 586.25)">
<g id="a_graph0"><a xlink:title="PerformanceDebugger class hierarchy">
<polygon fill="white" stroke="none" points="-4,4 -4,-586.25 569.12,-586.25 569.12,4 -4,4"/>
</a>
</g>
<!-- PerformanceDebugger -->
<g id="node1" class="node">
<title>PerformanceDebugger</title>
<g id="a_node1"><a xlink:href="#" xlink:title="class PerformanceDebugger:&#10;Collect and visualize a metric">
<polygon fill="none" stroke="black" points="0,-32.38 0,-78.38 169,-78.38 169,-32.38 0,-32.38"/>
<text xml:space="preserve" text-anchor="start" x="8" y="-62.08" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">PerformanceDebugger</text>
<polyline fill="none" stroke="black" points="0,-53.12 169,-53.12"/>
<g id="a_node1_0"><a xlink:href="#" xlink:title="PerformanceDebugger">
<g id="a_node1_1"><a xlink:href="#" xlink:title="__init__(self, collector_class: Type, log: bool = False):&#10;Constructor. Use instances of `collector_class` to collect events.">
<text xml:space="preserve" text-anchor="start" x="54.5" y="-40.62" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- MetricDebugger -->
<g id="node2" class="node">
<title>MetricDebugger</title>
<g id="a_node2"><a xlink:href="#" xlink:title="class MetricDebugger:&#10;Visualize a metric">
<polygon fill="none" stroke="black" points="21.38,-147.25 21.38,-257 147.62,-257 147.62,-147.25 21.38,-147.25"/>
<text xml:space="preserve" text-anchor="start" x="29.38" y="-240.7" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">MetricDebugger</text>
<polyline fill="none" stroke="black" points="21.38,-231.75 147.62,-231.75"/>
<g id="a_node2_2"><a xlink:href="#" xlink:title="MetricDebugger">
<g id="a_node2_3"><a xlink:href="#" xlink:title="color(self, location: Tuple[str, int]) &#45;&gt; str:&#10;Return a color for the given event, or None.&#10;To be overloaded in subclasses.">
<text xml:space="preserve" text-anchor="start" x="36.5" y="-219.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">color()</text>
</a>
</g>
<g id="a_node2_4"><a xlink:href="#" xlink:title="maximum(self, func_name: str) &#45;&gt; float">
<text xml:space="preserve" text-anchor="start" x="36.5" y="-205.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">maximum()</text>
</a>
</g>
<g id="a_node2_5"><a xlink:href="#" xlink:title="metric(self, location: Tuple[str, int]) &#45;&gt; float">
<text xml:space="preserve" text-anchor="start" x="36.5" y="-192.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">metric()</text>
</a>
</g>
<g id="a_node2_6"><a xlink:href="#" xlink:title="suspiciousness(self, location: Tuple[str, int]) &#45;&gt; float:&#10;Return a suspiciousness value in the range [0, 1.0]&#10;for the given event, or `None` if unknown.&#10;To be overloaded in subclasses.">
<text xml:space="preserve" text-anchor="start" x="36.5" y="-181" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">suspiciousness()</text>
</a>
</g>
<g id="a_node2_7"><a xlink:href="#" xlink:title="tooltip(self, location: Tuple[str, int]) &#45;&gt; str:&#10;Return a tooltip for the given event (default: percentage).&#10;To be overloaded in subclasses.">
<text xml:space="preserve" text-anchor="start" x="36.5" y="-168.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">tooltip()</text>
</a>
</g>
<g id="a_node2_8"><a xlink:href="#" xlink:title="total(self, func_name: str) &#45;&gt; float">
<text xml:space="preserve" text-anchor="start" x="36.5" y="-154.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">total()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- PerformanceDebugger&#45;&gt;MetricDebugger -->
<g id="edge1" class="edge">
<title>PerformanceDebugger&#45;&gt;MetricDebugger</title>
<path fill="none" stroke="black" d="M84.5,-78.67C84.5,-94 84.5,-115.19 84.5,-135.65"/>
<polygon fill="none" stroke="black" points="81,-135.38 84.5,-145.38 88,-135.38 81,-135.38"/>
</g>
<!-- SpectrumDebugger -->
<g id="node3" class="node">
<title>SpectrumDebugger</title>
<g id="a_node3"><a xlink:href="StatisticalDebugger.ipynb" xlink:title="class SpectrumDebugger:&#10;A class to collect events for passing and failing outcomes.">
<polygon fill="none" stroke="black" points="9.75,-294 9.75,-330 159.25,-330 159.25,-294 9.75,-294"/>
<text xml:space="preserve" text-anchor="start" x="17.75" y="-308.7" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">SpectrumDebugger</text>
</a>
</g>
</g>
<!-- MetricDebugger&#45;&gt;SpectrumDebugger -->
<g id="edge2" class="edge">
<title>MetricDebugger&#45;&gt;SpectrumDebugger</title>
<path fill="none" stroke="black" d="M84.5,-257.38C84.5,-266.06 84.5,-274.72 84.5,-282.48"/>
<polygon fill="none" stroke="black" points="81,-282.28 84.5,-292.28 88,-282.28 81,-282.28"/>
</g>
<!-- DifferenceDebugger -->
<g id="node4" class="node">
<title>DifferenceDebugger</title>
<g id="a_node4"><a xlink:href="StatisticalDebugger.ipynb" xlink:title="class DifferenceDebugger:&#10;A class to collect events for passing and failing outcomes.">
<polygon fill="none" stroke="black" points="8.62,-367 8.62,-425.75 160.38,-425.75 160.38,-367 8.62,-367"/>
<text xml:space="preserve" text-anchor="start" x="16.62" y="-409.45" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">DifferenceDebugger</text>
<polyline fill="none" stroke="black" points="8.62,-400.5 160.38,-400.5"/>
<g id="a_node4_9"><a xlink:href="#" xlink:title="DifferenceDebugger">
<g id="a_node4_10"><a xlink:href="StatisticalDebugger.ipynb" xlink:title="FAIL = &#39;FAIL&#39;">
<text xml:space="preserve" text-anchor="start" x="72.5" y="-387" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">FAIL</text>
</a>
</g>
<g id="a_node4_11"><a xlink:href="StatisticalDebugger.ipynb" xlink:title="PASS = &#39;PASS&#39;">
<text xml:space="preserve" text-anchor="start" x="72.5" y="-374.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">PASS</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- SpectrumDebugger&#45;&gt;DifferenceDebugger -->
<g id="edge3" class="edge">
<title>SpectrumDebugger&#45;&gt;DifferenceDebugger</title>
<path fill="none" stroke="black" d="M84.5,-330.47C84.5,-337.76 84.5,-346.55 84.5,-355.28"/>
<polygon fill="none" stroke="black" points="81,-355.07 84.5,-365.07 88,-355.07 81,-355.07"/>
</g>
<!-- StatisticalDebugger -->
<g id="node5" class="node">
<title>StatisticalDebugger</title>
<g id="a_node5"><a xlink:href="StatisticalDebugger.ipynb" xlink:title="class StatisticalDebugger:&#10;A class to collect events for multiple outcomes.">
<polygon fill="none" stroke="black" points="9,-462.75 9,-498.75 160,-498.75 160,-462.75 9,-462.75"/>
<text xml:space="preserve" text-anchor="start" x="17" y="-477.45" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">StatisticalDebugger</text>
</a>
</g>
</g>
<!-- DifferenceDebugger&#45;&gt;StatisticalDebugger -->
<g id="edge4" class="edge">
<title>DifferenceDebugger&#45;&gt;StatisticalDebugger</title>
<path fill="none" stroke="black" d="M84.5,-426.19C84.5,-434.2 84.5,-442.9 84.5,-450.91"/>
<polygon fill="none" stroke="black" points="81,-450.85 84.5,-460.85 88,-450.85 81,-450.85"/>
</g>
<!-- TimeCollector -->
<g id="node6" class="node">
<title>TimeCollector</title>
<g id="a_node6"><a xlink:href="#" xlink:title="class TimeCollector:&#10;Collect time executed for each line">
<polygon fill="none" stroke="black" points="199.5,-0.5 199.5,-110.25 311.5,-110.25 311.5,-0.5 199.5,-0.5"/>
<text xml:space="preserve" text-anchor="start" x="207.5" y="-93.95" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">TimeCollector</text>
<polyline fill="none" stroke="black" points="199.5,-85 311.5,-85"/>
<g id="a_node6_12"><a xlink:href="#" xlink:title="TimeCollector">
<g id="a_node6_13"><a xlink:href="#" xlink:title="__enter__(self) &#45;&gt; Any:&#10;Called at begin of `with` block. Turn tracing on.">
<text xml:space="preserve" text-anchor="start" x="216.5" y="-72.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">__enter__()</text>
</a>
</g>
<g id="a_node6_14"><a xlink:href="#" xlink:title="__init__(self) &#45;&gt; None:&#10;Constructor">
<text xml:space="preserve" text-anchor="start" x="216.5" y="-59.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node6_15"><a xlink:href="#" xlink:title="all_metrics(self, func: str) &#45;&gt; List[float]:&#10;Return all metric for a function `func`.">
<text xml:space="preserve" text-anchor="start" x="216.5" y="-47" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">all_metrics()</text>
</a>
</g>
<g id="a_node6_16"><a xlink:href="#" xlink:title="collect(self, frame: frame, event: str, arg: Any) &#45;&gt; None:&#10;Invoked for every line executed. Accumulate time spent.">
<text xml:space="preserve" text-anchor="start" x="216.5" y="-34.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">collect()</text>
</a>
</g>
<g id="a_node6_17"><a xlink:href="#" xlink:title="metric(self, location: Any) &#45;&gt; Optional[float]:&#10;Return a metric for an event, or none.">
<text xml:space="preserve" text-anchor="start" x="216.5" y="-21.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">metric()</text>
</a>
</g>
<g id="a_node6_18"><a xlink:href="#" xlink:title="reset_timer(self) &#45;&gt; None">
<text xml:space="preserve" text-anchor="start" x="216.5" y="-7.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">reset_timer()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- MetricCollector -->
<g id="node7" class="node">
<title>MetricCollector</title>
<g id="a_node7"><a xlink:href="#" xlink:title="class MetricCollector:&#10;Abstract superclass for collecting line&#45;specific metrics">
<polygon fill="none" stroke="black" points="206.38,-160 206.38,-244.25 326.62,-244.25 326.62,-160 206.38,-160"/>
<text xml:space="preserve" text-anchor="start" x="214.38" y="-227.95" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">MetricCollector</text>
<polyline fill="none" stroke="black" points="206.38,-219 326.62,-219"/>
<g id="a_node7_19"><a xlink:href="#" xlink:title="MetricCollector">
<g id="a_node7_20"><a xlink:href="#" xlink:title="all_metrics(self, func: str) &#45;&gt; List[float]:&#10;Return all metric for a function `func`.">
<text xml:space="preserve" text-anchor="start" x="227.5" y="-206.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">all_metrics()</text>
</a>
</g>
<g id="a_node7_21"><a xlink:href="#" xlink:title="maximum(self, func: str) &#45;&gt; float">
<text xml:space="preserve" text-anchor="start" x="227.5" y="-192.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">maximum()</text>
</a>
</g>
<g id="a_node7_22"><a xlink:href="#" xlink:title="metric(self, event: Any) &#45;&gt; Optional[float]:&#10;Return a metric for an event, or none.">
<text xml:space="preserve" text-anchor="start" x="227.5" y="-181" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">metric()</text>
</a>
</g>
<g id="a_node7_23"><a xlink:href="#" xlink:title="total(self, func: str) &#45;&gt; float">
<text xml:space="preserve" text-anchor="start" x="227.5" y="-167.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">total()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- TimeCollector&#45;&gt;MetricCollector -->
<g id="edge5" class="edge">
<title>TimeCollector&#45;&gt;MetricCollector</title>
<path fill="none" stroke="black" d="M259.63,-110.69C260.56,-122.97 261.55,-135.99 262.48,-148.21"/>
<polygon fill="none" stroke="black" points="258.98,-148.42 263.23,-158.12 265.96,-147.89 258.98,-148.42"/>
</g>
<!-- CoverageCollector -->
<g id="node8" class="node">
<title>CoverageCollector</title>
<g id="a_node8"><a xlink:href="StatisticalDebugger.ipynb" xlink:title="class CoverageCollector:&#10;A class to record covered locations during execution.">
<polygon fill="none" stroke="black" points="195.12,-294 195.12,-330 337.88,-330 337.88,-294 195.12,-294"/>
<text xml:space="preserve" text-anchor="start" x="203.12" y="-308.7" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">CoverageCollector</text>
</a>
</g>
</g>
<!-- MetricCollector&#45;&gt;CoverageCollector -->
<g id="edge6" class="edge">
<title>MetricCollector&#45;&gt;CoverageCollector</title>
<path fill="none" stroke="black" d="M266.5,-244.52C266.5,-257.14 266.5,-270.72 266.5,-282.29"/>
<polygon fill="none" stroke="black" points="263,-282 266.5,-292 270,-282 263,-282"/>
</g>
<!-- Collector -->
<g id="node9" class="node">
<title>Collector</title>
<g id="a_node9"><a xlink:href="StatisticalDebugger.ipynb" xlink:title="class Collector:&#10;A class to record events during execution.">
<polygon fill="none" stroke="black" points="202.38,-378.38 202.38,-414.38 280.62,-414.38 280.62,-378.38 202.38,-378.38"/>
<text xml:space="preserve" text-anchor="start" x="210.38" y="-393.07" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">Collector</text>
</a>
</g>
</g>
<!-- CoverageCollector&#45;&gt;Collector -->
<g id="edge7" class="edge">
<title>CoverageCollector&#45;&gt;Collector</title>
<path fill="none" stroke="black" d="M261.2,-330.47C257.98,-341.06 253.8,-354.83 250.12,-366.96"/>
<polygon fill="none" stroke="black" points="246.79,-365.9 247.23,-376.48 253.49,-367.93 246.79,-365.9"/>
</g>
<!-- StackInspector -->
<g id="node11" class="node">
<title>StackInspector</title>
<g id="a_node11"><a xlink:href="StackInspector.ipynb" xlink:title="class StackInspector:&#10;Provide functions to inspect the stack">
<polygon fill="none" stroke="black" points="196.5,-535.75 196.5,-581.75 362.5,-581.75 362.5,-535.75 196.5,-535.75"/>
<text xml:space="preserve" text-anchor="start" x="229.25" y="-565.45" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">StackInspector</text>
<polyline fill="none" stroke="black" points="196.5,-556.5 362.5,-556.5"/>
<g id="a_node11_24"><a xlink:href="#" xlink:title="StackInspector">
<g id="a_node11_25"><a xlink:href="StackInspector.ipynb" xlink:title="_generated_function_cache = {(&#39;remove_html_markup&#39;, 238): &lt;function remove_html_markup at 0x12132f420&gt;}">
<text xml:space="preserve" text-anchor="start" x="204.5" y="-543" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">_generated_function_cache</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- CoverageCollector&#45;&gt;StackInspector -->
<g id="edge10" class="edge">
<title>CoverageCollector&#45;&gt;StackInspector</title>
<path fill="none" stroke="black" d="M276.04,-330.24C281.14,-340.45 286.89,-353.82 289.5,-366.5 300.68,-420.83 293.04,-485.58 286.36,-524.09"/>
<polygon fill="none" stroke="black" points="282.93,-523.43 284.57,-533.9 289.81,-524.69 282.93,-523.43"/>
</g>
<!-- Tracer -->
<g id="node10" class="node">
<title>Tracer</title>
<g id="a_node10"><a xlink:href="Tracer.ipynb" xlink:title="class Tracer:&#10;A class for tracing a piece of code. Use as `with Tracer(): block()`">
<polygon fill="none" stroke="black" points="217.12,-462.75 217.12,-498.75 275.88,-498.75 275.88,-462.75 217.12,-462.75"/>
<text xml:space="preserve" text-anchor="start" x="225.12" y="-477.45" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">Tracer</text>
</a>
</g>
</g>
<!-- Collector&#45;&gt;Tracer -->
<g id="edge8" class="edge">
<title>Collector&#45;&gt;Tracer</title>
<path fill="none" stroke="black" d="M242.56,-414.84C243.2,-425.33 244.02,-438.92 244.75,-450.96"/>
<polygon fill="none" stroke="black" points="241.25,-451.03 245.35,-460.79 248.24,-450.6 241.25,-451.03"/>
</g>
<!-- Tracer&#45;&gt;StackInspector -->
<g id="edge9" class="edge">
<title>Tracer&#45;&gt;StackInspector</title>
<path fill="none" stroke="black" d="M253.99,-499C257.31,-506.65 261.34,-515.94 265.21,-524.84"/>
<polygon fill="none" stroke="black" points="261.99,-526.21 269.18,-533.99 268.41,-523.42 261.99,-526.21"/>
</g>
<!-- HitCollector -->
<g id="node12" class="node">
<title>HitCollector</title>
<g id="a_node12"><a xlink:href="#" xlink:title="class HitCollector:&#10;Collect how often a line is executed">
<polygon fill="none" stroke="black" points="329.62,-13.25 329.62,-97.5 427.38,-97.5 427.38,-13.25 329.62,-13.25"/>
<text xml:space="preserve" text-anchor="start" x="337.62" y="-81.2" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">HitCollector</text>
<polyline fill="none" stroke="black" points="329.62,-72.25 427.38,-72.25"/>
<g id="a_node12_26"><a xlink:href="#" xlink:title="HitCollector">
<g id="a_node12_27"><a xlink:href="#" xlink:title="__init__(self) &#45;&gt; None:&#10;Constructor.">
<text xml:space="preserve" text-anchor="start" x="339.5" y="-59.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node12_28"><a xlink:href="#" xlink:title="all_metrics(self, func: str) &#45;&gt; List[float]:&#10;Return all metric for a function `func`.">
<text xml:space="preserve" text-anchor="start" x="339.5" y="-47" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">all_metrics()</text>
</a>
</g>
<g id="a_node12_29"><a xlink:href="#" xlink:title="collect(self, frame: frame, event: str, arg: Any) &#45;&gt; None:&#10;Save coverage for an observed event.">
<text xml:space="preserve" text-anchor="start" x="339.5" y="-34.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">collect()</text>
</a>
</g>
<g id="a_node12_30"><a xlink:href="#" xlink:title="metric(self, location: Tuple[str, int]) &#45;&gt; Optional[int]:&#10;Return a metric for an event, or none.">
<text xml:space="preserve" text-anchor="start" x="339.5" y="-21.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">metric()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- HitCollector&#45;&gt;MetricCollector -->
<g id="edge11" class="edge">
<title>HitCollector&#45;&gt;MetricCollector</title>
<path fill="none" stroke="black" d="M346.41,-97.85C333.63,-114.36 318.82,-133.5 305.45,-150.79"/>
<polygon fill="none" stroke="black" points="302.88,-148.39 299.53,-158.44 308.41,-152.68 302.88,-148.39"/>
</g>
<!-- Legend -->
<g id="node13" class="node">
<title>Legend</title>
<text xml:space="preserve" text-anchor="start" x="445.88" y="-71.38" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="10.00" fill="#6a0dad">Legend</text>
<text xml:space="preserve" text-anchor="start" x="445.88" y="-61.38" font-family="Raleway, Helvetica, Arial, sans-serif" font-size="10.00">• </text>
<text xml:space="preserve" text-anchor="start" x="451.88" y="-61.38" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="8.00">public_method()</text>
<text xml:space="preserve" text-anchor="start" x="445.88" y="-51.38" font-family="Raleway, Helvetica, Arial, sans-serif" font-size="10.00">• </text>
<text xml:space="preserve" text-anchor="start" x="451.88" y="-51.38" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="8.00">private_method()</text>
<text xml:space="preserve" text-anchor="start" x="445.88" y="-41.38" font-family="Raleway, Helvetica, Arial, sans-serif" font-size="10.00">• </text>
<text xml:space="preserve" text-anchor="start" x="451.88" y="-41.38" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="8.00">overloaded_method()</text>
<text xml:space="preserve" text-anchor="start" x="445.88" y="-32.33" font-family="Helvetica,sans-Serif" font-size="9.00">Hover over names to see doc</text>
</g>
</g>
</svg>
</div></div>
</div>
</section>
<section id="measuring-performance">
<h2>Measuring Performance<a class="headerlink" href="#measuring-performance" title="Link to this heading">#</a></h2>
<p>The solution to debugging performance issues fits in two simple rules:</p>
<ol class="arabic simple">
<li><p><em>Measure</em> performance</p></li>
<li><p><em>Break down</em> how individual parts of your code contribute to performance.</p></li>
</ol>
<p>The first part, actually <em>measuring</em> performance, is key here. Developers often take elaborated guesses on which aspects of their code impact performance, and think about all possible ways to optimize their code – and at the same time, making it harder to understand, harder to evolve, and harder to maintain. In most cases, such guesses are wrong. Instead, <em>measure</em> performance of your program, <em>identify</em> the very few parts that may need to get improved, and again <em>measure</em> the impact of your changes.</p>
<p>Almost all programming languages offer a way to measure performance and breaking it down to individual parts of the code – a means also known as <em>profiling</em>. Profiling works by measuring the execution time for each function (or even more fine-grained location) in your program. This can be achieved by</p>
<ol class="arabic simple">
<li><p><em>Instrumenting</em> or <em>tracing</em> code such that the current time at entry and exit of each function (or line), thus determining the time spent. In Python, this is achieved by profilers like <a class="reference external" href="https://docs.python.org/3/library/profile.html">profile or cProfile</a></p></li>
<li><p><em>Sampling</em> the current function call stack at regular intervals, and thus assessing which functions are most active (= take the most time) during execution. For Python, the <a class="reference external" href="https://github.com/plasma-umass/scalene">scalene</a> profiler works this way.</p></li>
</ol>
<p>Pretty much all programming languages support profiling, either through measuring, sampling, or both. As a rule of thumb, <em>interpreted</em> languages more frequently support measuring (as it is easy to implement in an interpreter), while <em>compiled</em> languages more frequently support sampling (because instrumentation requires recompilation). Python is lucky to support both methods.</p>
<section id="tracing-execution-profiles">
<h3>Tracing Execution Profiles<a class="headerlink" href="#tracing-execution-profiles" title="Link to this heading">#</a></h3>
<p>Let us illustrate profiling in a simple example. The <code class="docutils literal notranslate"><span class="pre">ChangeCounter</span></code> class (which we will encounter in the <a class="reference internal" href="ChangeCounter.html"><span class="std std-doc">chapter on mining version histories</span></a>) reads in a version history from a git repository. Yet, it takes more than a minute to read in the debugging book change history:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ChangeCounter</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChangeCounter</span><span class="p">,</span> <span class="n">debuggingbook_change_counter</span>  <span class="c1"># minor dependency</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">Timer</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Timer</span><span class="o">.</span><span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
    <span class="n">change_counter</span> <span class="o">=</span> <span class="n">debuggingbook_change_counter</span><span class="p">(</span><span class="n">ChangeCounter</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>95.47416895799688
</pre></div>
</div>
</div>
</div>
<p>The Python <code class="docutils literal notranslate"><span class="pre">profile</span></code> and <code class="docutils literal notranslate"><span class="pre">cProfile</span></code> modules offer a simple way to identify the most time-consuming functions. They are invoked using the <code class="docutils literal notranslate"><span class="pre">run()</span></code> function, whose argument is the command to be profiled. The output reports, for each function encountered:</p>
<ul class="simple">
<li><p>How often it was called (<code class="docutils literal notranslate"><span class="pre">ncalls</span></code> column)</p></li>
<li><p>How much time was spent in the given function, <em>excluding</em> time spent in calls to sub-functions (<code class="docutils literal notranslate"><span class="pre">tottime</span></code> column)</p></li>
</ul>
<!-- * The fraction of `tottime` / `ncalls` (first `percall` column) -->
<ul class="simple">
<li><p>How much time was spent in the given function, <em>including</em> time spent in calls to sub-functions (<code class="docutils literal notranslate"><span class="pre">cumtime</span></code> column)</p></li>
</ul>
<!-- * The fraction of `cumtime` / `ncalls` (second `percall` column) -->
<p>Let us have a look at the profile we obtain:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">cProfile</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cProfile</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;debuggingbook_change_counter(ChangeCounter)&#39;</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="s1">&#39;cumulative&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>         43450243 function calls (43245180 primitive calls) in 103.436 seconds

   Ordered by: cumulative time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
     2714    0.016    0.000  157.824    0.058 threading.py:1058(join)
     2714    0.050    0.000  157.506    0.058 {method &#39;join&#39; of &#39;_thread._ThreadHandle&#39; objects}
     1409    0.006    0.000  103.775    0.074 repository.py:213(traverse_commits)
      2/1    0.000    0.000  103.435  103.435 {built-in method builtins.exec}
      2/1    0.002    0.001  103.435  103.435 &lt;string&gt;:1(&lt;module&gt;)
        1    0.000    0.000  103.433  103.433 ChangeCounter.ipynb:168(debuggingbook_change_counter)
        1    0.000    0.000  103.433  103.433 ChangeCounter.ipynb:51(__init__)
        1    0.000    0.000  103.433  103.433 ChangeCounter.ipynb:88(mine)
        1    0.000    0.000  103.401  103.401 _base.py:646(__exit__)
        1    0.000    0.000  103.401  103.401 thread.py:220(shutdown)
   2714/1    0.031    0.000  103.400  103.400 threading.py:1000(_bootstrap)
   2714/1    0.046    0.000  103.400  103.400 threading.py:1027(_bootstrap_inner)
   2714/1    0.021    0.000  103.400  103.400 ipkernel.py:750(run_closure)
   2714/1   13.244    0.005  103.400  103.400 threading.py:983(run)
      4/1    0.000    0.000  103.400  103.400 thread.py:70(_worker)
     18/4    0.001    0.000  103.400   25.850 {method &#39;get&#39; of &#39;_queue.SimpleQueue&#39; objects}
     1408    0.039    0.000  103.032    0.073 ChangeCounter.ipynb:102(mine_commit)
     1408    0.045    0.000  100.615    0.071 commit.py:758(modified_files)
     1355    0.214    0.000   98.978    0.073 diff.py:184(diff)
     1355   12.267    0.009   78.512    0.058 diff.py:583(_index_from_patch_format)
     1355    0.048    0.000   54.381    0.040 cmd.py:102(handle_process_output)
2710/1355   31.919    0.012   53.558    0.040 cmd.py:149(pump_stream)
      101    9.849    0.098   21.316    0.211 {built-in method time.sleep}
    15521    0.102    0.000   21.288    0.001 diff.py:412(__init__)
    14605    0.013    0.000   20.843    0.001 base.py:479(submodules)
    14605    0.047    0.000   20.830    0.001 util.py:1274(list_items)
34012/34006    0.056    0.000   20.772    0.001 {method &#39;extend&#39; of &#39;list&#39; objects}
    43815    0.203    0.000   20.716    0.000 base.py:1581(iter_items)
5426/5201    0.042    0.000   15.940    0.003 {method &#39;close&#39; of &#39;_io.BufferedReader&#39; objects}
     1410    0.137    0.000    9.950    0.007 cmd.py:1540(_call_process)
     1410    0.178    0.000    9.774    0.007 cmd.py:1096(execute)
     1356    0.034    0.000    9.620    0.007 cmd.py:1003(&lt;lambda&gt;)
     1410    0.156    0.000    9.131    0.006 subprocess.py:817(__init__)
     1410    0.222    0.000    8.862    0.006 subprocess.py:1808(_execute_child)
    74433    0.135    0.000    7.816    0.000 util.py:248(__getattr__)
   134748    0.396    0.000    7.637    0.000 cmd.py:1676(__get_object_header)
    43815    0.039    0.000    6.873    0.000 base.py:713(commit)
     1410    6.802    0.005    6.802    0.005 {built-in method _posixsubprocess.fork_exec}
102235/29210    0.071    0.000    6.520    0.000 tree.py:363(__getitem__)
102235/29210    0.267    0.000    6.484    0.000 tree.py:233(join)
    43815    0.018    0.000    6.277    0.000 symbolic.py:389(commit)
    43815    0.024    0.000    6.259    0.000 symbolic.py:289(_get_commit)
   240146    6.240    0.000    6.240    0.000 {method &#39;readline&#39; of &#39;_io.BufferedReader&#39; objects}
    43815    0.060    0.000    6.235    0.000 symbolic.py:279(_get_object)
    76328    0.175    0.000    5.800    0.000 db.py:44(stream)
    58420    0.077    0.000    5.728    0.000 tree.py:212(_set_cache_)
    76328    0.203    0.000    5.491    0.000 cmd.py:1712(stream_object_data)
    58420    0.053    0.000    4.656    0.000 symbolic.py:155(dereference_recursive)
   116841    0.104    0.000    4.602    0.000 symbolic.py:268(_get_ref_info)
   116841    0.365    0.000    4.498    0.000 symbolic.py:220(_get_ref_info_helper)
    58420    0.132    0.000    3.853    0.000 base.py:136(new_from_sha)
    14605    0.071    0.000    3.635    0.000 base.py:230(_config_parser)
    58420    0.129    0.000    3.332    0.000 db.py:39(info)
    58420    0.068    0.000    3.092    0.000 cmd.py:1684(get_object_header)
    14605    0.067    0.000    2.476    0.000 fun.py:230(rev_parse)
   134743    2.403    0.000    2.463    0.000 {built-in method _io.open}
    14605    0.047    0.000    2.401    0.000 fun.py:150(name_to_object)
    16013    0.039    0.000    1.941    0.000 commit.py:241(_set_cache_)
       23    0.001    0.000    1.693    0.074 base_events.py:1962(_run_once)
       23    0.001    0.000    1.690    0.073 selectors.py:540(select)
117161/102342    0.109    0.000    1.539    0.000 config.py:111(assure_data_present)
    14605    0.025    0.000    1.539    0.000 util.py:82(__init__)
    14711    0.068    0.000    1.525    0.000 config.py:315(__init__)
    58420    0.993    0.000    1.482    0.000 fun.py:77(tree_entries_from_data)
    14711    0.102    0.000    1.451    0.000 configparser.py:631(__init__)
     1410    1.347    0.001    1.347    0.001 {built-in method posix.read}
    14711    0.287    0.000    1.160    0.000 configparser.py:1341(__init__)
117161/102451    0.087    0.000    1.125    0.000 config.py:596(read)
       23    0.531    0.023    1.099    0.048 {method &#39;control&#39; of &#39;select.kqueue&#39; objects}
 15051549    0.961    0.000    0.961    0.000 {method &#39;append&#39; of &#39;list&#39; objects}
      963    0.007    0.000    0.947    0.001 ChangeCounter.ipynb:121(update_stats)
     1910    0.001    0.000    0.909    0.000 commit.py:214(content)
     1910    0.008    0.000    0.908    0.000 commit.py:222(_get_undecoded_content)
   116841    0.504    0.000    0.880    0.000 symbolic.py:172(_check_ref_name_valid)
     1895    0.001    0.000    0.791    0.000 base.py:192(data_stream)
     1355    0.744    0.001    0.744    0.001 {method &#39;join&#39; of &#39;bytes&#39; objects}
    14711    0.337    0.000    0.681    0.000 config.py:439(_read)
    76328    0.084    0.000    0.613    0.000 cmd.py:451(read)
    14711    0.579    0.000    0.579    0.000 {built-in method builtins.dir}
   152655    0.518    0.000    0.518    0.000 {method &#39;read&#39; of &#39;_io.BufferedReader&#39; objects}
    60315    0.026    0.000    0.517    0.000 base.py:137(read)
   134748    0.038    0.000    0.488    0.000 cmd.py:1663(_get_persistent_cmd)
    15521    0.004    0.000    0.487    0.000 ChangeCounter.ipynb:112(include)
    37861    0.061    0.000    0.485    0.000 commit.py:276(new_path)
    15521    0.013    0.000    0.482    0.000 ChangeCounter.ipynb:176(filter)
    16013    0.142    0.000    0.480    0.000 commit.py:782(_deserialize)
   117049    0.382    0.000    0.466    0.000 {method &#39;read&#39; of &#39;_io.TextIOWrapper&#39; objects}
   554990    0.227    0.000    0.401    0.000 compat.py:117(safe_decode)
  2120178    0.381    0.000    0.381    0.000 {method &#39;match&#39; of &#39;re.Pattern&#39; objects}
    16929    0.008    0.000    0.372    0.000 commit.py:634(committer_date)
   903101    0.369    0.000    0.369    0.000 cmd.py:989(__getattribute__)
    16929    0.009    0.000    0.353    0.000 commit.py:254(committed_datetime)
   158295    0.197    0.000    0.316    0.000 &lt;frozen posixpath&gt;:72(join)
    37479    0.063    0.000    0.309    0.000 _local.py:227(__str__)
   134748    0.301    0.000    0.301    0.000 {method &#39;flush&#39; of &#39;_io.BufferedWriter&#39; objects}
     2816    0.024    0.000    0.289    0.000 repository.py:245(_iter_commits)
     1410    0.042    0.000    0.281    0.000 &lt;frozen os&gt;:750(copy)
   194208    0.223    0.000    0.274    0.000 base.py:100(__init__)
    58525    0.072    0.000    0.270    0.000 configparser.py:796(get)
  1115675    0.208    0.000    0.259    0.000 {built-in method builtins.getattr}
   826398    0.157    0.000    0.246    0.000 cmd.py:378(__getattr__)
   118314    0.072    0.000    0.243    0.000 base.py:231(__init__)
   134748    0.160    0.000    0.238    0.000 cmd.py:1618(_parse_object_header)
    58420    0.128    0.000    0.228    0.000 util.py:111(get_object_type_by_name)
  1263240    0.226    0.000    0.226    0.000 {method &#39;decode&#39; of &#39;bytes&#39; objects}
    29608    0.139    0.000    0.216    0.000 util.py:91(mode_str_to_int)
   134748    0.120    0.000    0.216    0.000 cmd.py:1649(_prepare_ref)
2209202/2209198    0.202    0.000    0.209    0.000 {built-in method builtins.isinstance}
    37480    0.037    0.000    0.199    0.000 _local.py:289(drive)
   131764    0.199    0.000    0.199    0.000 {method &#39;__exit__&#39; of &#39;_io._IOBase&#39; objects}
    32026    0.054    0.000    0.195    0.000 util.py:326(parse_actor_and_date)
     1410    0.064    0.000    0.194    0.000 subprocess.py:1298(_close_pipe_fds)
    59828    0.042    0.000    0.188    0.000 tree.py:194(__init__)
   118196    0.078    0.000    0.184    0.000 {built-in method builtins.any}
  2336808    0.176    0.000    0.176    0.000 {built-in method builtins.ord}
    14711    0.067    0.000    0.171    0.000 configparser.py:1264(__init__)
    75894    0.052    0.000    0.155    0.000 commit.py:109(__init__)
   238290    0.087    0.000    0.154    0.000 &lt;frozen os&gt;:843(fsencode)
    16929    0.019    0.000    0.144    0.000 util.py:211(from_timestamp)
   103035    0.059    0.000    0.144    0.000 &lt;frozen os&gt;:711(__getitem__)
    37478    0.064    0.000    0.143    0.000 _local.py:257(_parse_path)
     2714    0.043    0.000    0.143    0.000 threading.py:955(start)
     1410    0.065    0.000    0.125    0.000 util.py:537(remove_password_if_present)
     2714    0.009    0.000    0.123    0.000 ipkernel.py:774(init_closure)
   102339    0.095    0.000    0.121    0.000 util.py:272(join_path)
    29210    0.021    0.000    0.115    0.000 base.py:435(index)
     2714    0.056    0.000    0.113    0.000 threading.py:869(__init__)
    58525    0.058    0.000    0.110    0.000 configparser.py:1176(_unify_values)
   350522    0.076    0.000    0.105    0.000 symbolic.py:214(&lt;genexpr&gt;)
   392024    0.104    0.000    0.104    0.000 {method &#39;split&#39; of &#39;str&#39; objects}
   919511    0.097    0.000    0.097    0.000 {built-in method builtins.len}
   104340    0.019    0.000    0.093    0.000 &lt;frozen _collections_abc&gt;:873(__iter__)
    29210    0.014    0.000    0.093    0.000 base.py:140(__init__)
     1410    0.015    0.000    0.092    0.000 subprocess.py:1704(_get_handles)
     4230    0.043    0.000    0.092    0.000 contextlib.py:534(callback)
   117049    0.059    0.000    0.084    0.000 &lt;frozen codecs&gt;:322(decode)
   146306    0.065    0.000    0.084    0.000 config.py:218(__getitem__)
    31042    0.015    0.000    0.083    0.000 diff.py:570(_pick_best_path)
    29210    0.021    0.000    0.082    0.000 base.py:123(__init__)
    14714    0.012    0.000    0.079    0.000 config.py:543(_has_includes)
    29210    0.014    0.000    0.079    0.000 base.py:172(_index_path)
    58525    0.046    0.000    0.077    0.000 __init__.py:1013(__getitem__)
     2714    0.077    0.000    0.077    0.000 {built-in method _thread.start_joinable_thread}
   476205    0.077    0.000    0.077    0.000 {method &#39;encode&#39; of &#39;str&#39; objects}
   104340    0.042    0.000    0.075    0.000 &lt;frozen os&gt;:734(__iter__)
   116841    0.059    0.000    0.071    0.000 symbolic.py:51(_git_dir)
    93746    0.069    0.000    0.069    0.000 {method &#39;search&#39; of &#39;re.Pattern&#39; objects}
   574473    0.069    0.000    0.069    0.000 {method &#39;endswith&#39; of &#39;str&#39; objects}
    31042    0.041    0.000    0.069    0.000 diff.py:105(decode_path)
    37583    0.021    0.000    0.069    0.000 _local.py:498(__init__)
     2714    0.028    0.000    0.068    0.000 threading.py:641(wait)
    26790    0.011    0.000    0.068    0.000 subprocess.py:1897(&lt;genexpr&gt;)
   205860    0.035    0.000    0.066    0.000 &lt;frozen os&gt;:797(decode)
    14710    0.017    0.000    0.065    0.000 config.py:546(_included_paths)
    29314    0.023    0.000    0.065    0.000 util.py:309(join_path_native)
   177654    0.065    0.000    0.065    0.000 typing.py:426(inner)
    43816    0.026    0.000    0.062    0.000 base.py:448(head)
      104    0.000    0.000    0.060    0.001 util.py:171(wrapper)
      105    0.004    0.000    0.060    0.001 base.py:172(__init__)
      104    0.001    0.000    0.060    0.001 base.py:1414(module)
    58425    0.042    0.000    0.058    0.000 &lt;frozen importlib._bootstrap&gt;:1390(_handle_fromlist)
   166827    0.058    0.000    0.058    0.000 {method &#39;split&#39; of &#39;bytes&#39; objects}
    32026    0.028    0.000    0.057    0.000 util.py:816(_from_string)
    16929    0.052    0.000    0.056    0.000 {built-in method fromtimestamp}
   117049    0.045    0.000    0.056    0.000 &lt;frozen codecs&gt;:312(__init__)
     1356    0.016    0.000    0.055    0.000 util.py:508(finalize_process)
   134460    0.055    0.000    0.055    0.000 {built-in method sys.intern}
   103524    0.055    0.000    0.055    0.000 config.py:205(__setitem__)
   634015    0.053    0.000    0.053    0.000 {built-in method posix.fspath}
   161531    0.033    0.000    0.053    0.000 &lt;frozen posixpath&gt;:42(_get_sep)
   103035    0.030    0.000    0.051    0.000 &lt;frozen os&gt;:793(encode)
   338507    0.051    0.000    0.051    0.000 {method &#39;startswith&#39; of &#39;str&#39; objects}
     1356    0.003    0.000    0.051    0.000 subprocess.py:1148(_get_devnull)
     1410    0.018    0.000    0.051    0.000 &lt;frozen os&gt;:656(get_exec_path)
   255931    0.049    0.000    0.049    0.000 {built-in method binascii.a2b_hex}
    16929    0.044    0.000    0.049    0.000 {method &#39;astimezone&#39; of &#39;datetime.datetime&#39; objects}
    76328    0.031    0.000    0.048    0.000 base.py:128(__new__)
    37583    0.030    0.000    0.048    0.000 _local.py:117(__init__)
     1356    0.048    0.000    0.048    0.000 {built-in method posix.open}
   313952    0.046    0.000    0.046    0.000 {method &#39;strip&#39; of &#39;str&#39; objects}
     2711    0.019    0.000    0.044    0.000 cmd.py:382(wait)
    29210    0.033    0.000    0.044    0.000 symbolic.py:603(to_full_path)
     1409    0.010    0.000    0.044    0.000 _base.py:612(result_iterator)
   162833    0.043    0.000    0.043    0.000 {method &#39;group&#39; of &#39;re.Match&#39; objects}
     4109    0.008    0.000    0.041    0.000 threading.py:327(wait)
   188323    0.041    0.000    0.041    0.000 {built-in method __new__ of type object at 0x1036cbcf0}
    37478    0.021    0.000    0.041    0.000 _local.py:237(_format_parsed_parts)
    58421    0.025    0.000    0.041    0.000 &lt;frozen importlib._bootstrap&gt;:645(parent)
    29210    0.025    0.000    0.040    0.000 configparser.py:908(has_option)
   134880    0.040    0.000    0.040    0.000 {method &#39;write&#39; of &#39;_io.BufferedWriter&#39; objects}
    58420    0.025    0.000    0.039    0.000 base.py:35(__new__)
    32026    0.032    0.000    0.039    0.000 util.py:146(utctz_to_altz)
       52    0.000    0.000    0.038    0.001 base.py:1437(module_exists)
    15521    0.015    0.000    0.036    0.000 commit.py:596(committer)
     1409    0.000    0.000    0.036    0.000 git.py:110(get_list_commits)
    43817    0.031    0.000    0.036    0.000 head.py:50(__init__)
    90150    0.022    0.000    0.035    0.000 diff.py:535(b_path)
     1387    0.027    0.000    0.034    0.000 parse.py:469(urlsplit)
   105104    0.034    0.000    0.034    0.000 typing.py:1944(_no_init_or_replace_init)
     1408    0.014    0.000    0.033    0.000 _base.py:314(_result_or_cancel)
    73609    0.032    0.000    0.032    0.000 {built-in method builtins.setattr}
19172/16448    0.033    0.000    0.032    0.000 {method &#39;acquire&#39; of &#39;_thread.lock&#39; objects}
     4230    0.032    0.000    0.032    0.000 contextlib.py:479(_create_cb_wrapper)
     1360    0.007    0.000    0.031    0.000 cmd.py:375(__del__)
   176931    0.031    0.000    0.031    0.000 {method &#39;rstrip&#39; of &#39;str&#39; objects}
13608/1410    0.015    0.000    0.030    0.000 cmd.py:1494(_unpack_args)
   147700    0.029    0.000    0.029    0.000 {method &#39;startswith&#39; of &#39;bytes&#39; objects}
   140433    0.029    0.000    0.029    0.000 {built-in method binascii.b2a_hex}
     2713    0.007    0.000    0.028    0.000 subprocess.py:1275(wait)
     2714    0.005    0.000    0.028    0.000 threading.py:620(set)
   146751    0.028    0.000    0.028    0.000 {built-in method builtins.hasattr}
     1410    0.017    0.000    0.026    0.000 contextlib.py:571(__exit__)
    29315    0.020    0.000    0.026    0.000 configparser.py:683(sections)
    59674    0.025    0.000    0.025    0.000 config.py:208(add)
   117049    0.025    0.000    0.025    0.000 {built-in method _codecs.utf_8_decode}
    79573    0.024    0.000    0.024    0.000 {method &#39;groups&#39; of &#39;re.Match&#39; objects}
    76328    0.023    0.000    0.023    0.000 base.py:132(__init__)
     1360    0.006    0.000    0.023    0.000 cmd.py:340(_terminate)
     1355    0.023    0.000    0.023    0.000 {method &#39;finditer&#39; of &#39;re.Pattern&#39; objects}
    37583    0.017    0.000    0.023    0.000 _local.py:505(__new__)
    58420    0.022    0.000    0.022    0.000 base.py:60(size)
     2713    0.004    0.000    0.021    0.000 subprocess.py:2034(_wait)
     4122    0.005    0.000    0.021    0.000 threading.py:428(notify_all)
    16929    0.020    0.000    0.020    0.000 util.py:191(__init__)
    88567    0.020    0.000    0.020    0.000 {method &#39;rpartition&#39; of &#39;str&#39; objects}
    37478    0.013    0.000    0.019    0.000 _local.py:277(_raw_path)
     1410    0.018    0.000    0.019    0.000 warnings.py:488(__enter__)
     1409    0.002    0.000    0.019    0.000 commit.py:512(_iter_from_process_or_stream)
   146438    0.018    0.000    0.018    0.000 {function _OMD.__getitem__ at 0x114154cc0}
    29210    0.013    0.000    0.018    0.000 util.py:42(sm_name)
    58420    0.018    0.000    0.018    0.000 base.py:38(__init__)
     4230    0.014    0.000    0.018    0.000 contextlib.py:552(_push_exit_callback)
     1408    0.013    0.000    0.017    0.000 commit.py:801(_parse_diff)
    25413    0.012    0.000    0.017    0.000 conf.py:52(get)
     1408    0.008    0.000    0.016    0.000 _base.py:428(result)
     7050    0.016    0.000    0.016    0.000 {built-in method posix.close}
   211200    0.016    0.000    0.016    0.000 typing.py:2371(cast)
     1358    0.003    0.000    0.015    0.000 subprocess.py:2021(_try_wait)
     2714    0.008    0.000    0.015    0.000 threading.py:592(__init__)
    29210    0.010    0.000    0.015    0.000 base.py:168(__ne__)
    30146    0.011    0.000    0.015    0.000 parse.py:193(_userinfo)
    15073    0.005    0.000    0.015    0.000 parse.py:160(password)
    89488    0.015    0.000    0.015    0.000 {method &#39;lower&#39; of &#39;str&#39; objects}
     4140    0.005    0.000    0.014    0.000 threading.py:398(notify)
    29634    0.014    0.000    0.014    0.000 {method &#39;sub&#39; of &#39;re.Pattern&#39; objects}
    58525    0.014    0.000    0.014    0.000 __init__.py:1003(__init__)
  418/210    0.001    0.000    0.013    0.000 fun.py:99(find_submodule_git_dir)
     1408    0.002    0.000    0.013    0.000 thread.py:165(submit)
     2714    0.009    0.000    0.013    0.000 _weakrefset.py:85(add)
    76328    0.013    0.000    0.013    0.000 cmd.py:440(__init__)
   147410    0.013    0.000    0.013    0.000 config.py:435(optionxform)
     4284    0.013    0.000    0.013    0.000 {built-in method posix.pipe}
12486/11070    0.008    0.000    0.013    0.000 threading.py:303(__enter__)
    80789    0.013    0.000    0.013    0.000 {method &#39;readline&#39; of &#39;_io.BytesIO&#39; objects}
    37369    0.010    0.000    0.013    0.000 &lt;frozen posixpath&gt;:131(splitdrive)
     1362    0.013    0.000    0.013    0.000 {built-in method posix.waitpid}
    76328    0.012    0.000    0.012    0.000 cmd.py:527(__del__)
    14605    0.009    0.000    0.012    0.000 util.py:1177(__new__)
     1409    0.004    0.000    0.012    0.000 __init__.py:1512(info)
    58525    0.012    0.000    0.012    0.000 base.py:379(common_dir)
     2822    0.002    0.000    0.012    0.000 {built-in method builtins.next}
     2714    0.012    0.000    0.012    0.000 threading.py:1267(_make_invoke_excepthook)
   117049    0.011    0.000    0.011    0.000 &lt;frozen codecs&gt;:263(__init__)
      105    0.000    0.000    0.011    0.000 base.py:658(config_reader)
     3132    0.004    0.000    0.011    0.000 __init__.py:1772(isEnabledFor)
      105    0.000    0.000    0.011    0.000 base.py:681(_config_reader)
        1    0.000    0.000    0.011    0.011 _base.py:583(map)
     2732    0.010    0.000    0.011    0.000 threading.py:1136(is_alive)
     1411    0.006    0.000    0.010    0.000 contextlib.py:303(helper)
     5428    0.008    0.000    0.010    0.000 threading.py:1429(current_thread)
     4123    0.007    0.000    0.010    0.000 threading.py:281(__init__)
    16929    0.008    0.000    0.010    0.000 mailmap.py:16(get_developer)
    37478    0.010    0.000    0.010    0.000 {built-in method posix._path_splitroot_ex}
        2    0.000    0.000    0.010    0.005 repository.py:179(_prep_repo)
     1410    0.009    0.000    0.009    0.000 contextlib.py:485(__init__)
     1410    0.002    0.000    0.009    0.000 warnings.py:170(simplefilter)
     1411    0.002    0.000    0.009    0.000 contextlib.py:145(__exit__)
     2714    0.007    0.000    0.009    0.000 threading.py:1049(_delete)
    58420    0.009    0.000    0.009    0.000 base.py:52(type)
    15073    0.003    0.000    0.009    0.000 parse.py:156(username)
    14605    0.005    0.000    0.008    0.000 base.py:162(__eq__)
     2710    0.008    0.000    0.008    0.000 threading.py:843(_newname)
    15521    0.005    0.000    0.008    0.000 commit.py:661(msg)
        1    0.000    0.000    0.008    0.008 base.py:756(iter_commits)
        1    0.000    0.000    0.008    0.008 commit.py:299(iter_items)
    14356    0.005    0.000    0.008    0.000 diff.py:531(a_path)
     1408    0.001    0.000    0.007    0.000 thread.py:184(_adjust_thread_count)
    37479    0.007    0.000    0.007    0.000 {method &#39;join&#39; of &#39;str&#39; objects}
    64052    0.007    0.000    0.007    0.000 {built-in method builtins.abs}
    58420    0.007    0.000    0.007    0.000 base.py:42(binsha)
     3028    0.005    0.000    0.007    0.000 &lt;frozen posixpath&gt;:176(dirname)
    73555    0.007    0.000    0.007    0.000 {built-in method builtins.callable}
     1515    0.001    0.000    0.007    0.000 &lt;frozen abc&gt;:117(__instancecheck__)
      523    0.001    0.000    0.007    0.000 fun.py:57(is_git_dir)
     6827    0.007    0.000    0.007    0.000 {method &#39;release&#39; of &#39;_thread.lock&#39; objects}
     3132    0.003    0.000    0.007    0.000 __init__.py:1826(_is_disabled)
     1410    0.007    0.000    0.007    0.000 {built-in method posix.access}
    12824    0.007    0.000    0.007    0.000 cmd.py:567(__getattribute)
     1410    0.004    0.000    0.007    0.000 warnings.py:188(_add_filter)
     1408    0.002    0.000    0.007    0.000 threading.py:472(acquire)
    14711    0.004    0.000    0.006    0.000 configparser.py:1383(__iter__)
      963    0.006    0.000    0.006    0.000 ChangeCounter.ipynb:137(update_size)
    12486    0.005    0.000    0.006    0.000 threading.py:306(__exit__)
     1515    0.006    0.000    0.006    0.000 {built-in method _abc._abc_instancecheck}
        2    0.000    0.000    0.006    0.003 git.py:77(clear)
        2    0.000    0.000    0.006    0.003 cmd.py:1727(clear_cache)
     1411    0.002    0.000    0.006    0.000 contextlib.py:136(__enter__)
     1408    0.001    0.000    0.006    0.000 thread.py:54(run)
    29315    0.006    0.000    0.006    0.000 {method &#39;keys&#39; of &#39;collections.OrderedDict&#39; objects}
      963    0.004    0.000    0.006    0.000 ChangeCounter.ipynb:145(update_changes)
    58525    0.005    0.000    0.005    0.000 configparser.py:383(before_get)
     5685    0.003    0.000    0.005    0.000 base.py:186(hexsha)
     4230    0.002    0.000    0.005    0.000 contextlib.py:481(_exit_wrapper)
    67716    0.005    0.000    0.005    0.000 util.py:204(dst)
    43817    0.005    0.000    0.005    0.000 symbolic.py:76(__init__)
    29418    0.005    0.000    0.005    0.000 base.py:370(working_tree_dir)
    26825    0.005    0.000    0.005    0.000 {method &#39;get&#39; of &#39;dict&#39; objects}
    16129    0.005    0.000    0.005    0.000 {method &#39;pop&#39; of &#39;list&#39; objects}
      105    0.000    0.000    0.005    0.000 _local.py:539(read_text)
    29314    0.005    0.000    0.005    0.000 util.py:303(to_native_path_linux)
     6841    0.003    0.000    0.005    0.000 threading.py:318(_is_owned)
    16013    0.005    0.000    0.005    0.000 {method &#39;read&#39; of &#39;_io.BytesIO&#39; objects}
    52195    0.004    0.000    0.004    0.000 util.py:198(utcoffset)
      105    0.000    0.000    0.004    0.000 _abc.py:628(read_text)
    17480    0.004    0.000    0.004    0.000 {method &#39;strip&#39; of &#39;bytes&#39; objects}
     2714    0.003    0.000    0.004    0.000 _weakrefset.py:39(_remove)
     4128    0.004    0.000    0.004    0.000 {method &#39;add&#39; of &#39;set&#39; objects}
     8363    0.004    0.000    0.004    0.000 {method &#39;append&#39; of &#39;collections.deque&#39; objects}
      105    0.000    0.000    0.004    0.000 _local.py:529(open)
     1411    0.002    0.000    0.004    0.000 contextlib.py:108(__init__)
     1470    0.004    0.000    0.004    0.000 {built-in method posix.stat}
     1408    0.002    0.000    0.004    0.000 conf.py:272(is_commit_filtered)
    15521    0.004    0.000    0.004    0.000 {method &#39;end&#39; of &#39;re.Match&#39; objects}
    32026    0.004    0.000    0.004    0.000 util.py:797(__init__)
     1408    0.001    0.000    0.004    0.000 commit.py:569(author)
     5632    0.004    0.000    0.004    0.000 {method &#39;__enter__&#39; of &#39;_thread.RLock&#39; objects}
        1    0.000    0.000    0.004    0.004 git.py:39(__init__)
     1387    0.003    0.000    0.004    0.000 parse.py:119(_coerce_args)
        1    0.000    0.000    0.003    0.003 git.py:86(_open_repository)
     1408    0.001    0.000    0.003    0.000 _base.py:328(__init__)
    13570    0.003    0.000    0.003    0.000 {built-in method _thread.get_ident}
     1048    0.001    0.000    0.003    0.000 &lt;frozen genericpath&gt;:48(isdir)
     1408    0.002    0.000    0.003    0.000 commit.py:560(hash)
      107    0.000    0.000    0.003    0.000 _local.py:166(__fspath__)
     1408    0.001    0.000    0.003    0.000 _base.py:537(set_result)
    37479    0.003    0.000    0.003    0.000 _local.py:307(_tail)
     2710    0.002    0.000    0.003    0.000 threading.py:1162(daemon)
    14711    0.002    0.000    0.003    0.000 config.py:378(_acquire_lock)
     1723    0.001    0.000    0.003    0.000 __init__.py:1500(debug)
    14166    0.003    0.000    0.003    0.000 {method &#39;start&#39; of &#39;re.Match&#39; objects}
     1461    0.001    0.000    0.003    0.000 commit.py:670(parents)
    37480    0.003    0.000    0.003    0.000 _local.py:298(root)
     2710    0.001    0.000    0.003    0.000 base.py:178(__str__)
    25380    0.003    0.000    0.003    0.000 {method &#39;endswith&#39; of &#39;bytes&#39; objects}
     1408    0.001    0.000    0.003    0.000 _base.py:364(cancel)
    14605    0.003    0.000    0.003    0.000 fun.py:219(to_commit)
    13774    0.003    0.000    0.003    0.000 {method &#39;__exit__&#39; of &#39;_thread.RLock&#39; objects}
     2711    0.002    0.000    0.003    0.000 encoding.py:1(force_bytes)
       24    0.000    0.000    0.003    0.000 events.py:87(_run)
     9875    0.002    0.000    0.002    0.000 {method &#39;replace&#39; of &#39;str&#39; objects}
     1410    0.002    0.000    0.002    0.000 {method &#39;remove&#39; of &#39;list&#39; objects}
    15521    0.002    0.000    0.002    0.000 commit.py:155(__init__)
       24    0.000    0.000    0.002    0.000 {method &#39;run&#39; of &#39;_contextvars.Context&#39; objects}
     1410    0.002    0.000    0.002    0.000 &lt;frozen _collections_abc&gt;:823(keys)
     1410    0.002    0.000    0.002    0.000 {built-in method sys.exception}
    14605    0.002    0.000    0.002    0.000 util.py:1180(__init__)
     4109    0.001    0.000    0.002    0.000 threading.py:315(_acquire_restore)
     2716    0.002    0.000    0.002    0.000 subprocess.py:1249(poll)
    14711    0.002    0.000    0.002    0.000 {built-in method builtins.iter}
     4109    0.001    0.000    0.002    0.000 threading.py:312(_release_save)
     1410    0.002    0.000    0.002    0.000 {built-in method builtins.sorted}
    14711    0.002    0.000    0.002    0.000 configparser.py:1224(converters)
     4230    0.002    0.000    0.002    0.000 {method &#39;pop&#39; of &#39;collections.deque&#39; objects}
     2711    0.001    0.000    0.002    0.000 cmd.py:994(__getattr__)
     2714    0.001    0.000    0.002    0.000 threading.py:1020(_set_ident)
     1358    0.001    0.000    0.002    0.000 subprocess.py:1978(_handle_exitstatus)
      315    0.001    0.000    0.002    0.000 util.py:525(expand_path)
6854/6382    0.002    0.000    0.002    0.000 {method &#39;__enter__&#39; of &#39;_thread.lock&#39; objects}
     5428    0.002    0.000    0.002    0.000 threading.py:1147(daemon)
    14709    0.002    0.000    0.002    0.000 base.py:388(bare)
    16929    0.002    0.000    0.002    0.000 developer.py:27(__init__)
      313    0.000    0.000    0.002    0.000 cmd.py:891(is_cygwin)
     1466    0.001    0.000    0.002    0.000 cmd.py:299(dashify)
     1410    0.002    0.000    0.002    0.000 contextlib.py:568(__enter__)
     1408    0.001    0.000    0.001    0.000 _base.py:497(set_running_or_notify_cancel)
      105    0.000    0.000    0.001    0.000 configparser.py:857(getboolean)
     2714    0.001    0.000    0.001    0.000 {method &#39;discard&#39; of &#39;set&#39; objects}
    11042    0.001    0.000    0.001    0.000 {method &#39;__exit__&#39; of &#39;_thread.lock&#39; objects}
      313    0.001    0.000    0.001    0.000 util.py:492(is_cygwin_git)
     1358    0.001    0.000    0.001    0.000 subprocess.py:1133(__del__)
     2714    0.001    0.000    0.001    0.000 threading.py:1024(_set_native_id)
     5475    0.001    0.000    0.001    0.000 {method &#39;insert&#39; of &#39;list&#39; objects}
      105    0.000    0.000    0.001    0.000 configparser.py:836(_get_conv)
     1410    0.001    0.000    0.001    0.000 warnings.py:509(__exit__)
     4109    0.001    0.000    0.001    0.000 {method &#39;remove&#39; of &#39;collections.deque&#39; objects}
    10870    0.001    0.000    0.001    0.000 threading.py:605(is_set)
      105    0.000    0.000    0.001    0.000 configparser.py:833(_get)
       11    0.000    0.000    0.001    0.000 iostream.py:118(_run_event_pipe_gc)
     5652    0.001    0.000    0.001    0.000 {method &#39;items&#39; of &#39;dict&#39; objects}
     1410    0.001    0.000    0.001    0.000 cmd.py:1483(transform_kwargs)
      105    0.000    0.000    0.001    0.000 __init__.py:174(search)
      105    0.000    0.000    0.001    0.000 &lt;frozen genericpath&gt;:16(exists)
     1387    0.001    0.000    0.001    0.000 &lt;string&gt;:1(&lt;lambda&gt;)
        3    0.000    0.000    0.001    0.000 config.py:717(write)
     5420    0.001    0.000    0.001    0.000 diff.py:235(&lt;genexpr&gt;)
      105    0.000    0.000    0.001    0.000 db.py:34(__init__)
     5428    0.001    0.000    0.001    0.000 threading.py:1112(ident)
        1    0.000    0.000    0.001    0.001 base.py:696(config_writer)
      105    0.001    0.000    0.001    0.000 __init__.py:330(_compile)
      317    0.000    0.000    0.001    0.000 &lt;frozen genericpath&gt;:36(isfile)
     1387    0.001    0.000    0.001    0.000 {method &#39;find&#39; of &#39;str&#39; objects}
      2/1    0.000    0.000    0.001    0.001 config.py:127(flush_changes)
     4230    0.001    0.000    0.001    0.000 {built-in method _warnings._filters_mutated}
        4    0.000    0.000    0.001    0.000 util.py:1058(_obtain_lock)
        4    0.000    0.000    0.001    0.000 util.py:1034(_obtain_lock_or_raise)
        2    0.000    0.000    0.001    0.000 zmqstream.py:573(_handle_events)
      105    0.000    0.000    0.001    0.000 _local.py:148(__truediv__)
     1410    0.001    0.000    0.001    0.000 subprocess.py:274(_cleanup)
     4109    0.001    0.000    0.001    0.000 {built-in method _thread.allocate_lock}
      105    0.000    0.000    0.001    0.000 cmd.py:964(__init__)
     1410    0.001    0.000    0.001    0.000 {method &#39;rfind&#39; of &#39;bytes&#39; objects}
     1408    0.000    0.000    0.001    0.000 git.py:140(get_commit_from_gitpython)
        1    0.000    0.000    0.001    0.001 asyncio.py:206(_handle_events)
     4074    0.001    0.000    0.001    0.000 subprocess.py:1987(_internal_poll)
     1410    0.001    0.000    0.001    0.000 cmd.py:335(__init__)
        2    0.000    0.000    0.001    0.000 zmqstream.py:614(_handle_recv)
     1049    0.001    0.000    0.001    0.000 {built-in method posix._path_normpath}
       22    0.000    0.000    0.001    0.000 tasks.py:703(sleep)
        1    0.000    0.000    0.001    0.001 config.py:873(set_value)
     2710    0.001    0.000    0.001    0.000 {built-in method _thread.daemon_threads_allowed}
     1410    0.001    0.000    0.001    0.000 warnings.py:462(__init__)
      105    0.000    0.000    0.001    0.000 loose.py:77(__init__)
        2    0.000    0.000    0.001    0.000 zmqstream.py:546(_run_callback)
     1618    0.000    0.000    0.000    0.000 {method &#39;rfind&#39; of &#39;str&#39; objects}
      315    0.000    0.000    0.000    0.000 &lt;frozen posixpath&gt;:376(abspath)
      107    0.000    0.000    0.000    0.000 _abc.py:130(with_segments)
      105    0.000    0.000    0.000    0.000 &lt;frozen _collections_abc&gt;:815(__contains__)
     1464    0.000    0.000    0.000    0.000 {method &#39;update&#39; of &#39;dict&#39; objects}
     2732    0.000    0.000    0.000    0.000 {method &#39;is_done&#39; of &#39;_thread._ThreadHandle&#39; objects}
      104    0.000    0.000    0.000    0.000 base.py:288(abspath)
        2    0.000    0.000    0.000    0.000 iostream.py:157(_handle_event)
     2714    0.000    0.000    0.000    0.000 {built-in method _thread.get_native_id}
     1408    0.000    0.000    0.000    0.000 threading.py:122(RLock)
        2    0.000    0.000    0.000    0.000 iostream.py:276(&lt;lambda&gt;)
     1408    0.000    0.000    0.000    0.000 _base.py:398(__get_result)
     1387    0.000    0.000    0.000    0.000 {method &#39;lstrip&#39; of &#39;str&#39; objects}
     1515    0.000    0.000    0.000    0.000 {method &#39;pop&#39; of &#39;dict&#39; objects}
     1410    0.000    0.000    0.000    0.000 {built-in method sys.audit}
       11    0.000    0.000    0.000    0.000 futures.py:310(_set_result_unless_cancelled)
     1358    0.000    0.000    0.000    0.000 {built-in method posix.WIFSTOPPED}
     2820    0.000    0.000    0.000    0.000 subprocess.py:1327(_on_error_fd_closer)
        3    0.000    0.000    0.000    0.000 config.py:671(_write)
      106    0.000    0.000    0.000    0.000 base.py:631(_get_config_path)
       11    0.000    0.000    0.000    0.000 {method &#39;set_result&#39; of &#39;_asyncio.Future&#39; objects}
       11    0.000    0.000    0.000    0.000 iostream.py:127(_event_pipe_gc)
       45    0.000    0.000    0.000    0.000 config.py:675(write_section)
      315    0.000    0.000    0.000    0.000 &lt;frozen posixpath&gt;:229(expanduser)
     1387    0.000    0.000    0.000    0.000 parse.py:421(_checknetloc)
     2837    0.000    0.000    0.000    0.000 {built-in method time.monotonic}
       12    0.000    0.000    0.000    0.000 base_events.py:823(call_soon)
     1358    0.000    0.000    0.000    0.000 {built-in method posix.waitstatus_to_exitcode}
      208    0.000    0.000    0.000    0.000 &lt;frozen posixpath&gt;:61(isabs)
     1413    0.000    0.000    0.000    0.000 {method &#39;put&#39; of &#39;_queue.SimpleQueue&#39; objects}
        1    0.000    0.000    0.000    0.000 config.py:410(release)
      105    0.000    0.000    0.000    0.000 base.py:113(__init__)
      315    0.000    0.000    0.000    0.000 &lt;frozen posixpath&gt;:290(expandvars)
       12    0.000    0.000    0.000    0.000 base_events.py:852(_call_soon)
     1410    0.000    0.000    0.000    0.000 &lt;frozen _collections_abc&gt;:850(__init__)
      104    0.000    0.000    0.000    0.000 base.py:351(__ne__)
       58    0.000    0.000    0.000    0.000 cmd.py:1467(transform_kwarg)
     1355    0.000    0.000    0.000    0.000 diff.py:172(_process_diff_args)
      105    0.000    0.000    0.000    0.000 configparser.py:1196(_convert_to_boolean)
       11    0.000    0.000    0.000    0.000 base_events.py:781(call_later)
     1412    0.000    0.000    0.000    0.000 {method &#39;get_nowait&#39; of &#39;_queue.SimpleQueue&#39; objects}
        1    0.000    0.000    0.000    0.000 {method &#39;disable&#39; of &#39;_lsprof.Profiler&#39; objects}
        1    0.000    0.000    0.000    0.000 git.py:92(_discover_main_branch)
      102    0.000    0.000    0.000    0.000 {built-in method posix.getppid}
     1408    0.000    0.000    0.000    0.000 _base.py:337(_invoke_callbacks)
     1387    0.000    0.000    0.000    0.000 parse.py:108(_noop)
     1408    0.000    0.000    0.000    0.000 thread.py:48(__init__)
        1    0.000    0.000    0.000    0.000 base.py:1043(active_branch)
      943    0.000    0.000    0.000    0.000 {built-in method _stat.S_ISDIR}
      963    0.000    0.000    0.000    0.000 ChangeCounter.ipynb:155(update_elems)
        2    0.000    0.000    0.000    0.000 iostream.py:278(_really_send)
     1408    0.000    0.000    0.000    0.000 commit.py:536(__init__)
       47    0.000    0.000    0.000    0.000 base_events.py:772(time)
        1    0.000    0.000    0.000    0.000 symbolic.py:504(reference)
        1    0.000    0.000    0.000    0.000 symbolic.py:407(_get_reference)
        2    0.000    0.000    0.000    0.000 socket.py:700(send_multipart)
       23    0.000    0.000    0.000    0.000 events.py:36(__init__)
       11    0.000    0.000    0.000    0.000 base_events.py:805(call_at)
       11    0.000    0.000    0.000    0.000 base_events.py:457(create_future)
        4    0.000    0.000    0.000    0.000 attrsettr.py:43(__getattr__)
       11    0.000    0.000    0.000    0.000 events.py:157(cancel)
     1408    0.000    0.000    0.000    0.000 {method &#39;_is_owned&#39; of &#39;_thread.RLock&#39; objects}
        8    0.000    0.000    0.000    0.000 {built-in method posix.lstat}
        4    0.000    0.000    0.000    0.000 attrsettr.py:66(_get_attr_opt)
       45    0.000    0.000    0.000    0.000 config.py:242(items_all)
       88    0.000    0.000    0.000    0.000 config.py:868(_value_to_string)
        2    0.000    0.000    0.000    0.000 zmqstream.py:653(_rebuild_io_state)
    18/14    0.000    0.000    0.000    0.000 threading.py:519(release)
        1    0.000    0.000    0.000    0.000 ioloop.py:750(_run_callback)
        1    0.000    0.000    0.000    0.000 zmqstream.py:684(&lt;lambda&gt;)
        2    0.000    0.000    0.000    0.000 _local.py:664(resolve)
       14    0.000    0.000    0.000    0.000 socket.py:623(send)
        1    0.000    0.000    0.000    0.000 util.py:1065(_release_lock)
       11    0.000    0.000    0.000    0.000 events.py:113(__init__)
        1    0.000    0.000    0.000    0.000 util.py:245(rmfile)
        1    0.000    0.000    0.000    0.000 conf.py:85(sanity_check_filters)
        2    0.000    0.000    0.000    0.000 zmqstream.py:676(_update_handler)
      104    0.000    0.000    0.000    0.000 base.py:346(__eq__)
        1    0.000    0.000    0.000    0.000 {built-in method posix.remove}
      132    0.000    0.000    0.000    0.000 config.py:235(getall)
        2    0.000    0.000    0.000    0.000 &lt;frozen posixpath&gt;:391(realpath)
        1    0.000    0.000    0.000    0.000 symbolic.py:886(from_path)
       14    0.000    0.000    0.000    0.000 enum.py:1596(__or__)
       11    0.000    0.000    0.000    0.000 {built-in method _heapq.heappop}
        1    0.000    0.000    0.000    0.000 repository.py:44(__init__)
      210    0.000    0.000    0.000    0.000 {built-in method _io.text_encoding}
       60    0.000    0.000    0.000    0.000 enum.py:1589(_get_value)
        1    0.000    0.000    0.000    0.000 conf.py:302(_check_timezones)
      211    0.000    0.000    0.000    0.000 {built-in method _stat.S_ISREG}
        3    0.000    0.000    0.000    0.000 config.py:238(items)
        2    0.000    0.000    0.000    0.000 subprocess.py:2224(terminate)
        2    0.000    0.000    0.000    0.000 _local.py:800(expanduser)
        2    0.000    0.000    0.000    0.000 subprocess.py:2192(send_signal)
        1    0.000    0.000    0.000    0.000 conf.py:310(_replace_timezone)
        2    0.000    0.000    0.000    0.000 socket.py:771(recv_multipart)
        1    0.000    0.000    0.000    0.000 thread.py:127(__init__)
       59    0.000    0.000    0.000    0.000 {method &#39;find&#39; of &#39;bytes&#39; objects}
        1    0.000    0.000    0.000    0.000 conf.py:26(__init__)
       88    0.000    0.000    0.000    0.000 encoding.py:11(force_text)
        6    0.000    0.000    0.000    0.000 enum.py:1607(__and__)
       26    0.000    0.000    0.000    0.000 enum.py:695(__call__)
      107    0.000    0.000    0.000    0.000 {built-in method builtins.issubclass}
       59    0.000    0.000    0.000    0.000 {method &#39;rstrip&#39; of &#39;bytes&#39; objects}
        1    0.000    0.000    0.000    0.000 conf.py:202(build_args)
        2    0.000    0.000    0.000    0.000 {built-in method posix.kill}
       11    0.000    0.000    0.000    0.000 {built-in method math.isnan}
        4    0.000    0.000    0.000    0.000 weakref.py:369(remove)
        1    0.000    0.000    0.000    0.000 {method &#39;replace&#39; of &#39;datetime.datetime&#39; objects}
       24    0.000    0.000    0.000    0.000 selector_events.py:740(_process_events)
       11    0.000    0.000    0.000    0.000 events.py:73(cancel)
        1    0.000    0.000    0.000    0.000 conf.py:72(_check_only_one_from_commit)
      105    0.000    0.000    0.000    0.000 base.py:70(__init__)
       26    0.000    0.000    0.000    0.000 enum.py:1156(__new__)
        2    0.000    0.000    0.000    0.000 typing.py:1374(__instancecheck__)
        2    0.000    0.000    0.000    0.000 {method &#39;close&#39; of &#39;_io.BufferedWriter&#39; objects}
        1    0.000    0.000    0.000    0.000 asyncio.py:231(add_callback)
        1    0.000    0.000    0.000    0.000 threading.py:461(__init__)
        2    0.000    0.000    0.000    0.000 typing.py:1665(__subclasscheck__)
        1    0.000    0.000    0.000    0.000 reference.py:54(__init__)
       12    0.000    0.000    0.000    0.000 {built-in method _contextvars.copy_context}
        1    0.000    0.000    0.000    0.000 git.py:343(__del__)
        2    0.000    0.000    0.000    0.000 zmqstream.py:532(sending)
       24    0.000    0.000    0.000    0.000 {built-in method builtins.max}
       26    0.000    0.000    0.000    0.000 {method &#39;popleft&#39; of &#39;collections.deque&#39; objects}
       45    0.000    0.000    0.000    0.000 base_events.py:2060(get_debug)
       11    0.000    0.000    0.000    0.000 {built-in method _heapq.heappush}
        4    0.000    0.000    0.000    0.000 typing.py:1443(__hash__)
        4    0.000    0.000    0.000    0.000 weakref.py:427(__setitem__)
        1    0.000    0.000    0.000    0.000 _local.py:346(name)
        2    0.000    0.000    0.000    0.000 queue.py:115(empty)
        1    0.000    0.000    0.000    0.000 util.py:1013(__init__)
       11    0.000    0.000    0.000    0.000 {method &#39;cancelled&#39; of &#39;_asyncio.Future&#39; objects}
        1    0.000    0.000    0.000    0.000 configparser.py:922(set)
        2    0.000    0.000    0.000    0.000 iostream.py:216(_check_mp_mode)
        2    0.000    0.000    0.000    0.000 repository.py:154(_is_remote)
        2    0.000    0.000    0.000    0.000 &lt;frozen abc&gt;:121(__subclasscheck__)
        2    0.000    0.000    0.000    0.000 iostream.py:213(_is_master_process)
       12    0.000    0.000    0.000    0.000 {built-in method _asyncio.get_running_loop}
        1    0.000    0.000    0.000    0.000 conf.py:79(_check_only_one_to_commit)
       23    0.000    0.000    0.000    0.000 base_events.py:554(_check_closed)
        8    0.000    0.000    0.000    0.000 conf.py:43(set_value)
        1    0.000    0.000    0.000    0.000 __init__.py:230(utcoffset)
        1    0.000    0.000    0.000    0.000 base_events.py:1947(_add_callback)
        1    0.000    0.000    0.000    0.000 reference.py:120(name)
        2    0.000    0.000    0.000    0.000 util.py:1020(_lock_file_path)
        2    0.000    0.000    0.000    0.000 conf.py:192(only_one_filter)
       11    0.000    0.000    0.000    0.000 base_events.py:1957(_timer_handle_cancelled)
        8    0.000    0.000    0.000    0.000 {built-in method _stat.S_ISLNK}
        1    0.000    0.000    0.000    0.000 conf.py:175(get_ending_commit)
        1    0.000    0.000    0.000    0.000 conf.py:61(_sanity_check_repos)
        3    0.000    0.000    0.000    0.000 config.py:763(_assure_writable)
        4    0.000    0.000    0.000    0.000 {method &#39;upper&#39; of &#39;str&#39; objects}
        1    0.000    0.000    0.000    0.000 {method &#39;reverse&#39; of &#39;list&#39; objects}
        1    0.000    0.000    0.000    0.000 conf.py:151(get_starting_commit)
        1    0.000    0.000    0.000    0.000 conf.py:123(_check_correct_filters_order)
        2    0.000    0.000    0.000    0.000 queue.py:267(_qsize)
        2    0.000    0.000    0.000    0.000 {built-in method _abc._abc_subclasscheck}
        1    0.000    0.000    0.000    0.000 {method &#39;isascii&#39; of &#39;str&#39; objects}
        3    0.000    0.000    0.000    0.000 git.py:63(repo)
        6    0.000    0.000    0.000    0.000 util.py:1024(_has_lock)
        4    0.000    0.000    0.000    0.000 zmqstream.py:528(receiving)
        4    0.000    0.000    0.000    0.000 {built-in method builtins.hash}
        2    0.000    0.000    0.000    0.000 iostream.py:255(closed)
        4    0.000    0.000    0.000    0.000 config.py:771(read_only)
        1    0.000    0.000    0.000    0.000 {method &#39;isalpha&#39; of &#39;str&#39; objects}
        1    0.000    0.000    0.000    0.000 configparser.py:702(has_section)
        2    0.000    0.000    0.000    0.000 {built-in method posix.getpid}
        1    0.000    0.000    0.000    0.000 &lt;frozen codecs&gt;:189(__init__)
        1    0.000    0.000    0.000    0.000 configparser.py:386(before_set)
        1    0.000    0.000    0.000    0.000 _base.py:643(__enter__)
</pre></div>
</div>
</div>
</div>
<p>Yes, that’s an awful lot of functions, but we can quickly narrow things down. The <code class="docutils literal notranslate"><span class="pre">cumtime</span></code> column is sorted by largest values first. We see that the <code class="docutils literal notranslate"><span class="pre">debuggingbook_change_counter()</span></code> method at the top takes up all the time – but this is not surprising, since it is the method we called in the first place. This calls a method <code class="docutils literal notranslate"><span class="pre">mine()</span></code> in the <code class="docutils literal notranslate"><span class="pre">ChangeCounter</span></code> class, which does all the work.</p>
<p>The next places are more interesting: almost all time is spent in a single method, named <code class="docutils literal notranslate"><span class="pre">modifications()</span></code>. This method determines the difference between two versions, which is an expensive operation; this is also supported by the observation that half of the time is spent in a <code class="docutils literal notranslate"><span class="pre">diff()</span></code> method.</p>
<p>This profile thus already gets us a hint on how to improve performance: Rather than computing the diff between versions for <em>every</em> version, we could do so <em>on demand</em> (and possibly cache results so we don’t have to compute them twice). Alas, this (slow) functionality is part of the
underlying <a class="reference external" href="https://pydriller.readthedocs.io/">PyDriller</a> Python package, so we cannot fix this within the <code class="docutils literal notranslate"><span class="pre">ChangeCounter</span></code> class. But we could file a bug with the developers, suggesting a patch to improve performance.</p>
</section>
<section id="sampling-execution-profiles">
<h3>Sampling Execution Profiles<a class="headerlink" href="#sampling-execution-profiles" title="Link to this heading">#</a></h3>
<p>Instrumenting code is <em>precise</em>, but it is also <em>slow</em>. An alternate way to measure performance is to <em>sample</em> in regular intervals which functions are currently active – for instance, by examining the current function call stack. The more frequently a function is sampled as active, the more time is spent in that function.</p>
<p>One profiler for Python that implements such sampling is <a class="reference external" href="https://github.com/plasma-umass/scalene">Scalene</a> – a high-performance, high-precision CPU, GPU, and memory profiler for Python. We can invoke it on our example as follows:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>scalene<span class="w"> </span>--html<span class="w"> </span>test.py<span class="w"> </span>&gt;<span class="w"> </span>scalene-out.html
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">test.py</span></code> is a script that again invokes</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">debuggingbook_change_counter</span><span class="p">(</span><span class="n">ChangeCounter</span><span class="p">)</span>
</pre></div>
</div>
<p>The output of <code class="docutils literal notranslate"><span class="pre">scalene</span></code> is sent to a HTML file (here, <code class="docutils literal notranslate"><span class="pre">scalene-out.html</span></code>) which is organized by <em>lines</em> – that is, for each line, we see how much it contributed to overall execution time. Opening the output <code class="docutils literal notranslate"><span class="pre">scalene-out.html</span></code> in a HTML browser, we see these lines:</p>
<p><img alt="" src="_images/scalene-out.png" /></p>
<p>As with <code class="docutils literal notranslate"><span class="pre">cProfile</span></code>, above, we identify the <code class="docutils literal notranslate"><span class="pre">mine()</span></code> method in the <code class="docutils literal notranslate"><span class="pre">ChangeCounter</span></code> class as the main performance hog – and in the <code class="docutils literal notranslate"><span class="pre">mine()</span></code> method, it is the iteration over all modifications that takes all the time. Adding the option <code class="docutils literal notranslate"><span class="pre">--profile-all</span></code> to <code class="docutils literal notranslate"><span class="pre">scalene</span></code> would extend the profile to all executed code, including the <code class="docutils literal notranslate"><span class="pre">pydriller</span></code> third-party library.</p>
<p>Besides relying on sampling rather that tracing (which is more efficient) and breaking down execution time by line, <code class="docutils literal notranslate"><span class="pre">scalene</span></code> also provides additional information on memory usage and more. If <code class="docutils literal notranslate"><span class="pre">cProfile</span></code> is not sufficient, then <code class="docutils literal notranslate"><span class="pre">scalene</span></code> will bring profiling to the next level.</p>
</section>
</section>
<section id="improving-performance">
<h2>Improving Performance<a class="headerlink" href="#improving-performance" title="Link to this heading">#</a></h2>
<p>Identifying a culprit is not always that easy. Notably, when the first set of obvious performance hogs is fixed, it becomes more and more difficult to squeeze out additional performance – and, as stated above, such optimization may be in conflict with readability and maintainability of your code. Here are some simple ways to improve performance:</p>
<ul class="simple">
<li><p><strong>Efficient algorithms</strong>. For many tasks, the simplest algorithm is not always the best performing one. Consider alternatives that may be more efficient, and <em>measure</em> whether they pay off.</p></li>
<li><p><strong>Efficient data types</strong>. Remember that certain operations, such as looking up whether an element is contained, may take different amounts of time depending on the data structure. In Python, a query like <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">in</span> <span class="pre">xs</span></code> takes (mostly) constant time if <code class="docutils literal notranslate"><span class="pre">xs</span></code> is a set, but linear time if <code class="docutils literal notranslate"><span class="pre">xs</span></code> is a list; these differences become significant as the size of <code class="docutils literal notranslate"><span class="pre">xs</span></code> grows.</p></li>
<li><p><strong>Efficient modules</strong>. In Python, most frequently used modules (or at least parts of) are implemented in C, which is way more efficient than plain Python. Rely on existing modules whenever possible. Or implement your own, <em>after</em> having measured that this may pay off.</p></li>
</ul>
<p>These are all things you can already use during programming – and also set up your code such that exchanging, say, one data type by another will still be possible later. This is best achieved by hiding implementation details (such as the used data types) behind an abstract interface used by your clients.</p>
<p>But beyond these points, remember the famous words by <a class="reference external" href="https://en.wikipedia.org/wiki/Donald_Knuth">Donald E. Knuth</a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">quiz</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">Donald E. Knuth said: "Premature optimization..."</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">
    
        <input type="radio" name="e14f4c6c-b294-11f0-866d-6298cf1a5790" id="e14f4c6c-b294-11f0-866d-6298cf1a5790-1" onclick="clear_selection('e14f4c6c-b294-11f0-866d-6298cf1a5790')">
        <label id="e14f4c6c-b294-11f0-866d-6298cf1a5790-1-label" for="e14f4c6c-b294-11f0-866d-6298cf1a5790-1">... is the root of all evil</label><br>
    
        <input type="radio" name="e14f4c6c-b294-11f0-866d-6298cf1a5790" id="e14f4c6c-b294-11f0-866d-6298cf1a5790-2" onclick="clear_selection('e14f4c6c-b294-11f0-866d-6298cf1a5790')">
        <label id="e14f4c6c-b294-11f0-866d-6298cf1a5790-2-label" for="e14f4c6c-b294-11f0-866d-6298cf1a5790-2">... requires lots of experience</label><br>
    
        <input type="radio" name="e14f4c6c-b294-11f0-866d-6298cf1a5790" id="e14f4c6c-b294-11f0-866d-6298cf1a5790-3" onclick="clear_selection('e14f4c6c-b294-11f0-866d-6298cf1a5790')">
        <label id="e14f4c6c-b294-11f0-866d-6298cf1a5790-3-label" for="e14f4c6c-b294-11f0-866d-6298cf1a5790-3">... should be left to assembly programmers</label><br>
    
        <input type="radio" name="e14f4c6c-b294-11f0-866d-6298cf1a5790" id="e14f4c6c-b294-11f0-866d-6298cf1a5790-4" onclick="clear_selection('e14f4c6c-b294-11f0-866d-6298cf1a5790')">
        <label id="e14f4c6c-b294-11f0-866d-6298cf1a5790-4-label" for="e14f4c6c-b294-11f0-866d-6298cf1a5790-4">... is the reason why TeX is so fast</label><br>
    
    </div>
    </p>
    <input id="e14f4c6c-b294-11f0-866d-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('e14f4c6c-b294-11f0-866d-6298cf1a5790', 2, 0, 'len(&quot;METAFONT&quot;) - len(&quot;TeX&quot;) - len(&quot;CWEB&quot;)')">
    <span class="quiz_hint" id="e14f4c6c-b294-11f0-866d-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
<p>This quote should always remind us that after a good design, you should always <em>first</em> measure and <em>then</em> optimize.</p>
</section>
<section id="building-a-profiler">
<h2>Building a Profiler<a class="headerlink" href="#building-a-profiler" title="Link to this heading">#</a></h2>
<p>Having discussed profilers from a <em>user</em> perspective, let us now dive into how they are actually implemented. It turns out we can use most of our existing infrastructure to implement a simple tracing profiler with only a few lines of code.</p>
<p>The program we will apply our profiler on is – surprise! – our ongoing example, <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code>. Our aim is to understand how much time is spent <em>in each line of the code</em> (such that we have a new feature on top of Python <code class="docutils literal notranslate"><span class="pre">cProfile</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">Intro_Debugging</span><span class="w"> </span><span class="kn">import</span> <span class="n">remove_html_markup</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">remove_html_markup</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">,</span>
              <span class="n">start_line_number</span><span class="o">=</span><span class="mi">238</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>238  <span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">remove_html_markup</span>(s):  <span class=" -Color -Color-White"># type: ignore</span>
239      tag = <span class=" -Color -Color-Blue">False</span>
240      quote = <span class=" -Color -Color-Blue">False</span>
241      out = <span class=" -Color -Color-Yellow">&quot;&quot;</span>
242  
243      <span class=" -Color -Color-Blue">for</span> c <span class=" -Color -Color-Magenta">in</span> s:
244          <span class=" -Color -Color-Blue">assert</span> tag <span class=" -Color -Color-Magenta">or</span> <span class=" -Color -Color-Magenta">not</span> quote
245  
246          <span class=" -Color -Color-Blue">if</span> c == <span class=" -Color -Color-Yellow">&#39;&lt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> <span class=" -Color -Color-Magenta">not</span> quote:
247              tag = <span class=" -Color -Color-Blue">True</span>
248          <span class=" -Color -Color-Blue">elif</span> c == <span class=" -Color -Color-Yellow">&#39;&gt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> <span class=" -Color -Color-Magenta">not</span> quote:
249              tag = <span class=" -Color -Color-Blue">False</span>
250          <span class=" -Color -Color-Blue">elif</span> (c == <span class=" -Color -Color-Yellow">&#39;&quot;&#39;</span> <span class=" -Color -Color-Magenta">or</span> c == <span class=" -Color -Color-Yellow">&quot;&#39;&quot;</span>) <span class=" -Color -Color-Magenta">and</span> tag:
251              quote = <span class=" -Color -Color-Magenta">not</span> quote
252          <span class=" -Color -Color-Blue">elif</span> <span class=" -Color -Color-Magenta">not</span> tag:
253              out = out + c
254  
255      <span class=" -Color -Color-Blue">return</span> out
</pre></div>
</div>
</div>
</div>
<p>We introduce a class <code class="docutils literal notranslate"><span class="pre">PerformanceTracer</span></code> that tracks, for each line in the code:</p>
<ul class="simple">
<li><p>how <em>often</em> it was executed (<code class="docutils literal notranslate"><span class="pre">hits</span></code>), and</p></li>
<li><p><em>how much time</em> was spent during its execution (<code class="docutils literal notranslate"><span class="pre">time</span></code>).</p></li>
</ul>
<p>To this end, we make use of our <code class="docutils literal notranslate"><span class="pre">Timer</span></code> class, which measures time, and the <code class="docutils literal notranslate"><span class="pre">Tracer</span></code> class from <a class="reference internal" href="Tracer.html"><span class="std std-doc">the chapter on tracing</span></a>, which allows us to track every line of the program as it is being executed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">Tracer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tracer</span>
</pre></div>
</div>
</div>
</div>
<p>In <code class="docutils literal notranslate"><span class="pre">PerformanceTracker</span></code>, the attributes <code class="docutils literal notranslate"><span class="pre">hits</span></code> and <code class="docutils literal notranslate"><span class="pre">time</span></code> are mappings indexed by unique locations – that is, pairs of function name and line number.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Location</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">PerformanceTracer</span><span class="p">(</span><span class="n">Tracer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Trace time and #hits for individual program lines&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_timer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Location</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Location</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="o">.</span><span class="n">Timer</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>As common in this book, we want to use <code class="docutils literal notranslate"><span class="pre">PerformanceTracer</span></code> in a <code class="docutils literal notranslate"><span class="pre">with</span></code>-block around the function call(s) to be tracked:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">PerformanceTracer</span><span class="p">()</span> <span class="k">as</span> <span class="n">perf_tracer</span><span class="p">:</span>
    <span class="n">function</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>When entering the <code class="docutils literal notranslate"><span class="pre">with</span></code> block (<code class="docutils literal notranslate"><span class="pre">__enter__()</span></code>), we reset all timers. Also, coming from the <code class="docutils literal notranslate"><span class="pre">__enter__()</span></code> method of the superclass <code class="docutils literal notranslate"><span class="pre">Tracer</span></code>, we enable tracing through the <code class="docutils literal notranslate"><span class="pre">traceit()</span></code> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">types</span><span class="w"> </span><span class="kn">import</span> <span class="n">FrameType</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">PerformanceTracer</span><span class="p">(</span><span class="n">PerformanceTracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enter a `with` block.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_timer</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">traceit()</span></code> method extracts the current location. It increases the corresponding <code class="docutils literal notranslate"><span class="pre">hits</span></code> value by 1, and adds the elapsed time to the corresponding <code class="docutils literal notranslate"><span class="pre">time</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">PerformanceTracer</span><span class="p">(</span><span class="n">PerformanceTracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">traceit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tracing function; called for every line.&quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">()</span>
        <span class="n">location</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="o">+=</span> <span class="n">t</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset_timer</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>This is it already. We can now determine where most time is spent in <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code>. We invoke it 10,000 times such that we can average over runs:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">PerformanceTracer</span><span class="p">()</span> <span class="k">as</span> <span class="n">perf_tracer</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&lt;b&gt;foo&lt;/b&gt;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here are the hits. For every line executed, we see how often it was executed. The most executed line is the <code class="docutils literal notranslate"><span class="pre">for</span></code> loop with 110,000 hits – once for each of the 10 characters in <code class="docutils literal notranslate"><span class="pre">&lt;b&gt;foo&lt;/b&gt;</span></code>, once for the final check, and all of this 10,000 times.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">perf_tracer</span><span class="o">.</span><span class="n">hits</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{(&#39;__init__&#39;, 17): 1,
 (&#39;__init__&#39;, 19): 1,
 (&#39;clock&#39;, 8): 1,
 (&#39;clock&#39;, 12): 2,
 (&#39;__init__&#39;, 20): 2,
 (&#39;remove_html_markup&#39;, 238): 10000,
 (&#39;remove_html_markup&#39;, 239): 10000,
 (&#39;remove_html_markup&#39;, 240): 10000,
 (&#39;remove_html_markup&#39;, 241): 10000,
 (&#39;remove_html_markup&#39;, 243): 110000,
 (&#39;remove_html_markup&#39;, 244): 100000,
 (&#39;remove_html_markup&#39;, 246): 100000,
 (&#39;remove_html_markup&#39;, 247): 20000,
 (&#39;remove_html_markup&#39;, 248): 80000,
 (&#39;remove_html_markup&#39;, 250): 60000,
 (&#39;remove_html_markup&#39;, 252): 60000,
 (&#39;remove_html_markup&#39;, 249): 20000,
 (&#39;remove_html_markup&#39;, 253): 30000,
 (&#39;remove_html_markup&#39;, 255): 20000}
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">time</span></code> attribute collects how much time was spent in each line. Within the loop, again, the <code class="docutils literal notranslate"><span class="pre">for</span></code> statement takes the most time. The other lines show some variability, though.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">perf_tracer</span><span class="o">.</span><span class="n">time</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{(&#39;__init__&#39;, 17): 0.00024116699933074415,
 (&#39;__init__&#39;, 19): 1.3329845387488604e-06,
 (&#39;clock&#39;, 8): 2.4999899324029684e-06,
 (&#39;clock&#39;, 12): 1.7909915186464787e-06,
 (&#39;__init__&#39;, 20): 1.334003172814846e-06,
 (&#39;remove_html_markup&#39;, 238): 0.007917946233646944,
 (&#39;remove_html_markup&#39;, 239): 0.00618785762344487,
 (&#39;remove_html_markup&#39;, 240): 0.006357173289870843,
 (&#39;remove_html_markup&#39;, 241): 0.006170973560074344,
 (&#39;remove_html_markup&#39;, 243): 0.06910131918266416,
 (&#39;remove_html_markup&#39;, 244): 0.0627616380515974,
 (&#39;remove_html_markup&#39;, 246): 0.06305116802104749,
 (&#39;remove_html_markup&#39;, 247): 0.012841210089391097,
 (&#39;remove_html_markup&#39;, 248): 0.04974727283115499,
 (&#39;remove_html_markup&#39;, 250): 0.03712841047672555,
 (&#39;remove_html_markup&#39;, 252): 0.037927715689875185,
 (&#39;remove_html_markup&#39;, 249): 0.012593008199473843,
 (&#39;remove_html_markup&#39;, 253): 0.01872212707530707,
 (&#39;remove_html_markup&#39;, 255): 0.013112093147356063}
</pre></div>
</div>
</div>
</div>
<p>For a full profiler, these numbers would now be sorted and printed in a table, much like <code class="docutils literal notranslate"><span class="pre">cProfile</span></code> does. However, we will borrow some material from previous chapters and annotate our code accordingly.</p>
</section>
<section id="visualizing-performance-metrics">
<h2>Visualizing Performance Metrics<a class="headerlink" href="#visualizing-performance-metrics" title="Link to this heading">#</a></h2>
<p>In the <a class="reference internal" href="StatisticalDebugger.html"><span class="std std-doc">chapter on statistical debugging</span></a>, we have encountered the <code class="docutils literal notranslate"><span class="pre">CoverageCollector</span></code> class, which collects line and function coverage during execution, using a <code class="docutils literal notranslate"><span class="pre">collect()</span></code> method that is invoked for every line. We will repurpose this class to collect arbitrary <em>metrics</em> on the lines executed, notably time taken.</p>
<section id="collecting-time-spent">
<h3>Collecting Time Spent<a class="headerlink" href="#collecting-time-spent" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">StatisticalDebugger</span><span class="w"> </span><span class="kn">import</span> <span class="n">CoverageCollector</span><span class="p">,</span> <span class="n">SpectrumDebugger</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">MetricCollector</span></code> class is an abstract superclass that provides an interface to access a particular metric.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MetricCollector</span><span class="p">(</span><span class="n">CoverageCollector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract superclass for collecting line-specific metrics&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a metric for an event, or none.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">all_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all metric for a function `func`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span>
</pre></div>
</div>
</div>
</div>
<p>Given these metrics, we can also compute sums and maxima for a single function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MetricCollector</span><span class="p">(</span><span class="n">MetricCollector</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">total</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_metrics</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">maximum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_metrics</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Let us instantiate this superclass into <code class="docutils literal notranslate"><span class="pre">TimeCollector</span></code> – a subclass that measures time. This is modeled after our <code class="docutils literal notranslate"><span class="pre">PerformanceTracer</span></code> class, above; notably, the <code class="docutils literal notranslate"><span class="pre">time</span></code> attribute serves the same role.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TimeCollector</span><span class="p">(</span><span class="n">MetricCollector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collect time executed for each line&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_timer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Location</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_items_to_ignore</span><span class="p">([</span><span class="n">Timer</span><span class="o">.</span><span class="n">Timer</span><span class="p">,</span> <span class="n">Timer</span><span class="o">.</span><span class="n">clock</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Invoked for every line executed. Accumulate time spent.&quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
        <span class="n">location</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="o">+=</span> <span class="n">t</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset_timer</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="o">.</span><span class="n">Timer</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_timer</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">metric()</span></code> and <code class="docutils literal notranslate"><span class="pre">all_metrics()</span></code> methods accumulate the metric (time taken) for an individual function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TimeCollector</span><span class="p">(</span><span class="n">TimeCollector</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">location</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">location</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">all_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">time</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="n">lineno</span><span class="p">),</span> <span class="n">time</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">func_name</span> <span class="o">==</span> <span class="n">func</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s how to use <code class="docutils literal notranslate"><span class="pre">TimeCollector()</span></code> – again, in a <code class="docutils literal notranslate"><span class="pre">with</span></code> block:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">TimeCollector</span><span class="p">()</span> <span class="k">as</span> <span class="n">collector</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&lt;b&gt;foo&lt;/b&gt;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">time</span></code> attribute holds the time spent in each line:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">location</span><span class="p">,</span> <span class="n">time_spent</span> <span class="ow">in</span> <span class="n">collector</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">time_spent</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;remove_html_markup&#39;, 238) 0.00015183707000687718
(&#39;remove_html_markup&#39;, 239) 0.00010900790221057832
(&#39;remove_html_markup&#39;, 240) 0.00011175306281074882
(&#39;remove_html_markup&#39;, 241) 0.00010875475709326565
(&#39;remove_html_markup&#39;, 243) 0.001230446039699018
(&#39;remove_html_markup&#39;, 244) 0.0011077363742515445
(&#39;remove_html_markup&#39;, 246) 0.0011040171957574785
(&#39;remove_html_markup&#39;, 247) 0.00022176094353199005
(&#39;remove_html_markup&#39;, 248) 0.0008924873836804181
(&#39;remove_html_markup&#39;, 250) 0.0006938762671779841
(&#39;remove_html_markup&#39;, 252) 0.000667455984512344
(&#39;remove_html_markup&#39;, 249) 0.0002219062007497996
(&#39;remove_html_markup&#39;, 253) 0.00032781687332317233
(&#39;remove_html_markup&#39;, 255) 0.00023653166135773063
</pre></div>
</div>
</div>
</div>
<p>And we can also create a total for an entire function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">collector</span><span class="o">.</span><span class="n">total</span><span class="p">(</span><span class="s1">&#39;remove_html_markup&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.00718538771616295
</pre></div>
</div>
</div>
</div>
</section>
<section id="visualizing-time-spent">
<h3>Visualizing Time Spent<a class="headerlink" href="#visualizing-time-spent" title="Link to this heading">#</a></h3>
<p>Let us now go and visualize these numbers in a simple form. The idea is to assign each line a <em>color</em> whose saturation indicates the time spent in that line relative to the time spent in the function overall  – the higher the fraction, the darker the line. We create a <code class="docutils literal notranslate"><span class="pre">MetricDebugger</span></code> class built as a specialization of <code class="docutils literal notranslate"><span class="pre">SpectrumDebugger</span></code>, in which <code class="docutils literal notranslate"><span class="pre">suspiciousness()</span></code> and <code class="docutils literal notranslate"><span class="pre">color()</span></code> are repurposed to show these metrics.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MetricDebugger</span><span class="p">(</span><span class="n">SpectrumDebugger</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Visualize a metric&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="n">Location</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="nb">sum</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collectors</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">collector</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collectors</span><span class="p">[</span><span class="n">outcome</span><span class="p">]:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">collector</span><span class="p">,</span> <span class="n">MetricCollector</span><span class="p">)</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">collector</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">sum</span> <span class="o">+=</span> <span class="n">m</span>  <span class="c1"># type: ignore</span>

        <span class="k">return</span> <span class="nb">sum</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">total</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collectors</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">collector</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collectors</span><span class="p">[</span><span class="n">outcome</span><span class="p">]:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">collector</span><span class="p">,</span> <span class="n">MetricCollector</span><span class="p">)</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">collector</span><span class="o">.</span><span class="n">all_metrics</span><span class="p">(</span><span class="n">func_name</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">total</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">maximum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">maximum</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collectors</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">collector</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collectors</span><span class="p">[</span><span class="n">outcome</span><span class="p">]:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">collector</span><span class="p">,</span> <span class="n">MetricCollector</span><span class="p">)</span>
                <span class="n">maximum</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">maximum</span><span class="p">,</span> 
                              <span class="nb">max</span><span class="p">(</span><span class="n">collector</span><span class="o">.</span><span class="n">all_metrics</span><span class="p">(</span><span class="n">func_name</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">maximum</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">suspiciousness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="n">Location</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">func_name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">location</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="n">location</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">total</span><span class="p">(</span><span class="n">func_name</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="n">Location</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">func_name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">location</span>
        <span class="n">hue</span> <span class="o">=</span> <span class="mi">240</span>  <span class="c1"># blue</span>
        <span class="n">saturation</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># fully saturated</span>
        <span class="n">darkness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="n">location</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">func_name</span><span class="p">)</span>
        <span class="n">lightness</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="n">darkness</span> <span class="o">*</span> <span class="mi">25</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;hsl(</span><span class="si">{</span><span class="n">hue</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">saturation</span><span class="si">}</span><span class="s2">%, </span><span class="si">{</span><span class="n">lightness</span><span class="si">}</span><span class="s2">%)&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">tooltip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="n">Location</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">tooltip</span><span class="p">(</span><span class="n">location</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">(</span><span class="n">location</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>We can now introduce <code class="docutils literal notranslate"><span class="pre">PerformanceDebugger</span></code> as a subclass of <code class="docutils literal notranslate"><span class="pre">MetricDebugger</span></code>, using an arbitrary <code class="docutils literal notranslate"><span class="pre">MetricCollector</span></code> (such as <code class="docutils literal notranslate"><span class="pre">TimeCollector</span></code>) to obtain the metric we want to visualize.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">PerformanceDebugger</span><span class="p">(</span><span class="n">MetricDebugger</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collect and visualize a metric&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collector_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span> <span class="n">log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">collector_class</span><span class="p">,</span> <span class="n">MetricCollector</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">collector_class</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>With <code class="docutils literal notranslate"><span class="pre">PerformanceDebugger</span></code>, we inherit all the capabilities of <code class="docutils literal notranslate"><span class="pre">SpectrumDebugger</span></code>, such as showing the (relative) percentage of time spent in a table. We see that the <code class="docutils literal notranslate"><span class="pre">for</span></code> condition and the following <code class="docutils literal notranslate"><span class="pre">assert</span></code> take most of the time, followed by the first condition.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">PerformanceDebugger</span><span class="p">(</span><span class="n">TimeCollector</span><span class="p">)</span> <span class="k">as</span> <span class="n">debugger</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&lt;b&gt;foo&lt;/b&gt;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">debugger</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 238   1% def remove_html_markup(s):  # type: ignore
 239   1%     tag = False
 240   1%     quote = False
 241   1%     out = &quot;&quot;
 242   0%
 243  16%     for c in s:
 244  15%         assert tag or not quote
 245   0%
 246  15%         if c == &#39;&lt;&#39; and not quote:
 247   3%             tag = True
 248  12%         elif c == &#39;&gt;&#39; and not quote:
 249   3%             tag = False
 250   9%         elif (c == &#39;&quot;&#39; or c == &quot;&#39;&quot;) and tag:
 251   0%             quote = not quote
 252   9%         elif not tag:
 253   4%             out = out + c
 254   0%
 255   3%     return out
</pre></div>
</div>
</div>
</div>
<p>However, we can also visualize these percentages, using shades of blue to indicate those lines most time spent in:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">debugger</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="background-color:hsl(240, 100%, 97.05433582288892%)"
                    title="Line 238:   1% 0.00015942173195071518"> 238 def remove_html_markup(s):  # type: ignore</pre>
<pre style="background-color:hsl(240, 100%, 97.69576991084122%)"
                    title="Line 239:   1% 0.00012470679939724505"> 239     tag = False</pre>
<pre style="background-color:hsl(240, 100%, 97.66184230038394%)"
                    title="Line 240:   1% 0.00012654298916459084"> 240     quote = False</pre>
<pre style="background-color:hsl(240, 100%, 97.7248302850485%)"
                    title="Line 241:   1% 0.00012313402839936316"> 241     out = &quot;&quot;</pre>
<pre style="background-color:hsl(240, 100%, 100.0%)"
                    title="Line 242:   0% 0.0"> 242 &nbsp;</pre>
<pre style="background-color:hsl(240, 100%, 75.0%)"
                    title="Line 243:  16% 0.0013530202559195459"> 243     for c in s:</pre>
<pre style="background-color:hsl(240, 100%, 76.59946385222858%)"
                    title="Line 244:  15% 0.001266455976292491"> 244         assert tag or not quote</pre>
<pre style="background-color:hsl(240, 100%, 100.0%)"
                    title="Line 245:   0% 0.0"> 245 &nbsp;</pre>
<pre style="background-color:hsl(240, 100%, 76.41775584992216%)"
                    title="Line 246:  15% 0.0012762901606038213"> 246         if c == &#x27;&lt;&#x27; and not quote:</pre>
<pre style="background-color:hsl(240, 100%, 95.301369847102%)"
                    title="Line 247:   3% 0.0002542936708778143"> 247             tag = True</pre>
<pre style="background-color:hsl(240, 100%, 81.82933151975948%)"
                    title="Line 248:  12% 0.00098341130069457"> 248         elif c == &#x27;&gt;&#x27; and not quote:</pre>
<pre style="background-color:hsl(240, 100%, 95.47003617295995%)"
                    title="Line 249:   3% 0.0002451653126627207"> 249             tag = False</pre>
<pre style="background-color:hsl(240, 100%, 86.4465625104997%)"
                    title="Line 250:   9% 0.0007335230184253305"> 250         elif (c == &#x27;&quot;&#x27; or c == &quot;&#x27;&quot;) and tag:</pre>
<pre style="background-color:hsl(240, 100%, 100.0%)"
                    title="Line 251:   0% 0.0"> 251             quote = not quote</pre>
<pre style="background-color:hsl(240, 100%, 86.29159607533946%)"
                    title="Line 252:   9% 0.0007419099274557084"> 252         elif not tag:</pre>
<pre style="background-color:hsl(240, 100%, 93.23249329707734%)"
                    title="Line 253:   4% 0.0003662629460450262"> 253             out = out + c</pre>
<pre style="background-color:hsl(240, 100%, 100.0%)"
                    title="Line 254:   0% 0.0"> 254 &nbsp;</pre>
<pre style="background-color:hsl(240, 100%, 95.17911784319452%)"
                    title="Line 255:   3% 0.00026091004838235676"> 255     return out</pre>
</div></div>
</div>
</section>
<section id="other-metrics">
<h3>Other Metrics<a class="headerlink" href="#other-metrics" title="Link to this heading">#</a></h3>
<p>Our framework is flexible enough to collect (and visualize) arbitrary metrics. This <code class="docutils literal notranslate"><span class="pre">HitCollector</span></code> class, for instance, collects how often a line is being executed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">HitCollector</span><span class="p">(</span><span class="n">MetricCollector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collect how often a line is executed&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Location</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
        <span class="n">location</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="n">Location</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">location</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="p">[</span><span class="n">location</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">all_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">hits</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="n">lineno</span><span class="p">),</span> <span class="n">hits</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">func_name</span> <span class="o">==</span> <span class="n">func</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We can plug in this class into <code class="docutils literal notranslate"><span class="pre">PerformanceDebugger</span></code> to obtain a distribution of lines executed:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">PerformanceDebugger</span><span class="p">(</span><span class="n">HitCollector</span><span class="p">)</span> <span class="k">as</span> <span class="n">debugger</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&lt;b&gt;foo&lt;/b&gt;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>In total, during this call to <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code>, there are 6,400 lines executed:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">debugger</span><span class="o">.</span><span class="n">total</span><span class="p">(</span><span class="s1">&#39;remove_html_markup&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6400.0
</pre></div>
</div>
</div>
</div>
<p>Again, we can visualize the distribution as a table and using colors. We can see how the shade gets lighter in the lower part of the loop as individual conditions have been met.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">debugger</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 238   1% def remove_html_markup(s):  # type: ignore
 239   1%     tag = False
 240   1%     quote = False
 241   1%     out = &quot;&quot;
 242   0%
 243  17%     for c in s:
 244  15%         assert tag or not quote
 245   0%
 246  15%         if c == &#39;&lt;&#39; and not quote:
 247   3%             tag = True
 248  12%         elif c == &#39;&gt;&#39; and not quote:
 249   3%             tag = False
 250   9%         elif (c == &#39;&quot;&#39; or c == &quot;&#39;&quot;) and tag:
 251   0%             quote = not quote
 252   9%         elif not tag:
 253   4%             out = out + c
 254   0%
 255   3%     return out
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">debugger</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="background-color:hsl(240, 100%, 97.72727272727273%)"
                    title="Line 238:   1% 100.0"> 238 def remove_html_markup(s):  # type: ignore</pre>
<pre style="background-color:hsl(240, 100%, 97.72727272727273%)"
                    title="Line 239:   1% 100.0"> 239     tag = False</pre>
<pre style="background-color:hsl(240, 100%, 97.72727272727273%)"
                    title="Line 240:   1% 100.0"> 240     quote = False</pre>
<pre style="background-color:hsl(240, 100%, 97.72727272727273%)"
                    title="Line 241:   1% 100.0"> 241     out = &quot;&quot;</pre>
<pre style="background-color:hsl(240, 100%, 100.0%)"
                    title="Line 242:   0% 0.0"> 242 &nbsp;</pre>
<pre style="background-color:hsl(240, 100%, 75.0%)"
                    title="Line 243:  17% 1100.0"> 243     for c in s:</pre>
<pre style="background-color:hsl(240, 100%, 77.27272727272728%)"
                    title="Line 244:  15% 1000.0"> 244         assert tag or not quote</pre>
<pre style="background-color:hsl(240, 100%, 100.0%)"
                    title="Line 245:   0% 0.0"> 245 &nbsp;</pre>
<pre style="background-color:hsl(240, 100%, 77.27272727272728%)"
                    title="Line 246:  15% 1000.0"> 246         if c == &#x27;&lt;&#x27; and not quote:</pre>
<pre style="background-color:hsl(240, 100%, 95.45454545454545%)"
                    title="Line 247:   3% 200.0"> 247             tag = True</pre>
<pre style="background-color:hsl(240, 100%, 81.81818181818181%)"
                    title="Line 248:  12% 800.0"> 248         elif c == &#x27;&gt;&#x27; and not quote:</pre>
<pre style="background-color:hsl(240, 100%, 95.45454545454545%)"
                    title="Line 249:   3% 200.0"> 249             tag = False</pre>
<pre style="background-color:hsl(240, 100%, 86.36363636363636%)"
                    title="Line 250:   9% 600.0"> 250         elif (c == &#x27;&quot;&#x27; or c == &quot;&#x27;&quot;) and tag:</pre>
<pre style="background-color:hsl(240, 100%, 100.0%)"
                    title="Line 251:   0% 0.0"> 251             quote = not quote</pre>
<pre style="background-color:hsl(240, 100%, 86.36363636363636%)"
                    title="Line 252:   9% 600.0"> 252         elif not tag:</pre>
<pre style="background-color:hsl(240, 100%, 93.18181818181819%)"
                    title="Line 253:   4% 300.0"> 253             out = out + c</pre>
<pre style="background-color:hsl(240, 100%, 100.0%)"
                    title="Line 254:   0% 0.0"> 254 &nbsp;</pre>
<pre style="background-color:hsl(240, 100%, 95.45454545454545%)"
                    title="Line 255:   3% 200.0"> 255     return out</pre>
</div></div>
</div>
</section>
</section>
<section id="integrating-with-delta-debugging">
<h2>Integrating with Delta Debugging<a class="headerlink" href="#integrating-with-delta-debugging" title="Link to this heading">#</a></h2>
<p>Besides identifying causes for performance issues in the code, one may also search for causes in the <em>input</em>, using <a class="reference internal" href="DeltaDebugger.html"><span class="std std-doc">Delta Debugging</span></a>. This can be useful if one does not immediately want to embark into investigating the code, but maybe first determine external influences that are related to performance issues.</p>
<p>Here is a variant of <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code> that introduces a (rather obvious) performance issue.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">remove_html_markup_ampersand</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">quote</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">tag</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">quote</span>

        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># &lt;-- the obvious performance issue</span>

        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;&lt;&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">quote</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;&gt;&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">quote</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;&quot;&#39;</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tag</span><span class="p">:</span>
            <span class="n">quote</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">quote</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">tag</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">out</span> <span class="o">+</span> <span class="n">c</span>

    <span class="k">return</span> <span class="n">out</span>
</pre></div>
</div>
</div>
</div>
<p>We can easily trigger this issue by measuring time taken:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Timer</span><span class="o">.</span><span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
    <span class="n">remove_html_markup_ampersand</span><span class="p">(</span><span class="s1">&#39;&amp;&amp;&amp;&#39;</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.30978220800170675
</pre></div>
</div>
</div>
</div>
<p>Let us set up a test that checks whether the performance issue is present.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">remove_html_test</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">Timer</span><span class="o">.</span><span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
        <span class="n">remove_html_markup_ampersand</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">t</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.1</span>
</pre></div>
</div>
</div>
</div>
<p>We can now apply delta debugging to determine a minimum input that causes the failure:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s_fail</span> <span class="o">=</span> <span class="s1">&#39;&lt;b&gt;foo&amp;amp;&lt;/b&gt;&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">DeltaDebugger</span><span class="o">.</span><span class="n">DeltaDebugger</span><span class="p">()</span> <span class="k">as</span> <span class="n">dd</span><span class="p">:</span>
    <span class="n">remove_html_test</span><span class="p">(</span><span class="n">s_fail</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dd</span><span class="o">.</span><span class="n">min_args</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;s&#39;: &#39;&amp;&#39;}
</pre></div>
</div>
</div>
</div>
<p>For performance issues, however, a minimal input is often not enough to highlight the failure cause. This is because short inputs tend to take less processing time than longer inputs, which increases the risks of a spurious diagnosis. A better alternative is to compute a <em>maximum</em> input where the issue does not occur:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s_pass</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">max_args</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s_pass</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;s&#39;: &#39;&lt;b&gt;fooamp;&lt;/b&gt;&#39;}
</pre></div>
</div>
</div>
</div>
<p>We see that the culprit character (the <code class="docutils literal notranslate"><span class="pre">&amp;</span></code>) is removed. This tells us the failure-inducing difference – or, more precisely, the cause for the performance issue.</p>
</section>
<section id="lessons-learned">
<h2>Lessons Learned<a class="headerlink" href="#lessons-learned" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>To measure performance,</p>
<ul>
<li><p>instrument the code such that the time taken per function (or line) is collected; or</p></li>
<li><p>sample the execution that at regular intervals, the active call stack is collected.</p></li>
</ul>
</li>
<li><p>To make code performant, focus on efficient algorithms, efficient data types, and sufficient abstraction such that you can replace them by alternatives.</p></li>
<li><p>Beyond efficient algorithms and data types, do <em>not</em> optimize before measuring.</p></li>
</ul>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Link to this heading">#</a></h2>
<p>This chapter concludes the part on abstracting failures. The next part will focus on</p>
<ul class="simple">
<li><p><a class="reference internal" href="Repairer.html"><span class="std std-doc">repairing code automatically</span></a></p></li>
</ul>
</section>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">#</a></h2>
<p><a class="reference external" href="https://github.com/plasma-umass/scalene">Scalene</a> is a high-performance, high-precision CPU, GPU, and memory profiler for Python. In contrast to the standard Python <code class="docutils literal notranslate"><span class="pre">cProfile</span></code> profiler, it uses <em>sampling</em> instead of instrumentation or relying on Python’s tracing facilities; and it also supports line-by-line profiling. Scalene might be the tool of choice if you want to go beyond basic profiling.</p>
<p>The Wikipedia articles on <a class="reference external" href="https://en.wikipedia.org/wiki/Profiling_(computer_programming)">profiling</a> and <a class="reference external" href="https://en.wikipedia.org/wiki/List_of_performance_analysis_tools">performance analysis tools</a> provide several additional resources on profiling tools and how to apply them in practice.</p>
</section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<section id="exercise-1-profiling-memory-usage">
<h3>Exercise 1: Profiling Memory Usage<a class="headerlink" href="#exercise-1-profiling-memory-usage" title="Link to this heading">#</a></h3>
<p>The Python <a class="reference external" href="https://docs.python.org/3/library/tracemalloc.html"><code class="docutils literal notranslate"><span class="pre">tracemalloc</span></code> module</a> allows tracking memory usage during execution. Between <code class="docutils literal notranslate"><span class="pre">tracemalloc.start()</span></code> and <code class="docutils literal notranslate"><span class="pre">tracemalloc.end()</span></code>, use <code class="docutils literal notranslate"><span class="pre">tracemalloc.get_traced_memory()</span></code> to obtain how much memory is currently being consumed:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">tracemalloc</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tracemalloc</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">current_size</span><span class="p">,</span> <span class="n">peak_size</span> <span class="o">=</span> <span class="n">tracemalloc</span><span class="o">.</span><span class="n">get_traced_memory</span><span class="p">()</span>
<span class="n">current_size</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>20551
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tracemalloc</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Create a subclass of <code class="docutils literal notranslate"><span class="pre">MetricCollector</span></code> named <code class="docutils literal notranslate"><span class="pre">MemoryCollector</span></code>. Make it measure the memory consumption before and after each line executed (0 if negative), and visualize the impact of individual lines on memory. Create an appropriate test program that (temporarily) consumes larger amounts of memory.</p>
</section>
</section>
<section id="exercise-2-statistical-performance-debugging">
<h2>Exercise 2: Statistical Performance Debugging<a class="headerlink" href="#exercise-2-statistical-performance-debugging" title="Link to this heading">#</a></h2>
<p>In a similar way as we integrated a binary “performance test” with delta debugging, we can also integrate such a test with other techniques. Combining a performance test with <a class="reference internal" href="StatisticalDebugger.html"><span class="std std-doc">Statistical Debugging</span></a>, for instance, will highlight those lines whose execution correlates with low performance. But then, the performance test need not be binary, as with functional pass/fail tests – you can also <em>weight</em> individual lines by <em>how much</em> they impact performance. Create a variant of <code class="docutils literal notranslate"><span class="pre">StatisticalDebugger</span></code> that reflects the impact of individual lines on an arbitrary (summarized) performance metric.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Alhazen.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Learning from Failures</p>
      </div>
    </a>
    <a class="right-next"
       href="Repairer.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Repairing Code Automatically</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#measuring-performance">Measuring Performance</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tracing-execution-profiles">Tracing Execution Profiles</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sampling-execution-profiles">Sampling Execution Profiles</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#improving-performance">Improving Performance</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#building-a-profiler">Building a Profiler</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-performance-metrics">Visualizing Performance Metrics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#collecting-time-spent">Collecting Time Spent</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-time-spent">Visualizing Time Spent</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#other-metrics">Other Metrics</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#integrating-with-delta-debugging">Integrating with Delta Debugging</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-profiling-memory-usage">Exercise 1: Profiling Memory Usage</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-statistical-performance-debugging">Exercise 2: Statistical Performance Debugging</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Andreas Zeller
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <div>
  Copyright &copy; 2021–2025 <a href="https://www.cispa.de/">CISPA Helmholtz Center for Information Security</a>.
  The <strong>content</strong> of this project is licensed under the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
  The <strong>source code</strong> that is part of the content, as well as the source code used to format and display that content is licensed under the <a href="https://github.com/uds-se/debuggingbook/blob/master/LICENSE.md#mit-license">MIT License</a>.
  <br>
  <a href="https://cispa.de/en/impressum">Imprint</a> &middot; <a href="/html/index.html#how-do-i-cite-your-work">Cite</a>
</div>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>