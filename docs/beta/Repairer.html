
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Repairing Code Automatically &#8212; The Debugging Book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=d5c2cecb" />
    <link rel="stylesheet" type="text/css" href="_static/mastodon-timeline.css?v=f82c2b23" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Repairer';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Tracking Bugs" href="Tracking.html" />
    <link rel="prev" title="Debugging Performance Issues" href="PerformanceDebugger.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content"><p>This is a beta version of debuggingbook.org, currently in development. See the <a href="https://debuggingbook.org/classic/"  style="color:white!important;">classic site</a> for the 2024 version.</p></div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/debuggingbook.png" class="logo__image only-light" alt="The Debugging Book - Home"/>
    <script>document.write(`<img src="_static/debuggingbook.png" class="logo__image only-dark" alt="The Debugging Book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    The Debugging Book
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tours.html">Sitemap</a></li>
<li class="toctree-l1"><a class="reference internal" href="Intro_Debugging.html">Introduction to Debugging</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Observing Executions</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tracer.html">Tracing Executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="Debugger.html">How Debuggers Work</a></li>
<li class="toctree-l1"><a class="reference internal" href="Assertions.html">Asserting Expectations</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Flows and Dependencies</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Slicer.html">Tracking Failure Origins</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Reducing Failure Causes</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="DeltaDebugger.html">Reducing Failure-Inducing Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ChangeDebugger.html">Isolating Failure-Inducing Changes</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Abstracting Failures</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="StatisticalDebugger.html">Statistical Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="DynamicInvariants.html">Mining Function Specifications</a></li>
<li class="toctree-l1"><a class="reference internal" href="DDSetDebugger.html">Generalizing Failure Circumstances</a></li>
<li class="toctree-l1"><a class="reference internal" href="Alhazen.html">Learning from Failures</a></li>
<li class="toctree-l1"><a class="reference internal" href="PerformanceDebugger.html">Debugging Performance Issues</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Automatic Repair</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Repairing Code Automatically</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Debugging in the Large</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tracking.html">Tracking Bugs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ChangeCounter.html">Where the Bugs are</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ExpectError.html">Error Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timer.html">Timer</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timeout.html">Timeout</a></li>
<li class="toctree-l1"><a class="reference internal" href="ClassDiagram.html">Class Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="StackInspector.html">Inspecting Call Stacks</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">About This Book</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ReleaseNotes.html">Release Notes for The Debugging Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="Importing.html">Downloads and Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Guide_for_Authors.html">Guide for Authors</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/uds-se/debuggingbook/master?urlpath=tree/docs/notebooks/Repairer.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/uds-se/debuggingbook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/uds-se/debuggingbook/issues/new?title=Issue%20on%20page%20%2FRepairer.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
    <li><a href="../code/Repairer.py" target="_blank"
       class="btn btn-sm btn-download-source-button dropdown-item"
       title="Download Python code"
       data-bs-placement="left" data-bs-toggle="tooltip"
    >
  

    <span class="btn__icon-container">
      <i class="fas fa-file"></i>
      </span>
    <span class="btn__text-container">.py</span>
    </a>
    </li>
    
      
      
      
      <li><a href="_sources/Repairer.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download notebook"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  
    <li><a href="Importing.html" target="_blank"
       class="btn btn-sm btn-download-source-button dropdown-item"
       title="All downloads"
       data-bs-placement="left" data-bs-toggle="tooltip"
    >
  

    <span class="btn__icon-container">
      <i class="fas fa-file"></i>
      </span>
    <span class="btn__text-container">All downloads</span>
    </a>
    </li>
    </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Repairing Code Automatically</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#automatic-code-repairs">Automatic Code Repairs</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-middle-function">The middle() Function</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#validated-repairs">Validated Repairs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#genetic-optimization">Genetic Optimization</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-test-suite">A Test Suite</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#locating-the-defect">Locating the Defect</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#random-code-mutations">Random Code Mutations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#picking-statements">Picking Statements</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mutating-statements">Mutating Statements</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#choosing-suspicious-statements-to-mutate">Choosing Suspicious Statements to Mutate</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#choosing-a-mutation-method">Choosing a Mutation Method</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#swapping-statements">Swapping Statements</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#inserting-statements">Inserting Statements</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#deleting-statements">Deleting Statements</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#helpers">Helpers</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#all-together">All Together</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fitness">Fitness</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#population">Population</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evolution">Evolution</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#simplifying">Simplifying</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#crossover">Crossover</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-crossover">Excursion: Implementing Crossover</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#crossing-statement-lists">Crossing Statement Lists</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#applying-crossover-on-programs">Applying Crossover on Programs</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#end-of-excursion">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#crossover-in-action">Crossover in Action</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-repairer-class">A Repairer Class</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-repairer">Excursion: Implementing Repairer</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#helper-functions">Helper Functions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#running-tests">Running Tests</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#re-defining-functions">(Re)defining Functions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#repairing">Repairing</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#evolving">Evolving</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Simplifying</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#repairer-in-action">Repairer in Action</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#removing-html-markup">Removing HTML Markup</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-creating-html-test-cases">Excursion: Creating HTML Test Cases</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mutating-conditions">Mutating Conditions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#collecting-conditions">Collecting Conditions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Mutating Conditions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#limitations">Limitations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-automated-repair-parameters">Exercise 1: Automated Repair Parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-elitism">Exercise 2: Elitism</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3-evolving-values">Exercise 3: Evolving Values</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-4-evolving-variable-names">Exercise 4: Evolving Variable Names</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-5-parallel-repair">Exercise 5: Parallel Repair</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="repairing-code-automatically">
<h1>Repairing Code Automatically<a class="headerlink" href="#repairing-code-automatically" title="Link to this heading">#</a></h1>
<p>So far, we have discussed how to track failures and how to locate defects in code. Let us now discuss how to <em>repair</em> defects – that is, to correct the code such that the failure no longer occurs. We will discuss how to <em>repair code automatically</em> – by systematically searching through possible fixes and evolving the most promising candidates.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">YouTubeVideo</span>
<span class="n">YouTubeVideo</span><span class="p">(</span><span class="s2">&quot;UJTf7cW0idI&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <iframe
            width="640"
            height="360"
            src="https://www.youtube-nocookie.com/embed/UJTf7cW0idI"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
<p><strong>Prerequisites</strong></p>
<ul class="simple">
<li><p>Re-read the <a class="reference internal" href="Intro_Debugging.html"><span class="std std-doc">introduction to debugging</span></a>, notably on how to properly fix code.</p></li>
<li><p>We make use of automatic fault localization, as discussed in the <a class="reference internal" href="StatisticalDebugger.html"><span class="std std-doc">chapter on statistical debugging</span></a>.</p></li>
<li><p>We make extensive use of code transformations, as discussed in the <a class="reference internal" href="Tracer.html"><span class="std std-doc">chapter on tracing executions</span></a>.</p></li>
<li><p>We make use of <a class="reference internal" href="DeltaDebugger.html"><span class="std std-doc">delta debugging</span></a>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">bookutils.setup</span>
</pre></div>
</div>
</div>
</div>
<section id="synopsis">
<h2>Synopsis<a class="headerlink" href="#synopsis" title="Link to this heading">#</a></h2>
<p>To <a class="reference internal" href="Importing.html"><span class="std std-doc">use the code provided in this chapter</span></a>, write</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">debuggingbook.Repairer</span><span class="w"> </span><span class="kn">import</span> <span class="o">&lt;</span><span class="n">identifier</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>and then make use of the following features.</p>
<p><strong>Note</strong>: The examples in this section only work after the rest of the cells have been executed.</p>
<p>This chapter provides tools and techniques for automated repair of program code. The <code class="docutils literal notranslate"><span class="pre">Repairer</span></code> class takes a <code class="docutils literal notranslate"><span class="pre">RankingDebugger</span></code> debugger as input (such as <code class="docutils literal notranslate"><span class="pre">OchiaiDebugger</span></code> from the <a class="reference internal" href="StatisticalDebugger.html"><span class="std std-doc">chapter on statistical debugging</span></a>. A typical setup looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">debuggingbook.StatisticalDebugger</span><span class="w"> </span><span class="kn">import</span> <span class="n">OchiaiDebugger</span>

<span class="n">debugger</span> <span class="o">=</span> <span class="n">OchiaiDebugger</span><span class="p">()</span>
<span class="k">for</span> <span class="n">inputs</span> <span class="ow">in</span> <span class="n">TESTCASES</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">debugger</span><span class="p">:</span>
        <span class="n">test_foo</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
<span class="o">...</span>

<span class="n">repairer</span> <span class="o">=</span> <span class="n">Repairer</span><span class="p">(</span><span class="n">debugger</span><span class="p">)</span>
</pre></div>
</div>
<p>Here, <code class="docutils literal notranslate"><span class="pre">test_foo()</span></code> is a function that raises an exception if the tested function <code class="docutils literal notranslate"><span class="pre">foo()</span></code> fails. If <code class="docutils literal notranslate"><span class="pre">foo()</span></code> passes, <code class="docutils literal notranslate"><span class="pre">test_foo()</span></code> should not raise an exception.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">repair()</span></code> method of a <code class="docutils literal notranslate"><span class="pre">Repairer</span></code> searches for a repair of the code covered in the debugger (except for methods whose name starts or ends in <code class="docutils literal notranslate"><span class="pre">test</span></code>, such that <code class="docutils literal notranslate"><span class="pre">foo()</span></code>, not <code class="docutils literal notranslate"><span class="pre">test_foo()</span></code> is repaired). <code class="docutils literal notranslate"><span class="pre">repair()</span></code> returns the best fix candidate as a pair <code class="docutils literal notranslate"><span class="pre">(tree,</span> <span class="pre">fitness)</span></code> where <code class="docutils literal notranslate"><span class="pre">tree</span></code> is a <a class="reference external" href="http://docs.python.org/3/library/ast">Python abstract syntax tree</a> (AST) of the fix candidate, and <code class="docutils literal notranslate"><span class="pre">fitness</span></code> is the fitness of the candidate (a value between 0 and 1). A <code class="docutils literal notranslate"><span class="pre">fitness</span></code> of 1.0 means that the candidate passed all tests. A typical usage looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tree</span><span class="p">,</span> <span class="n">fitness</span> <span class="o">=</span> <span class="n">repairer</span><span class="o">.</span><span class="n">repair</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">tree</span><span class="p">),</span> <span class="n">fitness</span><span class="p">)</span>
</pre></div>
</div>
<p>Here is a complete example for the <code class="docutils literal notranslate"><span class="pre">middle()</span></code> program. This is the original source code of <code class="docutils literal notranslate"><span class="pre">middle()</span></code>:</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">middle</span>(x, y, z):  <span class=" -Color -Color-White"># type: ignore</span>
    <span class=" -Color -Color-Blue">if</span> y &lt; z:
        <span class=" -Color -Color-Blue">if</span> x &lt; y:
            <span class=" -Color -Color-Blue">return</span> y
        <span class=" -Color -Color-Blue">elif</span> x &lt; z:
            <span class=" -Color -Color-Blue">return</span> y
    <span class=" -Color -Color-Blue">else</span>:
        <span class=" -Color -Color-Blue">if</span> x &gt; y:
            <span class=" -Color -Color-Blue">return</span> y
        <span class=" -Color -Color-Blue">elif</span> x &gt; z:
            <span class=" -Color -Color-Blue">return</span> x
    <span class=" -Color -Color-Blue">return</span> z
</pre></div>
</div>
</div>
</div>
<p>We set up a function <code class="docutils literal notranslate"><span class="pre">middle_test()</span></code> that tests it. The <code class="docutils literal notranslate"><span class="pre">middle_debugger</span></code>  collects testcases and outcomes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">middle_debugger</span> <span class="o">=</span> <span class="n">OchiaiDebugger</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">MIDDLE_PASSING_TESTCASES</span> <span class="o">+</span> <span class="n">MIDDLE_FAILING_TESTCASES</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">middle_debugger</span><span class="p">:</span>
        <span class="n">middle_test</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The repairer is instantiated with the debugger used (<code class="docutils literal notranslate"><span class="pre">middle_debugger</span></code>):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">middle_repairer</span> <span class="o">=</span> <span class="n">Repairer</span><span class="p">(</span><span class="n">middle_debugger</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">repair()</span></code> method of the repairer attempts to repair the function invoked by the test (<code class="docutils literal notranslate"><span class="pre">middle()</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tree</span><span class="p">,</span> <span class="n">fitness</span> <span class="o">=</span> <span class="n">middle_repairer</span><span class="o">.</span><span class="n">repair</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The returned AST <code class="docutils literal notranslate"><span class="pre">tree</span></code> can be output via <code class="docutils literal notranslate"><span class="pre">ast.unparse()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">tree</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>def middle(x, y, z):
    if y &lt; z:
        if x &lt; y:
            return y
        elif x &lt; z:
            return x
    elif x &gt; y:
        return y
    elif x &gt; z:
        return x
    return z
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">fitness</span></code> value shows how well the repaired program fits the tests. A fitness value of 1.0 shows that the repaired program satisfies all tests.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fitness</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># docassert</span>
<span class="k">assert</span> <span class="n">fitness</span> <span class="o">&gt;=</span> <span class="mf">1.0</span>
</pre></div>
</div>
</div>
</div>
<p>Hence, the above program indeed is a perfect repair in the sense that all previously failing tests now pass – our repair was successful.</p>
<p>Here are the classes defined in this chapter. A <code class="docutils literal notranslate"><span class="pre">Repairer</span></code> repairs a program, using a <code class="docutils literal notranslate"><span class="pre">StatementMutator</span></code> and a <code class="docutils literal notranslate"><span class="pre">CrossoverOperator</span></code> to evolve a population of candidates.</p>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 14.0.2 (20251019.1705)
 -->
<!-- Pages: 1 -->
<svg width="628pt" height="636pt"
 viewBox="0.00 0.00 628.00 636.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 632.25)">
<g id="a_graph0"><a xlink:title="Repairer class hierarchy">
<polygon fill="white" stroke="none" points="-4,4 -4,-632.25 623.62,-632.25 623.62,4 -4,4"/>
</a>
</g>
<!-- Repairer -->
<g id="node1" class="node">
<title>Repairer</title>
<g id="a_node1"><a xlink:href="#" xlink:title="class Repairer:&#10;A class for automatic repair of Python programs">
<polygon fill="none" stroke="black" points="15,-0.5 15,-250.5 151,-250.5 151,-0.5 15,-0.5"/>
<text xml:space="preserve" text-anchor="start" x="54.5" y="-234.2" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">Repairer</text>
<polyline fill="none" stroke="black" points="15,-225.25 151,-225.25"/>
<g id="a_node1_0"><a xlink:href="#" xlink:title="Repairer">
<g id="a_node1_1"><a xlink:href="#" xlink:title="__init__(self, debugger: StatisticalDebugger.RankingDebugger, *, targets: Optional[List[Any]] = None, sources: Optional[List[Any]] = None, log: Union[bool, int] = False, mutator_class: Type = &lt;class &#39;StatementMutator&#39;&gt;, crossover_class: Type = &lt;class &#39;CrossoverOperator&#39;&gt;, reducer_class: Type = &lt;class &#39;DeltaDebugger.DeltaDebugger&#39;&gt;, globals: Optional[Dict[str, Any]] = None):&#10;Constructor.&#10;`debugger`: a `RankingDebugger` to take tests and coverage from.&#10;`targets`: a list of functions/modules to be repaired.&#10;(default: the covered functions in `debugger`, except tests)&#10;`sources`: a list of functions/modules to take repairs from.&#10;(default: same as `targets`)&#10;`globals`: if given, a `globals()` dict for executing targets&#10;(default: `globals()` of caller)">
<text xml:space="preserve" text-anchor="start" x="23" y="-212.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node1_2"><a xlink:href="#" xlink:title="repair(self, population_size: int = 40, iterations: int = 100) &#45;&gt; Tuple[ast.AST, float]:&#10;Repair the function we collected test runs from.&#10;Use a population size of `population_size` and&#10;at most `iterations` iterations.&#10;Returns a pair (`ast`, `fitness`) where&#10;`ast` is the AST of the repaired function, and&#10;`fitness` is its fitness (between 0 and 1.0)">
<text xml:space="preserve" text-anchor="start" x="23" y="-200" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">repair()</text>
</a>
</g>
<g id="a_node1_3"><a xlink:href="#" xlink:title="default_functions(self) &#45;&gt; List[Callable]:&#10;Return the set of functions to be repaired.&#10;Functions whose names start or end in `test` are excluded.">
<text xml:space="preserve" text-anchor="start" x="23" y="-186.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">default_functions()</text>
</a>
</g>
<g id="a_node1_4"><a xlink:href="#" xlink:title="evolve(self, population: List[ast.AST]) &#45;&gt; List[ast.AST]:&#10;Evolve the candidate population by mutating and crossover.">
<text xml:space="preserve" text-anchor="start" x="23" y="-173.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">evolve()</text>
</a>
</g>
<g id="a_node1_5"><a xlink:href="#" xlink:title="fitness(self, tree: ast.AST) &#45;&gt; float:&#10;Test `tree`, returning its fitness">
<text xml:space="preserve" text-anchor="start" x="23" y="-160.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">fitness()</text>
</a>
</g>
<g id="a_node1_6"><a xlink:href="#" xlink:title="fitness_key(self, tree: ast.AST) &#45;&gt; Tuple[float, int]:&#10;Key to be used for sorting the population">
<text xml:space="preserve" text-anchor="start" x="23" y="-148" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">fitness_key()</text>
</a>
</g>
<g id="a_node1_7"><a xlink:href="#" xlink:title="getsource(self, item: Union[str, Any]) &#45;&gt; str:&#10;Get the source for `item`. Can also be a string.">
<text xml:space="preserve" text-anchor="start" x="23" y="-135.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">getsource()</text>
</a>
</g>
<g id="a_node1_8"><a xlink:href="#" xlink:title="initial_population(self, size: int) &#45;&gt; List[ast.AST]:&#10;Return an initial population of size `size`">
<text xml:space="preserve" text-anchor="start" x="23" y="-122.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">initial_population()</text>
</a>
</g>
<g id="a_node1_9"><a xlink:href="#" xlink:title="log_tree(self, description: str, tree: Any) &#45;&gt; None:&#10;Print out `tree` as source code prefixed by `description`.">
<text xml:space="preserve" text-anchor="start" x="23" y="-109.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">log_tree()</text>
</a>
</g>
<g id="a_node1_10"><a xlink:href="#" xlink:title="parse(self, items: List[Any]) &#45;&gt; ast.AST:&#10;Read in a list of items into a single tree">
<text xml:space="preserve" text-anchor="start" x="23" y="-97" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">parse()</text>
</a>
</g>
<g id="a_node1_11"><a xlink:href="#" xlink:title="reduce(self, tree: ast.AST) &#45;&gt; ast.AST:&#10;Simplify `tree` using delta debugging.">
<text xml:space="preserve" text-anchor="start" x="23" y="-84.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">reduce()</text>
</a>
</g>
<g id="a_node1_12"><a xlink:href="#" xlink:title="run_test_set(self, test_set: str, validate: bool = False) &#45;&gt; int:&#10;Run given `test_set`&#10;(`DifferenceDebugger.PASS` or `DifferenceDebugger.FAIL`).&#10;If `validate` is set, check expectations.&#10;Return number of passed tests.">
<text xml:space="preserve" text-anchor="start" x="23" y="-71.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">run_test_set()</text>
</a>
</g>
<g id="a_node1_13"><a xlink:href="#" xlink:title="run_tests(self, validate: bool = False) &#45;&gt; float:&#10;Run passing and failing tests, returning weighted fitness.">
<text xml:space="preserve" text-anchor="start" x="23" y="-58.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">run_tests()</text>
</a>
</g>
<g id="a_node1_14"><a xlink:href="#" xlink:title="test_reduce(self, source_lines: List[str], original_fitness: float) &#45;&gt; None:&#10;Test function for delta debugging.">
<text xml:space="preserve" text-anchor="start" x="23" y="-46" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">test_reduce()</text>
</a>
</g>
<g id="a_node1_15"><a xlink:href="#" xlink:title="toplevel_defs(self, tree: ast.AST) &#45;&gt; List[str]:&#10;Return a list of names of defined functions and classes in `tree`">
<text xml:space="preserve" text-anchor="start" x="23" y="-33.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">toplevel_defs()</text>
</a>
</g>
<g id="a_node1_16"><a xlink:href="#" xlink:title="validate(self) &#45;&gt; None">
<text xml:space="preserve" text-anchor="start" x="23" y="-20.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">validate()</text>
</a>
</g>
<g id="a_node1_17"><a xlink:href="#" xlink:title="weight(self, test_set: str) &#45;&gt; float:&#10;Return the weight of `test_set`&#10;(`DifferenceDebugger.PASS` or `DifferenceDebugger.FAIL`).">
<text xml:space="preserve" text-anchor="start" x="23" y="-7.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">weight()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- StackInspector -->
<g id="node2" class="node">
<title>StackInspector</title>
<g id="a_node2"><a xlink:href="StackInspector.ipynb" xlink:title="class StackInspector:&#10;Provide functions to inspect the stack">
<polygon fill="none" stroke="black" points="0,-361.62 0,-407.62 166,-407.62 166,-361.62 0,-361.62"/>
<text xml:space="preserve" text-anchor="start" x="32.75" y="-391.32" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">StackInspector</text>
<polyline fill="none" stroke="black" points="0,-382.38 166,-382.38"/>
<g id="a_node2_18"><a xlink:href="#" xlink:title="StackInspector">
<g id="a_node2_19"><a xlink:href="StackInspector.ipynb" xlink:title="_generated_function_cache = {(&#39;middle_test&#39;, 1): &lt;function middle_test at 0x113d6f880&gt;, (&#39;test_reduce&#39;, 2): &lt;function Repairer.test_reduce at 0x11422e2a0&gt;, (&#39;remove_html_markup_test&#39;, 1): &lt;function remove_html_markup_test at 0x11423c220&gt;}">
<text xml:space="preserve" text-anchor="start" x="8" y="-368.88" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">_generated_function_cache</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- Repairer&#45;&gt;StackInspector -->
<g id="edge1" class="edge">
<title>Repairer&#45;&gt;StackInspector</title>
<path fill="none" stroke="black" d="M83,-250.92C83,-287.44 83,-324.4 83,-350.01"/>
<polygon fill="none" stroke="black" points="79.5,-349.76 83,-359.76 86.5,-349.76 79.5,-349.76"/>
</g>
<!-- ConditionMutator -->
<g id="node3" class="node">
<title>ConditionMutator</title>
<g id="a_node3"><a xlink:href="#" xlink:title="class ConditionMutator:&#10;Mutate conditions in an AST">
<polygon fill="none" stroke="black" points="188.12,-83.38 188.12,-167.62 321.88,-167.62 321.88,-83.38 188.12,-83.38"/>
<text xml:space="preserve" text-anchor="start" x="196.12" y="-151.32" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">ConditionMutator</text>
<polyline fill="none" stroke="black" points="188.12,-142.38 321.88,-142.38"/>
<g id="a_node3_20"><a xlink:href="#" xlink:title="ConditionMutator">
<g id="a_node3_21"><a xlink:href="#" xlink:title="__init__(self, *args: Any, **kwargs: Any) &#45;&gt; None:&#10;Constructor. Arguments are as with `StatementMutator` constructor.">
<text xml:space="preserve" text-anchor="start" x="201" y="-129.88" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node3_22"><a xlink:href="#" xlink:title="choose_bool_op(self) &#45;&gt; str">
<text xml:space="preserve" text-anchor="start" x="201" y="-116.12" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">choose_bool_op()</text>
</a>
</g>
<g id="a_node3_23"><a xlink:href="#" xlink:title="choose_condition(self) &#45;&gt; ast.expr:&#10;Return a random condition from source.">
<text xml:space="preserve" text-anchor="start" x="201" y="-103.38" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">choose_condition()</text>
</a>
</g>
<g id="a_node3_24"><a xlink:href="#" xlink:title="swap(self, node: ast.AST) &#45;&gt; ast.AST:&#10;Replace `node` condition by a condition from `source`">
<text xml:space="preserve" text-anchor="start" x="201" y="-91.62" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">swap()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- StatementMutator -->
<g id="node4" class="node">
<title>StatementMutator</title>
<g id="a_node4"><a xlink:href="#" xlink:title="class StatementMutator:&#10;Mutate statements in an AST for automated repair.">
<polygon fill="none" stroke="black" points="184,-287.5 184,-481.75 326,-481.75 326,-287.5 184,-287.5"/>
<text xml:space="preserve" text-anchor="start" x="193.5" y="-465.45" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">StatementMutator</text>
<polyline fill="none" stroke="black" points="184,-456.5 326,-456.5"/>
<g id="a_node4_25"><a xlink:href="#" xlink:title="StatementMutator">
<g id="a_node4_26"><a xlink:href="#" xlink:title="NODE_MAX_LENGTH = 20">
<text xml:space="preserve" text-anchor="start" x="210" y="-443" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">NODE_MAX_LENGTH</text>
</a>
</g>
</a>
</g>
<polyline fill="none" stroke="black" points="184,-435.75 326,-435.75"/>
<g id="a_node4_27"><a xlink:href="#" xlink:title="StatementMutator">
<g id="a_node4_28"><a xlink:href="#" xlink:title="__init__(self, suspiciousness_func: Optional[Callable[[Tuple[Callable, int]], float]] = None, source: Optional[List[ast.AST]] = None, log: Union[bool, int] = False) &#45;&gt; None:&#10;Constructor.&#10;`suspiciousness_func` is a function that takes a location&#10;(function, line_number) and returns a suspiciousness value&#10;between 0 and 1.0. If not given, all locations get the same&#10;suspiciousness of 1.0.&#10;`source` is a list of statements to choose from.">
<text xml:space="preserve" text-anchor="start" x="192" y="-423.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node4_29"><a xlink:href="#" xlink:title="mutate(self, tree: ast.AST) &#45;&gt; ast.AST:&#10;Mutate the given AST `tree` in place. Return mutated tree.">
<text xml:space="preserve" text-anchor="start" x="192" y="-410.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">mutate()</text>
</a>
</g>
<g id="a_node4_30"><a xlink:href="#" xlink:title="choose_op(self) &#45;&gt; Callable">
<text xml:space="preserve" text-anchor="start" x="192" y="-396.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">choose_op()</text>
</a>
</g>
<g id="a_node4_31"><a xlink:href="#" xlink:title="choose_statement(self) &#45;&gt; ast.AST">
<text xml:space="preserve" text-anchor="start" x="192" y="-384" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">choose_statement()</text>
</a>
</g>
<g id="a_node4_32"><a xlink:href="#" xlink:title="delete(self, node: ast.AST) &#45;&gt; None:&#10;Delete `node`.">
<text xml:space="preserve" text-anchor="start" x="192" y="-371.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">delete()</text>
</a>
</g>
<g id="a_node4_33"><a xlink:href="#" xlink:title="format_node(self, node: ast.AST) &#45;&gt; str:&#10;Return a string representation for `node`.">
<text xml:space="preserve" text-anchor="start" x="192" y="-358.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">format_node()</text>
</a>
</g>
<g id="a_node4_34"><a xlink:href="#" xlink:title="insert(self, node: ast.AST) &#45;&gt; Union[ast.AST, List[ast.AST]]:&#10;Insert a random node from `source` after `node`">
<text xml:space="preserve" text-anchor="start" x="192" y="-345.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">insert()</text>
</a>
</g>
<g id="a_node4_35"><a xlink:href="#" xlink:title="node_suspiciousness(self, stmt: ast.AST, func_name: str) &#45;&gt; float">
<text xml:space="preserve" text-anchor="start" x="192" y="-333" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">node_suspiciousness()</text>
</a>
</g>
<g id="a_node4_36"><a xlink:href="#" xlink:title="node_to_be_mutated(self, tree: ast.AST) &#45;&gt; ast.AST">
<text xml:space="preserve" text-anchor="start" x="192" y="-320.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">node_to_be_mutated()</text>
</a>
</g>
<g id="a_node4_37"><a xlink:href="#" xlink:title="swap(self, node: ast.AST) &#45;&gt; ast.AST:&#10;Replace `node` with a random node from `source`">
<text xml:space="preserve" text-anchor="start" x="192" y="-308.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">swap()</text>
</a>
</g>
<g id="a_node4_38"><a xlink:href="#" xlink:title="visit(self, node: ast.AST) &#45;&gt; ast.AST:&#10;Visit a node.">
<text xml:space="preserve" text-anchor="start" x="192" y="-295.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">visit()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- ConditionMutator&#45;&gt;StatementMutator -->
<g id="edge2" class="edge">
<title>ConditionMutator&#45;&gt;StatementMutator</title>
<path fill="none" stroke="black" d="M255,-168.1C255,-197.33 255,-237.86 255,-275.9"/>
<polygon fill="none" stroke="black" points="251.5,-275.56 255,-285.56 258.5,-275.56 251.5,-275.56"/>
</g>
<!-- NodeTransformer -->
<g id="node5" class="node">
<title>NodeTransformer</title>
<g id="a_node5"><a xlink:href="ast.ipynb" xlink:title="class NodeTransformer:&#10;A :class:`NodeVisitor` subclass that walks the abstract syntax tree and&#10;allows modification of nodes.&#10;&#10;The `NodeTransformer` will walk the AST and use the return value of the&#10;visitor methods to replace or remove the old node. &#160;If the return value of&#10;the visitor method is ``None``, the node will be removed from its location,&#10;otherwise it is replaced with the return value. &#160;The return value may be the&#10;original node in which case no replacement takes place.&#10;&#10;Here is an example transformer that rewrites all occurrences of name lookups&#10;(``foo``) to ``data[&#39;foo&#39;]``::&#10;&#10;class RewriteName(NodeTransformer):&#10;&#10;def visit_Name(self, node):&#10;return Subscript(&#10;value=Name(id=&#39;data&#39;, ctx=Load()),&#10;slice=Constant(value=node.id),&#10;ctx=node.ctx&#10;)&#10;&#10;Keep in mind that if the node you&#39;re operating on has child nodes you must&#10;either transform the child nodes yourself or call the :meth:`generic_visit`&#10;method for the node first.&#10;&#10;For nodes that were part of a collection of statements (that applies to all&#10;statement nodes), the visitor may also return a list of nodes rather than&#10;just a single node.&#10;&#10;Usually you use the transformer like this::&#10;&#10;node = YourTransformer().visit(node)">
<polygon fill="none" stroke="black" points="189.25,-518.75 189.25,-554.75 320.75,-554.75 320.75,-518.75 189.25,-518.75"/>
<text xml:space="preserve" text-anchor="start" x="197.25" y="-533.45" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-style="italic" font-size="14.00" fill="#6a0dad">NodeTransformer</text>
</a>
</g>
</g>
<!-- StatementMutator&#45;&gt;NodeTransformer -->
<g id="edge3" class="edge">
<title>StatementMutator&#45;&gt;NodeTransformer</title>
<path fill="none" stroke="black" d="M255,-481.98C255,-491.01 255,-499.6 255,-507.15"/>
<polygon fill="none" stroke="black" points="251.5,-506.91 255,-516.91 258.5,-506.91 251.5,-506.91"/>
</g>
<!-- NodeVisitor -->
<g id="node6" class="node">
<title>NodeVisitor</title>
<g id="a_node6"><a xlink:href="ast.ipynb" xlink:title="class NodeVisitor:&#10;A node visitor base class that walks the abstract syntax tree and calls a&#10;visitor function for every node found. &#160;This function may return a value&#10;which is forwarded by the `visit` method.&#10;&#10;This class is meant to be subclassed, with the subclass adding visitor&#10;methods.&#10;&#10;Per default the visitor functions for the nodes are ``&#39;visit_&#39;`` +&#10;class name of the node. &#160;So a `TryFinally` node visit function would&#10;be `visit_TryFinally`. &#160;This behavior can be changed by overriding&#10;the `visit` method. &#160;If no visitor function exists for a node&#10;(return value `None`) the `generic_visit` visitor is used instead.&#10;&#10;Don&#39;t use the `NodeVisitor` if you want to apply changes to nodes during&#10;traversing. &#160;For this a special visitor exists (`NodeTransformer`) that&#10;allows modifications.">
<polygon fill="none" stroke="black" points="208.75,-591.75 208.75,-627.75 301.25,-627.75 301.25,-591.75 208.75,-591.75"/>
<text xml:space="preserve" text-anchor="start" x="216.75" y="-606.45" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-style="italic" font-size="14.00" fill="#6a0dad">NodeVisitor</text>
</a>
</g>
</g>
<!-- NodeTransformer&#45;&gt;NodeVisitor -->
<g id="edge4" class="edge">
<title>NodeTransformer&#45;&gt;NodeVisitor</title>
<path fill="none" stroke="black" d="M255,-554.94C255,-562.52 255,-571.65 255,-580.21"/>
<polygon fill="none" stroke="black" points="251.5,-580.21 255,-590.21 258.5,-580.21 251.5,-580.21"/>
</g>
<!-- CrossoverOperator -->
<g id="node7" class="node">
<title>CrossoverOperator</title>
<g id="a_node7"><a xlink:href="#" xlink:title="class CrossoverOperator:&#10;A class for performing statement crossover of Python programs">
<polygon fill="none" stroke="black" points="340,-60.25 340,-190.75 482,-190.75 482,-60.25 340,-60.25"/>
<text xml:space="preserve" text-anchor="start" x="348" y="-174.45" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">CrossoverOperator</text>
<polyline fill="none" stroke="black" points="340,-165.5 482,-165.5"/>
<g id="a_node7_39"><a xlink:href="#" xlink:title="CrossoverOperator">
<g id="a_node7_40"><a xlink:href="#" xlink:title="SKIP_LIST = {&lt;class &#39;ast.ClassDef&#39;&gt;, &lt;class &#39;ast.Module&#39;&gt;}">
<text xml:space="preserve" text-anchor="start" x="384" y="-152" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">SKIP_LIST</text>
</a>
</g>
</a>
</g>
<polyline fill="none" stroke="black" points="340,-144.75 482,-144.75"/>
<g id="a_node7_41"><a xlink:href="#" xlink:title="CrossoverOperator">
<g id="a_node7_42"><a xlink:href="#" xlink:title="__init__(self, log: Union[bool, int] = False):&#10;Constructor. If `log` is set, turn on logging.">
<text xml:space="preserve" text-anchor="start" x="351" y="-132.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node7_43"><a xlink:href="#" xlink:title="crossover(self, t1: ast.AST, t2: ast.AST) &#45;&gt; Tuple[ast.AST, ast.AST]:&#10;Do a crossover of ASTs `t1` and `t2`.&#10;Raises `CrossoverError` if no crossover is found.">
<text xml:space="preserve" text-anchor="start" x="351" y="-119.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">crossover()</text>
</a>
</g>
<g id="a_node7_44"><a xlink:href="#" xlink:title="can_cross(self, tree: ast.AST, body_attr: str = &#39;body&#39;) &#45;&gt; bool">
<text xml:space="preserve" text-anchor="start" x="351" y="-105.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">can_cross()</text>
</a>
</g>
<g id="a_node7_45"><a xlink:href="#" xlink:title="cross_bodies(self, body_1: List[ast.AST], body_2: List[ast.AST]) &#45;&gt; Tuple[List[ast.AST], List[ast.AST]]:&#10;Crossover the statement lists `body_1` x `body_2`. Return new lists.">
<text xml:space="preserve" text-anchor="start" x="351" y="-93" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">cross_bodies()</text>
</a>
</g>
<g id="a_node7_46"><a xlink:href="#" xlink:title="crossover_attr(self, t1: ast.AST, t2: ast.AST, body_attr: str) &#45;&gt; bool:&#10;Crossover the bodies `body_attr` of two trees `t1` and `t2`.&#10;Return True if successful.">
<text xml:space="preserve" text-anchor="start" x="351" y="-80.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">crossover_attr()</text>
</a>
</g>
<g id="a_node7_47"><a xlink:href="#" xlink:title="crossover_branches(self, t1: ast.AST, t2: ast.AST) &#45;&gt; bool:&#10;Special case:&#10;`t1` = `if P: S1 else: S2` x `t2` = `if P&#39;: S1&#39; else: S2&#39;`&#10;becomes&#10;`t1` = `if P: S2&#39; else: S1&#39;` and `t2` = `if P&#39;: S2 else: S1`&#10;Returns True if successful.">
<text xml:space="preserve" text-anchor="start" x="351" y="-67.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">crossover_branches()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- Legend -->
<g id="node8" class="node">
<title>Legend</title>
<text xml:space="preserve" text-anchor="start" x="500.38" y="-141.5" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="10.00" fill="#6a0dad">Legend</text>
<text xml:space="preserve" text-anchor="start" x="500.38" y="-131.5" font-family="Raleway, Helvetica, Arial, sans-serif" font-size="10.00">• </text>
<text xml:space="preserve" text-anchor="start" x="506.38" y="-131.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="8.00">public_method()</text>
<text xml:space="preserve" text-anchor="start" x="500.38" y="-121.5" font-family="Raleway, Helvetica, Arial, sans-serif" font-size="10.00">• </text>
<text xml:space="preserve" text-anchor="start" x="506.38" y="-121.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="8.00">private_method()</text>
<text xml:space="preserve" text-anchor="start" x="500.38" y="-111.5" font-family="Raleway, Helvetica, Arial, sans-serif" font-size="10.00">• </text>
<text xml:space="preserve" text-anchor="start" x="506.38" y="-111.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="8.00">overloaded_method()</text>
<text xml:space="preserve" text-anchor="start" x="500.38" y="-102.45" font-family="Helvetica,sans-Serif" font-size="9.00">Hover over names to see doc</text>
</g>
</g>
</svg>
</div></div>
</div>
</section>
<section id="automatic-code-repairs">
<h2>Automatic Code Repairs<a class="headerlink" href="#automatic-code-repairs" title="Link to this heading">#</a></h2>
<p>So far, we have discussed how to locate defects in code, how to track failures back to the defects that caused them, and how to systematically determine failure conditions. Let us now address the last step in debugging – namely, how to <em>automatically fix code</em>.</p>
<p>Already in the <a class="reference internal" href="Intro_Debugging.html"><span class="std std-doc">introduction to debugging</span></a>, we have discussed how to fix code manually. Notably, we have established that a <em>diagnosis</em> (which induces a fix) should show <em>causality</em> (i.e., how the defect causes the failure) and <em>incorrectness</em> (how the defect is wrong). Is it possible to obtain such a diagnosis automatically?</p>
<p>In this chapter, we introduce a technique of <em>automatic code repair</em> – that is, for a given failure, automatically determine a fix that makes the failure go away. To do so, we randomly (but systematically) <em>mutate</em> the program code – that is, insert, change, and delete fragments – until we find a change that actually causes the failing test to pass.</p>
<p>If this sounds like an audacious idea, that is because it is. But not only is <em>automated program repair</em> one of the hottest topics of software research in the last decade, it is also being increasingly deployed in industry. At Facebook, for instance, every failing test report comes with an automatically generated <em>repair suggestion</em> – a suggestion that already has been validated to work. Programmers can apply the suggestion as is or use it as basis for their own fixes.</p>
<section id="the-middle-function">
<h3>The middle() Function<a class="headerlink" href="#the-middle-function" title="Link to this heading">#</a></h3>
<p>Let us introduce our ongoing example. In the <a class="reference internal" href="StatisticalDebugger.html"><span class="std std-doc">chapter on statistical debugging</span></a>, we have introduced the <code class="docutils literal notranslate"><span class="pre">middle()</span></code> function – a function that returns the “middle” of three numbers <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, and <code class="docutils literal notranslate"><span class="pre">z</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">StatisticalDebugger</span><span class="w"> </span><span class="kn">import</span> <span class="n">middle</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>708  <span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">middle</span>(x, y, z):  <span class=" -Color -Color-White"># type: ignore</span>
709      <span class=" -Color -Color-Blue">if</span> y &lt; z:
710          <span class=" -Color -Color-Blue">if</span> x &lt; y:
711              <span class=" -Color -Color-Blue">return</span> y
712          <span class=" -Color -Color-Blue">elif</span> x &lt; z:
713              <span class=" -Color -Color-Blue">return</span> y
714      <span class=" -Color -Color-Blue">else</span>:
715          <span class=" -Color -Color-Blue">if</span> x &gt; y:
716              <span class=" -Color -Color-Blue">return</span> y
717          <span class=" -Color -Color-Blue">elif</span> x &gt; z:
718              <span class=" -Color -Color-Blue">return</span> x
719      <span class=" -Color -Color-Blue">return</span> z
</pre></div>
</div>
</div>
</div>
<p>In most cases, <code class="docutils literal notranslate"><span class="pre">middle()</span></code> just runs fine:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">middle</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5
</pre></div>
</div>
</div>
</div>
<p>In some other cases, though, it does not work correctly:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">middle</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
</div>
</div>
</section>
<section id="validated-repairs">
<h3>Validated Repairs<a class="headerlink" href="#validated-repairs" title="Link to this heading">#</a></h3>
<p>Now, if we only want a repair that fixes this one given failure, this would be very easy. All we have to do is to replace the entire body by a single statement:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">middle_sort_of_fixed</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<p>You will concur that the failure no longer occurs:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">middle_sort_of_fixed</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2
</pre></div>
</div>
</div>
</div>
<p>But this, of course, is not the aim of automatic fixes, nor of fixes in general: We want our fixes not only to make the given failure go away, but we also want the resulting code to be <em>correct</em> (which, of course, is a lot harder).</p>
<p>Automatic repair techniques therefore assume the existence of a <em>test suite</em> that can check whether an implementation satisfies its requirements. Better yet, one can use the test suite to gradually check <em>how close</em> one is to perfection: A piece of code that satisfies 99% of all tests is better than one that satisfies ~33% of all tests, as <code class="docutils literal notranslate"><span class="pre">middle_sort_of_fixed()</span></code> would do (assuming the test suite evenly checks the input space).</p>
</section>
<section id="genetic-optimization">
<h3>Genetic Optimization<a class="headerlink" href="#genetic-optimization" title="Link to this heading">#</a></h3>
<p>The common approach for automatic repair follows the principle of <em>genetic optimization</em>. Roughly spoken, genetic optimization is a <em>metaheuristic</em> inspired by the process of <em>natural selection</em>. The idea is to <em>evolve</em> a selection of <em>candidate solutions</em> towards a maximum <em>fitness</em>:</p>
<ol class="arabic simple">
<li><p>Have a selection of <em>candidates</em>.</p></li>
<li><p>Determine the <em>fitness</em> of each candidate.</p></li>
<li><p>Retain those candidates with the <em>highest fitness</em>.</p></li>
<li><p>Create new candidates from the retained candidates, by applying genetic operations:</p>
<ul class="simple">
<li><p><em>Mutation</em> mutates some aspect of a candidate.</p></li>
<li><p><em>CrossoverOperator</em> creates new candidates combining features of two candidates.</p></li>
</ul>
</li>
<li><p>Repeat until an optimal solution is found.</p></li>
</ol>
<p>Applied for automated program repair, this means the following steps:</p>
<ol class="arabic simple">
<li><p>Have a <em>test suite</em> with both failing and passing tests that helps to assert correctness of possible solutions.</p></li>
<li><p>With the test suite, use <a class="reference internal" href="StatisticalDebugger.html"><span class="std std-doc">fault localization</span></a> to determine potential code locations to be fixed.</p></li>
<li><p>Systematically <em>mutate</em> the code (by adding, changing, or deleting code) and <em>cross</em> code to create possible fix candidates.</p></li>
<li><p>Identify the <em>fittest</em> fix candidates – that is, those that satisfy the most tests.</p></li>
<li><p><em>Evolve</em> the fittest candidates until a perfect fix is found, or until time resources are depleted.</p></li>
</ol>
<p>Let us illustrate these steps in the following sections.</p>
</section>
</section>
<section id="a-test-suite">
<h2>A Test Suite<a class="headerlink" href="#a-test-suite" title="Link to this heading">#</a></h2>
<p>In automated repair, the larger and the more thorough the test suite, the higher the quality of the resulting fix (if any). Hence, if we want to repair <code class="docutils literal notranslate"><span class="pre">middle()</span></code> automatically, we need a good test suite – with good inputs, but also with good checks. Note that running the test suite commonly takes the most time of automated repair, so a large test suite also comes with extra cost.</p>
<p>Let us first focus on achieving high-quality repairs. Hence, we will use the extensive test suites introduced in the <a class="reference internal" href="StatisticalDebugger.html"><span class="std std-doc">chapter on statistical debugging</span></a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">StatisticalDebugger</span><span class="w"> </span><span class="kn">import</span> <span class="n">MIDDLE_PASSING_TESTCASES</span><span class="p">,</span> <span class="n">MIDDLE_FAILING_TESTCASES</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">middle_test()</span></code> function fails whenever <code class="docutils literal notranslate"><span class="pre">middle()</span></code> returns an incorrect result:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">middle_test</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">middle</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">m</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ExpectError</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExpectError</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">middle_test</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57510/3661663124.py&quot;, line 2, in &lt;module&gt;
    middle_test(2, 1, 3)
    ~~~~~~~~~~~^^^^^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57510/40742806.py&quot;, line 3, in middle_test
    assert m == sorted([x, y, z])[1]
           ^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError (expected)
</pre></div>
</div>
</div>
</div>
</section>
<section id="locating-the-defect">
<h2>Locating the Defect<a class="headerlink" href="#locating-the-defect" title="Link to this heading">#</a></h2>
<p>Our next step is to find potential defect locations – that is, those locations in the code our mutations should focus upon. Since we already do have two test suites, we can make use of <a class="reference internal" href="StatisticalDebugger.html"><span class="std std-doc">statistical debugging</span></a> to identify likely faulty locations.  Our <code class="docutils literal notranslate"><span class="pre">OchiaiDebugger</span></code> ranks individual code lines by how frequently they are executed in failing runs (and not in passing runs).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">StatisticalDebugger</span><span class="w"> </span><span class="kn">import</span> <span class="n">OchiaiDebugger</span><span class="p">,</span> <span class="n">RankingDebugger</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">middle_debugger</span> <span class="o">=</span> <span class="n">OchiaiDebugger</span><span class="p">()</span>

<span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">MIDDLE_PASSING_TESTCASES</span> <span class="o">+</span> <span class="n">MIDDLE_FAILING_TESTCASES</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">middle_debugger</span><span class="p">:</span>
        <span class="n">middle_test</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We see that the upper half of the <code class="docutils literal notranslate"><span class="pre">middle()</span></code> code is definitely more suspicious:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">middle_debugger</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 708:  70%"> 708 def middle(x, y, z):  # type: ignore</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 709:  70%"> 709     if y &lt; z:</pre>
<pre style="background-color:hsl(15.155513200675452, 100.0%, 80%)"
                    title="Line 710:  87%"> 710         if x &lt; y:</pre>
<pre style="background-color:hsl(120.0, 8.0%, 80%)"
                    title="Line 711:   0%"> 711             return y</pre>
<pre style="background-color:hsl(11.799643839908121, 100.0%, 80%)"
                    title="Line 712:  90%"> 712         elif x &lt; z:</pre>
<pre style="background-color:hsl(3.9916213145203594, 100.0%, 80%)"
                    title="Line 713:  96%"> 713             return y</pre>
<pre title="Line 714: not executed"> 714     else:
</pre>
<pre style="background-color:hsl(120.0, 69.0%, 80%)"
                    title="Line 715:   0%"> 715         if x &gt; y:</pre>
<pre style="background-color:hsl(120.0, 19.0%, 80%)"
                    title="Line 716:   0%"> 716             return y</pre>
<pre style="background-color:hsl(120.0, 50.0%, 80%)"
                    title="Line 717:   0%"> 717         elif x &gt; z:</pre>
<pre style="background-color:hsl(120.0, 19.0%, 80%)"
                    title="Line 718:   0%"> 718             return x</pre>
<pre style="background-color:hsl(120.0, 47.0%, 80%)"
                    title="Line 719:   0%"> 719     return z</pre>

<p/><pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 1:  70%">   1 def middle_test(x: int, y: int, z: int) -&gt; None:</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 2:  70%">   2     m = middle(x, y, z)</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 3:  70%">   3     assert m == sorted([x, y, z])[1]</pre>
</div></div>
</div>
<p>The most suspicious line is:</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>713            <span class=" -Color -Color-Blue">return</span> y
</pre></div>
</div>
</div>
</div>
<p>with a suspiciousness of:</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9667364890456637
</pre></div>
</div>
</div>
</div>
</section>
<section id="random-code-mutations">
<h2>Random Code Mutations<a class="headerlink" href="#random-code-mutations" title="Link to this heading">#</a></h2>
<p>Our third step in automatic code repair is to <em>randomly mutate the code</em>. Specifically, we want to randomly <em>delete</em>, <em>insert</em>, and <em>replace</em> statements in the program to be repaired. However, simply synthesizing code <em>from scratch</em> is unlikely to yield anything meaningful – the number of combinations is simply far too high. Already for a three-character identifier name, we have more than 200,000 combinations:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">string</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="o">*</span> \
  <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span> <span class="o">*</span> \
  <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>210357
</pre></div>
</div>
</div>
</div>
<p>Hence, we do <em>not</em> synthesize code from scratch, but instead <em>reuse</em> elements from the program to be fixed, hypothesizing that “a program that contains an error in one area likely implements the correct behavior elsewhere” \cite{LeGoues2012}. This insight has been dubbed the <em>plastic surgery hypothesis</em>: content of new code can often be assembled out of fragments of code that already exist in the code base \citeBarr2014}.</p>
<p>For our “plastic surgery”, we do not operate on a <em>textual</em> representation of the program, but rather on a <em>structural</em> representation, which by construction allows us to avoid lexical and syntactical errors in the first place.</p>
<p>This structural representation is the <em>abstract syntax tree</em> (AST), which we already have seen in various chapters, such as the <a class="reference internal" href="DeltaDebugger.html"><span class="std std-doc">chapter on delta debugging</span></a>, the <a class="reference internal" href="Tracer.html"><span class="std std-doc">chapter on tracing</span></a>, and excessively in the <a class="reference internal" href="Slicer.html"><span class="std std-doc">chapter on slicing</span></a>. The <a class="reference external" href="http://docs.python.org/3/library/ast">official Python <code class="docutils literal notranslate"><span class="pre">ast</span></code> reference</a> is complete, but a bit brief; the documentation <a class="reference external" href="https://greentreesnakes.readthedocs.io/en/latest/">“Green Tree Snakes - the missing Python AST docs”</a> provides an excellent introduction.</p>
<p>Recapitulating, an AST is a tree representation of the program, showing a hierarchical structure of the program’s elements. Here is the AST for our <code class="docutils literal notranslate"><span class="pre">middle()</span></code> function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">ast</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_content</span><span class="p">,</span> <span class="n">show_ast</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">middle_tree</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">middle</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_ast</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7159efc465b26f9b44c9f3ab5c9ae5cf1d0cec6a24edc52ac2fd6f18bc887365.svg" src="_images/7159efc465b26f9b44c9f3ab5c9ae5cf1d0cec6a24edc52ac2fd6f18bc887365.svg" />
</div>
</div>
<p>You see that it consists of one function definition (<code class="docutils literal notranslate"><span class="pre">FunctionDef</span></code>) with three <code class="docutils literal notranslate"><span class="pre">arguments</span></code> and two statements – one <code class="docutils literal notranslate"><span class="pre">If</span></code> and one <code class="docutils literal notranslate"><span class="pre">Return</span></code>. Each <code class="docutils literal notranslate"><span class="pre">If</span></code> subtree has three branches – one for the condition (<code class="docutils literal notranslate"><span class="pre">test</span></code>), one for the body to be executed if the condition is true (<code class="docutils literal notranslate"><span class="pre">body</span></code>), and one for the <code class="docutils literal notranslate"><span class="pre">else</span></code> case (<code class="docutils literal notranslate"><span class="pre">orelse</span></code>). The <code class="docutils literal notranslate"><span class="pre">body</span></code> and <code class="docutils literal notranslate"><span class="pre">orelse</span></code> branches again are lists of statements.</p>
<p>An AST can also be shown as text, which is more compact, yet reveals more information. <code class="docutils literal notranslate"><span class="pre">ast.dump()</span></code> gives not only the class names of elements, but also how they are constructed – actually, the whole expression can be used to construct an AST.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Module(body=[FunctionDef(name=&#39;middle&#39;, args=arguments(args=[arg(arg=&#39;x&#39;), arg(arg=&#39;y&#39;), arg(arg=&#39;z&#39;)]), body=[If(test=Compare(left=Name(id=&#39;y&#39;, ctx=Load()), ops=[Lt()], comparators=[Name(id=&#39;z&#39;, ctx=Load())]), body=[If(test=Compare(left=Name(id=&#39;x&#39;, ctx=Load()), ops=[Lt()], comparators=[Name(id=&#39;y&#39;, ctx=Load())]), body=[Return(value=Name(id=&#39;y&#39;, ctx=Load()))], orelse=[If(test=Compare(left=Name(id=&#39;x&#39;, ctx=Load()), ops=[Lt()], comparators=[Name(id=&#39;z&#39;, ctx=Load())]), body=[Return(value=Name(id=&#39;y&#39;, ctx=Load()))])])], orelse=[If(test=Compare(left=Name(id=&#39;x&#39;, ctx=Load()), ops=[Gt()], comparators=[Name(id=&#39;y&#39;, ctx=Load())]), body=[Return(value=Name(id=&#39;y&#39;, ctx=Load()))], orelse=[If(test=Compare(left=Name(id=&#39;x&#39;, ctx=Load()), ops=[Gt()], comparators=[Name(id=&#39;z&#39;, ctx=Load())]), body=[Return(value=Name(id=&#39;x&#39;, ctx=Load()))])])]), Return(value=Name(id=&#39;z&#39;, ctx=Load()))])])
</pre></div>
</div>
</div>
</div>
<p>This is the path to the first <code class="docutils literal notranslate"><span class="pre">return</span></code> statement:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ast</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">()</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&quot;Return(value=Name(id=&#39;y&#39;, ctx=Load()))&quot;
</pre></div>
</div>
</div>
</div>
<section id="picking-statements">
<h3>Picking Statements<a class="headerlink" href="#picking-statements" title="Link to this heading">#</a></h3>
<p>For our mutation operators, we want to use statements from the program itself. Hence, we need a means to find those very statements. The <code class="docutils literal notranslate"><span class="pre">StatementVisitor</span></code> class iterates through an AST, adding all statements it finds in function definitions to its <code class="docutils literal notranslate"><span class="pre">statements</span></code> list. To do so, it subclasses the Python <code class="docutils literal notranslate"><span class="pre">ast</span></code> <code class="docutils literal notranslate"><span class="pre">NodeVisitor</span></code> class, described in the <a class="reference external" href="http://docs.python.org/3/library/ast">official Python <code class="docutils literal notranslate"><span class="pre">ast</span></code> reference</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ast</span><span class="w"> </span><span class="kn">import</span> <span class="n">NodeVisitor</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">StatementVisitor</span><span class="p">(</span><span class="n">NodeVisitor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Visit all statements within function defs in an AST&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statements</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statements_seen</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_statements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">elems</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elems</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">elems</span> <span class="o">=</span> <span class="p">[</span><span class="n">elems</span><span class="p">]</span>  <span class="c1"># type: ignore</span>

        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">elems</span><span class="p">:</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stmt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statements_seen</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">statements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statements_seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visit_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Any node other than the ones listed below</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_statements</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_statements</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;orelse&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Module children are defs, classes and globals - don&#39;t add</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visit_ClassDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">ClassDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Class children are defs and globals - don&#39;t add</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generic_visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visit_FunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">node</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AsyncFunctionDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">visit_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visit_AsyncFunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AsyncFunctionDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit_FunctionDef</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The function <code class="docutils literal notranslate"><span class="pre">all_statements()</span></code> returns all statements in the given AST <code class="docutils literal notranslate"><span class="pre">tree</span></code>. If an <code class="docutils literal notranslate"><span class="pre">ast</span></code> class <code class="docutils literal notranslate"><span class="pre">tp</span></code> is given, it only returns instances of that class.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">all_statements_and_functions</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> 
                                 <span class="n">tp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> \
                                 <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a list of pairs (`statement`, `function`) for all statements in `tree`.</span>
<span class="sd">    If `tp` is given, return only statements of that class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">visitor</span> <span class="o">=</span> <span class="n">StatementVisitor</span><span class="p">()</span>
    <span class="n">visitor</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="n">statements</span> <span class="o">=</span> <span class="n">visitor</span><span class="o">.</span><span class="n">statements</span>
    <span class="k">if</span> <span class="n">tp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">statements</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">statements</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tp</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">statements</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">all_statements</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">tp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a list of all statements in `tree`.</span>
<span class="sd">    If `tp` is given, return only statements of that class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">stmt</span> <span class="k">for</span> <span class="n">stmt</span><span class="p">,</span> <span class="n">func_name</span> <span class="ow">in</span> <span class="n">all_statements_and_functions</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">tp</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<p>Here are all the <code class="docutils literal notranslate"><span class="pre">return</span></code> statements in <code class="docutils literal notranslate"><span class="pre">middle()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_statements</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">(),</span> <span class="n">ast</span><span class="o">.</span><span class="n">Return</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;ast.Return at 0x113ef3b10&gt;,
 &lt;ast.Return at 0x113e0e7d0&gt;,
 &lt;ast.Return at 0x113e0c3d0&gt;,
 &lt;ast.Return at 0x113ef1d90&gt;,
 &lt;ast.Return at 0x113ef0410&gt;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_statements_and_functions</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">(),</span> <span class="n">ast</span><span class="o">.</span><span class="n">If</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&lt;ast.If at 0x113e2e910&gt;, &#39;middle&#39;),
 (&lt;ast.If at 0x113e2f6d0&gt;, &#39;middle&#39;),
 (&lt;ast.If at 0x113eee410&gt;, &#39;middle&#39;),
 (&lt;ast.If at 0x113eee0d0&gt;, &#39;middle&#39;),
 (&lt;ast.If at 0x113eee890&gt;, &#39;middle&#39;)]
</pre></div>
</div>
</div>
</div>
<p>We can randomly pick an element:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">random_node</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">all_statements</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">()))</span>
<span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">random_node</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;return y&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="mutating-statements">
<h3>Mutating Statements<a class="headerlink" href="#mutating-statements" title="Link to this heading">#</a></h3>
<p>The main part in mutation, however, is to actually mutate the code of the program under test. To this end, we introduce a <code class="docutils literal notranslate"><span class="pre">StatementMutator</span></code> class – a subclass of <code class="docutils literal notranslate"><span class="pre">NodeTransformer</span></code>, described in the <a class="reference external" href="http://docs.python.org/3/library/ast">official Python <code class="docutils literal notranslate"><span class="pre">ast</span></code> reference</a>.</p>
<p>The constructor provides various keyword arguments to configure the mutator.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ast</span><span class="w"> </span><span class="kn">import</span> <span class="n">NodeTransformer</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">StatementMutator</span><span class="p">(</span><span class="n">NodeTransformer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mutate statements in an AST for automated repair.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">suspiciousness_func</span><span class="p">:</span>
                     <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">source</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">log</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor.</span>
<span class="sd">        `suspiciousness_func` is a function that takes a location</span>
<span class="sd">        (function, line_number) and returns a suspiciousness value</span>
<span class="sd">        between 0 and 1.0. If not given, all locations get the same </span>
<span class="sd">        suspiciousness of 1.0.</span>
<span class="sd">        `source` is a list of statements to choose from.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>

        <span class="k">if</span> <span class="n">suspiciousness_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">suspiciousness_func</span><span class="p">(</span><span class="n">location</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">1.0</span>
        <span class="k">assert</span> <span class="n">suspiciousness_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">suspiciousness_func</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">suspiciousness_func</span>

        <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Source for repairs #</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                <span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mutations</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
<section id="choosing-suspicious-statements-to-mutate">
<h4>Choosing Suspicious Statements to Mutate<a class="headerlink" href="#choosing-suspicious-statements-to-mutate" title="Link to this heading">#</a></h4>
<p>We start with deciding which AST nodes to mutate. The method <code class="docutils literal notranslate"><span class="pre">node_suspiciousness()</span></code> returns the suspiciousness for a given node, by invoking the suspiciousness function <code class="docutils literal notranslate"><span class="pre">suspiciousness_func</span></code> given during initialization.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">StatementMutator</span><span class="p">(</span><span class="n">StatementMutator</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">node_suspiciousness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stmt</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">func_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="s1">&#39;lineno&#39;</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">format_node</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span><span class="si">}</span><span class="s2">: Expected line number&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="n">suspiciousness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">suspiciousness_func</span><span class="p">((</span><span class="n">func_name</span><span class="p">,</span> <span class="n">stmt</span><span class="o">.</span><span class="n">lineno</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">suspiciousness</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># not executed</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="k">return</span> <span class="n">suspiciousness</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">format_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
        <span class="o">...</span>
</pre></div>
</div>
</div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">node_to_be_mutated()</span></code> picks a node (statement) to be mutated. It determines the suspiciousness of all statements, and invokes <code class="docutils literal notranslate"><span class="pre">random.choices()</span></code>, using the suspiciousness as weight. Unsuspicious statements (with zero weight) will not be chosen.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">StatementMutator</span><span class="p">(</span><span class="n">StatementMutator</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">node_to_be_mutated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="n">statements</span> <span class="o">=</span> <span class="n">all_statements_and_functions</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">statements</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;No statements&quot;</span>

        <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">node_suspiciousness</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">func_name</span><span class="p">)</span> 
                   <span class="k">for</span> <span class="n">stmt</span><span class="p">,</span> <span class="n">func_name</span> <span class="ow">in</span> <span class="n">statements</span><span class="p">]</span>
        <span class="n">stmts</span> <span class="o">=</span> <span class="p">[</span><span class="n">stmt</span> <span class="k">for</span> <span class="n">stmt</span><span class="p">,</span> <span class="n">func_name</span> <span class="ow">in</span> <span class="n">statements</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Weights:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">stmt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">statements</span><span class="p">):</span>
                <span class="n">node</span><span class="p">,</span> <span class="n">func_name</span> <span class="o">=</span> <span class="n">stmt</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">format_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="c1"># No suspicious line</span>
            <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">stmts</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">stmts</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="choosing-a-mutation-method">
<h4>Choosing a Mutation Method<a class="headerlink" href="#choosing-a-mutation-method" title="Link to this heading">#</a></h4>
<p>The method <code class="docutils literal notranslate"><span class="pre">visit()</span></code> is invoked on all nodes. For nodes marked with a <code class="docutils literal notranslate"><span class="pre">mutate_me</span></code> attribute, it randomly chooses a mutation method (<code class="docutils literal notranslate"><span class="pre">choose_op()</span></code>) and then invokes it on the node.</p>
<p>According to the rules of <code class="docutils literal notranslate"><span class="pre">NodeTransformer</span></code>, the mutation method can return</p>
<ul class="simple">
<li><p>a new node or a list of nodes, replacing the current node;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">None</span></code>, deleting it; or</p></li>
<li><p>the node itself, keeping things as they are.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RE_SPACE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[ \t\n]+&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">StatementMutator</span><span class="p">(</span><span class="n">StatementMutator</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">choose_op</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">insert</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">swap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>  <span class="c1"># Visits (and transforms?) children</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">mutate_me</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
            <span class="k">return</span> <span class="n">node</span>

        <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">choose_op</span><span class="p">()</span>
        <span class="n">new_node</span> <span class="o">=</span> <span class="n">op</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mutations</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="si">:</span><span class="s2">4</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">op</span><span class="o">.</span><span class="vm">__name__</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;:&#39;</span><span class="si">:</span><span class="s2">7</span><span class="si">}</span><span class="s2"> &quot;</span>  <span class="c1"># type: ignore</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">format_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;becomes </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">format_node</span><span class="p">(</span><span class="n">new_node</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new_node</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="swapping-statements">
<h4>Swapping Statements<a class="headerlink" href="#swapping-statements" title="Link to this heading">#</a></h4>
<p>Our first mutator is <code class="docutils literal notranslate"><span class="pre">swap()</span></code>, which replaces the current node <code class="docutils literal notranslate"><span class="pre">NODE</span></code> by a random node found in <code class="docutils literal notranslate"><span class="pre">source</span></code> (using a newly defined <code class="docutils literal notranslate"><span class="pre">choose_statement()</span></code>).</p>
<p>As a rule of thumb, we try to avoid inserting entire subtrees with all attached statements; and try to respect only the first line of a node. If the new node has the form</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">P</span><span class="p">:</span>
    <span class="n">BODY</span>
</pre></div>
</div>
<p>we thus only insert</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">P</span><span class="p">:</span> 
    <span class="k">pass</span>
</pre></div>
</div>
<p>since the statements in <code class="docutils literal notranslate"><span class="pre">BODY</span></code> have a later chance to get inserted. The same holds for all constructs that have a <code class="docutils literal notranslate"><span class="pre">BODY</span></code>, i.e. <code class="docutils literal notranslate"><span class="pre">while</span></code>, <code class="docutils literal notranslate"><span class="pre">for</span></code>, <code class="docutils literal notranslate"><span class="pre">try</span></code>, <code class="docutils literal notranslate"><span class="pre">with</span></code>, and more.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">StatementMutator</span><span class="p">(</span><span class="n">StatementMutator</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">choose_statement</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">StatementMutator</span><span class="p">(</span><span class="n">StatementMutator</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">swap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Replace `node` with a random node from `source`&quot;&quot;&quot;</span>
        <span class="n">new_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">choose_statement</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">stmt</span><span class="p">):</span>
            <span class="c1"># The source `if P: X` is added as `if P: pass`</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">):</span>
                <span class="n">new_node</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">Pass</span><span class="p">()]</span>  <span class="c1"># type: ignore</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="s1">&#39;orelse&#39;</span><span class="p">):</span>
                <span class="n">new_node</span><span class="o">.</span><span class="n">orelse</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: ignore</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="s1">&#39;finalbody&#39;</span><span class="p">):</span>
                <span class="n">new_node</span><span class="o">.</span><span class="n">finalbody</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: ignore</span>

        <span class="c1"># ast.copy_location(new_node, node)</span>
        <span class="k">return</span> <span class="n">new_node</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="inserting-statements">
<h4>Inserting Statements<a class="headerlink" href="#inserting-statements" title="Link to this heading">#</a></h4>
<p>Our next mutator is <code class="docutils literal notranslate"><span class="pre">insert()</span></code>, which randomly chooses some node from <code class="docutils literal notranslate"><span class="pre">source</span></code> and inserts it after the current node <code class="docutils literal notranslate"><span class="pre">NODE</span></code>. (If <code class="docutils literal notranslate"><span class="pre">NODE</span></code> is a <code class="docutils literal notranslate"><span class="pre">return</span></code> statement, then we insert the new node <em>before</em> <code class="docutils literal notranslate"><span class="pre">NODE</span></code>.)</p>
<p>If the statement to be inserted has the form</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">P</span><span class="p">:</span>
    <span class="n">BODY</span>
</pre></div>
</div>
<p>we only insert the “header” of the <code class="docutils literal notranslate"><span class="pre">if</span></code>, resulting in</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">P</span><span class="p">:</span> 
    <span class="n">NODE</span>
</pre></div>
</div>
<p>Again, this applies to all constructs that have a <code class="docutils literal notranslate"><span class="pre">BODY</span></code>, i.e., <code class="docutils literal notranslate"><span class="pre">while</span></code>, <code class="docutils literal notranslate"><span class="pre">for</span></code>, <code class="docutils literal notranslate"><span class="pre">try</span></code>, <code class="docutils literal notranslate"><span class="pre">with</span></code>, and more.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">StatementMutator</span><span class="p">(</span><span class="n">StatementMutator</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Insert a random node from `source` after `node`&quot;&quot;&quot;</span>
        <span class="n">new_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">choose_statement</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">stmt</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">):</span>
            <span class="c1"># Inserting `if P: X` as `if P:`</span>
            <span class="n">new_node</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="s1">&#39;orelse&#39;</span><span class="p">):</span>
                <span class="n">new_node</span><span class="o">.</span><span class="n">orelse</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: ignore</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="s1">&#39;finalbody&#39;</span><span class="p">):</span>
                <span class="n">new_node</span><span class="o">.</span><span class="n">finalbody</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: ignore</span>
            <span class="c1"># ast.copy_location(new_node, node)</span>
            <span class="k">return</span> <span class="n">new_node</span>

        <span class="c1"># Only insert before `return`, not after it</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Return</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Return</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">new_node</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">new_node</span><span class="p">,</span> <span class="n">node</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">node</span><span class="p">,</span> <span class="n">new_node</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="deleting-statements">
<h4>Deleting Statements<a class="headerlink" href="#deleting-statements" title="Link to this heading">#</a></h4>
<p>Our last mutator is <code class="docutils literal notranslate"><span class="pre">delete()</span></code>, which deletes the current node <code class="docutils literal notranslate"><span class="pre">NODE</span></code>. The standard case is to replace <code class="docutils literal notranslate"><span class="pre">NODE</span></code> by a <code class="docutils literal notranslate"><span class="pre">pass</span></code> statement.</p>
<p>If the statement to be deleted has the form</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">P</span><span class="p">:</span>
    <span class="n">BODY</span>
</pre></div>
</div>
<p>we only delete the “header” of the <code class="docutils literal notranslate"><span class="pre">if</span></code>, resulting in</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">BODY</span>
</pre></div>
</div>
<p>Again, this applies to all constructs that have a <code class="docutils literal notranslate"><span class="pre">BODY</span></code>, i.e., <code class="docutils literal notranslate"><span class="pre">while</span></code>, <code class="docutils literal notranslate"><span class="pre">for</span></code>, <code class="docutils literal notranslate"><span class="pre">try</span></code>, <code class="docutils literal notranslate"><span class="pre">with</span></code>, and more. If the statement to be deleted has multiple branches, a random branch is chosen (e.g., the <code class="docutils literal notranslate"><span class="pre">else</span></code> branch of an <code class="docutils literal notranslate"><span class="pre">if</span></code> statement).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">StatementMutator</span><span class="p">(</span><span class="n">StatementMutator</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete `node`.&quot;&quot;&quot;</span>

        <span class="n">branches</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="s1">&#39;orelse&#39;</span><span class="p">,</span> <span class="s1">&#39;finalbody&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">attr</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">branches</span><span class="p">:</span>
            <span class="c1"># Replace `if P: S` by `S`</span>
            <span class="n">branch</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span>
            <span class="n">new_node</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">branch</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">new_node</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">stmt</span><span class="p">):</span>
            <span class="c1"># Avoid empty bodies; make this a `pass` statement</span>
            <span class="n">new_node</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Pass</span><span class="p">()</span>
            <span class="n">ast</span><span class="o">.</span><span class="n">copy_location</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">new_node</span>

        <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Just delete</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">quiz</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">Why are statements replaced by <code>pass</code> rather than deleted?</div>
    </p>
    <p>
    <div class="quiz_options" title="Check all that apply.">
    
        <input type="checkbox" name="ebf0288a-b294-11f0-bc1f-6298cf1a5790" id="ebf0288a-b294-11f0-bc1f-6298cf1a5790-1" onclick="clear_selection('ebf0288a-b294-11f0-bc1f-6298cf1a5790')">
        <label id="ebf0288a-b294-11f0-bc1f-6298cf1a5790-1-label" for="ebf0288a-b294-11f0-bc1f-6298cf1a5790-1">Because <code>if P: pass</code> is valid Python, while <code>if P:</code> is not</label><br>
    
        <input type="checkbox" name="ebf0288a-b294-11f0-bc1f-6298cf1a5790" id="ebf0288a-b294-11f0-bc1f-6298cf1a5790-2" onclick="clear_selection('ebf0288a-b294-11f0-bc1f-6298cf1a5790')">
        <label id="ebf0288a-b294-11f0-bc1f-6298cf1a5790-2-label" for="ebf0288a-b294-11f0-bc1f-6298cf1a5790-2">Because in Python, bodies for <code>if</code>, <code>while</code>, etc. cannot be empty</label><br>
    
        <input type="checkbox" name="ebf0288a-b294-11f0-bc1f-6298cf1a5790" id="ebf0288a-b294-11f0-bc1f-6298cf1a5790-3" onclick="clear_selection('ebf0288a-b294-11f0-bc1f-6298cf1a5790')">
        <label id="ebf0288a-b294-11f0-bc1f-6298cf1a5790-3-label" for="ebf0288a-b294-11f0-bc1f-6298cf1a5790-3">Because a <code>pass</code> node makes a target for future mutations</label><br>
    
        <input type="checkbox" name="ebf0288a-b294-11f0-bc1f-6298cf1a5790" id="ebf0288a-b294-11f0-bc1f-6298cf1a5790-4" onclick="clear_selection('ebf0288a-b294-11f0-bc1f-6298cf1a5790')">
        <label id="ebf0288a-b294-11f0-bc1f-6298cf1a5790-4-label" for="ebf0288a-b294-11f0-bc1f-6298cf1a5790-4">Because it causes the tests to pass</label><br>
    
    </div>
    </p>
    <input id="ebf0288a-b294-11f0-bc1f-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('ebf0288a-b294-11f0-bc1f-6298cf1a5790', 14, 1, '[3 ^ n for n in range(3)]')">
    <span class="quiz_hint" id="ebf0288a-b294-11f0-bc1f-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
<p>Indeed, Python’s <code class="docutils literal notranslate"><span class="pre">compile()</span></code> will fail if any of the bodies is an empty list. Also, it leaves us a statement that can be evolved further.</p>
</section>
<section id="helpers">
<h4>Helpers<a class="headerlink" href="#helpers" title="Link to this heading">#</a></h4>
<p>For logging purposes, we introduce a helper function <code class="docutils literal notranslate"><span class="pre">format_node()</span></code> that returns a short string representation of the node.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">StatementMutator</span><span class="p">(</span><span class="n">StatementMutator</span><span class="p">):</span>
    <span class="n">NODE_MAX_LENGTH</span> <span class="o">=</span> <span class="mi">20</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">format_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a string representation for `node`.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;None&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_node</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">node</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">RE_SPACE</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">node</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">NODE_MAX_LENGTH</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">NODE_MAX_LENGTH</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="all-together">
<h4>All Together<a class="headerlink" href="#all-together" title="Link to this heading">#</a></h4>
<p>Let us now create the main entry point, which is <code class="docutils literal notranslate"><span class="pre">mutate()</span></code>. It picks the node to be mutated and marks it with a <code class="docutils literal notranslate"><span class="pre">mutate_me</span></code> attribute. By calling <code class="docutils literal notranslate"><span class="pre">visit()</span></code>, it then sets off the <code class="docutils literal notranslate"><span class="pre">NodeTransformer</span></code> transformation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">StatementMutator</span><span class="p">(</span><span class="n">StatementMutator</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mutate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mutate the given AST `tree` in place. Return mutated tree.&quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">all_statements</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
            <span class="n">node</span><span class="o">.</span><span class="n">mutate_me</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># type: ignore</span>

        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_to_be_mutated</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">mutate_me</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># type: ignore</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mutations</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mutations</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No mutations found&quot;</span><span class="p">)</span>

        <span class="n">ast</span><span class="o">.</span><span class="n">fix_missing_locations</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tree</span>
</pre></div>
</div>
</div>
</div>
<p>Here are a number of transformations applied by <code class="docutils literal notranslate"><span class="pre">StatementMutator</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mutator</span> <span class="o">=</span> <span class="n">StatementMutator</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">new_tree</span> <span class="o">=</span> <span class="n">mutator</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   9:insert: &#39;return y&#39; becomes &#39;return y&#39;
   8:insert: &#39;if x &gt; y: return y e...&#39; becomes &#39;if x &lt; y: if x &gt; y: ...&#39;
  12:insert: &#39;return z&#39; becomes &#39;if y &lt; z: return z...&#39;
   3:swap:   &#39;if x &lt; y: return y e...&#39; becomes &#39;return x&#39;
   3:swap:   &#39;if x &lt; y: return y e...&#39; becomes &#39;return z&#39;
   3:swap:   &#39;if x &lt; y: return y e...&#39; becomes &#39;return x&#39;
  11:swap:   &#39;return x&#39; becomes &#39;return y&#39;
  10:insert: &#39;if x &gt; z: return x...&#39; becomes &#39;if x &gt; z: return x...&#39;; &#39;return z&#39;
  12:delete: &#39;return z&#39; becomes &#39;pass&#39;
   8:swap:   &#39;if x &gt; y: return y e...&#39; becomes &#39;if y &lt; z: pass&#39;
</pre></div>
</div>
</div>
</div>
<p>This is the effect of the last mutator applied on <code class="docutils literal notranslate"><span class="pre">middle</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">new_tree</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">middle</span>(x, y, z):
    <span class=" -Color -Color-Blue">if</span> y &lt; z:
        <span class=" -Color -Color-Blue">if</span> x &lt; y:
            <span class=" -Color -Color-Blue">return</span> y
        <span class=" -Color -Color-Blue">elif</span> x &lt; z:
            <span class=" -Color -Color-Blue">return</span> y
    <span class=" -Color -Color-Blue">elif</span> y &lt; z:
        <span class=" -Color -Color-Blue">pass</span>
    <span class=" -Color -Color-Blue">return</span> z
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="fitness">
<h2>Fitness<a class="headerlink" href="#fitness" title="Link to this heading">#</a></h2>
<p>Now that we can apply random mutations to code, let us find out how good these mutations are. Given our test suites for <code class="docutils literal notranslate"><span class="pre">middle</span></code>, we can check for a given code candidate how many of the previously passing test cases it passes, and how many of the failing test cases it passes. The more tests pass, the higher the <em>fitness</em> of the candidate.</p>
<p>Not all passing tests have the same value, though. We want to prevent <em>regressions</em> – that is, having a fix that breaks a previously passing test. The values of <code class="docutils literal notranslate"><span class="pre">WEIGHT_PASSING</span></code> and <code class="docutils literal notranslate"><span class="pre">WEIGHT_FAILING</span></code> set the relative weight (or importance) of passing vs. failing tests; we see that keeping passing tests passing is far more important than fixing failing tests.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">WEIGHT_PASSING</span> <span class="o">=</span> <span class="mf">0.99</span>
<span class="n">WEIGHT_FAILING</span> <span class="o">=</span> <span class="mf">0.01</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">middle_fitness</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute fitness of a `middle()` candidate given in `tree`&quot;&quot;&quot;</span>
    <span class="n">original_middle</span> <span class="o">=</span> <span class="n">middle</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">tree</span><span class="p">),</span> <span class="s1">&#39;&lt;fitness&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>  <span class="c1"># Compilation error</span>

    <span class="n">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>

    <span class="n">passing_passed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">failing_passed</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Test how many of the passing runs pass</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">MIDDLE_PASSING_TESTCASES</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">middle_test</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
            <span class="n">passing_passed</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="n">passing_ratio</span> <span class="o">=</span> <span class="n">passing_passed</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">MIDDLE_PASSING_TESTCASES</span><span class="p">)</span>

    <span class="c1"># Test how many of the failing runs pass</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">MIDDLE_FAILING_TESTCASES</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">middle_test</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
            <span class="n">failing_passed</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="n">failing_ratio</span> <span class="o">=</span> <span class="n">failing_passed</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">MIDDLE_FAILING_TESTCASES</span><span class="p">)</span>

    <span class="n">fitness</span> <span class="o">=</span> <span class="p">(</span><span class="n">WEIGHT_PASSING</span> <span class="o">*</span> <span class="n">passing_ratio</span> <span class="o">+</span>
               <span class="n">WEIGHT_FAILING</span> <span class="o">*</span> <span class="n">failing_ratio</span><span class="p">)</span>

    <span class="nb">globals</span><span class="p">()[</span><span class="s1">&#39;middle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_middle</span>
    <span class="k">return</span> <span class="n">fitness</span>
</pre></div>
</div>
</div>
</div>
<p>Our faulty <code class="docutils literal notranslate"><span class="pre">middle()</span></code> program has a fitness of <code class="docutils literal notranslate"><span class="pre">WEIGHT_PASSING</span></code> (99%), because it passes all the passing tests (but none of the failing ones).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">middle_fitness</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.99
</pre></div>
</div>
</div>
</div>
<p>Our “sort of fixed” version of <code class="docutils literal notranslate"><span class="pre">middle()</span></code> gets a much lower fitness:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">middle_fitness</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;def middle(x, y, z): return x&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.4258
</pre></div>
</div>
</div>
</div>
<p>In the <a class="reference internal" href="StatisticalDebugger.html"><span class="doc std std-doc">chapter on statistical debugging</span></a>, we also defined a fixed version of <code class="docutils literal notranslate"><span class="pre">middle()</span></code>. This gets a fitness of 1.0, passing all tests. (We won’t use this fixed version for automated repairs.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">StatisticalDebugger</span><span class="w"> </span><span class="kn">import</span> <span class="n">middle_fixed</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">middle_fixed_source</span> <span class="o">=</span> \
    <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">middle_fixed</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;middle_fixed&#39;</span><span class="p">,</span> <span class="s1">&#39;middle&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">middle_fitness</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">middle_fixed_source</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0
</pre></div>
</div>
</div>
</div>
</section>
<section id="population">
<h2>Population<a class="headerlink" href="#population" title="Link to this heading">#</a></h2>
<p>We now set up a <em>population</em> of fix candidates to evolve over time.  A higher population size will yield more candidates to check, but also need more time to test; a lower population size will yield fewer candidates, but allow for more evolution steps.  We choose a population size of 40 (from \cite{LeGoues2012}).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">POPULATION_SIZE</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">middle_mutator</span> <span class="o">=</span> <span class="n">StatementMutator</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">MIDDLE_POPULATION</span> <span class="o">=</span> <span class="p">[</span><span class="n">middle_tree</span><span class="p">()]</span> <span class="o">+</span> \
    <span class="p">[</span><span class="n">middle_mutator</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">())</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">POPULATION_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<p>We sort the fix candidates according to their fitness. This actually runs all tests on all candidates.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">MIDDLE_POPULATION</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">middle_fitness</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The candidate with the highest fitness is still our original (faulty) <code class="docutils literal notranslate"><span class="pre">middle()</span></code> code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">MIDDLE_POPULATION</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
      <span class="n">middle_fitness</span><span class="p">(</span><span class="n">MIDDLE_POPULATION</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>def middle(x, y, z):
    if y &lt; z:
        if x &lt; y:
            return y
        elif x &lt; z:
            return y
    elif x &gt; y:
        return y
    elif x &gt; z:
        return x
    return z 0.99
</pre></div>
</div>
</div>
</div>
<p>At the other end of the spectrum, the candidate with the lowest fitness has some vital functionality removed:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">MIDDLE_POPULATION</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
      <span class="n">middle_fitness</span><span class="p">(</span><span class="n">MIDDLE_POPULATION</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>def middle(x, y, z):
    if y &lt; z:
        if x &lt; y:
            return y
        elif x &lt; z:
            return y
    else:
        return y
    return z 0.5445
</pre></div>
</div>
</div>
</div>
</section>
<section id="evolution">
<h2>Evolution<a class="headerlink" href="#evolution" title="Link to this heading">#</a></h2>
<p>To evolve our population of candidates, we fill up the population with mutations created from the population, using a <code class="docutils literal notranslate"><span class="pre">StatementMutator</span></code> as described above to create these mutations. Then we reduce the population to its original size, keeping the fittest candidates.</p>
<!-- TODO: shouldn't there be some kind of randomness to also keep sometimes candidates with lesser fitness? --><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">evolve_middle</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">MIDDLE_POPULATION</span>

    <span class="n">source</span> <span class="o">=</span> <span class="n">all_statements</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">())</span>
    <span class="n">mutator</span> <span class="o">=</span> <span class="n">StatementMutator</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">MIDDLE_POPULATION</span><span class="p">)</span>

    <span class="n">offspring</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">offspring</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">MIDDLE_POPULATION</span><span class="p">)</span>
        <span class="n">offspring</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mutator</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span>

    <span class="n">MIDDLE_POPULATION</span> <span class="o">+=</span> <span class="n">offspring</span>
    <span class="n">MIDDLE_POPULATION</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">middle_fitness</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">MIDDLE_POPULATION</span> <span class="o">=</span> <span class="n">MIDDLE_POPULATION</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>This is what happens when evolving our population for the first time; the original source is still our best candidate.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evolve_middle</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tree</span> <span class="o">=</span> <span class="n">MIDDLE_POPULATION</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">tree</span><span class="p">),</span> <span class="n">middle_fitness</span><span class="p">(</span><span class="n">tree</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>def middle(x, y, z):
    if y &lt; z:
        if x &lt; y:
            return y
        elif x &lt; z:
            return y
    elif x &gt; y:
        return y
    elif x &gt; z:
        return x
    return z 0.99
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># docassert</span>
<span class="k">assert</span> <span class="n">middle_fitness</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0</span>
</pre></div>
</div>
</div>
</div>
<p>However, nothing keeps us from evolving for a few generations more…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
    <span class="n">evolve_middle</span><span class="p">()</span>
    <span class="n">best_middle_tree</span> <span class="o">=</span> <span class="n">MIDDLE_POPULATION</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">fitness</span> <span class="o">=</span> <span class="n">middle_fitness</span><span class="p">(</span><span class="n">best_middle_tree</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">Iteration </span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">2</span><span class="si">}</span><span class="s2">: fitness = </span><span class="si">{</span><span class="n">fitness</span><span class="si">}</span><span class="s2">  &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fitness</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="k">break</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration  0: fitness = 0.99  
Iteration  1: fitness = 1.0  
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># docassert</span>
<span class="k">assert</span> <span class="n">middle_fitness</span><span class="p">(</span><span class="n">best_middle_tree</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">1.0</span>
</pre></div>
</div>
</div>
</div>
<p>Success! We find a candidate that actually passes all tests, including the failing ones. Here is the candidate:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">best_middle_tree</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="n">start_line_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 1  <span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">middle</span>(x, y, z):
 2      <span class=" -Color -Color-Blue">if</span> y &lt; z:
 3          <span class=" -Color -Color-Blue">if</span> x &lt; y:
 4              <span class=" -Color -Color-Blue">if</span> x &lt; z:
 5                  <span class=" -Color -Color-Blue">return</span> y
 6          <span class=" -Color -Color-Blue">elif</span> x &lt; z:
 7              <span class=" -Color -Color-Blue">return</span> x
 8      <span class=" -Color -Color-Blue">elif</span> x &gt; y:
 9          <span class=" -Color -Color-Blue">return</span> y
10      <span class=" -Color -Color-Blue">else</span>:
11          <span class=" -Color -Color-Blue">if</span> x &gt; z:
12              <span class=" -Color -Color-Blue">return</span> x
13          <span class=" -Color -Color-Blue">return</span> z
14      <span class=" -Color -Color-Blue">return</span> z
</pre></div>
</div>
</div>
</div>
<p>… and yes, it passes all tests:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">original_middle</span> <span class="o">=</span> <span class="n">middle</span>
<span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">best_middle_tree</span><span class="p">),</span> <span class="s1">&#39;&lt;string&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
<span class="n">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>

<span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">MIDDLE_PASSING_TESTCASES</span> <span class="o">+</span> <span class="n">MIDDLE_FAILING_TESTCASES</span><span class="p">:</span>
    <span class="n">middle_test</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

<span class="n">middle</span> <span class="o">=</span> <span class="n">original_middle</span>
</pre></div>
</div>
</div>
</div>
<p>As the code is already validated by hundreds of test cases, it is very valuable for the programmer. Even if the programmer decides not to use the code as is, the location gives very strong hints on which code to examine and where to apply a fix.</p>
<p>However, a closer look at our fix candidate shows that there is some amount of redundancy – that is, superfluous statements.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">Some of the lines in our fix candidate are redundant. Which are these?</div>
    </p>
    <p>
    <div class="quiz_options" title="Check all that apply.">
    
        <input type="checkbox" name="ec1212e2-b294-11f0-bc1f-6298cf1a5790" id="ec1212e2-b294-11f0-bc1f-6298cf1a5790-1" onclick="clear_selection('ec1212e2-b294-11f0-bc1f-6298cf1a5790')">
        <label id="ec1212e2-b294-11f0-bc1f-6298cf1a5790-1-label" for="ec1212e2-b294-11f0-bc1f-6298cf1a5790-1">Line 3: <code>if x &lt; y:</code></label><br>
    
        <input type="checkbox" name="ec1212e2-b294-11f0-bc1f-6298cf1a5790" id="ec1212e2-b294-11f0-bc1f-6298cf1a5790-2" onclick="clear_selection('ec1212e2-b294-11f0-bc1f-6298cf1a5790')">
        <label id="ec1212e2-b294-11f0-bc1f-6298cf1a5790-2-label" for="ec1212e2-b294-11f0-bc1f-6298cf1a5790-2">Line 4: <code>if x &lt; z:</code></label><br>
    
        <input type="checkbox" name="ec1212e2-b294-11f0-bc1f-6298cf1a5790" id="ec1212e2-b294-11f0-bc1f-6298cf1a5790-3" onclick="clear_selection('ec1212e2-b294-11f0-bc1f-6298cf1a5790')">
        <label id="ec1212e2-b294-11f0-bc1f-6298cf1a5790-3-label" for="ec1212e2-b294-11f0-bc1f-6298cf1a5790-3">Line 5: <code>return y</code></label><br>
    
        <input type="checkbox" name="ec1212e2-b294-11f0-bc1f-6298cf1a5790" id="ec1212e2-b294-11f0-bc1f-6298cf1a5790-4" onclick="clear_selection('ec1212e2-b294-11f0-bc1f-6298cf1a5790')">
        <label id="ec1212e2-b294-11f0-bc1f-6298cf1a5790-4-label" for="ec1212e2-b294-11f0-bc1f-6298cf1a5790-4">Line 13: <code>return z</code></label><br>
    
    </div>
    </p>
    <input id="ec1212e2-b294-11f0-bc1f-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('ec1212e2-b294-11f0-bc1f-6298cf1a5790', 20, 1, '[eval(chr(100 - x)) for x in [48, 50]]')">
    <span class="quiz_hint" id="ec1212e2-b294-11f0-bc1f-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
</section>
<section id="simplifying">
<h2>Simplifying<a class="headerlink" href="#simplifying" title="Link to this heading">#</a></h2>
<p>As demonstrated in the chapter on <a class="reference internal" href="DeltaDebugger.html"><span class="std std-doc">reducing failure-inducing inputs</span></a>, we can use delta debugging on code to get rid of these superfluous statements.</p>
<p>The trick for simplification is to have the test function (<code class="docutils literal notranslate"><span class="pre">test_middle_lines()</span></code>) declare a fitness of 1.0 as a “failure”. Delta debugging will then simplify the input as long as the “failure” (and hence the maximum fitness obtained) persists.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">DeltaDebugger</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeltaDebugger</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">middle_lines</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">best_middle_tree</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">test_middle_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">middle_fitness</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0</span>  <span class="c1"># &quot;Fail&quot; only while fitness is 1.0</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">DeltaDebugger</span><span class="p">()</span> <span class="k">as</span> <span class="n">dd</span><span class="p">:</span>
    <span class="n">test_middle_lines</span><span class="p">(</span><span class="n">middle_lines</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reduced_lines</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">min_args</span><span class="p">()[</span><span class="s1">&#39;lines&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reduced_source</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reduced_lines</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">repaired_source</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">reduced_source</span><span class="p">))</span>  <span class="c1"># normalize</span>
<span class="n">print_content</span><span class="p">(</span><span class="n">repaired_source</span><span class="p">,</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">middle</span>(x, y, z):
    <span class=" -Color -Color-Blue">if</span> y &lt; z:
        <span class=" -Color -Color-Blue">if</span> x &lt; y:
            <span class=" -Color -Color-Blue">return</span> y
        <span class=" -Color -Color-Blue">elif</span> x &lt; z:
            <span class=" -Color -Color-Blue">return</span> x
    <span class=" -Color -Color-Blue">elif</span> x &gt; y:
        <span class=" -Color -Color-Blue">return</span> y
    <span class=" -Color -Color-Blue">elif</span> x &gt; z:
        <span class=" -Color -Color-Blue">return</span> x
    <span class=" -Color -Color-Blue">return</span> z
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># docassert</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">reduced_lines</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">middle_lines</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Success! Delta Debugging has eliminated the superfluous statements. We can present the difference to the original as a patch:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">original_source</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">middle_source</span><span class="p">))</span>  <span class="c1"># normalize</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ChangeDebugger</span><span class="w"> </span><span class="kn">import</span> <span class="n">diff</span><span class="p">,</span> <span class="n">print_patch</span>  <span class="c1"># minor dependency</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">(</span><span class="n">original_source</span><span class="p">,</span> <span class="n">repaired_source</span><span class="p">):</span>
    <span class="n">print_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>@@ -<span class=" -Color -Color-Blue">87</span>,<span class=" -Color -Color-Blue">37</span> +<span class=" -Color -Color-Blue">87</span>,<span class=" -Color -Color-Blue">37</span> @@
  x &lt; z:

-            <span class=" -Color -Color-Blue">return</span> y

+            <span class=" -Color -Color-Blue">return</span> x

     <span class=" -Color -Color-Blue">elif</span>
</pre></div>
</div>
</div>
</div>
<p>We can present this patch to the programmer, who will then immediately know what to fix in the <code class="docutils literal notranslate"><span class="pre">middle()</span></code> code.</p>
</section>
<section id="crossover">
<h2>Crossover<a class="headerlink" href="#crossover" title="Link to this heading">#</a></h2>
<p>So far, we have only applied one kind of genetic operators – mutation. There is a second one, though, also inspired by natural selection.</p>
<p>The <em>crossover</em> operation mutates two strands of genes, as illustrated in the following picture. We have two parents (red and blue), each as a sequence of genes. To create “crossed” children, we pick a <em>crossover point</em> and exchange the strands at this very point:</p>
<p><img alt="" src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/56/OnePointCrossover.svg/500px-OnePointCrossover.svg.png" /></p>
<p>We implement a <code class="docutils literal notranslate"><span class="pre">CrossoverOperator</span></code> class that implements such an operation on two randomly chosen statement lists of two programs. It is used as</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">crossover</span> <span class="o">=</span> <span class="n">CrossoverOperator</span><span class="p">()</span>
<span class="n">crossover</span><span class="o">.</span><span class="n">crossover</span><span class="p">(</span><span class="n">tree_p1</span><span class="p">,</span> <span class="n">tree_p2</span><span class="p">)</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">tree_p1</span></code> and <code class="docutils literal notranslate"><span class="pre">tree_p2</span></code> are two ASTs that are changed in place.</p>
<section id="excursion-implementing-crossover">
<h3>Excursion: Implementing Crossover<a class="headerlink" href="#excursion-implementing-crossover" title="Link to this heading">#</a></h3>
<section id="crossing-statement-lists">
<h4>Crossing Statement Lists<a class="headerlink" href="#crossing-statement-lists" title="Link to this heading">#</a></h4>
<p>Applied on programs, a crossover mutation takes two parents and “crosses” a list of statements. As an example, if our “parents” <code class="docutils literal notranslate"><span class="pre">p1()</span></code> and <code class="docutils literal notranslate"><span class="pre">p2()</span></code> are defined as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">p1</span><span class="p">():</span>  <span class="c1"># type: ignore</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">p2</span><span class="p">():</span>  <span class="c1"># type: ignore</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>
</div>
</div>
</div>
<p>Then a crossover operation would produce one child with a body</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">y</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">z</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>
</div>
<p>and another child with a body</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>
</div>
<p>We can easily implement this in a <code class="docutils literal notranslate"><span class="pre">CrossoverOperator</span></code> class in a method <code class="docutils literal notranslate"><span class="pre">cross_bodies()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CrossoverOperator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class for performing statement crossover of Python programs&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor. If `log` is set, turn on logging.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cross_bodies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body_1</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">],</span> <span class="n">body_2</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">])</span> <span class="o">-&gt;</span> \
        <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Crossover the statement lists `body_1` x `body_2`. Return new lists.&quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body_1</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body_2</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>

        <span class="n">crossover_point_1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">body_1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">crossover_point_2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">body_2</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">body_1</span><span class="p">[:</span><span class="n">crossover_point_1</span><span class="p">]</span> <span class="o">+</span> <span class="n">body_2</span><span class="p">[</span><span class="n">crossover_point_2</span><span class="p">:],</span>
                <span class="n">body_2</span><span class="p">[:</span><span class="n">crossover_point_2</span><span class="p">]</span> <span class="o">+</span> <span class="n">body_1</span><span class="p">[</span><span class="n">crossover_point_1</span><span class="p">:])</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s the <code class="docutils literal notranslate"><span class="pre">CrossoverOperatorMutator</span></code> applied on <code class="docutils literal notranslate"><span class="pre">p1</span></code> and <code class="docutils literal notranslate"><span class="pre">p2</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tree_p1</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">p1</span><span class="p">))</span>
<span class="n">tree_p2</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">p2</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">body_p1</span> <span class="o">=</span> <span class="n">tree_p1</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">body</span>  <span class="c1"># type: ignore</span>
<span class="n">body_p2</span> <span class="o">=</span> <span class="n">tree_p2</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">body</span>  <span class="c1"># type: ignore</span>
<span class="n">body_p1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;ast.Assign at 0x114013990&gt;,
 &lt;ast.Assign at 0x114008210&gt;,
 &lt;ast.Assign at 0x114010b10&gt;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crosser</span> <span class="o">=</span> <span class="n">CrossoverOperator</span><span class="p">()</span>
<span class="n">tree_p1</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">tree_p2</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">crosser</span><span class="o">.</span><span class="n">cross_bodies</span><span class="p">(</span><span class="n">body_p1</span><span class="p">,</span> <span class="n">body_p2</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">tree_p1</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">p1</span>():
    a = <span class=" -Color -Color-Blue">1</span>
    y = <span class=" -Color -Color-Blue">2</span>
    z = <span class=" -Color -Color-Blue">3</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">tree_p2</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">p2</span>():
    x = <span class=" -Color -Color-Blue">1</span>
    b = <span class=" -Color -Color-Blue">2</span>
    c = <span class=" -Color -Color-Blue">3</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="applying-crossover-on-programs">
<h4>Applying Crossover on Programs<a class="headerlink" href="#applying-crossover-on-programs" title="Link to this heading">#</a></h4>
<p>Applying the crossover operation on arbitrary programs is a bit more complex, though. We first have to <em>find</em> lists of statements that we actually can cross over. The <code class="docutils literal notranslate"><span class="pre">can_cross()</span></code> method returns True if we have a list of statements that we can cross. Python modules and classes are excluded, because changing the ordering of definitions will not have much impact on the program functionality, other than introducing errors due to  dependencies.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CrossoverOperator</span><span class="p">(</span><span class="n">CrossoverOperator</span><span class="p">):</span>
    <span class="c1"># In modules and class defs, the ordering of elements does not matter (much)</span>
    <span class="n">SKIP_LIST</span> <span class="o">=</span> <span class="p">{</span><span class="n">ast</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">ClassDef</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">can_cross</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">body_attr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;body&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span> <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SKIP_LIST</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">body</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">body_attr</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">return</span> <span class="n">body</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<p>Here comes our method <code class="docutils literal notranslate"><span class="pre">crossover_attr()</span></code> which searches for crossover possibilities. It takes two ASTs <code class="docutils literal notranslate"><span class="pre">t1</span></code> and <code class="docutils literal notranslate"><span class="pre">t2</span></code> and an attribute (typically <code class="docutils literal notranslate"><span class="pre">'body'</span></code>) and retrieves the attribute lists <span class="math notranslate nohighlight">\(l_1\)</span> (from <code class="docutils literal notranslate"><span class="pre">t1.&lt;attr&gt;</span></code>) and <span class="math notranslate nohighlight">\(l_2\)</span> (from <code class="docutils literal notranslate"><span class="pre">t2.&lt;attr&gt;</span></code>).</p>
<p>If <span class="math notranslate nohighlight">\(l_1\)</span> and <span class="math notranslate nohighlight">\(l_2\)</span> can be crossed, it crosses them, and is done. Otherwise</p>
<ul class="simple">
<li><p>If there is a pair of elements <span class="math notranslate nohighlight">\(e_1 \in l_1\)</span> and <span class="math notranslate nohighlight">\(e_2 \in l_2\)</span> that has the same name – say, functions of the same name –, it applies itself to <span class="math notranslate nohighlight">\(e_1\)</span> and <span class="math notranslate nohighlight">\(e_2\)</span>.</p></li>
<li><p>Otherwise, it creates random pairs of elements <span class="math notranslate nohighlight">\(e_1 \in l_1\)</span> and <span class="math notranslate nohighlight">\(e_2 \in l_2\)</span> and applies itself on these very pairs.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">crossover_attr()</span></code> changes <code class="docutils literal notranslate"><span class="pre">t1</span></code> and <code class="docutils literal notranslate"><span class="pre">t2</span></code> in place and returns True if a crossover was found; it returns False otherwise.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CrossoverOperator</span><span class="p">(</span><span class="n">CrossoverOperator</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">crossover_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">t2</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">body_attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Crossover the bodies `body_attr` of two trees `t1` and `t2`.</span>
<span class="sd">        Return True if successful.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body_attr</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">body_attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">body_attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crossover_branches</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checking </span><span class="si">{</span><span class="n">t1</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">body_attr</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">t2</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">body_attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">body_1</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">body_attr</span><span class="p">)</span>
        <span class="n">body_2</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">body_attr</span><span class="p">)</span>

        <span class="c1"># If both trees have the attribute, we can cross their bodies</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_cross</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">body_attr</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_cross</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">body_attr</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Crossing </span><span class="si">{</span><span class="n">t1</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">body_attr</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">t2</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">body_attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">new_body_1</span><span class="p">,</span> <span class="n">new_body_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_bodies</span><span class="p">(</span><span class="n">body_1</span><span class="p">,</span> <span class="n">body_2</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">body_attr</span><span class="p">,</span> <span class="n">new_body_1</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">body_attr</span><span class="p">,</span> <span class="n">new_body_2</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Strategy 1: Find matches in class/function of same name</span>
        <span class="k">for</span> <span class="n">child_1</span> <span class="ow">in</span> <span class="n">body_1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">child_1</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">child_2</span> <span class="ow">in</span> <span class="n">body_2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">child_2</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="ow">and</span>
                           <span class="n">child_1</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">child_2</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crossover_attr</span><span class="p">(</span><span class="n">child_1</span><span class="p">,</span> <span class="n">child_2</span><span class="p">,</span> <span class="n">body_attr</span><span class="p">):</span>
                            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Strategy 2: Find matches anywhere</span>
        <span class="k">for</span> <span class="n">child_1</span> <span class="ow">in</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">body_1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">body_1</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">child_2</span> <span class="ow">in</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">body_2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">body_2</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crossover_attr</span><span class="p">(</span><span class="n">child_1</span><span class="p">,</span> <span class="n">child_2</span><span class="p">,</span> <span class="n">body_attr</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<p>We have a special case for <code class="docutils literal notranslate"><span class="pre">if</span></code> nodes, where we can cross their body and <code class="docutils literal notranslate"><span class="pre">else</span></code> branches. (In Python, <code class="docutils literal notranslate"><span class="pre">for</span></code> and <code class="docutils literal notranslate"><span class="pre">while</span></code> also have <code class="docutils literal notranslate"><span class="pre">else</span></code> branches, but swapping these with loop bodies is likely to create havoc.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CrossoverOperator</span><span class="p">(</span><span class="n">CrossoverOperator</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">crossover_branches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">t2</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Special case:</span>
<span class="sd">        `t1` = `if P: S1 else: S2` x `t2` = `if P&#39;: S1&#39; else: S2&#39;`</span>
<span class="sd">        becomes</span>
<span class="sd">        `t1` = `if P: S2&#39; else: S1&#39;` and `t2` = `if P&#39;: S2 else: S1`</span>
<span class="sd">        Returns True if successful.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="s1">&#39;orelse&#39;</span><span class="p">)</span> <span class="ow">and</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="s1">&#39;orelse&#39;</span><span class="p">)):</span>

            <span class="n">t1</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">If</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>  <span class="c1"># keep mypy happy</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">If</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Crossing branches </span><span class="si">{</span><span class="n">t1</span><span class="si">}</span><span class="s2"> x </span><span class="si">{</span><span class="n">t2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">t1</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">t1</span><span class="o">.</span><span class="n">orelse</span><span class="p">,</span> <span class="n">t2</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">t2</span><span class="o">.</span><span class="n">orelse</span> <span class="o">=</span> \
                <span class="n">t2</span><span class="o">.</span><span class="n">orelse</span><span class="p">,</span> <span class="n">t2</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">t1</span><span class="o">.</span><span class="n">orelse</span><span class="p">,</span> <span class="n">t1</span><span class="o">.</span><span class="n">body</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">crossover()</span></code> is the main entry point. It checks for the special <code class="docutils literal notranslate"><span class="pre">if</span></code> case as described above; if not, it searches for possible crossover points. It raises <code class="docutils literal notranslate"><span class="pre">CrossoverError</span></code> if not successful.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CrossoverOperator</span><span class="p">(</span><span class="n">CrossoverOperator</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">crossover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">t2</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Do a crossover of ASTs `t1` and `t2`.</span>
<span class="sd">        Raises `CrossoverError` if no crossover is found.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">body_attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="s1">&#39;orelse&#39;</span><span class="p">,</span> <span class="s1">&#39;finalbody&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crossover_attr</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">body_attr</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span>

        <span class="k">raise</span> <span class="n">CrossoverError</span><span class="p">(</span><span class="s2">&quot;No crossover found&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CrossoverError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="end-of-excursion">
<h3>End of Excursion<a class="headerlink" href="#end-of-excursion" title="Link to this heading">#</a></h3>
</section>
<section id="crossover-in-action">
<h3>Crossover in Action<a class="headerlink" href="#crossover-in-action" title="Link to this heading">#</a></h3>
<p>Let us put our <code class="docutils literal notranslate"><span class="pre">CrossoverOperator</span></code> in action. Here is a test case for crossover, involving more deeply nested structures:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">p1</span><span class="p">():</span>  <span class="c1"># type: ignore</span>
    <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">p2</span><span class="p">():</span>  <span class="c1"># type: ignore</span>
    <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We invoke the <code class="docutils literal notranslate"><span class="pre">crossover()</span></code> method with two ASTs from <code class="docutils literal notranslate"><span class="pre">p1</span></code> and <code class="docutils literal notranslate"><span class="pre">p2</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crossover</span> <span class="o">=</span> <span class="n">CrossoverOperator</span><span class="p">()</span>
<span class="n">tree_p1</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">p1</span><span class="p">))</span>
<span class="n">tree_p2</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">p2</span><span class="p">))</span>
<span class="n">crossover</span><span class="o">.</span><span class="n">crossover</span><span class="p">(</span><span class="n">tree_p1</span><span class="p">,</span> <span class="n">tree_p2</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>Here is the crossed offspring, mixing statement lists of <code class="docutils literal notranslate"><span class="pre">p1</span></code> and <code class="docutils literal notranslate"><span class="pre">p2</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">tree_p1</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">p1</span>():
    <span class=" -Color -Color-Blue">if</span> <span class=" -Color -Color-Blue">True</span>:
        <span class=" -Color -Color-Cyan">print</span>(c)
        <span class=" -Color -Color-Cyan">print</span>(d)
    <span class=" -Color -Color-Blue">else</span>:
        <span class=" -Color -Color-Cyan">print</span>(a)
        <span class=" -Color -Color-Cyan">print</span>(b)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">tree_p2</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">p2</span>():
    <span class=" -Color -Color-Blue">if</span> <span class=" -Color -Color-Blue">True</span>:
    <span class=" -Color -Color-Blue">else</span>:
        <span class=" -Color -Color-Cyan">print</span>(<span class=" -Color -Color-Blue">1</span>)
        <span class=" -Color -Color-Cyan">print</span>(<span class=" -Color -Color-Blue">2</span>)
        <span class=" -Color -Color-Cyan">print</span>(<span class=" -Color -Color-Blue">3</span>)
</pre></div>
</div>
</div>
</div>
<p>Here is our special case for <code class="docutils literal notranslate"><span class="pre">if</span></code> nodes in action, crossing our <code class="docutils literal notranslate"><span class="pre">middle()</span></code> tree with <code class="docutils literal notranslate"><span class="pre">p2</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">middle_t1</span><span class="p">,</span> <span class="n">middle_t2</span> <span class="o">=</span> <span class="n">crossover</span><span class="o">.</span><span class="n">crossover</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">(),</span>
                                          <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">p2</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<p>We see how the resulting offspring encompasses elements of both sources:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">middle_t1</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">middle</span>(x, y, z):
    <span class=" -Color -Color-Blue">if</span> y &lt; z:
        <span class=" -Color -Color-Cyan">print</span>(c)
        <span class=" -Color -Color-Cyan">print</span>(d)
    <span class=" -Color -Color-Blue">else</span>:
        <span class=" -Color -Color-Cyan">print</span>(a)
        <span class=" -Color -Color-Cyan">print</span>(b)
    <span class=" -Color -Color-Blue">return</span> z
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">middle_t2</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">p2</span>():
    <span class=" -Color -Color-Blue">if</span> <span class=" -Color -Color-Blue">True</span>:
        <span class=" -Color -Color-Blue">if</span> x &gt; y:
            <span class=" -Color -Color-Blue">return</span> y
        <span class=" -Color -Color-Blue">elif</span> x &gt; z:
            <span class=" -Color -Color-Blue">return</span> x
    <span class=" -Color -Color-Blue">elif</span> x &lt; y:
        <span class=" -Color -Color-Blue">return</span> y
    <span class=" -Color -Color-Blue">elif</span> x &lt; z:
        <span class=" -Color -Color-Blue">return</span> y
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="a-repairer-class">
<h2>A Repairer Class<a class="headerlink" href="#a-repairer-class" title="Link to this heading">#</a></h2>
<p>So far, we have applied all our techniques on the <code class="docutils literal notranslate"><span class="pre">middle()</span></code> program only. Let us now create a <code class="docutils literal notranslate"><span class="pre">Repairer</span></code> class that applies automatic program repair on arbitrary Python programs. The idea is that you can apply it on some statistical debugger, for which you have gathered passing and failing test cases, and then invoke its <code class="docutils literal notranslate"><span class="pre">repair()</span></code> method to find a “best” fix candidate:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">debugger</span> <span class="o">=</span> <span class="n">OchiaiDebugger</span><span class="p">()</span>
<span class="k">with</span> <span class="n">debugger</span><span class="p">:</span>
    <span class="o">&lt;</span><span class="n">passing</span> <span class="n">test</span><span class="o">&gt;</span>
<span class="k">with</span> <span class="n">debugger</span><span class="p">:</span>
    <span class="o">&lt;</span><span class="n">failing</span> <span class="n">test</span><span class="o">&gt;</span>
<span class="o">...</span>
<span class="n">repairer</span> <span class="o">=</span> <span class="n">Repairer</span><span class="p">(</span><span class="n">debugger</span><span class="p">)</span>
<span class="n">repairer</span><span class="o">.</span><span class="n">repair</span><span class="p">()</span>
</pre></div>
</div>
<section id="excursion-implementing-repairer">
<h3>Excursion: Implementing Repairer<a class="headerlink" href="#excursion-implementing-repairer" title="Link to this heading">#</a></h3>
<p>The main argument to the <code class="docutils literal notranslate"><span class="pre">Repairer</span></code> constructor is the <code class="docutils literal notranslate"><span class="pre">debugger</span></code> to get information from. On top of that, it also allows customizing the classes used for mutation, crossover, and reduction.
Setting <code class="docutils literal notranslate"><span class="pre">targets</span></code> allows defining a set of functions to repair; setting <code class="docutils literal notranslate"><span class="pre">sources</span></code> allows setting a set of sources to take repairs from.
The constructor then sets up the environment for running tests and repairing, as described below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">StackInspector</span><span class="w"> </span><span class="kn">import</span> <span class="n">StackInspector</span>  <span class="c1"># minor dependency</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Repairer</span><span class="p">(</span><span class="n">StackInspector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class for automatic repair of Python programs&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">debugger</span><span class="p">:</span> <span class="n">RankingDebugger</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                 <span class="n">targets</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">sources</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">log</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">mutator_class</span><span class="p">:</span> <span class="n">Type</span> <span class="o">=</span> <span class="n">StatementMutator</span><span class="p">,</span>
                 <span class="n">crossover_class</span><span class="p">:</span> <span class="n">Type</span> <span class="o">=</span> <span class="n">CrossoverOperator</span><span class="p">,</span>
                 <span class="n">reducer_class</span><span class="p">:</span> <span class="n">Type</span> <span class="o">=</span> <span class="n">DeltaDebugger</span><span class="p">,</span>
                 <span class="nb">globals</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor.</span>
<span class="sd">`debugger`: a `RankingDebugger` to take tests and coverage from.</span>
<span class="sd">`targets`: a list of functions/modules to be repaired.</span>
<span class="sd">    (default: the covered functions in `debugger`, except tests)</span>
<span class="sd">`sources`: a list of functions/modules to take repairs from.</span>
<span class="sd">    (default: same as `targets`)</span>
<span class="sd">`globals`: if given, a `globals()` dict for executing targets</span>
<span class="sd">    (default: `globals()` of caller)&quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">debugger</span><span class="p">,</span> <span class="n">RankingDebugger</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugger</span> <span class="o">=</span> <span class="n">debugger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>

        <span class="k">if</span> <span class="n">targets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_functions</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">targets</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No targets to repair&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_functions</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sources</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No sources to take repairs from&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">function</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Multiple entry points observed&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">target_tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_tree</span><span class="p">(</span><span class="s2">&quot;Target code to be repaired:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_tree</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ast</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_tree</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ast</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_tree</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_tree</span><span class="p">(</span><span class="s2">&quot;Source code to take repairs from:&quot;</span><span class="p">,</span> 
                          <span class="bp">self</span><span class="o">.</span><span class="n">source_tree</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fitness_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mutator</span><span class="p">:</span> <span class="n">StatementMutator</span> <span class="o">=</span> \
            <span class="n">mutator_class</span><span class="p">(</span>
                <span class="n">source</span><span class="o">=</span><span class="n">all_statements</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_tree</span><span class="p">),</span>
                <span class="n">suspiciousness_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">suspiciousness</span><span class="p">,</span>
                <span class="n">log</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crossover</span><span class="p">:</span> <span class="n">CrossoverOperator</span> <span class="o">=</span> <span class="n">crossover_class</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reducer</span><span class="p">:</span> <span class="n">DeltaDebugger</span> <span class="o">=</span> <span class="n">reducer_class</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">globals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">globals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller_globals</span><span class="p">()</span>  <span class="c1"># see below</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">globals</span> <span class="o">=</span> <span class="nb">globals</span>
</pre></div>
</div>
</div>
</div>
<p>When we access or execute functions, we do so in the  caller’s environment, not ours. The <code class="docutils literal notranslate"><span class="pre">caller_globals()</span></code> method from <code class="docutils literal notranslate"><span class="pre">StackInspector</span></code> acts as replacement for <code class="docutils literal notranslate"><span class="pre">globals()</span></code>.</p>
<section id="helper-functions">
<h4>Helper Functions<a class="headerlink" href="#helper-functions" title="Link to this heading">#</a></h4>
<p>The constructor uses a number of helper functions to create its environment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Repairer</span><span class="p">(</span><span class="n">Repairer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">getsource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the source for `item`. Can also be a string.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Repairer</span><span class="p">(</span><span class="n">Repairer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">default_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the set of functions to be repaired.</span>
<span class="sd">        Functions whose names start or end in `test` are excluded.&quot;&quot;&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">is_test</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">func</span> <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">covered_functions</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_test</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Repairer</span><span class="p">(</span><span class="n">Repairer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">log_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print out `tree` as source code prefixed by `description`.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
            <span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">tree</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Repairer</span><span class="p">(</span><span class="n">Repairer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read in a list of items into a single tree&quot;&quot;&quot;</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

            <span class="n">item_lines</span><span class="p">,</span> <span class="n">item_first_lineno</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcelines</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">item_tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">item_lines</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">IndentationError</span><span class="p">:</span>
                <span class="c1"># inner function or likewise</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can&#39;t parse </span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">ast</span><span class="o">.</span><span class="n">increment_lineno</span><span class="p">(</span><span class="n">item_tree</span><span class="p">,</span> <span class="n">item_first_lineno</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">tree</span><span class="o">.</span><span class="n">body</span> <span class="o">+=</span> <span class="n">item_tree</span><span class="o">.</span><span class="n">body</span>

        <span class="k">return</span> <span class="n">tree</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="running-tests">
<h4>Running Tests<a class="headerlink" href="#running-tests" title="Link to this heading">#</a></h4>
<p>Now that we have set the environment for <code class="docutils literal notranslate"><span class="pre">Repairer</span></code>, we can implement one step of automatic repair after the other. The method <code class="docutils literal notranslate"><span class="pre">run_test_set()</span></code> runs the given <code class="docutils literal notranslate"><span class="pre">test_set</span></code> (<code class="docutils literal notranslate"><span class="pre">DifferenceDebugger.PASS</span></code> or <code class="docutils literal notranslate"><span class="pre">DifferenceDebugger.FAIL</span></code>), returning the number of passed tests. If <code class="docutils literal notranslate"><span class="pre">validate</span></code> is set, it checks whether the outcomes are as expected.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Repairer</span><span class="p">(</span><span class="n">Repairer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_test_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_set</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">validate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run given `test_set`</span>
<span class="sd">        (`DifferenceDebugger.PASS` or `DifferenceDebugger.FAIL`).</span>
<span class="sd">        If `validate` is set, check expectations.</span>
<span class="sd">        Return number of passed tests.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">passed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">collectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">collectors</span><span class="p">[</span><span class="n">test_set</span><span class="p">]</span>
        <span class="n">function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">function</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="c1"># FIXME: function may have been redefined</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">collectors</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing </span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">()</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">function</span><span class="p">(</span><span class="o">**</span><span class="n">c</span><span class="o">.</span><span class="n">args</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;failed (</span><span class="si">{</span><span class="n">err</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">test_set</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">PASS</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">err</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">()</span><span class="si">}</span><span class="s2"> should have passed, but failed&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">passed</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;passed&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">test_set</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">FAIL</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FailureNotReproducedError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">()</span><span class="si">}</span><span class="s2"> should have failed, but passed&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">passed</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">FailureNotReproducedError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<p>Here is how we use <code class="docutils literal notranslate"><span class="pre">run_tests_set()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">repairer</span> <span class="o">=</span> <span class="n">Repairer</span><span class="p">(</span><span class="n">middle_debugger</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">repairer</span><span class="o">.</span><span class="n">run_test_set</span><span class="p">(</span><span class="n">middle_debugger</span><span class="o">.</span><span class="n">PASS</span><span class="p">)</span> <span class="o">==</span> \
    <span class="nb">len</span><span class="p">(</span><span class="n">MIDDLE_PASSING_TESTCASES</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">repairer</span><span class="o">.</span><span class="n">run_test_set</span><span class="p">(</span><span class="n">middle_debugger</span><span class="o">.</span><span class="n">FAIL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">run_tests()</span></code> runs passing and failing tests, weighing the passed test cases to obtain the overall fitness.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Repairer</span><span class="p">(</span><span class="n">Repairer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_set</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the weight of `test_set`</span>
<span class="sd">        (`DifferenceDebugger.PASS` or `DifferenceDebugger.FAIL`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">PASS</span><span class="p">:</span> <span class="n">WEIGHT_PASSING</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">FAIL</span><span class="p">:</span> <span class="n">WEIGHT_FAILING</span>
        <span class="p">}[</span><span class="n">test_set</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run passing and failing tests, returning weighted fitness.&quot;&quot;&quot;</span>
        <span class="n">fitness</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">for</span> <span class="n">test_set</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">PASS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">FAIL</span><span class="p">]:</span>
            <span class="n">passed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_test_set</span><span class="p">(</span><span class="n">test_set</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">)</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">passed</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">collectors</span><span class="p">[</span><span class="n">test_set</span><span class="p">])</span>
            <span class="n">fitness</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">(</span><span class="n">test_set</span><span class="p">)</span> <span class="o">*</span> <span class="n">ratio</span>

        <span class="k">return</span> <span class="n">fitness</span>
</pre></div>
</div>
</div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">validate()</span></code> ensures the observed tests can be adequately reproduced.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Repairer</span><span class="p">(</span><span class="n">Repairer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fitness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_tests</span><span class="p">(</span><span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">fitness</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">PASS</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">repairer</span> <span class="o">=</span> <span class="n">Repairer</span><span class="p">(</span><span class="n">middle_debugger</span><span class="p">)</span>
<span class="n">repairer</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="re-defining-functions">
<h4>(Re)defining Functions<a class="headerlink" href="#re-defining-functions" title="Link to this heading">#</a></h4>
<p>Our <code class="docutils literal notranslate"><span class="pre">run_tests()</span></code> methods above do not yet redefine the function to be repaired. This is done by the <code class="docutils literal notranslate"><span class="pre">fitness()</span></code> function, which compiles and defines the given repair candidate <code class="docutils literal notranslate"><span class="pre">tree</span></code> before testing it.  It caches and returns the fitness.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Repairer</span><span class="p">(</span><span class="n">Repairer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fitness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test `tree`, returning its fitness&quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">tree</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitness_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitness_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># Save defs</span>
        <span class="n">original_defs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">toplevel_defs</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">:</span>
                <span class="n">original_defs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Couldn&#39;t find definition of </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">original_defs</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Couldn&#39;t find any definition&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Repair candidate:&quot;</span><span class="p">)</span>
            <span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">tree</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>

        <span class="c1"># Create new definition</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">tree</span><span class="p">),</span> <span class="s1">&#39;&lt;Repairer&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span class="c1"># Compilation error</span>
            <span class="n">code</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fitness = 0.0 (compilation error)&quot;</span><span class="p">)</span>

            <span class="n">fitness</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">return</span> <span class="n">fitness</span>

        <span class="c1"># Execute new code, defining new functions in `self.globals`</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">)</span>

        <span class="c1"># Set new definitions in the namespace (`__globals__`)</span>
        <span class="c1"># of the function we will be calling.</span>
        <span class="n">function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">function</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="s1">&#39;__globals__&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">original_defs</span><span class="p">:</span>
            <span class="n">function</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>  <span class="c1"># type: ignore</span>

        <span class="n">fitness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_tests</span><span class="p">(</span><span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Restore definitions</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">original_defs</span><span class="p">:</span>
            <span class="n">function</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_defs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_defs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fitness = </span><span class="si">{</span><span class="n">fitness</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fitness_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fitness</span>
        <span class="k">return</span> <span class="n">fitness</span>
</pre></div>
</div>
</div>
</div>
<p>The helper function <code class="docutils literal notranslate"><span class="pre">toplevel_defs()</span></code> helps to save and restore the environment before and after redefining the function under repair.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Repairer</span><span class="p">(</span><span class="n">Repairer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">toplevel_defs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list of names of defined functions and classes in `tree`&quot;&quot;&quot;</span>
        <span class="n">visitor</span> <span class="o">=</span> <span class="n">DefinitionVisitor</span><span class="p">()</span>
        <span class="n">visitor</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">visitor</span><span class="p">,</span> <span class="s1">&#39;definitions&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="n">definitions</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DefinitionVisitor</span><span class="p">(</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">definitions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">ClassDef</span><span class="p">,</span> 
                                         <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">,</span> 
                                         <span class="n">ast</span><span class="o">.</span><span class="n">AsyncFunctionDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">definitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visit_FunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_definition</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visit_AsyncFunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AsyncFunctionDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_definition</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visit_ClassDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">ClassDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_definition</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s an example for <code class="docutils literal notranslate"><span class="pre">fitness()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">repairer</span> <span class="o">=</span> <span class="n">Repairer</span><span class="p">(</span><span class="n">middle_debugger</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Target code to be repaired:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">middle</span>(x, y, z):
    <span class=" -Color -Color-Blue">if</span> y &lt; z:
        <span class=" -Color -Color-Blue">if</span> x &lt; y:
            <span class=" -Color -Color-Blue">return</span> y
        <span class=" -Color -Color-Blue">elif</span> x &lt; z:
            <span class=" -Color -Color-Blue">return</span> y
    <span class=" -Color -Color-Blue">elif</span> x &gt; y:
        <span class=" -Color -Color-Blue">return</span> y
    <span class=" -Color -Color-Blue">elif</span> x &gt; z:
        <span class=" -Color -Color-Blue">return</span> x
    <span class=" -Color -Color-Blue">return</span> z
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">good_fitness</span> <span class="o">=</span> <span class="n">repairer</span><span class="o">.</span><span class="n">fitness</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">())</span>
<span class="n">good_fitness</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.99
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># docassert</span>
<span class="k">assert</span> <span class="n">good_fitness</span> <span class="o">&gt;=</span> <span class="mf">0.99</span><span class="p">,</span> <span class="s2">&quot;fitness() failed&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bad_middle_tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;def middle(x, y, z): return x&quot;</span><span class="p">)</span>
<span class="n">bad_fitness</span> <span class="o">=</span> <span class="n">repairer</span><span class="o">.</span><span class="n">fitness</span><span class="p">(</span><span class="n">bad_middle_tree</span><span class="p">)</span>
<span class="n">bad_fitness</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.4258
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># docassert</span>
<span class="k">assert</span> <span class="n">bad_fitness</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;fitness() failed&quot;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="repairing">
<h4>Repairing<a class="headerlink" href="#repairing" title="Link to this heading">#</a></h4>
<p>Now for the actual <code class="docutils literal notranslate"><span class="pre">repair()</span></code> method, which creates a <code class="docutils literal notranslate"><span class="pre">population</span></code> and then evolves it until the fitness is 1.0 or the given number of iterations is spent.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Repairer</span><span class="p">(</span><span class="n">Repairer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">initial_population</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return an initial population of size `size`&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_tree</span><span class="p">]</span> <span class="o">+</span> \
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mutator</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_tree</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">repair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">POPULATION_SIZE</span><span class="p">,</span> <span class="n">iterations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> \
        <span class="n">Tuple</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Repair the function we collected test runs from.</span>
<span class="sd">        Use a population size of `population_size` and</span>
<span class="sd">        at most `iterations` iterations.</span>
<span class="sd">        Returns a pair (`ast`, `fitness`) where </span>
<span class="sd">        `ast` is the AST of the repaired function, and</span>
<span class="sd">        `fitness` is its fitness (between 0 and 1.0)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

        <span class="n">population</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_population</span><span class="p">(</span><span class="n">population_size</span><span class="p">)</span>

        <span class="n">last_key</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_tree</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
            <span class="n">population</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evolve</span><span class="p">(</span><span class="n">population</span><span class="p">)</span>

            <span class="n">best_tree</span> <span class="o">=</span> <span class="n">population</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fitness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitness</span><span class="p">(</span><span class="n">best_tree</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Evolving population: &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;iteration</span><span class="si">{</span><span class="n">iteration</span><span class="si">:</span><span class="s2">4</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">iterations</span><span class="si">}</span><span class="s2"> &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;fitness = </span><span class="si">{</span><span class="n">fitness</span><span class="si">:</span><span class="s2">.5</span><span class="si">}</span><span class="s2">   </span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">best_key</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">best_tree</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">best_key</span> <span class="o">!=</span> <span class="n">last_key</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">()</span>
                    <span class="nb">print</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log_tree</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New best code (fitness = </span><span class="si">{</span><span class="n">fitness</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span>
                                  <span class="n">best_tree</span><span class="p">)</span>
                    <span class="n">last_key</span> <span class="o">=</span> <span class="n">best_key</span>

            <span class="k">if</span> <span class="n">fitness</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_tree</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best code (fitness = </span><span class="si">{</span><span class="n">fitness</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span> <span class="n">best_tree</span><span class="p">)</span>

        <span class="n">best_tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">best_tree</span><span class="p">)</span>
        <span class="n">fitness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitness</span><span class="p">(</span><span class="n">best_tree</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_tree</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reduced code (fitness = </span><span class="si">{</span><span class="n">fitness</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">,</span> <span class="n">best_tree</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">best_tree</span><span class="p">,</span> <span class="n">fitness</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="evolving">
<h4>Evolving<a class="headerlink" href="#evolving" title="Link to this heading">#</a></h4>
<p>The evolution of our population takes place in the <code class="docutils literal notranslate"><span class="pre">evolve()</span></code> method. In contrast to the <code class="docutils literal notranslate"><span class="pre">evolve_middle()</span></code> function, above, we use crossover to create the offspring, which we still mutate afterwards.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Repairer</span><span class="p">(</span><span class="n">Repairer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">evolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evolve the candidate population by mutating and crossover.&quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">population</span><span class="p">)</span>

        <span class="c1"># Create offspring as crossover of parents</span>
        <span class="n">offspring</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">offspring</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">parent_1</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">population</span><span class="p">))</span>
            <span class="n">parent_2</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">population</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">crossover</span><span class="o">.</span><span class="n">crossover</span><span class="p">(</span><span class="n">parent_1</span><span class="p">,</span> <span class="n">parent_2</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">CrossoverError</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c1"># Just keep parents</span>
            <span class="n">offspring</span> <span class="o">+=</span> <span class="p">[</span><span class="n">parent_1</span><span class="p">,</span> <span class="n">parent_2</span><span class="p">]</span>

        <span class="c1"># Mutate offspring</span>
        <span class="n">offspring</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mutator</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">offspring</span><span class="p">]</span>

        <span class="c1"># Add it to population</span>
        <span class="n">population</span> <span class="o">+=</span> <span class="n">offspring</span>

        <span class="c1"># Keep the fitter part of the population</span>
        <span class="n">population</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fitness_key</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">population</span> <span class="o">=</span> <span class="n">population</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">population</span>
</pre></div>
</div>
</div>
</div>
<p>A second difference is that we not only sort by fitness, but also by tree size – with equal fitness, a smaller tree thus will be favored. This helps keeping fixes and patches small.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Repairer</span><span class="p">(</span><span class="n">Repairer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fitness_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Key to be used for sorting the population&quot;&quot;&quot;</span>
        <span class="n">tree_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tree</span><span class="p">)])</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitness</span><span class="p">(</span><span class="n">tree</span><span class="p">),</span> <span class="o">-</span><span class="n">tree_size</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id1">
<h4>Simplifying<a class="headerlink" href="#id1" title="Link to this heading">#</a></h4>
<p>The last step in repairing is simplifying the code. As demonstrated in the chapter on <a class="reference internal" href="DeltaDebugger.html"><span class="std std-doc">reducing failure-inducing inputs</span></a>, we can use delta debugging on code to get rid of superfluous statements. To this end, we convert the tree to lines, run delta debugging on them, and then convert it back to a tree.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Repairer</span><span class="p">(</span><span class="n">Repairer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simplify `tree` using delta debugging.&quot;&quot;&quot;</span>

        <span class="n">original_fitness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitness</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="n">source_lines</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">reducer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_reduce</span><span class="p">(</span><span class="n">source_lines</span><span class="p">,</span> <span class="n">original_fitness</span><span class="p">)</span>

        <span class="n">reduced_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reducer</span><span class="o">.</span><span class="n">min_args</span><span class="p">()[</span><span class="s1">&#39;source_lines&#39;</span><span class="p">]</span>
        <span class="n">reduced_source</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reduced_lines</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">reduced_source</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>As dicussed above, we simplify the code by having the test function (<code class="docutils literal notranslate"><span class="pre">test_reduce()</span></code>) declare reaching the maximum fitness obtained so far as a “failure”. Delta debugging will then simplify the input as long as the “failure” (and hence the maximum fitness obtained) persists.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Repairer</span><span class="p">(</span><span class="n">Repairer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_lines</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">original_fitness</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test function for delta debugging.&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source_lines</span><span class="p">)</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
            <span class="n">fitness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitness</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">fitness</span> <span class="o">&lt;</span> <span class="n">original_fitness</span>

        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">IndentationError</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># traceback.print_exc()  # Uncomment to see internal errors</span>
            <span class="k">raise</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id2">
<h3>End of Excursion<a class="headerlink" href="#id2" title="Link to this heading">#</a></h3>
</section>
<section id="repairer-in-action">
<h3>Repairer in Action<a class="headerlink" href="#repairer-in-action" title="Link to this heading">#</a></h3>
<p>Let us go and apply <code class="docutils literal notranslate"><span class="pre">Repairer</span></code> in practice. We initialize it with <code class="docutils literal notranslate"><span class="pre">middle_debugger</span></code>, which has (still) collected the passing and failing runs for <code class="docutils literal notranslate"><span class="pre">middle_test()</span></code>. We also set <code class="docutils literal notranslate"><span class="pre">log</span></code> for some diagnostics along the way.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">repairer</span> <span class="o">=</span> <span class="n">Repairer</span><span class="p">(</span><span class="n">middle_debugger</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Target code to be repaired:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">middle</span>(x, y, z):
    <span class=" -Color -Color-Blue">if</span> y &lt; z:
        <span class=" -Color -Color-Blue">if</span> x &lt; y:
            <span class=" -Color -Color-Blue">return</span> y
        <span class=" -Color -Color-Blue">elif</span> x &lt; z:
            <span class=" -Color -Color-Blue">return</span> y
    <span class=" -Color -Color-Blue">elif</span> x &gt; y:
        <span class=" -Color -Color-Blue">return</span> y
    <span class=" -Color -Color-Blue">elif</span> x &gt; z:
        <span class=" -Color -Color-Blue">return</span> x
    <span class=" -Color -Color-Blue">return</span> z
</pre></div>
</div>
</div>
</div>
<p>We now invoke <code class="docutils literal notranslate"><span class="pre">repair()</span></code> to evolve our population. After a few iterations, we find a tree with perfect fitness.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_tree</span><span class="p">,</span> <span class="n">fitness</span> <span class="o">=</span> <span class="n">repairer</span><span class="o">.</span><span class="n">repair</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration   0/100 fitness = 1.0   
Best code (fitness = 1.0):
<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">middle</span>(x, y, z):
    <span class=" -Color -Color-Blue">if</span> y &lt; z:
        <span class=" -Color -Color-Blue">if</span> x &lt; y:
            <span class=" -Color -Color-Blue">return</span> y
        <span class=" -Color -Color-Blue">elif</span> x &lt; z:
            <span class=" -Color -Color-Blue">return</span> x
    <span class=" -Color -Color-Blue">elif</span> x &gt; y:
        <span class=" -Color -Color-Blue">return</span> y
    <span class=" -Color -Color-Blue">elif</span> x &gt; z:
        <span class=" -Color -Color-Blue">return</span> x
    <span class=" -Color -Color-Blue">return</span> z

Reduced code (fitness = 1.0):
<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">middle</span>(x, y, z):
    <span class=" -Color -Color-Blue">if</span> y &lt; z:
        <span class=" -Color -Color-Blue">if</span> x &lt; y:
            <span class=" -Color -Color-Blue">return</span> y
        <span class=" -Color -Color-Blue">elif</span> x &lt; z:
            <span class=" -Color -Color-Blue">return</span> x
    <span class=" -Color -Color-Blue">elif</span> x &gt; y:
        <span class=" -Color -Color-Blue">return</span> y
    <span class=" -Color -Color-Blue">elif</span> x &gt; z:
        <span class=" -Color -Color-Blue">return</span> x
    <span class=" -Color -Color-Blue">return</span> z
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">best_tree</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">middle</span>(x, y, z):
    <span class=" -Color -Color-Blue">if</span> y &lt; z:
        <span class=" -Color -Color-Blue">if</span> x &lt; y:
            <span class=" -Color -Color-Blue">return</span> y
        <span class=" -Color -Color-Blue">elif</span> x &lt; z:
            <span class=" -Color -Color-Blue">return</span> x
    <span class=" -Color -Color-Blue">elif</span> x &gt; y:
        <span class=" -Color -Color-Blue">return</span> y
    <span class=" -Color -Color-Blue">elif</span> x &gt; z:
        <span class=" -Color -Color-Blue">return</span> x
    <span class=" -Color -Color-Blue">return</span> z
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fitness</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># docassert</span>
<span class="k">assert</span> <span class="n">fitness</span> <span class="o">&gt;=</span> <span class="mf">1.0</span>
</pre></div>
</div>
</div>
</div>
<p>Again, we have a perfect solution. Here, we did not even need to simplify the code in the last iteration, as our <code class="docutils literal notranslate"><span class="pre">fitness_key()</span></code> function favors smaller implementations.</p>
</section>
</section>
<section id="removing-html-markup">
<h2>Removing HTML Markup<a class="headerlink" href="#removing-html-markup" title="Link to this heading">#</a></h2>
<p>Let us apply <code class="docutils literal notranslate"><span class="pre">Repairer</span></code> on our other ongoing example, namely <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">remove_html_markup</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">quote</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;&lt;&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">quote</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;&gt;&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">quote</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;&quot;&#39;</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;&#39;&quot;</span> <span class="ow">and</span> <span class="n">tag</span><span class="p">:</span>
            <span class="n">quote</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">quote</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">tag</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">out</span> <span class="o">+</span> <span class="n">c</span>

    <span class="k">return</span> <span class="n">out</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">remove_html_markup_tree</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">remove_html_markup</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>To run <code class="docutils literal notranslate"><span class="pre">Repairer</span></code> on <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code>, we need a test and a test suite. <code class="docutils literal notranslate"><span class="pre">remove_html_markup_test()</span></code> raises an exception if applying <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code> on the given <code class="docutils literal notranslate"><span class="pre">html</span></code> string does not yield the <code class="docutils literal notranslate"><span class="pre">plain</span></code> string.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">remove_html_markup_test</span><span class="p">(</span><span class="n">html</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">plain</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">outcome</span> <span class="o">=</span> <span class="n">remove_html_markup</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">outcome</span> <span class="o">==</span> <span class="n">plain</span><span class="p">,</span> \
        <span class="sa">f</span><span class="s2">&quot;Got </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span><span class="si">}</span><span class="s2">, expected </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">plain</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>Now for the test suite. We use a simple fuzzing scheme to create dozens of passing and failing test cases in <code class="docutils literal notranslate"><span class="pre">REMOVE_HTML_PASSING_TESTCASES</span></code> and <code class="docutils literal notranslate"><span class="pre">REMOVE_HTML_FAILING_TESTCASES</span></code>, respectively.</p>
<section id="excursion-creating-html-test-cases">
<h3>Excursion: Creating HTML Test Cases<a class="headerlink" href="#excursion-creating-html-test-cases" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">random_string</span><span class="p">(</span><span class="n">length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">),</span> <span class="n">end</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">random_string</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;@YeYg&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">random_id</span><span class="p">(</span><span class="n">length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">random_string</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">random_id</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;eaaem&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">random_plain</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">random_string</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">random_string_noquotes</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">random_string</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">random_html</span><span class="p">(</span><span class="n">depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">random_plain</span><span class="p">()</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">random_id</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">html</span><span class="p">,</span> <span class="n">plain</span> <span class="o">=</span> <span class="n">random_html</span><span class="p">(</span><span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">plain</span> <span class="o">=</span> <span class="n">random_plain</span><span class="p">()</span>

    <span class="n">attr</span> <span class="o">=</span> <span class="n">random_id</span><span class="p">()</span>
    <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">random_string_noquotes</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
    <span class="n">postfix</span> <span class="o">=</span> <span class="n">random_plain</span><span class="p">()</span>

    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s1">&lt;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">&gt;</span><span class="si">{</span><span class="n">html</span><span class="si">}</span><span class="s1">&lt;/</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s1">&gt;</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> \
        <span class="n">prefix</span> <span class="o">+</span> <span class="n">plain</span> <span class="o">+</span> <span class="n">postfix</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">random_html</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;L1JA|&lt;uidfm lmvie=&quot;QNSD:&quot;&gt;BvE&quot;8&lt;/uidfm&gt;v@rNS&#39;, &#39;L1JA|BvE&quot;8v@rNS&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">remove_html_testcase</span><span class="p">(</span><span class="n">expected</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">html</span><span class="p">,</span> <span class="n">plain</span> <span class="o">=</span> <span class="n">random_html</span><span class="p">()</span>
        <span class="n">outcome</span> <span class="o">=</span> <span class="p">(</span><span class="n">remove_html_markup</span><span class="p">(</span><span class="n">html</span><span class="p">)</span> <span class="o">==</span> <span class="n">plain</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">outcome</span> <span class="o">==</span> <span class="n">expected</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">html</span><span class="p">,</span> <span class="n">plain</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">REMOVE_HTML_TESTS</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">REMOVE_HTML_PASSING_TESTCASES</span> <span class="o">=</span> \
    <span class="p">[</span><span class="n">remove_html_testcase</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">REMOVE_HTML_TESTS</span><span class="p">)]</span>
<span class="n">REMOVE_HTML_FAILING_TESTCASES</span> <span class="o">=</span> \
    <span class="p">[</span><span class="n">remove_html_testcase</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">REMOVE_HTML_TESTS</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id3">
<h3>End of Excursion<a class="headerlink" href="#id3" title="Link to this heading">#</a></h3>
<p>Here is a passing test case:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">REMOVE_HTML_PASSING_TESTCASES</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;Sg$VT&lt;fqlui ppzww=&quot;!EyHN&quot;&gt;J9Ji &lt;/fqlui&gt;.)!$&#39;, &#39;Sg$VTJ9Ji .)!$&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">html</span><span class="p">,</span> <span class="n">plain</span> <span class="o">=</span> <span class="n">REMOVE_HTML_PASSING_TESTCASES</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">remove_html_markup_test</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">plain</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here is a failing test case (containing a double quote in the plain text)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">REMOVE_HTML_FAILING_TESTCASES</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;3AGe&lt;qcguk yewyq=&quot;wA^&lt;S&quot;&gt;7&quot;!%H&lt;/qcguk&gt;6azh_&#39;, &#39;3AGe7&quot;!%H6azh_&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">html</span><span class="p">,</span> <span class="n">plain</span> <span class="o">=</span> <span class="n">REMOVE_HTML_FAILING_TESTCASES</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">remove_html_markup_test</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">plain</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57510/2578453007.py&quot;, line 3, in &lt;module&gt;
    remove_html_markup_test(html, plain)
    ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57510/700130947.py&quot;, line 3, in remove_html_markup_test
    assert outcome == plain, \
           ^^^^^^^^^^^^^^^^
AssertionError: Got &#39;3AGe7!%H&lt;/qcguk&gt;6azh_&#39;, expected &#39;3AGe7&quot;!%H6azh_&#39; (expected)
</pre></div>
</div>
</div>
</div>
<p>We run our tests, collecting the outcomes in <code class="docutils literal notranslate"><span class="pre">html_debugger</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">html_debugger</span> <span class="o">=</span> <span class="n">OchiaiDebugger</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">html</span><span class="p">,</span> <span class="n">plain</span> <span class="ow">in</span> <span class="p">(</span><span class="n">REMOVE_HTML_PASSING_TESTCASES</span> <span class="o">+</span> 
                    <span class="n">REMOVE_HTML_FAILING_TESTCASES</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">html_debugger</span><span class="p">:</span>
        <span class="n">remove_html_markup_test</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">plain</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The suspiciousness distribution will not be of much help here – pretty much all lines in <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code> have the same suspiciousness.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">html_debugger</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 1:  70%">   1 def remove_html_markup_test(html: str, plain: str) -&gt; None:</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 2:  70%">   2     outcome = remove_html_markup(html)</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 3:  70%">   3     assert outcome == plain, \</pre>
<pre style="background-color:hsl(0.0, 100.0%, 80%)"
                    title="Line 4: 100%">   4         f&quot;Got {repr(outcome)}, expected {repr(plain)}&quot;</pre>

<p/><pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 1:  70%">   1 def remove_html_markup(s):  # type: ignore</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 2:  70%">   2     tag = False</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 3:  70%">   3     quote = False</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 4:  70%">   4     out = &quot;&quot;</pre>
<pre title="Line 5: not executed">   5 &nbsp;</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 6:  70%">   6     for c in s:</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 7:  70%">   7         if c == &#x27;&lt;&#x27; and not quote:</pre>
<pre style="background-color:hsl(53.3989532967738, 100.0%, 80%)"
                    title="Line 8:  55%">   8             tag = True</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 9:  70%">   9         elif c == &#x27;&gt;&#x27; and not quote:</pre>
<pre style="background-color:hsl(51.966394858339115, 100.0%, 80%)"
                    title="Line 10:  56%">  10             tag = False</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 11:  70%">  11         elif c == &#x27;&quot;&#x27; or c == &quot;&#x27;&quot; and tag:</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 12:  70%">  12             quote = not quote</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 13:  70%">  13         elif not tag:</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 14:  70%">  14             out = out + c</pre>
<pre title="Line 15: not executed">  15 &nbsp;</pre>
<pre style="background-color:hsl(35.14718625761431, 100.0%, 80%)"
                    title="Line 16:  70%">  16     return out</pre>
</div></div>
</div>
<p>Let us create our repairer and run it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">html_repairer</span> <span class="o">=</span> <span class="n">Repairer</span><span class="p">(</span><span class="n">html_debugger</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Target code to be repaired:
<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">remove_html_markup</span>(s):
    tag = <span class=" -Color -Color-Blue">False</span>
    quote = <span class=" -Color -Color-Blue">False</span>
    out = <span class=" -Color -Color-Yellow">&#39;&#39;</span>
    <span class=" -Color -Color-Blue">for</span> c <span class=" -Color -Color-Magenta">in</span> s:
        <span class=" -Color -Color-Blue">if</span> c == <span class=" -Color -Color-Yellow">&#39;&lt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> (<span class=" -Color -Color-Magenta">not</span> quote):
            tag = <span class=" -Color -Color-Blue">True</span>
        <span class=" -Color -Color-Blue">elif</span> c == <span class=" -Color -Color-Yellow">&#39;&gt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> (<span class=" -Color -Color-Magenta">not</span> quote):
            tag = <span class=" -Color -Color-Blue">False</span>
        <span class=" -Color -Color-Blue">elif</span> c == <span class=" -Color -Color-Yellow">&#39;&quot;&#39;</span> <span class=" -Color -Color-Magenta">or</span> (c == <span class=" -Color -Color-Yellow">&quot;&#39;&quot;</span> <span class=" -Color -Color-Magenta">and</span> tag):
            quote = <span class=" -Color -Color-Magenta">not</span> quote
        <span class=" -Color -Color-Blue">elif</span> <span class=" -Color -Color-Magenta">not</span> tag:
            out = out + c
    <span class=" -Color -Color-Blue">return</span> out
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_tree</span><span class="p">,</span> <span class="n">fitness</span> <span class="o">=</span> <span class="n">html_repairer</span><span class="o">.</span><span class="n">repair</span><span class="p">(</span><span class="n">iterations</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration   0/20 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration   1/20 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration   2/20 fitness = 0.99   
Evolving population: iteration   3/20 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration   4/20 fitness = 0.99   
Evolving population: iteration   5/20 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration   6/20 fitness = 0.99   
Evolving population: iteration   7/20 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration   8/20 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration   9/20 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  10/20 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  11/20 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  12/20 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  13/20 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  14/20 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  15/20 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  16/20 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  17/20 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  18/20 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  19/20 fitness = 0.99   
Best code (fitness = 0.99):
<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">remove_html_markup</span>(s):
    tag = <span class=" -Color -Color-Blue">False</span>
    quote = <span class=" -Color -Color-Blue">False</span>
    out = <span class=" -Color -Color-Yellow">&#39;&#39;</span>
    <span class=" -Color -Color-Blue">for</span> c <span class=" -Color -Color-Magenta">in</span> s:
        <span class=" -Color -Color-Blue">if</span> c == <span class=" -Color -Color-Yellow">&#39;&lt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> (<span class=" -Color -Color-Magenta">not</span> quote):
            tag = <span class=" -Color -Color-Blue">True</span>
        <span class=" -Color -Color-Blue">elif</span> c == <span class=" -Color -Color-Yellow">&#39;&gt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> (<span class=" -Color -Color-Magenta">not</span> quote):
            tag = <span class=" -Color -Color-Blue">False</span>
        <span class=" -Color -Color-Blue">elif</span> c == <span class=" -Color -Color-Yellow">&#39;&quot;&#39;</span> <span class=" -Color -Color-Magenta">or</span> (c == <span class=" -Color -Color-Yellow">&quot;&#39;&quot;</span> <span class=" -Color -Color-Magenta">and</span> tag):
            quote = <span class=" -Color -Color-Magenta">not</span> quote
        <span class=" -Color -Color-Blue">elif</span> <span class=" -Color -Color-Magenta">not</span> tag:
            out = out + c
    <span class=" -Color -Color-Blue">return</span> out

Reduced code (fitness = 0.99):
<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">remove_html_markup</span>(s):
    tag = <span class=" -Color -Color-Blue">False</span>
    quote = <span class=" -Color -Color-Blue">False</span>
    out = <span class=" -Color -Color-Yellow">&#39;&#39;</span>
    <span class=" -Color -Color-Blue">for</span> c <span class=" -Color -Color-Magenta">in</span> s:
        <span class=" -Color -Color-Blue">if</span> c == <span class=" -Color -Color-Yellow">&#39;&lt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> (<span class=" -Color -Color-Magenta">not</span> quote):
            tag = <span class=" -Color -Color-Blue">True</span>
        <span class=" -Color -Color-Blue">elif</span> c == <span class=" -Color -Color-Yellow">&#39;&gt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> (<span class=" -Color -Color-Magenta">not</span> quote):
            tag = <span class=" -Color -Color-Blue">False</span>
        <span class=" -Color -Color-Blue">elif</span> c == <span class=" -Color -Color-Yellow">&#39;&quot;&#39;</span> <span class=" -Color -Color-Magenta">or</span> (c == <span class=" -Color -Color-Yellow">&quot;&#39;&quot;</span> <span class=" -Color -Color-Magenta">and</span> tag):
            quote = <span class=" -Color -Color-Magenta">not</span> quote
        <span class=" -Color -Color-Blue">elif</span> <span class=" -Color -Color-Magenta">not</span> tag:
            out = out + c
    <span class=" -Color -Color-Blue">return</span> out
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># docassert</span>
<span class="k">assert</span> <span class="n">fitness</span> <span class="o">&lt;</span> <span class="mf">1.0</span>
</pre></div>
</div>
</div>
</div>
<p>We see that the “best” code is still our original code, with no changes. And we can set <code class="docutils literal notranslate"><span class="pre">iterations</span></code> to 50, 100, 200… – our <code class="docutils literal notranslate"><span class="pre">Repairer</span></code> won’t be able to repair it.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">Why couldn't <code>Repairer()</code> repair <code>remove_html_markup()</code>?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">
    
        <input type="radio" name="f013ddda-b294-11f0-bc1f-6298cf1a5790" id="f013ddda-b294-11f0-bc1f-6298cf1a5790-1" onclick="clear_selection('f013ddda-b294-11f0-bc1f-6298cf1a5790')">
        <label id="f013ddda-b294-11f0-bc1f-6298cf1a5790-1-label" for="f013ddda-b294-11f0-bc1f-6298cf1a5790-1">The population is too small!</label><br>
    
        <input type="radio" name="f013ddda-b294-11f0-bc1f-6298cf1a5790" id="f013ddda-b294-11f0-bc1f-6298cf1a5790-2" onclick="clear_selection('f013ddda-b294-11f0-bc1f-6298cf1a5790')">
        <label id="f013ddda-b294-11f0-bc1f-6298cf1a5790-2-label" for="f013ddda-b294-11f0-bc1f-6298cf1a5790-2">The suspiciousness is too evenly distributed!</label><br>
    
        <input type="radio" name="f013ddda-b294-11f0-bc1f-6298cf1a5790" id="f013ddda-b294-11f0-bc1f-6298cf1a5790-3" onclick="clear_selection('f013ddda-b294-11f0-bc1f-6298cf1a5790')">
        <label id="f013ddda-b294-11f0-bc1f-6298cf1a5790-3-label" for="f013ddda-b294-11f0-bc1f-6298cf1a5790-3">We need more test cases!</label><br>
    
        <input type="radio" name="f013ddda-b294-11f0-bc1f-6298cf1a5790" id="f013ddda-b294-11f0-bc1f-6298cf1a5790-4" onclick="clear_selection('f013ddda-b294-11f0-bc1f-6298cf1a5790')">
        <label id="f013ddda-b294-11f0-bc1f-6298cf1a5790-4-label" for="f013ddda-b294-11f0-bc1f-6298cf1a5790-4">We need more iterations!</label><br>
    
        <input type="radio" name="f013ddda-b294-11f0-bc1f-6298cf1a5790" id="f013ddda-b294-11f0-bc1f-6298cf1a5790-5" onclick="clear_selection('f013ddda-b294-11f0-bc1f-6298cf1a5790')">
        <label id="f013ddda-b294-11f0-bc1f-6298cf1a5790-5-label" for="f013ddda-b294-11f0-bc1f-6298cf1a5790-5">There is no statement in the source with a correct condition!</label><br>
    
        <input type="radio" name="f013ddda-b294-11f0-bc1f-6298cf1a5790" id="f013ddda-b294-11f0-bc1f-6298cf1a5790-6" onclick="clear_selection('f013ddda-b294-11f0-bc1f-6298cf1a5790')">
        <label id="f013ddda-b294-11f0-bc1f-6298cf1a5790-6-label" for="f013ddda-b294-11f0-bc1f-6298cf1a5790-6">The population is too big!</label><br>
    
    </div>
    </p>
    <input id="f013ddda-b294-11f0-bc1f-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('f013ddda-b294-11f0-bc1f-6298cf1a5790', 32, 0, '5242880 &gt;&gt; 20')">
    <span class="quiz_hint" id="f013ddda-b294-11f0-bc1f-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
<p>You can explore all the hypotheses above by changing the appropriate parameters, but you won’t be able to change the outcome. The problem is that, unlike <code class="docutils literal notranslate"><span class="pre">middle()</span></code>, there is no statement (or combination thereof) in <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code> that could be used to make the failure go away. For this, we need to mutate another aspect of the code, which we will explore in the next section.</p>
</section>
</section>
<section id="mutating-conditions">
<h2>Mutating Conditions<a class="headerlink" href="#mutating-conditions" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">Repairer</span></code> class is very configurable. The individual steps in automated repair can all be replaced by providing own classes in the keyword arguments of its <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> constructor:</p>
<ul class="simple">
<li><p>To change fault localization, pass a different <code class="docutils literal notranslate"><span class="pre">debugger</span></code> that is a subclass of <code class="docutils literal notranslate"><span class="pre">RankingDebugger</span></code>.</p></li>
<li><p>To change the mutation operator, set <code class="docutils literal notranslate"><span class="pre">mutator_class</span></code> to a subclass of <code class="docutils literal notranslate"><span class="pre">StatementMutator</span></code>.</p></li>
<li><p>To change the crossover operator, set <code class="docutils literal notranslate"><span class="pre">crossover_class</span></code> to a subclass of <code class="docutils literal notranslate"><span class="pre">CrossoverOperator</span></code>.</p></li>
<li><p>To change the reduction algorithm, set <code class="docutils literal notranslate"><span class="pre">reducer_class</span></code> to a subclass of <code class="docutils literal notranslate"><span class="pre">Reducer</span></code>.</p></li>
</ul>
<p>In this section, we will explore how to extend the mutation operator such that it can mutate <em>conditions</em> for control constructs such as <code class="docutils literal notranslate"><span class="pre">if</span></code>, <code class="docutils literal notranslate"><span class="pre">while</span></code>, or <code class="docutils literal notranslate"><span class="pre">for</span></code>. To this end, we introduce a new class <code class="docutils literal notranslate"><span class="pre">ConditionMutator</span></code> subclassing <code class="docutils literal notranslate"><span class="pre">StatementMutator</span></code>.</p>
<section id="collecting-conditions">
<h3>Collecting Conditions<a class="headerlink" href="#collecting-conditions" title="Link to this heading">#</a></h3>
<p>Let us start with a few simple supporting functions. The function <code class="docutils literal notranslate"><span class="pre">all_conditions()</span></code> retrieves all control conditions from an AST.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">all_conditions</span><span class="p">(</span><span class="n">trees</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]],</span>
                   <span class="n">tp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">expr</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return all conditions from the AST (or AST list) `trees`.</span>
<span class="sd">    If `tp` is given, return only elements of that type.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trees</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trees</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span>
        <span class="n">trees</span> <span class="o">=</span> <span class="p">[</span><span class="n">trees</span><span class="p">]</span>

    <span class="n">visitor</span> <span class="o">=</span> <span class="n">ConditionVisitor</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">trees</span><span class="p">:</span>
        <span class="n">visitor</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="n">conditions</span> <span class="o">=</span> <span class="n">visitor</span><span class="o">.</span><span class="n">conditions</span>
    <span class="k">if</span> <span class="n">tp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">conditions</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conditions</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tp</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">conditions</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">all_conditions()</span></code> uses a <code class="docutils literal notranslate"><span class="pre">ConditionVisitor</span></code> class to walk the tree and collect the conditions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ConditionVisitor</span><span class="p">(</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">expr</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conditions_seen</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">elems</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elems</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">elems</span> <span class="o">=</span> <span class="p">[</span><span class="n">elems</span><span class="p">]</span>

        <span class="n">elems</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">expr</span><span class="p">],</span> <span class="n">elems</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">elems</span><span class="p">:</span>
            <span class="n">elem_str</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">elem_str</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditions_seen</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conditions_seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">elem_str</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visit_BoolOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">BoolOp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_conditions</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visit_UnaryOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">UnaryOp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Not</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_conditions</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;operand&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generic_visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_conditions</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here are all the conditions in <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code>. This is some material to construct new conditions from.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="n">all_conditions</span><span class="p">(</span><span class="n">remove_html_markup_tree</span><span class="p">())]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&quot;c == &#39;&lt;&#39; and (not quote)&quot;,
 &quot;c == &#39;&lt;&#39;&quot;,
 &#39;not quote&#39;,
 &#39;quote&#39;,
 &quot;c == &#39;&gt;&#39; and (not quote)&quot;,
 &quot;c == &#39;&gt;&#39;&quot;,
 &#39;c == \&#39;&quot;\&#39; or (c == &quot;\&#39;&quot; and tag)&#39;,
 &#39;c == \&#39;&quot;\&#39;&#39;,
 &#39;c == &quot;\&#39;&quot; and tag&#39;,
 &#39;c == &quot;\&#39;&quot;&#39;,
 &#39;tag&#39;,
 &#39;not tag&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="id4">
<h3>Mutating Conditions<a class="headerlink" href="#id4" title="Link to this heading">#</a></h3>
<p>Here comes our <code class="docutils literal notranslate"><span class="pre">ConditionMutator</span></code> class. We subclass from <code class="docutils literal notranslate"><span class="pre">StatementMutator</span></code> and set an attribute <code class="docutils literal notranslate"><span class="pre">self.conditions</span></code> containing all the conditions in the source. The method <code class="docutils literal notranslate"><span class="pre">choose_condition()</span></code> randomly picks a condition.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ConditionMutator</span><span class="p">(</span><span class="n">StatementMutator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mutate conditions in an AST&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor. Arguments are as with `StatementMutator` constructor.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span> <span class="o">=</span> <span class="n">all_conditions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found conditions&quot;</span><span class="p">,</span>
                  <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> 
                   <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">choose_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">expr</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a random condition from source.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>The actual mutation takes place in the <code class="docutils literal notranslate"><span class="pre">swap()</span></code> method. If the node to be replaced has a <code class="docutils literal notranslate"><span class="pre">test</span></code> attribute (i.e. a controlling predicate), then we pick a random condition <code class="docutils literal notranslate"><span class="pre">cond</span></code> from the source and randomly chose from:</p>
<ul class="simple">
<li><p><strong>set</strong>: We change <code class="docutils literal notranslate"><span class="pre">test</span></code> to <code class="docutils literal notranslate"><span class="pre">cond</span></code>.</p></li>
<li><p><strong>not</strong>: We invert <code class="docutils literal notranslate"><span class="pre">test</span></code>.</p></li>
<li><p><strong>and</strong>: We replace <code class="docutils literal notranslate"><span class="pre">test</span></code> by <code class="docutils literal notranslate"><span class="pre">cond</span> <span class="pre">and</span> <span class="pre">test</span></code>.</p></li>
<li><p><strong>or</strong>: We replace <code class="docutils literal notranslate"><span class="pre">test</span></code> by <code class="docutils literal notranslate"><span class="pre">cond</span> <span class="pre">or</span> <span class="pre">test</span></code>.</p></li>
</ul>
<p>Over time, this might lead to operators propagating across the population.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ConditionMutator</span><span class="p">(</span><span class="n">ConditionMutator</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">choose_bool_op</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s1">&#39;set&#39;</span><span class="p">,</span> <span class="s1">&#39;not&#39;</span><span class="p">,</span> <span class="s1">&#39;and&#39;</span><span class="p">,</span> <span class="s1">&#39;or&#39;</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">swap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Replace `node` condition by a condition from `source`&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">swap</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="n">node</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">If</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

        <span class="n">cond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">choose_condition</span><span class="p">()</span>
        <span class="n">new_test</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">choice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">choose_bool_op</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;set&#39;</span><span class="p">:</span>
            <span class="n">new_test</span> <span class="o">=</span> <span class="n">cond</span>
        <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;not&#39;</span><span class="p">:</span>
            <span class="n">new_test</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">UnaryOp</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Not</span><span class="p">(),</span> <span class="n">operand</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;and&#39;</span><span class="p">:</span>
            <span class="n">new_test</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">BoolOp</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">And</span><span class="p">(),</span> <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;or&#39;</span><span class="p">:</span>
            <span class="n">new_test</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">BoolOp</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Or</span><span class="p">(),</span> <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown boolean operand&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">new_test</span><span class="p">:</span>
            <span class="c1"># ast.copy_location(new_test, node)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">test</span> <span class="o">=</span> <span class="n">new_test</span>

        <span class="k">return</span> <span class="n">node</span>
</pre></div>
</div>
</div>
</div>
<p>We can use the mutator just like <code class="docutils literal notranslate"><span class="pre">StatementMutator</span></code>, except that some of the mutations will also include new conditions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mutator</span> <span class="o">=</span> <span class="n">ConditionMutator</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">all_statements</span><span class="p">(</span><span class="n">remove_html_markup_tree</span><span class="p">()),</span>
                           <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Found conditions [&quot;c == &#39;&lt;&#39; and (not quote)&quot;, &quot;c == &#39;&lt;&#39;&quot;, &#39;not quote&#39;, &#39;quote&#39;, &quot;c == &#39;&gt;&#39; and (not quote)&quot;, &quot;c == &#39;&gt;&#39;&quot;, &#39;c == \&#39;&quot;\&#39; or (c == &quot;\&#39;&quot; and tag)&#39;, &#39;c == \&#39;&quot;\&#39;&#39;, &#39;c == &quot;\&#39;&quot; and tag&#39;, &#39;c == &quot;\&#39;&quot;&#39;, &#39;tag&#39;, &#39;not tag&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">new_tree</span> <span class="o">=</span> <span class="n">mutator</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">remove_html_markup_tree</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   2:insert: &#39;tag = False&#39; becomes &#39;for c in s: tag = Fa...&#39;
  10:insert: &#39;tag = False&#39; becomes &#39;tag = False&#39;; &#39;out = out + c&#39;
   8:insert: &#39;tag = True&#39; becomes &#39;if c == \&#39;&quot;\&#39; or (c ==...&#39;
  12:insert: &#39;quote = not quote&#39; becomes &#39;quote = not quote&#39;; &#39;tag = True&#39;
  10:delete: &#39;tag = False&#39; becomes &#39;pass&#39;
  12:insert: &#39;quote = not quote&#39; becomes &quot;if c == &#39;&gt;&#39; and (not...&quot;
   3:insert: &#39;quote = False&#39; becomes &#39;quote = False&#39;; &quot;out = &#39;&#39;&quot;
  14:swap:   &#39;out = out + c&#39; becomes &#39;quote = False&#39;
  12:insert: &#39;quote = not quote&#39; becomes &#39;for c in s: quote = ...&#39;
   3:delete: &#39;quote = False&#39; becomes &#39;pass&#39;
</pre></div>
</div>
</div>
</div>
<p>Let us put our new mutator to action, again in a <code class="docutils literal notranslate"><span class="pre">Repairer()</span></code>. To activate it, all we need to do is to pass it as <code class="docutils literal notranslate"><span class="pre">mutator_class</span></code> keyword argument.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">condition_repairer</span> <span class="o">=</span> <span class="n">Repairer</span><span class="p">(</span><span class="n">html_debugger</span><span class="p">,</span>
                              <span class="n">mutator_class</span><span class="o">=</span><span class="n">ConditionMutator</span><span class="p">,</span>
                              <span class="n">log</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Target code to be repaired:
<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">remove_html_markup</span>(s):
    tag = <span class=" -Color -Color-Blue">False</span>
    quote = <span class=" -Color -Color-Blue">False</span>
    out = <span class=" -Color -Color-Yellow">&#39;&#39;</span>
    <span class=" -Color -Color-Blue">for</span> c <span class=" -Color -Color-Magenta">in</span> s:
        <span class=" -Color -Color-Blue">if</span> c == <span class=" -Color -Color-Yellow">&#39;&lt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> (<span class=" -Color -Color-Magenta">not</span> quote):
            tag = <span class=" -Color -Color-Blue">True</span>
        <span class=" -Color -Color-Blue">elif</span> c == <span class=" -Color -Color-Yellow">&#39;&gt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> (<span class=" -Color -Color-Magenta">not</span> quote):
            tag = <span class=" -Color -Color-Blue">False</span>
        <span class=" -Color -Color-Blue">elif</span> c == <span class=" -Color -Color-Yellow">&#39;&quot;&#39;</span> <span class=" -Color -Color-Magenta">or</span> (c == <span class=" -Color -Color-Yellow">&quot;&#39;&quot;</span> <span class=" -Color -Color-Magenta">and</span> tag):
            quote = <span class=" -Color -Color-Magenta">not</span> quote
        <span class=" -Color -Color-Blue">elif</span> <span class=" -Color -Color-Magenta">not</span> tag:
            out = out + c
    <span class=" -Color -Color-Blue">return</span> out
</pre></div>
</div>
</div>
</div>
<p>We might need more iterations for this one. Let us see…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_tree</span><span class="p">,</span> <span class="n">fitness</span> <span class="o">=</span> <span class="n">condition_repairer</span><span class="o">.</span><span class="n">repair</span><span class="p">(</span><span class="n">iterations</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration   0/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration   1/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration   2/200 fitness = 0.99   
Evolving population: iteration   3/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration   4/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration   5/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration   6/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration   7/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration   8/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration   9/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  10/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  11/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  12/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  13/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  14/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  15/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  16/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  17/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  18/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  19/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  20/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  21/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  22/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  23/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  24/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  25/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  26/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  27/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  28/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  29/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  30/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  31/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  32/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  33/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  34/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  35/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  36/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  37/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  38/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  39/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  40/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  41/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  42/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  43/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  44/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  45/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  46/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  47/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  48/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  49/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  50/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  51/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  52/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  53/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  54/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  55/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  56/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  57/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  58/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  59/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  60/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  61/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  62/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  63/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  64/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  65/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  66/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  67/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  68/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  69/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  70/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  71/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  72/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  73/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  74/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  75/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  76/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  77/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  78/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  79/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  80/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  81/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  82/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  83/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  84/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  85/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  86/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  87/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  88/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  89/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  90/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  91/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  92/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  93/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  94/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  95/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  96/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  97/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  98/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration  99/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 100/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 101/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 102/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 103/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 104/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 105/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 106/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 107/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 108/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 109/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 110/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 111/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 112/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 113/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 114/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 115/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 116/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 117/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 118/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 119/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 120/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 121/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 122/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 123/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 124/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 125/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 126/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 127/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 128/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 129/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 130/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 131/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 132/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 133/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 134/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 135/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 136/200 fitness = 0.99   

New best code (fitness = 0.99):
<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">remove_html_markup</span>(s):
    tag = <span class=" -Color -Color-Blue">False</span>
    quote = <span class=" -Color -Color-Blue">False</span>
    out = <span class=" -Color -Color-Yellow">&#39;&#39;</span>
    <span class=" -Color -Color-Blue">for</span> c <span class=" -Color -Color-Magenta">in</span> s:
        <span class=" -Color -Color-Blue">if</span> c == <span class=" -Color -Color-Yellow">&#39;&lt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> (<span class=" -Color -Color-Magenta">not</span> quote):
            tag = <span class=" -Color -Color-Blue">True</span>
        <span class=" -Color -Color-Blue">elif</span> c == <span class=" -Color -Color-Yellow">&#39;&gt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> (<span class=" -Color -Color-Magenta">not</span> quote):
            tag = <span class=" -Color -Color-Blue">False</span>
        <span class=" -Color -Color-Blue">elif</span> c == <span class=" -Color -Color-Yellow">&#39;&quot;&#39;</span>:
            quote = <span class=" -Color -Color-Magenta">not</span> quote
        <span class=" -Color -Color-Blue">elif</span> <span class=" -Color -Color-Magenta">not</span> tag:
            out = out + c
    <span class=" -Color -Color-Blue">return</span> out
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 137/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 138/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 139/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 140/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 141/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 142/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 143/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 144/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 145/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 146/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 147/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 148/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 149/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 150/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 151/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 152/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 153/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 154/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 155/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 156/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 157/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 158/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 159/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 160/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 161/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 162/200 fitness = 0.99   

New best code (fitness = 0.99):
<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">remove_html_markup</span>(s):
    tag = <span class=" -Color -Color-Blue">False</span>
    quote = <span class=" -Color -Color-Blue">False</span>
    out = <span class=" -Color -Color-Yellow">&#39;&#39;</span>
    <span class=" -Color -Color-Blue">for</span> c <span class=" -Color -Color-Magenta">in</span> s:
        <span class=" -Color -Color-Blue">if</span> c == <span class=" -Color -Color-Yellow">&#39;&lt;&#39;</span>:
            tag = <span class=" -Color -Color-Blue">True</span>
        <span class=" -Color -Color-Blue">elif</span> c == <span class=" -Color -Color-Yellow">&#39;&gt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> (<span class=" -Color -Color-Magenta">not</span> quote):
            tag = <span class=" -Color -Color-Blue">False</span>
        <span class=" -Color -Color-Blue">elif</span> c == <span class=" -Color -Color-Yellow">&#39;&quot;&#39;</span>:
            quote = <span class=" -Color -Color-Magenta">not</span> quote
        <span class=" -Color -Color-Blue">elif</span> <span class=" -Color -Color-Magenta">not</span> tag:
            out = out + c
    <span class=" -Color -Color-Blue">return</span> out
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 163/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 164/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 165/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 166/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration 167/200 fitness = 1.0   

New best code (fitness = 1.0):
<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">remove_html_markup</span>(s):
    tag = <span class=" -Color -Color-Blue">False</span>
    quote = <span class=" -Color -Color-Blue">False</span>
    out = <span class=" -Color -Color-Yellow">&#39;&#39;</span>
    out = <span class=" -Color -Color-Yellow">&#39;&#39;</span>
    <span class=" -Color -Color-Blue">for</span> c <span class=" -Color -Color-Magenta">in</span> s:
        <span class=" -Color -Color-Blue">if</span> c == <span class=" -Color -Color-Yellow">&#39;&lt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> (<span class=" -Color -Color-Magenta">not</span> quote):
            tag = <span class=" -Color -Color-Blue">True</span>
        <span class=" -Color -Color-Blue">elif</span> c == <span class=" -Color -Color-Yellow">&#39;&gt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> (<span class=" -Color -Color-Magenta">not</span> quote):
            tag = <span class=" -Color -Color-Blue">False</span>
        <span class=" -Color -Color-Blue">elif</span> tag <span class=" -Color -Color-Magenta">and</span> c == <span class=" -Color -Color-Yellow">&#39;&quot;&#39;</span>:
            quote = <span class=" -Color -Color-Magenta">not</span> quote
        <span class=" -Color -Color-Blue">elif</span> <span class=" -Color -Color-Magenta">not</span> tag:
            <span class=" -Color -Color-Blue">if</span> <span class=" -Color -Color-Magenta">not</span> tag:
                out = out + c
    <span class=" -Color -Color-Blue">return</span> out


Reduced code (fitness = 1.0):
<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">remove_html_markup</span>(s):
    tag = <span class=" -Color -Color-Blue">False</span>
    quote = <span class=" -Color -Color-Blue">False</span>
    out = <span class=" -Color -Color-Yellow">&#39;&#39;</span>
    <span class=" -Color -Color-Blue">for</span> c <span class=" -Color -Color-Magenta">in</span> s:
        <span class=" -Color -Color-Blue">if</span> c == <span class=" -Color -Color-Yellow">&#39;&lt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> (<span class=" -Color -Color-Magenta">not</span> quote):
            tag = <span class=" -Color -Color-Blue">True</span>
        <span class=" -Color -Color-Blue">elif</span> c == <span class=" -Color -Color-Yellow">&#39;&gt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> (<span class=" -Color -Color-Magenta">not</span> quote):
            tag = <span class=" -Color -Color-Blue">False</span>
        <span class=" -Color -Color-Blue">elif</span> tag <span class=" -Color -Color-Magenta">and</span> c == <span class=" -Color -Color-Yellow">&#39;&quot;&#39;</span>:
            quote = <span class=" -Color -Color-Magenta">not</span> quote
        <span class=" -Color -Color-Blue">elif</span> <span class=" -Color -Color-Magenta">not</span> tag:
            out = out + c
    <span class=" -Color -Color-Blue">return</span> out
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">repaired_source</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">best_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">repaired_source</span><span class="p">,</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">remove_html_markup</span>(s):
    tag = <span class=" -Color -Color-Blue">False</span>
    quote = <span class=" -Color -Color-Blue">False</span>
    out = <span class=" -Color -Color-Yellow">&#39;&#39;</span>
    <span class=" -Color -Color-Blue">for</span> c <span class=" -Color -Color-Magenta">in</span> s:
        <span class=" -Color -Color-Blue">if</span> c == <span class=" -Color -Color-Yellow">&#39;&lt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> (<span class=" -Color -Color-Magenta">not</span> quote):
            tag = <span class=" -Color -Color-Blue">True</span>
        <span class=" -Color -Color-Blue">elif</span> c == <span class=" -Color -Color-Yellow">&#39;&gt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> (<span class=" -Color -Color-Magenta">not</span> quote):
            tag = <span class=" -Color -Color-Blue">False</span>
        <span class=" -Color -Color-Blue">elif</span> tag <span class=" -Color -Color-Magenta">and</span> c == <span class=" -Color -Color-Yellow">&#39;&quot;&#39;</span>:
            quote = <span class=" -Color -Color-Magenta">not</span> quote
        <span class=" -Color -Color-Blue">elif</span> <span class=" -Color -Color-Magenta">not</span> tag:
            out = out + c
    <span class=" -Color -Color-Blue">return</span> out
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># docassert</span>
<span class="k">assert</span> <span class="n">fitness</span> <span class="o">&gt;=</span> <span class="mf">1.0</span>
</pre></div>
</div>
</div>
</div>
<p>Success again! We have automatically repaired <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code> – the resulting code passes all tests, including those that were previously failing.</p>
<p>Again, we can present the fix as a patch:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">original_source</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">remove_html_markup_tree</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">(</span><span class="n">original_source</span><span class="p">,</span> <span class="n">repaired_source</span><span class="p">):</span>
    <span class="n">print_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>@@ -<span class=" -Color -Color-Blue">210</span>,<span class=" -Color -Color-Blue">53</span> +<span class=" -Color -Color-Blue">210</span>,<span class=" -Color -Color-Blue">39</span> @@
 lse

-        <span class=" -Color -Color-Blue">elif</span> c == <span class=" -Color -Color-Yellow">&#39;&quot;&#39;</span> <span class=" -Color -Color-Magenta">or</span> (c == <span class=" -Color -Color-Yellow">&quot;&#39;&quot;</span> <span class=" -Color -Color-Magenta">and</span> tag):

+        <span class=" -Color -Color-Blue">elif</span> tag <span class=" -Color -Color-Magenta">and</span> c == <span class=" -Color -Color-Yellow">&#39;&quot;&#39;</span>:
</pre></div>
</div>
</div>
</div>
<p>However, looking at the patch, one may come up with doubts.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">Is this actually the best solution?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">
    
        <input type="radio" name="0c993f0e-b295-11f0-bc1f-6298cf1a5790" id="0c993f0e-b295-11f0-bc1f-6298cf1a5790-1" onclick="clear_selection('0c993f0e-b295-11f0-bc1f-6298cf1a5790')">
        <label id="0c993f0e-b295-11f0-bc1f-6298cf1a5790-1-label" for="0c993f0e-b295-11f0-bc1f-6298cf1a5790-1">Yes, sure, of course. Why?</label><br>
    
        <input type="radio" name="0c993f0e-b295-11f0-bc1f-6298cf1a5790" id="0c993f0e-b295-11f0-bc1f-6298cf1a5790-2" onclick="clear_selection('0c993f0e-b295-11f0-bc1f-6298cf1a5790')">
        <label id="0c993f0e-b295-11f0-bc1f-6298cf1a5790-2-label" for="0c993f0e-b295-11f0-bc1f-6298cf1a5790-2">Err - what happened to single quotes?</label><br>
    
    </div>
    </p>
    <input id="0c993f0e-b295-11f0-bc1f-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('0c993f0e-b295-11f0-bc1f-6298cf1a5790', 4, 0, '')">
    <span class="quiz_hint" id="0c993f0e-b295-11f0-bc1f-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
<p>Indeed – our solution does not seem to handle single quotes anymore. Why is that so?</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">Why aren't single quotes handled in the solution?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">
    
        <input type="radio" name="0c99db26-b295-11f0-bc1f-6298cf1a5790" id="0c99db26-b295-11f0-bc1f-6298cf1a5790-1" onclick="clear_selection('0c99db26-b295-11f0-bc1f-6298cf1a5790')">
        <label id="0c99db26-b295-11f0-bc1f-6298cf1a5790-1-label" for="0c99db26-b295-11f0-bc1f-6298cf1a5790-1">Because they're not important. I mean, y'know, who uses 'em anyway?</label><br>
    
        <input type="radio" name="0c99db26-b295-11f0-bc1f-6298cf1a5790" id="0c99db26-b295-11f0-bc1f-6298cf1a5790-2" onclick="clear_selection('0c99db26-b295-11f0-bc1f-6298cf1a5790')">
        <label id="0c99db26-b295-11f0-bc1f-6298cf1a5790-2-label" for="0c99db26-b295-11f0-bc1f-6298cf1a5790-2">Because they are not part of our tests? Let me look up how they are constructed...</label><br>
    
    </div>
    </p>
    <input id="0c99db26-b295-11f0-bc1f-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('0c99db26-b295-11f0-bc1f-6298cf1a5790', 4, 0, '')">
    <span class="quiz_hint" id="0c99db26-b295-11f0-bc1f-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
<p>Correct! Our test cases do not include single quotes – at least not in the interior of HTML tags – and thus, automatic repair did not care to preserve their handling.</p>
<p>How can we fix this? An easy way is to include an appropriate test case in our set – a test case that passes with the original <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code>, yet fails with the “repaired” <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code> as shown above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">html_debugger</span><span class="p">:</span>
    <span class="n">remove_html_markup_test</span><span class="p">(</span><span class="s2">&quot;&lt;foo quote=&#39;&gt;abc&#39;&gt;me&lt;/foo&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;me&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let us repeat the repair with the extended test set:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_tree</span><span class="p">,</span> <span class="n">fitness</span> <span class="o">=</span> <span class="n">condition_repairer</span><span class="o">.</span><span class="n">repair</span><span class="p">(</span><span class="n">iterations</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration   0/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration   1/200 fitness = 0.99   
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Evolving population: iteration   2/200 fitness = 1.0   

New best code (fitness = 1.0):
<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">remove_html_markup</span>(s):
    tag = <span class=" -Color -Color-Blue">False</span>
    quote = <span class=" -Color -Color-Blue">False</span>
    out = <span class=" -Color -Color-Yellow">&#39;&#39;</span>
    <span class=" -Color -Color-Blue">for</span> c <span class=" -Color -Color-Magenta">in</span> s:
        <span class=" -Color -Color-Blue">if</span> c == <span class=" -Color -Color-Yellow">&#39;&lt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> (<span class=" -Color -Color-Magenta">not</span> quote):
            tag = <span class=" -Color -Color-Blue">True</span>
        <span class=" -Color -Color-Blue">elif</span> c == <span class=" -Color -Color-Yellow">&#39;&gt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> (<span class=" -Color -Color-Magenta">not</span> quote):
            tag = <span class=" -Color -Color-Blue">False</span>
        <span class=" -Color -Color-Blue">elif</span> tag <span class=" -Color -Color-Magenta">and</span> (c == <span class=" -Color -Color-Yellow">&#39;&quot;&#39;</span> <span class=" -Color -Color-Magenta">or</span> (c == <span class=" -Color -Color-Yellow">&quot;&#39;&quot;</span> <span class=" -Color -Color-Magenta">and</span> tag)):
            quote = <span class=" -Color -Color-Magenta">not</span> quote
        <span class=" -Color -Color-Blue">elif</span> <span class=" -Color -Color-Magenta">not</span> tag:
            out = out + c
    <span class=" -Color -Color-Blue">if</span> <span class=" -Color -Color-Magenta">not</span> tag:
        tag = <span class=" -Color -Color-Blue">False</span>
        <span class=" -Color -Color-Blue">return</span> out


Reduced code (fitness = 1.0):
<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">remove_html_markup</span>(s):
    tag = <span class=" -Color -Color-Blue">False</span>
    quote = <span class=" -Color -Color-Blue">False</span>
    out = <span class=" -Color -Color-Yellow">&#39;&#39;</span>
    <span class=" -Color -Color-Blue">for</span> c <span class=" -Color -Color-Magenta">in</span> s:
        <span class=" -Color -Color-Blue">if</span> c == <span class=" -Color -Color-Yellow">&#39;&lt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> (<span class=" -Color -Color-Magenta">not</span> quote):
            tag = <span class=" -Color -Color-Blue">True</span>
        <span class=" -Color -Color-Blue">elif</span> c == <span class=" -Color -Color-Yellow">&#39;&gt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> (<span class=" -Color -Color-Magenta">not</span> quote):
            tag = <span class=" -Color -Color-Blue">False</span>
        <span class=" -Color -Color-Blue">elif</span> tag <span class=" -Color -Color-Magenta">and</span> (c == <span class=" -Color -Color-Yellow">&#39;&quot;&#39;</span> <span class=" -Color -Color-Magenta">or</span> (c == <span class=" -Color -Color-Yellow">&quot;&#39;&quot;</span> <span class=" -Color -Color-Magenta">and</span> tag)):
            quote = <span class=" -Color -Color-Magenta">not</span> quote
        <span class=" -Color -Color-Blue">elif</span> <span class=" -Color -Color-Magenta">not</span> tag:
            out = out + c
    <span class=" -Color -Color-Blue">if</span> <span class=" -Color -Color-Magenta">not</span> tag:
        <span class=" -Color -Color-Blue">return</span> out
</pre></div>
</div>
</div>
</div>
<p>Here is the final tree:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">best_tree</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">remove_html_markup</span>(s):
    tag = <span class=" -Color -Color-Blue">False</span>
    quote = <span class=" -Color -Color-Blue">False</span>
    out = <span class=" -Color -Color-Yellow">&#39;&#39;</span>
    <span class=" -Color -Color-Blue">for</span> c <span class=" -Color -Color-Magenta">in</span> s:
        <span class=" -Color -Color-Blue">if</span> c == <span class=" -Color -Color-Yellow">&#39;&lt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> (<span class=" -Color -Color-Magenta">not</span> quote):
            tag = <span class=" -Color -Color-Blue">True</span>
        <span class=" -Color -Color-Blue">elif</span> c == <span class=" -Color -Color-Yellow">&#39;&gt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> (<span class=" -Color -Color-Magenta">not</span> quote):
            tag = <span class=" -Color -Color-Blue">False</span>
        <span class=" -Color -Color-Blue">elif</span> tag <span class=" -Color -Color-Magenta">and</span> (c == <span class=" -Color -Color-Yellow">&#39;&quot;&#39;</span> <span class=" -Color -Color-Magenta">or</span> (c == <span class=" -Color -Color-Yellow">&quot;&#39;&quot;</span> <span class=" -Color -Color-Magenta">and</span> tag)):
            quote = <span class=" -Color -Color-Magenta">not</span> quote
        <span class=" -Color -Color-Blue">elif</span> <span class=" -Color -Color-Magenta">not</span> tag:
            out = out + c
    <span class=" -Color -Color-Blue">if</span> <span class=" -Color -Color-Magenta">not</span> tag:
        <span class=" -Color -Color-Blue">return</span> out
</pre></div>
</div>
</div>
</div>
<p>And here is its fitness:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fitness</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># docassert</span>
<span class="k">assert</span> <span class="n">fitness</span> <span class="o">&gt;=</span> <span class="mf">1.0</span>
</pre></div>
</div>
</div>
</div>
<p>The revised candidate now passes <em>all</em> tests (including the tricky quote test we added last). Its condition now properly checks for <code class="docutils literal notranslate"><span class="pre">tag</span></code> <em>and</em> both quotes. (The <code class="docutils literal notranslate"><span class="pre">tag</span></code> inside the parentheses is still redundant, but so be it.) From this example, we can learn a few lessons about the possibilities and risks of automated repair:</p>
<ul class="simple">
<li><p>First, automatic repair is highly dependent on the quality of the checking tests. The risk is that the repair may overspecialize towards the test.</p></li>
<li><p>Second, when based on “plastic surgery”, automated repair is highly dependent on the sources that program fragments are chosen from. If there is a hint of a solution somewhere in the code, there is a chance that automated repair will catch it up.</p></li>
<li><p>Third, automatic repair is a deeply heuristic approach. Its behavior will vary widely with any change to the parameters (and the underlying random number generators).</p></li>
<li><p>Fourth, automatic repair can take a long time. The examples we have in this chapter take less than a minute to compute, and neither Python nor our implementation is exactly fast. But as the search space grows, automated repair will take much longer.</p></li>
</ul>
<p>On the other hand, even an incomplete automated repair candidate can be much better than nothing at all – it may provide all the essential ingredients (such as the location or the involved variables) for a successful fix. When users of automated repair techniques are aware of its limitations and its assumptions, there is lots of potential in automated repair. Enjoy!</p>
</section>
</section>
<section id="limitations">
<h2>Limitations<a class="headerlink" href="#limitations" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">Repairer</span></code> class is tested on our example programs, but not much more. Things that do not work include</p>
<ul class="simple">
<li><p>Functions with inner functions are not repaired.</p></li>
</ul>
</section>
<section id="lessons-learned">
<h2>Lessons Learned<a class="headerlink" href="#lessons-learned" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Automated repair based on genetic optimization uses five ingredients:</p>
<ol class="arabic simple">
<li><p>A <em>test suite</em> to determine passing and failing tests</p></li>
<li><p><em>Defect localization</em> (typically obtained from <a class="reference internal" href="StatisticalDebugger.html"><span class="std std-doc">statistical debugging</span></a> with the test suite) to determine potential locations to be fixed</p></li>
<li><p><em>Random code mutations</em> and <em>crossover operations</em> to create and evolve a population of inputs</p></li>
<li><p>A <em>fitness function</em> and a <em>selection strategy</em> to determine the part of the population that should be evolved further</p></li>
<li><p>A <em>reducer</em> such as <a class="reference internal" href="DeltaDebugger.html"><span class="std std-doc">delta debugging</span></a> to simplify the final candidate with the highest fitness.</p></li>
</ol>
</li>
<li><p>The result of automated repair is a <em>fix candidate</em> with the highest fitness for the given tests.</p></li>
<li><p>A <em>fix candidate</em> is not guaranteed to be correct or optimal, but gives important hints on how to fix the program.</p></li>
<li><p>All the above ingredients offer plenty of settings and alternatives to experiment with.</p></li>
</ul>
</section>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">#</a></h2>
<p>The seminal work in automated repair is <a class="reference external" href="https://squareslab.github.io/genprog-code/">GenProg</a> \cite{LeGoues2012}, which heavily inspired our <code class="docutils literal notranslate"><span class="pre">Repairer</span></code> implementation. Major differences between GenProg and <code class="docutils literal notranslate"><span class="pre">Repairer</span></code> include:</p>
<ul class="simple">
<li><p>GenProg includes its own defect localization (which is also dynamically updated), whereas <code class="docutils literal notranslate"><span class="pre">Repairer</span></code> builds on earlier statistical debugging.</p></li>
<li><p>GenProg can apply multiple mutations on programs (or none at all), whereas <code class="docutils literal notranslate"><span class="pre">Repairer</span></code> applies exactly one mutation.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">StatementMutator</span></code> used by <code class="docutils literal notranslate"><span class="pre">Repairer</span></code> includes various special cases for program structures (<code class="docutils literal notranslate"><span class="pre">if</span></code>, <code class="docutils literal notranslate"><span class="pre">for</span></code>, <code class="docutils literal notranslate"><span class="pre">while</span></code>…), whereas GenProg operates on statements only.</p></li>
<li><p>GenProg has been tested on large production programs.</p></li>
</ul>
<p>While GenProg is <em>the</em> seminal work in the area (and arguably the most important software engineering research contribution of the 2010s), there have been a number of important extensions of automated repair. These include:</p>
<ul class="simple">
<li><p><em>AutoFix</em> \cite{Pei2014} leverages <em>program contracts</em> (pre- and postconditions) to generate tests and assertions automatically. Not only do such <a class="reference internal" href="Assertions.html"><span class="std std-doc">assertions</span></a> help in fault localization, they also allow for much better validation of fix candidates.</p></li>
<li><p><em>SemFix</em> \cite{Nguyen2013} and its successor <em><a class="reference external" href="http://angelix.io">Angelix</a></em> \cite{Mechtaev2016}
introduce automated program repair based on <em>symbolic analysis</em> rather than genetic optimization. This allows leveraging program semantics, which GenProg does not consider.</p></li>
</ul>
<p>To learn more about automated program repair, see <a class="reference external" href="http://program-repair.org">program-repair.org</a>, the community page dedicated to research in program repair.</p>
</section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<section id="exercise-1-automated-repair-parameters">
<h3>Exercise 1: Automated Repair Parameters<a class="headerlink" href="#exercise-1-automated-repair-parameters" title="Link to this heading">#</a></h3>
<p>Automated Repair is influenced by numerous design choices – the size of the population, the number of iterations, the genetic optimization strategy, and more. How do changes to these design choices affect its effectiveness?</p>
<ul class="simple">
<li><p>Consider the constants defined in this chapter (such as <code class="docutils literal notranslate"><span class="pre">POPULATION_SIZE</span></code> or <code class="docutils literal notranslate"><span class="pre">WEIGHT_PASSING</span></code> vs. <code class="docutils literal notranslate"><span class="pre">WEIGHT_FAILING</span></code>). How do changes affect the effectiveness of automated repair?</p></li>
<li><p>As an effectiveness metric, consider the number of iterations it takes to produce a fix candidate.</p></li>
<li><p>Since genetic optimization is a random algorithm, you need to determine effectiveness averages over a large number of runs (say, 100).</p></li>
</ul>
</section>
<section id="exercise-2-elitism">
<h3>Exercise 2: Elitism<a class="headerlink" href="#exercise-2-elitism" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Genetic_algorithm#Elitism"><em>Elitism</em></a> (also known as <em>elitist selection</em>) is a variant of genetic selection in which a small fraction of the fittest candidates of the last population are included unchanged in the offspring.</p>
<ul class="simple">
<li><p>Implement elitist selection by subclassing the <code class="docutils literal notranslate"><span class="pre">evolve()</span></code> method. Experiment with various fractions (5%, 10%, 25%) of “elites” and see how this improves results.</p></li>
</ul>
</section>
<section id="exercise-3-evolving-values">
<h3>Exercise 3: Evolving Values<a class="headerlink" href="#exercise-3-evolving-values" title="Link to this heading">#</a></h3>
<p>Following the steps of <code class="docutils literal notranslate"><span class="pre">ConditionMutator</span></code>, implement a <code class="docutils literal notranslate"><span class="pre">ValueMutator</span></code> class that replaces one constant value by another one found in the source (say, <code class="docutils literal notranslate"><span class="pre">0</span></code> by <code class="docutils literal notranslate"><span class="pre">1</span></code> or <code class="docutils literal notranslate"><span class="pre">True</span></code> by <code class="docutils literal notranslate"><span class="pre">False</span></code>).</p>
<p>For validation, consider the following failure in the <code class="docutils literal notranslate"><span class="pre">square_root()</span></code> function from the <a class="reference internal" href="Assertions.html"><span class="std std-doc">chapter on assertions</span></a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">Assertions</span><span class="w"> </span><span class="kn">import</span> <span class="n">square_root</span>  <span class="c1"># minor dependency</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">square_root_of_zero</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_57510/1107282428.py&quot;, line 2, in &lt;module&gt;
    square_root_of_zero = square_root(0)
  File &quot;Assertions.ipynb&quot;, line 61, in square_root
    guess = (approx + x / approx) / 2
                      ~~^~~~~~~~
ZeroDivisionError: float division by zero (expected)
</pre></div>
</div>
</div>
</div>
<p>Can your <code class="docutils literal notranslate"><span class="pre">ValueMutator</span></code> automatically fix this failure?</p>
<p><strong>Solution.</strong> Your solution will be effective if it also includes named constants such as <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">square_root_fixed</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="k">assert</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span>  <span class="c1"># precondition</span>

    <span class="n">approx</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># &lt;-- FIX: Change `None` to 0</span>
    <span class="n">guess</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">while</span> <span class="n">approx</span> <span class="o">!=</span> <span class="n">guess</span><span class="p">:</span>
        <span class="n">approx</span> <span class="o">=</span> <span class="n">guess</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="p">(</span><span class="n">approx</span> <span class="o">+</span> <span class="n">x</span> <span class="o">/</span> <span class="n">approx</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">approx</span> <span class="o">*</span> <span class="n">approx</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">approx</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">square_root_fixed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0
</pre></div>
</div>
</div>
</div>
</section>
<section id="exercise-4-evolving-variable-names">
<h3>Exercise 4: Evolving Variable Names<a class="headerlink" href="#exercise-4-evolving-variable-names" title="Link to this heading">#</a></h3>
<p>Following the steps of <code class="docutils literal notranslate"><span class="pre">ConditionMutator</span></code>, implement a <code class="docutils literal notranslate"><span class="pre">IdentifierMutator</span></code> class that replaces one identifier by another one found in the source (say, <code class="docutils literal notranslate"><span class="pre">y</span></code> by <code class="docutils literal notranslate"><span class="pre">x</span></code>). Does it help to fix the <code class="docutils literal notranslate"><span class="pre">middle()</span></code> error?</p>
</section>
<section id="exercise-5-parallel-repair">
<h3>Exercise 5: Parallel Repair<a class="headerlink" href="#exercise-5-parallel-repair" title="Link to this heading">#</a></h3>
<p>Automatic Repair is a technique that is embarrassingly parallel – all tests for one candidate can all be run in parallel, and all tests for <em>all</em> candidates can also be run in parallel. Set up an infrastructure for running concurrent tests using Pythons <a class="reference external" href="https://docs.python.org/3/library/asyncio.html">asyncio</a> library.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="PerformanceDebugger.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Debugging Performance Issues</p>
      </div>
    </a>
    <a class="right-next"
       href="Tracking.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Tracking Bugs</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#automatic-code-repairs">Automatic Code Repairs</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-middle-function">The middle() Function</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#validated-repairs">Validated Repairs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#genetic-optimization">Genetic Optimization</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-test-suite">A Test Suite</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#locating-the-defect">Locating the Defect</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#random-code-mutations">Random Code Mutations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#picking-statements">Picking Statements</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mutating-statements">Mutating Statements</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#choosing-suspicious-statements-to-mutate">Choosing Suspicious Statements to Mutate</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#choosing-a-mutation-method">Choosing a Mutation Method</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#swapping-statements">Swapping Statements</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#inserting-statements">Inserting Statements</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#deleting-statements">Deleting Statements</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#helpers">Helpers</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#all-together">All Together</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fitness">Fitness</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#population">Population</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evolution">Evolution</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#simplifying">Simplifying</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#crossover">Crossover</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-crossover">Excursion: Implementing Crossover</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#crossing-statement-lists">Crossing Statement Lists</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#applying-crossover-on-programs">Applying Crossover on Programs</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#end-of-excursion">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#crossover-in-action">Crossover in Action</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-repairer-class">A Repairer Class</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-repairer">Excursion: Implementing Repairer</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#helper-functions">Helper Functions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#running-tests">Running Tests</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#re-defining-functions">(Re)defining Functions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#repairing">Repairing</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#evolving">Evolving</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Simplifying</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#repairer-in-action">Repairer in Action</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#removing-html-markup">Removing HTML Markup</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-creating-html-test-cases">Excursion: Creating HTML Test Cases</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mutating-conditions">Mutating Conditions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#collecting-conditions">Collecting Conditions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Mutating Conditions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#limitations">Limitations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-automated-repair-parameters">Exercise 1: Automated Repair Parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-elitism">Exercise 2: Elitism</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3-evolving-values">Exercise 3: Evolving Values</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-4-evolving-variable-names">Exercise 4: Evolving Variable Names</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-5-parallel-repair">Exercise 5: Parallel Repair</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Andreas Zeller
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <div>
  Copyright &copy; 2021–2025 <a href="https://www.cispa.de/">CISPA Helmholtz Center for Information Security</a>.
  The <strong>content</strong> of this project is licensed under the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
  The <strong>source code</strong> that is part of the content, as well as the source code used to format and display that content is licensed under the <a href="https://github.com/uds-se/debuggingbook/blob/master/LICENSE.md#mit-license">MIT License</a>.
  <br>
  <a href="https://cispa.de/en/impressum">Imprint</a> &middot; <a href="/html/index.html#how-do-i-cite-your-work">Cite</a>
</div>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>