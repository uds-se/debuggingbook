
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Mining Function Specifications &#8212; The Debugging Book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=d5c2cecb" />
    <link rel="stylesheet" type="text/css" href="_static/mastodon-timeline.css?v=f82c2b23" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'DynamicInvariants';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Generalizing Failure Circumstances" href="DDSetDebugger.html" />
    <link rel="prev" title="Statistical Debugging" href="StatisticalDebugger.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content"><p>This is a beta version of debuggingbook.org, currently in development. See the <a href="https://debuggingbook.org/classic/"  style="color:white!important;">classic site</a> for the 2024 version.</p></div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/debuggingbook.png" class="logo__image only-light" alt="The Debugging Book - Home"/>
    <script>document.write(`<img src="_static/debuggingbook.png" class="logo__image only-dark" alt="The Debugging Book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    The Debugging Book
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tours.html">Sitemap</a></li>
<li class="toctree-l1"><a class="reference internal" href="Intro_Debugging.html">Introduction to Debugging</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Observing Executions</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tracer.html">Tracing Executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="Debugger.html">How Debuggers Work</a></li>
<li class="toctree-l1"><a class="reference internal" href="Assertions.html">Asserting Expectations</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Flows and Dependencies</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Slicer.html">Tracking Failure Origins</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Reducing Failure Causes</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="DeltaDebugger.html">Reducing Failure-Inducing Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ChangeDebugger.html">Isolating Failure-Inducing Changes</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Abstracting Failures</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="StatisticalDebugger.html">Statistical Debugging</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Mining Function Specifications</a></li>
<li class="toctree-l1"><a class="reference internal" href="DDSetDebugger.html">Generalizing Failure Circumstances</a></li>
<li class="toctree-l1"><a class="reference internal" href="Alhazen.html">Learning from Failures</a></li>
<li class="toctree-l1"><a class="reference internal" href="PerformanceDebugger.html">Debugging Performance Issues</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Automatic Repair</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Repairer.html">Repairing Code Automatically</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Debugging in the Large</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tracking.html">Tracking Bugs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ChangeCounter.html">Where the Bugs are</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ExpectError.html">Error Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timer.html">Timer</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timeout.html">Timeout</a></li>
<li class="toctree-l1"><a class="reference internal" href="ClassDiagram.html">Class Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="StackInspector.html">Inspecting Call Stacks</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">About This Book</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ReleaseNotes.html">Release Notes for The Debugging Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="Importing.html">Downloads and Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Guide_for_Authors.html">Guide for Authors</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/uds-se/debuggingbook/master?urlpath=tree/docs/notebooks/DynamicInvariants.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/uds-se/debuggingbook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/uds-se/debuggingbook/issues/new?title=Issue%20on%20page%20%2FDynamicInvariants.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
    <li><a href="../code/DynamicInvariants.py" target="_blank"
       class="btn btn-sm btn-download-source-button dropdown-item"
       title="Download Python code"
       data-bs-placement="left" data-bs-toggle="tooltip"
    >
  

    <span class="btn__icon-container">
      <i class="fas fa-file"></i>
      </span>
    <span class="btn__text-container">.py</span>
    </a>
    </li>
    
      
      
      
      <li><a href="_sources/DynamicInvariants.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download notebook"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  
    <li><a href="Importing.html" target="_blank"
       class="btn btn-sm btn-download-source-button dropdown-item"
       title="All downloads"
       data-bs-placement="left" data-bs-toggle="tooltip"
    >
  

    <span class="btn__icon-container">
      <i class="fas fa-file"></i>
      </span>
    <span class="btn__text-container">All downloads</span>
    </a>
    </li>
    </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Mining Function Specifications</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#specifications-and-assertions">Specifications and Assertions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#beyond-generic-failures">Beyond Generic Failures</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mining-data-types">Mining Data Types</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-runtime-type-checking">Excursion: Runtime Type Checking</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#end-of-excursion">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#static-type-checking">Static Type Checking</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mining-type-specifications">Mining Type Specifications</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tracing-calls">Tracing Calls</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#getting-types">Getting Types</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#annotating-functions-with-types">Annotating Functions with Types</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-accessing-function-structure">Excursion: Accessing Function Structure</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">End of Excursion</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-annotating-functions-with-given-types">Excursion: Annotating Functions with Given Types</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">End of Excursion</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-annotating-functions-with-mined-types">Excursion: Annotating Functions with Mined Types</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">End of Excursion</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-a-type-annotator-class">Excursion: A Type Annotator Class</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">End of Excursion</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-handling-multiple-types">Excursion: Handling Multiple Types</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">End of Excursion</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mining-invariants">Mining Invariants</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#annotating-functions-with-pre-and-postconditions">Annotating Functions with Pre- and Postconditions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Mining Invariants</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-properties">Defining Properties</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-meta-variables">Extracting Meta-Variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#instantiating-properties">Instantiating Properties</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluating-properties">Evaluating Properties</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-invariants">Checking Invariants</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-invariants">Extracting Invariants</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#converting-mined-invariants-to-annotations">Converting Mined Invariants to Annotations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#avoiding-overspecialization">Avoiding Overspecialization</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#partial-invariants">Partial Invariants</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#some-examples">Some Examples</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#removing-html-markup">Removing HTML Markup</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-recursive-function">A Recursive Function</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sum-of-two-numbers">Sum of two Numbers</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-specifications">Checking Specifications</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-union-types">Exercise 1: Union Types</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-types-for-local-variables">Exercise 2: Types for Local Variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3-verbose-invariant-checkers">Exercise 3: Verbose Invariant Checkers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-4-save-initial-values">Exercise 4: Save Initial Values</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-5-implications">Exercise 5: Implications</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-6-local-variables">Exercise 6: Local Variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-7-embedding-invariants-as-assertions">Exercise 7: Embedding Invariants as Assertions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-8-grammar-generated-properties">Exercise 8: Grammar-Generated Properties</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-9-loop-invariants">Exercise 9: Loop Invariants</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-10-path-invariants">Exercise 10: Path Invariants</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="mining-function-specifications">
<h1>Mining Function Specifications<a class="headerlink" href="#mining-function-specifications" title="Link to this heading">#</a></h1>
<p>In the <a class="reference internal" href="Assertions.html"><span class="std std-doc">chapter on assertions</span></a>, we have seen how important it is to <em>check</em> whether the result is as expected.  In this chapter, we introduce a technique that allows us to <em>mine</em> function specifications from a set of given executions, resulting in abstract and formal <em>descriptions</em> of what the function expects and what it delivers.</p>
<p>These so-called <em>dynamic invariants</em> produce pre- and post-conditions over function arguments and variables from a set of executions. Within debugging, the resulting <em>assertions</em> can immediately check whether function behavior has changed, but can also be useful to determine the characteristics of <em>failing</em> runs (as opposed to <em>passing</em> runs). Furthermore, the resulting specifications provide pre- and postconditions for formal program proofs, testing, and verification.</p>
<p>This chapter is based on <a class="reference external" href="https://www.fuzzingbook.org/html/DynamicInvariants.html">a chapter with the same name in The Fuzzing Book</a>, which focuses on test generation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">YouTubeVideo</span>
<span class="n">YouTubeVideo</span><span class="p">(</span><span class="s2">&quot;HDu1olXFvv0&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <iframe
            width="640"
            height="360"
            src="https://www.youtube-nocookie.com/embed/HDu1olXFvv0"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
<p><strong>Prerequisites</strong></p>
<ul class="simple">
<li><p>You should be familiar with tracing program executions, as in the <a class="reference internal" href="Tracer.html"><span class="std std-doc">chapter on tracing</span></a>.</p></li>
<li><p>Later in this section, we access the internal <em>abstract syntax tree</em> representations of Python programs and transform them, as in the <a class="reference internal" href="Slicer.html"><span class="std std-doc">chapter on tracking failure origins</span></a>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">bookutils.setup</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">Tracer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tracer</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
</div>
<section id="synopsis">
<h2>Synopsis<a class="headerlink" href="#synopsis" title="Link to this heading">#</a></h2>
<p>To <a class="reference internal" href="Importing.html"><span class="std std-doc">use the code provided in this chapter</span></a>, write</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">debuggingbook.DynamicInvariants</span><span class="w"> </span><span class="kn">import</span> <span class="o">&lt;</span><span class="n">identifier</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>and then make use of the following features.</p>
<p><strong>Note</strong>: The examples in this section only work after the rest of the cells have been executed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">sum2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">TypeAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">type_annotator</span><span class="p">:</span>
    <span class="n">sum2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">sum2</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">sum2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">typed_functions()</span></code> method will return a representation of <code class="docutils literal notranslate"><span class="pre">sum2()</span></code> annotated with types observed during execution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">type_annotator</span><span class="o">.</span><span class="n">typed_functions</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>def sum2(a: int, b: int) -&gt; int:
    return a + b
</pre></div>
</div>
</div>
</div>
<p>As a shortcut, one can also just evaluate the annotator:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">type_annotator</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>def sum2(a: int, b: int) -&gt; int:
    return a + b
</pre></div>
</div>
</div>
</div>
<p>The invariant annotator works similarly:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">inv_annotator</span><span class="p">:</span>
    <span class="n">sum2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">sum2</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">sum2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">functions_with_invariants()</span></code> method will return a representation of <code class="docutils literal notranslate"><span class="pre">sum2()</span></code> annotated with inferred pre- and postconditions that all hold for the observed values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">inv_annotator</span><span class="o">.</span><span class="n">functions_with_invariants</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>@precondition(lambda a, b: isinstance(a, int))
@precondition(lambda a, b: isinstance(b, int))
@postcondition(lambda return_value, a, b: a == return_value - b)
@postcondition(lambda return_value, a, b: b == return_value - a)
@postcondition(lambda return_value, a, b: isinstance(return_value, int))
@postcondition(lambda return_value, a, b: return_value == a + b)
@postcondition(lambda return_value, a, b: return_value == b + a)
def sum2(a, b):  # type: ignore
    return a + b
</pre></div>
</div>
</div>
</div>
<p>Again, a shortcut is available:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inv_annotator</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>@precondition(lambda a, b: isinstance(a, int))
@precondition(lambda a, b: isinstance(b, int))
@postcondition(lambda return_value, a, b: a == return_value - b)
@postcondition(lambda return_value, a, b: b == return_value - a)
@postcondition(lambda return_value, a, b: isinstance(return_value, int))
@postcondition(lambda return_value, a, b: return_value == a + b)
@postcondition(lambda return_value, a, b: return_value == b + a)
def sum2(a, b):  # type: ignore
    return a + b
</pre></div>
</div>
</div>
</div>
<p>Such type specifications and invariants can be helpful as <em>oracles</em> (to detect deviations from a given set of runs). The chapter gives details on how to customize the properties checked for.</p>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 14.0.2 (20251019.1705)
 -->
<!-- Pages: 1 -->
<svg width="484pt" height="556pt"
 viewBox="0.00 0.00 484.00 556.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 551.5)">
<g id="a_graph0"><a xlink:title="TypeAnnotator class hierarchy">
<polygon fill="white" stroke="none" points="-4,4 -4,-551.5 479.62,-551.5 479.62,4 -4,4"/>
</a>
</g>
<!-- TypeAnnotator -->
<g id="node1" class="node">
<title>TypeAnnotator</title>
<g id="a_node1"><a xlink:href="#" xlink:title="class TypeAnnotator:&#10;A class for tracing a piece of code. Use as `with Tracer(): block()`">
<polygon fill="none" stroke="black" points="0,-6.88 0,-103.88 142,-103.88 142,-6.88 0,-6.88"/>
<text xml:space="preserve" text-anchor="start" x="21.12" y="-87.58" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">TypeAnnotator</text>
<polyline fill="none" stroke="black" points="0,-78.62 142,-78.62"/>
<g id="a_node1_0"><a xlink:href="#" xlink:title="TypeAnnotator">
<g id="a_node1_1"><a xlink:href="#" xlink:title="__repr__(self) &#45;&gt; str:&#10;String representation, like `typed_functions()`">
<text xml:space="preserve" text-anchor="start" x="8" y="-66.12" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__repr__()</text>
</a>
</g>
<g id="a_node1_2"><a xlink:href="#" xlink:title="typed_function(self, function_name: str) &#45;&gt; str:&#10;Return the code for all calls of `function_name` observed, annotated with types">
<text xml:space="preserve" text-anchor="start" x="8" y="-53.38" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">typed_function()</text>
</a>
</g>
<g id="a_node1_3"><a xlink:href="#" xlink:title="typed_function_ast(self, function_name: str) &#45;&gt; Optional[ast.AST]:&#10;Return an AST for all calls of `function_name` observed, annotated with types">
<text xml:space="preserve" text-anchor="start" x="8" y="-40.62" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">typed_function_ast()</text>
</a>
</g>
<g id="a_node1_4"><a xlink:href="#" xlink:title="typed_functions(self) &#45;&gt; str:&#10;Return the code for all functions observed, annotated with types">
<text xml:space="preserve" text-anchor="start" x="8" y="-27.88" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">typed_functions()</text>
</a>
</g>
<g id="a_node1_5"><a xlink:href="#" xlink:title="typed_functions_ast(self) &#45;&gt; Dict[str, ast.AST]:&#10;Return a dict name &#45;&gt; AST for all functions observed, annotated with types">
<text xml:space="preserve" text-anchor="start" x="8" y="-15.12" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">typed_functions_ast()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- TypeTracer -->
<g id="node2" class="node">
<title>TypeTracer</title>
<g id="a_node2"><a xlink:href="#" xlink:title="class TypeTracer:&#10;A class for tracing a piece of code. Use as `with Tracer(): block()`">
<polygon fill="none" stroke="black" points="53.88,-165 53.88,-201 144.12,-201 144.12,-165 53.88,-165"/>
<text xml:space="preserve" text-anchor="start" x="61.88" y="-179.7" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">TypeTracer</text>
</a>
</g>
</g>
<!-- TypeAnnotator&#45;&gt;TypeTracer -->
<g id="edge1" class="edge">
<title>TypeAnnotator&#45;&gt;TypeTracer</title>
<path fill="none" stroke="black" d="M81.67,-104.23C85.4,-120.97 89.46,-139.22 92.72,-153.83"/>
<polygon fill="none" stroke="black" points="89.22,-154.19 94.81,-163.19 96.05,-152.67 89.22,-154.19"/>
</g>
<!-- CallTracer -->
<g id="node3" class="node">
<title>CallTracer</title>
<g id="a_node3"><a xlink:href="#" xlink:title="class CallTracer:&#10;A class for tracing a piece of code. Use as `with Tracer(): block()`">
<polygon fill="none" stroke="black" points="109,-255.75 109,-391 209,-391 209,-255.75 109,-255.75"/>
<text xml:space="preserve" text-anchor="start" x="124.5" y="-374.7" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">CallTracer</text>
<polyline fill="none" stroke="black" points="109,-365.75 209,-365.75"/>
<g id="a_node3_6"><a xlink:href="#" xlink:title="CallTracer">
<g id="a_node3_7"><a xlink:href="#" xlink:title="__init__(self, log: bool = False, **kwargs: Any) &#45;&gt; None:&#10;Create a new tracer.&#10;If `file` is given, output to `file` instead of stdout.">
<text xml:space="preserve" text-anchor="start" x="117" y="-353.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node3_8"><a xlink:href="#" xlink:title="add_call(self, function_name: str, arguments: List[Tuple[str, Any]], return_value: Any = None) &#45;&gt; None:&#10;Add given call to list of calls">
<text xml:space="preserve" text-anchor="start" x="117" y="-339.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">add_call()</text>
</a>
</g>
<g id="a_node3_9"><a xlink:href="#" xlink:title="all_calls(self) &#45;&gt; Dict[str, List[Tuple[List[Tuple[str, Any]], Any]]]:&#10;Return list of calls for function_name,&#10;or a mapping function_name &#45;&gt; calls for all functions tracked">
<text xml:space="preserve" text-anchor="start" x="117" y="-326.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">all_calls()</text>
</a>
</g>
<g id="a_node3_10"><a xlink:href="#" xlink:title="calls(self, function_name: str) &#45;&gt; List[Tuple[List[Tuple[str, Any]], Any]]:&#10;Return list of calls for `function_name`.">
<text xml:space="preserve" text-anchor="start" x="117" y="-314" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">calls()</text>
</a>
</g>
<g id="a_node3_11"><a xlink:href="#" xlink:title="reset(self) &#45;&gt; None">
<text xml:space="preserve" text-anchor="start" x="117" y="-301.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">reset()</text>
</a>
</g>
<g id="a_node3_12"><a xlink:href="#" xlink:title="trace_call(self, frame: frame, event: str, arg: Any) &#45;&gt; None:&#10;Save current function name and args on the stack">
<text xml:space="preserve" text-anchor="start" x="117" y="-288.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">trace_call()</text>
</a>
</g>
<g id="a_node3_13"><a xlink:href="#" xlink:title="trace_return(self, frame: frame, event: str, arg: Any) &#45;&gt; None:&#10;Get return value and store complete call with arguments and return value">
<text xml:space="preserve" text-anchor="start" x="117" y="-275.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">trace_return()</text>
</a>
</g>
<g id="a_node3_14"><a xlink:href="#" xlink:title="traceit(self, frame: frame, event: str, arg: Any) &#45;&gt; None:&#10;Tracking function: Record all calls and all args">
<text xml:space="preserve" text-anchor="start" x="117" y="-264" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">traceit()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- TypeTracer&#45;&gt;CallTracer -->
<g id="edge2" class="edge">
<title>TypeTracer&#45;&gt;CallTracer</title>
<path fill="none" stroke="black" d="M106.48,-201.25C111.45,-212.7 118.36,-228.64 125.54,-245.2"/>
<polygon fill="none" stroke="black" points="122.24,-246.39 129.43,-254.17 128.66,-243.6 122.24,-246.39"/>
</g>
<!-- Tracer -->
<g id="node4" class="node">
<title>Tracer</title>
<g id="a_node4"><a xlink:href="Tracer.ipynb" xlink:title="class Tracer:&#10;A class for tracing a piece of code. Use as `with Tracer(): block()`">
<polygon fill="none" stroke="black" points="129.62,-428 129.62,-464 188.38,-464 188.38,-428 129.62,-428"/>
<text xml:space="preserve" text-anchor="start" x="137.62" y="-442.7" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">Tracer</text>
</a>
</g>
</g>
<!-- CallTracer&#45;&gt;Tracer -->
<g id="edge3" class="edge">
<title>CallTracer&#45;&gt;Tracer</title>
<path fill="none" stroke="black" d="M159,-391.39C159,-400.11 159,-408.64 159,-416.24"/>
<polygon fill="none" stroke="black" points="155.5,-416.15 159,-426.15 162.5,-416.15 155.5,-416.15"/>
</g>
<!-- StackInspector -->
<g id="node5" class="node">
<title>StackInspector</title>
<g id="a_node5"><a xlink:href="StackInspector.ipynb" xlink:title="class StackInspector:&#10;Provide functions to inspect the stack">
<polygon fill="none" stroke="black" points="76,-501 76,-547 242,-547 242,-501 76,-501"/>
<text xml:space="preserve" text-anchor="start" x="108.75" y="-530.7" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">StackInspector</text>
<polyline fill="none" stroke="black" points="76,-521.75 242,-521.75"/>
<g id="a_node5_15"><a xlink:href="#" xlink:title="StackInspector">
<g id="a_node5_16"><a xlink:href="StackInspector.ipynb" xlink:title="_generated_function_cache = {}">
<text xml:space="preserve" text-anchor="start" x="84" y="-508.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">_generated_function_cache</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- Tracer&#45;&gt;StackInspector -->
<g id="edge4" class="edge">
<title>Tracer&#45;&gt;StackInspector</title>
<path fill="none" stroke="black" d="M159,-464.25C159,-471.65 159,-480.58 159,-489.21"/>
<polygon fill="none" stroke="black" points="155.5,-489.11 159,-499.11 162.5,-489.11 155.5,-489.11"/>
</g>
<!-- InvariantAnnotator -->
<g id="node6" class="node">
<title>InvariantAnnotator</title>
<g id="a_node6"><a xlink:href="#" xlink:title="class InvariantAnnotator:&#10;A class for tracing a piece of code. Use as `with Tracer(): block()`">
<polygon fill="none" stroke="black" points="160,-0.5 160,-110.25 338,-110.25 338,-0.5 160,-0.5"/>
<text xml:space="preserve" text-anchor="start" x="186.38" y="-93.95" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">InvariantAnnotator</text>
<polyline fill="none" stroke="black" points="160,-85 338,-85"/>
<g id="a_node6_17"><a xlink:href="#" xlink:title="InvariantAnnotator">
<g id="a_node6_18"><a xlink:href="#" xlink:title="__repr__(self) &#45;&gt; str:&#10;String representation, like `functions_with_invariants()`">
<text xml:space="preserve" text-anchor="start" x="168" y="-72.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__repr__()</text>
</a>
</g>
<g id="a_node6_19"><a xlink:href="#" xlink:title="function_with_invariants(self, function_name: str) &#45;&gt; str:&#10;Return the code of `function_name`, annotated with invariants">
<text xml:space="preserve" text-anchor="start" x="168" y="-59.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">function_with_invariants()</text>
</a>
</g>
<g id="a_node6_20"><a xlink:href="#" xlink:title="functions_with_invariants(self) &#45;&gt; str:&#10;Return the code of all observed functions, annotated with invariants">
<text xml:space="preserve" text-anchor="start" x="168" y="-47" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">functions_with_invariants()</text>
</a>
</g>
<g id="a_node6_21"><a xlink:href="#" xlink:title="postconditions(self, function_name: str) &#45;&gt; List[str]:&#10;Return a list of mined postconditions for `function_name`">
<text xml:space="preserve" text-anchor="start" x="168" y="-34.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">postconditions()</text>
</a>
</g>
<g id="a_node6_22"><a xlink:href="#" xlink:title="preconditions(self, function_name: str) &#45;&gt; List[str]:&#10;Return a list of mined preconditions for `function_name`">
<text xml:space="preserve" text-anchor="start" x="168" y="-21.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">preconditions()</text>
</a>
</g>
<g id="a_node6_23"><a xlink:href="#" xlink:title="params(self, function_name: str) &#45;&gt; str">
<text xml:space="preserve" text-anchor="start" x="168" y="-7.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">params()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- InvariantTracer -->
<g id="node7" class="node">
<title>InvariantTracer</title>
<g id="a_node7"><a xlink:href="#" xlink:title="class InvariantTracer:&#10;A class for tracing a piece of code. Use as `with Tracer(): block()`">
<polygon fill="none" stroke="black" points="175.75,-147.25 175.75,-218.75 292.25,-218.75 292.25,-147.25 175.75,-147.25"/>
<text xml:space="preserve" text-anchor="start" x="183.75" y="-202.45" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">InvariantTracer</text>
<polyline fill="none" stroke="black" points="175.75,-193.5 292.25,-193.5"/>
<g id="a_node7_24"><a xlink:href="#" xlink:title="InvariantTracer">
<g id="a_node7_25"><a xlink:href="#" xlink:title="__init__(self, props: Optional[List[str]] = None, **kwargs: Any) &#45;&gt; None:&#10;Create a new tracer.&#10;If `file` is given, output to `file` instead of stdout.">
<text xml:space="preserve" text-anchor="start" x="186" y="-181" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node7_26"><a xlink:href="#" xlink:title="all_invariants(self) &#45;&gt; Dict[str, Set[Tuple[str, Tuple[str, ...]]]]">
<text xml:space="preserve" text-anchor="start" x="186" y="-167.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">all_invariants()</text>
</a>
</g>
<g id="a_node7_27"><a xlink:href="#" xlink:title="invariants(self, function_name: str) &#45;&gt; Set[Tuple[str, Tuple[str, ...]]]">
<text xml:space="preserve" text-anchor="start" x="186" y="-154.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">invariants()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- InvariantAnnotator&#45;&gt;InvariantTracer -->
<g id="edge5" class="edge">
<title>InvariantAnnotator&#45;&gt;InvariantTracer</title>
<path fill="none" stroke="black" d="M242.51,-110.75C241.53,-118.94 240.53,-127.34 239.57,-135.35"/>
<polygon fill="none" stroke="black" points="236.1,-134.91 238.39,-145.26 243.05,-135.74 236.1,-134.91"/>
</g>
<!-- InvariantTracer&#45;&gt;CallTracer -->
<g id="edge6" class="edge">
<title>InvariantTracer&#45;&gt;CallTracer</title>
<path fill="none" stroke="black" d="M215.07,-218.92C210.64,-227.09 205.75,-236.12 200.76,-245.33"/>
<polygon fill="none" stroke="black" points="197.73,-243.58 196.04,-254.04 203.88,-246.92 197.73,-243.58"/>
</g>
<!-- Legend -->
<g id="node8" class="node">
<title>Legend</title>
<text xml:space="preserve" text-anchor="start" x="356.38" y="-71.38" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="10.00" fill="#6a0dad">Legend</text>
<text xml:space="preserve" text-anchor="start" x="356.38" y="-61.38" font-family="Raleway, Helvetica, Arial, sans-serif" font-size="10.00"></text>
<text xml:space="preserve" text-anchor="start" x="362.38" y="-61.38" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="8.00">public_method()</text>
<text xml:space="preserve" text-anchor="start" x="356.38" y="-51.38" font-family="Raleway, Helvetica, Arial, sans-serif" font-size="10.00"></text>
<text xml:space="preserve" text-anchor="start" x="362.38" y="-51.38" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="8.00">private_method()</text>
<text xml:space="preserve" text-anchor="start" x="356.38" y="-41.38" font-family="Raleway, Helvetica, Arial, sans-serif" font-size="10.00"></text>
<text xml:space="preserve" text-anchor="start" x="362.38" y="-41.38" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="8.00">overloaded_method()</text>
<text xml:space="preserve" text-anchor="start" x="356.38" y="-32.33" font-family="Helvetica,sans-Serif" font-size="9.00">Hover over names to see doc</text>
</g>
</g>
</svg>
</div></div>
</div>
</section>
<section id="specifications-and-assertions">
<h2>Specifications and Assertions<a class="headerlink" href="#specifications-and-assertions" title="Link to this heading">#</a></h2>
<p>When implementing a function or program, one usually works against a <em>specification</em>  a set of documented requirements to be satisfied by the code.  Such specifications can come in natural language.  A formal specification, however, allows the computer to check whether the specification is satisfied.</p>
<p>In the <a class="reference internal" href="Assertions.html"><span class="std std-doc">chapter on assertions</span></a>, we have seen how <em>preconditions</em> and <em>postconditions</em> can describe what a function does.  Consider the following (simple) square root function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">square_root</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="k">assert</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span>  <span class="c1"># Precondition</span>

    <span class="o">...</span>

    <span class="k">assert</span> <span class="n">result</span> <span class="o">*</span> <span class="n">result</span> <span class="o">==</span> <span class="n">x</span>  <span class="c1"># Postcondition</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</div>
</div>
<p>The assertion <code class="docutils literal notranslate"><span class="pre">assert</span> <span class="pre">p</span></code> checks the condition <code class="docutils literal notranslate"><span class="pre">p</span></code>; if it does not hold, execution is aborted.  Here, the actual body is not yet written; we use the assertions as a specification of what <code class="docutils literal notranslate"><span class="pre">square_root()</span></code> <em>expects</em>, and what it <em>delivers</em>.</p>
<p>The topmost assertion is the <em>precondition</em>, stating the requirements on the function arguments.  The assertion at the end is the <em>postcondition</em>, stating the properties of the function result (including its relationship with the original arguments).  Using these pre- and postconditions as a specification, we can now go and implement a square root function that satisfies them.  Once implemented, we can have the assertions check at runtime whether <code class="docutils literal notranslate"><span class="pre">square_root()</span></code> works as expected.</p>
<p>However, not every piece of code is developed with explicit specifications in the first place; let alone does most code comes with formal pre- and post-conditions.  (Just take a look at the chapters in this book.)  This is a pity: As Ken Thompson famously said, Without specifications, there are no bugs only surprises.  It is also a problem for debugging, since, of course, debugging needs some specification such that we know what is wrong, and how to fix it.  This raises the interesting question: Can we somehow <em>retrofit</em> existing code with specifications that properly describe their behavior, allowing developers to simply <em>check</em> them rather than having to write them from scratch?  This is what we do in this chapter.</p>
</section>
<section id="beyond-generic-failures">
<h2>Beyond Generic Failures<a class="headerlink" href="#beyond-generic-failures" title="Link to this heading">#</a></h2>
<p>Before we go into <em>mining</em> specifications, let us first discuss why it could be useful to <em>have</em> them.  As a motivating example, consider the full implementation of <code class="docutils literal notranslate"><span class="pre">square_root()</span></code> from the <a class="reference internal" href="Assertions.html"><span class="std std-doc">chapter on assertions</span></a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">bookutils.setup</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">square_root</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes the square root of x, using the Newton-Raphson method&quot;&quot;&quot;</span>
    <span class="n">approx</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">guess</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">while</span> <span class="n">approx</span> <span class="o">!=</span> <span class="n">guess</span><span class="p">:</span>
        <span class="n">approx</span> <span class="o">=</span> <span class="n">guess</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="p">(</span><span class="n">approx</span> <span class="o">+</span> <span class="n">x</span> <span class="o">/</span> <span class="n">approx</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="k">return</span> <span class="n">approx</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">square_root()</span></code> does not come with any functionality that would check types or values.  Hence, it is easy for callers to make mistakes when calling <code class="docutils literal notranslate"><span class="pre">square_root()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ExpectError</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExpectError</span><span class="p">,</span> <span class="n">ExpectTimeout</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">square_root</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_52062/1219646233.py&quot;, line 2, in &lt;module&gt;
    square_root(&quot;foo&quot;)
    ~~~~~~~~~~~^^^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_52062/81976482.py&quot;, line 4, in square_root
    guess = x / 2
            ~~^~~
TypeError: unsupported operand type(s) for /: &#39;str&#39; and &#39;int&#39; (expected)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_52062/3113108935.py&quot;, line 2, in &lt;module&gt;
    x = square_root(0.0)
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_52062/81976482.py&quot;, line 7, in square_root
    guess = (approx + x / approx) / 2
                      ~~^~~~~~~~
ZeroDivisionError: float division by zero (expected)
</pre></div>
</div>
</div>
</div>
<p>At least, the Python system catches these errors at runtime.  The following call, however, simply lets the function enter an infinite loop:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectTimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_52062/3421421264.py&quot;, line 2, in &lt;module&gt;
    x = square_root(-1.0)
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_52062/81976482.py&quot;, line 5, in square_root
    while approx != guess:
          ^^^^^^^^^^^^^^^
  File &quot;Timeout.ipynb&quot;, line 43, in timeout_handler
    raise TimeoutError()
TimeoutError (expected)
</pre></div>
</div>
</div>
</div>
<p>Our goal is to avoid such errors by <em>annotating</em> functions with information that prevents errors like the above ones.  The idea is to provide a <em>specification</em> of expected properties a specification that can then be checked at runtime or statically.</p>
<p>\todo{Introduce the concept of <em>contract</em>.}</p>
</section>
<section id="mining-data-types">
<h2>Mining Data Types<a class="headerlink" href="#mining-data-types" title="Link to this heading">#</a></h2>
<p>For our Python code, one of the most important specifications we need is <em>types</em>.  Python being a dynamically typed language means that all data types are determined at run time; the code itself does not explicitly state whether a variable is an integer, a string, an array, a dictionary  or whatever.</p>
<p>As <em>writer</em> of Python code, omitting explicit type declarations may save time (and allows for some fun hacks).  It is not sure whether a lack of types helps in <em>reading</em> and <em>understanding</em> code for humans.  For a <em>computer</em> trying to analyze code, the lack of explicit types is detrimental.  If, say, a constraint solver, sees <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">x:</span></code> and cannot know whether <code class="docutils literal notranslate"><span class="pre">x</span></code> is supposed to be a number or a string, this introduces an <em>ambiguity</em>.  Such ambiguities may multiply over the entire analysis in a combinatorial explosion  or in the analysis yielding an overly inaccurate result.</p>
<p>Python 3.6 and later allow data types as <em>annotations</em> to function arguments (actually, to all variables) and return values.  We can, for instance, state that <code class="docutils literal notranslate"><span class="pre">square_root()</span></code> is a function that accepts a floating-point value and returns one:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">square_root_with_type_annotations</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes the square root of x, using the Newton-Raphson method&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">square_root</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>By default, such annotations are ignored by the Python interpreter.  Therefore, one can still call <code class="docutils literal notranslate"><span class="pre">square_root_typed()</span></code> with a string as an argument and get the exact same result as above.  However, one can make use of special <em>type checking</em> modules that would check types <em>dynamically</em> at runtime or <em>statically</em> by analyzing the code without having to execute it.</p>
<section id="excursion-runtime-type-checking">
<h3>Excursion: Runtime Type Checking<a class="headerlink" href="#excursion-runtime-type-checking" title="Link to this heading">#</a></h3>
<p><em>Please note: <code class="docutils literal notranslate"><span class="pre">enforce</span></code> no longer runs on Python 3.7 and later, so this section is commented out</em></p>
<p>The Python <code class="docutils literal notranslate"><span class="pre">enforce</span></code> package provides a function decorator that automatically inserts type-checking code that is executed at runtime.  Here is how to use it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import enforce</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @enforce.runtime_validation</span>
<span class="c1"># def square_root_with_checked_type_annotations(x: float) -&gt; float:</span>
<span class="c1">#     &quot;&quot;&quot;Computes the square root of x, using the Newton-Raphson method&quot;&quot;&quot;</span>
<span class="c1">#     return square_root(x)</span>
</pre></div>
</div>
</div>
</div>
<p>Now, invoking <code class="docutils literal notranslate"><span class="pre">square_root_with_checked_type_annotations()</span></code> raises an exception when invoked with a type dfferent from the one declared:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># with ExpectError():</span>
<span class="c1">#     square_root_with_checked_type_annotations(True)</span>
</pre></div>
</div>
</div>
</div>
<p>Note that this error is not caught by the untyped variant, where passing a boolean value happily returns <span class="math notranslate nohighlight">\(\sqrt{1}\)</span> as result.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># square_root(True)</span>
</pre></div>
</div>
</div>
</div>
<p>In Python (and other languages), the boolean values <code class="docutils literal notranslate"><span class="pre">True</span></code> and <code class="docutils literal notranslate"><span class="pre">False</span></code> can be implicitly converted to the integers 1 and 0; however, it is hard to think of a call to <code class="docutils literal notranslate"><span class="pre">sqrt()</span></code> where this would not be an error.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">quiz</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">What happens if we call <code>square_root_with_checked_type_annotations(1)</code>?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">
    
        <input type="radio" name="f7f2cb0c-b293-11f0-88db-6298cf1a5790" id="f7f2cb0c-b293-11f0-88db-6298cf1a5790-1" onclick="clear_selection('f7f2cb0c-b293-11f0-88db-6298cf1a5790')">
        <label id="f7f2cb0c-b293-11f0-88db-6298cf1a5790-1-label" for="f7f2cb0c-b293-11f0-88db-6298cf1a5790-1"><code>1</code> is automatically converted to float. It will pass.</label><br>
    
        <input type="radio" name="f7f2cb0c-b293-11f0-88db-6298cf1a5790" id="f7f2cb0c-b293-11f0-88db-6298cf1a5790-2" onclick="clear_selection('f7f2cb0c-b293-11f0-88db-6298cf1a5790')">
        <label id="f7f2cb0c-b293-11f0-88db-6298cf1a5790-2-label" for="f7f2cb0c-b293-11f0-88db-6298cf1a5790-2"><code>1</code> is a subtype of float. It will pass.</label><br>
    
        <input type="radio" name="f7f2cb0c-b293-11f0-88db-6298cf1a5790" id="f7f2cb0c-b293-11f0-88db-6298cf1a5790-3" onclick="clear_selection('f7f2cb0c-b293-11f0-88db-6298cf1a5790')">
        <label id="f7f2cb0c-b293-11f0-88db-6298cf1a5790-3-label" for="f7f2cb0c-b293-11f0-88db-6298cf1a5790-3"><code>1</code> is an integer, and no float. The type check will fail.</label><br>
    
        <input type="radio" name="f7f2cb0c-b293-11f0-88db-6298cf1a5790" id="f7f2cb0c-b293-11f0-88db-6298cf1a5790-4" onclick="clear_selection('f7f2cb0c-b293-11f0-88db-6298cf1a5790')">
        <label id="f7f2cb0c-b293-11f0-88db-6298cf1a5790-4-label" for="f7f2cb0c-b293-11f0-88db-6298cf1a5790-4">The function will fail for some other reason.</label><br>
    
    </div>
    </p>
    <input id="f7f2cb0c-b293-11f0-88db-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('f7f2cb0c-b293-11f0-88db-6298cf1a5790', 8, 0, '37035 // 12345')">
    <span class="quiz_hint" id="f7f2cb0c-b293-11f0-88db-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
<p>Prediction is very difficult, especially when the future is concerned (Niels Bohr). We can find out by a simple experiment that <code class="docutils literal notranslate"><span class="pre">float</span></code> actually means <code class="docutils literal notranslate"><span class="pre">float</span></code>  and not <code class="docutils literal notranslate"><span class="pre">int</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># with ExpectError(enforce.exceptions.RuntimeTypeError):</span>
<span class="c1">#     square_root_with_checked_type_annotations(1)</span>
</pre></div>
</div>
</div>
</div>
<p>To allow <code class="docutils literal notranslate"><span class="pre">int</span></code> as a type, we need to specify a <em>union</em> of types.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @enforce.runtime_validation</span>
<span class="c1"># def square_root_with_union_type(x: Union[int, float]) -&gt; float:</span>
<span class="c1">#     &quot;&quot;&quot;Computes the square root of x, using the Newton-Raphson method&quot;&quot;&quot;</span>
<span class="c1">#     return square_root(x)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># square_root_with_union_type(2)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># square_root_with_union_type(2.0)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># with ExpectError(enforce.exceptions.RuntimeTypeError):</span>
<span class="c1">#     square_root_with_union_type(&quot;Two dot zero&quot;)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="end-of-excursion">
<h3>End of Excursion<a class="headerlink" href="#end-of-excursion" title="Link to this heading">#</a></h3>
</section>
<section id="static-type-checking">
<h3>Static Type Checking<a class="headerlink" href="#static-type-checking" title="Link to this heading">#</a></h3>
<p>Type annotations can also be checked <em>statically</em> that is, without even running the code.  Let us create a simple Python file consisting of the above <code class="docutils literal notranslate"><span class="pre">square_root_typed()</span></code> definition and a bad invocation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.py&#39;</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/tmp7gclqo71.py&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">square_root</span><span class="p">))</span>
<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">square_root_with_type_annotations</span><span class="p">))</span>
<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;print(square_root_with_type_annotations(&#39;123&#39;))</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>These are the contents of our newly created Python file:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_file</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_file</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">start_line_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 1  <span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">square_root</span>(x):  <span class=" -Color -Color-White"># type: ignore</span>
 2  <span class=" -Color -Color-White">    </span><span class=" -Color -Color-Yellow">&quot;&quot;&quot;Computes the square root of x, using the Newton-Raphson method&quot;&quot;&quot;</span>
 3      approx = <span class=" -Color -Color-Blue">None</span>
 4      guess = x / <span class=" -Color -Color-Blue">2</span>
 5      <span class=" -Color -Color-Blue">while</span> approx != guess:
 6          approx = guess
 7          guess = (approx + x / approx) / <span class=" -Color -Color-Blue">2</span>
 8  
 9      <span class=" -Color -Color-Blue">return</span> approx
10  
11  <span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">square_root_with_type_annotations</span>(x: <span class=" -Color -Color-Cyan">float</span>) -&gt; <span class=" -Color -Color-Cyan">float</span>:
12  <span class=" -Color -Color-White">    </span><span class=" -Color -Color-Yellow">&quot;&quot;&quot;Computes the square root of x, using the Newton-Raphson method&quot;&quot;&quot;</span>
13      <span class=" -Color -Color-Blue">return</span> square_root(x)
14  
15  <span class=" -Color -Color-Cyan">print</span>(square_root_with_type_annotations(<span class=" -Color -Color-Yellow">&#39;123&#39;</span>))
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="http://mypy-lang.org">Mypy</a> is a type checker for Python programs.  As it checks types statically, types induce no overhead at runtime; plus, a static check can be faster than a lengthy series of tests with runtime type checking enabled.  Let us see what <code class="docutils literal notranslate"><span class="pre">mypy</span></code> produces on the above file:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;mypy&quot;</span><span class="p">,</span> <span class="s2">&quot;--strict&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
                        <span class="n">universal_newlines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
<span class="k">del</span> <span class="n">f</span>  <span class="c1"># Delete temporary file</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>13: <span class=" -Color -Color-Bold -Color-Bold-Red">error:</span> Returning Any from function declared to return <span class=" -Color -Color-Bold">&quot;float&quot;</span>  <span class=" -Color -Color-Yellow">[no-any-return]</span>
13: <span class=" -Color -Color-Bold -Color-Bold-Red">error:</span> Call to untyped function <span class=" -Color -Color-Bold">&quot;square_root&quot;</span> in typed context  <span class=" -Color -Color-Yellow">[no-untyped-call]</span>
15: <span class=" -Color -Color-Bold -Color-Bold-Red">error:</span> Argument 1 to <span class=" -Color -Color-Bold">&quot;square_root_with_type_annotations&quot;</span> has incompatible type <span class=" -Color -Color-Bold">&quot;str&quot;</span>; expected <span class=" -Color -Color-Bold">&quot;float&quot;</span>  <span class=" -Color -Color-Yellow">[arg-type]</span>
<span class=" -Color -Color-Bold -Color-Bold-Red">Found 3 errors in 1 file (checked 1 source file)</span>
</pre></div>
</div>
</div>
</div>
<p>We see that <code class="docutils literal notranslate"><span class="pre">mypy</span></code> complains about untyped function definitions such as <code class="docutils literal notranslate"><span class="pre">square_root()</span></code>; most important, however, it finds that the  call to <code class="docutils literal notranslate"><span class="pre">square_root_with_type_annotations()</span></code> in the last line has the wrong type.</p>
<p>With <code class="docutils literal notranslate"><span class="pre">mypy</span></code>, we can achieve the same type safety with Python as in statically typed languages  provided that we as programmers also produce the necessary type annotations.  Is there a simple way to obtain these?</p>
</section>
</section>
<section id="mining-type-specifications">
<h2>Mining Type Specifications<a class="headerlink" href="#mining-type-specifications" title="Link to this heading">#</a></h2>
<p>Our first task will be to mine type annotations (as part of the code) from <em>values</em> we observe at run time.  These type annotations would be <em>mined</em> from actual function executions, <em>learning</em> from (normal) runs what the expected argument and return types should be.  By observing a series of calls such as these, we could infer that both <code class="docutils literal notranslate"><span class="pre">x</span></code> and the return value are of type <code class="docutils literal notranslate"><span class="pre">float</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">25.0</span><span class="p">)</span>
<span class="n">y</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
<span class="n">y</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.414213562373095
</pre></div>
</div>
</div>
</div>
<p>How can we mine types from executions?  The answer is simple:</p>
<ol class="arabic simple">
<li><p>We <em>observe</em> a function during execution</p></li>
<li><p>We track the <em>types</em> of its arguments</p></li>
<li><p>We include these types as <em>annotations</em> into the code.</p></li>
</ol>
<p>To do so, we can make use of Pythons tracing facility we already observed in the <a class="reference internal" href="Tracer.html"><span class="std std-doc">chapter on tracing executions</span></a>.  With every call to a function, we retrieve the arguments, their values, and their types.</p>
<section id="tracing-calls">
<h3>Tracing Calls<a class="headerlink" href="#tracing-calls" title="Link to this heading">#</a></h3>
<p>To observe argument types at runtime, we define a <em>tracer function</em> that tracks the execution of <code class="docutils literal notranslate"><span class="pre">square_root()</span></code>, checking its arguments and return values.  The <code class="docutils literal notranslate"><span class="pre">CallTracer</span></code> class is set to trace functions in a <code class="docutils literal notranslate"><span class="pre">with</span></code> block as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">CallTracer</span><span class="p">()</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">function_to_be_tracked</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">info</span> <span class="o">=</span> <span class="n">tracer</span><span class="o">.</span><span class="n">collected_information</span><span class="p">()</span>
</pre></div>
</div>
<p>To create the tracer, we build on the <code class="docutils literal notranslate"><span class="pre">Tracer</span></code> superclass as in the <a class="reference internal" href="Tracer.html"><span class="std std-doc">chapter on tracing executions</span></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">types</span><span class="w"> </span><span class="kn">import</span> <span class="n">FrameType</span>
</pre></div>
</div>
</div>
</div>
<p>We start with two helper functions. <code class="docutils literal notranslate"><span class="pre">get_arguments()</span></code> returns a list of call arguments in the given call frame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Arguments</span> <span class="o">=</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_arguments</span><span class="p">(</span><span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Arguments</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return call arguments in the given frame&quot;&quot;&quot;</span>
    <span class="c1"># When called, all arguments are local variables</span>
    <span class="n">local_variables</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">)</span>  <span class="c1"># explicit copy</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="p">[(</span><span class="n">var</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="n">var</span><span class="p">])</span> 
                 <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">local_variables</span><span class="p">]</span>

    <span class="c1"># FIXME: This may be needed for Python &lt; 3.10</span>
    <span class="c1"># arguments.reverse()  # Want same order as call</span>

    <span class="k">return</span> <span class="n">arguments</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">simple_call_string()</span></code> is a helper for logging that prints out calls in a user-friendly manner.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">simple_call_string</span><span class="p">(</span><span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">argument_list</span><span class="p">:</span> <span class="n">Arguments</span><span class="p">,</span>
                       <span class="n">return_value</span> <span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return function_name(arg[0], arg[1], ...) as a string&quot;&quot;&quot;</span>
    <span class="n">call</span> <span class="o">=</span> <span class="n">function_name</span> <span class="o">+</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> \
        <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">var</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                   <span class="k">for</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">argument_list</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>

    <span class="k">if</span> <span class="n">return_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">call</span> <span class="o">+=</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">return_value</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">call</span>
</pre></div>
</div>
</div>
</div>
<p>Now for <code class="docutils literal notranslate"><span class="pre">CallTracer</span></code>. The constructor simply invokes the <code class="docutils literal notranslate"><span class="pre">Tracer</span></code> constructor:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CallTracer</span><span class="p">(</span><span class="n">Tracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span><span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span> <span class="o">=</span> <span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Arguments</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stack</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Arguments</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">traceit()</span></code> method does nothing yet; this is done in specialized subclasses.  The <code class="docutils literal notranslate"><span class="pre">CallTracer</span></code> class implements a <code class="docutils literal notranslate"><span class="pre">traceit()</span></code> function that checks for function calls and returns:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CallTracer</span><span class="p">(</span><span class="n">CallTracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">traceit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tracking function: Record all calls and all args&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s2">&quot;call&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace_call</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="s2">&quot;return&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace_return</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">trace_call()</span></code> is called when a function is called; it retrieves the function name and current arguments, and saves them on a stack.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CallTracer</span><span class="p">(</span><span class="n">CallTracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">trace_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save current function name and args on the stack&quot;&quot;&quot;</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span>
        <span class="n">function_name</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">co_name</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="n">get_arguments</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">function_name</span><span class="p">,</span> <span class="n">arguments</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">simple_call_string</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">arguments</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>When the function returns, <code class="docutils literal notranslate"><span class="pre">trace_return()</span></code> is called.  We now also have the return value.  We log the whole call with arguments and return value (if desired) and save it in our list of calls.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CallTracer</span><span class="p">(</span><span class="n">CallTracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">trace_return</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get return value and store complete call with arguments and return value&quot;&quot;&quot;</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span>
        <span class="n">function_name</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">co_name</span>
        <span class="n">return_value</span> <span class="o">=</span> <span class="n">arg</span>
        <span class="c1"># TODO: Could call get_arguments() here</span>
        <span class="c1"># to also retrieve _final_ values of argument variables</span>

        <span class="n">called_function_name</span><span class="p">,</span> <span class="n">called_arguments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">function_name</span> <span class="o">==</span> <span class="n">called_function_name</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">simple_call_string</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">called_arguments</span><span class="p">),</span> <span class="s2">&quot;returns&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_call</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">called_arguments</span><span class="p">,</span> <span class="n">return_value</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">add_call()</span></code> saves the calls in a list; each function name has its own list.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CallTracer</span><span class="p">(</span><span class="n">CallTracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">Arguments</span><span class="p">,</span>
                 <span class="n">return_value</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add given call to list of calls&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">function_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="p">[</span><span class="n">function_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="p">[</span><span class="n">function_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">arguments</span><span class="p">,</span> <span class="n">return_value</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>we can retrieve the list of calls, either for a given function name (<code class="docutils literal notranslate"><span class="pre">calls()</span></code>),
or for all functions (<code class="docutils literal notranslate"><span class="pre">all_calls()</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CallTracer</span><span class="p">(</span><span class="n">CallTracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">calls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Arguments</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return list of calls for `function_name`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="p">[</span><span class="n">function_name</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CallTracer</span><span class="p">(</span><span class="n">CallTracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">all_calls</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Arguments</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return list of calls for function_name, </span>
<span class="sd">        or a mapping function_name -&gt; calls for all functions tracked</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span>
</pre></div>
</div>
</div>
</div>
<p>Let us now put this to use.  We turn on logging to track the individual calls and their return values:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">CallTracer</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>square_root(x=25)
square_root(x=25) returns 5.0
square_root(x=2.0)
square_root(x=2.0) returns 1.414213562373095
</pre></div>
</div>
</div>
</div>
<p>After execution, we can retrieve the individual calls:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">calls</span> <span class="o">=</span> <span class="n">tracer</span><span class="o">.</span><span class="n">calls</span><span class="p">(</span><span class="s1">&#39;square_root&#39;</span><span class="p">)</span>
<span class="n">calls</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[([(&#39;x&#39;, 25)], 5.0), ([(&#39;x&#39;, 2.0)], 1.414213562373095)]
</pre></div>
</div>
</div>
</div>
<p>Each call is a pair (<code class="docutils literal notranslate"><span class="pre">argument_list</span></code>, <code class="docutils literal notranslate"><span class="pre">return_value</span></code>), where <code class="docutils literal notranslate"><span class="pre">argument_list</span></code> is a list of pairs (<code class="docutils literal notranslate"><span class="pre">parameter_name</span></code>, <code class="docutils literal notranslate"><span class="pre">value</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">square_root_argument_list</span><span class="p">,</span> <span class="n">square_root_return_value</span> <span class="o">=</span> <span class="n">calls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">simple_call_string</span><span class="p">(</span><span class="s1">&#39;square_root&#39;</span><span class="p">,</span> <span class="n">square_root_argument_list</span><span class="p">,</span> <span class="n">square_root_return_value</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;square_root(x=25) = 5.0&#39;
</pre></div>
</div>
</div>
</div>
<p>If the function does not return a value, <code class="docutils literal notranslate"><span class="pre">return_value</span></code> is <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">hello</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hello,&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">CallTracer</span><span class="p">()</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">hello</span><span class="p">(</span><span class="s2">&quot;world&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Hello, world
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hello_calls</span> <span class="o">=</span> <span class="n">tracer</span><span class="o">.</span><span class="n">calls</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
<span class="n">hello_calls</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[([(&#39;name&#39;, &#39;world&#39;)], None)]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hello_argument_list</span><span class="p">,</span> <span class="n">hello_return_value</span> <span class="o">=</span> <span class="n">hello_calls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">simple_call_string</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="n">hello_argument_list</span><span class="p">,</span> <span class="n">hello_return_value</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&quot;hello(name=&#39;world&#39;)&quot;
</pre></div>
</div>
</div>
</div>
</section>
<section id="getting-types">
<h3>Getting Types<a class="headerlink" href="#getting-types" title="Link to this heading">#</a></h3>
<p>Despite what you may have read or heard, Python actually <em>is</em> a typed language.  It is just that it is <em>dynamically typed</em>  types are used and checked only at runtime (rather than declared in the code, where they can be <em>statically checked</em> at compile time).  We can thus retrieve types of all values within Python:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>int
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>float
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span><span class="p">([</span><span class="mi">4</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>list
</pre></div>
</div>
</div>
</div>
<p>We can retrieve the type of the first argument to <code class="docutils literal notranslate"><span class="pre">square_root()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">parameter</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">square_root_argument_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">parameter</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;x&#39;, int)
</pre></div>
</div>
</div>
</div>
<p>as well as the type of the return value:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span><span class="p">(</span><span class="n">square_root_return_value</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>float
</pre></div>
</div>
</div>
</div>
<p>Hence, we see that (so far), <code class="docutils literal notranslate"><span class="pre">square_root()</span></code> is a function taking (among others) integers and returning floats.  We could declare <code class="docutils literal notranslate"><span class="pre">square_root()</span></code> as:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">square_root_annotated</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">square_root</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This is a representation we could place in a static type checker, allowing to check whether calls to <code class="docutils literal notranslate"><span class="pre">square_root()</span></code> actually pass a number.  A dynamic type checker could run such checks at runtime.</p>
<p>By default, Python does not do anything with such annotations.  However, tools can access annotations from functions and other objects:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">square_root_annotated</span><span class="o">.</span><span class="vm">__annotations__</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;x&#39;: int, &#39;return&#39;: float}
</pre></div>
</div>
</div>
</div>
<p>This is how run-time checkers access the annotations to check against.</p>
</section>
<section id="annotating-functions-with-types">
<h3>Annotating Functions with Types<a class="headerlink" href="#annotating-functions-with-types" title="Link to this heading">#</a></h3>
<p>Our plan is to annotate functions automatically, based on the types we have seen. Our aim is to build a class <code class="docutils literal notranslate"><span class="pre">TypeAnnotator</span></code> that can be used as follows. First, it would track some execution:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">TypeAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">some_function_call</span><span class="p">()</span>
</pre></div>
</div>
<p>After tracking, <code class="docutils literal notranslate"><span class="pre">TypeAnnotator</span></code> would provide appropriate methods to access (type-)annotated versions of the function seen:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">typed_functions</span><span class="p">())</span>
</pre></div>
</div>
<p>Let us put the pieces together to build <code class="docutils literal notranslate"><span class="pre">TypeAnnotator</span></code>.</p>
<section id="excursion-accessing-function-structure">
<h4>Excursion: Accessing Function Structure<a class="headerlink" href="#excursion-accessing-function-structure" title="Link to this heading">#</a></h4>
<p>To annotate functions, we need to convert a function into a tree representation (called <em>abstract syntax trees</em>, or ASTs) and back; we already have seen these in the chapter on <a class="reference internal" href="Slicer.html"><span class="std std-doc">tracking value origins</span></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">ast</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
</pre></div>
</div>
</div>
</div>
<p>We can get the source of a Python function using <code class="docutils literal notranslate"><span class="pre">inspect.getsource()</span></code>.  (Note that this does not work for functions defined in other notebooks.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">square_root_source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">square_root</span><span class="p">)</span>
<span class="n">square_root_source</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;def square_root(x):  # type: ignore\n    &quot;&quot;&quot;Computes the square root of x, using the Newton-Raphson method&quot;&quot;&quot;\n    approx = None\n    guess = x / 2\n    while approx != guess:\n        approx = guess\n        guess = (approx + x / approx) / 2\n\n    return approx\n&#39;
</pre></div>
</div>
</div>
</div>
<p>To view these in a visually pleasing form, our function <code class="docutils literal notranslate"><span class="pre">print_content(s,</span> <span class="pre">suffix)</span></code> formats and highlights the string <code class="docutils literal notranslate"><span class="pre">s</span></code> as if it were a file with ending <code class="docutils literal notranslate"><span class="pre">suffix</span></code>.  We can thus view (and highlight) the source as if it were a Python file:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_content</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">square_root_source</span><span class="p">,</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">square_root</span>(x):  <span class=" -Color -Color-White"># type: ignore</span>
<span class=" -Color -Color-White">    </span><span class=" -Color -Color-Yellow">&quot;&quot;&quot;Computes the square root of x, using the Newton-Raphson method&quot;&quot;&quot;</span>
    approx = <span class=" -Color -Color-Blue">None</span>
    guess = x / <span class=" -Color -Color-Blue">2</span>
    <span class=" -Color -Color-Blue">while</span> approx != guess:
        approx = guess
        guess = (approx + x / approx) / <span class=" -Color -Color-Blue">2</span>

    <span class=" -Color -Color-Blue">return</span> approx
</pre></div>
</div>
</div>
</div>
<p>Parsing this gives us an abstract syntax tree (AST) a representation of the program in tree form.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">square_root_ast</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">square_root_source</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>What does this AST look like?  The helper functions <code class="docutils literal notranslate"><span class="pre">ast.dump()</span></code> (textual output) and <code class="docutils literal notranslate"><span class="pre">showast.show_ast()</span></code> (graphical output with <a class="reference external" href="https://github.com/hchasestevens/show_ast">showast</a>) allow us to inspect the structure of the tree.  We see that the function starts as a <code class="docutils literal notranslate"><span class="pre">FunctionDef</span></code> with name and arguments, followed by a body, which is a list of statements of type <code class="docutils literal notranslate"><span class="pre">Expr</span></code> (the docstring), type <code class="docutils literal notranslate"><span class="pre">Assign</span></code> (assignments), <code class="docutils literal notranslate"><span class="pre">While</span></code> (while loop with its own body), and finally <code class="docutils literal notranslate"><span class="pre">Return</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">square_root_ast</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Module(
    body=[
        FunctionDef(
            name=&#39;square_root&#39;,
            args=arguments(
                args=[
                    arg(arg=&#39;x&#39;)]),
            body=[
                Expr(
                    value=Constant(value=&#39;Computes the square root of x, using the Newton-Raphson method&#39;)),
                Assign(
                    targets=[
                        Name(id=&#39;approx&#39;, ctx=Store())],
                    value=Constant(value=None)),
                Assign(
                    targets=[
                        Name(id=&#39;guess&#39;, ctx=Store())],
                    value=BinOp(
                        left=Name(id=&#39;x&#39;, ctx=Load()),
                        op=Div(),
                        right=Constant(value=2))),
                While(
                    test=Compare(
                        left=Name(id=&#39;approx&#39;, ctx=Load()),
                        ops=[
                            NotEq()],
                        comparators=[
                            Name(id=&#39;guess&#39;, ctx=Load())]),
                    body=[
                        Assign(
                            targets=[
                                Name(id=&#39;approx&#39;, ctx=Store())],
                            value=Name(id=&#39;guess&#39;, ctx=Load())),
                        Assign(
                            targets=[
                                Name(id=&#39;guess&#39;, ctx=Store())],
                            value=BinOp(
                                left=BinOp(
                                    left=Name(id=&#39;approx&#39;, ctx=Load()),
                                    op=Add(),
                                    right=BinOp(
                                        left=Name(id=&#39;x&#39;, ctx=Load()),
                                        op=Div(),
                                        right=Name(id=&#39;approx&#39;, ctx=Load()))),
                                op=Div(),
                                right=Constant(value=2)))]),
                Return(
                    value=Name(id=&#39;approx&#39;, ctx=Load()))])])
</pre></div>
</div>
</div>
</div>
<p>Too much text for you?  This graphical representation may make things simpler.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">show_ast</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_ast</span><span class="p">(</span><span class="n">square_root_ast</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/2fb3dd1ed74ebf8de2343cafcc3a6082ba71fd1df36fd6c9207b94f954c4a912.svg" src="_images/2fb3dd1ed74ebf8de2343cafcc3a6082ba71fd1df36fd6c9207b94f954c4a912.svg" />
</div>
</div>
<p>The function <code class="docutils literal notranslate"><span class="pre">ast.unparse()</span></code> converts such a tree back into the more familiar textual Python code representation.  Comments are gone, and there may be more (or fewer) parentheses than before, but the result has the same semantics:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">square_root_ast</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">square_root</span>(x):
<span class=" -Color -Color-White">    </span><span class=" -Color -Color-Yellow">&quot;&quot;&quot;Computes the square root of x, using the Newton-Raphson method&quot;&quot;&quot;</span>
    approx = <span class=" -Color -Color-Blue">None</span>
    guess = x / <span class=" -Color -Color-Blue">2</span>
    <span class=" -Color -Color-Blue">while</span> approx != guess:
        approx = guess
        guess = (approx + x / approx) / <span class=" -Color -Color-Blue">2</span>
    <span class=" -Color -Color-Blue">return</span> approx
</pre></div>
</div>
</div>
</div>
</section>
<section id="id1">
<h4>End of Excursion<a class="headerlink" href="#id1" title="Link to this heading">#</a></h4>
</section>
<section id="excursion-annotating-functions-with-given-types">
<h4>Excursion: Annotating Functions with Given Types<a class="headerlink" href="#excursion-annotating-functions-with-given-types" title="Link to this heading">#</a></h4>
<p>Let us now go and transform ASTs to add type annotations.  We start with a helper function <code class="docutils literal notranslate"><span class="pre">parse_type(name)</span></code> which  parses a type name into an AST.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">parse_type</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">expr</span><span class="p">:</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">ValueVisitor</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">visit_Expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value_node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span>

    <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">name_visitor</span> <span class="o">=</span> <span class="n">ValueVisitor</span><span class="p">()</span>
    <span class="n">name_visitor</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">name_visitor</span><span class="o">.</span><span class="n">value_node</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">parse_type</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Name(id=&#39;int&#39;, ctx=Load())
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">parse_type</span><span class="p">(</span><span class="s1">&#39;[object]&#39;</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>List(elts=[Name(id=&#39;object&#39;, ctx=Load())], ctx=Load())
</pre></div>
</div>
</div>
</div>
<p>We now define a helper function that actually adds type annotations to a function AST.  The <code class="docutils literal notranslate"><span class="pre">TypeTransformer</span></code> class builds on the Python standard library <code class="docutils literal notranslate"><span class="pre">ast.NodeTransformer</span></code> infrastructure.  It would be called as</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="n">TypeTransformer</span><span class="p">({</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="s1">&#39;int&#39;</span><span class="p">},</span> <span class="s1">&#39;float&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">ast</span><span class="p">)</span>
</pre></div>
</div>
<p>to annotate the arguments of <code class="docutils literal notranslate"><span class="pre">square_root()</span></code>: <code class="docutils literal notranslate"><span class="pre">x</span></code> with <code class="docutils literal notranslate"><span class="pre">int</span></code>, and the return type with <code class="docutils literal notranslate"><span class="pre">float</span></code>.  The returned AST can then be unparsed, compiled or analyzed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TypeTransformer</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeTransformer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argument_types</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">return_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">argument_types</span> <span class="o">=</span> <span class="n">argument_types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_type</span> <span class="o">=</span> <span class="n">return_type</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The core of <code class="docutils literal notranslate"><span class="pre">TypeTransformer</span></code> is the method <code class="docutils literal notranslate"><span class="pre">visit_FunctionDef()</span></code>, which is called for every function definition in the AST.  Its argument <code class="docutils literal notranslate"><span class="pre">node</span></code> is the subtree of the function definition to be transformed.  Our implementation accesses the individual arguments and invokes <code class="docutils literal notranslate"><span class="pre">annotate_args()</span></code> on them; it also sets the return type in the <code class="docutils literal notranslate"><span class="pre">returns</span></code> attribute of the node.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TypeTransformer</span><span class="p">(</span><span class="n">TypeTransformer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_FunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add annotation to function&quot;&quot;&quot;</span>
        <span class="c1"># Set argument types</span>
        <span class="n">new_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annotate_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>

        <span class="n">new_arguments</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">arguments</span><span class="p">(</span>
            <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">posonlyargs</span><span class="p">,</span>
            <span class="n">new_args</span><span class="p">,</span>
            <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">vararg</span><span class="p">,</span>
            <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">kwonlyargs</span><span class="p">,</span>
            <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">kw_defaults</span><span class="p">,</span>
            <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">kwarg</span><span class="p">,</span>
            <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">defaults</span>
        <span class="p">)</span>

        <span class="c1"># Set return type</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">parse_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">return_type</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">copy_location</span><span class="p">(</span>
            <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">new_arguments</span><span class="p">,</span>
                            <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">decorator_list</span><span class="p">,</span>
                            <span class="n">node</span><span class="o">.</span><span class="n">returns</span><span class="p">),</span> <span class="n">node</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
</div>
<p>Each argument gets its own annotation, taken from the types originally passed to the class:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TypeTransformer</span><span class="p">(</span><span class="n">TypeTransformer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">annotate_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">arg</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add annotation to single function argument&quot;&quot;&quot;</span>
        <span class="n">arg_name</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">arg</span>
        <span class="k">if</span> <span class="n">arg_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">argument_types</span><span class="p">:</span>
            <span class="n">arg</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="n">parse_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">argument_types</span><span class="p">[</span><span class="n">arg_name</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">arg</span>
</pre></div>
</div>
</div>
</div>
<p>Does this work?  Let us annotate the AST from <code class="docutils literal notranslate"><span class="pre">square_root()</span></code> with types for the arguments and return types:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_ast</span> <span class="o">=</span> <span class="n">TypeTransformer</span><span class="p">({</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="s1">&#39;int&#39;</span><span class="p">},</span> <span class="s1">&#39;float&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">square_root_ast</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>When we unparse the new AST, we see that the annotations actually are present:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">new_ast</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">square_root</span>(x: <span class=" -Color -Color-Cyan">int</span>) -&gt; <span class=" -Color -Color-Cyan">float</span>:
<span class=" -Color -Color-White">    </span><span class=" -Color -Color-Yellow">&quot;&quot;&quot;Computes the square root of x, using the Newton-Raphson method&quot;&quot;&quot;</span>
    approx = <span class=" -Color -Color-Blue">None</span>
    guess = x / <span class=" -Color -Color-Blue">2</span>
    <span class=" -Color -Color-Blue">while</span> approx != guess:
        approx = guess
        guess = (approx + x / approx) / <span class=" -Color -Color-Blue">2</span>
    <span class=" -Color -Color-Blue">return</span> approx
</pre></div>
</div>
</div>
</div>
<p>Similarly, we can annotate the <code class="docutils literal notranslate"><span class="pre">hello()</span></code> function from above:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hello_source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">hello</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hello_ast</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">hello_source</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_ast</span> <span class="o">=</span> <span class="n">TypeTransformer</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">},</span> <span class="s1">&#39;None&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">hello_ast</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">new_ast</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">hello</span>(name: <span class=" -Color -Color-Cyan">str</span>) -&gt; <span class=" -Color -Color-Blue">None</span>:
    <span class=" -Color -Color-Cyan">print</span>(<span class=" -Color -Color-Yellow">&#39;Hello,&#39;</span>, name)
</pre></div>
</div>
</div>
</div>
</section>
<section id="id2">
<h4>End of Excursion<a class="headerlink" href="#id2" title="Link to this heading">#</a></h4>
</section>
<section id="excursion-annotating-functions-with-mined-types">
<h4>Excursion: Annotating Functions with Mined Types<a class="headerlink" href="#excursion-annotating-functions-with-mined-types" title="Link to this heading">#</a></h4>
<p>Let us now annotate functions with types mined at runtime. We start with a simple function <code class="docutils literal notranslate"><span class="pre">type_string()</span></code> that determines
the appropriate type of a given value (as a string):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">type_string</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">type_string</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;int&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">type_string</span><span class="p">([])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;list&#39;
</pre></div>
</div>
</div>
</div>
<p>For composite structures, <code class="docutils literal notranslate"><span class="pre">type_string()</span></code> does not examine element types; hence, the type of <code class="docutils literal notranslate"><span class="pre">[3]</span></code> is simply <code class="docutils literal notranslate"><span class="pre">list</span></code> instead of, say, <code class="docutils literal notranslate"><span class="pre">list[int]</span></code>.  For now, <code class="docutils literal notranslate"><span class="pre">list</span></code> will do fine.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">type_string</span><span class="p">([</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;list&#39;
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">type_string()</span></code> will be used to infer the types of argument values found at runtime, as returned by <code class="docutils literal notranslate"><span class="pre">CallTracer.all_calls()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">CallTracer</span><span class="p">()</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">25.0</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tracer</span><span class="o">.</span><span class="n">all_calls</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;square_root&#39;: [([(&#39;x&#39;, 25.0)], 5.0), ([(&#39;x&#39;, 2.0)], 1.414213562373095)]}
</pre></div>
</div>
</div>
</div>
<p>The function <code class="docutils literal notranslate"><span class="pre">annotate_types()</span></code> takes such a list of calls and annotates each function listed:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">StackInspector</span><span class="w"> </span><span class="kn">import</span> <span class="n">StackInspector</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">annotate_types</span><span class="p">(</span><span class="n">calls</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Arguments</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]])</span> \
        <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]:</span>
    <span class="n">annotated_functions</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">stack_inspector</span> <span class="o">=</span> <span class="n">StackInspector</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">function_name</span> <span class="ow">in</span> <span class="n">calls</span><span class="p">:</span>
        <span class="n">function</span> <span class="o">=</span> <span class="n">stack_inspector</span><span class="o">.</span><span class="n">search_func</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">function</span><span class="p">:</span>
            <span class="n">annotated_functions</span><span class="p">[</span><span class="n">function_name</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">annotate_function_with_types</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">calls</span><span class="p">[</span><span class="n">function_name</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">annotated_functions</span>
</pre></div>
</div>
</div>
</div>
<p>For each function, we get the source and its AST and then get to the actual annotation in <code class="docutils literal notranslate"><span class="pre">annotate_function_ast_with_types()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">annotate_function_with_types</span><span class="p">(</span><span class="n">function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
                                 <span class="n">function_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Arguments</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
    <span class="n">function_code</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
    <span class="n">function_ast</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">function_code</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">annotate_function_ast_with_types</span><span class="p">(</span><span class="n">function_ast</span><span class="p">,</span> <span class="n">function_calls</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The function <code class="docutils literal notranslate"><span class="pre">annotate_function_ast_with_types()</span></code> invokes the <code class="docutils literal notranslate"><span class="pre">TypeTransformer</span></code> with the calls seen, and for each call, iterate over the arguments, determine their types, and annotate the AST with these.  The universal type <code class="docutils literal notranslate"><span class="pre">Any</span></code> is used when we encounter type conflicts, which we will discuss below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">annotate_function_ast_with_types</span><span class="p">(</span><span class="n">function_ast</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span>
                                     <span class="n">function_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Arguments</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
    <span class="n">parameter_types</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">return_type</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">calls_seen</span> <span class="ow">in</span> <span class="n">function_calls</span><span class="p">:</span>
        <span class="n">args</span><span class="p">,</span> <span class="n">return_value</span> <span class="o">=</span> <span class="n">calls_seen</span>
        <span class="k">if</span> <span class="n">return_value</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">return_type</span> <span class="ow">and</span> <span class="n">return_type</span> <span class="o">!=</span> <span class="n">type_string</span><span class="p">(</span><span class="n">return_value</span><span class="p">):</span>
                <span class="n">return_type</span> <span class="o">=</span> <span class="s1">&#39;Any&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">return_type</span> <span class="o">=</span> <span class="n">type_string</span><span class="p">(</span><span class="n">return_value</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">different_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">parameter_types</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span> <span class="o">!=</span>
                                  <span class="n">type_string</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">different_type</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">different_type</span><span class="p">:</span>
                <span class="n">parameter_types</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Any&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parameter_types</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_string</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="n">annotated_function_ast</span> <span class="o">=</span> \
        <span class="n">TypeTransformer</span><span class="p">(</span><span class="n">parameter_types</span><span class="p">,</span> <span class="n">return_type</span><span class="p">)</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">function_ast</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">annotated_function_ast</span>
</pre></div>
</div>
</div>
</div>
<p>Here is <code class="docutils literal notranslate"><span class="pre">square_root()</span></code> annotated with the types recorded usign the tracer, above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">annotate_types</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">all_calls</span><span class="p">())[</span><span class="s1">&#39;square_root&#39;</span><span class="p">]),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">square_root</span>(x: <span class=" -Color -Color-Cyan">float</span>) -&gt; <span class=" -Color -Color-Cyan">float</span>:
<span class=" -Color -Color-White">    </span><span class=" -Color -Color-Yellow">&quot;&quot;&quot;Computes the square root of x, using the Newton-Raphson method&quot;&quot;&quot;</span>
    approx = <span class=" -Color -Color-Blue">None</span>
    guess = x / <span class=" -Color -Color-Blue">2</span>
    <span class=" -Color -Color-Blue">while</span> approx != guess:
        approx = guess
        guess = (approx + x / approx) / <span class=" -Color -Color-Blue">2</span>
    <span class=" -Color -Color-Blue">return</span> approx
</pre></div>
</div>
</div>
</div>
</section>
<section id="id3">
<h4>End of Excursion<a class="headerlink" href="#id3" title="Link to this heading">#</a></h4>
</section>
<section id="excursion-a-type-annotator-class">
<h4>Excursion: A Type Annotator Class<a class="headerlink" href="#excursion-a-type-annotator-class" title="Link to this heading">#</a></h4>
<p>Let us bring all of this together in a single class <code class="docutils literal notranslate"><span class="pre">TypeAnnotator</span></code> that first tracks calls of functions and then allows accessing the AST (and the source code form) of the tracked functions annotated with types.  The method <code class="docutils literal notranslate"><span class="pre">typed_functions()</span></code> returns the annotated functions as a string; <code class="docutils literal notranslate"><span class="pre">typed_functions_ast()</span></code> returns their AST.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TypeTracer</span><span class="p">(</span><span class="n">CallTracer</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TypeAnnotator</span><span class="p">(</span><span class="n">TypeTracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">typed_functions_ast</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a dict name -&gt; AST for all functions observed, annotated with types&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">annotate_types</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_calls</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">typed_function_ast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return an AST for all calls of `function_name` observed, annotated with types&quot;&quot;&quot;</span>
        <span class="n">function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_func</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">function</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">annotate_function_with_types</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calls</span><span class="p">(</span><span class="n">function_name</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">typed_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the code for all functions observed, annotated with types&quot;&quot;&quot;</span>
        <span class="n">functions</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">f_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_calls</span><span class="p">():</span>
            <span class="n">f_ast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">typed_function_ast</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f_ast</span><span class="p">:</span>
                <span class="n">functions</span> <span class="o">+=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">f_ast</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">functions</span> <span class="o">+=</span> <span class="s1">&#39;# Could not find function &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">functions</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">typed_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the code for all calls of `function_name` observed, annotated with types&quot;&quot;&quot;</span>
        <span class="n">function_ast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">typed_function_ast</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">function_ast</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">function_ast</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;String representation, like `typed_functions()`&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">typed_functions</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id4">
<h4>End of Excursion<a class="headerlink" href="#id4" title="Link to this heading">#</a></h4>
<p>Here is how to use <code class="docutils literal notranslate"><span class="pre">TypeAnnotator</span></code>.  We first track a series of calls:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">TypeAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">25.0</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>After tracking, we can immediately retrieve an annotated version of the functions tracked:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">typed_functions</span><span class="p">(),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">square_root</span>(x: <span class=" -Color -Color-Cyan">float</span>) -&gt; <span class=" -Color -Color-Cyan">float</span>:
<span class=" -Color -Color-White">    </span><span class=" -Color -Color-Yellow">&quot;&quot;&quot;Computes the square root of x, using the Newton-Raphson method&quot;&quot;&quot;</span>
    approx = <span class=" -Color -Color-Blue">None</span>
    guess = x / <span class=" -Color -Color-Blue">2</span>
    <span class=" -Color -Color-Blue">while</span> approx != guess:
        approx = guess
        guess = (approx + x / approx) / <span class=" -Color -Color-Blue">2</span>
    <span class=" -Color -Color-Blue">return</span> approx
</pre></div>
</div>
</div>
</div>
<p>This also works for multiple and diverse functions.  One could go and implement an automatic type annotator for Python files based on the types seen during execution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">TypeAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">hello</span><span class="p">(</span><span class="s1">&#39;type annotations&#39;</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Hello, type annotations
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">typed_functions</span><span class="p">(),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-White"># Could not find function &#39;parent_header&#39;# Could not find function &#39;_is_master_process&#39;# Could not find function &#39;utcoffset&#39;# Could not find function &#39;is_set&#39;# Could not find function &#39;is_alive&#39;# Could not find function &#39;_event_pipe&#39;# Could not find function &#39;send&#39;# Could not find function &#39;schedule&#39;# Could not find function &#39;_schedule_flush&#39;# Could not find function &#39;write&#39;# Could not find function &#39;is_publishing&#39;# Could not find function &#39;is_active&#39;def cast(typ: TypeVar, val: Any) -&gt; Any:</span>
<span class=" -Color -Color-White">    </span><span class=" -Color -Color-Yellow">&quot;&quot;&quot;Cast a value to a type.</span>

<span class=" -Color -Color-Yellow">    This returns the value unchanged.  To the type checker this</span>
<span class=" -Color -Color-Yellow">    signals that the return value has the designated type, but at</span>
<span class=" -Color -Color-Yellow">    runtime we intentionally don&#39;t check anything (we want this</span>
<span class=" -Color -Color-Yellow">    to be as fast as possible).</span>
<span class=" -Color -Color-Yellow">    &quot;&quot;&quot;</span>
    <span class=" -Color -Color-Blue">return</span> val<span class=" -Color -Color-White"># Could not find function &#39;get&#39;# Could not find function &#39;__get__&#39;# Could not find function &#39;__init__&#39;def hello(name: str) -&gt; None:</span>
    <span class=" -Color -Color-Cyan">print</span>(<span class=" -Color -Color-Yellow">&#39;Hello,&#39;</span>, name)<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">square_root</span>(x: <span class=" -Color -Color-Cyan">float</span>) -&gt; <span class=" -Color -Color-Cyan">float</span>:
<span class=" -Color -Color-White">    </span><span class=" -Color -Color-Yellow">&quot;&quot;&quot;Computes the square root of x, using the Newton-Raphson method&quot;&quot;&quot;</span>
    approx = <span class=" -Color -Color-Blue">None</span>
    guess = x / <span class=" -Color -Color-Blue">2</span>
    <span class=" -Color -Color-Blue">while</span> approx != guess:
        approx = guess
        guess = (approx + x / approx) / <span class=" -Color -Color-Blue">2</span>
    <span class=" -Color -Color-Blue">return</span> approx
</pre></div>
</div>
</div>
</div>
<p>A content as above could now be sent to a type checker, which would detect any type inconsistency between callers and callees.</p>
</section>
<section id="excursion-handling-multiple-types">
<h4>Excursion: Handling Multiple Types<a class="headerlink" href="#excursion-handling-multiple-types" title="Link to this heading">#</a></h4>
<p>Let us now resolve the role of the magic <code class="docutils literal notranslate"><span class="pre">Any</span></code> type in <code class="docutils literal notranslate"><span class="pre">annotate_function_ast_with_types()</span></code>.  If we see multiple types for the same argument, we set its type to <code class="docutils literal notranslate"><span class="pre">Any</span></code>.  For <code class="docutils literal notranslate"><span class="pre">square_root()</span></code>, this makes sense, as its arguments can be integers as well as floats:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">CallTracer</span><span class="p">()</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">25.0</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">annotated_square_root_ast</span> <span class="o">=</span> <span class="n">annotate_types</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">all_calls</span><span class="p">())[</span><span class="s1">&#39;square_root&#39;</span><span class="p">]</span>
<span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">annotated_square_root_ast</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">square_root</span>(x: Any) -&gt; <span class=" -Color -Color-Cyan">float</span>:
<span class=" -Color -Color-White">    </span><span class=" -Color -Color-Yellow">&quot;&quot;&quot;Computes the square root of x, using the Newton-Raphson method&quot;&quot;&quot;</span>
    approx = <span class=" -Color -Color-Blue">None</span>
    guess = x / <span class=" -Color -Color-Blue">2</span>
    <span class=" -Color -Color-Blue">while</span> approx != guess:
        approx = guess
        guess = (approx + x / approx) / <span class=" -Color -Color-Blue">2</span>
    <span class=" -Color -Color-Blue">return</span> approx
</pre></div>
</div>
</div>
</div>
<p>The following function <code class="docutils literal notranslate"><span class="pre">sum3()</span></code> can be called with floating-point numbers as arguments, resulting in the parameters getting a <code class="docutils literal notranslate"><span class="pre">float</span></code> type:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">sum3</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">TypeAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
<span class="n">y</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">typed_functions</span><span class="p">(),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">sum3</span>(a: <span class=" -Color -Color-Cyan">float</span>, b: <span class=" -Color -Color-Cyan">float</span>, c: <span class=" -Color -Color-Cyan">float</span>) -&gt; <span class=" -Color -Color-Cyan">float</span>:
    <span class=" -Color -Color-Blue">return</span> a + b + c
</pre></div>
</div>
</div>
</div>
<p>If we call <code class="docutils literal notranslate"><span class="pre">sum3()</span></code> with integers, though, the arguments get an <code class="docutils literal notranslate"><span class="pre">int</span></code> type:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">TypeAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">y</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">typed_functions</span><span class="p">(),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">sum3</span>(a: <span class=" -Color -Color-Cyan">int</span>, b: <span class=" -Color -Color-Cyan">int</span>, c: <span class=" -Color -Color-Cyan">int</span>) -&gt; <span class=" -Color -Color-Cyan">int</span>:
    <span class=" -Color -Color-Blue">return</span> a + b + c
</pre></div>
</div>
</div>
</div>
<p>And we can also call <code class="docutils literal notranslate"><span class="pre">sum3()</span></code> with strings, which assigns the arguments a <code class="docutils literal notranslate"><span class="pre">str</span></code> type:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">TypeAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="s2">&quot;one&quot;</span><span class="p">,</span> <span class="s2">&quot;two&quot;</span><span class="p">,</span> <span class="s2">&quot;three&quot;</span><span class="p">)</span>
<span class="n">y</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;onetwothree&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">typed_functions</span><span class="p">(),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">sum3</span>(a: <span class=" -Color -Color-Cyan">str</span>, b: <span class=" -Color -Color-Cyan">str</span>, c: <span class=" -Color -Color-Cyan">str</span>) -&gt; <span class=" -Color -Color-Cyan">str</span>:
    <span class=" -Color -Color-Blue">return</span> a + b + c
</pre></div>
</div>
</div>
</div>
<p>If we have multiple calls, but with different types, <code class="docutils literal notranslate"><span class="pre">TypeAnnotator()</span></code> will assign an <code class="docutils literal notranslate"><span class="pre">Any</span></code> type to both arguments and return values:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">TypeAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="s2">&quot;one&quot;</span><span class="p">,</span> <span class="s2">&quot;two&quot;</span><span class="p">,</span> <span class="s2">&quot;three&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">typed_sum3_def</span> <span class="o">=</span> <span class="n">annotator</span><span class="o">.</span><span class="n">typed_function</span><span class="p">(</span><span class="s1">&#39;sum3&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">typed_sum3_def</span><span class="p">,</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">sum3</span>(a: Any, b: Any, c: Any) -&gt; Any:
    <span class=" -Color -Color-Blue">return</span> a + b + c
</pre></div>
</div>
</div>
</div>
<p>A type <code class="docutils literal notranslate"><span class="pre">Any</span></code> makes it explicit that an object can, indeed, have any type; it will not be typechecked at runtime or statically.  To some extent, this defeats the power of type checking; but it also preserves some of the type flexibility that many Python programmers enjoy.  Besides <code class="docutils literal notranslate"><span class="pre">Any</span></code>, the <code class="docutils literal notranslate"><span class="pre">typing</span></code> module supports several additional ways to define ambiguous types; we will keep this in mind for a later exercise.</p>
</section>
<section id="id5">
<h4>End of Excursion<a class="headerlink" href="#id5" title="Link to this heading">#</a></h4>
</section>
</section>
</section>
<section id="mining-invariants">
<h2>Mining Invariants<a class="headerlink" href="#mining-invariants" title="Link to this heading">#</a></h2>
<p>Besides basic data types. we can check several further properties from arguments.  We can, for instance, whether an argument can be negative, zero, or positive; or that one argument should be smaller than the second; or that the result should be the sum of two arguments properties that cannot be expressed in a (Python) type.</p>
<p>Such properties are called <em>invariants</em>, as they hold across all invocations of a function. Specifically, invariants come as <em>pre</em>- and <em>postconditions</em> conditions that always hold at the beginning and at the end of a function.  (There are also <em>data</em> and <em>object</em> invariants that express always-holding properties over the state of data or objects, but we do not consider these in this book.)</p>
<section id="annotating-functions-with-pre-and-postconditions">
<h3>Annotating Functions with Pre- and Postconditions<a class="headerlink" href="#annotating-functions-with-pre-and-postconditions" title="Link to this heading">#</a></h3>
<p>The classical means to specify pre- and postconditions is via <em>assertions</em>, which we have introduced in the <a class="reference internal" href="Assertions.html"><span class="std std-doc">chapter on assertions</span></a>.  A precondition checks whether the arguments to a function satisfy the expected properties; a postcondition does the same for the result.  We can express and check both using assertions as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">square_root_with_invariants</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="k">assert</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span>  <span class="c1"># Precondition</span>

    <span class="o">...</span>

    <span class="k">assert</span> <span class="n">result</span> <span class="o">*</span> <span class="n">result</span> <span class="o">==</span> <span class="n">x</span>  <span class="c1"># Postcondition</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</div>
</div>
<p>A nicer way, however, is to syntactically separate invariants from the function at hand.  Using appropriate decorators, we could specify pre- and postconditions as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@precondition</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span>
<span class="nd">@postcondition</span> <span class="k">lambda</span> <span class="n">return_value</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">return_value</span> <span class="o">*</span> <span class="n">return_value</span> <span class="o">==</span> <span class="n">x</span>
<span class="k">def</span><span class="w"> </span><span class="nf">square_root_with_invariants</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="c1"># normal code without assertions</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>The decorators <code class="docutils literal notranslate"><span class="pre">&#64;precondition</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;postcondition</span></code> would run the given functions (specified as anonymous <code class="docutils literal notranslate"><span class="pre">lambda</span></code> functions) before and after the decorated function, respectively.  If the functions return <code class="docutils literal notranslate"><span class="pre">False</span></code>, the condition is violated.  <code class="docutils literal notranslate"><span class="pre">&#64;precondition</span></code> gets the function arguments as arguments; <code class="docutils literal notranslate"><span class="pre">&#64;postcondition</span></code> additionally gets the return value as first argument.</p>
<p>It turns out that implementing such decorators is not hard at all.  Our implementation builds on a <a class="reference external" href="https://stackoverflow.com/questions/12151182/python-precondition-postcondition-for-member-function-how">code snippet from StackOverflow</a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">functools</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">condition</span><span class="p">(</span><span class="n">precondition</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">postcondition</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>  <span class="c1"># preserves name, docstring, etc</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">precondition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">precondition</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> \
                    <span class="s2">&quot;Precondition violated&quot;</span>

            <span class="c1"># Call original function or method</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">postcondition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">postcondition</span><span class="p">(</span><span class="n">retval</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> \
                    <span class="s2">&quot;Postcondition violated&quot;</span>

            <span class="k">return</span> <span class="n">retval</span>
        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">decorator</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">precondition</span><span class="p">(</span><span class="n">check</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">condition</span><span class="p">(</span><span class="n">precondition</span><span class="o">=</span><span class="n">check</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">postcondition</span><span class="p">(</span><span class="n">check</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">condition</span><span class="p">(</span><span class="n">postcondition</span><span class="o">=</span><span class="n">check</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>With these, we can now start decorating <code class="docutils literal notranslate"><span class="pre">square_root()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@precondition</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">square_root_with_precondition</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="k">return</span> <span class="n">square_root</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This catches arguments violating the precondition:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">square_root_with_precondition</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_52062/2859393274.py&quot;, line 2, in &lt;module&gt;
    square_root_with_precondition(-1.0)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_52062/3759592669.py&quot;, line 7, in wrapper
    assert precondition(*args, **kwargs), \
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
AssertionError: Precondition violated (expected)
</pre></div>
</div>
</div>
</div>
<p>Likewise, we can provide a postcondition:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@postcondition</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ret</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">ret</span> <span class="o">*</span> <span class="n">ret</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">square_root_with_postcondition</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="k">return</span> <span class="n">square_root</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">square_root_with_postcondition</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
<span class="n">y</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.414213562373095
</pre></div>
</div>
</div>
</div>
<p>If we have a buggy implementation of <span class="math notranslate nohighlight">\(\sqrt{x}\)</span>, this gets caught quickly:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@postcondition</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ret</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">ret</span> <span class="o">*</span> <span class="n">ret</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">buggy_square_root_with_postcondition</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="k">return</span> <span class="n">square_root</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">buggy_square_root_with_postcondition</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_52062/1806983978.py&quot;, line 2, in &lt;module&gt;
    y = buggy_square_root_with_postcondition(2.0)
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_52062/3759592669.py&quot;, line 13, in wrapper
    assert postcondition(retval, *args, **kwargs), \
           ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError: Postcondition violated (expected)
</pre></div>
</div>
</div>
</div>
<p>While checking pre- and postconditions is a great way to catch errors, specifying them can be cumbersome.  Let us try to see whether we can (again) <em>mine</em> some of them.</p>
</section>
<section id="id6">
<h3>Mining Invariants<a class="headerlink" href="#id6" title="Link to this heading">#</a></h3>
<p>To <em>mine</em> invariants, we can use the same tracking functionality as before; instead of saving values for individual variables, though, we now check whether the values satisfy specific <em>properties</em> or not.  For instance, if all values of <code class="docutils literal notranslate"><span class="pre">x</span></code> seen satisfy the condition <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">&gt;</span> <span class="pre">0</span></code>, then we make <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">&gt;</span> <span class="pre">0</span></code> an invariant of the function.  If we see positive, zero, and negative values of <code class="docutils literal notranslate"><span class="pre">x</span></code>, though, then there is no property of <code class="docutils literal notranslate"><span class="pre">x</span></code> left to talk about.</p>
<p>The general idea is thus:</p>
<ol class="arabic simple">
<li><p>Check all variable values observed against a set of predefined properties; and</p></li>
<li><p>Keep only those properties that hold for all runs observed.</p></li>
</ol>
</section>
<section id="defining-properties">
<h3>Defining Properties<a class="headerlink" href="#defining-properties" title="Link to this heading">#</a></h3>
<p>What precisely do we mean by properties?  Here is a small collection of value properties that would frequently be used in invariants.  All these properties would be evaluated with the <em>metavariables</em> <code class="docutils literal notranslate"><span class="pre">X</span></code>, <code class="docutils literal notranslate"><span class="pre">Y</span></code>, and <code class="docutils literal notranslate"><span class="pre">Z</span></code> (actually, any upper-case identifier) being replaced with the names of function parameters:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">INVARIANT_PROPERTIES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;X &lt; 0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X &lt;= 0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X &gt; 0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X &gt;= 0&quot;</span><span class="p">,</span>
    <span class="c1"># &quot;X == 0&quot;,  # implied by &quot;X&quot;, below</span>
    <span class="c1"># &quot;X != 0&quot;,  # implied by &quot;not X&quot;, below</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>When <code class="docutils literal notranslate"><span class="pre">square_root(x)</span></code> is called as, say <code class="docutils literal notranslate"><span class="pre">square_root(5.0)</span></code>, we see that <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">=</span> <span class="pre">5.0</span></code> holds.  The above properties would then all be checked for <code class="docutils literal notranslate"><span class="pre">x</span></code>.  Only the properties <code class="docutils literal notranslate"><span class="pre">X</span> <span class="pre">&gt;</span> <span class="pre">0</span></code>, <code class="docutils literal notranslate"><span class="pre">X</span> <span class="pre">&gt;=</span> <span class="pre">0</span></code>, and <code class="docutils literal notranslate"><span class="pre">not</span> <span class="pre">X</span></code> hold for the call seen; and hence <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">&gt;</span> <span class="pre">0</span></code>, <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">&gt;=</span> <span class="pre">0</span></code>, and <code class="docutils literal notranslate"><span class="pre">not</span> <span class="pre">x</span></code> (or better: <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">!=</span> <span class="pre">0</span></code>) would make potential preconditions for <code class="docutils literal notranslate"><span class="pre">square_root(x)</span></code>.</p>
<p>We can check for many more properties such as relations between two arguments:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">INVARIANT_PROPERTIES</span> <span class="o">+=</span> <span class="p">[</span>
    <span class="s2">&quot;X == Y&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X &gt; Y&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X &lt; Y&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X &gt;= Y&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X &lt;= Y&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Types also can be checked using properties.  For any function parameter <code class="docutils literal notranslate"><span class="pre">X</span></code>, only one of these will hold:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">INVARIANT_PROPERTIES</span> <span class="o">+=</span> <span class="p">[</span>
    <span class="s2">&quot;isinstance(X, bool)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;isinstance(X, int)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;isinstance(X, float)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;isinstance(X, list)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;isinstance(X, dict)&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We can check for arithmetic properties:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">INVARIANT_PROPERTIES</span> <span class="o">+=</span> <span class="p">[</span>
    <span class="s2">&quot;X == Y + Z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X == Y * Z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X == Y - Z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X == Y / Z&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Heres relations over three values, a Python special:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">INVARIANT_PROPERTIES</span> <span class="o">+=</span> <span class="p">[</span>
    <span class="s2">&quot;X &lt; Y &lt; Z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X &lt;= Y &lt;= Z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X &gt; Y &gt; Z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X &gt;= Y &gt;= Z&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>These Boolean properties also check for other types, as in Python, <code class="docutils literal notranslate"><span class="pre">None</span></code>, an empty list, an empty set, an empty string, and the value zero all evaluate to <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">INVARIANT_PROPERTIES</span> <span class="o">+=</span> <span class="p">[</span>
    <span class="s2">&quot;X&quot;</span><span class="p">,</span>
    <span class="s2">&quot;not X&quot;</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we can also check for list or string properties.  Again, this is just a tiny selection.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">INVARIANT_PROPERTIES</span> <span class="o">+=</span> <span class="p">[</span>
    <span class="s2">&quot;X == len(Y)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X == sum(Y)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X in Y&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X.startswith(Y)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X.endswith(Y)&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="extracting-meta-variables">
<h3>Extracting Meta-Variables<a class="headerlink" href="#extracting-meta-variables" title="Link to this heading">#</a></h3>
<p>Let us first introduce a few <em>helper functions</em> before we can get to the actual mining.  <code class="docutils literal notranslate"><span class="pre">metavars()</span></code> extracts the set of meta-variables (<code class="docutils literal notranslate"><span class="pre">X</span></code>, <code class="docutils literal notranslate"><span class="pre">Y</span></code>, <code class="docutils literal notranslate"><span class="pre">Z</span></code>, etc.) from a property.  To this end, we parse the property as a Python expression and then visit the identifiers.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">metavars</span><span class="p">(</span><span class="n">prop</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">metavar_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">ArgVisitor</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">visit_Name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
                <span class="n">metavar_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="n">ArgVisitor</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">prop</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">metavar_list</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">metavars</span><span class="p">(</span><span class="s2">&quot;X &lt; 0&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">metavars</span><span class="p">(</span><span class="s2">&quot;X.startswith(Y)&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">metavars</span><span class="p">(</span><span class="s2">&quot;isinstance(X, str)&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="instantiating-properties">
<h3>Instantiating Properties<a class="headerlink" href="#instantiating-properties" title="Link to this heading">#</a></h3>
<p>To produce a property as invariant, we need to be able to <em>instantiate</em> it with variable names.  The instantiation of <code class="docutils literal notranslate"><span class="pre">X</span> <span class="pre">&gt;</span> <span class="pre">0</span></code> with <code class="docutils literal notranslate"><span class="pre">X</span></code> being instantiated to <code class="docutils literal notranslate"><span class="pre">a</span></code>, for instance, gets us <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">&gt;</span> <span class="pre">0</span></code>.  To this end, the function <code class="docutils literal notranslate"><span class="pre">instantiate_prop()</span></code> takes a property and a collection of variable names and instantiates the meta-variables left-to-right with the corresponding variables names in the collection.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">instantiate_prop_ast</span><span class="p">(</span><span class="n">prop</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">var_names</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">NameTransformer</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeTransformer</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">visit_Name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">node</span>
            <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">mapping</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">],</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">())</span>

    <span class="n">meta_variables</span> <span class="o">=</span> <span class="n">metavars</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">meta_variables</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">var_names</span><span class="p">)</span>

    <span class="n">mapping</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">meta_variables</span><span class="p">)):</span>
        <span class="n">mapping</span><span class="p">[</span><span class="n">meta_variables</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">var_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">prop_ast</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;eval&#39;</span><span class="p">)</span>
    <span class="n">new_ast</span> <span class="o">=</span> <span class="n">NameTransformer</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">prop_ast</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_ast</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">instantiate_prop</span><span class="p">(</span><span class="n">prop</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">var_names</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">prop_ast</span> <span class="o">=</span> <span class="n">instantiate_prop_ast</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">var_names</span><span class="p">)</span>
    <span class="n">prop_text</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">prop_ast</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">prop_text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">prop_text</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">):</span>
        <span class="n">prop_text</span> <span class="o">=</span> <span class="n">prop_text</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">prop_text</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">instantiate_prop</span><span class="p">(</span><span class="s2">&quot;X &gt; Y&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;a &gt; b&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">instantiate_prop</span><span class="p">(</span><span class="s2">&quot;X.startswith(Y)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;x.startswith(y)&#39;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="evaluating-properties">
<h3>Evaluating Properties<a class="headerlink" href="#evaluating-properties" title="Link to this heading">#</a></h3>
<p>To actually <em>evaluate</em> properties, we do not need to instantiate them.  Instead, we simply convert them into a boolean function, using <code class="docutils literal notranslate"><span class="pre">lambda</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">prop_function_text</span><span class="p">(</span><span class="n">prop</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="s2">&quot;lambda &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metavars</span><span class="p">(</span><span class="n">prop</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">prop</span>
</pre></div>
</div>
</div>
</div>
<p>Here is a simple example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prop_function_text</span><span class="p">(</span><span class="s2">&quot;X &gt; Y&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;lambda X, Y: X &gt; Y&#39;
</pre></div>
</div>
</div>
</div>
<p>We can easily evaluate the function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">prop_function</span><span class="p">(</span><span class="n">prop</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">prop_function_text</span><span class="p">(</span><span class="n">prop</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Here is an example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">prop_function</span><span class="p">(</span><span class="s2">&quot;X &gt; Y&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">What is p(100, 1)?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">
    
        <input type="radio" name="f92b6da8-b293-11f0-88db-6298cf1a5790" id="f92b6da8-b293-11f0-88db-6298cf1a5790-1" onclick="clear_selection('f92b6da8-b293-11f0-88db-6298cf1a5790')">
        <label id="f92b6da8-b293-11f0-88db-6298cf1a5790-1-label" for="f92b6da8-b293-11f0-88db-6298cf1a5790-1">False</label><br>
    
        <input type="radio" name="f92b6da8-b293-11f0-88db-6298cf1a5790" id="f92b6da8-b293-11f0-88db-6298cf1a5790-2" onclick="clear_selection('f92b6da8-b293-11f0-88db-6298cf1a5790')">
        <label id="f92b6da8-b293-11f0-88db-6298cf1a5790-2-label" for="f92b6da8-b293-11f0-88db-6298cf1a5790-2">True</label><br>
    
    </div>
    </p>
    <input id="f92b6da8-b293-11f0-88db-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('f92b6da8-b293-11f0-88db-6298cf1a5790', 4, 0, 'p(100, 1) + 1')">
    <span class="quiz_hint" id="f92b6da8-b293-11f0-88db-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>False
</pre></div>
</div>
</div>
</div>
</section>
<section id="checking-invariants">
<h3>Checking Invariants<a class="headerlink" href="#checking-invariants" title="Link to this heading">#</a></h3>
<p>To extract invariants from an execution, we need to check them on all possible instantiations of arguments.  If the function to be checked has two arguments <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code>, we instantiate the property <code class="docutils literal notranslate"><span class="pre">X</span> <span class="pre">&lt;</span> <span class="pre">Y</span></code> both as <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">&lt;</span> <span class="pre">b</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span> <span class="pre">&lt;</span> <span class="pre">a</span></code> and check each of them.</p>
<p>To get all combinations, we use the Python <code class="docutils literal notranslate"><span class="pre">permutations()</span></code> function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">combination</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">permutations</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">],</span> <span class="mi">2</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">combination</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1.0, 2.0)
(1.0, 3.0)
(2.0, 1.0)
(2.0, 3.0)
(3.0, 1.0)
(3.0, 2.0)
</pre></div>
</div>
</div>
</div>
<p>The function <code class="docutils literal notranslate"><span class="pre">true_property_instantiations()</span></code> takes a property and a list of tuples (<code class="docutils literal notranslate"><span class="pre">var_name</span></code>, <code class="docutils literal notranslate"><span class="pre">value</span></code>).  It then produces all instantiations of the property with the given values and returns those that evaluate to True.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Invariants</span> <span class="o">=</span> <span class="n">Set</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]]]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">true_property_instantiations</span><span class="p">(</span><span class="n">prop</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">vars_and_values</span><span class="p">:</span> <span class="n">Arguments</span><span class="p">,</span> 
                                 <span class="n">log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Invariants</span><span class="p">:</span>
    <span class="n">instantiations</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">prop_function</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>

    <span class="n">len_metavars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">metavars</span><span class="p">(</span><span class="n">prop</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">combination</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">permutations</span><span class="p">(</span><span class="n">vars_and_values</span><span class="p">,</span> <span class="n">len_metavars</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span> <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">combination</span><span class="p">]</span>
        <span class="n">var_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_name</span> <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">combination</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">combination</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">instantiations</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">prop</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">var_names</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">instantiations</span>
</pre></div>
</div>
</div>
</div>
<p>Here is an example.   If <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">==</span> <span class="pre">-1</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span> <span class="pre">==</span> <span class="pre">1</span></code>, the property <code class="docutils literal notranslate"><span class="pre">X</span> <span class="pre">&lt;</span> <span class="pre">Y</span></code> holds for <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">&lt;</span> <span class="pre">y</span></code>, but not for <code class="docutils literal notranslate"><span class="pre">y</span> <span class="pre">&lt;</span> <span class="pre">x</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">invs</span> <span class="o">=</span> <span class="n">true_property_instantiations</span><span class="p">(</span><span class="s2">&quot;X &lt; Y&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)],</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">invs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>X &lt; Y ((&#39;x&#39;, -1), (&#39;y&#39;, 1)) True
X &lt; Y ((&#39;y&#39;, 1), (&#39;x&#39;, -1)) False
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{(&#39;X &lt; Y&#39;, (&#39;x&#39;, &#39;y&#39;))}
</pre></div>
</div>
</div>
</div>
<p>The instantiation retrieves the short form:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">prop</span><span class="p">,</span> <span class="n">var_names</span> <span class="ow">in</span> <span class="n">invs</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">instantiate_prop</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">var_names</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>x &lt; y
</pre></div>
</div>
</div>
</div>
<p>Likewise, with values for <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> as above, the property <code class="docutils literal notranslate"><span class="pre">X</span> <span class="pre">&lt;</span> <span class="pre">0</span></code> only holds for <code class="docutils literal notranslate"><span class="pre">x</span></code>, but not for <code class="docutils literal notranslate"><span class="pre">y</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">invs</span> <span class="o">=</span> <span class="n">true_property_instantiations</span><span class="p">(</span><span class="s2">&quot;X &lt; 0&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)],</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>X &lt; 0 ((&#39;x&#39;, -1),) True
X &lt; 0 ((&#39;y&#39;, 1),) False
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">prop</span><span class="p">,</span> <span class="n">var_names</span> <span class="ow">in</span> <span class="n">invs</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">instantiate_prop</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">var_names</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>x &lt; 0
</pre></div>
</div>
</div>
</div>
</section>
<section id="extracting-invariants">
<h3>Extracting Invariants<a class="headerlink" href="#extracting-invariants" title="Link to this heading">#</a></h3>
<p>Let us now run the above invariant extraction on function arguments and return values as observed during a function execution.  To this end, we extend the <code class="docutils literal notranslate"><span class="pre">CallTracer</span></code> class into an <code class="docutils literal notranslate"><span class="pre">InvariantTracer</span></code> class, which automatically computes invariants for all functions and all calls observed during tracking.</p>
<p>By default, an <code class="docutils literal notranslate"><span class="pre">InvariantTracer</span></code> uses the <code class="docutils literal notranslate"><span class="pre">INVARIANT_PROPERTIES</span></code> properties as defined above; however, one can specify alternate sets of properties.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">InvariantTracer</span><span class="p">(</span><span class="n">CallTracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">props</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">props</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">props</span> <span class="o">=</span> <span class="n">INVARIANT_PROPERTIES</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">props</span> <span class="o">=</span> <span class="n">props</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The key method of the <code class="docutils literal notranslate"><span class="pre">InvariantTracer</span></code> is the <code class="docutils literal notranslate"><span class="pre">invariants()</span></code> method.  This iterates over the calls observed and checks which properties hold.  Only the intersection of properties  that is, the set of properties that hold for all calls is preserved, and eventually returned.  The special variable <code class="docutils literal notranslate"><span class="pre">return_value</span></code> is set to hold the return value.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RETURN_VALUE</span> <span class="o">=</span> <span class="s1">&#39;return_value&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">InvariantTracer</span><span class="p">(</span><span class="n">InvariantTracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">all_invariants</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Invariants</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">function_name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">invariants</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">function_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_calls</span><span class="p">()}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">invariants</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Invariants</span><span class="p">:</span>
        <span class="n">invariants</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">variables</span><span class="p">,</span> <span class="n">return_value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calls</span><span class="p">(</span><span class="n">function_name</span><span class="p">):</span>
            <span class="n">vars_and_values</span> <span class="o">=</span> <span class="n">variables</span> <span class="o">+</span> <span class="p">[(</span><span class="n">RETURN_VALUE</span><span class="p">,</span> <span class="n">return_value</span><span class="p">)]</span>

            <span class="n">s</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">|=</span> <span class="n">true_property_instantiations</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">vars_and_values</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">invariants</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">invariants</span> <span class="o">=</span> <span class="n">s</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">invariants</span> <span class="o">&amp;=</span> <span class="n">s</span>

        <span class="k">assert</span> <span class="n">invariants</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">invariants</span>
</pre></div>
</div>
</div>
</div>
<p>Heres an example of how to use <code class="docutils literal notranslate"><span class="pre">invariants()</span></code>.  We run the tracer on a small set of calls.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">InvariantTracer</span><span class="p">()</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">25.0</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>

<span class="n">tracer</span><span class="o">.</span><span class="n">all_calls</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;square_root&#39;: [([(&#39;x&#39;, 25.0)], 5.0), ([(&#39;x&#39;, 10.0)], 3.162277660168379)]}
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">invariants()</span></code> method produces a set of properties that hold for the observed runs, together with their instantiations over function arguments.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">invs</span> <span class="o">=</span> <span class="n">tracer</span><span class="o">.</span><span class="n">invariants</span><span class="p">(</span><span class="s1">&#39;square_root&#39;</span><span class="p">)</span>
<span class="n">invs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{(&#39;X&#39;, (&#39;return_value&#39;,)),
 (&#39;X&#39;, (&#39;x&#39;,)),
 (&#39;X &lt; Y&#39;, (&#39;return_value&#39;, &#39;x&#39;)),
 (&#39;X &lt;= Y&#39;, (&#39;return_value&#39;, &#39;x&#39;)),
 (&#39;X &gt; 0&#39;, (&#39;return_value&#39;,)),
 (&#39;X &gt; 0&#39;, (&#39;x&#39;,)),
 (&#39;X &gt; Y&#39;, (&#39;x&#39;, &#39;return_value&#39;)),
 (&#39;X &gt;= 0&#39;, (&#39;return_value&#39;,)),
 (&#39;X &gt;= 0&#39;, (&#39;x&#39;,)),
 (&#39;X &gt;= Y&#39;, (&#39;x&#39;, &#39;return_value&#39;)),
 (&#39;isinstance(X, float)&#39;, (&#39;return_value&#39;,)),
 (&#39;isinstance(X, float)&#39;, (&#39;x&#39;,))}
</pre></div>
</div>
</div>
</div>
<p>As before, the actual instantiations are easier to read:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">pretty_invariants</span><span class="p">(</span><span class="n">invariants</span><span class="p">:</span> <span class="n">Invariants</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">props</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">var_names</span><span class="p">)</span> <span class="ow">in</span> <span class="n">invariants</span><span class="p">:</span>
        <span class="n">props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instantiate_prop</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">var_names</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pretty_invariants</span><span class="p">(</span><span class="n">invs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;isinstance(return_value, float)&#39;,
 &#39;isinstance(x, float)&#39;,
 &#39;return_value&#39;,
 &#39;return_value &lt; x&#39;,
 &#39;return_value &lt;= x&#39;,
 &#39;return_value &gt; 0&#39;,
 &#39;return_value &gt;= 0&#39;,
 &#39;x&#39;,
 &#39;x &gt; 0&#39;,
 &#39;x &gt; return_value&#39;,
 &#39;x &gt;= 0&#39;,
 &#39;x &gt;= return_value&#39;]
</pre></div>
</div>
</div>
</div>
<p>We see that the both <code class="docutils literal notranslate"><span class="pre">x</span></code> and the return value have a <code class="docutils literal notranslate"><span class="pre">float</span></code> type.  We also see that both are always greater than zero.  These are properties that may make useful pre- and postconditions, notably for symbolic analysis.</p>
<p>However, theres also an invariant which does <em>not</em> universally hold, namely <code class="docutils literal notranslate"><span class="pre">return_value</span> <span class="pre">&lt;=</span> <span class="pre">x</span></code>, as the following example shows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">square_root</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.1
</pre></div>
</div>
</div>
</div>
<p>Clearly, 0.1 &gt; 0.01 holds.  This is a case of us not learning from sufficiently diverse inputs.  As soon as we have a call including <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">=</span> <span class="pre">0.1</span></code>, though, the invariant <code class="docutils literal notranslate"><span class="pre">return_value</span> <span class="pre">&lt;=</span> <span class="pre">x</span></code> is eliminated:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">InvariantTracer</span><span class="p">()</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">25.0</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

<span class="n">pretty_invariants</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">invariants</span><span class="p">(</span><span class="s1">&#39;square_root&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;isinstance(return_value, float)&#39;,
 &#39;isinstance(x, float)&#39;,
 &#39;return_value&#39;,
 &#39;return_value &gt; 0&#39;,
 &#39;return_value &gt;= 0&#39;,
 &#39;x&#39;,
 &#39;x &gt; 0&#39;,
 &#39;x &gt;= 0&#39;]
</pre></div>
</div>
</div>
</div>
<p>We will discuss later how to ensure sufficient diversity in inputs.  (Hint: This involves test generation.)</p>
<p>Let us try out our invariant tracer on <code class="docutils literal notranslate"><span class="pre">sum3()</span></code>.  We see that all types are well-defined; the properties that all arguments are non-zero, however, is specific to the calls observed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">InvariantTracer</span><span class="p">()</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">)</span>

<span class="n">pretty_invariants</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">invariants</span><span class="p">(</span><span class="s1">&#39;sum3&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;a&#39;,
 &#39;b&#39;,
 &#39;c&#39;,
 &#39;isinstance(a, int)&#39;,
 &#39;isinstance(b, int)&#39;,
 &#39;isinstance(c, int)&#39;,
 &#39;isinstance(return_value, int)&#39;,
 &#39;return_value&#39;]
</pre></div>
</div>
</div>
</div>
<p>If we invoke <code class="docutils literal notranslate"><span class="pre">sum3()</span></code> with strings instead, we get different invariants.  Notably, we obtain the postcondition that the returned string always starts with the string in the first argument <code class="docutils literal notranslate"><span class="pre">a</span></code> a universal postcondition if strings are used.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">InvariantTracer</span><span class="p">()</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>

<span class="n">pretty_invariants</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">invariants</span><span class="p">(</span><span class="s1">&#39;sum3&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;a&#39;,
 &#39;a &lt; return_value&#39;,
 &#39;a &lt;= return_value&#39;,
 &#39;a in return_value&#39;,
 &#39;b&#39;,
 &#39;b in return_value&#39;,
 &#39;c&#39;,
 &#39;c in return_value&#39;,
 &#39;return_value&#39;,
 &#39;return_value &gt; a&#39;,
 &#39;return_value &gt;= a&#39;,
 &#39;return_value.endswith(c)&#39;,
 &#39;return_value.startswith(a)&#39;]
</pre></div>
</div>
</div>
</div>
<p>If we invoke <code class="docutils literal notranslate"><span class="pre">sum3()</span></code> with both strings and numbers (and zeros, too), there are no properties left that would hold across all calls.  Thats the price of flexibility.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">InvariantTracer</span><span class="p">()</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">pretty_invariants</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">invariants</span><span class="p">(</span><span class="s1">&#39;sum3&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
</section>
<section id="converting-mined-invariants-to-annotations">
<h3>Converting Mined Invariants to Annotations<a class="headerlink" href="#converting-mined-invariants-to-annotations" title="Link to this heading">#</a></h3>
<p>As with types, above, we would like to have some functionality where we can add the mined invariants as annotations to existing functions.  To this end, we introduce the <code class="docutils literal notranslate"><span class="pre">InvariantAnnotator</span></code> class, extending <code class="docutils literal notranslate"><span class="pre">InvariantTracer</span></code>.</p>
<p>We start with a helper method.  <code class="docutils literal notranslate"><span class="pre">params()</span></code> returns a comma-separated list of parameter names as observed during calls.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">InvariantAnnotator</span><span class="p">(</span><span class="n">InvariantTracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">arguments</span><span class="p">,</span> <span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calls</span><span class="p">(</span><span class="n">function_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arg_name</span> <span class="k">for</span> <span class="p">(</span><span class="n">arg_name</span><span class="p">,</span> <span class="n">arg_value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">25.0</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">annotator</span><span class="o">.</span><span class="n">params</span><span class="p">(</span><span class="s1">&#39;square_root&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;x&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">annotator</span><span class="o">.</span><span class="n">params</span><span class="p">(</span><span class="s1">&#39;sum3&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;a, b, c&#39;
</pre></div>
</div>
</div>
</div>
<p>Now for the actual annotation.  <code class="docutils literal notranslate"><span class="pre">preconditions()</span></code> returns the preconditions from the mined invariants (i.e., those properties that do not depend on the return value) as a string with annotations:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">InvariantAnnotator</span><span class="p">(</span><span class="n">InvariantAnnotator</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">preconditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list of mined preconditions for `function_name`&quot;&quot;&quot;</span>
        <span class="n">conditions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">inv</span> <span class="ow">in</span> <span class="n">pretty_invariants</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invariants</span><span class="p">(</span><span class="n">function_name</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">inv</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">RETURN_VALUE</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># Postcondition</span>

            <span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;@precondition(lambda &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">inv</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
            <span class="n">conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">conditions</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">25.0</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">annotator</span><span class="o">.</span><span class="n">preconditions</span><span class="p">(</span><span class="s1">&#39;square_root&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;@precondition(lambda x: isinstance(x, float))&#39;,
 &#39;@precondition(lambda x: x)&#39;,
 &#39;@precondition(lambda x: x &gt; 0)&#39;,
 &#39;@precondition(lambda x: x &gt;= 0)&#39;]
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">postconditions()</span></code> does the same for postconditions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">InvariantAnnotator</span><span class="p">(</span><span class="n">InvariantAnnotator</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">postconditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list of mined postconditions for `function_name`&quot;&quot;&quot;</span>

        <span class="n">conditions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">inv</span> <span class="ow">in</span> <span class="n">pretty_invariants</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invariants</span><span class="p">(</span><span class="n">function_name</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">inv</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">RETURN_VALUE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># Precondition</span>

            <span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;@postcondition(lambda </span><span class="si">{</span><span class="n">RETURN_VALUE</span><span class="si">}</span><span class="s2">,&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">inv</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">conditions</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">25.0</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">annotator</span><span class="o">.</span><span class="n">postconditions</span><span class="p">(</span><span class="s1">&#39;square_root&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;@postcondition(lambda return_value, x: isinstance(return_value, float))&#39;,
 &#39;@postcondition(lambda return_value, x: return_value)&#39;,
 &#39;@postcondition(lambda return_value, x: return_value &gt; 0)&#39;,
 &#39;@postcondition(lambda return_value, x: return_value &gt;= 0)&#39;]
</pre></div>
</div>
</div>
</div>
<p>With these, we can take a function and add both pre- and postconditions as annotations:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">InvariantAnnotator</span><span class="p">(</span><span class="n">InvariantAnnotator</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">functions_with_invariants</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the code of all observed functions, annotated with invariants&quot;&quot;&quot;</span>

        <span class="n">functions</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">function_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_invariants</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_with_invariants</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">function</span> <span class="o">=</span> <span class="s1">&#39;# Could not find function &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span>

            <span class="n">functions</span> <span class="o">+=</span> <span class="n">function</span>
        <span class="k">return</span> <span class="n">functions</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">function_with_invariants</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the code of `function_name`, annotated with invariants&quot;&quot;&quot;</span>
        <span class="n">function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_func</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">function</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preconditions</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span> <span class="o">+</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">postconditions</span><span class="p">(</span><span class="n">function_name</span><span class="p">))</span> <span class="o">+</span> \
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">source</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;String representation, like `functions_with_invariants()`&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">functions_with_invariants</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Here comes <code class="docutils literal notranslate"><span class="pre">function_with_invariants()</span></code> in all its glory:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">25.0</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">function_with_invariants</span><span class="p">(</span><span class="s1">&#39;square_root&#39;</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>@precondition(<span class=" -Color -Color-Blue">lambda</span> x: <span class=" -Color -Color-Cyan">isinstance</span>(x, <span class=" -Color -Color-Cyan">float</span>))
@precondition(<span class=" -Color -Color-Blue">lambda</span> x: x)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x: x &gt; <span class=" -Color -Color-Blue">0</span>)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x: x &gt;= <span class=" -Color -Color-Blue">0</span>)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x: <span class=" -Color -Color-Cyan">isinstance</span>(return_value, <span class=" -Color -Color-Cyan">float</span>))
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x: return_value)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x: return_value &gt; <span class=" -Color -Color-Blue">0</span>)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x: return_value &gt;= <span class=" -Color -Color-Blue">0</span>)
<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">square_root</span>(x):  <span class=" -Color -Color-White"># type: ignore</span>
<span class=" -Color -Color-White">    </span><span class=" -Color -Color-Yellow">&quot;&quot;&quot;Computes the square root of x, using the Newton-Raphson method&quot;&quot;&quot;</span>
    approx = <span class=" -Color -Color-Blue">None</span>
    guess = x / <span class=" -Color -Color-Blue">2</span>
    <span class=" -Color -Color-Blue">while</span> approx != guess:
        approx = guess
        guess = (approx + x / approx) / <span class=" -Color -Color-Blue">2</span>

    <span class=" -Color -Color-Blue">return</span> approx
</pre></div>
</div>
</div>
</div>
<p>Quite a number of invariants, isnt it?  Further below (and in the exercises), we will discuss on how to focus on the most relevant properties.</p>
</section>
</section>
<section id="avoiding-overspecialization">
<h2>Avoiding Overspecialization<a class="headerlink" href="#avoiding-overspecialization" title="Link to this heading">#</a></h2>
<p>Mined specifications can only be as good as the executions they were mined from. If we only see a single call, for instance, we will be faced with several mined pre- and postconditions that <em>overspecialize</em> towards the values seen.</p>
<p>Let us illustrate this effect on a simple <code class="docutils literal notranslate"><span class="pre">sum2()</span></code> function which adds two numbers.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">sum2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</pre></div>
</div>
</div>
</div>
<p>If we invoke <code class="docutils literal notranslate"><span class="pre">sum2()</span></code> with a variety of arguments, the invariants all capture the relationship between <code class="docutils literal notranslate"><span class="pre">a</span></code>, <code class="docutils literal notranslate"><span class="pre">b</span></code>, and the return value as <code class="docutils literal notranslate"><span class="pre">return_value</span> <span class="pre">==</span> <span class="pre">a</span> <span class="pre">+</span> <span class="pre">b</span></code> in all its variations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">sum2</span><span class="p">(</span><span class="mi">31</span><span class="p">,</span> <span class="mi">45</span><span class="p">)</span>
    <span class="n">sum2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">sum2</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">functions_with_invariants</span><span class="p">(),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>@precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: <span class=" -Color -Color-Cyan">isinstance</span>(a, <span class=" -Color -Color-Cyan">int</span>))
@precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: <span class=" -Color -Color-Cyan">isinstance</span>(b, <span class=" -Color -Color-Cyan">int</span>))
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: a == return_value - b)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: b == return_value - a)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: <span class=" -Color -Color-Cyan">isinstance</span>(return_value, <span class=" -Color -Color-Cyan">int</span>))
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value == a + b)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value == b + a)
<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">sum2</span>(a, b):  <span class=" -Color -Color-White"># type: ignore</span>
    <span class=" -Color -Color-Blue">return</span> a + b
</pre></div>
</div>
</div>
</div>
<p>If, however, we see only a single call, the invariants will overspecialize to the single call seen:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum2</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">functions_with_invariants</span><span class="p">(),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>@precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: a)
@precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: a &lt;= b)
@precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: a == b)
@precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: a &gt; <span class=" -Color -Color-Blue">0</span>)
@precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: a &gt;= <span class=" -Color -Color-Blue">0</span>)
@precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: a &gt;= b)
@precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: b)
@precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: b &lt;= a)
@precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: b == a)
@precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: b &gt; <span class=" -Color -Color-Blue">0</span>)
@precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: b &gt;= <span class=" -Color -Color-Blue">0</span>)
@precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: b &gt;= a)
@precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: <span class=" -Color -Color-Cyan">isinstance</span>(a, <span class=" -Color -Color-Cyan">int</span>))
@precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: <span class=" -Color -Color-Cyan">isinstance</span>(b, <span class=" -Color -Color-Cyan">int</span>))
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: a &lt; return_value)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: a &lt;= b &lt;= return_value)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: a &lt;= return_value)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: a == return_value - b)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: a == return_value / b)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: b &lt; return_value)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: b &lt;= a &lt;= return_value)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: b &lt;= return_value)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: b == return_value - a)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: b == return_value / a)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: <span class=" -Color -Color-Cyan">isinstance</span>(return_value, <span class=" -Color -Color-Cyan">int</span>))
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value == a * b)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value == a + b)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value == b * a)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value == b + a)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value &gt; <span class=" -Color -Color-Blue">0</span>)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value &gt; a)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value &gt; b)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value &gt;= <span class=" -Color -Color-Blue">0</span>)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value &gt;= a)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value &gt;= a &gt;= b)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value &gt;= b)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value &gt;= b &gt;= a)
<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">sum2</span>(a, b):  <span class=" -Color -Color-White"># type: ignore</span>
    <span class=" -Color -Color-Blue">return</span> a + b
</pre></div>
</div>
</div>
</div>
<p>The mined precondition <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">==</span> <span class="pre">b</span></code>, for instance, only holds for the single call observed; the same holds for the mined postcondition <code class="docutils literal notranslate"><span class="pre">return_value</span> <span class="pre">==</span> <span class="pre">a</span> <span class="pre">*</span> <span class="pre">b</span></code>.  Yet, <code class="docutils literal notranslate"><span class="pre">sum2()</span></code> can obviously be successfully called with other values that do not satisfy these conditions.</p>
<p>To get out of this trap, we have to <em>learn from more and more diverse runs</em>.
One way to obtain such runs is by <em>generating</em> inputs. Indeed, a simple test generator for calls of <code class="docutils literal notranslate"><span class="pre">sum2()</span></code> will easily resolve the problem.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">+</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">+</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">length</span> <span class="o">=</span> <span class="n">sum2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">function_with_invariants</span><span class="p">(</span><span class="s1">&#39;sum2&#39;</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>@precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: <span class=" -Color -Color-Cyan">isinstance</span>(a, <span class=" -Color -Color-Cyan">int</span>))
@precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: <span class=" -Color -Color-Cyan">isinstance</span>(b, <span class=" -Color -Color-Cyan">int</span>))
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: a == return_value - b)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: b == return_value - a)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: <span class=" -Color -Color-Cyan">isinstance</span>(return_value, <span class=" -Color -Color-Cyan">int</span>))
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value == a + b)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value == b + a)
<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">sum2</span>(a, b):  <span class=" -Color -Color-White"># type: ignore</span>
    <span class=" -Color -Color-Blue">return</span> a + b
</pre></div>
</div>
</div>
</div>
<p>Note, though, that an API test generator, such as above, will have to be set up such that it actually respects preconditions in our case, we invoke <code class="docutils literal notranslate"><span class="pre">sum2()</span></code> with integers only, already assuming its precondition.  In some way, one thus needs a specification (a model, a grammar) to mine another specification a chicken-and-egg problem.</p>
<p>However, there is one way out of this problem: If one can automatically generate tests at the system level, then one has an <em>infinite source of executions</em> to learn invariants from.  In each of these executions, all functions would be called with values that satisfy the (implicit) precondition, allowing us to mine invariants for these functions.  This holds, because at the system level, invalid inputs must be rejected by the system in the first place.  The meaningful precondition at the system level, ensuring that only valid inputs get through, thus gets broken down into a multitude of meaningful preconditions (and subsequent postconditions) at the function level.</p>
<p>The big requirement for all this, though, is that one needs good test generators. This will be the subject of another book, namely <a class="reference external" href="https://www.fuzzingbook.org/">The Fuzzing Book</a>.</p>
</section>
<section id="partial-invariants">
<h2>Partial Invariants<a class="headerlink" href="#partial-invariants" title="Link to this heading">#</a></h2>
<p>For debugging, it can be helpful to focus on invariants produced only by <em>failing</em> runs, thus characterizing the <em>circumstances under which a function fails</em>. Let us illustrate this on an example.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">middle()</span></code> function from the <a class="reference internal" href="StatisticalDebugger.html"><span class="std std-doc">chapter on statistical debugging</span></a> is supposed to return the middle of three integers <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, and <code class="docutils literal notranslate"><span class="pre">z</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">StatisticalDebugger</span><span class="w"> </span><span class="kn">import</span> <span class="n">middle</span>  <span class="c1"># minor dependency</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">+</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">+</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">+</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="n">middle</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
<p>By default, our <code class="docutils literal notranslate"><span class="pre">InvariantAnnotator()</span></code> does not return any particular pre- or postcondition (other than the types observed). That is just fine, as the function indeed imposes no particular precondition; and the postcondition from <code class="docutils literal notranslate"><span class="pre">middle()</span></code> is not covered by the <code class="docutils literal notranslate"><span class="pre">InvariantAnnotator</span></code> patterns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">functions_with_invariants</span><span class="p">(),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-White"># Could not find function &#39;_randbelow_with_getrandbits&#39;# Could not find function &#39;randrange&#39;@precondition(lambda x, y, z: isinstance(x, int))</span>
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: <span class=" -Color -Color-Cyan">isinstance</span>(y, <span class=" -Color -Color-Cyan">int</span>))
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: <span class=" -Color -Color-Cyan">isinstance</span>(z, <span class=" -Color -Color-Cyan">int</span>))
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: <span class=" -Color -Color-Cyan">isinstance</span>(return_value, <span class=" -Color -Color-Cyan">int</span>))
<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">middle</span>(x, y, z):  <span class=" -Color -Color-White"># type: ignore</span>
    <span class=" -Color -Color-Blue">if</span> y &lt; z:
        <span class=" -Color -Color-Blue">if</span> x &lt; y:
            <span class=" -Color -Color-Blue">return</span> y
        <span class=" -Color -Color-Blue">elif</span> x &lt; z:
            <span class=" -Color -Color-Blue">return</span> y
    <span class=" -Color -Color-Blue">else</span>:
        <span class=" -Color -Color-Blue">if</span> x &gt; y:
            <span class=" -Color -Color-Blue">return</span> y
        <span class=" -Color -Color-Blue">elif</span> x &gt; z:
            <span class=" -Color -Color-Blue">return</span> x
    <span class=" -Color -Color-Blue">return</span> z
</pre></div>
</div>
</div>
</div>
<p>Things get more interesting if we focus on a particular subset of runs only, though - say, a set of inputs where <code class="docutils literal notranslate"><span class="pre">middle()</span></code> fails.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">StatisticalDebugger</span><span class="w"> </span><span class="kn">import</span> <span class="n">MIDDLE_FAILING_TESTCASES</span>  <span class="c1"># minor dependency</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">MIDDLE_FAILING_TESTCASES</span><span class="p">:</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="n">middle</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">functions_with_invariants</span><span class="p">(),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: <span class=" -Color -Color-Cyan">isinstance</span>(x, <span class=" -Color -Color-Cyan">int</span>))
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: <span class=" -Color -Color-Cyan">isinstance</span>(y, <span class=" -Color -Color-Cyan">int</span>))
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: <span class=" -Color -Color-Cyan">isinstance</span>(z, <span class=" -Color -Color-Cyan">int</span>))
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: x)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: x &lt; z)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: x &lt;= z)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: x &gt; <span class=" -Color -Color-Blue">0</span>)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: x &gt; y)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: x &gt;= <span class=" -Color -Color-Blue">0</span>)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: x &gt;= y)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: y &lt; x)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: y &lt; x &lt; z)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: y &lt; z)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: y &lt;= x)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: y &lt;= x &lt;= z)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: y &lt;= z)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: y &gt;= <span class=" -Color -Color-Blue">0</span>)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: z)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: z &gt; <span class=" -Color -Color-Blue">0</span>)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: z &gt; x)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: z &gt; x &gt; y)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: z &gt; y)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: z &gt;= <span class=" -Color -Color-Blue">0</span>)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: z &gt;= x)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: z &gt;= x &gt;= y)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: z &gt;= y)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: <span class=" -Color -Color-Cyan">isinstance</span>(return_value, <span class=" -Color -Color-Cyan">int</span>))
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: return_value &lt; x)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: return_value &lt; x &lt; z)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: return_value &lt; z)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: return_value &lt;= x)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: return_value &lt;= x &lt;= z)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: return_value &lt;= y)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: return_value &lt;= y &lt;= x)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: return_value &lt;= y &lt;= z)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: return_value &lt;= z)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: return_value == y)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: return_value &gt;= <span class=" -Color -Color-Blue">0</span>)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: return_value &gt;= y)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: x &gt; return_value)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: x &gt;= return_value)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: x &gt;= return_value &gt;= y)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: x &gt;= y &gt;= return_value)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: y &lt;= return_value)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: y &lt;= return_value &lt;= x)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: y &lt;= return_value &lt;= z)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: y == return_value)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: y &gt;= return_value)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: z &gt; return_value)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: z &gt; x &gt; return_value)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: z &gt;= return_value)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: z &gt;= return_value &gt;= y)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: z &gt;= x &gt;= return_value)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: z &gt;= y &gt;= return_value)
<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">middle</span>(x, y, z):  <span class=" -Color -Color-White"># type: ignore</span>
    <span class=" -Color -Color-Blue">if</span> y &lt; z:
        <span class=" -Color -Color-Blue">if</span> x &lt; y:
            <span class=" -Color -Color-Blue">return</span> y
        <span class=" -Color -Color-Blue">elif</span> x &lt; z:
            <span class=" -Color -Color-Blue">return</span> y
    <span class=" -Color -Color-Blue">else</span>:
        <span class=" -Color -Color-Blue">if</span> x &gt; y:
            <span class=" -Color -Color-Blue">return</span> y
        <span class=" -Color -Color-Blue">elif</span> x &gt; z:
            <span class=" -Color -Color-Blue">return</span> x
    <span class=" -Color -Color-Blue">return</span> z
</pre></div>
</div>
</div>
</div>
<p>Now thats an intimidating set of pre- and postconditions. However, almost all of the preconditions are implied by the one precondition</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@precondition</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">z</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;y &lt; x &lt; z&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>which characterizes the exact condition under which <code class="docutils literal notranslate"><span class="pre">middle()</span></code> fails (which also happens to be the condition under which the erroneous second <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">y</span></code> is executed). By checking how <em>invariants for failing runs</em> differ from <em>invariants for passing runs</em>, we can identify circumstances for function failures.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">Could <code>InvariantAnnotator</code> also determine a precondition that characterizes <em>passing</em> runs?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">
    
        <input type="radio" name="fb2e13da-b293-11f0-88db-6298cf1a5790" id="fb2e13da-b293-11f0-88db-6298cf1a5790-1" onclick="clear_selection('fb2e13da-b293-11f0-88db-6298cf1a5790')">
        <label id="fb2e13da-b293-11f0-88db-6298cf1a5790-1-label" for="fb2e13da-b293-11f0-88db-6298cf1a5790-1">Yes</label><br>
    
        <input type="radio" name="fb2e13da-b293-11f0-88db-6298cf1a5790" id="fb2e13da-b293-11f0-88db-6298cf1a5790-2" onclick="clear_selection('fb2e13da-b293-11f0-88db-6298cf1a5790')">
        <label id="fb2e13da-b293-11f0-88db-6298cf1a5790-2-label" for="fb2e13da-b293-11f0-88db-6298cf1a5790-2">No</label><br>
    
    </div>
    </p>
    <input id="fb2e13da-b293-11f0-88db-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('fb2e13da-b293-11f0-88db-6298cf1a5790', 4, 0, 'int(math.exp(1))')">
    <span class="quiz_hint" id="fb2e13da-b293-11f0-88db-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
<p>Indeed, it cannot the correct invariant for passing runs would be the <em>inverse</em> of the invariant for failing runs, and <code class="docutils literal notranslate"><span class="pre">not</span> <span class="pre">A</span> <span class="pre">&lt;</span> <span class="pre">B</span> <span class="pre">&lt;</span> <span class="pre">C</span></code> is not part of our invariant library. We can easily test this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">StatisticalDebugger</span><span class="w"> </span><span class="kn">import</span> <span class="n">MIDDLE_PASSING_TESTCASES</span>  <span class="c1"># minor dependency</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">MIDDLE_PASSING_TESTCASES</span><span class="p">:</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="n">middle</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">functions_with_invariants</span><span class="p">(),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: <span class=" -Color -Color-Cyan">isinstance</span>(x, <span class=" -Color -Color-Cyan">int</span>))
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: <span class=" -Color -Color-Cyan">isinstance</span>(y, <span class=" -Color -Color-Cyan">int</span>))
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: <span class=" -Color -Color-Cyan">isinstance</span>(z, <span class=" -Color -Color-Cyan">int</span>))
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: x &gt;= <span class=" -Color -Color-Blue">0</span>)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: y &gt;= <span class=" -Color -Color-Blue">0</span>)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x, y, z: z &gt;= <span class=" -Color -Color-Blue">0</span>)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: <span class=" -Color -Color-Cyan">isinstance</span>(return_value, <span class=" -Color -Color-Cyan">int</span>))
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x, y, z: return_value &gt;= <span class=" -Color -Color-Blue">0</span>)
<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">middle</span>(x, y, z):  <span class=" -Color -Color-White"># type: ignore</span>
    <span class=" -Color -Color-Blue">if</span> y &lt; z:
        <span class=" -Color -Color-Blue">if</span> x &lt; y:
            <span class=" -Color -Color-Blue">return</span> y
        <span class=" -Color -Color-Blue">elif</span> x &lt; z:
            <span class=" -Color -Color-Blue">return</span> y
    <span class=" -Color -Color-Blue">else</span>:
        <span class=" -Color -Color-Blue">if</span> x &gt; y:
            <span class=" -Color -Color-Blue">return</span> y
        <span class=" -Color -Color-Blue">elif</span> x &gt; z:
            <span class=" -Color -Color-Blue">return</span> x
    <span class=" -Color -Color-Blue">return</span> z
</pre></div>
</div>
</div>
</div>
</section>
<section id="some-examples">
<h2>Some Examples<a class="headerlink" href="#some-examples" title="Link to this heading">#</a></h2>
<p>Let us try out the <code class="docutils literal notranslate"><span class="pre">InvariantAnnotator</span></code> on a number of examples.</p>
<section id="removing-html-markup">
<h3>Removing HTML Markup<a class="headerlink" href="#removing-html-markup" title="Link to this heading">#</a></h3>
<p>Running <code class="docutils literal notranslate"><span class="pre">InvariantAnnotator</span></code> on our ongoing example <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code> does not provide much, as our invariant properties are tailored towards numerical functions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">Intro_Debugging</span><span class="w"> </span><span class="kn">import</span> <span class="n">remove_html_markup</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="s2">&quot;&lt;foo&gt;bar&lt;/foo&gt;&quot;</span><span class="p">)</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="s2">&quot;bar&quot;</span><span class="p">)</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&quot;bar&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">functions_with_invariants</span><span class="p">(),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>@precondition(<span class=" -Color -Color-Blue">lambda</span> s: s)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, s: return_value)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, s: return_value &gt;= s)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, s: return_value <span class=" -Color -Color-Magenta">in</span> s)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, s: s &lt;= return_value)
<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">remove_html_markup</span>(s):  <span class=" -Color -Color-White"># type: ignore</span>
    tag = <span class=" -Color -Color-Blue">False</span>
    quote = <span class=" -Color -Color-Blue">False</span>
    out = <span class=" -Color -Color-Yellow">&quot;&quot;</span>

    <span class=" -Color -Color-Blue">for</span> c <span class=" -Color -Color-Magenta">in</span> s:
        <span class=" -Color -Color-Blue">assert</span> tag <span class=" -Color -Color-Magenta">or</span> <span class=" -Color -Color-Magenta">not</span> quote

        <span class=" -Color -Color-Blue">if</span> c == <span class=" -Color -Color-Yellow">&#39;&lt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> <span class=" -Color -Color-Magenta">not</span> quote:
            tag = <span class=" -Color -Color-Blue">True</span>
        <span class=" -Color -Color-Blue">elif</span> c == <span class=" -Color -Color-Yellow">&#39;&gt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> <span class=" -Color -Color-Magenta">not</span> quote:
            tag = <span class=" -Color -Color-Blue">False</span>
        <span class=" -Color -Color-Blue">elif</span> (c == <span class=" -Color -Color-Yellow">&#39;&quot;&#39;</span> <span class=" -Color -Color-Magenta">or</span> c == <span class=" -Color -Color-Yellow">&quot;&#39;&quot;</span>) <span class=" -Color -Color-Magenta">and</span> tag:
            quote = <span class=" -Color -Color-Magenta">not</span> quote
        <span class=" -Color -Color-Blue">elif</span> <span class=" -Color -Color-Magenta">not</span> tag:
            out = out + c

    <span class=" -Color -Color-Blue">return</span> out
</pre></div>
</div>
</div>
</div>
<p>In the <a class="reference internal" href="DDSetDebugger.html"><span class="std std-doc">chapter on DDSet</span></a>, we will see how to express more complex properties for structured inputs.</p>
</section>
<section id="a-recursive-function">
<h3>A Recursive Function<a class="headerlink" href="#a-recursive-function" title="Link to this heading">#</a></h3>
<p>Heres another example.  <code class="docutils literal notranslate"><span class="pre">list_length()</span></code> recursively computes the length of a Python function.  Let us see whether we can mine its invariants:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">list_length</span><span class="p">(</span><span class="n">elems</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">elems</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">length</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">list_length</span><span class="p">(</span><span class="n">elems</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">return</span> <span class="n">length</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">list_length</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

<span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">functions_with_invariants</span><span class="p">(),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>@precondition(<span class=" -Color -Color-Blue">lambda</span> elems: <span class=" -Color -Color-Cyan">isinstance</span>(elems, <span class=" -Color -Color-Cyan">list</span>))
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, elems: <span class=" -Color -Color-Cyan">isinstance</span>(return_value, <span class=" -Color -Color-Cyan">int</span>))
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, elems: return_value == <span class=" -Color -Color-Cyan">len</span>(elems))
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, elems: return_value &gt;= <span class=" -Color -Color-Blue">0</span>)
<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">list_length</span>(elems: List[Any]) -&gt; <span class=" -Color -Color-Cyan">int</span>:
    <span class=" -Color -Color-Blue">if</span> elems == []:
        length = <span class=" -Color -Color-Blue">0</span>
    <span class=" -Color -Color-Blue">else</span>:
        length = <span class=" -Color -Color-Blue">1</span> + list_length(elems[<span class=" -Color -Color-Blue">1</span>:])
    <span class=" -Color -Color-Blue">return</span> length
</pre></div>
</div>
</div>
</div>
<p>Almost all these properties are relevant.  Of course, the reason the invariants are so neat is that the return value is equal to <code class="docutils literal notranslate"><span class="pre">len(elems)</span></code> is that <code class="docutils literal notranslate"><span class="pre">X</span> <span class="pre">==</span> <span class="pre">len(Y)</span></code> is part of the list of properties to be checked.</p>
</section>
<section id="sum-of-two-numbers">
<h3>Sum of two Numbers<a class="headerlink" href="#sum-of-two-numbers" title="Link to this heading">#</a></h3>
<p>The next example is a very simple function: If we have a function without return value, the return value is <code class="docutils literal notranslate"><span class="pre">None</span></code>, and we can only mine preconditions.  (Well, we get a postcondition <code class="docutils literal notranslate"><span class="pre">not</span> <span class="pre">return_value</span></code> that the return value evaluates to False, which holds for <code class="docutils literal notranslate"><span class="pre">None</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">print_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">print_sum</span><span class="p">(</span><span class="mi">31</span><span class="p">,</span> <span class="mi">45</span><span class="p">)</span>
    <span class="n">print_sum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">print_sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>76
0
-6
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">functions_with_invariants</span><span class="p">(),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-White"># Could not find function &#39;parent_header&#39;# Could not find function &#39;_is_master_process&#39;# Could not find function &#39;utcoffset&#39;# Could not find function &#39;is_set&#39;# Could not find function &#39;is_alive&#39;# Could not find function &#39;_event_pipe&#39;# Could not find function &#39;send&#39;# Could not find function &#39;schedule&#39;# Could not find function &#39;_schedule_flush&#39;# Could not find function &#39;write&#39;# Could not find function &#39;is_publishing&#39;# Could not find function &#39;is_active&#39;@precondition(lambda typ, val: typ)</span>
@precondition(<span class=" -Color -Color-Blue">lambda</span> typ, val: val)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, typ, val: return_value)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, typ, val: return_value == val)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, typ, val: val == return_value)
<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">cast</span>(typ, val):
<span class=" -Color -Color-White">    </span><span class=" -Color -Color-Yellow">&quot;&quot;&quot;Cast a value to a type.</span>

<span class=" -Color -Color-Yellow">    This returns the value unchanged.  To the type checker this</span>
<span class=" -Color -Color-Yellow">    signals that the return value has the designated type, but at</span>
<span class=" -Color -Color-Yellow">    runtime we intentionally don&#39;t check anything (we want this</span>
<span class=" -Color -Color-Yellow">    to be as fast as possible).</span>
<span class=" -Color -Color-Yellow">    &quot;&quot;&quot;</span>
    <span class=" -Color -Color-Blue">return</span> val
<span class=" -Color -Color-White"># Could not find function &#39;get&#39;# Could not find function &#39;__get__&#39;# Could not find function &#39;__init__&#39;@precondition(lambda a, b: isinstance(a, int))</span>
@precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: <span class=" -Color -Color-Cyan">isinstance</span>(b, <span class=" -Color -Color-Cyan">int</span>))
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: <span class=" -Color -Color-Magenta">not</span> return_value)
<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">print_sum</span>(a, b):  <span class=" -Color -Color-White"># type: ignore</span>
    <span class=" -Color -Color-Cyan">print</span>(a + b)
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="checking-specifications">
<h2>Checking Specifications<a class="headerlink" href="#checking-specifications" title="Link to this heading">#</a></h2>
<p>A function with invariants, as above, can be fed into the Python interpreter, such that all pre- and postconditions are checked.  We create a function <code class="docutils literal notranslate"><span class="pre">square_root_annotated()</span></code> which includes all the invariants mined above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">InvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">25.0</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">square_root_def</span> <span class="o">=</span> <span class="n">annotator</span><span class="o">.</span><span class="n">functions_with_invariants</span><span class="p">()</span>
<span class="n">square_root_def</span> <span class="o">=</span> <span class="n">square_root_def</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;square_root&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;square_root_annotated&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">square_root_def</span><span class="p">,</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>@precondition(<span class=" -Color -Color-Blue">lambda</span> x: <span class=" -Color -Color-Cyan">isinstance</span>(x, <span class=" -Color -Color-Cyan">float</span>))
@precondition(<span class=" -Color -Color-Blue">lambda</span> x: x)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x: x &gt; <span class=" -Color -Color-Blue">0</span>)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x: x &gt;= <span class=" -Color -Color-Blue">0</span>)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x: <span class=" -Color -Color-Cyan">isinstance</span>(return_value, <span class=" -Color -Color-Cyan">float</span>))
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x: return_value)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x: return_value &gt; <span class=" -Color -Color-Blue">0</span>)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x: return_value &gt;= <span class=" -Color -Color-Blue">0</span>)
<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">square_root_annotated</span>(x):  <span class=" -Color -Color-White"># type: ignore</span>
<span class=" -Color -Color-White">    </span><span class=" -Color -Color-Yellow">&quot;&quot;&quot;Computes the square root of x, using the Newton-Raphson method&quot;&quot;&quot;</span>
    approx = <span class=" -Color -Color-Blue">None</span>
    guess = x / <span class=" -Color -Color-Blue">2</span>
    <span class=" -Color -Color-Blue">while</span> approx != guess:
        approx = guess
        guess = (approx + x / approx) / <span class=" -Color -Color-Blue">2</span>

    <span class=" -Color -Color-Blue">return</span> approx
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exec</span><span class="p">(</span><span class="n">square_root_def</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The annotated version checks against invalid arguments or more precisely, against arguments with properties that have not been observed yet:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">square_root_annotated</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_52062/2533314883.py&quot;, line 2, in &lt;module&gt;
    square_root_annotated(-1.0)  # type: ignore
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_52062/3759592669.py&quot;, line 11, in wrapper
    retval = func(*args, **kwargs)
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_52062/3759592669.py&quot;, line 11, in wrapper
    retval = func(*args, **kwargs)
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_52062/3759592669.py&quot;, line 7, in wrapper
    assert precondition(*args, **kwargs), \
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
AssertionError: Precondition violated (expected)
</pre></div>
</div>
</div>
</div>
<p>This is in contrast to the original version, which just hangs on negative values:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectTimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">square_root</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_52062/3436772654.py&quot;, line 2, in &lt;module&gt;
    square_root(-1.0)
    ~~~~~~~~~~~^^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_52062/81976482.py&quot;, line 5, in square_root
    while approx != guess:
          ^^^^^^^^^^^^^^^
  File &quot;Timeout.ipynb&quot;, line 43, in timeout_handler
    raise TimeoutError()
TimeoutError (expected)
</pre></div>
</div>
</div>
</div>
<p>If we make changes to the function definition such that the properties of the return value change, such <em>regressions</em> are caught as violations of the postconditions.  Let us illustrate this by simply inverting the result, and return <span class="math notranslate nohighlight">\(-2\)</span> as square root of 4.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">square_root_def</span> <span class="o">=</span> <span class="n">square_root_def</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;square_root_annotated&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;square_root_negative&#39;</span><span class="p">)</span>
<span class="n">square_root_def</span> <span class="o">=</span> <span class="n">square_root_def</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;return approx&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;return -approx&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">square_root_def</span><span class="p">,</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>@precondition(<span class=" -Color -Color-Blue">lambda</span> x: <span class=" -Color -Color-Cyan">isinstance</span>(x, <span class=" -Color -Color-Cyan">float</span>))
@precondition(<span class=" -Color -Color-Blue">lambda</span> x: x)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x: x &gt; <span class=" -Color -Color-Blue">0</span>)
@precondition(<span class=" -Color -Color-Blue">lambda</span> x: x &gt;= <span class=" -Color -Color-Blue">0</span>)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x: <span class=" -Color -Color-Cyan">isinstance</span>(return_value, <span class=" -Color -Color-Cyan">float</span>))
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x: return_value)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x: return_value &gt; <span class=" -Color -Color-Blue">0</span>)
@postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, x: return_value &gt;= <span class=" -Color -Color-Blue">0</span>)
<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">square_root_negative</span>(x):  <span class=" -Color -Color-White"># type: ignore</span>
<span class=" -Color -Color-White">    </span><span class=" -Color -Color-Yellow">&quot;&quot;&quot;Computes the square root of x, using the Newton-Raphson method&quot;&quot;&quot;</span>
    approx = <span class=" -Color -Color-Blue">None</span>
    guess = x / <span class=" -Color -Color-Blue">2</span>
    <span class=" -Color -Color-Blue">while</span> approx != guess:
        approx = guess
        guess = (approx + x / approx) / <span class=" -Color -Color-Blue">2</span>

    <span class=" -Color -Color-Blue">return</span> -approx
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exec</span><span class="p">(</span><span class="n">square_root_def</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Technically speaking, <span class="math notranslate nohighlight">\(-2\)</span> <em>is</em> a square root of 4, since <span class="math notranslate nohighlight">\((-2)^2 = 4\)</span> holds.  Yet, such a change may be unexpected by callers of <code class="docutils literal notranslate"><span class="pre">square_root()</span></code>, and hence, this would be caught with the first call:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">square_root_negative</span><span class="p">(</span><span class="mf">4.0</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_52062/2283626907.py&quot;, line 2, in &lt;module&gt;
    square_root_negative(4.0)  # type: ignore
    ~~~~~~~~~~~~~~~~~~~~^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_52062/3759592669.py&quot;, line 11, in wrapper
    retval = func(*args, **kwargs)
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_52062/3759592669.py&quot;, line 11, in wrapper
    retval = func(*args, **kwargs)
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_52062/3759592669.py&quot;, line 11, in wrapper
    retval = func(*args, **kwargs)
  [Previous line repeated 4 more times]
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_52062/3759592669.py&quot;, line 13, in wrapper
    assert postcondition(retval, *args, **kwargs), \
           ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError: Postcondition violated (expected)
</pre></div>
</div>
</div>
</div>
<p>We see how pre- and postconditions, as well as types, can serve as <em>oracles</em> during testing.  In particular, once we have mined them for a set of functions, we can check them again and again with test generators especially after code changes.  The more checks we have, and the more specific they are, the more likely it is we can detect unwanted effects of changes.</p>
</section>
<section id="lessons-learned">
<h2>Lessons Learned<a class="headerlink" href="#lessons-learned" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Type annotations and explicit invariants allow for <em>checking</em> arguments and results for expected data types and other properties.</p></li>
<li><p>One can automatically <em>mine</em> data types and invariants by observing arguments and results at runtime.</p></li>
<li><p>The quality of mined invariants depends on the diversity of values observed during executions; this variety can be increased by generating tests.</p></li>
</ul>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Link to this heading">#</a></h2>
<p>In the next chapter, we will explore <a class="reference internal" href="DDSetDebugger.html"><span class="std std-doc">abstracting failure conditions</span></a>.</p>
</section>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">#</a></h2>
<p>The <a class="reference external" href="https://plse.cs.washington.edu/daikon/">DAIKON dynamic invariant detector</a> can be considered the mother of function specification miners.  Continuously maintained and extended for more than 20 years, it mines likely invariants in the style of this chapter for a variety of languages, including C, C++, C#, Eiffel, F#, Java, Perl, and Visual Basic.  On top of the functionality discussed above, it holds a rich catalog of patterns for likely invariants, supports data invariants, can eliminate invariants that are implied by others, and determines statistical confidence to disregard unlikely invariants.  The corresponding paper \cite{Ernst2001} is one of the seminal and most-cited papers of Software Engineering.  A multitude of works have been published based on DAIKON and detecting invariants; see this <a class="reference external" href="http://plse.cs.washington.edu/daikon/pubs/">curated list</a> for details.</p>
<p>The interaction between test generators and invariant detection is already discussed in \cite{Ernst2001} (incidentally also using grammars).  The Eclat tool \cite{Pacheco2005} is a model example of tight interaction between a unit-level test generator and DAIKON-style invariant mining, where the mined invariants are used to produce oracles and to systematically guide the test generator towards fault-revealing inputs.</p>
<p>Mining specifications is not restricted to pre- and postconditions.  The paper Mining Specifications \cite{Ammons2002} is another classic in the field, learning state protocols from executions.  Grammar mining \cite{Gopinath2020} can also be seen as a specification mining approach, this time learning specifications for input formats.</p>
<p>As it comes to adding type annotations to existing code, the blog post <a class="reference external" href="https://www.bernat.tech/the-state-of-type-hints-in-python/">The state of type hints in Python</a> gives a great overview on how Python type hints can be used and checked.  To add type annotations, there are two important tools available that also implement our above approach:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://instagram-engineering.com/let-your-code-type-hint-itself-introducing-open-source-monkeytype-a855c7284881">MonkeyType</a> implements the above approach of tracing executions and annotating Python 3 arguments, returns, and variables with type hints.</p></li>
<li><p><a class="reference external" href="https://github.com/dropbox/pyannotate">PyAnnotate</a> does a similar job, focusing on code in Python 2.  It does not produce Python 3-style annotations, but instead produces annotations as comments that can be processed by static type checkers.</p></li>
</ul>
<p>These tools have been created by engineers at Facebook and Dropbox, respectively, assisting them in checking millions of lines of code for type issues.</p>
</section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<p>Our code for mining types and invariants is in no way complete.  There are dozens of ways to extend our implementations, some of which we discuss in exercises.</p>
<section id="exercise-1-union-types">
<h3>Exercise 1: Union Types<a class="headerlink" href="#exercise-1-union-types" title="Link to this heading">#</a></h3>
<p>The Python <code class="docutils literal notranslate"><span class="pre">typing</span></code> module allows expressing that an argument can have multiple types.  For <code class="docutils literal notranslate"><span class="pre">square_root(x)</span></code>, this allows expressing that <code class="docutils literal notranslate"><span class="pre">x</span></code> can be an <code class="docutils literal notranslate"><span class="pre">int</span></code> or a <code class="docutils literal notranslate"><span class="pre">float</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">square_root_with_union_type</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
    <span class="o">...</span>
</pre></div>
</div>
</div>
</div>
<p>Extend the <code class="docutils literal notranslate"><span class="pre">TypeAnnotator</span></code> such that it supports union types for arguments and return values.  Use <code class="docutils literal notranslate"><span class="pre">Optional[X]</span></code> as a shorthand for <code class="docutils literal notranslate"><span class="pre">Union[X,</span> <span class="pre">None]</span></code>.</p>
<p><strong>Solution.</strong> Left to the reader. Hint: extend <code class="docutils literal notranslate"><span class="pre">type_string()</span></code>.</p>
</section>
<section id="exercise-2-types-for-local-variables">
<h3>Exercise 2: Types for Local Variables<a class="headerlink" href="#exercise-2-types-for-local-variables" title="Link to this heading">#</a></h3>
<p>In Python, one cannot only annotate arguments with types, but actually also local and global variables  for instance, <code class="docutils literal notranslate"><span class="pre">approx</span></code> and <code class="docutils literal notranslate"><span class="pre">guess</span></code> in our <code class="docutils literal notranslate"><span class="pre">square_root()</span></code> implementation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">square_root_with_local_types</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes the square root of x, using the Newton-Raphson method&quot;&quot;&quot;</span>
    <span class="n">approx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">guess</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">while</span> <span class="n">approx</span> <span class="o">!=</span> <span class="n">guess</span><span class="p">:</span>
        <span class="n">approx</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">guess</span>  <span class="c1"># type: ignore</span>
        <span class="n">guess</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="p">(</span><span class="n">approx</span> <span class="o">+</span> <span class="n">x</span> <span class="o">/</span> <span class="n">approx</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># type: ignore</span>
    <span class="k">return</span> <span class="n">approx</span>
</pre></div>
</div>
</div>
</div>
<p>Extend the <code class="docutils literal notranslate"><span class="pre">TypeAnnotator</span></code> such that it also annotates local variables with types.  Search the function AST for assignments, determine the type of the assigned value, and make it an annotation on the left-hand side.</p>
<p><strong>Solution.</strong> Left to the reader.</p>
</section>
<section id="exercise-3-verbose-invariant-checkers">
<h3>Exercise 3: Verbose Invariant Checkers<a class="headerlink" href="#exercise-3-verbose-invariant-checkers" title="Link to this heading">#</a></h3>
<p>Our implementation of invariant checkers does not make it clear for the user which pre-/postcondition failed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@precondition</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">remove_first_char</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">remove_first_char</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_52062/2212034949.py&quot;, line 2, in &lt;module&gt;
    remove_first_char(&#39;&#39;)
    ~~~~~~~~~~~~~~~~~^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_52062/3759592669.py&quot;, line 7, in wrapper
    assert precondition(*args, **kwargs), \
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
AssertionError: Precondition violated (expected)
</pre></div>
</div>
</div>
</div>
<p>The following implementation adds an optional <code class="docutils literal notranslate"><span class="pre">doc</span></code> keyword argument which is printed if the invariant is violated:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">verbose_condition</span><span class="p">(</span><span class="n">precondition</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">postcondition</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">doc</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
        <span class="c1"># Use `functools` to preserve name, docstring, etc</span>
        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">precondition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">precondition</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> \
                    <span class="s2">&quot;Precondition violated: &quot;</span> <span class="o">+</span> <span class="n">doc</span>

            <span class="c1"># call original function or method</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">postcondition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">postcondition</span><span class="p">(</span><span class="n">retval</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> \
                    <span class="s2">&quot;Postcondition violated: &quot;</span> <span class="o">+</span> <span class="n">doc</span>

            <span class="k">return</span> <span class="n">retval</span>

        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">decorator</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">verbose_precondition</span><span class="p">(</span><span class="n">check</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">verbose_condition</span><span class="p">(</span><span class="n">precondition</span><span class="o">=</span><span class="n">check</span><span class="p">,</span>
                             <span class="n">doc</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;doc&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">verbose_postcondition</span><span class="p">(</span><span class="n">check</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">verbose_condition</span><span class="p">(</span><span class="n">postcondition</span><span class="o">=</span><span class="n">check</span><span class="p">,</span>
                             <span class="n">doc</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;doc&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@verbose_precondition</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;len(s) &gt; 0&quot;</span><span class="p">)</span>    <span class="c1"># type: ignore</span>
<span class="k">def</span><span class="w"> </span><span class="nf">remove_first_char</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">remove_first_char</span><span class="p">(</span><span class="s1">&#39;abc&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;bc&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">remove_first_char</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_52062/2212034949.py&quot;, line 2, in &lt;module&gt;
    remove_first_char(&#39;&#39;)
    ~~~~~~~~~~~~~~~~~^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_52062/706783034.py&quot;, line 9, in wrapper
    assert precondition(*args, **kwargs), \
           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
AssertionError: Precondition violated: len(s) &gt; 0 (expected)
</pre></div>
</div>
</div>
</div>
<p>Extend <code class="docutils literal notranslate"><span class="pre">InvariantAnnotator</span></code> into a <code class="docutils literal notranslate"><span class="pre">VerboseInvariantAnnotator</span></code> class that includes the conditions in the generated pre- and postconditions.</p>
<p><strong>Solution.</strong> Heres a simple solution:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">VerboseInvariantAnnotator</span><span class="p">(</span><span class="n">InvariantAnnotator</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">preconditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">conditions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">inv</span> <span class="ow">in</span> <span class="n">pretty_invariants</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invariants</span><span class="p">(</span><span class="n">function_name</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">inv</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">RETURN_VALUE</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># Postcondition</span>

            <span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;@verbose_precondition(lambda &quot;</span> <span class="o">+</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span>
                    <span class="n">inv</span> <span class="o">+</span> <span class="s1">&#39;, doc=&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">inv</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
            <span class="n">conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">conditions</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">VerboseInvariantAnnotator</span><span class="p">(</span><span class="n">VerboseInvariantAnnotator</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">postconditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">conditions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">inv</span> <span class="ow">in</span> <span class="n">pretty_invariants</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invariants</span><span class="p">(</span><span class="n">function_name</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">inv</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">RETURN_VALUE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># Precondition</span>

            <span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;@verbose_postcondition(lambda &quot;</span> <span class="o">+</span>
                    <span class="n">RETURN_VALUE</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span>
                    <span class="n">inv</span> <span class="o">+</span> <span class="s1">&#39;, doc=&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">inv</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
            <span class="n">conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">conditions</span>
</pre></div>
</div>
</div>
</div>
<p>The resulting annotations are harder to read, but easier to diagnose:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">VerboseInvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum2</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">functions_with_invariants</span><span class="p">(),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>@verbose_precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: a, doc=<span class=" -Color -Color-Yellow">&#39;a&#39;</span>)
@verbose_precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: a &lt;= b, doc=<span class=" -Color -Color-Yellow">&#39;a &lt;= b&#39;</span>)
@verbose_precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: a == b, doc=<span class=" -Color -Color-Yellow">&#39;a == b&#39;</span>)
@verbose_precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: a &gt; <span class=" -Color -Color-Blue">0</span>, doc=<span class=" -Color -Color-Yellow">&#39;a &gt; 0&#39;</span>)
@verbose_precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: a &gt;= <span class=" -Color -Color-Blue">0</span>, doc=<span class=" -Color -Color-Yellow">&#39;a &gt;= 0&#39;</span>)
@verbose_precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: a &gt;= b, doc=<span class=" -Color -Color-Yellow">&#39;a &gt;= b&#39;</span>)
@verbose_precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: b, doc=<span class=" -Color -Color-Yellow">&#39;b&#39;</span>)
@verbose_precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: b &lt;= a, doc=<span class=" -Color -Color-Yellow">&#39;b &lt;= a&#39;</span>)
@verbose_precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: b == a, doc=<span class=" -Color -Color-Yellow">&#39;b == a&#39;</span>)
@verbose_precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: b &gt; <span class=" -Color -Color-Blue">0</span>, doc=<span class=" -Color -Color-Yellow">&#39;b &gt; 0&#39;</span>)
@verbose_precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: b &gt;= <span class=" -Color -Color-Blue">0</span>, doc=<span class=" -Color -Color-Yellow">&#39;b &gt;= 0&#39;</span>)
@verbose_precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: b &gt;= a, doc=<span class=" -Color -Color-Yellow">&#39;b &gt;= a&#39;</span>)
@verbose_precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: <span class=" -Color -Color-Cyan">isinstance</span>(a, <span class=" -Color -Color-Cyan">int</span>), doc=<span class=" -Color -Color-Yellow">&#39;isinstance(a, int)&#39;</span>)
@verbose_precondition(<span class=" -Color -Color-Blue">lambda</span> a, b: <span class=" -Color -Color-Cyan">isinstance</span>(b, <span class=" -Color -Color-Cyan">int</span>), doc=<span class=" -Color -Color-Yellow">&#39;isinstance(b, int)&#39;</span>)
@verbose_postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: a &lt; return_value, doc=<span class=" -Color -Color-Yellow">&#39;a &lt; return_value&#39;</span>)
@verbose_postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: a &lt;= b &lt;= return_value, doc=<span class=" -Color -Color-Yellow">&#39;a &lt;= b &lt;= return_value&#39;</span>)
@verbose_postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: a &lt;= return_value, doc=<span class=" -Color -Color-Yellow">&#39;a &lt;= return_value&#39;</span>)
@verbose_postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: a == return_value - b, doc=<span class=" -Color -Color-Yellow">&#39;a == return_value - b&#39;</span>)
@verbose_postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: a == return_value / b, doc=<span class=" -Color -Color-Yellow">&#39;a == return_value / b&#39;</span>)
@verbose_postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: b &lt; return_value, doc=<span class=" -Color -Color-Yellow">&#39;b &lt; return_value&#39;</span>)
@verbose_postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: b &lt;= a &lt;= return_value, doc=<span class=" -Color -Color-Yellow">&#39;b &lt;= a &lt;= return_value&#39;</span>)
@verbose_postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: b &lt;= return_value, doc=<span class=" -Color -Color-Yellow">&#39;b &lt;= return_value&#39;</span>)
@verbose_postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: b == return_value - a, doc=<span class=" -Color -Color-Yellow">&#39;b == return_value - a&#39;</span>)
@verbose_postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: b == return_value / a, doc=<span class=" -Color -Color-Yellow">&#39;b == return_value / a&#39;</span>)
@verbose_postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: <span class=" -Color -Color-Cyan">isinstance</span>(return_value, <span class=" -Color -Color-Cyan">int</span>), doc=<span class=" -Color -Color-Yellow">&#39;isinstance(return_value, int)&#39;</span>)
@verbose_postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value, doc=<span class=" -Color -Color-Yellow">&#39;return_value&#39;</span>)
@verbose_postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value == a * b, doc=<span class=" -Color -Color-Yellow">&#39;return_value == a * b&#39;</span>)
@verbose_postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value == a + b, doc=<span class=" -Color -Color-Yellow">&#39;return_value == a + b&#39;</span>)
@verbose_postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value == b * a, doc=<span class=" -Color -Color-Yellow">&#39;return_value == b * a&#39;</span>)
@verbose_postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value == b + a, doc=<span class=" -Color -Color-Yellow">&#39;return_value == b + a&#39;</span>)
@verbose_postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value &gt; <span class=" -Color -Color-Blue">0</span>, doc=<span class=" -Color -Color-Yellow">&#39;return_value &gt; 0&#39;</span>)
@verbose_postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value &gt; a, doc=<span class=" -Color -Color-Yellow">&#39;return_value &gt; a&#39;</span>)
@verbose_postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value &gt; b, doc=<span class=" -Color -Color-Yellow">&#39;return_value &gt; b&#39;</span>)
@verbose_postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value &gt;= <span class=" -Color -Color-Blue">0</span>, doc=<span class=" -Color -Color-Yellow">&#39;return_value &gt;= 0&#39;</span>)
@verbose_postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value &gt;= a, doc=<span class=" -Color -Color-Yellow">&#39;return_value &gt;= a&#39;</span>)
@verbose_postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value &gt;= a &gt;= b, doc=<span class=" -Color -Color-Yellow">&#39;return_value &gt;= a &gt;= b&#39;</span>)
@verbose_postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value &gt;= b, doc=<span class=" -Color -Color-Yellow">&#39;return_value &gt;= b&#39;</span>)
@verbose_postcondition(<span class=" -Color -Color-Blue">lambda</span> return_value, a, b: return_value &gt;= b &gt;= a, doc=<span class=" -Color -Color-Yellow">&#39;return_value &gt;= b &gt;= a&#39;</span>)
<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">sum2</span>(a, b):  <span class=" -Color -Color-White"># type: ignore</span>
    <span class=" -Color -Color-Blue">return</span> a + b
</pre></div>
</div>
</div>
</div>
<p>As an alternative, one may be able to use <code class="docutils literal notranslate"><span class="pre">inspect.getsource()</span></code> on the lambda expression or unparse it.  This is left to the reader.</p>
</section>
<section id="exercise-4-save-initial-values">
<h3>Exercise 4: Save Initial Values<a class="headerlink" href="#exercise-4-save-initial-values" title="Link to this heading">#</a></h3>
<p>If the value of an argument changes during function execution, this can easily confuse our implementation: The values are tracked at the beginning of the function, but checked only when it returns.  Extend the <code class="docutils literal notranslate"><span class="pre">InvariantAnnotator</span></code> and the infrastructure it uses such that</p>
<ul class="simple">
<li><p>it saves argument values both at the beginning and at the end of a function invocation;</p></li>
<li><p>postconditions can be expressed over both <em>initial</em> values of arguments and the <em>final</em> values of arguments;</p></li>
<li><p>the mined postconditions refer to both these values as well.</p></li>
</ul>
<p><strong>Solution.</strong> To be added.</p>
</section>
<section id="exercise-5-implications">
<h3>Exercise 5: Implications<a class="headerlink" href="#exercise-5-implications" title="Link to this heading">#</a></h3>
<p>Several mined invariant are actually <em>implied</em> by others: If <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">&gt;</span> <span class="pre">0</span></code> holds, then this implies <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">&gt;=</span> <span class="pre">0</span></code> and <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">!=</span> <span class="pre">0</span></code>.  Extend the <code class="docutils literal notranslate"><span class="pre">InvariantAnnotator</span></code> such that implications between properties are explicitly encoded, and such that implied properties are no longer listed as invariants.  See \cite{Ernst2001} for ideas.</p>
<p><strong>Solution.</strong> Left to the reader.</p>
</section>
<section id="exercise-6-local-variables">
<h3>Exercise 6: Local Variables<a class="headerlink" href="#exercise-6-local-variables" title="Link to this heading">#</a></h3>
<p>Postconditions may also refer to the values of local variables.  Consider extending <code class="docutils literal notranslate"><span class="pre">InvariantAnnotator</span></code> and its infrastructure such that the values of local variables at the end of the execution are also recorded and made part of the invariant inference mechanism.</p>
<p><strong>Solution.</strong> Left to the reader.</p>
</section>
<section id="exercise-7-embedding-invariants-as-assertions">
<h3>Exercise 7: Embedding Invariants as Assertions<a class="headerlink" href="#exercise-7-embedding-invariants-as-assertions" title="Link to this heading">#</a></h3>
<p>Rather than producing invariants as annotations for pre- and postconditions, insert them as <code class="docutils literal notranslate"><span class="pre">assert</span></code> statements into the function code, as in:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">square_root</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="s1">&#39;Computes the square root of x, using the Newton-Raphson method&#39;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="s1">&#39;violated precondition&#39;</span>
    <span class="k">assert</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;violated precondition&#39;</span>
    <span class="n">approx</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">guess</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">approx</span> <span class="o">!=</span> <span class="n">guess</span><span class="p">):</span>
        <span class="n">approx</span> <span class="o">=</span> <span class="n">guess</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="p">((</span><span class="n">approx</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">approx</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">return_value</span> <span class="o">=</span> <span class="n">approx</span>
    <span class="k">assert</span> <span class="n">return_value</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">,</span> <span class="s1">&#39;violated postcondition&#39;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="s1">&#39;violated postcondition&#39;</span>
    <span class="k">return</span> <span class="n">approx</span>
</pre></div>
</div>
<p>Such a formulation may make it easier for test generators and symbolic analysis to access and interpret pre- and postconditions.</p>
<p><strong>Solution.</strong> Here is a tentative implementation that inserts invariants into function ASTs.</p>
<p>Part 1: Embedding Invariants into Functions</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">EmbeddedInvariantAnnotator</span><span class="p">(</span><span class="n">InvariantTracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">function_with_invariants_ast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">annotate_function_with_invariants</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">invariants</span><span class="p">(</span><span class="n">function_name</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">function_with_invariants</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_with_invariants_ast</span><span class="p">(</span><span class="n">function_name</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">annotate_invariants</span><span class="p">(</span><span class="n">invariants</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Invariants</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">]:</span>
    <span class="n">annotated_functions</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">function_name</span> <span class="ow">in</span> <span class="n">invariants</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">annotated_functions</span><span class="p">[</span><span class="n">function_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">annotate_function_with_invariants</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">invariants</span><span class="p">[</span><span class="n">function_name</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">continue</span>

    <span class="k">return</span> <span class="n">annotated_functions</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">annotate_function_with_invariants</span><span class="p">(</span><span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                                      <span class="n">function_invariants</span><span class="p">:</span> <span class="n">Invariants</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
    <span class="n">stack_inspector</span> <span class="o">=</span> <span class="n">StackInspector</span><span class="p">()</span>
    <span class="n">function</span> <span class="o">=</span> <span class="n">stack_inspector</span><span class="o">.</span><span class="n">search_func</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span>

    <span class="n">function_code</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
    <span class="n">function_ast</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">function_code</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">annotate_function_ast_with_invariants</span><span class="p">(</span><span class="n">function_ast</span><span class="p">,</span> <span class="n">function_invariants</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">annotate_function_ast_with_invariants</span><span class="p">(</span><span class="n">function_ast</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span>
                                          <span class="n">function_invariants</span><span class="p">:</span> <span class="n">Invariants</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
    <span class="n">annotated_function_ast</span> <span class="o">=</span> <span class="n">EmbeddedInvariantTransformer</span><span class="p">(</span><span class="n">function_invariants</span><span class="p">)</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">function_ast</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">annotated_function_ast</span>
</pre></div>
</div>
</div>
</div>
<p>Part 2: Preconditions</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">PreconditionTransformer</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeTransformer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invariants</span><span class="p">:</span> <span class="n">Invariants</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">invariants</span> <span class="o">=</span> <span class="n">invariants</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">preconditions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">stmt</span><span class="p">]:</span>
        <span class="n">preconditions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">var_names</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">invariants</span><span class="p">:</span>
            <span class="n">assertion</span> <span class="o">=</span> <span class="s2">&quot;assert &quot;</span> <span class="o">+</span> <span class="n">instantiate_prop</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">var_names</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &quot;violated precondition&quot;&#39;</span>
            <span class="n">assertion_ast</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">assertion</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">assertion</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">RETURN_VALUE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">preconditions</span> <span class="o">+=</span> <span class="n">assertion_ast</span><span class="o">.</span><span class="n">body</span>

        <span class="k">return</span> <span class="n">preconditions</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">insert_assertions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">stmt</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">stmt</span><span class="p">]:</span>
        <span class="n">preconditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preconditions</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">docstring</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">,</span> <span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">s</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">docstring</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">docstring</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">preconditions</span> <span class="o">+</span> <span class="n">body</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">preconditions</span> <span class="o">+</span> <span class="n">body</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visit_FunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add invariants to function&quot;&quot;&quot;</span>
        <span class="c1"># print(ast.dump(node))</span>
        <span class="n">node</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_assertions</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">EmbeddedInvariantTransformer</span><span class="p">(</span><span class="n">PreconditionTransformer</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">EmbeddedInvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">square_root</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">function_with_invariants</span><span class="p">(</span><span class="s1">&#39;square_root&#39;</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">square_root</span>(x):
<span class=" -Color -Color-White">    </span><span class=" -Color -Color-Yellow">&quot;&quot;&quot;Computes the square root of x, using the Newton-Raphson method&quot;&quot;&quot;</span>
    <span class=" -Color -Color-Blue">assert</span> <span class=" -Color -Color-Cyan">isinstance</span>(x, <span class=" -Color -Color-Cyan">int</span>), <span class=" -Color -Color-Yellow">&#39;violated precondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> x &gt;= <span class=" -Color -Color-Blue">0</span>, <span class=" -Color -Color-Yellow">&#39;violated precondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> x &gt; <span class=" -Color -Color-Blue">0</span>, <span class=" -Color -Color-Yellow">&#39;violated precondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> x, <span class=" -Color -Color-Yellow">&#39;violated precondition&#39;</span>
    approx = <span class=" -Color -Color-Blue">None</span>
    guess = x / <span class=" -Color -Color-Blue">2</span>
    <span class=" -Color -Color-Blue">while</span> approx != guess:
        approx = guess
        guess = (approx + x / approx) / <span class=" -Color -Color-Blue">2</span>
    <span class=" -Color -Color-Blue">return</span> approx
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_52062/1454548230.py:20: DeprecationWarning: Attribute s is deprecated and will be removed in Python 3.14; use value instead
  docstring = cast(ast.Constant, body[0]).value.s
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">EmbeddedInvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">function_with_invariants</span><span class="p">(</span><span class="s1">&#39;sum3&#39;</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">sum3</span>(a, b, c):
    <span class=" -Color -Color-Blue">assert</span> <span class=" -Color -Color-Cyan">isinstance</span>(b, <span class=" -Color -Color-Cyan">int</span>), <span class=" -Color -Color-Yellow">&#39;violated precondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> <span class=" -Color -Color-Cyan">isinstance</span>(c, <span class=" -Color -Color-Cyan">int</span>), <span class=" -Color -Color-Yellow">&#39;violated precondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> <span class=" -Color -Color-Cyan">isinstance</span>(a, <span class=" -Color -Color-Cyan">int</span>), <span class=" -Color -Color-Yellow">&#39;violated precondition&#39;</span>
    <span class=" -Color -Color-Blue">return</span> a + b + c
</pre></div>
</div>
</div>
</div>
<p>Part 3: Postconditions</p>
<p>We make a few simplifying assumptions:</p>
<ul class="simple">
<li><p>Variables do not change during execution.</p></li>
<li><p>There is a single <code class="docutils literal notranslate"><span class="pre">return</span></code> statement at the end of the function.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">EmbeddedInvariantTransformer</span><span class="p">(</span><span class="n">EmbeddedInvariantTransformer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">postconditions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">stmt</span><span class="p">]:</span>
        <span class="n">postconditions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">var_names</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">invariants</span><span class="p">:</span>
            <span class="n">assertion</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;assert &quot;</span> <span class="o">+</span> <span class="n">instantiate_prop</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">var_names</span><span class="p">)</span> <span class="o">+</span>
                         <span class="s1">&#39;, &quot;violated postcondition&quot;&#39;</span><span class="p">)</span>
            <span class="n">assertion_ast</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">assertion</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">assertion</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">RETURN_VALUE</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">postconditions</span> <span class="o">+=</span> <span class="n">assertion_ast</span><span class="o">.</span><span class="n">body</span>

        <span class="k">return</span> <span class="n">postconditions</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">insert_assertions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">stmt</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">stmt</span><span class="p">]:</span>
        <span class="n">new_body</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">insert_assertions</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="n">postconditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">postconditions</span><span class="p">()</span>

        <span class="n">body_ends_with_return</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_body</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ast</span><span class="o">.</span><span class="n">Return</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">body_ends_with_return</span><span class="p">:</span>
            <span class="n">ret_val</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Return</span><span class="p">,</span> <span class="n">new_body</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">value</span>
            <span class="n">saver</span> <span class="o">=</span> <span class="n">RETURN_VALUE</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">ret_val</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">saver</span> <span class="o">=</span> <span class="n">RETURN_VALUE</span> <span class="o">+</span> <span class="s2">&quot; = None&quot;</span>

        <span class="n">saver_ast</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">stmt</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">saver</span><span class="p">))</span>
        <span class="n">postconditions</span> <span class="o">=</span> <span class="p">[</span><span class="n">saver_ast</span><span class="p">]</span> <span class="o">+</span> <span class="n">postconditions</span>

        <span class="k">if</span> <span class="n">body_ends_with_return</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">new_body</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">postconditions</span> <span class="o">+</span> <span class="p">[</span><span class="n">new_body</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">new_body</span> <span class="o">+</span> <span class="n">postconditions</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">EmbeddedInvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">square_root</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">square_root_def</span> <span class="o">=</span> <span class="n">annotator</span><span class="o">.</span><span class="n">function_with_invariants</span><span class="p">(</span><span class="s1">&#39;square_root&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_52062/1454548230.py:20: DeprecationWarning: Attribute s is deprecated and will be removed in Python 3.14; use value instead
  docstring = cast(ast.Constant, body[0]).value.s
</pre></div>
</div>
</div>
</div>
<p>Heres the full definition with included assertions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">square_root_def</span><span class="p">,</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">square_root</span>(x):
<span class=" -Color -Color-White">    </span><span class=" -Color -Color-Yellow">&quot;&quot;&quot;Computes the square root of x, using the Newton-Raphson method&quot;&quot;&quot;</span>
    <span class=" -Color -Color-Blue">assert</span> <span class=" -Color -Color-Cyan">isinstance</span>(x, <span class=" -Color -Color-Cyan">int</span>), <span class=" -Color -Color-Yellow">&#39;violated precondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> x &gt;= <span class=" -Color -Color-Blue">0</span>, <span class=" -Color -Color-Yellow">&#39;violated precondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> x &gt; <span class=" -Color -Color-Blue">0</span>, <span class=" -Color -Color-Yellow">&#39;violated precondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> x, <span class=" -Color -Color-Yellow">&#39;violated precondition&#39;</span>
    approx = <span class=" -Color -Color-Blue">None</span>
    guess = x / <span class=" -Color -Color-Blue">2</span>
    <span class=" -Color -Color-Blue">while</span> approx != guess:
        approx = guess
        guess = (approx + x / approx) / <span class=" -Color -Color-Blue">2</span>
    return_value = approx
    <span class=" -Color -Color-Blue">assert</span> return_value &lt; x, <span class=" -Color -Color-Yellow">&#39;violated postcondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> <span class=" -Color -Color-Cyan">isinstance</span>(return_value, <span class=" -Color -Color-Cyan">float</span>), <span class=" -Color -Color-Yellow">&#39;violated postcondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> return_value, <span class=" -Color -Color-Yellow">&#39;violated postcondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> x &gt; return_value, <span class=" -Color -Color-Yellow">&#39;violated postcondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> return_value &lt;= x, <span class=" -Color -Color-Yellow">&#39;violated postcondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> return_value &gt;= <span class=" -Color -Color-Blue">0</span>, <span class=" -Color -Color-Yellow">&#39;violated postcondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> return_value &gt; <span class=" -Color -Color-Blue">0</span>, <span class=" -Color -Color-Yellow">&#39;violated postcondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> x &gt;= return_value, <span class=" -Color -Color-Yellow">&#39;violated postcondition&#39;</span>
    <span class=" -Color -Color-Blue">return</span> approx
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exec</span><span class="p">(</span><span class="n">square_root_def</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;square_root&#39;</span><span class="p">,</span> <span class="s1">&#39;square_root_annotated&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">square_root_annotated</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_52062/1293367810.py&quot;, line 2, in &lt;module&gt;
    square_root_annotated(-1)
    ~~~~~~~~~~~~~~~~~~~~~^^^^
  File &quot;&lt;string&gt;&quot;, line 4, in square_root_annotated
AssertionError: violated precondition (expected)
</pre></div>
</div>
</div>
</div>
<p>Here come some more examples:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">EmbeddedInvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sum3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">function_with_invariants</span><span class="p">(</span><span class="s1">&#39;sum3&#39;</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">sum3</span>(a, b, c):
    <span class=" -Color -Color-Blue">assert</span> <span class=" -Color -Color-Cyan">isinstance</span>(b, <span class=" -Color -Color-Cyan">int</span>), <span class=" -Color -Color-Yellow">&#39;violated precondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> <span class=" -Color -Color-Cyan">isinstance</span>(c, <span class=" -Color -Color-Cyan">int</span>), <span class=" -Color -Color-Yellow">&#39;violated precondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> <span class=" -Color -Color-Cyan">isinstance</span>(a, <span class=" -Color -Color-Cyan">int</span>), <span class=" -Color -Color-Yellow">&#39;violated precondition&#39;</span>
    return_value = a + b + c
    <span class=" -Color -Color-Blue">assert</span> <span class=" -Color -Color-Cyan">isinstance</span>(return_value, <span class=" -Color -Color-Cyan">int</span>), <span class=" -Color -Color-Yellow">&#39;violated postcondition&#39;</span>
    <span class=" -Color -Color-Blue">return</span> a + b + c
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">EmbeddedInvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">list_length</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

<span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">function_with_invariants</span><span class="p">(</span><span class="s1">&#39;list_length&#39;</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">list_length</span>(elems: List[Any]) -&gt; <span class=" -Color -Color-Cyan">int</span>:
    <span class=" -Color -Color-Blue">assert</span> <span class=" -Color -Color-Cyan">isinstance</span>(elems, <span class=" -Color -Color-Cyan">list</span>), <span class=" -Color -Color-Yellow">&#39;violated precondition&#39;</span>
    <span class=" -Color -Color-Blue">if</span> elems == []:
        length = <span class=" -Color -Color-Blue">0</span>
    <span class=" -Color -Color-Blue">else</span>:
        length = <span class=" -Color -Color-Blue">1</span> + list_length(elems[<span class=" -Color -Color-Blue">1</span>:])
    return_value = length
    <span class=" -Color -Color-Blue">assert</span> return_value &gt;= <span class=" -Color -Color-Blue">0</span>, <span class=" -Color -Color-Yellow">&#39;violated postcondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> return_value == <span class=" -Color -Color-Cyan">len</span>(elems), <span class=" -Color -Color-Yellow">&#39;violated postcondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> <span class=" -Color -Color-Cyan">isinstance</span>(return_value, <span class=" -Color -Color-Cyan">int</span>), <span class=" -Color -Color-Yellow">&#39;violated postcondition&#39;</span>
    <span class=" -Color -Color-Blue">return</span> length
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">EmbeddedInvariantAnnotator</span><span class="p">()</span> <span class="k">as</span> <span class="n">annotator</span><span class="p">:</span>
    <span class="n">print_sum</span><span class="p">(</span><span class="mi">31</span><span class="p">,</span> <span class="mi">45</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>76
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">annotator</span><span class="o">.</span><span class="n">function_with_invariants</span><span class="p">(</span><span class="s1">&#39;print_sum&#39;</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">print_sum</span>(a, b):
    <span class=" -Color -Color-Blue">assert</span> a &gt; <span class=" -Color -Color-Blue">0</span>, <span class=" -Color -Color-Yellow">&#39;violated precondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> b &gt;= <span class=" -Color -Color-Blue">0</span>, <span class=" -Color -Color-Yellow">&#39;violated precondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> b &gt;= a, <span class=" -Color -Color-Yellow">&#39;violated precondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> <span class=" -Color -Color-Cyan">isinstance</span>(b, <span class=" -Color -Color-Cyan">int</span>), <span class=" -Color -Color-Yellow">&#39;violated precondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> b &gt; <span class=" -Color -Color-Blue">0</span>, <span class=" -Color -Color-Yellow">&#39;violated precondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> a, <span class=" -Color -Color-Yellow">&#39;violated precondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> a &gt;= <span class=" -Color -Color-Blue">0</span>, <span class=" -Color -Color-Yellow">&#39;violated precondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> a &lt; b, <span class=" -Color -Color-Yellow">&#39;violated precondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> <span class=" -Color -Color-Cyan">isinstance</span>(a, <span class=" -Color -Color-Cyan">int</span>), <span class=" -Color -Color-Yellow">&#39;violated precondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> a &lt;= b, <span class=" -Color -Color-Yellow">&#39;violated precondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> b &gt; a, <span class=" -Color -Color-Yellow">&#39;violated precondition&#39;</span>
    <span class=" -Color -Color-Blue">assert</span> b, <span class=" -Color -Color-Yellow">&#39;violated precondition&#39;</span>
    <span class=" -Color -Color-Cyan">print</span>(a + b)
    return_value = <span class=" -Color -Color-Blue">None</span>
    <span class=" -Color -Color-Blue">assert</span> <span class=" -Color -Color-Magenta">not</span> return_value, <span class=" -Color -Color-Yellow">&#39;violated postcondition&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>And were done!</p>
</section>
<section id="exercise-8-grammar-generated-properties">
<h3>Exercise 8: Grammar-Generated Properties<a class="headerlink" href="#exercise-8-grammar-generated-properties" title="Link to this heading">#</a></h3>
<p>The larger the set of properties to be checked, the more potential invariants can be discovered.  Create a <em>grammar</em> that systematically produces a large set of properties.  See \cite{Ernst2001} for possible patterns.</p>
</section>
<section id="exercise-9-loop-invariants">
<h3>Exercise 9: Loop Invariants<a class="headerlink" href="#exercise-9-loop-invariants" title="Link to this heading">#</a></h3>
<p>This is not so much a problem in debugging, but rather for <em>symbolic verification</em>. A <em>loop invariant</em> is a property that holds for every iteration of a loop, such as</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">tag</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">quote</span>
</pre></div>
</div>
<p>for <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code>. Create an annotator that determines and adds loop invariants for <code class="docutils literal notranslate"><span class="pre">for</span></code> and <code class="docutils literal notranslate"><span class="pre">while</span></code> loops.</p>
</section>
<section id="exercise-10-path-invariants">
<h3>Exercise 10: Path Invariants<a class="headerlink" href="#exercise-10-path-invariants" title="Link to this heading">#</a></h3>
<p>A <em>path invariant</em> is a property that holds for taking a particular path, such as</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">z</span>
</pre></div>
</div>
<p>for the second (erroneous) <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">y</span></code> statement of the <code class="docutils literal notranslate"><span class="pre">middle()</span></code> function. Create an annotator that adds path invariants (expressed over the preconditions that hold when taking this particular branch) for every <code class="docutils literal notranslate"><span class="pre">if</span></code> statement in the code.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="StatisticalDebugger.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Statistical Debugging</p>
      </div>
    </a>
    <a class="right-next"
       href="DDSetDebugger.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Generalizing Failure Circumstances</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#specifications-and-assertions">Specifications and Assertions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#beyond-generic-failures">Beyond Generic Failures</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mining-data-types">Mining Data Types</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-runtime-type-checking">Excursion: Runtime Type Checking</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#end-of-excursion">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#static-type-checking">Static Type Checking</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mining-type-specifications">Mining Type Specifications</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tracing-calls">Tracing Calls</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#getting-types">Getting Types</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#annotating-functions-with-types">Annotating Functions with Types</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-accessing-function-structure">Excursion: Accessing Function Structure</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">End of Excursion</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-annotating-functions-with-given-types">Excursion: Annotating Functions with Given Types</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">End of Excursion</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-annotating-functions-with-mined-types">Excursion: Annotating Functions with Mined Types</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">End of Excursion</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-a-type-annotator-class">Excursion: A Type Annotator Class</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">End of Excursion</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-handling-multiple-types">Excursion: Handling Multiple Types</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">End of Excursion</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mining-invariants">Mining Invariants</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#annotating-functions-with-pre-and-postconditions">Annotating Functions with Pre- and Postconditions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Mining Invariants</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-properties">Defining Properties</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-meta-variables">Extracting Meta-Variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#instantiating-properties">Instantiating Properties</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluating-properties">Evaluating Properties</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-invariants">Checking Invariants</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-invariants">Extracting Invariants</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#converting-mined-invariants-to-annotations">Converting Mined Invariants to Annotations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#avoiding-overspecialization">Avoiding Overspecialization</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#partial-invariants">Partial Invariants</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#some-examples">Some Examples</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#removing-html-markup">Removing HTML Markup</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-recursive-function">A Recursive Function</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sum-of-two-numbers">Sum of two Numbers</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-specifications">Checking Specifications</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-union-types">Exercise 1: Union Types</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-types-for-local-variables">Exercise 2: Types for Local Variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3-verbose-invariant-checkers">Exercise 3: Verbose Invariant Checkers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-4-save-initial-values">Exercise 4: Save Initial Values</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-5-implications">Exercise 5: Implications</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-6-local-variables">Exercise 6: Local Variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-7-embedding-invariants-as-assertions">Exercise 7: Embedding Invariants as Assertions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-8-grammar-generated-properties">Exercise 8: Grammar-Generated Properties</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-9-loop-invariants">Exercise 9: Loop Invariants</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-10-path-invariants">Exercise 10: Path Invariants</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Andreas Zeller
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <div>
  Copyright &copy; 20212025 <a href="https://www.cispa.de/">CISPA Helmholtz Center for Information Security</a>.
  The <strong>content</strong> of this project is licensed under the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
  The <strong>source code</strong> that is part of the content, as well as the source code used to format and display that content is licensed under the <a href="https://github.com/uds-se/debuggingbook/blob/master/LICENSE.md#mit-license">MIT License</a>. <a href="https://cispa.de/en/impressum">Imprint</a>.
  <br>
  <a href="https://cispa.de/en/impressum">Imprint</a> &middot; <a href="/html/index.html#how-do-i-cite-your-work">Cite</a>
</div>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>