
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Tracing Executions &#8212; The Debugging Book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=d5c2cecb" />
    <link rel="stylesheet" type="text/css" href="_static/mastodon-timeline.css?v=f82c2b23" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Tracer';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="How Debuggers Work" href="Debugger.html" />
    <link rel="prev" title="Introduction to Debugging" href="Intro_Debugging.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content"><p>This is a beta version of debuggingbook.org, currently in development. See the <a href="https://debuggingbook.org/classic/"  style="color:white!important;">classic site</a> for the 2024 version.</p></div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/debuggingbook.png" class="logo__image only-light" alt="The Debugging Book - Home"/>
    <script>document.write(`<img src="_static/debuggingbook.png" class="logo__image only-dark" alt="The Debugging Book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    The Debugging Book
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tours.html">Sitemap</a></li>
<li class="toctree-l1"><a class="reference internal" href="Intro_Debugging.html">Introduction to Debugging</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Observing Executions</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Tracing Executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="Debugger.html">How Debuggers Work</a></li>
<li class="toctree-l1"><a class="reference internal" href="Assertions.html">Asserting Expectations</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Flows and Dependencies</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Slicer.html">Tracking Failure Origins</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Reducing Failure Causes</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="DeltaDebugger.html">Reducing Failure-Inducing Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ChangeDebugger.html">Isolating Failure-Inducing Changes</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Abstracting Failures</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="StatisticalDebugger.html">Statistical Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="DynamicInvariants.html">Mining Function Specifications</a></li>
<li class="toctree-l1"><a class="reference internal" href="DDSetDebugger.html">Generalizing Failure Circumstances</a></li>
<li class="toctree-l1"><a class="reference internal" href="Alhazen.html">Learning from Failures</a></li>
<li class="toctree-l1"><a class="reference internal" href="PerformanceDebugger.html">Debugging Performance Issues</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Automatic Repair</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Repairer.html">Repairing Code Automatically</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Debugging in the Large</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tracking.html">Tracking Bugs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ChangeCounter.html">Where the Bugs are</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ExpectError.html">Error Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timer.html">Timer</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timeout.html">Timeout</a></li>
<li class="toctree-l1"><a class="reference internal" href="ClassDiagram.html">Class Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="StackInspector.html">Inspecting Call Stacks</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">About This Book</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ReleaseNotes.html">Release Notes for The Debugging Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="Importing.html">Downloads and Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Guide_for_Authors.html">Guide for Authors</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/uds-se/debuggingbook/master?urlpath=tree/docs/notebooks/Tracer.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/uds-se/debuggingbook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/uds-se/debuggingbook/issues/new?title=Issue%20on%20page%20%2FTracer.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
    <li><a href="../code/Tracer.py" target="_blank"
       class="btn btn-sm btn-download-source-button dropdown-item"
       title="Download Python code"
       data-bs-placement="left" data-bs-toggle="tooltip"
    >
  

    <span class="btn__icon-container">
      <i class="fas fa-file"></i>
      </span>
    <span class="btn__text-container">.py</span>
    </a>
    </li>
    
      
      
      
      <li><a href="_sources/Tracer.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download notebook"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  
    <li><a href="Importing.html" target="_blank"
       class="btn btn-sm btn-download-source-button dropdown-item"
       title="All downloads"
       data-bs-placement="left" data-bs-toggle="tooltip"
    >
  

    <span class="btn__icon-container">
      <i class="fas fa-file"></i>
      </span>
    <span class="btn__text-container">All downloads</span>
    </a>
    </li>
    </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Tracing Executions</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tracing-python-programs">Tracing Python Programs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-tracer-class">A Tracer Class</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#accessing-source-code">Accessing Source Code</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tracing-calls-and-returns">Tracing Calls and Returns</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tracing-variable-changes">Tracing Variable Changes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conditional-tracing">Conditional Tracing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#watching-events">Watching Events</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#efficient-tracing">Efficient Tracing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tracing-binary-executables">Tracing Binary Executables</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#low-level-debugging-interfaces">Low-Level Debugging Interfaces</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#high-level-debugging-interfaces">High-Level Debugging Interfaces</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-exception-handling">Exercise 1: Exception Handling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-syntax-based-instrumentation">Exercise 2: Syntax-Based Instrumentation</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="tracing-executions">
<h1>Tracing Executions<a class="headerlink" href="#tracing-executions" title="Link to this heading">#</a></h1>
<p>In this chapter, we show how to <em>observe program state during an execution</em> – a prerequisite for logging and interactive debugging. Thanks to the power of Python, we can do this in a few lines of code.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">YouTubeVideo</span>
<span class="n">YouTubeVideo</span><span class="p">(</span><span class="s2">&quot;UYAvCl-5NGY&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <iframe
            width="640"
            height="360"
            src="https://www.youtube-nocookie.com/embed/UYAvCl-5NGY"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
<p><strong>Prerequisites</strong></p>
<ul class="simple">
<li><p>You should have read the <a class="reference internal" href="Intro_Debugging.html"><span class="std std-doc">Introduction to Debugging</span></a>.</p></li>
<li><p>Knowing a bit of <em>Python</em> is helpful for understanding the code examples in the book.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">bookutils.setup</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">quiz</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">Intro_Debugging</span>
</pre></div>
</div>
</div>
</div>
<section id="synopsis">
<h2>Synopsis<a class="headerlink" href="#synopsis" title="Link to this heading">#</a></h2>
<p>To <a class="reference internal" href="Importing.html"><span class="std std-doc">use the code provided in this chapter</span></a>, write</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">debuggingbook.Tracer</span><span class="w"> </span><span class="kn">import</span> <span class="o">&lt;</span><span class="n">identifier</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>and then make use of the following features.</p>
<p><strong>Note</strong>: The examples in this section only work after the rest of the cells have been executed.</p>
<p>This chapter provides a <code class="docutils literal notranslate"><span class="pre">Tracer</span></code> class that allows logging events during program execution. The advanced subclass <code class="docutils literal notranslate"><span class="pre">EventTracer</span></code> allows restricting logs to specific conditions. Logs are shown only while the given <code class="docutils literal notranslate"><span class="pre">condition</span></code> holds:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">EventTracer</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="s1">&#39;line == 223 or len(out) &gt;= 6&#39;</span><span class="p">):</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&lt;b&gt;foo&lt;/b&gt;bar&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # s = &#39;&lt;b&gt;foo&lt;/b&gt;bar&#39;, tag = False, quote = False, out = &#39;foobar&#39;, c = &#39;r&#39;, function = &#39;remove_html_markup&#39;, line = 243
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # line = 255
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>255     return out
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>remove_html_markup() returns &#39;foobar&#39;
</pre></div>
</div>
</div>
</div>
<p>It also allows restricting logs to specific events. Log entries are shown only if one of the given <code class="docutils literal notranslate"><span class="pre">events</span></code> changes its value:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">EventTracer</span><span class="p">(</span><span class="n">events</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;c == &#39;/&#39;&quot;</span><span class="p">]):</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&lt;b&gt;foo&lt;/b&gt;bar&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Calling remove_html_markup(s = &#39;&lt;b&gt;foo&lt;/b&gt;bar&#39;, function = &#39;remove_html_markup&#39;, line = 238)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # tag = False, quote = False, out = &#39;&#39;, c = &#39;&lt;&#39;, line = 244
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # tag = True, out = &#39;foo&#39;, c = &#39;/&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # c = &#39;b&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Tracer</span></code> and <code class="docutils literal notranslate"><span class="pre">EventTracer</span></code> classes allow for subclassing and further customization.</p>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 14.0.2 (20251019.1705)
 -->
<!-- Pages: 1 -->
<svg width="285pt" height="457pt"
 viewBox="0.00 0.00 285.00 457.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 453)">
<g id="a_graph0"><a xlink:title="EventTracer class hierarchy">
<polygon fill="white" stroke="none" points="-4,4 -4,-453 280.62,-453 280.62,4 -4,4"/>
</a>
</g>
<!-- EventTracer -->
<g id="node1" class="node">
<title>EventTracer</title>
<g id="a_node1"><a xlink:href="#" xlink:title="class EventTracer:&#10;Log when a given event expression changes its value">
<polygon fill="none" stroke="black" points="27,-0.5 27,-72 139,-72 139,-0.5 27,-0.5"/>
<text xml:space="preserve" text-anchor="start" x="43.25" y="-55.7" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">EventTracer</text>
<polyline fill="none" stroke="black" points="27,-46.75 139,-46.75"/>
<g id="a_node1_0"><a xlink:href="#" xlink:title="EventTracer">
<g id="a_node1_1"><a xlink:href="#" xlink:title="__init__(self, *, condition: Optional[str] = None, events: List[str] = [], file: &lt;class &#39;TextIO&#39;&gt; = &lt;ipykernel.iostream.OutStream object at 0x108396530&gt;) &#45;&gt; None:&#10;Constructor. `events` is a list of expressions to watch.">
<text xml:space="preserve" text-anchor="start" x="35" y="-34.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node1_2"><a xlink:href="#" xlink:title="do_report(self, frame: frame, event: str, arg: Any) &#45;&gt; bool:&#10;Return True if a line should be shown">
<text xml:space="preserve" text-anchor="start" x="35" y="-21.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">do_report()</text>
</a>
</g>
<g id="a_node1_3"><a xlink:href="#" xlink:title="events_changed(self, events: List[str], frame: frame) &#45;&gt; bool:&#10;Return True if any of the observed `events` has changed">
<text xml:space="preserve" text-anchor="start" x="35" y="-7.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">events_changed()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- ConditionalTracer -->
<g id="node2" class="node">
<title>ConditionalTracer</title>
<g id="a_node2"><a xlink:href="#" xlink:title="class ConditionalTracer:&#10;A class for tracing a piece of code. Use as `with Tracer(): block()`">
<polygon fill="none" stroke="black" points="15.38,-109 15.38,-193.25 150.62,-193.25 150.62,-109 15.38,-109"/>
<text xml:space="preserve" text-anchor="start" x="23.38" y="-176.95" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">ConditionalTracer</text>
<polyline fill="none" stroke="black" points="15.38,-168 150.62,-168"/>
<g id="a_node2_4"><a xlink:href="#" xlink:title="ConditionalTracer">
<g id="a_node2_5"><a xlink:href="#" xlink:title="__init__(self, *, condition: Optional[str] = None, file: &lt;class &#39;TextIO&#39;&gt; = &lt;ipykernel.iostream.OutStream object at 0x108396530&gt;) &#45;&gt; None:&#10;Constructor. Trace all events for which `condition` (a Python expr) holds.">
<text xml:space="preserve" text-anchor="start" x="32" y="-155.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node2_6"><a xlink:href="#" xlink:title="do_report(self, frame: frame, event: str, arg: Any) &#45;&gt; Optional[bool]">
<text xml:space="preserve" text-anchor="start" x="32" y="-142.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">do_report()</text>
</a>
</g>
<g id="a_node2_7"><a xlink:href="#" xlink:title="eval_in_context(self, expr: str, frame: frame) &#45;&gt; Any">
<text xml:space="preserve" text-anchor="start" x="32" y="-129" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">eval_in_context()</text>
</a>
</g>
<g id="a_node2_8"><a xlink:href="#" xlink:title="traceit(self, frame: frame, event: str, arg: Any) &#45;&gt; None:&#10;Tracing function; called at every line. To be overloaded in subclasses.">
<text xml:space="preserve" text-anchor="start" x="32" y="-117.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">traceit()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- EventTracer&#45;&gt;ConditionalTracer -->
<g id="edge1" class="edge">
<title>EventTracer&#45;&gt;ConditionalTracer</title>
<path fill="none" stroke="black" d="M83,-72.35C83,-80.27 83,-88.84 83,-97.31"/>
<polygon fill="none" stroke="black" points="79.5,-97.2 83,-107.2 86.5,-97.2 79.5,-97.2"/>
</g>
<!-- Tracer -->
<g id="node3" class="node">
<title>Tracer</title>
<g id="a_node3"><a xlink:href="#" xlink:title="class Tracer:&#10;A class for tracing a piece of code. Use as `with Tracer(): block()`">
<polygon fill="none" stroke="black" points="6,-230.25 6,-365.5 160,-365.5 160,-230.25 6,-230.25"/>
<text xml:space="preserve" text-anchor="start" x="61.62" y="-349.2" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">Tracer</text>
<polyline fill="none" stroke="black" points="6,-340.25 160,-340.25"/>
<g id="a_node3_9"><a xlink:href="#" xlink:title="Tracer">
<g id="a_node3_10"><a xlink:href="#" xlink:title="__enter__(self) &#45;&gt; Any:&#10;Called at begin of `with` block. Turn tracing on.">
<text xml:space="preserve" text-anchor="start" x="14" y="-327.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__enter__()</text>
</a>
</g>
<g id="a_node3_11"><a xlink:href="#" xlink:title="__exit__(self, exc_tp: Type, exc_value: BaseException, exc_traceback: traceback) &#45;&gt; Optional[bool]:&#10;Called at end of `with` block. Turn tracing off.&#10;Return `None` if ok, not `None` if internal error.">
<text xml:space="preserve" text-anchor="start" x="14" y="-315" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__exit__()</text>
</a>
</g>
<g id="a_node3_12"><a xlink:href="#" xlink:title="__init__(self, file: &lt;class &#39;TextIO&#39;&gt; = &lt;ipykernel.iostream.OutStream object at 0x108396530&gt;) &#45;&gt; None:&#10;Create a new tracer.&#10;If `file` is given, output to `file` instead of stdout.">
<text xml:space="preserve" text-anchor="start" x="14" y="-302.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node3_13"><a xlink:href="#" xlink:title="changed_vars(self, new_vars: Dict[str, Any]) &#45;&gt; Dict[str, Any]:&#10;Track changed variables, based on `new_vars` observed.">
<text xml:space="preserve" text-anchor="start" x="14" y="-289.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">changed_vars()</text>
</a>
</g>
<g id="a_node3_14"><a xlink:href="#" xlink:title="print_debugger_status(self, frame: frame, event: str, arg: Any) &#45;&gt; None:&#10;Show current source line and changed vars">
<text xml:space="preserve" text-anchor="start" x="14" y="-276.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">print_debugger_status()</text>
</a>
</g>
<g id="a_node3_15"><a xlink:href="#" xlink:title="_traceit(self, frame: frame, event: str, arg: Any) &#45;&gt; Optional[Callable]:&#10;Internal tracing function.">
<text xml:space="preserve" text-anchor="start" x="14" y="-263" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">_traceit()</text>
</a>
</g>
<g id="a_node3_16"><a xlink:href="#" xlink:title="log(self, *objects: Any, sep: str = &#39; &#39;, end: str = &#39;\n&#39;, flush: bool = True) &#45;&gt; None:&#10;Like `print()`, but always sending to `file` given at initialization,&#10;and flushing by default.">
<text xml:space="preserve" text-anchor="start" x="14" y="-250.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">log()</text>
</a>
</g>
<g id="a_node3_17"><a xlink:href="#" xlink:title="traceit(self, frame: frame, event: str, arg: Any) &#45;&gt; None:&#10;Tracing function; called at every line. To be overloaded in subclasses.">
<text xml:space="preserve" text-anchor="start" x="14" y="-238.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">traceit()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- ConditionalTracer&#45;&gt;Tracer -->
<g id="edge2" class="edge">
<title>ConditionalTracer&#45;&gt;Tracer</title>
<path fill="none" stroke="black" d="M83,-193.6C83,-201.5 83,-210.01 83,-218.63"/>
<polygon fill="none" stroke="black" points="79.5,-218.46 83,-228.46 86.5,-218.46 79.5,-218.46"/>
</g>
<!-- StackInspector -->
<g id="node4" class="node">
<title>StackInspector</title>
<g id="a_node4"><a xlink:href="StackInspector.ipynb" xlink:title="class StackInspector:&#10;Provide functions to inspect the stack">
<polygon fill="none" stroke="black" points="0,-402.5 0,-448.5 166,-448.5 166,-402.5 0,-402.5"/>
<text xml:space="preserve" text-anchor="start" x="32.75" y="-432.2" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">StackInspector</text>
<polyline fill="none" stroke="black" points="0,-423.25 166,-423.25"/>
<g id="a_node4_18"><a xlink:href="#" xlink:title="StackInspector">
<g id="a_node4_19"><a xlink:href="StackInspector.ipynb" xlink:title="_generated_function_cache = {}">
<text xml:space="preserve" text-anchor="start" x="8" y="-409.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">_generated_function_cache</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- Tracer&#45;&gt;StackInspector -->
<g id="edge3" class="edge">
<title>Tracer&#45;&gt;StackInspector</title>
<path fill="none" stroke="black" d="M83,-365.73C83,-374.35 83,-382.86 83,-390.62"/>
<polygon fill="none" stroke="black" points="79.5,-390.58 83,-400.58 86.5,-390.58 79.5,-390.58"/>
</g>
<!-- Legend -->
<g id="node5" class="node">
<title>Legend</title>
<text xml:space="preserve" text-anchor="start" x="157.38" y="-52.25" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="10.00" fill="#6a0dad">Legend</text>
<text xml:space="preserve" text-anchor="start" x="157.38" y="-42.25" font-family="Raleway, Helvetica, Arial, sans-serif" font-size="10.00">• </text>
<text xml:space="preserve" text-anchor="start" x="163.38" y="-42.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="8.00">public_method()</text>
<text xml:space="preserve" text-anchor="start" x="157.38" y="-32.25" font-family="Raleway, Helvetica, Arial, sans-serif" font-size="10.00">• </text>
<text xml:space="preserve" text-anchor="start" x="163.38" y="-32.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="8.00">private_method()</text>
<text xml:space="preserve" text-anchor="start" x="157.38" y="-22.25" font-family="Raleway, Helvetica, Arial, sans-serif" font-size="10.00">• </text>
<text xml:space="preserve" text-anchor="start" x="163.38" y="-22.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="8.00">overloaded_method()</text>
<text xml:space="preserve" text-anchor="start" x="157.38" y="-13.2" font-family="Helvetica,sans-Serif" font-size="9.00">Hover over names to see doc</text>
</g>
</g>
</svg>
</div></div>
</div>
</section>
<section id="tracing-python-programs">
<h2>Tracing Python Programs<a class="headerlink" href="#tracing-python-programs" title="Link to this heading">#</a></h2>
<p>How do debugging tools access the state of a program during execution? For <em>interpreted</em> languages such as Python, this is a simple task. If a language is interpreted, it is typically fairly easy to control execution and to inspect state – since this is what the interpreter is doing already anyway. Debuggers are then implemented on top of <em>hooks</em> that allow interrupting execution and accessing program state.</p>
<p>Python makes such a hook available in the function <code class="docutils literal notranslate"><span class="pre">sys.settrace()</span></code>. You invoke it with a <em>tracing function</em> that will be called at every line executed, as in</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="n">traceit</span><span class="p">)</span>
</pre></div>
</div>
<p>Such a tracing function is convenient, as it simply traces <em>everything</em>. In contrast to an interactive debugger, where you have to select which aspect of the execution you’re interested in, you can just print out a long trace into an <em>execution log</em>, to examine it later.</p>
<p>This tracing function takes the format</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">types</span><span class="w"> </span><span class="kn">import</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">TracebackType</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">traceit</span><span class="p">(</span><span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]:</span>
    <span class="o">...</span>
</pre></div>
</div>
</div>
</div>
<p>Here, <code class="docutils literal notranslate"><span class="pre">event</span></code> is a string telling what has happened in the program – for instance,</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">'line'</span></code> – a new line is executed</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'call'</span></code> – a function just has been called</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'return'</span></code> – a function returns</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">frame</span></code> argument holds the current execution frame – that is, the function and its local variables:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">frame.f_lineno</span></code> – the current line</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">frame.f_locals</span></code> – the current variables (as a Python dictionary)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">frame.f_code</span></code> – the current code (as a Code object), with attributes such as</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">frame.f_code.co_name</span></code> – the name of the current function</p></li>
</ul>
</li>
</ul>
<p>We can thus get a <em>trace</em> of the program by simply printing out these values:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">traceit</span><span class="p">(</span><span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]:</span>  <span class="c1"># type: ignore</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The return value of the trace function is the function to be executed at the next event – typically, this is the function itself:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">traceit</span><span class="p">(</span><span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]:</span>  <span class="c1"># type: ignore</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">traceit</span>
</pre></div>
</div>
</div>
</div>
<p>Let us try this out on the <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code> function introduced in the <a class="reference internal" href="Intro_Debugging.html"><span class="std std-doc">Introduction to Debugging</span></a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">Intro_Debugging</span><span class="w"> </span><span class="kn">import</span> <span class="n">remove_html_markup</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_content</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">content</span><span class="p">,</span> <span class="n">start_line_number</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcelines</span><span class="p">(</span><span class="n">remove_html_markup</span><span class="p">)</span>
<span class="n">print_content</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="n">start_line_number</span><span class="o">=</span><span class="n">start_line_number</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>238  <span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">remove_html_markup</span>(s):  <span class=" -Color -Color-White"># type: ignore</span>
239      tag = <span class=" -Color -Color-Blue">False</span>
240      quote = <span class=" -Color -Color-Blue">False</span>
241      out = <span class=" -Color -Color-Yellow">&quot;&quot;</span>
242  
243      <span class=" -Color -Color-Blue">for</span> c <span class=" -Color -Color-Magenta">in</span> s:
244          <span class=" -Color -Color-Blue">assert</span> tag <span class=" -Color -Color-Magenta">or</span> <span class=" -Color -Color-Magenta">not</span> quote
245  
246          <span class=" -Color -Color-Blue">if</span> c == <span class=" -Color -Color-Yellow">&#39;&lt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> <span class=" -Color -Color-Magenta">not</span> quote:
247              tag = <span class=" -Color -Color-Blue">True</span>
248          <span class=" -Color -Color-Blue">elif</span> c == <span class=" -Color -Color-Yellow">&#39;&gt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> <span class=" -Color -Color-Magenta">not</span> quote:
249              tag = <span class=" -Color -Color-Blue">False</span>
250          <span class=" -Color -Color-Blue">elif</span> (c == <span class=" -Color -Color-Yellow">&#39;&quot;&#39;</span> <span class=" -Color -Color-Magenta">or</span> c == <span class=" -Color -Color-Yellow">&quot;&#39;&quot;</span>) <span class=" -Color -Color-Magenta">and</span> tag:
251              quote = <span class=" -Color -Color-Magenta">not</span> quote
252          <span class=" -Color -Color-Blue">elif</span> <span class=" -Color -Color-Magenta">not</span> tag:
253              out = out + c
254  
255      <span class=" -Color -Color-Blue">return</span> out
</pre></div>
</div>
</div>
</div>
<p>We define a variant <code class="docutils literal notranslate"><span class="pre">remove_html_markup_traced()</span></code> which turns on tracing, invokes <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code>, and turns tracing off again.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">remove_html_markup_traced</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="n">traceit</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">remove_html_markup</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>
</pre></div>
</div>
</div>
</div>
<p>Here is what we get when we run <code class="docutils literal notranslate"><span class="pre">remove_html_markup_traced()</span></code>:</p>
<ul class="simple">
<li><p>We first get a <code class="docutils literal notranslate"><span class="pre">call</span></code> event (showing the call of <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code>)</p></li>
<li><p>We then get various <code class="docutils literal notranslate"><span class="pre">line</span></code> events (for each line of <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code>)</p></li>
<li><p>In the end, we get a <code class="docutils literal notranslate"><span class="pre">return</span></code> event (showing the return from <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code>)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">remove_html_markup_traced</span><span class="p">(</span><span class="s1">&#39;xyz&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>call 238 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;}
line 239 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;}
line 240 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False}
line 241 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False}
line 243 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;&#39;}
line 244 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;&#39;, &#39;c&#39;: &#39;x&#39;}
line 246 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;&#39;, &#39;c&#39;: &#39;x&#39;}
line 248 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;&#39;, &#39;c&#39;: &#39;x&#39;}
line 250 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;&#39;, &#39;c&#39;: &#39;x&#39;}
line 252 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;&#39;, &#39;c&#39;: &#39;x&#39;}
line 253 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;&#39;, &#39;c&#39;: &#39;x&#39;}
line 243 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;x&#39;, &#39;c&#39;: &#39;x&#39;}
line 244 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;x&#39;, &#39;c&#39;: &#39;y&#39;}
line 246 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;x&#39;, &#39;c&#39;: &#39;y&#39;}
line 248 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;x&#39;, &#39;c&#39;: &#39;y&#39;}
line 250 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;x&#39;, &#39;c&#39;: &#39;y&#39;}
line 252 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;x&#39;, &#39;c&#39;: &#39;y&#39;}
line 253 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;x&#39;, &#39;c&#39;: &#39;y&#39;}
line 243 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;xy&#39;, &#39;c&#39;: &#39;y&#39;}
line 244 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;xy&#39;, &#39;c&#39;: &#39;z&#39;}
line 246 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;xy&#39;, &#39;c&#39;: &#39;z&#39;}
line 248 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;xy&#39;, &#39;c&#39;: &#39;z&#39;}
line 250 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;xy&#39;, &#39;c&#39;: &#39;z&#39;}
line 252 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;xy&#39;, &#39;c&#39;: &#39;z&#39;}
line 253 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;xy&#39;, &#39;c&#39;: &#39;z&#39;}
line 243 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;xyz&#39;, &#39;c&#39;: &#39;z&#39;}
line 255 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;xyz&#39;, &#39;c&#39;: &#39;z&#39;}
return 255 remove_html_markup {&#39;s&#39;: &#39;xyz&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;xyz&#39;, &#39;c&#39;: &#39;z&#39;}
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;xyz&#39;
</pre></div>
</div>
</div>
</div>
<p>During the execution, we also see all local <em>variables</em>. As <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code> is called at the very beginning, the parameter <code class="docutils literal notranslate"><span class="pre">s</span></code> holds the argument <code class="docutils literal notranslate"><span class="pre">&quot;xyz&quot;</span></code>. As more local variables are being assigned, these show up in our dictionary of local variables.</p>
<p>We see how the variable <code class="docutils literal notranslate"><span class="pre">c</span></code> takes one character of the input string at a time; the <code class="docutils literal notranslate"><span class="pre">out</span></code> variable accumulates them.  and the <code class="docutils literal notranslate"><span class="pre">tag</span></code> and <code class="docutils literal notranslate"><span class="pre">quote</span></code> flags stay unchanged throughout the execution.</p>
<p>An interesting aspect is that we can actually <em>access</em> all these local variables as regular Python objects. We can, for instance, separately access the value of <code class="docutils literal notranslate"><span class="pre">c</span></code> by looking up <code class="docutils literal notranslate"><span class="pre">frame.f_locals['c']</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">traceit</span><span class="p">(</span><span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]:</span>  <span class="c1"># type: ignore</span>
    <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">:</span>
        <span class="n">value_of_c</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span><span class="si">:}</span><span class="s2"> c = </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">value_of_c</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span><span class="si">:}</span><span class="s2"> c is undefined&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">traceit</span>
</pre></div>
</div>
</div>
</div>
<p>This allows us to specifically monitor individual variables:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">remove_html_markup_traced</span><span class="p">(</span><span class="s1">&#39;xyz&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>238 c is undefined
239 c is undefined
240 c is undefined
241 c is undefined
243 c is undefined
244 c = &#39;x&#39;
246 c = &#39;x&#39;
248 c = &#39;x&#39;
250 c = &#39;x&#39;
252 c = &#39;x&#39;
253 c = &#39;x&#39;
243 c = &#39;x&#39;
244 c = &#39;y&#39;
246 c = &#39;y&#39;
248 c = &#39;y&#39;
250 c = &#39;y&#39;
252 c = &#39;y&#39;
253 c = &#39;y&#39;
243 c = &#39;y&#39;
244 c = &#39;z&#39;
246 c = &#39;z&#39;
248 c = &#39;z&#39;
250 c = &#39;z&#39;
252 c = &#39;z&#39;
253 c = &#39;z&#39;
243 c = &#39;z&#39;
255 c = &#39;z&#39;
255 c = &#39;z&#39;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;xyz&#39;
</pre></div>
</div>
</div>
</div>
<p>This tracing capability is tremendously powerful – actually, it is one of the reasons this book uses Python all over the place. In most other languages, inspecting the program state during execution is much more complex than the handful of lines we have needed so far.</p>
<p>To learn more about <code class="docutils literal notranslate"><span class="pre">sys.settrace()</span></code>, spend a moment to look up <a class="reference external" href="https://docs.python.org/3/library/sys.html">its documentation in the Python reference</a>.</p>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">What happens if the tracing function returns <code>None</code> while tracing function <code>f()</code>? (You can also try this out yourself.)</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">
    
        <input type="radio" name="bdc75768-b293-11f0-bed5-6298cf1a5790" id="bdc75768-b293-11f0-bed5-6298cf1a5790-1" onclick="clear_selection('bdc75768-b293-11f0-bed5-6298cf1a5790')">
        <label id="bdc75768-b293-11f0-bed5-6298cf1a5790-1-label" for="bdc75768-b293-11f0-bed5-6298cf1a5790-1">Tracing stops for all functions; the tracing function is no longer called</label><br>
    
        <input type="radio" name="bdc75768-b293-11f0-bed5-6298cf1a5790" id="bdc75768-b293-11f0-bed5-6298cf1a5790-2" onclick="clear_selection('bdc75768-b293-11f0-bed5-6298cf1a5790')">
        <label id="bdc75768-b293-11f0-bed5-6298cf1a5790-2-label" for="bdc75768-b293-11f0-bed5-6298cf1a5790-2">Tracing stops for <code>f()</code>: the tracing function is called when <code>f()</code> returns</label><br>
    
        <input type="radio" name="bdc75768-b293-11f0-bed5-6298cf1a5790" id="bdc75768-b293-11f0-bed5-6298cf1a5790-3" onclick="clear_selection('bdc75768-b293-11f0-bed5-6298cf1a5790')">
        <label id="bdc75768-b293-11f0-bed5-6298cf1a5790-3-label" for="bdc75768-b293-11f0-bed5-6298cf1a5790-3">Tracing stops for <code>f()</code> the rest of the execution: the tracing function is no longer called for calls to <code>f()</code></label><br>
    
        <input type="radio" name="bdc75768-b293-11f0-bed5-6298cf1a5790" id="bdc75768-b293-11f0-bed5-6298cf1a5790-4" onclick="clear_selection('bdc75768-b293-11f0-bed5-6298cf1a5790')">
        <label id="bdc75768-b293-11f0-bed5-6298cf1a5790-4-label" for="bdc75768-b293-11f0-bed5-6298cf1a5790-4">Nothing changes</label><br>
    
    </div>
    </p>
    <input id="bdc75768-b293-11f0-bed5-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('bdc75768-b293-11f0-bed5-6298cf1a5790', 4, 0, 'int(math.log(7.38905609893065))')">
    <span class="quiz_hint" id="bdc75768-b293-11f0-bed5-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
<p>Indeed, as listed in the documentation: if <code class="docutils literal notranslate"><span class="pre">sys.settrace()</span></code> returns <code class="docutils literal notranslate"><span class="pre">None</span></code>, then tracing stops for the current scope; tracing will resume when the current function returns. This can be helpful for momentarily disable (expensive) tracing.</p>
</section>
<section id="a-tracer-class">
<h2>A Tracer Class<a class="headerlink" href="#a-tracer-class" title="Link to this heading">#</a></h2>
<p>Let us refine our tracing function a bit. First, it would be nice if one could actually <em>customize</em> tracing just as needed. To this end, we introduce a <code class="docutils literal notranslate"><span class="pre">Tracer</span></code> class that does all the formatting for us, and which can be <em>subclassed</em> to allow for different output formats.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">traceit()</span></code> method in <code class="docutils literal notranslate"><span class="pre">Tracer</span></code> is the same as above, and again is set up via <code class="docutils literal notranslate"><span class="pre">sys.settrace()</span></code>. It uses a <code class="docutils literal notranslate"><span class="pre">log()</span></code> method after the Python <code class="docutils literal notranslate"><span class="pre">print()</span></code> function.</p>
<p>The typical usage of <code class="docutils literal notranslate"><span class="pre">Tracer</span></code>, however, is as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Tracer</span><span class="p">():</span>
    <span class="c1"># Code to be traced</span>
    <span class="o">...</span>

<span class="c1"># Code no longer traced</span>
<span class="o">...</span>
</pre></div>
</div>
<p>When the <code class="docutils literal notranslate"><span class="pre">with</span></code> statement is encountered, the <code class="docutils literal notranslate"><span class="pre">__enter__()</span></code> method is called, which starts tracing. When the <code class="docutils literal notranslate"><span class="pre">with</span></code> block ends, the <code class="docutils literal notranslate"><span class="pre">__exit__()</span></code> method is called, and tracing is turned off. We take special care that the internal <code class="docutils literal notranslate"><span class="pre">__exit__()</span></code> method is not part of the trace, and that any other tracing function that was active before is being restored.</p>
<p>We build <code class="docutils literal notranslate"><span class="pre">Tracer</span></code> on top of a class named <code class="docutils literal notranslate"><span class="pre">StackInspector</span></code>, whose <code class="docutils literal notranslate"><span class="pre">our_frame()</span></code> and <code class="docutils literal notranslate"><span class="pre">is_internal_error()</span></code> methods us with providing better diagnostics in case of error.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">StackInspector</span><span class="w"> </span><span class="kn">import</span> <span class="n">StackInspector</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Tracer</span><span class="p">(</span><span class="n">StackInspector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class for tracing a piece of code. Use as `with Tracer(): block()`&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="n">TextIO</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trace a block of code, sending logs to `file` (default: stdout)&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_trace_function</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">traceit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tracing function. To be overridden in subclasses.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_traceit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Internal tracing function.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
            <span class="c1"># Do not trace our own methods</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traceit</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traceit</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">objects</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> 
            <span class="n">sep</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> 
            <span class="n">flush</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Like `print()`, but always sending to `file` given at initialization,</span>
<span class="sd">        and flushing by default.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">objects</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="n">flush</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Called at begin of `with` block. Turn tracing on.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_trace_function</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">gettrace</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_traceit</span><span class="p">)</span>

        <span class="c1"># This extra line also enables tracing for the current block</span>
        <span class="c1"># inspect.currentframe().f_back.f_trace = self._traceit</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_tp</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">:</span> <span class="ne">BaseException</span><span class="p">,</span> 
                 <span class="n">exc_traceback</span><span class="p">:</span> <span class="n">TracebackType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called at end of `with` block. Turn tracing off.</span>
<span class="sd">        Return `None` if ok, not `None` if internal error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_trace_function</span><span class="p">)</span>

        <span class="c1"># Note: we must return a non-True value here,</span>
        <span class="c1"># such that we re-raise all exceptions</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_internal_error</span><span class="p">(</span><span class="n">exc_tp</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># internal error</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># all ok</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s how we use the <code class="docutils literal notranslate"><span class="pre">Tracer</span></code> class. You see that everything works as before, except that it is nicer to use:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Tracer</span><span class="p">():</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="s2">&quot;abc&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>call 238 remove_html_markup {&#39;s&#39;: &#39;abc&#39;}
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>line 239 remove_html_markup {&#39;s&#39;: &#39;abc&#39;}
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>line 240 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False}
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>line 241 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False}
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>line 243 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;&#39;}
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>line 244 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;&#39;, &#39;c&#39;: &#39;a&#39;}
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>line 246 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;&#39;, &#39;c&#39;: &#39;a&#39;}
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>line 248 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;&#39;, &#39;c&#39;: &#39;a&#39;}
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>line 250 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;&#39;, &#39;c&#39;: &#39;a&#39;}
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>line 252 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;&#39;, &#39;c&#39;: &#39;a&#39;}
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>line 253 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;&#39;, &#39;c&#39;: &#39;a&#39;}
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>line 243 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;a&#39;, &#39;c&#39;: &#39;a&#39;}
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>line 244 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;a&#39;, &#39;c&#39;: &#39;b&#39;}
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>line 246 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;a&#39;, &#39;c&#39;: &#39;b&#39;}
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>line 248 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;a&#39;, &#39;c&#39;: &#39;b&#39;}
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>line 250 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;a&#39;, &#39;c&#39;: &#39;b&#39;}
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>line 252 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;a&#39;, &#39;c&#39;: &#39;b&#39;}
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>line 253 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;a&#39;, &#39;c&#39;: &#39;b&#39;}
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>line 243 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;ab&#39;, &#39;c&#39;: &#39;b&#39;}
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>line 244 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;ab&#39;, &#39;c&#39;: &#39;c&#39;}
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>line 246 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;ab&#39;, &#39;c&#39;: &#39;c&#39;}
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>line 248 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;ab&#39;, &#39;c&#39;: &#39;c&#39;}
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>line 250 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;ab&#39;, &#39;c&#39;: &#39;c&#39;}
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>line 252 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;ab&#39;, &#39;c&#39;: &#39;c&#39;}
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>line 253 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;ab&#39;, &#39;c&#39;: &#39;c&#39;}
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>line 243 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;abc&#39;, &#39;c&#39;: &#39;c&#39;}
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>line 255 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;abc&#39;, &#39;c&#39;: &#39;c&#39;}
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>return 255 remove_html_markup {&#39;s&#39;: &#39;abc&#39;, &#39;tag&#39;: False, &#39;quote&#39;: False, &#39;out&#39;: &#39;abc&#39;, &#39;c&#39;: &#39;c&#39;}
</pre></div>
</div>
</div>
</div>
</section>
<section id="accessing-source-code">
<h2>Accessing Source Code<a class="headerlink" href="#accessing-source-code" title="Link to this heading">#</a></h2>
<p>We can now go and <em>extend</em> the class with additional features. It would be nice if it could actually display the source code of the function being tracked, such that we know where we are. In Python, the function <code class="docutils literal notranslate"><span class="pre">inspect.getsource()</span></code> returns the source code of a function or module. Looking up</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">module</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmodule</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="p">)</span>
</pre></div>
</div>
<p>gives us the current module, and</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
</pre></div>
</div>
<p>gives us its source code. All we then have to do is to retrieve the current line.</p>
<p>To implement our extended <code class="docutils literal notranslate"><span class="pre">traceit()</span></code> method, we use a bit of a hack. The Python language requires us to define an entire class with all methods as a single, continuous unit; however, we would like to introduce one method after another.  To avoid this problem, we use a special hack: Whenever we want to introduce a new method to some class <code class="docutils literal notranslate"><span class="pre">C</span></code>, we use the construct</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">C</span><span class="p">(</span><span class="n">C</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">new_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
</div>
<p>This seems to define <code class="docutils literal notranslate"><span class="pre">C</span></code> as a subclass of itself, which would make no sense – but actually, it introduces a new <code class="docutils literal notranslate"><span class="pre">C</span></code> class as a subclass of the <em>old</em> <code class="docutils literal notranslate"><span class="pre">C</span></code> class, and then shadowing the old <code class="docutils literal notranslate"><span class="pre">C</span></code> definition.  What this gets us is a <code class="docutils literal notranslate"><span class="pre">C</span></code> class with <code class="docutils literal notranslate"><span class="pre">new_method()</span></code> as a method, which is just what we want.  (<code class="docutils literal notranslate"><span class="pre">C</span></code> objects defined earlier will retain the earlier <code class="docutils literal notranslate"><span class="pre">C</span></code> definition, though, and thus must be rebuilt.)</p>
<p>Using this hack, we can now redefine the <code class="docutils literal notranslate"><span class="pre">traceit()</span></code> method. Our new tracer shows the current line as it is executed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Tracer</span><span class="p">(</span><span class="n">Tracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">traceit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tracing function; called at every line. To be overloaded in subclasses.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;line&#39;</span><span class="p">:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmodule</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">module</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
            <span class="n">current_line</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span><span class="p">,</span> <span class="n">current_line</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Tracer</span><span class="p">():</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="s2">&quot;abc&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>239     tag = False
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>240     quote = False
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>241     out = &quot;&quot;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>246         if c == &#39;&lt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>248         elif c == &#39;&gt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>250         elif (c == &#39;&quot;&#39; or c == &quot;&#39;&quot;) and tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>252         elif not tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>253             out = out + c
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>246         if c == &#39;&lt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>248         elif c == &#39;&gt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>250         elif (c == &#39;&quot;&#39; or c == &quot;&#39;&quot;) and tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>252         elif not tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>253             out = out + c
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>246         if c == &#39;&lt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>248         elif c == &#39;&gt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>250         elif (c == &#39;&quot;&#39; or c == &quot;&#39;&quot;) and tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>252         elif not tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>253             out = out + c
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>255     return out
</pre></div>
</div>
</div>
</div>
</section>
<section id="tracing-calls-and-returns">
<h2>Tracing Calls and Returns<a class="headerlink" href="#tracing-calls-and-returns" title="Link to this heading">#</a></h2>
<p>Next, we’d like to report calling and returning from functions. For the <code class="docutils literal notranslate"><span class="pre">return</span></code> event, <code class="docutils literal notranslate"><span class="pre">arg</span></code> holds the value being returned.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Tracer</span><span class="p">(</span><span class="n">Tracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">traceit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tracing function. To be overridden in subclasses.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calling </span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="si">}</span><span class="s2">()&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;line&#39;</span><span class="p">:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmodule</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">module</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">source</span><span class="p">:</span>
                <span class="n">current_line</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span><span class="p">,</span> <span class="n">current_line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;return&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="si">}</span><span class="s2">() returns </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Tracer</span><span class="p">():</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="s2">&quot;abc&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Calling remove_html_markup()
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>239     tag = False
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>240     quote = False
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>241     out = &quot;&quot;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>246         if c == &#39;&lt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>248         elif c == &#39;&gt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>250         elif (c == &#39;&quot;&#39; or c == &quot;&#39;&quot;) and tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>252         elif not tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>253             out = out + c
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>246         if c == &#39;&lt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>248         elif c == &#39;&gt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>250         elif (c == &#39;&quot;&#39; or c == &quot;&#39;&quot;) and tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>252         elif not tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>253             out = out + c
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>246         if c == &#39;&lt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>248         elif c == &#39;&gt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>250         elif (c == &#39;&quot;&#39; or c == &quot;&#39;&quot;) and tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>252         elif not tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>253             out = out + c
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>255     return out
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>remove_html_markup() returns &#39;abc&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="tracing-variable-changes">
<h2>Tracing Variable Changes<a class="headerlink" href="#tracing-variable-changes" title="Link to this heading">#</a></h2>
<p>Finally, we’d again like to report variables – but only those that have changed. To this end, we save a copy of the last reported variables in the class, reporting only the changed values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Tracer</span><span class="p">(</span><span class="n">Tracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="n">TextIO</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new tracer.</span>
<span class="sd">        If `file` is given, output to `file` instead of stdout.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_vars</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">changed_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_vars</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Track changed variables, based on `new_vars` observed.&quot;&quot;&quot;</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">var_value</span> <span class="ow">in</span> <span class="n">new_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">var_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_vars</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">last_vars</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">!=</span> <span class="n">var_value</span><span class="p">):</span>
                <span class="n">changed</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">var_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_vars</span> <span class="o">=</span> <span class="n">new_vars</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">changed</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s how this works: If variable <code class="docutils literal notranslate"><span class="pre">a</span></code> is set to 10 (and we didn’t have it so far), it is marked as changed:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tracer</span> <span class="o">=</span> <span class="n">Tracer</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tracer</span><span class="o">.</span><span class="n">changed_vars</span><span class="p">({</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;a&#39;: 10}
</pre></div>
</div>
</div>
</div>
<p>If another variable <code class="docutils literal notranslate"><span class="pre">b</span></code> is added, and only <code class="docutils literal notranslate"><span class="pre">b</span></code> is changed, then only <code class="docutils literal notranslate"><span class="pre">b</span></code> is marked as changed:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tracer</span><span class="o">.</span><span class="n">changed_vars</span><span class="p">({</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;b&#39;: 25}
</pre></div>
</div>
</div>
</div>
<p>If both variables keep their values, nothing changes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tracer</span><span class="o">.</span><span class="n">changed_vars</span><span class="p">({</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{}
</pre></div>
</div>
</div>
</div>
<p>But if new variables come along, they are listed again.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">changes</span> <span class="o">=</span> <span class="n">tracer</span><span class="o">.</span><span class="n">changed_vars</span><span class="p">({</span><span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">})</span>
<span class="n">changes</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;c&#39;: 10, &#39;d&#39;: 25}
</pre></div>
</div>
</div>
</div>
<p>The following expression creates a comma-separated list of variables and values:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">var</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">changes</span><span class="p">[</span><span class="n">var</span><span class="p">])</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;c = 10, d = 25&#39;
</pre></div>
</div>
</div>
</div>
<p>We can now put all of this together in our tracing function, reporting any variable changes as we see them. Note how we exploit the fact that in a call, all variables have a “new” value; and when we return from a function, we explicitly delete the “last” variables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Tracer</span><span class="p">(</span><span class="n">Tracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">print_debugger_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show current source line and changed vars&quot;&quot;&quot;</span>
        <span class="n">changes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">changed_vars</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">)</span>
        <span class="n">changes_s</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">var</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">changes</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
                               <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Calling &quot;</span> <span class="o">+</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">changes_s</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">changes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="n">changes_s</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;line&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">module</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmodule</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">module</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
                <span class="n">current_line</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">err</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">current_line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">current_line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;return&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span> <span class="o">+</span> <span class="s1">&#39;()&#39;</span> <span class="o">+</span> <span class="s2">&quot; returns &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_vars</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Delete &#39;last&#39; variables</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">traceit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tracing function; called at every line. To be overloaded in subclasses.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_debugger_status</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s the resulting trace of <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code> for a more complex input. You can see that the tracing output allows us to see which lines are executed as well as the variables whose value changes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Tracer</span><span class="p">():</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&lt;b&gt;x&lt;/b&gt;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Calling remove_html_markup(s = &#39;&lt;b&gt;x&lt;/b&gt;&#39;)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>239     tag = False
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # tag = False
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>240     quote = False
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # quote = False
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>241     out = &quot;&quot;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # out = &#39;&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # c = &#39;&lt;&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>246         if c == &#39;&lt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>247             tag = True
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # tag = True
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # c = &#39;b&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>246         if c == &#39;&lt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>248         elif c == &#39;&gt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>250         elif (c == &#39;&quot;&#39; or c == &quot;&#39;&quot;) and tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>252         elif not tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # c = &#39;&gt;&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>246         if c == &#39;&lt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>248         elif c == &#39;&gt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>249             tag = False
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # tag = False
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # c = &#39;x&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>246         if c == &#39;&lt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>248         elif c == &#39;&gt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>250         elif (c == &#39;&quot;&#39; or c == &quot;&#39;&quot;) and tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>252         elif not tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>253             out = out + c
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # out = &#39;x&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # c = &#39;&lt;&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>246         if c == &#39;&lt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>247             tag = True
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # tag = True
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # c = &#39;/&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>246         if c == &#39;&lt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>248         elif c == &#39;&gt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>250         elif (c == &#39;&quot;&#39; or c == &quot;&#39;&quot;) and tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>252         elif not tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # c = &#39;b&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>246         if c == &#39;&lt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>248         elif c == &#39;&gt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>250         elif (c == &#39;&quot;&#39; or c == &quot;&#39;&quot;) and tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>252         elif not tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # c = &#39;&gt;&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>246         if c == &#39;&lt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>248         elif c == &#39;&gt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>249             tag = False
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # tag = False
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>255     return out
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>remove_html_markup() returns &#39;x&#39;
</pre></div>
</div>
</div>
</div>
<p>As you see, even a simple function can create a long execution log. Hence, we will now explore how to focus tracing on particular <em>events</em>.</p>
</section>
<section id="conditional-tracing">
<h2>Conditional Tracing<a class="headerlink" href="#conditional-tracing" title="Link to this heading">#</a></h2>
<p>A log such as the above can very quickly become very messy – notably if executions take a long time, or if data structures become very complex. If one of our local variables were a list with 1,000 entries for instance, and were changed with each line, we’d be printing out the entire list with 1,000 entries for each step.</p>
<p>We could still load the log into, say, a text editor or a database and then search for specific values, but this is still cumbersome – and expensive. A better alternative, however, is to have our tracer only log while specific <em>conditions</em> hold.</p>
<p>To this end, we introduce a class <code class="docutils literal notranslate"><span class="pre">ConditionalTracer</span></code>, which gets a <em>conditional expression</em> to be checked during executions. Only if this condition holds do we list the current status. With</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ConditionalTracer</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="s1">&#39;c == &quot;z&quot;&#39;</span><span class="p">):</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>we would obtain only the lines executed while <code class="docutils literal notranslate"><span class="pre">c</span></code> gets a value of <code class="docutils literal notranslate"><span class="pre">'z'</span></code>, and with</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ConditionalTracer</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="s1">&#39;quote&#39;</span><span class="p">):</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>we would obtain only the lines executed while <code class="docutils literal notranslate"><span class="pre">quote</span></code> is True. If we have multiple conditions, we can combine them into one using <code class="docutils literal notranslate"><span class="pre">and</span></code>, <code class="docutils literal notranslate"><span class="pre">or</span></code>, or <code class="docutils literal notranslate"><span class="pre">not</span></code>.</p>
<p>Our <code class="docutils literal notranslate"><span class="pre">ConditionalTracer</span></code> class stores the condition in its <code class="docutils literal notranslate"><span class="pre">condition</span></code> attribute:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ConditionalTracer</span><span class="p">(</span><span class="n">Tracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">condition</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="n">TextIO</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor. Trace all events for which `condition` (a Python expr) holds.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">condition</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">condition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_report</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Its <code class="docutils literal notranslate"><span class="pre">traceit()</span></code> function <em>evaluates</em> <code class="docutils literal notranslate"><span class="pre">condition</span></code> and reports the current line only if it holds. To this end, it uses the Python <code class="docutils literal notranslate"><span class="pre">eval()</span></code> function which evaluates the condition in the context of the local variables of the program under test. If the condition gets set, we print out three dots to indicate the elapsed time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ConditionalTracer</span><span class="p">(</span><span class="n">ConditionalTracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">eval_in_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>  <span class="c1"># (yet) undefined variable</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">cond</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">do_report()</span></code> function returns True if the status is to be reported:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ConditionalTracer</span><span class="p">(</span><span class="n">ConditionalTracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">do_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_in_context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We put everything together in our <code class="docutils literal notranslate"><span class="pre">traceit()</span></code> function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ConditionalTracer</span><span class="p">(</span><span class="n">ConditionalTracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">traceit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_report</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">report</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_report</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_report</span> <span class="o">=</span> <span class="n">report</span>

        <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_debugger_status</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s an example. We see that <code class="docutils literal notranslate"><span class="pre">quote</span></code> is set only while the three characters <code class="docutils literal notranslate"><span class="pre">b</span></code>, <code class="docutils literal notranslate"><span class="pre">a</span></code>, and <code class="docutils literal notranslate"><span class="pre">r</span></code> are processed (as should be).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ConditionalTracer</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="s1">&#39;quote&#39;</span><span class="p">):</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&lt;b title=&quot;bar&quot;&gt;&quot;foo&quot;&lt;/b&gt;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # s = &#39;&lt;b title=&quot;bar&quot;&gt;&quot;foo&quot;&lt;/b&gt;&#39;, tag = True, quote = True, out = &#39;&#39;, c = &#39;&quot;&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # c = &#39;b&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>246         if c == &#39;&lt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>248         elif c == &#39;&gt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>250         elif (c == &#39;&quot;&#39; or c == &quot;&#39;&quot;) and tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>252         elif not tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # c = &#39;a&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>246         if c == &#39;&lt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>248         elif c == &#39;&gt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>250         elif (c == &#39;&quot;&#39; or c == &quot;&#39;&quot;) and tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>252         elif not tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # c = &#39;r&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>246         if c == &#39;&lt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>248         elif c == &#39;&gt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>250         elif (c == &#39;&quot;&#39; or c == &quot;&#39;&quot;) and tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>252         elif not tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # c = &#39;&quot;&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>246         if c == &#39;&lt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>248         elif c == &#39;&gt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>250         elif (c == &#39;&quot;&#39; or c == &quot;&#39;&quot;) and tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>251             quote = not quote
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">What happens if the condition contains a syntax error?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">
    
        <input type="radio" name="bde97104-b293-11f0-bed5-6298cf1a5790" id="bde97104-b293-11f0-bed5-6298cf1a5790-1" onclick="clear_selection('bde97104-b293-11f0-bed5-6298cf1a5790')">
        <label id="bde97104-b293-11f0-bed5-6298cf1a5790-1-label" for="bde97104-b293-11f0-bed5-6298cf1a5790-1">The tracer stops, raising an exception</label><br>
    
        <input type="radio" name="bde97104-b293-11f0-bed5-6298cf1a5790" id="bde97104-b293-11f0-bed5-6298cf1a5790-2" onclick="clear_selection('bde97104-b293-11f0-bed5-6298cf1a5790')">
        <label id="bde97104-b293-11f0-bed5-6298cf1a5790-2-label" for="bde97104-b293-11f0-bed5-6298cf1a5790-2">The tracer continues as if the condition were <code>True</code></label><br>
    
        <input type="radio" name="bde97104-b293-11f0-bed5-6298cf1a5790" id="bde97104-b293-11f0-bed5-6298cf1a5790-3" onclick="clear_selection('bde97104-b293-11f0-bed5-6298cf1a5790')">
        <label id="bde97104-b293-11f0-bed5-6298cf1a5790-3-label" for="bde97104-b293-11f0-bed5-6298cf1a5790-3">The tracer continues as if the condition were <code>False</code></label><br>
    
    </div>
    </p>
    <input id="bde97104-b293-11f0-bed5-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('bde97104-b293-11f0-bed5-6298cf1a5790', 2, 0, '393 % 7')">
    <span class="quiz_hint" id="bde97104-b293-11f0-bed5-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
<p>Here’s the answer, illustrated in two examples. For syntax errors, we indeed get an exception:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ExpectError</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExpectError</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">(</span><span class="ne">SyntaxError</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">ConditionalTracer</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="s1">&#39;2 +&#39;</span><span class="p">):</span>
        <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&lt;b title=&quot;bar&quot;&gt;&quot;foo&quot;&lt;/b&gt;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51051/3292487498.py&quot;, line 3, in &lt;module&gt;
    remove_html_markup(&#39;&lt;b title=&quot;bar&quot;&gt;&quot;foo&quot;&lt;/b&gt;&#39;)
    ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;Intro_Debugging.ipynb&quot;, line 238, in remove_html_markup
    def remove_html_markup(s):  # type: ignore
    
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51051/3738699336.py&quot;, line 19, in _traceit
    self.traceit(frame, event, arg)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51051/2841885016.py&quot;, line 3, in traceit
    report = self.do_report(frame, event, arg)
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51051/3084505080.py&quot;, line 3, in do_report
    return self.eval_in_context(self.condition, frame)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51051/1027065478.py&quot;, line 4, in eval_in_context
    cond = eval(expr, None, frame.f_locals)
  File &quot;&lt;string&gt;&quot;, line 1
    2 +
SyntaxError: invalid syntax (expected)
</pre></div>
</div>
</div>
</div>
<p>If a variable is undefined, though, the condition evaluates to False:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">ConditionalTracer</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="s1">&#39;undefined_variable&#39;</span><span class="p">):</span>
        <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&lt;b title=&quot;bar&quot;&gt;&quot;foo&quot;&lt;/b&gt;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can also have the log focus on <em>particular code locations</em> only. To this end, we add the pseudo-variables <code class="docutils literal notranslate"><span class="pre">function</span></code> and <code class="docutils literal notranslate"><span class="pre">line</span></code> to our evaluation context, which can be used within our condition to refer to the current function name or line. Then, we invoke the original <code class="docutils literal notranslate"><span class="pre">eval_cond()</span></code> as above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ConditionalTracer</span><span class="p">(</span><span class="n">ConditionalTracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">eval_in_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">eval_in_context</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Again, here is an example. We focus on the parts of the function where the <code class="docutils literal notranslate"><span class="pre">out</span></code> variable is being set:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ConditionalTracer</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="s2">&quot;function == &#39;remove_html_markup&#39; and line &gt;= 237&quot;</span><span class="p">):</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;xyz&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Calling remove_html_markup(s = &#39;xyz&#39;, function = &#39;remove_html_markup&#39;, line = 238)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # line = 239
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>239     tag = False
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # tag = False, line = 240
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>240     quote = False
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # quote = False, line = 241
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>241     out = &quot;&quot;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # out = &#39;&#39;, line = 243
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # c = &#39;x&#39;, line = 244
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # line = 246
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>246         if c == &#39;&lt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # line = 248
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>248         elif c == &#39;&gt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # line = 250
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>250         elif (c == &#39;&quot;&#39; or c == &quot;&#39;&quot;) and tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # line = 252
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>252         elif not tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # line = 253
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>253             out = out + c
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # out = &#39;x&#39;, line = 243
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # c = &#39;y&#39;, line = 244
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # line = 246
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>246         if c == &#39;&lt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # line = 248
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>248         elif c == &#39;&gt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # line = 250
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>250         elif (c == &#39;&quot;&#39; or c == &quot;&#39;&quot;) and tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # line = 252
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>252         elif not tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # line = 253
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>253             out = out + c
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # out = &#39;xy&#39;, line = 243
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # c = &#39;z&#39;, line = 244
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # line = 246
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>246         if c == &#39;&lt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # line = 248
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>248         elif c == &#39;&gt;&#39; and not quote:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # line = 250
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>250         elif (c == &#39;&quot;&#39; or c == &quot;&#39;&quot;) and tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # line = 252
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>252         elif not tag:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # line = 253
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>253             out = out + c
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # out = &#39;xyz&#39;, line = 243
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # line = 255
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>255     return out
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>remove_html_markup() returns &#39;xyz&#39;
</pre></div>
</div>
</div>
</div>
<p>Using <code class="docutils literal notranslate"><span class="pre">line</span></code> and <code class="docutils literal notranslate"><span class="pre">function</span></code> in conditions is equivalent to conventional <em>breakpoints</em> in interactive debuggers. We will encounter them again in the next chapter.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">If the program under test contains a variable named <code>line</code>, which <code>line</code> does the condition refer to?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">
    
        <input type="radio" name="bdf0d106-b293-11f0-bed5-6298cf1a5790" id="bdf0d106-b293-11f0-bed5-6298cf1a5790-1" onclick="clear_selection('bdf0d106-b293-11f0-bed5-6298cf1a5790')">
        <label id="bdf0d106-b293-11f0-bed5-6298cf1a5790-1-label" for="bdf0d106-b293-11f0-bed5-6298cf1a5790-1"><code>line</code> as in the debugger</label><br>
    
        <input type="radio" name="bdf0d106-b293-11f0-bed5-6298cf1a5790" id="bdf0d106-b293-11f0-bed5-6298cf1a5790-2" onclick="clear_selection('bdf0d106-b293-11f0-bed5-6298cf1a5790')">
        <label id="bdf0d106-b293-11f0-bed5-6298cf1a5790-2-label" for="bdf0d106-b293-11f0-bed5-6298cf1a5790-2"><code>line</code> as in the program</label><br>
    
    </div>
    </p>
    <input id="bdf0d106-b293-11f0-bed5-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('bdf0d106-b293-11f0-bed5-6298cf1a5790', 2, 0, '(326 * 27 == 8888) + 1')">
    <span class="quiz_hint" id="bdf0d106-b293-11f0-bed5-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
</section>
<section id="watching-events">
<h2>Watching Events<a class="headerlink" href="#watching-events" title="Link to this heading">#</a></h2>
<p>As an alternative to conditional logging, we may also be interested to exactly trace when a variable not only <em>has</em> a particular value, but also when it <em>changes</em> its value.</p>
<p>To this end, we set up an <code class="docutils literal notranslate"><span class="pre">EventTracer</span></code> class that <em>watches</em> when some event takes place. It takes a list of expressions (“events”) and evaluates them for each line; if any event changes its value, we log the status.</p>
<p>With</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">EventTracer</span><span class="p">(</span><span class="n">events</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">,</span> <span class="s1">&#39;quote&#39;</span><span class="p">]):</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>for instance, we would get a listing of all lines where <code class="docutils literal notranslate"><span class="pre">tag</span></code> or <code class="docutils literal notranslate"><span class="pre">quote</span></code> change their value; and with</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">EventTracer</span><span class="p">(</span><span class="n">events</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">]):</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>we would obtain a listing of all lines where the current function changes.</p>
<p>Our <code class="docutils literal notranslate"><span class="pre">EventTracer</span></code> class stores the list of events in its <code class="docutils literal notranslate"><span class="pre">events</span></code> attribute:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">EventTracer</span><span class="p">(</span><span class="n">ConditionalTracer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Log when a given event expression changes its value&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">condition</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">file</span><span class="p">:</span> <span class="n">TextIO</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor. `events` is a list of expressions to watch.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">List</span><span class="p">)</span>  <span class="c1"># avoid type errors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">events</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_event_values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="n">condition</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Its <code class="docutils literal notranslate"><span class="pre">events_changed()</span></code> function <em>evaluates</em> the individual events and checks if they change.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">EventTracer</span><span class="p">(</span><span class="n">EventTracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">events_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if any of the observed `events` has changed&quot;&quot;&quot;</span>
        <span class="n">change</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_in_context</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_event_values</span> <span class="ow">or</span>
                    <span class="n">value</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_event_values</span><span class="p">[</span><span class="n">event</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_event_values</span><span class="p">[</span><span class="n">event</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">change</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">change</span>
</pre></div>
</div>
</div>
</div>
<p>We hook this into <code class="docutils literal notranslate"><span class="pre">do_report()</span></code>, the method that determines whether a line should be shown.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">EventTracer</span><span class="p">(</span><span class="n">EventTracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">do_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if a line should be shown&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_in_context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">events_changed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">,</span> <span class="n">frame</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>This allows us to track, for instance, how <code class="docutils literal notranslate"><span class="pre">quote</span></code> and <code class="docutils literal notranslate"><span class="pre">tag</span></code> change their values over time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">EventTracer</span><span class="p">(</span><span class="n">events</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;quote&#39;</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">]):</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&lt;b title=&quot;bar&quot;&gt;&quot;foo&quot;&lt;/b&gt;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Calling remove_html_markup(s = &#39;&lt;b title=&quot;bar&quot;&gt;&quot;foo&quot;&lt;/b&gt;&#39;, function = &#39;remove_html_markup&#39;, line = 238)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # tag = False, line = 240
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>240     quote = False
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # quote = False, line = 241
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>241     out = &quot;&quot;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # tag = True, out = &#39;&#39;, c = &#39;&lt;&#39;, line = 243
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # quote = True, c = &#39;&quot;&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # quote = False
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # tag = False, c = &#39;&gt;&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # tag = True, out = &#39;&quot;foo&quot;&#39;, c = &#39;&lt;&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # tag = False, c = &#39;&gt;&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>243     for c in s:
</pre></div>
</div>
</div>
</div>
<p>Continuously monitoring variable values at execution time is equivalent to the concept of <em>watchpoints</em> in interactive debuggers.</p>
<p>With this, we have all we need for observing what happens during execution: We can explore the entire state, and we can evaluate conditions and events we are interested in. In the next chapter, we will see how to turn these capabilities into an interactive debugger, where we can query all these things interactively.</p>
</section>
<section id="efficient-tracing">
<h2>Efficient Tracing<a class="headerlink" href="#efficient-tracing" title="Link to this heading">#</a></h2>
<p>While our framework is very flexible (and can still be extended further), it also is <em>slow</em>, since we have to evaluate all conditions and events for every single line of the program. Just how slow are things? We can easily measure this.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">Timer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">runs</span> <span class="o">=</span> <span class="mi">1000</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s the untraced execution time in seconds:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">runs</span><span class="p">):</span>
        <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&lt;b title=&quot;bar&quot;&gt;&quot;foo&quot;&lt;/b&gt;&#39;</span><span class="p">)</span>
<span class="n">untraced_execution_time</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">()</span>
<span class="n">untraced_execution_time</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0021284589893184602
</pre></div>
</div>
</div>
</div>
<p>And here’s the <em>traced</em> execution time:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">runs</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">EventTracer</span><span class="p">():</span>
            <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&lt;b title=&quot;bar&quot;&gt;&quot;foo&quot;&lt;/b&gt;&#39;</span><span class="p">)</span>
<span class="n">traced_execution_time</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">()</span>
<span class="n">traced_execution_time</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.7567424169974402
</pre></div>
</div>
</div>
</div>
<p>We see that the <em>traced</em> execution time is several hundred times slower:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">traced_execution_time</span> <span class="o">/</span> <span class="n">untraced_execution_time</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>355.53535247571375
</pre></div>
</div>
</div>
</div>
<p>We can still speed up our implementation somewhat, but still will get nowhere near the untraced execution time.</p>
<p>There is a trick, though, that allows us to execute programs at full speed while being traced. Rather than <em>dynamically</em> checking at run time whether a condition is met, we can also <em>statically</em> inject appropriate code into the program under test. This way, the non-traced code is executed at normal speed.</p>
<p>There is a downside, though: This only works if the condition to be checked is limited to specific <em>locations</em> – because it is precisely these locations where we insert our tracing code. With this limitation, though, <em>static</em> tracing can speed up things significantly.</p>
<p>How does static code injection work? The trick involves <em>rewriting</em> the program code to insert special <em>debugging statements</em> at the given locations. This way, we do not need to use the tracing function at all.</p>
<p>The following <code class="docutils literal notranslate"><span class="pre">insert_tracer()</span></code> function demonstrates this. It takes a function as well as a list of <em>breakpoint</em> lines where to insert tracing statements. At each given line, it injects the code</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">TRACER_CODE</span> <span class="o">=</span> \
    <span class="s2">&quot;TRACER.print_debugger_status(inspect.currentframe(), &#39;line&#39;, None); &quot;</span>
</pre></div>
</div>
</div>
</div>
<p>into the function definition, which calls into this tracer:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">TRACER</span> <span class="o">=</span> <span class="n">Tracer</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">insert_tracer()</span></code> then <em>compiles</em> the resulting code into a new “traced” function, which it then returns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">insert_tracer</span><span class="p">(</span><span class="n">function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">breakpoints</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[])</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a variant of `function` with tracing code `TRACER_CODE` inserted</span>
<span class="sd">       at each line given by `breakpoints`.&quot;&quot;&quot;</span>

    <span class="n">source_lines</span><span class="p">,</span> <span class="n">starting_line_number</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcelines</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>

    <span class="n">breakpoints</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">given_line</span> <span class="ow">in</span> <span class="n">breakpoints</span><span class="p">:</span>
        <span class="c1"># Set new source line</span>
        <span class="n">relative_line</span> <span class="o">=</span> <span class="n">given_line</span> <span class="o">-</span> <span class="n">starting_line_number</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">inject_line</span> <span class="o">=</span> <span class="n">source_lines</span><span class="p">[</span><span class="n">relative_line</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">indent</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inject_line</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">inject_line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span>
        <span class="n">source_lines</span><span class="p">[</span><span class="n">relative_line</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">indent</span> <span class="o">+</span> <span class="n">TRACER_CODE</span> <span class="o">+</span> <span class="n">inject_line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>

    <span class="c1"># Rename function</span>
    <span class="n">new_function_name</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;_traced&quot;</span>
    <span class="n">source_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">new_function_name</span><span class="p">)</span>
    <span class="n">new_def</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source_lines</span><span class="p">)</span>

    <span class="c1"># For debugging</span>
    <span class="n">print_content</span><span class="p">(</span><span class="n">new_def</span><span class="p">,</span> <span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="n">start_line_number</span><span class="o">=</span><span class="n">starting_line_number</span><span class="p">)</span>

    <span class="c1"># We keep original source and filename to ease debugging</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="n">starting_line_number</span>    <span class="c1"># Get line number right</span>
    <span class="n">new_function_code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">new_def</span><span class="p">,</span> <span class="n">function</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_filename</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
    <span class="n">exec</span><span class="p">(</span><span class="n">new_function_code</span><span class="p">)</span>
    <span class="n">new_function</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">new_function_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_function</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s an example: inserting two breakpoints in (relative) Lines 7 and 18 of <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code> results in the following (rewritten) definition of <code class="docutils literal notranslate"><span class="pre">remove_html_markup_traced()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">remove_html_markup_starting_line_number</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcelines</span><span class="p">(</span><span class="n">remove_html_markup</span><span class="p">)</span>
<span class="n">breakpoints</span> <span class="o">=</span> <span class="p">[(</span><span class="n">remove_html_markup_starting_line_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> 
               <span class="p">(</span><span class="n">remove_html_markup_starting_line_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">18</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">remove_html_markup_traced</span> <span class="o">=</span> <span class="n">insert_tracer</span><span class="p">(</span><span class="n">remove_html_markup</span><span class="p">,</span> <span class="n">breakpoints</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>238  <span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">remove_html_markup_traced</span>(s):  <span class=" -Color -Color-White"># type: ignore</span>
239      tag = <span class=" -Color -Color-Blue">False</span>
240      quote = <span class=" -Color -Color-Blue">False</span>
241      out = <span class=" -Color -Color-Yellow">&quot;&quot;</span>
242  
243      <span class=" -Color -Color-Blue">for</span> c <span class=" -Color -Color-Magenta">in</span> s:
244          TRACER.print_debugger_status(inspect.currentframe(), <span class=" -Color -Color-Yellow">&#39;line&#39;</span>, <span class=" -Color -Color-Blue">None</span>); <span class=" -Color -Color-Blue">assert</span> tag <span class=" -Color -Color-Magenta">or</span> <span class=" -Color -Color-Magenta">not</span> quote
245  
246          <span class=" -Color -Color-Blue">if</span> c == <span class=" -Color -Color-Yellow">&#39;&lt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> <span class=" -Color -Color-Magenta">not</span> quote:
247              tag = <span class=" -Color -Color-Blue">True</span>
248          <span class=" -Color -Color-Blue">elif</span> c == <span class=" -Color -Color-Yellow">&#39;&gt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> <span class=" -Color -Color-Magenta">not</span> quote:
249              tag = <span class=" -Color -Color-Blue">False</span>
250          <span class=" -Color -Color-Blue">elif</span> (c == <span class=" -Color -Color-Yellow">&#39;&quot;&#39;</span> <span class=" -Color -Color-Magenta">or</span> c == <span class=" -Color -Color-Yellow">&quot;&#39;&quot;</span>) <span class=" -Color -Color-Magenta">and</span> tag:
251              quote = <span class=" -Color -Color-Magenta">not</span> quote
252          <span class=" -Color -Color-Blue">elif</span> <span class=" -Color -Color-Magenta">not</span> tag:
253              out = out + c
254  
255      TRACER.print_debugger_status(inspect.currentframe(), <span class=" -Color -Color-Yellow">&#39;line&#39;</span>, <span class=" -Color -Color-Blue">None</span>); <span class=" -Color -Color-Blue">return</span> out
</pre></div>
</div>
</div>
</div>
<p>If we execute the statically instrumented <code class="docutils literal notranslate"><span class="pre">remove_html_markup_traced()</span></code>, we obtain the same output as when using a dynamic tracer. Note that the source code listed shows the original code; the injected calls into <code class="docutils literal notranslate"><span class="pre">TRACER</span></code> do not show up.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
    <span class="n">remove_html_markup_traced</span><span class="p">(</span><span class="s1">&#39;&lt;b title=&quot;bar&quot;&gt;&quot;foo&quot;&lt;/b&gt;&#39;</span><span class="p">)</span>
<span class="n">static_tracer_execution_time</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>238 c is undefined
239 c is undefined
240 c is undefined
241 c is undefined
243 c is undefined
244 c = &#39;&lt;&#39;
246 c = &#39;&lt;&#39;
247 c = &#39;&lt;&#39;
243 c = &#39;&lt;&#39;
244 c = &#39;b&#39;
246 c = &#39;b&#39;
248 c = &#39;b&#39;
250 c = &#39;b&#39;
252 c = &#39;b&#39;
243 c = &#39;b&#39;
244 c = &#39; &#39;
246 c = &#39; &#39;
248 c = &#39; &#39;
250 c = &#39; &#39;
252 c = &#39; &#39;
243 c = &#39; &#39;
244 c = &#39;t&#39;
246 c = &#39;t&#39;
248 c = &#39;t&#39;
250 c = &#39;t&#39;
252 c = &#39;t&#39;
243 c = &#39;t&#39;
244 c = &#39;i&#39;
246 c = &#39;i&#39;
248 c = &#39;i&#39;
250 c = &#39;i&#39;
252 c = &#39;i&#39;
243 c = &#39;i&#39;
244 c = &#39;t&#39;
246 c = &#39;t&#39;
248 c = &#39;t&#39;
250 c = &#39;t&#39;
252 c = &#39;t&#39;
243 c = &#39;t&#39;
244 c = &#39;l&#39;
246 c = &#39;l&#39;
248 c = &#39;l&#39;
250 c = &#39;l&#39;
252 c = &#39;l&#39;
243 c = &#39;l&#39;
244 c = &#39;e&#39;
246 c = &#39;e&#39;
248 c = &#39;e&#39;
250 c = &#39;e&#39;
252 c = &#39;e&#39;
243 c = &#39;e&#39;
244 c = &#39;=&#39;
246 c = &#39;=&#39;
248 c = &#39;=&#39;
250 c = &#39;=&#39;
252 c = &#39;=&#39;
243 c = &#39;=&#39;
244 c = &#39;&quot;&#39;
246 c = &#39;&quot;&#39;
248 c = &#39;&quot;&#39;
250 c = &#39;&quot;&#39;
251 c = &#39;&quot;&#39;
243 c = &#39;&quot;&#39;
244 c = &#39;b&#39;
246 c = &#39;b&#39;
248 c = &#39;b&#39;
250 c = &#39;b&#39;
252 c = &#39;b&#39;
243 c = &#39;b&#39;
244 c = &#39;a&#39;
246 c = &#39;a&#39;
248 c = &#39;a&#39;
250 c = &#39;a&#39;
252 c = &#39;a&#39;
243 c = &#39;a&#39;
244 c = &#39;r&#39;
246 c = &#39;r&#39;
248 c = &#39;r&#39;
250 c = &#39;r&#39;
252 c = &#39;r&#39;
243 c = &#39;r&#39;
244 c = &#39;&quot;&#39;
246 c = &#39;&quot;&#39;
248 c = &#39;&quot;&#39;
250 c = &#39;&quot;&#39;
251 c = &#39;&quot;&#39;
243 c = &#39;&quot;&#39;
244 c = &#39;&gt;&#39;
246 c = &#39;&gt;&#39;
248 c = &#39;&gt;&#39;
249 c = &#39;&gt;&#39;
243 c = &#39;&gt;&#39;
244 c = &#39;&quot;&#39;
246 c = &#39;&quot;&#39;
248 c = &#39;&quot;&#39;
250 c = &#39;&quot;&#39;
252 c = &#39;&quot;&#39;
253 c = &#39;&quot;&#39;
243 c = &#39;&quot;&#39;
244 c = &#39;f&#39;
246 c = &#39;f&#39;
248 c = &#39;f&#39;
250 c = &#39;f&#39;
252 c = &#39;f&#39;
253 c = &#39;f&#39;
243 c = &#39;f&#39;
244 c = &#39;o&#39;
246 c = &#39;o&#39;
248 c = &#39;o&#39;
250 c = &#39;o&#39;
252 c = &#39;o&#39;
253 c = &#39;o&#39;
243 c = &#39;o&#39;
244 c = &#39;o&#39;
246 c = &#39;o&#39;
248 c = &#39;o&#39;
250 c = &#39;o&#39;
252 c = &#39;o&#39;
253 c = &#39;o&#39;
243 c = &#39;o&#39;
244 c = &#39;&quot;&#39;
246 c = &#39;&quot;&#39;
248 c = &#39;&quot;&#39;
250 c = &#39;&quot;&#39;
252 c = &#39;&quot;&#39;
253 c = &#39;&quot;&#39;
243 c = &#39;&quot;&#39;
244 c = &#39;&lt;&#39;
246 c = &#39;&lt;&#39;
247 c = &#39;&lt;&#39;
243 c = &#39;&lt;&#39;
244 c = &#39;/&#39;
246 c = &#39;/&#39;
248 c = &#39;/&#39;
250 c = &#39;/&#39;
252 c = &#39;/&#39;
243 c = &#39;/&#39;
244 c = &#39;b&#39;
246 c = &#39;b&#39;
248 c = &#39;b&#39;
250 c = &#39;b&#39;
252 c = &#39;b&#39;
243 c = &#39;b&#39;
244 c = &#39;&gt;&#39;
246 c = &#39;&gt;&#39;
248 c = &#39;&gt;&#39;
249 c = &#39;&gt;&#39;
243 c = &#39;&gt;&#39;
255 c = &#39;&gt;&#39;
255 c = &#39;&gt;&#39;
</pre></div>
</div>
</div>
</div>
<p>How fast is the static tracer compared with the dynamic tracer? This is the execution time of the above code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">static_tracer_execution_time</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.000814375001937151
</pre></div>
</div>
</div>
</div>
<p>Compare this with the equivalent dynamic tracer:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">line7</span> <span class="o">=</span> <span class="p">(</span><span class="n">remove_html_markup_starting_line_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">7</span>
<span class="n">line18</span> <span class="o">=</span> <span class="p">(</span><span class="n">remove_html_markup_starting_line_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">18</span>

<span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">EventTracer</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;line == </span><span class="si">{</span><span class="n">line7</span><span class="si">}</span><span class="s1"> or line == </span><span class="si">{</span><span class="n">line18</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
        <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&lt;b title=&quot;bar&quot;&gt;&quot;foo&quot;&lt;/b&gt;&#39;</span><span class="p">)</span>

<span class="n">dynamic_tracer_execution_time</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">()</span>
<span class="n">dynamic_tracer_execution_time</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # s = &#39;&lt;b title=&quot;bar&quot;&gt;&quot;foo&quot;&lt;/b&gt;&#39;, tag = False, quote = False, out = &#39;&#39;, c = &#39;&lt;&#39;, function = &#39;remove_html_markup&#39;, line = 244
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # tag = True, c = &#39;b&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # c = &#39; &#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # c = &#39;t&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # c = &#39;i&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # c = &#39;t&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # c = &#39;l&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # c = &#39;e&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # c = &#39;=&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # c = &#39;&quot;&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # quote = True, c = &#39;b&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # c = &#39;a&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # c = &#39;r&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # c = &#39;&quot;&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # quote = False, c = &#39;&gt;&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # tag = False, c = &#39;&quot;&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # out = &#39;&quot;&#39;, c = &#39;f&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # out = &#39;&quot;f&#39;, c = &#39;o&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # out = &#39;&quot;fo&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # out = &#39;&quot;foo&#39;, c = &#39;&quot;&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # out = &#39;&quot;foo&quot;&#39;, c = &#39;&lt;&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # tag = True, c = &#39;/&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # c = &#39;b&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # c = &#39;&gt;&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>244         assert tag or not quote
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # tag = False, line = 255
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>255     return out
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>remove_html_markup() returns &#39;&quot;foo&quot;&#39;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.025687707995530218
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dynamic_tracer_execution_time</span> <span class="o">/</span> <span class="n">static_tracer_execution_time</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>31.54284934388575
</pre></div>
</div>
</div>
</div>
<p>We see that the static tracker is several times faster – an advantage that will only increase further as more non-traced code is executed. If our code looks like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">some_extreme_function</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="o">...</span>  <span class="c1"># Long-running function</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>and we then execute it with</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">EventTracer</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;function==&#39;remove_html_markup&#39; and line == </span><span class="si">{</span><span class="n">line18</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
    <span class="n">some_extreme_function</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         # s = &#39;foo&#39;, tag = False, quote = False, out = &#39;foo&#39;, c = &#39;o&#39;, function = &#39;remove_html_markup&#39;, line = 255
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>255     return out
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>remove_html_markup() returns &#39;foo&#39;
</pre></div>
</div>
</div>
</div>
<p>we will spend quite some time.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">In the above example, where is the <code>EventTracer.traceit()</code> function called?</div>
    </p>
    <p>
    <div class="quiz_options" title="Check all that apply.">
    
        <input type="checkbox" name="be7aca82-b293-11f0-bed5-6298cf1a5790" id="be7aca82-b293-11f0-bed5-6298cf1a5790-1" onclick="clear_selection('be7aca82-b293-11f0-bed5-6298cf1a5790')">
        <label id="be7aca82-b293-11f0-bed5-6298cf1a5790-1-label" for="be7aca82-b293-11f0-bed5-6298cf1a5790-1">When <code>some_extreme_function()</code> returns</label><br>
    
        <input type="checkbox" name="be7aca82-b293-11f0-bed5-6298cf1a5790" id="be7aca82-b293-11f0-bed5-6298cf1a5790-2" onclick="clear_selection('be7aca82-b293-11f0-bed5-6298cf1a5790')">
        <label id="be7aca82-b293-11f0-bed5-6298cf1a5790-2-label" for="be7aca82-b293-11f0-bed5-6298cf1a5790-2">For each line of <code>some_extreme_function()</code></label><br>
    
        <input type="checkbox" name="be7aca82-b293-11f0-bed5-6298cf1a5790" id="be7aca82-b293-11f0-bed5-6298cf1a5790-3" onclick="clear_selection('be7aca82-b293-11f0-bed5-6298cf1a5790')">
        <label id="be7aca82-b293-11f0-bed5-6298cf1a5790-3-label" for="be7aca82-b293-11f0-bed5-6298cf1a5790-3">When <code>remove_html_markup()</code> returns</label><br>
    
        <input type="checkbox" name="be7aca82-b293-11f0-bed5-6298cf1a5790" id="be7aca82-b293-11f0-bed5-6298cf1a5790-4" onclick="clear_selection('be7aca82-b293-11f0-bed5-6298cf1a5790')">
        <label id="be7aca82-b293-11f0-bed5-6298cf1a5790-4-label" for="be7aca82-b293-11f0-bed5-6298cf1a5790-4">For each line of <code>remove_html_markup()</code></label><br>
    
    </div>
    </p>
    <input id="be7aca82-b293-11f0-bed5-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('be7aca82-b293-11f0-bed5-6298cf1a5790', 30, 1, '[ord(c) - 100 for c in \&#x27;efgh\&#x27;]')">
    <span class="quiz_hint" id="be7aca82-b293-11f0-bed5-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
<p>Indeed: Stepping line by line through some function can be pretty expensive, as every call, line, and return of <code class="docutils literal notranslate"><span class="pre">some_extreme_function()</span></code> and <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code> is tracked.</p>
<p>On the other hand, the static tracker is limited to conditions that refer to a <em>specific location in the code.</em> If we want to check whether some variable changes, for instance, we have to perform a (nontrivial) static analysis of the code to determine possible locations for a change. If a variable is changed indirectly through references or pointers (a common risk in system-level languages like C), there is no alternative to actually watching its value after each instruction.</p>
</section>
<section id="tracing-binary-executables">
<h2>Tracing Binary Executables<a class="headerlink" href="#tracing-binary-executables" title="Link to this heading">#</a></h2>
<p>Debuggers that act on binary code (say, code compiled from C) operate similarly as our “static” tracer: They take a location in the binary code and replace its instruction with a <em>break instruction</em> that interrupts execution, returning control to the debugger. The debugger then replaces the break instruction with the original instruction before resuming execution.</p>
<p>If the code cannot be altered (for instance, because it is in read-only memory), however, then debuggers resort to the “dynamic” tracing method, executing one instruction at a time and checking the program counter for its current value after each step.</p>
<p>To provide a minimum of efficient support, some processor architectures, such as x86, provide <em>hardware breakpoints</em>. Programmers (or more precisely, debugging tools) can define a set of specific values for the program counter to watch, and if the program counter reaches one of these values, execution is interrupted to return to the debugger. Likewise, <em>hardware watchpoints</em> will check specific memory locations at run time for changes and given values. There are also hardware watchpoints that break when a specific memory location is read from. Both hardware watchpoints and hardware breakpoints allow a limited tracking of stopping conditions while still maintaining original execution speed – and the best debugging tools will use a mix of static tracing, dynamic tracing, and hardware tracing.</p>
</section>
<section id="lessons-learned">
<h2>Lessons Learned<a class="headerlink" href="#lessons-learned" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Interpreted languages can provide <em>debugging hooks</em> that allow controlling program execution and access program state.</p></li>
<li><p>Tracing can be limited to specific conditions and events:</p>
<ul>
<li><p>A <em>breakpoint</em> is a condition referring to a particular location in the code.</p></li>
<li><p>A <em>watchpoint</em> is an event referring to a particular state change.</p></li>
</ul>
</li>
<li><p>Compiled languages allow <em>instrumenting</em> code at compile time, injecting code that allows handing over control to a tracing or debugging tool.</p></li>
</ul>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Link to this heading">#</a></h2>
<p>In the next chapter, we will see how to</p>
<ul class="simple">
<li><p><a class="reference internal" href="Debugger.html"><span class="std std-doc">leverage our tracing infrastructure for interactive debugging</span></a></p></li>
</ul>
</section>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">#</a></h2>
<p>Debugging interfaces like Python <code class="docutils literal notranslate"><span class="pre">sys.settrace()</span></code> are common in all programming languages that provide support for interactive debugging, providing support for executing programs step by step and inspecting program state along the way.</p>
<section id="low-level-debugging-interfaces">
<h3>Low-Level Debugging Interfaces<a class="headerlink" href="#low-level-debugging-interfaces" title="Link to this heading">#</a></h3>
<p>The first set of interfaces considered takes place at a <em>low level</em>, allowing access to <em>machine level</em> features. On Linux and other UNIX-like systems, the <a class="reference external" href="https://en.wikipedia.org/wiki/Ptrace">ptrace()</a> system call provides a means by which one process (the ‘tracer’) may observe and control the execution of another process (the ‘tracee’), and examine and change the tracee’s memory and registers.</p>
<p><code class="docutils literal notranslate"><span class="pre">ptrace()</span></code> is a low-level interface, which allows stepping over individual machine instructions and to read raw memory. In order to map instructions back to original statements and translate memory contents to variable values, compilers can include <em>debugging information</em> in the produced binaries, which debuggers then read out during a debugging session.</p>
</section>
<section id="high-level-debugging-interfaces">
<h3>High-Level Debugging Interfaces<a class="headerlink" href="#high-level-debugging-interfaces" title="Link to this heading">#</a></h3>
<p>The second set of interfaces allows accessing the program’s internals using the concepts of the program – i.e. variables and code locations, as Python does. The <a class="reference external" href="https://docs.oracle.com/javase/8/docs/jdk/api/jpda/jdi/">Java Debug Interface</a> (JDI) is a <em>high-level interface</em> for implementing a debugger (or tracer) on top of Java. <a class="reference external" href="https://www.baeldung.com/java-debug-interface">This introduction to JDI</a> shows how to build a debugger using this interface in a few steps.</p>
<p>For JavaScript, Mozilla’s <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Tools/Debugger-API">Debugger API</a> and Google’s <a class="reference external" href="https://developer.chrome.com/docs/extensions/reference/debugger/">chrome.debugger API</a> similarly allow tracing and inspecting program execution.</p>
</section>
</section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<section id="exercise-1-exception-handling">
<h3>Exercise 1: Exception Handling<a class="headerlink" href="#exercise-1-exception-handling" title="Link to this heading">#</a></h3>
<p>So far, we have only seen execution of lines in individual functions. But if a function raises an exception, we also may want to catch and report this. Right now, an exception is being raised right through our tracer, interrupting the trace.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">fail</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Tracer</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fail</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Calling fail()
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2     return 2 / 0
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>fail() returns None
</pre></div>
</div>
</div>
</div>
<p>Extend the <code class="docutils literal notranslate"><span class="pre">Tracer</span></code> class (or the <code class="docutils literal notranslate"><span class="pre">EventTracer</span></code> subclasses) such that exceptions (event type <code class="docutils literal notranslate"><span class="pre">'exception'</span></code>) are properly traced, too, say as</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fail</span><span class="p">()</span> <span class="n">raises</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span> <span class="n">division</span> <span class="n">by</span> <span class="n">zero</span>
</pre></div>
</div>
<p>See the Python documentation for <code class="docutils literal notranslate"><span class="pre">sys.settrace()</span></code>.</p>
<p><strong>Solution.</strong> Simply extend <code class="docutils literal notranslate"><span class="pre">print_debugger_status()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Tracer</span><span class="p">(</span><span class="n">Tracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">print_debugger_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;exception&#39;</span><span class="p">:</span>
            <span class="n">exception</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">arg</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="si">}</span><span class="s2">() &quot;</span>
                     <span class="sa">f</span><span class="s2">&quot;raises </span><span class="si">{</span><span class="n">exception</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">print_debugger_status</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Tracer</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fail</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Calling fail()
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2     return 2 / 0
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>fail() raises ZeroDivisionError: division by zero
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>fail() returns None
</pre></div>
</div>
</div>
</div>
</section>
<section id="exercise-2-syntax-based-instrumentation">
<h3>Exercise 2: Syntax-Based Instrumentation<a class="headerlink" href="#exercise-2-syntax-based-instrumentation" title="Link to this heading">#</a></h3>
<p>Adding instrumentation to source code is a complicated business, notably because it is not always easy to determine where and how to instrument. If a Python line starts with</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">condition</span><span class="p">:</span>
</pre></div>
</div>
<p>where should one insert code to instrument it?</p>
<p>A much more elegant way to instrument code is to add instrumentation <em>after the code has already been parsed</em>. Python code, like most other code, is first <em>parsed</em> into an intermediate tree-like structure (called an <em>abstract syntax tree</em>, or <em>AST</em>). This AST can then be inspected and manipulated, before a second step compiles it into low-level instruction sequences to be executed.</p>
<p>Let us start with an example. Here is an AST resulting from parsing a very simple piece of code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">foo</span><span class="p">():</span>  <span class="c1"># type: ignore</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">ret</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
<span class="n">print_content</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">foo</span>():  <span class=" -Color -Color-White"># type: ignore</span>
    ret = <span class=" -Color -Color-Blue">2</span> * <span class=" -Color -Color-Blue">2</span>
    <span class=" -Color -Color-Blue">return</span> ret
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">ast</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">show_ast</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_ast</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e7321428d24555987ef39f28199b769cabfef615f389753c5b5a996eac3fc9ab.svg" src="_images/e7321428d24555987ef39f28199b769cabfef615f389753c5b5a996eac3fc9ab.svg" />
</div>
</div>
<p>You see that the function <code class="docutils literal notranslate"><span class="pre">foo()</span></code> has a <code class="docutils literal notranslate"><span class="pre">FunctionDef</span></code> node with four children: The function name (<code class="docutils literal notranslate"><span class="pre">&quot;foo&quot;</span></code>), its arguments (<code class="docutils literal notranslate"><span class="pre">arguments</span></code>; currently empty), followed by the statements that make the function body – <code class="docutils literal notranslate"><span class="pre">Assign</span></code> for the assignment, <code class="docutils literal notranslate"><span class="pre">Return</span></code> for the <code class="docutils literal notranslate"><span class="pre">return</span></code> statement.</p>
<p>We obtain and manipulate the AST through the Python <code class="docutils literal notranslate"><span class="pre">ast</span></code> module. The <a class="reference external" href="http://docs.python.org/3/library/ast">official Python <code class="docutils literal notranslate"><span class="pre">ast</span></code> reference</a> is complete, but a bit brief; the documentation <a class="reference external" href="https://greentreesnakes.readthedocs.io/en/latest/">“Green Tree Snakes - the missing Python AST docs”</a> provides an excellent introduction.</p>
<p>To instrument the above code, we need to insert a new statement as a child to <code class="docutils literal notranslate"><span class="pre">FunctionDef</span></code> node.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ast</span><span class="w"> </span><span class="kn">import</span> <span class="n">NodeTransformer</span><span class="p">,</span> <span class="n">FunctionDef</span><span class="p">,</span> <span class="n">fix_missing_locations</span><span class="p">,</span> <span class="n">AST</span><span class="p">,</span> <span class="n">Module</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s the code we want to inject:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">subtree_to_be_injected</span><span class="p">:</span> <span class="n">AST</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;print(&#39;entering function&#39;)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_ast</span><span class="p">(</span><span class="n">subtree_to_be_injected</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8caff3974e03225e364695b67eeefcaee23be674ce08b18117f2cea1adf38f06.svg" src="_images/8caff3974e03225e364695b67eeefcaee23be674ce08b18117f2cea1adf38f06.svg" />
</div>
</div>
<p>The root of an <code class="docutils literal notranslate"><span class="pre">ast.parse()</span></code> tree actually is a <code class="docutils literal notranslate"><span class="pre">Module</span></code> node; we go directly to its child, which is the <code class="docutils literal notranslate"><span class="pre">Expr</span></code> node we want to inject.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">subtree_to_be_injected</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Module</span><span class="p">,</span> <span class="n">subtree_to_be_injected</span><span class="p">)</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>To inject the code, we use the <code class="docutils literal notranslate"><span class="pre">NodeTransformer</span></code> class as described in the Python <code class="docutils literal notranslate"><span class="pre">ast</span></code> documentation. We vist all function definitions (<code class="docutils literal notranslate"><span class="pre">FunctionDef</span></code>) and replace them with a new function definition in which the <code class="docutils literal notranslate"><span class="pre">body</span></code> gets an additional child – namely our subtree to be injected.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">InjectPass</span><span class="p">(</span><span class="n">NodeTransformer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_FunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">FunctionDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AST</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">FunctionDef</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="p">[</span><span class="n">subtree_to_be_injected</span><span class="p">]</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span>
            <span class="n">decorator_list</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">decorator_list</span><span class="p">,</span>
            <span class="n">returns</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">returns</span>
        <span class="p">)</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_tree</span> <span class="o">=</span> <span class="n">fix_missing_locations</span><span class="p">(</span><span class="n">InjectPass</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">tree</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>This is what our new tree looks like:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_ast</span><span class="p">(</span><span class="n">new_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/a1e71fc8b0b3a49d8c8ec36b416d70b934ef348ad26df828415b74c8787a634f.svg" src="_images/a1e71fc8b0b3a49d8c8ec36b416d70b934ef348ad26df828415b74c8787a634f.svg" />
</div>
</div>
<p>This is what the tree looks like when converted back to source code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_source</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">new_tree</span><span class="p">)</span>
<span class="n">print_content</span><span class="p">(</span><span class="n">new_source</span><span class="p">,</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">foo</span>():
    <span class=" -Color -Color-Cyan">print</span>(<span class=" -Color -Color-Yellow">&#39;entering function&#39;</span>)
    ret = <span class=" -Color -Color-Blue">2</span> * <span class=" -Color -Color-Blue">2</span>
    <span class=" -Color -Color-Blue">return</span> ret
</pre></div>
</div>
</div>
</div>
<p>We can now compile the new source into a function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exec</span><span class="p">(</span><span class="n">new_source</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>… and happily invoke our instrumented function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">foo</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>entering function
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4
</pre></div>
</div>
</div>
</div>
<p>Your task is to implement a function <code class="docutils literal notranslate"><span class="pre">insert_tracer_ast(function,</span> <span class="pre">breakpoints)</span></code> that works like <code class="docutils literal notranslate"><span class="pre">insert_tracer()</span></code>, above, except that it uses this AST-based mechanism to inject debugging code into the given function.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Intro_Debugging.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Introduction to Debugging</p>
      </div>
    </a>
    <a class="right-next"
       href="Debugger.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">How Debuggers Work</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tracing-python-programs">Tracing Python Programs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-tracer-class">A Tracer Class</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#accessing-source-code">Accessing Source Code</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tracing-calls-and-returns">Tracing Calls and Returns</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tracing-variable-changes">Tracing Variable Changes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conditional-tracing">Conditional Tracing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#watching-events">Watching Events</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#efficient-tracing">Efficient Tracing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tracing-binary-executables">Tracing Binary Executables</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#low-level-debugging-interfaces">Low-Level Debugging Interfaces</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#high-level-debugging-interfaces">High-Level Debugging Interfaces</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-exception-handling">Exercise 1: Exception Handling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-syntax-based-instrumentation">Exercise 2: Syntax-Based Instrumentation</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Andreas Zeller
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <div>
  Copyright &copy; 2021–2025 <a href="https://www.cispa.de/">CISPA Helmholtz Center for Information Security</a>.
  The <strong>content</strong> of this project is licensed under the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
  The <strong>source code</strong> that is part of the content, as well as the source code used to format and display that content is licensed under the <a href="https://github.com/uds-se/debuggingbook/blob/master/LICENSE.md#mit-license">MIT License</a>. <a href="https://cispa.de/en/impressum">Imprint</a>.
  <br>
  <a href="https://cispa.de/en/impressum">Imprint</a> &middot; <a href="/html/index.html#how-do-i-cite-your-work">Cite</a>
</div>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>