
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Tracking Failure Origins &#8212; The Debugging Book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=d5c2cecb" />
    <link rel="stylesheet" type="text/css" href="_static/mastodon-timeline.css?v=f82c2b23" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Slicer';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Reducing Failure-Inducing Inputs" href="DeltaDebugger.html" />
    <link rel="prev" title="Asserting Expectations" href="Assertions.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content"><p>This is a beta version of debuggingbook.org, currently in development. See the <a href="https://debuggingbook.org/classic/"  style="color:white!important;">classic site</a> for the 2024 version.</p></div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/debuggingbook.png" class="logo__image only-light" alt="The Debugging Book - Home"/>
    <script>document.write(`<img src="_static/debuggingbook.png" class="logo__image only-dark" alt="The Debugging Book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    The Debugging Book
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tours.html">Sitemap</a></li>
<li class="toctree-l1"><a class="reference internal" href="Intro_Debugging.html">Introduction to Debugging</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Observing Executions</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tracer.html">Tracing Executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="Debugger.html">How Debuggers Work</a></li>
<li class="toctree-l1"><a class="reference internal" href="Assertions.html">Asserting Expectations</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Flows and Dependencies</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Tracking Failure Origins</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Reducing Failure Causes</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="DeltaDebugger.html">Reducing Failure-Inducing Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ChangeDebugger.html">Isolating Failure-Inducing Changes</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Abstracting Failures</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="StatisticalDebugger.html">Statistical Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="DynamicInvariants.html">Mining Function Specifications</a></li>
<li class="toctree-l1"><a class="reference internal" href="DDSetDebugger.html">Generalizing Failure Circumstances</a></li>
<li class="toctree-l1"><a class="reference internal" href="Alhazen.html">Learning from Failures</a></li>
<li class="toctree-l1"><a class="reference internal" href="PerformanceDebugger.html">Debugging Performance Issues</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Automatic Repair</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Repairer.html">Repairing Code Automatically</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Debugging in the Large</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tracking.html">Tracking Bugs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ChangeCounter.html">Where the Bugs are</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ExpectError.html">Error Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timer.html">Timer</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timeout.html">Timeout</a></li>
<li class="toctree-l1"><a class="reference internal" href="ClassDiagram.html">Class Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="StackInspector.html">Inspecting Call Stacks</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">About This Book</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ReleaseNotes.html">Release Notes for The Debugging Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="Importing.html">Downloads and Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Guide_for_Authors.html">Guide for Authors</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/uds-se/debuggingbook/master?urlpath=tree/docs/notebooks/Slicer.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/uds-se/debuggingbook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/uds-se/debuggingbook/issues/new?title=Issue%20on%20page%20%2FSlicer.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
    <li><a href="../code/Slicer.py" target="_blank"
       class="btn btn-sm btn-download-source-button dropdown-item"
       title="Download Python code"
       data-bs-placement="left" data-bs-toggle="tooltip"
    >
  

    <span class="btn__icon-container">
      <i class="fas fa-file"></i>
      </span>
    <span class="btn__text-container">.py</span>
    </a>
    </li>
    
      
      
      
      <li><a href="_sources/Slicer.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download notebook"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  
    <li><a href="Importing.html" target="_blank"
       class="btn btn-sm btn-download-source-button dropdown-item"
       title="All downloads"
       data-bs-placement="left" data-bs-toggle="tooltip"
    >
  

    <span class="btn__icon-container">
      <i class="fas fa-file"></i>
      </span>
    <span class="btn__text-container">All downloads</span>
    </a>
    </li>
    </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Tracking Failure Origins</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dependencies">Dependencies</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-visualizing-dependencies">Excursion: Visualizing Dependencies</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#a-class-for-dependencies">A Class for Dependencies</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#drawing-dependencies">Drawing Dependencies</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#slices">Slices</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#end-of-excursion">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-dependencies">Data Dependencies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#control-dependencies">Control Dependencies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dependency-graphs">Dependency Graphs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#showing-dependencies-with-code">Showing Dependencies with Code</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-listing-dependencies">Excursion: Listing Dependencies</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">End of Excursion</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Slices</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tracking-techniques">Tracking Techniques</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#wrapping-data-objects">Wrapping Data Objects</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#wrapping-data-accesses">Wrapping Data Accesses</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-data-tracker">A Data Tracker</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#instrumenting-source-code">Instrumenting Source Code</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tracking-variable-accesses">Tracking Variable Accesses</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-tracking-assignments-and-assertions">Excursion: Tracking Assignments and Assertions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-tracking-return-values">Excursion: Tracking Return Values</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-tracking-control">Excursion: Tracking Control</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-tracking-calls-and-arguments">Excursion: Tracking Calls and Arguments</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-tracking-parameters">Excursion: Tracking Parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-transformer-stress-test">Excursion: Transformer Stress Test</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tracking-dependencies">Tracking Dependencies</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">Data Dependencies</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-variables">Reading Variables</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-locations">Checking Locations</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-variables">Setting Variables</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-control-dependencies">Excursion: Control Dependencies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-calls-and-returns">Excursion: Calls and Returns</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-function-arguments">Excursion: Function Arguments</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-diagnostics">Excursion: Diagnostics</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#slicing-code">Slicing Code</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#an-instrumenter-base-class">An Instrumenter Base Class</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-slicer-class">The Slicer Class</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#diagnostics">Diagnostics</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#more-examples">More Examples</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#square-root">Square Root</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#removing-html-markup">Removing HTML Markup</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calls-and-augmented-assign">Calls and Augmented Assign</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dynamic-instrumentation">Dynamic Instrumentation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-dynamic-instrumentation">Excursion: Implementing Dynamic Instrumentation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#more-applications">More Applications</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#verifying-information-flows">Verifying Information Flows</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assessing-test-quality">Assessing Test Quality</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-in-statistical-debugging">Use in Statistical Debugging</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#things-that-do-not-work">Things that do not Work</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-control-slices">Exercise 1: Control Slices</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-incremental-exploration">Exercise 2: Incremental Exploration</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3-forward-slicing">Exercise 3: Forward Slicing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-4-code-with-forward-dependencies">Exercise 4: Code with Forward Dependencies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-5-flow-assertions">Exercise 5: Flow Assertions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-6-checked-coverage">Exercise 6: Checked Coverage</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="tracking-failure-origins">
<h1>Tracking Failure Origins<a class="headerlink" href="#tracking-failure-origins" title="Link to this heading">#</a></h1>
<p>The question of “Where does this value come from?” is fundamental for debugging. Which earlier variables could possibly have influenced the current erroneous state? And how did their values come to be?</p>
<p>When programmers read code during debugging, they scan it for potential <em>origins</em> of given values. This can be a tedious experience, notably, if the origins spread across multiple separate locations, possibly even in different modules. In this chapter, we thus investigate means to <em>determine such origins</em> automatically – by collecting data and control dependencies during program execution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">YouTubeVideo</span>
<span class="n">YouTubeVideo</span><span class="p">(</span><span class="s2">&quot;sjf3cOR0lcI&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <iframe
            width="640"
            height="360"
            src="https://www.youtube-nocookie.com/embed/sjf3cOR0lcI"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
<p><strong>Prerequisites</strong></p>
<ul class="simple">
<li><p>You should have read the <a class="reference internal" href="Intro_Debugging.html"><span class="doc std std-doc">Introduction to Debugging</span></a>.</p></li>
<li><p>To understand how to compute dependencies automatically (the second half of this chapter), you will need</p>
<ul>
<li><p>advanced knowledge of Python semantics</p></li>
<li><p>knowledge on how to instrument and transform code</p></li>
<li><p>knowledge on how an interpreter works</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">bookutils.setup</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">quiz</span><span class="p">,</span> <span class="n">next_inputs</span><span class="p">,</span> <span class="n">print_content</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
</div>
<section id="synopsis">
<h2>Synopsis<a class="headerlink" href="#synopsis" title="Link to this heading">#</a></h2>
<p>To <a class="reference internal" href="Importing.html"><span class="std std-doc">use the code provided in this chapter</span></a>, write</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">debuggingbook.Slicer</span><span class="w"> </span><span class="kn">import</span> <span class="o">&lt;</span><span class="n">identifier</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>and then make use of the following features.</p>
<p><strong>Note</strong>: The examples in this section only work after the rest of the cells have been executed.</p>
<p>This chapter provides a <code class="docutils literal notranslate"><span class="pre">Slicer</span></code> class to automatically determine and visualize dynamic flows and dependencies. When we say that a variable <span class="math notranslate nohighlight">\(x\)</span> <em>depends</em> on a variable <span class="math notranslate nohighlight">\(y\)</span> (and that <span class="math notranslate nohighlight">\(y\)</span> <em>flows</em> into <span class="math notranslate nohighlight">\(x\)</span>), we distinguish two kinds of dependencies:</p>
<ul class="simple">
<li><p><strong>Data dependency</strong>: <span class="math notranslate nohighlight">\(x\)</span> is assigned a value computed from <span class="math notranslate nohighlight">\(y\)</span>.</p></li>
<li><p><strong>Control dependency</strong>: A statement involving <span class="math notranslate nohighlight">\(x\)</span> is executed <em>only</em> because a <em>condition</em> involving <span class="math notranslate nohighlight">\(y\)</span> was evaluated, influencing the execution path.</p></li>
</ul>
<p>Such dependencies are crucial for debugging, as they allow determininh the origins of individual values (and notably incorrect values).</p>
<p>To determine dynamic dependencies in a function <code class="docutils literal notranslate"><span class="pre">func</span></code>, use</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Slicer</span><span class="p">()</span> <span class="k">as</span> <span class="n">slicer</span><span class="p">:</span>
    <span class="o">&lt;</span><span class="n">Some</span> <span class="n">call</span> <span class="n">to</span> <span class="n">func</span><span class="p">()</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>and then <code class="docutils literal notranslate"><span class="pre">slicer.graph()</span></code> or <code class="docutils literal notranslate"><span class="pre">slicer.code()</span></code> to examine dependencies.</p>
<p>You can also explicitly specify the functions to be instrumented, as in</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Slicer</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">func_1</span><span class="p">,</span> <span class="n">func_2</span><span class="p">)</span> <span class="k">as</span> <span class="n">slicer</span><span class="p">:</span>
    <span class="o">&lt;</span><span class="n">Some</span> <span class="n">call</span> <span class="n">to</span> <span class="n">func</span><span class="p">()</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Here is an example. The <code class="docutils literal notranslate"><span class="pre">demo()</span></code> function computes some number from <code class="docutils literal notranslate"><span class="pre">x</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">demo</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">while</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">z</span> <span class="o">&lt;=</span> <span class="mi">64</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">*=</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">z</span>
</pre></div>
</div>
</div>
</div>
<p>By using <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">Slicer()</span></code>, we first instrument <code class="docutils literal notranslate"><span class="pre">demo()</span></code> and then execute it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Slicer</span><span class="p">()</span> <span class="k">as</span> <span class="n">slicer</span><span class="p">:</span>
    <span class="n">demo</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/2454789564.py:22: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(id), value],
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/3554319793.py:4: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(id), Name(id=id, ctx=Load())],
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:12: DeprecationWarning: ast.Num is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords=[keyword(arg=&#39;pos&#39;, value=ast.Num(n + 1))]
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:19: DeprecationWarning: ast.NameConstant is deprecated and will be removed in Python 3.14; use ast.Constant instead
  value=ast.NameConstant(value=True)))
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:25: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(child.arg),
</pre></div>
</div>
</div>
</div>
<p>After execution is complete, you can output <code class="docutils literal notranslate"><span class="pre">slicer</span></code> to visualize the dependencies and flows as graph. Data dependencies are shown as black solid edges; control dependencies are shown as grey dashed edges. The arrows indicate influence: If <span class="math notranslate nohighlight">\(y\)</span> depends on <span class="math notranslate nohighlight">\(x\)</span> (and thus <span class="math notranslate nohighlight">\(x\)</span> flows into <span class="math notranslate nohighlight">\(y\)</span>), then we have an arrow <span class="math notranslate nohighlight">\(x \rightarrow y\)</span>.
We see how the parameter <code class="docutils literal notranslate"><span class="pre">x</span></code> flows into <code class="docutils literal notranslate"><span class="pre">z</span></code>, which is returned after some computation that is control dependent on a <code class="docutils literal notranslate"><span class="pre">&lt;test&gt;</span></code> involving <code class="docutils literal notranslate"><span class="pre">z</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">slicer</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7c1b13ce998e0690592477e4185217c82fec47bdc35a9124c5018d7ab346e55f.svg" src="_images/7c1b13ce998e0690592477e4185217c82fec47bdc35a9124c5018d7ab346e55f.svg" />
</div>
</div>
<p>An alternate representation is <code class="docutils literal notranslate"><span class="pre">slicer.code()</span></code>, annotating the instrumented source code with (backward) dependencies. Data dependencies are shown with <code class="docutils literal notranslate"><span class="pre">&lt;=</span></code>, control dependencies with <code class="docutils literal notranslate"><span class="pre">&lt;-</span></code>; locations (lines) are shown in parentheses.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">slicer</span><span class="o">.</span><span class="n">code</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     1 <span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">demo</span>(x: <span class=" -Color -Color-Cyan">int</span>) -&gt; <span class=" -Color -Color-Cyan">int</span>:
*    2     z = x  <span class=" -Color -Color-White"># &lt;= x (5)</span>
*    3     <span class=" -Color -Color-Blue">while</span> x &lt;= z &lt;= <span class=" -Color -Color-Blue">64</span>:  <span class=" -Color -Color-White"># &lt;= z (2), x (5), z (4)</span>
*    4         z *= <span class=" -Color -Color-Blue">2</span>  <span class=" -Color -Color-White"># &lt;= z (2), z (4); &lt;- &lt;test&gt; (3)</span>
*    5     <span class=" -Color -Color-Blue">return</span> z  <span class=" -Color -Color-White"># &lt;= z (4)</span>
</pre></div>
</div>
</div>
</div>
<p>Dependencies can also be retrieved programmatically. The <code class="docutils literal notranslate"><span class="pre">dependencies()</span></code> method returns a <code class="docutils literal notranslate"><span class="pre">Dependencies</span></code> object encapsulating the dependency graph.</p>
<p>The method <code class="docutils literal notranslate"><span class="pre">all_vars()</span></code> returns all variables in the dependency graph. Each variable is encoded as a pair (<em>name</em>, <em>location</em>) where <em>location</em> is a pair (<em>codename</em>, <em>lineno</em>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">slicer</span><span class="o">.</span><span class="n">dependencies</span><span class="p">()</span><span class="o">.</span><span class="n">all_vars</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{(&#39;&lt;demo() return value&gt;&#39;, (&lt;function __main__.demo(x: int) -&gt; int&gt;, 5)),
 (&#39;&lt;test&gt;&#39;, (&lt;function __main__.demo(x: int) -&gt; int&gt;, 3)),
 (&#39;x&#39;, (&lt;function __main__.demo(x: int) -&gt; int&gt;, 5)),
 (&#39;z&#39;, (&lt;function __main__.demo(x: int) -&gt; int&gt;, 2)),
 (&#39;z&#39;, (&lt;function __main__.demo(x: int) -&gt; int&gt;, 4))}
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">code()</span></code> and <code class="docutils literal notranslate"><span class="pre">graph()</span></code> methods can also be applied on dependencies. The method <code class="docutils literal notranslate"><span class="pre">backward_slice(var)</span></code> returns a backward slice for the given variable (again given as a pair (<em>name</em>, <em>location</em>)). To retrieve where <code class="docutils literal notranslate"><span class="pre">z</span></code> in Line 2 came from, use:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">start_demo</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcelines</span><span class="p">(</span><span class="n">demo</span><span class="p">)</span>
<span class="n">start_demo</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">slicer</span><span class="o">.</span><span class="n">dependencies</span><span class="p">()</span><span class="o">.</span><span class="n">backward_slice</span><span class="p">((</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">demo</span><span class="p">,</span> <span class="n">start_demo</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">graph</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8843647aff775b59a2c840aab2d824b8026dfaa1d36d7bd85c60356ddf6d9d12.svg" src="_images/8843647aff775b59a2c840aab2d824b8026dfaa1d36d7bd85c60356ddf6d9d12.svg" />
</div>
</div>
<p>Here are the classes defined in this chapter. A <code class="docutils literal notranslate"><span class="pre">Slicer</span></code> instruments a program, using a <code class="docutils literal notranslate"><span class="pre">DependencyTracker</span></code> at run time to collect <code class="docutils literal notranslate"><span class="pre">Dependencies</span></code>.</p>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 14.0.2 (20251019.1705)
 -->
<!-- Pages: 1 -->
<svg width="544pt" height="895pt"
 viewBox="0.00 0.00 544.00 895.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 891.25)">
<g id="a_graph0"><a xlink:title="Slicer class hierarchy">
<polygon fill="white" stroke="none" points="-4,4 -4,-891.25 539.62,-891.25 539.62,4 -4,4"/>
</a>
</g>
<!-- Slicer -->
<g id="node1" class="node">
<title>Slicer</title>
<g id="a_node1"><a xlink:href="#" xlink:title="class Slicer:&#10;Track dependencies in an execution">
<polygon fill="none" stroke="black" points="0,-30 0,-254.5 190,-254.5 190,-30 0,-30"/>
<text xml:space="preserve" text-anchor="start" x="76.25" y="-238.2" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">Slicer</text>
<polyline fill="none" stroke="black" points="0,-229.25 190,-229.25"/>
<g id="a_node1_0"><a xlink:href="#" xlink:title="Slicer">
<g id="a_node1_1"><a xlink:href="#" xlink:title="__init__(self, *items_to_instrument: Any, dependency_tracker: Optional[DependencyTracker] = None, globals: Optional[Dict[str, Any]] = None, log: Union[bool, int] = False):&#10;Create a slicer.&#10;`items_to_instrument` are Python functions or modules with source code.&#10;`dependency_tracker` is the tracker to be used (default: DependencyTracker).&#10;`globals` is the namespace to be used(default: caller&#39;s `globals()`)&#10;`log`=True or `log` &gt; 0 turns on logging">
<text xml:space="preserve" text-anchor="start" x="8" y="-216.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node1_2"><a xlink:href="#" xlink:title="_repr_mimebundle_(self, include: Any = None, exclude: Any = None) &#45;&gt; Any:&#10;If the object is output in Jupyter, render dependencies as a SVG graph">
<text xml:space="preserve" text-anchor="start" x="8" y="-204" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">_repr_mimebundle_()</text>
</a>
</g>
<g id="a_node1_3"><a xlink:href="#" xlink:title="code(self, *args: Any, **kwargs: Any) &#45;&gt; None:&#10;Show code of instrumented items, annotated with dependencies.">
<text xml:space="preserve" text-anchor="start" x="8" y="-191.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">code()</text>
</a>
</g>
<g id="a_node1_4"><a xlink:href="#" xlink:title="dependencies(self) &#45;&gt; Dependencies:&#10;Return collected dependencies.">
<text xml:space="preserve" text-anchor="start" x="8" y="-178.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">dependencies()</text>
</a>
</g>
<g id="a_node1_5"><a xlink:href="#" xlink:title="graph(self, *args: Any, **kwargs: Any) &#45;&gt; graphviz.graphs.Digraph:&#10;Show dependency graph.">
<text xml:space="preserve" text-anchor="start" x="8" y="-165.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">graph()</text>
</a>
</g>
<g id="a_node1_6"><a xlink:href="#" xlink:title="calls_in_our_with_block(self) &#45;&gt; Set[str]:&#10;Return a set of function names called in the `with` block.">
<text xml:space="preserve" text-anchor="start" x="8" y="-152" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">calls_in_our_with_block()</text>
</a>
</g>
<g id="a_node1_7"><a xlink:href="#" xlink:title="default_items_to_instrument(self) &#45;&gt; List[Callable]">
<text xml:space="preserve" text-anchor="start" x="8" y="-140.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">default_items_to_instrument()</text>
</a>
</g>
<g id="a_node1_8"><a xlink:href="#" xlink:title="execute(self, tree: ast.AST, item: Any) &#45;&gt; None:&#10;Compile and execute `tree`. May be extended in subclasses.">
<text xml:space="preserve" text-anchor="start" x="8" y="-127.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">execute()</text>
</a>
</g>
<g id="a_node1_9"><a xlink:href="#" xlink:title="funcs_in_our_with_block(self) &#45;&gt; List[Callable]">
<text xml:space="preserve" text-anchor="start" x="8" y="-113.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">funcs_in_our_with_block()</text>
</a>
</g>
<g id="a_node1_10"><a xlink:href="#" xlink:title="instrument(self, item: Any) &#45;&gt; Any:&#10;Instrument `item`, transforming its source code, and re&#45;defining it.">
<text xml:space="preserve" text-anchor="start" x="8" y="-102" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">instrument()</text>
</a>
</g>
<g id="a_node1_11"><a xlink:href="#" xlink:title="our_with_block(self) &#45;&gt; ast.With:&#10;Return the currently active `with` block.">
<text xml:space="preserve" text-anchor="start" x="8" y="-88.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">our_with_block()</text>
</a>
</g>
<g id="a_node1_12"><a xlink:href="#" xlink:title="parse(self, item: Any) &#45;&gt; ast.AST:&#10;Parse `item`, returning its AST">
<text xml:space="preserve" text-anchor="start" x="8" y="-75.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">parse()</text>
</a>
</g>
<g id="a_node1_13"><a xlink:href="#" xlink:title="restore(self) &#45;&gt; None:&#10;Restore original code.">
<text xml:space="preserve" text-anchor="start" x="8" y="-63.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">restore()</text>
</a>
</g>
<g id="a_node1_14"><a xlink:href="#" xlink:title="transform(self, tree: ast.AST) &#45;&gt; ast.AST:&#10;Apply transformers on `tree`. May be extended in subclasses.">
<text xml:space="preserve" text-anchor="start" x="8" y="-51" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">transform()</text>
</a>
</g>
<g id="a_node1_15"><a xlink:href="#" xlink:title="transformers(self) &#45;&gt; List[ast.NodeTransformer]:&#10;List of transformers to apply. To be extended in subclasses.">
<text xml:space="preserve" text-anchor="start" x="8" y="-38.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">transformers()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- Instrumenter -->
<g id="node2" class="node">
<title>Instrumenter</title>
<g id="a_node2"><a xlink:href="#" xlink:title="class Instrumenter:&#10;Instrument functions for dynamic tracking">
<polygon fill="none" stroke="black" points="18,-458.88 18,-568.62 208,-568.62 208,-458.88 18,-458.88"/>
<text xml:space="preserve" text-anchor="start" x="71" y="-552.33" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-style="italic" font-size="14.00" fill="#6a0dad">Instrumenter</text>
<polyline fill="none" stroke="black" points="18,-543.38 208,-543.38"/>
<g id="a_node2_16"><a xlink:href="#" xlink:title="Instrumenter">
<g id="a_node2_17"><a xlink:href="#" xlink:title="__enter__(self) &#45;&gt; Any:&#10;Instrument sources">
<text xml:space="preserve" text-anchor="start" x="26" y="-530.88" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__enter__()</text>
</a>
</g>
<g id="a_node2_18"><a xlink:href="#" xlink:title="__exit__(self, exc_type: Type, exc_value: BaseException, traceback: traceback) &#45;&gt; Optional[bool]:&#10;Restore sources">
<text xml:space="preserve" text-anchor="start" x="26" y="-518.12" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__exit__()</text>
</a>
</g>
<g id="a_node2_19"><a xlink:href="#" xlink:title="__init__(self, *items_to_instrument: Callable, globals: Optional[Dict[str, Any]] = None, log: Union[bool, int] = False) &#45;&gt; None:&#10;Create an instrumenter.&#10;`items_to_instrument` is a list of items to instrument.&#10;`globals` is a namespace to use (default: caller&#39;s globals())">
<text xml:space="preserve" text-anchor="start" x="26" y="-505.38" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node2_20"><a xlink:href="#" xlink:title="instrument(self, item: Any) &#45;&gt; Any:&#10;Instrument `item`. To be overloaded in subclasses.">
<text xml:space="preserve" text-anchor="start" x="26" y="-492.62" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">instrument()</text>
</a>
</g>
<g id="a_node2_21"><a xlink:href="#" xlink:title="default_items_to_instrument(self) &#45;&gt; List[Callable]">
<text xml:space="preserve" text-anchor="start" x="26" y="-479.88" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">default_items_to_instrument()</text>
</a>
</g>
<g id="a_node2_22"><a xlink:href="#" xlink:title="restore(self) &#45;&gt; None">
<text xml:space="preserve" text-anchor="start" x="26" y="-467.12" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">restore()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- Slicer&#45;&gt;Instrumenter -->
<g id="edge1" class="edge">
<title>Slicer&#45;&gt;Instrumenter</title>
<path fill="none" stroke="black" d="M100.44,-254.86C103.5,-317.71 107.22,-394.01 109.81,-447.25"/>
<polygon fill="none" stroke="black" points="106.31,-447.25 110.29,-457.07 113.3,-446.91 106.31,-447.25"/>
</g>
<!-- StackInspector -->
<g id="node3" class="node">
<title>StackInspector</title>
<g id="a_node3"><a xlink:href="StackInspector.ipynb" xlink:title="class StackInspector:&#10;Provide functions to inspect the stack">
<polygon fill="none" stroke="black" points="211,-743.5 211,-886.75 377,-886.75 377,-743.5 211,-743.5"/>
<text xml:space="preserve" text-anchor="start" x="244.88" y="-870.45" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-style="italic" font-size="14.00" fill="#6a0dad">StackInspector</text>
<polyline fill="none" stroke="black" points="211,-861.5 377,-861.5"/>
<g id="a_node3_23"><a xlink:href="#" xlink:title="StackInspector">
<g id="a_node3_24"><a xlink:href="StackInspector.ipynb" xlink:title="_generated_function_cache = {(&#39;&lt;module&gt;&#39;, 2): &lt;function &lt;module&gt; at 0x10d9f5300&gt;, (&#39;&lt;module&gt;&#39;, 1): &lt;function &lt;module&gt; at 0x10d9f54e0&gt;, (&#39;&lt;module&gt;&#39;, 3): &lt;function &lt;module&gt; at 0x10e60cfe0&gt;, (&#39;&lt;module&gt;&#39;, 4): &lt;function &lt;module&gt; at 0x10e60d440&gt;}">
<text xml:space="preserve" text-anchor="start" x="219" y="-848" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">_generated_function_cache</text>
</a>
</g>
</a>
</g>
<polyline fill="none" stroke="black" points="211,-840.75 377,-840.75"/>
<g id="a_node3_25"><a xlink:href="#" xlink:title="StackInspector">
<g id="a_node3_26"><a xlink:href="StackInspector.ipynb" xlink:title="caller_frame(self) &#45;&gt; frame:&#10;Return the frame of the caller.">
<text xml:space="preserve" text-anchor="start" x="243" y="-828.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">caller_frame()</text>
</a>
</g>
<g id="a_node3_27"><a xlink:href="StackInspector.ipynb" xlink:title="caller_function(self) &#45;&gt; Callable:&#10;Return the calling function">
<text xml:space="preserve" text-anchor="start" x="243" y="-815.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">caller_function()</text>
</a>
</g>
<g id="a_node3_28"><a xlink:href="StackInspector.ipynb" xlink:title="caller_globals(self) &#45;&gt; Dict[str, Any]:&#10;Return the globals() environment of the caller.">
<text xml:space="preserve" text-anchor="start" x="243" y="-802.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">caller_globals()</text>
</a>
</g>
<g id="a_node3_29"><a xlink:href="StackInspector.ipynb" xlink:title="caller_locals(self) &#45;&gt; Dict[str, Any]:&#10;Return the locals() environment of the caller.">
<text xml:space="preserve" text-anchor="start" x="243" y="-790" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">caller_locals()</text>
</a>
</g>
<g id="a_node3_30"><a xlink:href="StackInspector.ipynb" xlink:title="caller_location(self) &#45;&gt; Tuple[Callable, int]:&#10;Return the location (func, lineno) of the caller.">
<text xml:space="preserve" text-anchor="start" x="243" y="-777.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">caller_location()</text>
</a>
</g>
<g id="a_node3_31"><a xlink:href="StackInspector.ipynb" xlink:title="search_frame(self, name: str, frame: Optional[frame] = None) &#45;&gt; Tuple[Optional[frame], Optional[Callable]]:&#10;Return a pair (`frame`, `item`)&#10;in which the function `name` is defined as `item`.">
<text xml:space="preserve" text-anchor="start" x="243" y="-764.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">search_frame()</text>
</a>
</g>
<g id="a_node3_32"><a xlink:href="StackInspector.ipynb" xlink:title="search_func(self, name: str, frame: Optional[frame] = None) &#45;&gt; Optional[Callable]:&#10;Search in callers for a definition of the function `name`">
<text xml:space="preserve" text-anchor="start" x="243" y="-751.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">search_func()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- Instrumenter&#45;&gt;StackInspector -->
<g id="edge2" class="edge">
<title>Instrumenter&#45;&gt;StackInspector</title>
<path fill="none" stroke="black" d="M144.17,-568.91C166.59,-607.59 197.74,-660.75 226,-707 231.27,-715.63 236.84,-724.61 242.43,-733.53"/>
<polygon fill="none" stroke="black" points="239.4,-735.29 247.68,-741.89 245.32,-731.56 239.4,-735.29"/>
</g>
<!-- DependencyTracker -->
<g id="node4" class="node">
<title>DependencyTracker</title>
<g id="a_node4"><a xlink:href="#" xlink:title="class DependencyTracker:&#10;Track dependencies during execution">
<polygon fill="none" stroke="black" points="208,-0.5 208,-284 398,-284 398,-0.5 208,-0.5"/>
<text xml:space="preserve" text-anchor="start" x="235.88" y="-267.7" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">DependencyTracker</text>
<polyline fill="none" stroke="black" points="208,-258.75 398,-258.75"/>
<g id="a_node4_33"><a xlink:href="#" xlink:title="DependencyTracker">
<g id="a_node4_34"><a xlink:href="#" xlink:title="TEST = &#39;&lt;test&gt;&#39;">
<text xml:space="preserve" text-anchor="start" x="291" y="-245.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">TEST</text>
</a>
</g>
</a>
</g>
<polyline fill="none" stroke="black" points="208,-238 398,-238"/>
<g id="a_node4_35"><a xlink:href="#" xlink:title="DependencyTracker">
<g id="a_node4_36"><a xlink:href="#" xlink:title="__enter__(self) &#45;&gt; Any:&#10;Track entering an if/while/for block">
<text xml:space="preserve" text-anchor="start" x="216" y="-225.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__enter__()</text>
</a>
</g>
<g id="a_node4_37"><a xlink:href="#" xlink:title="__exit__(self, exc_type: Type, exc_value: BaseException, traceback: traceback) &#45;&gt; Optional[bool]:&#10;Track exiting an if/while/for block">
<text xml:space="preserve" text-anchor="start" x="216" y="-212.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__exit__()</text>
</a>
</g>
<g id="a_node4_38"><a xlink:href="#" xlink:title="__init__(self, *args: Any, **kwargs: Any) &#45;&gt; None:&#10;Constructor. Arguments are passed to DataTracker.__init__()">
<text xml:space="preserve" text-anchor="start" x="216" y="-200" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node4_39"><a xlink:href="#" xlink:title="arg(self, value: Any, pos: Optional[int] = None, kw: Optional[str] = None) &#45;&gt; Any:&#10;Track passing an argument `value`&#10;(with given position `pos` 1..n or keyword `kw`)">
<text xml:space="preserve" text-anchor="start" x="216" y="-187.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">arg()</text>
</a>
</g>
<g id="a_node4_40"><a xlink:href="#" xlink:title="call(self, func: Callable) &#45;&gt; Callable:&#10;Track a call of function `func`">
<text xml:space="preserve" text-anchor="start" x="216" y="-174.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">call()</text>
</a>
</g>
<g id="a_node4_41"><a xlink:href="#" xlink:title="get(self, name: str, value: Any) &#45;&gt; Any:&#10;Track a read access for variable `name` with value `value`">
<text xml:space="preserve" text-anchor="start" x="216" y="-161.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">get()</text>
</a>
</g>
<g id="a_node4_42"><a xlink:href="#" xlink:title="param(self, name: str, value: Any, pos: Optional[int] = None, vararg: str = &#39;&#39;, last: bool = False) &#45;&gt; Any:&#10;Track getting a parameter `name` with value `value`&#10;(with given position `pos`).&#10;vararg parameters are indicated by setting `varargs` to&#10;&#39;*&#39; (*args) or &#39;**&#39; (**kwargs)">
<text xml:space="preserve" text-anchor="start" x="216" y="-149" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">param()</text>
</a>
</g>
<g id="a_node4_43"><a xlink:href="#" xlink:title="ret(self, value: Any) &#45;&gt; Any:&#10;Track a function return">
<text xml:space="preserve" text-anchor="start" x="216" y="-136.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">ret()</text>
</a>
</g>
<g id="a_node4_44"><a xlink:href="#" xlink:title="set(self, name: str, value: Any, loads: Optional[Set[str]] = None) &#45;&gt; Any:&#10;Add a dependency for `name` = `value`">
<text xml:space="preserve" text-anchor="start" x="216" y="-123.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">set()</text>
</a>
</g>
<g id="a_node4_45"><a xlink:href="#" xlink:title="test(self, value: Any) &#45;&gt; Any:&#10;Track a test for condition `value`">
<text xml:space="preserve" text-anchor="start" x="216" y="-110.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">test()</text>
</a>
</g>
<g id="a_node4_46"><a xlink:href="#" xlink:title="call_generator(self, func: Callable) &#45;&gt; Callable:&#10;Track a call of a generator function">
<text xml:space="preserve" text-anchor="start" x="216" y="-97" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">call_generator()</text>
</a>
</g>
<g id="a_node4_47"><a xlink:href="#" xlink:title="check_location(self) &#45;&gt; None:&#10;If we are in a new location, clear set of read variables">
<text xml:space="preserve" text-anchor="start" x="216" y="-84.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">check_location()</text>
</a>
</g>
<g id="a_node4_48"><a xlink:href="#" xlink:title="clear_read(self) &#45;&gt; None:&#10;Clear set of read variables">
<text xml:space="preserve" text-anchor="start" x="216" y="-71.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">clear_read()</text>
</a>
</g>
<g id="a_node4_49"><a xlink:href="#" xlink:title="dependencies(self) &#45;&gt; Dependencies:&#10;Return dependencies">
<text xml:space="preserve" text-anchor="start" x="216" y="-58.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">dependencies()</text>
</a>
</g>
<g id="a_node4_50"><a xlink:href="#" xlink:title="ignore_location_change(self) &#45;&gt; None">
<text xml:space="preserve" text-anchor="start" x="216" y="-46" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">ignore_location_change()</text>
</a>
</g>
<g id="a_node4_51"><a xlink:href="#" xlink:title="ignore_next_location_change(self) &#45;&gt; None">
<text xml:space="preserve" text-anchor="start" x="216" y="-33.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">ignore_next_location_change()</text>
</a>
</g>
<g id="a_node4_52"><a xlink:href="#" xlink:title="in_generator(self) &#45;&gt; bool:&#10;True if we are calling a generator function">
<text xml:space="preserve" text-anchor="start" x="216" y="-20.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">in_generator()</text>
</a>
</g>
<g id="a_node4_53"><a xlink:href="#" xlink:title="ret_generator(self, generator: Any) &#45;&gt; Any:&#10;Track the return of a generator function">
<text xml:space="preserve" text-anchor="start" x="216" y="-7.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">ret_generator()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- DataTracker -->
<g id="node5" class="node">
<title>DataTracker</title>
<g id="a_node5"><a xlink:href="#" xlink:title="class DataTracker:&#10;Track data accesses during execution">
<polygon fill="none" stroke="black" points="235,-420.62 235,-606.88 353,-606.88 353,-420.62 235,-420.62"/>
<text xml:space="preserve" text-anchor="start" x="253.5" y="-590.58" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">DataTracker</text>
<polyline fill="none" stroke="black" points="235,-581.62 353,-581.62"/>
<g id="a_node5_54"><a xlink:href="#" xlink:title="DataTracker">
<g id="a_node5_55"><a xlink:href="#" xlink:title="__enter__(self) &#45;&gt; Any:&#10;Enter `with` block. To be overloaded in subclasses.">
<text xml:space="preserve" text-anchor="start" x="243" y="-569.12" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__enter__()</text>
</a>
</g>
<g id="a_node5_56"><a xlink:href="#" xlink:title="__exit__(self, exc_type: Type, exc_value: BaseException, traceback: traceback) &#45;&gt; Optional[bool]:&#10;Exit `with` block. To be overloaded in subclasses.">
<text xml:space="preserve" text-anchor="start" x="243" y="-556.38" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__exit__()</text>
</a>
</g>
<g id="a_node5_57"><a xlink:href="#" xlink:title="__init__(self, log: bool = False) &#45;&gt; None:&#10;Constructor. If `log` is set, turn on logging.">
<text xml:space="preserve" text-anchor="start" x="243" y="-543.62" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node5_58"><a xlink:href="#" xlink:title="arg(self, value: Any, pos: Optional[int] = None, kw: Optional[str] = None) &#45;&gt; Any:&#10;Track `value` being passed as argument.&#10;`pos` (if given) is the argument position (starting with 1).&#10;`kw` (if given) is the argument keyword.">
<text xml:space="preserve" text-anchor="start" x="243" y="-530.88" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">arg()</text>
</a>
</g>
<g id="a_node5_59"><a xlink:href="#" xlink:title="augment(self, name: str, value: Any) &#45;&gt; Any:&#10;Track augmenting `name` with `value`.&#10;To be overloaded in subclasses.">
<text xml:space="preserve" text-anchor="start" x="243" y="-518.12" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">augment()</text>
</a>
</g>
<g id="a_node5_60"><a xlink:href="#" xlink:title="call(self, func: Callable) &#45;&gt; Callable:&#10;Track a call to `func`.">
<text xml:space="preserve" text-anchor="start" x="243" y="-505.38" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">call()</text>
</a>
</g>
<g id="a_node5_61"><a xlink:href="#" xlink:title="get(self, name: str, value: Any) &#45;&gt; Any:&#10;Track getting `value` from `name`.">
<text xml:space="preserve" text-anchor="start" x="243" y="-492.62" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">get()</text>
</a>
</g>
<g id="a_node5_62"><a xlink:href="#" xlink:title="param(self, name: str, value: Any, pos: Optional[int] = None, vararg: str = &#39;&#39;, last: bool = False) &#45;&gt; Any:&#10;At the beginning of a function, track parameter `name` being set to `value`.&#10;`pos` is the position of the argument (starting with 1).&#10;`vararg` is &quot;*&quot; if `name` is a vararg parameter (as in *args),&#10;and &quot;**&quot; is `name` is a kwargs parameter (as in *kwargs).&#10;`last` is True if `name` is the last parameter.">
<text xml:space="preserve" text-anchor="start" x="243" y="-479.88" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">param()</text>
</a>
</g>
<g id="a_node5_63"><a xlink:href="#" xlink:title="ret(self, value: Any) &#45;&gt; Any:&#10;Track `value` being used as return value.">
<text xml:space="preserve" text-anchor="start" x="243" y="-467.12" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">ret()</text>
</a>
</g>
<g id="a_node5_64"><a xlink:href="#" xlink:title="set(self, name: str, value: Any, loads: Optional[Set[str]] = None) &#45;&gt; Any:&#10;Track setting `name` to `value`.">
<text xml:space="preserve" text-anchor="start" x="243" y="-454.38" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">set()</text>
</a>
</g>
<g id="a_node5_65"><a xlink:href="#" xlink:title="test(self, cond: ast.AST) &#45;&gt; ast.AST:&#10;Test condition `cond`. To be overloaded in subclasses.">
<text xml:space="preserve" text-anchor="start" x="243" y="-441.62" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">test()</text>
</a>
</g>
<g id="a_node5_66"><a xlink:href="#" xlink:title="instrument_call(self, func: Callable) &#45;&gt; Callable:&#10;Instrument a call to `func`. To be implemented in subclasses.">
<text xml:space="preserve" text-anchor="start" x="243" y="-428.88" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">instrument_call()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- DependencyTracker&#45;&gt;DataTracker -->
<g id="edge3" class="edge">
<title>DependencyTracker&#45;&gt;DataTracker</title>
<path fill="none" stroke="black" d="M299.57,-284.26C298.56,-325.73 297.47,-370.31 296.53,-408.99"/>
<polygon fill="none" stroke="black" points="293.03,-408.67 296.29,-418.75 300.03,-408.84 293.03,-408.67"/>
</g>
<!-- DataTracker&#45;&gt;StackInspector -->
<g id="edge4" class="edge">
<title>DataTracker&#45;&gt;StackInspector</title>
<path fill="none" stroke="black" d="M294,-607.02C294,-646.89 294,-693.17 294,-731.86"/>
<polygon fill="none" stroke="black" points="290.5,-731.56 294,-741.56 297.5,-731.56 290.5,-731.56"/>
</g>
<!-- Dependencies -->
<g id="node6" class="node">
<title>Dependencies</title>
<g id="a_node6"><a xlink:href="#" xlink:title="class Dependencies:&#10;A dependency graph">
<polygon fill="none" stroke="black" points="371,-321 371,-706.5 501,-706.5 501,-321 371,-321"/>
<text xml:space="preserve" text-anchor="start" x="388" y="-690.2" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="14.00" fill="#6a0dad">Dependencies</text>
<polyline fill="none" stroke="black" points="371,-681.25 501,-681.25"/>
<g id="a_node6_67"><a xlink:href="#" xlink:title="Dependencies">
<g id="a_node6_68"><a xlink:href="#" xlink:title="FONT_NAME = &#39;Courier&#39;">
<text xml:space="preserve" text-anchor="start" x="406" y="-667.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">FONT_NAME</text>
</a>
</g>
<g id="a_node6_69"><a xlink:href="#" xlink:title="NODE_COLOR = &#39;peachpuff&#39;">
<text xml:space="preserve" text-anchor="start" x="406" y="-655" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">NODE_COLOR</text>
</a>
</g>
</a>
</g>
<polyline fill="none" stroke="black" points="371,-647.75 501,-647.75"/>
<g id="a_node6_70"><a xlink:href="#" xlink:title="Dependencies">
<g id="a_node6_71"><a xlink:href="#" xlink:title="__init__(self, data: Optional[Dict[Tuple[str, Tuple[Callable, int]], Set[Tuple[str, Tuple[Callable, int]]]]] = None, control: Optional[Dict[Tuple[str, Tuple[Callable, int]], Set[Tuple[str, Tuple[Callable, int]]]]] = None) &#45;&gt; None:&#10;Create a dependency graph from `data` and `control`.&#10;Both `data` and `control` are dictionaries&#10;holding _nodes_ as keys and sets of nodes as values.&#10;Each node comes as a tuple (variable_name, location)&#10;where `variable_name` is a string&#10;and `location` is a pair (function, lineno)&#10;where `function` is a callable and `lineno` is a line number&#10;denoting a unique location in the code.">
<text xml:space="preserve" text-anchor="start" x="379" y="-635.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node6_72"><a xlink:href="#" xlink:title="__repr__(self) &#45;&gt; str:&#10;Represent dependencies as a Python expression">
<text xml:space="preserve" text-anchor="start" x="379" y="-622.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__repr__()</text>
</a>
</g>
<g id="a_node6_73"><a xlink:href="#" xlink:title="__str__(self) &#45;&gt; str:&#10;Return string representation of dependencies">
<text xml:space="preserve" text-anchor="start" x="379" y="-609.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__str__()</text>
</a>
</g>
<g id="a_node6_74"><a xlink:href="#" xlink:title="_repr_mimebundle_(self, include: Any = None, exclude: Any = None) &#45;&gt; Any:&#10;If the object is output in Jupyter, render dependencies as a SVG graph">
<text xml:space="preserve" text-anchor="start" x="379" y="-597" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">_repr_mimebundle_()</text>
</a>
</g>
<g id="a_node6_75"><a xlink:href="#" xlink:title="all_functions(self) &#45;&gt; Dict[Callable, List[Tuple[int, Tuple[str, Tuple[Callable, int]]]]]:&#10;Return mapping&#10;{`function`: [(`lineno`, `var`), (`lineno`, `var`), ...], ...}&#10;for all functions in the dependencies.">
<text xml:space="preserve" text-anchor="start" x="379" y="-584.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">all_functions()</text>
</a>
</g>
<g id="a_node6_76"><a xlink:href="#" xlink:title="all_vars(self) &#45;&gt; Set[Tuple[str, Tuple[Callable, int]]]:&#10;Return a set of all variables (as `var_name`, `location`) in the dependencies">
<text xml:space="preserve" text-anchor="start" x="379" y="-571.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">all_vars()</text>
</a>
</g>
<g id="a_node6_77"><a xlink:href="#" xlink:title="backward_slice(self, *criteria: Union[str, Tuple[Callable, int], Tuple[str, Tuple[Callable, int]]], mode: str = &#39;cd&#39;, depth: int = &#45;1) &#45;&gt; Dependencies:&#10;Create a backward slice from nodes `criteria`.&#10;`mode` can contain &#39;c&#39; (draw control dependencies)&#10;and &#39;d&#39; (draw data dependencies) (default: &#39;cd&#39;)">
<text xml:space="preserve" text-anchor="start" x="379" y="-558.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">backward_slice()</text>
</a>
</g>
<g id="a_node6_78"><a xlink:href="#" xlink:title="code(self, *items: Callable, mode: str = &#39;cd&#39;) &#45;&gt; None:&#10;List `items` on standard output, including dependencies as comments.&#10;If `items` is empty, all included functions are listed.&#10;`mode` can contain &#39;c&#39; (draw control dependencies) and &#39;d&#39; (draw data dependencies)&#10;(default: &#39;cd&#39;).">
<text xml:space="preserve" text-anchor="start" x="379" y="-546" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">code()</text>
</a>
</g>
<g id="a_node6_79"><a xlink:href="#" xlink:title="graph(self, *, mode: str = &#39;flow&#39;) &#45;&gt; graphviz.graphs.Digraph:&#10;Draw dependencies. `mode` is either&#10;* `&#39;flow&#39;`: arrows indicate information flow (from A to B); or&#10;* `&#39;depend&#39;`: arrows indicate dependencies (B depends on A)">
<text xml:space="preserve" text-anchor="start" x="379" y="-533.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">graph()</text>
</a>
</g>
<g id="a_node6_80"><a xlink:href="#" xlink:title="_code(self, item: Callable, mode: str) &#45;&gt; None">
<text xml:space="preserve" text-anchor="start" x="379" y="-519.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">_code()</text>
</a>
</g>
<g id="a_node6_81"><a xlink:href="#" xlink:title="_source(self, node: Tuple[str, Tuple[Callable, int]]) &#45;&gt; str">
<text xml:space="preserve" text-anchor="start" x="379" y="-506.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">_source()</text>
</a>
</g>
<g id="a_node6_82"><a xlink:href="#" xlink:title="add_hierarchy(self, g: graphviz.graphs.Digraph) &#45;&gt; graphviz.graphs.Digraph:&#10;Add invisible edges for a proper hierarchy.">
<text xml:space="preserve" text-anchor="start" x="379" y="-494" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">add_hierarchy()</text>
</a>
</g>
<g id="a_node6_83"><a xlink:href="#" xlink:title="draw_dependencies(self, g: graphviz.graphs.Digraph, mode: str) &#45;&gt; None">
<text xml:space="preserve" text-anchor="start" x="379" y="-481.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">draw_dependencies()</text>
</a>
</g>
<g id="a_node6_84"><a xlink:href="#" xlink:title="draw_edge(self, g: graphviz.graphs.Digraph, mode: str, node_from: str, node_to: str, **kwargs: Any) &#45;&gt; None">
<text xml:space="preserve" text-anchor="start" x="379" y="-468.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">draw_edge()</text>
</a>
</g>
<g id="a_node6_85"><a xlink:href="#" xlink:title="expand_criteria(self, criteria: List[Union[str, Tuple[Callable, int], Tuple[str, Tuple[Callable, int]]]]) &#45;&gt; List[Tuple[str, Tuple[Callable, int]]]:&#10;Return list of vars matched by `criteria`.">
<text xml:space="preserve" text-anchor="start" x="379" y="-455.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">expand_criteria()</text>
</a>
</g>
<g id="a_node6_86"><a xlink:href="#" xlink:title="format_var(self, var: Tuple[str, Tuple[Callable, int]], current_func: Optional[Callable] = None) &#45;&gt; str:&#10;Return string for `var` in `current_func`.">
<text xml:space="preserve" text-anchor="start" x="379" y="-443" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">format_var()</text>
</a>
</g>
<g id="a_node6_87"><a xlink:href="#" xlink:title="id(self, var: Tuple[str, Tuple[Callable, int]]) &#45;&gt; str:&#10;Return a unique ID for `var`.">
<text xml:space="preserve" text-anchor="start" x="379" y="-430.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">id()</text>
</a>
</g>
<g id="a_node6_88"><a xlink:href="#" xlink:title="label(self, var: Tuple[str, Tuple[Callable, int]]) &#45;&gt; str:&#10;Render node `var` using HTML style.">
<text xml:space="preserve" text-anchor="start" x="379" y="-417.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">label()</text>
</a>
</g>
<g id="a_node6_89"><a xlink:href="#" xlink:title="make_graph(self, name: str = &#39;dependencies&#39;, comment: str = &#39;Dependencies&#39;) &#45;&gt; graphviz.graphs.Digraph">
<text xml:space="preserve" text-anchor="start" x="379" y="-404.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">make_graph()</text>
</a>
</g>
<g id="a_node6_90"><a xlink:href="#" xlink:title="repr_dependencies(self, vars: Dict[Tuple[str, Tuple[Callable, int]], Set[Tuple[str, Tuple[Callable, int]]]]) &#45;&gt; str">
<text xml:space="preserve" text-anchor="start" x="379" y="-392" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">repr_dependencies()</text>
</a>
</g>
<g id="a_node6_91"><a xlink:href="#" xlink:title="repr_deps(self, var_set: Set[Tuple[str, Tuple[Callable, int]]]) &#45;&gt; str">
<text xml:space="preserve" text-anchor="start" x="379" y="-379.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">repr_deps()</text>
</a>
</g>
<g id="a_node6_92"><a xlink:href="#" xlink:title="repr_var(self, var: Tuple[str, Tuple[Callable, int]]) &#45;&gt; str">
<text xml:space="preserve" text-anchor="start" x="379" y="-366.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">repr_var()</text>
</a>
</g>
<g id="a_node6_93"><a xlink:href="#" xlink:title="source(self, node: Tuple[str, Tuple[Callable, int]]) &#45;&gt; str:&#10;Return the source code for a given node.">
<text xml:space="preserve" text-anchor="start" x="379" y="-353.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">source()</text>
</a>
</g>
<g id="a_node6_94"><a xlink:href="#" xlink:title="tooltip(self, var: Tuple[str, Tuple[Callable, int]]) &#45;&gt; str:&#10;Return a tooltip for node `var`.">
<text xml:space="preserve" text-anchor="start" x="379" y="-341" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">tooltip()</text>
</a>
</g>
<g id="a_node6_95"><a xlink:href="#" xlink:title="validate(self) &#45;&gt; None:&#10;Perform a simple syntactic validation of dependencies">
<text xml:space="preserve" text-anchor="start" x="379" y="-328.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">validate()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- Dependencies&#45;&gt;StackInspector -->
<g id="edge5" class="edge">
<title>Dependencies&#45;&gt;StackInspector</title>
<path fill="none" stroke="black" d="M370.55,-689.37C367.75,-695.36 364.9,-701.25 362,-707 357.61,-715.72 352.7,-724.63 347.58,-733.41"/>
<polygon fill="none" stroke="black" points="344.61,-731.55 342.51,-741.94 350.63,-735.13 344.61,-731.55"/>
</g>
<!-- Legend -->
<g id="node7" class="node">
<title>Legend</title>
<text xml:space="preserve" text-anchor="start" x="416.38" y="-158.25" font-family="Raleway, Helvetica, Arial, sans-serif" font-weight="bold" font-size="10.00" fill="#6a0dad">Legend</text>
<text xml:space="preserve" text-anchor="start" x="416.38" y="-148.25" font-family="Raleway, Helvetica, Arial, sans-serif" font-size="10.00">• </text>
<text xml:space="preserve" text-anchor="start" x="422.38" y="-148.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="8.00">public_method()</text>
<text xml:space="preserve" text-anchor="start" x="416.38" y="-138.25" font-family="Raleway, Helvetica, Arial, sans-serif" font-size="10.00">• </text>
<text xml:space="preserve" text-anchor="start" x="422.38" y="-138.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="8.00">private_method()</text>
<text xml:space="preserve" text-anchor="start" x="416.38" y="-128.25" font-family="Raleway, Helvetica, Arial, sans-serif" font-size="10.00">• </text>
<text xml:space="preserve" text-anchor="start" x="422.38" y="-128.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="8.00">overloaded_method()</text>
<text xml:space="preserve" text-anchor="start" x="416.38" y="-119.2" font-family="Helvetica,sans-Serif" font-size="9.00">Hover over names to see doc</text>
</g>
</g>
</svg>
</div></div>
</div>
</section>
<section id="dependencies">
<h2>Dependencies<a class="headerlink" href="#dependencies" title="Link to this heading">#</a></h2>
<p>In the <a class="reference internal" href="Intro_Debugging.html"><span class="std std-doc">Introduction to debugging</span></a>, we have seen how faults in a program state propagate to eventually become visible as failures. This induces a debugging strategy called <em>tracking origins</em>:</p>
<ol class="arabic simple">
<li><p>We start with a single faulty state <em>f</em> – the failure.</p></li>
<li><p>We determine <em>f</em>’s <em>origins</em> – the parts of earlier states that could have caused the faulty state <em>f</em>.</p></li>
<li><p>For each of these origins <em>e</em>, we determine whether they are faulty or not.</p></li>
<li><p>For each of the faulty origins, we in turn determine <em>their</em> origins.</p></li>
<li><p>If we find a part of the state that is faulty, yet has only correct origins, we have found the defect.</p></li>
</ol>
<p>In all generality, a “part of the state” can be anything that can influence the program – some configuration setting, some database content, or the state of a device. Almost always, though, it is through <em>individual variables</em> that a part of the state manifests itself.</p>
<p>The good news is that variables do not take arbitrary values at arbitrary times – instead, they are set and accessed at precise moments in time, as determined by the program’s semantics. This allows us to determine their <em>origins</em> by reading program code.</p>
<p>Let us assume you have a piece of code that reads as follows. The <code class="docutils literal notranslate"><span class="pre">middle()</span></code> function is supposed to return the “middle” number of three values <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, and <code class="docutils literal notranslate"><span class="pre">z</span></code> – that is, the one number that neither is the minimum nor the maximum.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">middle</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">z</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">y</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y</span>
        <span class="k">elif</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">z</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">y</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y</span>
        <span class="k">elif</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">z</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">z</span>
</pre></div>
</div>
</div>
</div>
<p>In most cases, <code class="docutils literal notranslate"><span class="pre">middle()</span></code> runs just fine:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">middle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">m</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2
</pre></div>
</div>
</div>
</div>
<p>In others, however, it returns the wrong value:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">middle</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">m</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
</div>
</div>
<p>This is a typical debugging situation: You see a value that is erroneous; and you want to find out where it came from.</p>
<ul class="simple">
<li><p>In our case, we see that the erroneous value was returned from <code class="docutils literal notranslate"><span class="pre">middle()</span></code>, so we identify the five <code class="docutils literal notranslate"><span class="pre">return</span></code> statements in <code class="docutils literal notranslate"><span class="pre">middle()</span></code> that the value could have come from.</p></li>
<li><p>The value returned is the value of <code class="docutils literal notranslate"><span class="pre">y</span></code>, and neither <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, nor <code class="docutils literal notranslate"><span class="pre">z</span></code> are altered during the execution of <code class="docutils literal notranslate"><span class="pre">middle()</span></code>. Hence, it must be one of the three <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">y</span></code> statements that is the origin of <code class="docutils literal notranslate"><span class="pre">m</span></code>. But which one?</p></li>
</ul>
<p>For our small example, we can fire up an interactive debugger and simply step through the function; this reveals us the conditions evaluated and the <code class="docutils literal notranslate"><span class="pre">return</span></code> statement executed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">Debugger</span>  <span class="c1"># minor dependency</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Debugger</span><span class="o">.</span><span class="n">Debugger</span><span class="p">():</span>
    <span class="n">middle</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Calling middle(x = 2, y = 1, z = 3)
</pre></div>
</div>
<div class="output text_html"><samp>(debugger) <b>step</b></samp></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2     if y &lt; z:
</pre></div>
</div>
<div class="output text_html"><samp>(debugger) <b>step</b></samp></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3         if x &lt; y:
</pre></div>
</div>
<div class="output text_html"><samp>(debugger) <b>step</b></samp></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5         elif x &lt; z:
</pre></div>
</div>
<div class="output text_html"><samp>(debugger) <b>step</b></samp></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6             return y
</pre></div>
</div>
<div class="output text_html"><samp>(debugger) <b>quit</b></samp></div></div>
</div>
<p>We now see that it was the second <code class="docutils literal notranslate"><span class="pre">return</span></code> statement that returned the incorrect value. But why was it executed after all? To this end, we can resort to the <code class="docutils literal notranslate"><span class="pre">middle()</span></code> source code and have a look at those conditions that caused the <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">y</span></code> statement to be executed. Indeed, the conditions <code class="docutils literal notranslate"><span class="pre">y</span> <span class="pre">&lt;</span> <span class="pre">z</span></code>, <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">&gt;</span> <span class="pre">y</span></code>, and finally <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">&lt;</span> <span class="pre">z</span></code> again are <em>origins</em> of the returned value – and in turn have <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, and <code class="docutils literal notranslate"><span class="pre">z</span></code> as origins.</p>
<p>In our above reasoning about origins, we have encountered two kinds of origins:</p>
<ul class="simple">
<li><p>earlier <em>data values</em> (such as the value of <code class="docutils literal notranslate"><span class="pre">y</span></code> being returned) and</p></li>
<li><p>earlier <em>control conditions</em> (such as the <code class="docutils literal notranslate"><span class="pre">if</span></code> conditions governing the <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">y</span></code> statement).</p></li>
</ul>
<p>The later parts of the state that can be influenced by such origins are said to be <em>dependent</em> on these origins. Speaking of variables, a variable <span class="math notranslate nohighlight">\(x\)</span> <em>depends</em> on the value of a variable <span class="math notranslate nohighlight">\(y\)</span> (written as <span class="math notranslate nohighlight">\(x \leftarrow y\)</span>) if a change in <span class="math notranslate nohighlight">\(y\)</span> could affect the value of <span class="math notranslate nohighlight">\(x\)</span>.</p>
<p>We distinguish two kinds of dependencies <span class="math notranslate nohighlight">\(x \leftarrow y\)</span>, aligned with the two kinds of origins as outlined above:</p>
<ul class="simple">
<li><p><strong>Data dependency</strong>: <span class="math notranslate nohighlight">\(x\)</span> is assigned a value computed from <span class="math notranslate nohighlight">\(y\)</span>. In our example, <code class="docutils literal notranslate"><span class="pre">m</span></code> is data dependent on the return value of <code class="docutils literal notranslate"><span class="pre">middle()</span></code>.</p></li>
<li><p><strong>Control dependency</strong>: A statement involving <span class="math notranslate nohighlight">\(x\)</span> is executed <em>only</em> because a <em>condition</em> involving <span class="math notranslate nohighlight">\(y\)</span> was evaluated, influencing the execution path. In our example, the value returned by <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">y</span></code> is control dependent on the several conditions along its path, which involve <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, and <code class="docutils literal notranslate"><span class="pre">z</span></code>.</p></li>
</ul>
<p>Let us examine these dependencies in more detail.</p>
<section id="excursion-visualizing-dependencies">
<h3>Excursion: Visualizing Dependencies<a class="headerlink" href="#excursion-visualizing-dependencies" title="Link to this heading">#</a></h3>
<p>Note: This is an excursion, diverting away from the main flow of the chapter. Unless you know what you are doing, you are encouraged to skip this part.</p>
<p>To illustrate our examples, we introduce a <code class="docutils literal notranslate"><span class="pre">Dependencies</span></code> class that captures dependencies between variables at specific locations.</p>
<section id="a-class-for-dependencies">
<h4>A Class for Dependencies<a class="headerlink" href="#a-class-for-dependencies" title="Link to this heading">#</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">Dependencies</span></code> holds two dependency graphs. <code class="docutils literal notranslate"><span class="pre">data</span></code> holds data dependencies, <code class="docutils literal notranslate"><span class="pre">control</span></code> holds control dependencies.</p>
<p>Each of the two is organized as a dictionary holding <em>nodes</em> as keys and sets of nodes as values. Each node comes as a tuple</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">variable_name</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">variable_name</span></code> is a string and <code class="docutils literal notranslate"><span class="pre">location</span></code> is a pair</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>
</pre></div>
</div>
<p>denoting a unique location in the code.</p>
<p>This is also reflected in the following type definitions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Location</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
<span class="n">Node</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Location</span><span class="p">]</span>
<span class="n">Dependency</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Node</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="n">Node</span><span class="p">]]</span>
</pre></div>
</div>
</div>
</div>
<p>In this chapter, for many purposes, we need to lookup a function’s location, source code, or simply definition. The class <code class="docutils literal notranslate"><span class="pre">StackInspector</span></code> provides a number of convenience functions for this purpose.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">StackInspector</span><span class="w"> </span><span class="kn">import</span> <span class="n">StackInspector</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Dependencies</span></code> class builds on <code class="docutils literal notranslate"><span class="pre">StackInspector</span></code> to capture dependencies.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Dependencies</span><span class="p">(</span><span class="n">StackInspector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A dependency graph&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dependency</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">control</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dependency</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a dependency graph from `data` and `control`.</span>
<span class="sd">        Both `data` and `control` are dictionaries</span>
<span class="sd">        holding _nodes_ as keys and sets of nodes as values.</span>
<span class="sd">        Each node comes as a tuple (variable_name, location)</span>
<span class="sd">        where `variable_name` is a string </span>
<span class="sd">        and `location` is a pair (function, lineno)</span>
<span class="sd">        where `function` is a callable and `lineno` is a line number</span>
<span class="sd">        denoting a unique location in the code.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">control</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">control</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control</span> <span class="o">=</span> <span class="n">control</span>

        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">validate()</span></code> method checks for consistency.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Dependencies</span><span class="p">(</span><span class="n">Dependencies</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check dependency structure.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">var_name</span><span class="p">,</span> <span class="n">location</span> <span class="o">=</span> <span class="n">node</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="n">func</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="n">location</span>
            <span class="k">assert</span> <span class="nb">callable</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lineno</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">source()</span></code> method returns the source code for a given node.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Dependencies</span><span class="p">(</span><span class="n">Dependencies</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># Return source line, or &#39;&#39;</span>
        <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span> <span class="o">=</span> <span class="n">node</span>
        <span class="n">func</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="n">location</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">func</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
            <span class="c1"># No source</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">source_lines</span><span class="p">,</span> <span class="n">first_lineno</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcelines</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Couldn&#39;t find source &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;for </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">source_lines</span><span class="p">[</span><span class="n">lineno</span> <span class="o">-</span> <span class="n">first_lineno</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>

        <span class="k">return</span> <span class="n">line</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the source code for a given node.&quot;&quot;&quot;</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">line</span>

        <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span> <span class="o">=</span> <span class="n">node</span>
        <span class="n">func</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="n">location</span>
        <span class="n">code_name</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="k">if</span> <span class="n">code_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">code_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;</span><span class="si">{</span><span class="n">code_name</span><span class="si">}</span><span class="s1">()&gt;&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_deps</span> <span class="o">=</span> <span class="n">Dependencies</span><span class="p">()</span>
<span class="n">test_deps</span><span class="o">.</span><span class="n">source</span><span class="p">((</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">middle</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;def middle(x, y, z):  # type: ignore&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="drawing-dependencies">
<h4>Drawing Dependencies<a class="headerlink" href="#drawing-dependencies" title="Link to this heading">#</a></h4>
<p>Both data and control form a graph between nodes, and can be visualized as such. We use the <code class="docutils literal notranslate"><span class="pre">graphviz</span></code> package for creating such visualizations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">graphviz</span><span class="w"> </span><span class="kn">import</span> <span class="n">Digraph</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">make_graph()</span></code> sets the basic graph attributes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">html</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Dependencies</span><span class="p">(</span><span class="n">Dependencies</span><span class="p">):</span>
    <span class="n">NODE_COLOR</span> <span class="o">=</span> <span class="s1">&#39;peachpuff&#39;</span>
    <span class="n">FONT_NAME</span> <span class="o">=</span> <span class="s1">&#39;Courier&#39;</span>  <span class="c1"># &#39;Fira Mono&#39; may produce warnings in &#39;dot&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                   <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;dependencies&quot;</span><span class="p">,</span>
                   <span class="n">comment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Dependencies&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Digraph</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Digraph</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">,</span>
            <span class="n">graph_attr</span><span class="o">=</span><span class="p">{</span>
            <span class="p">},</span>
            <span class="n">node_attr</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;style&#39;</span><span class="p">:</span> <span class="s1">&#39;filled&#39;</span><span class="p">,</span>
                <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="s1">&#39;box&#39;</span><span class="p">,</span>
                <span class="s1">&#39;fillcolor&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">NODE_COLOR</span><span class="p">,</span>
                <span class="s1">&#39;fontname&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">FONT_NAME</span>
            <span class="p">},</span>
            <span class="n">edge_attr</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;fontname&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">FONT_NAME</span>
            <span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">graph()</span></code> returns a graph visualization.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Dependencies</span><span class="p">(</span><span class="n">Dependencies</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;flow&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Digraph</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Draw dependencies. `mode` is either</span>
<span class="sd">        * `&#39;flow&#39;`: arrows indicate information flow (from A to B); or</span>
<span class="sd">        * `&#39;depend&#39;`: arrows indicate dependencies (B depends on A)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_graph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">draw_dependencies</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_hierarchy</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">g</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_repr_mimebundle_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;If the object is output in Jupyter, render dependencies as a SVG graph&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">()</span><span class="o">.</span><span class="n">_repr_mimebundle_</span><span class="p">(</span><span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The main part of graph drawing takes place in two methods, <code class="docutils literal notranslate"><span class="pre">draw_dependencies()</span></code> and <code class="docutils literal notranslate"><span class="pre">add_hierarchy()</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">draw_dependencies()</span></code> processes through the graph, adding nodes and edges from the dependencies.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Dependencies</span><span class="p">(</span><span class="n">Dependencies</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">all_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="n">Node</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a set of all variables (as `var_name`, `location`) in the dependencies&quot;&quot;&quot;</span>
        <span class="n">all_vars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">all_vars</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">var</span><span class="p">]:</span>
                <span class="n">all_vars</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="p">:</span>
            <span class="n">all_vars</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="p">[</span><span class="n">var</span><span class="p">]:</span>
                <span class="n">all_vars</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">all_vars</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Dependencies</span><span class="p">(</span><span class="n">Dependencies</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">draw_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g</span><span class="p">:</span> <span class="n">Digraph</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">node_from</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">node_to</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;flow&#39;</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">node_from</span><span class="p">,</span> <span class="n">node_to</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;depend&#39;</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">node_from</span><span class="p">,</span> <span class="n">node_to</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="s2">&quot;back&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`mode` must be &#39;flow&#39; or &#39;depend&#39;&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">draw_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g</span><span class="p">:</span> <span class="n">Digraph</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_vars</span><span class="p">():</span>
            <span class="n">g</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="n">var</span><span class="p">),</span>
                   <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">var</span><span class="p">),</span>
                   <span class="n">tooltip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tooltip</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">var</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">draw_edge</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="n">source</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="p">[</span><span class="n">var</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">draw_edge</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="n">source</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="n">var</span><span class="p">),</span>
                                   <span class="n">style</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">draw_dependencies()</span></code> makes use of a few helper functions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Dependencies</span><span class="p">(</span><span class="n">Dependencies</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a unique ID for `var`.&quot;&quot;&quot;</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># Avoid non-identifier characters</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">repr</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">isalnum</span><span class="p">()</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="p">:</span>
                <span class="nb">id</span> <span class="o">+=</span> <span class="n">c</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;:&#39;</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;,&#39;</span><span class="p">:</span>
                <span class="nb">id</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span>
        <span class="k">return</span> <span class="nb">id</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Render node `var` using HTML style.&quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span> <span class="o">=</span> <span class="n">var</span>
        <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

        <span class="n">title</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">):</span>
            <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&lt;I&gt;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1">&lt;/I&gt;&#39;</span>

        <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&lt;B&gt;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1">&lt;/B&gt;&#39;</span>
        <span class="k">if</span> <span class="n">source</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">+=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&lt;FONT POINT-SIZE=&quot;9.0&quot;&gt;&lt;BR/&gt;&lt;BR/&gt;&#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;&lt;/FONT&gt;&#39;</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&lt;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&gt;&#39;</span>
        <span class="k">return</span> <span class="n">label</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">tooltip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a tooltip for node `var`.&quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span> <span class="o">=</span> <span class="n">var</span>
        <span class="n">func</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="n">location</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>In the second part of graph drawing, <code class="docutils literal notranslate"><span class="pre">add_hierarchy()</span></code> adds invisible edges to ensure that nodes with lower line numbers are drawn above nodes with higher line numbers.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Dependencies</span><span class="p">(</span><span class="n">Dependencies</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_hierarchy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g</span><span class="p">:</span> <span class="n">Digraph</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Digraph</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add invisible edges for a proper hierarchy.&quot;&quot;&quot;</span>
        <span class="n">functions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_functions</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">functions</span><span class="p">:</span>
            <span class="n">last_var</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">last_lineno</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">lineno</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span> <span class="ow">in</span> <span class="n">functions</span><span class="p">[</span><span class="n">func</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">last_var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lineno</span> <span class="o">&gt;</span> <span class="n">last_lineno</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="n">last_var</span><span class="p">),</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="n">var</span><span class="p">),</span>
                           <span class="n">style</span><span class="o">=</span><span class="s1">&#39;invis&#39;</span><span class="p">)</span>

                <span class="n">last_var</span> <span class="o">=</span> <span class="n">var</span>
                <span class="n">last_lineno</span> <span class="o">=</span> <span class="n">lineno</span>

        <span class="k">return</span> <span class="n">g</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Dependencies</span><span class="p">(</span><span class="n">Dependencies</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">all_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Node</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return mapping </span>
<span class="sd">        {`function`: [(`lineno`, `var`), (`lineno`, `var`), ...], ...}</span>
<span class="sd">        for all functions in the dependencies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">functions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Node</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_vars</span><span class="p">():</span>
            <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span> <span class="o">=</span> <span class="n">var</span>
            <span class="n">func</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="n">location</span>
            <span class="k">if</span> <span class="n">func</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">functions</span><span class="p">:</span>
                <span class="n">functions</span><span class="p">[</span><span class="n">func</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">functions</span><span class="p">[</span><span class="n">func</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">lineno</span><span class="p">,</span> <span class="n">var</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">functions</span><span class="p">:</span>
            <span class="n">functions</span><span class="p">[</span><span class="n">func</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">functions</span>
</pre></div>
</div>
</div>
</div>
<p>Here comes the graph in all its glory:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">middle_deps</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dependencies</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">Dependencies</span><span class="p">({(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">middle</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span> <span class="nb">set</span><span class="p">(),</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">middle</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span> <span class="nb">set</span><span class="p">(),</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">middle</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span> <span class="nb">set</span><span class="p">(),</span> <span class="p">(</span><span class="s1">&#39;&lt;test&gt;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">middle</span><span class="p">,</span> <span class="mi">2</span><span class="p">)):</span> <span class="p">{(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">middle</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">middle</span><span class="p">,</span> <span class="mi">1</span><span class="p">))},</span> <span class="p">(</span><span class="s1">&#39;&lt;test&gt;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">middle</span><span class="p">,</span> <span class="mi">3</span><span class="p">)):</span> <span class="p">{(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">middle</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">middle</span><span class="p">,</span> <span class="mi">1</span><span class="p">))},</span> <span class="p">(</span><span class="s1">&#39;&lt;test&gt;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">middle</span><span class="p">,</span> <span class="mi">5</span><span class="p">)):</span> <span class="p">{(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">middle</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">middle</span><span class="p">,</span> <span class="mi">1</span><span class="p">))},</span> <span class="p">(</span><span class="s1">&#39;&lt;middle() return value&gt;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">middle</span><span class="p">,</span> <span class="mi">6</span><span class="p">)):</span> <span class="p">{(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">middle</span><span class="p">,</span> <span class="mi">1</span><span class="p">))}},</span> <span class="p">{(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">middle</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span> <span class="nb">set</span><span class="p">(),</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">middle</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span> <span class="nb">set</span><span class="p">(),</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">middle</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span> <span class="nb">set</span><span class="p">(),</span> <span class="p">(</span><span class="s1">&#39;&lt;test&gt;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">middle</span><span class="p">,</span> <span class="mi">2</span><span class="p">)):</span> <span class="nb">set</span><span class="p">(),</span> <span class="p">(</span><span class="s1">&#39;&lt;test&gt;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">middle</span><span class="p">,</span> <span class="mi">3</span><span class="p">)):</span> <span class="p">{(</span><span class="s1">&#39;&lt;test&gt;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">middle</span><span class="p">,</span> <span class="mi">2</span><span class="p">))},</span> <span class="p">(</span><span class="s1">&#39;&lt;test&gt;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">middle</span><span class="p">,</span> <span class="mi">5</span><span class="p">)):</span> <span class="p">{(</span><span class="s1">&#39;&lt;test&gt;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">middle</span><span class="p">,</span> <span class="mi">3</span><span class="p">))},</span> <span class="p">(</span><span class="s1">&#39;&lt;middle() return value&gt;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">middle</span><span class="p">,</span> <span class="mi">6</span><span class="p">)):</span> <span class="p">{(</span><span class="s1">&#39;&lt;test&gt;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">middle</span><span class="p">,</span> <span class="mi">5</span><span class="p">))}})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">middle_deps</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/82b4ce7d77b6d16dff5211ade047135e322a356ec492173245fb0de53aabfaf1.svg" src="_images/82b4ce7d77b6d16dff5211ade047135e322a356ec492173245fb0de53aabfaf1.svg" />
</div>
</div>
<p>By default, the arrow direction indicates <em>flows</em> – an arrow <em>A</em> → <em>B</em> indicates that information from <em>A</em> <em>flows</em> into <em>B</em> (and thus the state in <em>A</em> <em>causes</em> the state in <em>B</em>). By setting the extra keyword parameter <code class="docutils literal notranslate"><span class="pre">mode</span></code> to <code class="docutils literal notranslate"><span class="pre">depend</span></code> instead of <code class="docutils literal notranslate"><span class="pre">flow</span></code> (default), you can reverse these arrows; then an arrow <em>A</em> → <em>B</em> indicates <em>A</em> <em>depends</em> on <em>B</em>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">middle_deps</span><span class="p">()</span><span class="o">.</span><span class="n">graph</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;depend&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/131596b9d9e8c8db8ee115ee1a904a0aa47b26399162f283455d67ac6ff833aa.svg" src="_images/131596b9d9e8c8db8ee115ee1a904a0aa47b26399162f283455d67ac6ff833aa.svg" />
</div>
</div>
</section>
<section id="slices">
<h4>Slices<a class="headerlink" href="#slices" title="Link to this heading">#</a></h4>
<p>The method <code class="docutils literal notranslate"><span class="pre">backward_slice(*critera,</span> <span class="pre">mode='cd')</span></code> returns a subset of dependencies, following dependencies backward from the given <em>slicing criteria</em> <code class="docutils literal notranslate"><span class="pre">criteria</span></code>. These criteria can be</p>
<ul class="simple">
<li><p>variable names (such as <code class="docutils literal notranslate"><span class="pre">&lt;test&gt;</span></code>); or</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">(function,</span> <span class="pre">lineno)</span></code> pairs (such as <code class="docutils literal notranslate"><span class="pre">(middle,</span> <span class="pre">3)</span></code>); or</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">(var_name,</span> <span class="pre">(function,</span> <span class="pre">lineno))</span></code> (such as <code class="docutils literal notranslate"><span class="pre">(</span></code>x<code class="docutils literal notranslate"><span class="pre">,</span> <span class="pre">(middle,</span> <span class="pre">1))</span></code>) locations.</p></li>
</ul>
<p>The extra parameter <code class="docutils literal notranslate"><span class="pre">mode</span></code> controls which dependencies are to be followed:</p>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">d</span></code></strong> = data dependencies</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">c</span></code></strong> = control dependencies</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Criterion</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Location</span><span class="p">,</span> <span class="n">Node</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Dependencies</span><span class="p">(</span><span class="n">Dependencies</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">expand_criteria</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Criterion</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return list of vars matched by `criteria`.&quot;&quot;&quot;</span>
        <span class="n">all_vars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">criterion</span> <span class="ow">in</span> <span class="n">criteria</span><span class="p">:</span>
            <span class="n">criterion_var</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">criterion_func</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">criterion_lineno</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">criterion</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">criterion_var</span> <span class="o">=</span> <span class="n">criterion</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">criterion</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="n">criterion</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">criterion_func</span><span class="p">,</span> <span class="n">criterion_lineno</span> <span class="o">=</span> <span class="n">criterion</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">criterion</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">criterion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">criterion_var</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">criterion_func</span><span class="p">,</span> <span class="n">criterion_lineno</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid argument&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_vars</span><span class="p">():</span>
                <span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span> <span class="o">=</span> <span class="n">var</span>
                <span class="n">func</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="n">location</span>

                <span class="n">name_matches</span> <span class="o">=</span> <span class="p">(</span><span class="n">criterion_func</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
                                <span class="n">criterion_func</span> <span class="o">==</span> <span class="n">func</span> <span class="ow">or</span>
                                <span class="n">criterion_func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

                <span class="n">location_matches</span> <span class="o">=</span> <span class="p">(</span><span class="n">criterion_lineno</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
                                    <span class="n">criterion_lineno</span> <span class="o">==</span> <span class="n">lineno</span><span class="p">)</span>

                <span class="n">var_matches</span> <span class="o">=</span> <span class="p">(</span><span class="n">criterion_var</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
                               <span class="n">criterion_var</span> <span class="o">==</span> <span class="n">var_name</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">name_matches</span> <span class="ow">and</span> <span class="n">location_matches</span> <span class="ow">and</span> <span class="n">var_matches</span><span class="p">:</span>
                    <span class="n">all_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">all_vars</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">backward_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">criteria</span><span class="p">:</span> <span class="n">Criterion</span><span class="p">,</span> 
                       <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;cd&#39;</span><span class="p">,</span> <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dependencies</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a backward slice from nodes `criteria`.</span>
<span class="sd">        `mode` can contain &#39;c&#39; (draw control dependencies)</span>
<span class="sd">        and &#39;d&#39; (draw data dependencies) (default: &#39;cd&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">control</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_criteria</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">depth</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;d&#39;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
                <span class="c1"># Follow data dependencies</span>
                <span class="n">data</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">next_var</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">var</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">next_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                        <span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_var</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

            <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
                <span class="c1"># Follow control dependencies</span>
                <span class="n">control</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">next_var</span> <span class="ow">in</span> <span class="n">control</span><span class="p">[</span><span class="n">var</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">next_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                        <span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_var</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">control</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

            <span class="n">depth</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">Dependencies</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">control</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="end-of-excursion">
<h3>End of Excursion<a class="headerlink" href="#end-of-excursion" title="Link to this heading">#</a></h3>
</section>
<section id="data-dependencies">
<h3>Data Dependencies<a class="headerlink" href="#data-dependencies" title="Link to this heading">#</a></h3>
<p>Here is an example of a data dependency in our <code class="docutils literal notranslate"><span class="pre">middle()</span></code> program. The value <code class="docutils literal notranslate"><span class="pre">y</span></code> returned by <code class="docutils literal notranslate"><span class="pre">middle()</span></code> comes from the value <code class="docutils literal notranslate"><span class="pre">y</span></code> as originally passed as argument. We use arrows <span class="math notranslate nohighlight">\(x \leftarrow y\)</span> to indicate that a variable <span class="math notranslate nohighlight">\(x\)</span> depends on an earlier variable <span class="math notranslate nohighlight">\(y\)</span>:</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="_images/94d4768c12e220305834615143edcc8b6b61830944d41146c1b8b8fa649e7eff.svg" src="_images/94d4768c12e220305834615143edcc8b6b61830944d41146c1b8b8fa649e7eff.svg" />
</div>
</div>
<p>Here, we can see that the value <code class="docutils literal notranslate"><span class="pre">y</span></code> in the return statement is data dependent on the value of <code class="docutils literal notranslate"><span class="pre">y</span></code> as passed to <code class="docutils literal notranslate"><span class="pre">middle()</span></code>. An alternate interpretation of this graph is a <em>data flow</em>: The value of <code class="docutils literal notranslate"><span class="pre">y</span></code> in the upper node <em>flows</em> into the value of <code class="docutils literal notranslate"><span class="pre">y</span></code> in the lower node.</p>
<p>Since we consider the values of variables at specific locations in the program, such data dependencies can also be interpreted as dependencies between <em>statements</em> – the above <code class="docutils literal notranslate"><span class="pre">return</span></code> statement thus is data dependent on the initialization of <code class="docutils literal notranslate"><span class="pre">y</span></code> in the upper node.</p>
</section>
<section id="control-dependencies">
<h3>Control Dependencies<a class="headerlink" href="#control-dependencies" title="Link to this heading">#</a></h3>
<p>Here is an example of a control dependency. The execution of the above <code class="docutils literal notranslate"><span class="pre">return</span></code> statement is controlled by the earlier test <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">&lt;</span> <span class="pre">z</span></code>. We use gray dashed lines to indicate control dependencies:</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="_images/0dc8d86f79c2d7491decbf9aed40bf05033878743be7a5e3458ee62ca56de890.svg" src="_images/0dc8d86f79c2d7491decbf9aed40bf05033878743be7a5e3458ee62ca56de890.svg" />
</div>
</div>
<p>This test in turn is controlled by earlier tests, so the full chain of control dependencies looks like this:</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="_images/8cb49ef05100b032fb3b1eaf26f1f1ee5c0902bfb412db0547dee8605bf40e21.svg" src="_images/8cb49ef05100b032fb3b1eaf26f1f1ee5c0902bfb412db0547dee8605bf40e21.svg" />
</div>
</div>
</section>
<section id="dependency-graphs">
<h3>Dependency Graphs<a class="headerlink" href="#dependency-graphs" title="Link to this heading">#</a></h3>
<p>The above <code class="docutils literal notranslate"><span class="pre">&lt;test&gt;</span></code> values (and their statements) are in turn also dependent on earlier data, namely the <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, and <code class="docutils literal notranslate"><span class="pre">z</span></code> values as originally passed. We can draw all data and control dependencies in a single graph, called a <em>program dependency graph</em>:</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="_images/82b4ce7d77b6d16dff5211ade047135e322a356ec492173245fb0de53aabfaf1.svg" src="_images/82b4ce7d77b6d16dff5211ade047135e322a356ec492173245fb0de53aabfaf1.svg" />
</div>
</div>
<p>This graph now gives us an idea on how to proceed to track the origins of the <code class="docutils literal notranslate"><span class="pre">middle()</span></code> return value at the bottom. Its value can come from any of the origins – namely the initialization of <code class="docutils literal notranslate"><span class="pre">y</span></code> at the function call, or from the <code class="docutils literal notranslate"><span class="pre">&lt;test&gt;</span></code> that controls it. This test in turn depends on <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">z</span></code> and their associated statements, which we now can check one after the other.</p>
<p>Note that all these dependencies in the graph are <em>dynamic</em> dependencies – that is, they refer to statements actually evaluated in the run at hand, as well as the decisions made in that very run. There also are <em>static</em> dependency graphs coming from static analysis of the code; but for debugging, <em>dynamic</em> dependencies specific to the failing run are more useful.</p>
</section>
<section id="showing-dependencies-with-code">
<h3>Showing Dependencies with Code<a class="headerlink" href="#showing-dependencies-with-code" title="Link to this heading">#</a></h3>
<p>While a graph gives us a representation about which possible data and control flows to track, integrating dependencies with actual program code results in a compact representation that is easy to reason about.</p>
<section id="excursion-listing-dependencies">
<h4>Excursion: Listing Dependencies<a class="headerlink" href="#excursion-listing-dependencies" title="Link to this heading">#</a></h4>
<p>To show dependencies as text, we introduce a method <code class="docutils literal notranslate"><span class="pre">format_var()</span></code> that shows a single node (a variable) as text. By default, a node is referenced as</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">NAME</span> <span class="p">(</span><span class="n">FUNCTION</span><span class="p">:</span><span class="n">LINENO</span><span class="p">)</span>
</pre></div>
</div>
<p>However, within a given function, it makes no sense to re-state the function name again and again, so we have a shorthand</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">NAME</span> <span class="p">(</span><span class="n">LINENO</span><span class="p">)</span>
</pre></div>
</div>
<p>to state a dependency to variable <code class="docutils literal notranslate"><span class="pre">NAME</span></code> in line <code class="docutils literal notranslate"><span class="pre">LINENO</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Dependencies</span><span class="p">(</span><span class="n">Dependencies</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">current_func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return string for `var` in `current_func`.&quot;&quot;&quot;</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">location</span> <span class="o">=</span> <span class="n">var</span>
        <span class="n">func</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="n">location</span>
        <span class="k">if</span> <span class="n">current_func</span> <span class="ow">and</span> <span class="p">(</span><span class="n">func</span> <span class="o">==</span> <span class="n">current_func</span> <span class="ow">or</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="n">current_func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s2">)&quot;</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">format_var()</span></code> is used extensively in the <code class="docutils literal notranslate"><span class="pre">__str__()</span></code> string representation of dependencies, listing all nodes and their data (<code class="docutils literal notranslate"><span class="pre">&lt;=</span></code>) and control (<code class="docutils literal notranslate"><span class="pre">&lt;-</span></code>) dependencies.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Dependencies</span><span class="p">(</span><span class="n">Dependencies</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return string representation of dependencies&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_functions</span><span class="p">():</span>
            <span class="n">code_name</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>

            <span class="k">if</span> <span class="n">out</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">code_name</span><span class="si">}</span><span class="s2">():</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="n">all_vars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">all_vars</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">var</span><span class="p">:</span> <span class="n">var</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">all_vars</span><span class="p">:</span>
                <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span> <span class="o">=</span> <span class="n">var</span>
                <span class="n">var_func</span><span class="p">,</span> <span class="n">var_lineno</span> <span class="o">=</span> <span class="n">location</span>
                <span class="n">var_code_name</span> <span class="o">=</span> <span class="n">var_func</span><span class="o">.</span><span class="vm">__name__</span>

                <span class="k">if</span> <span class="n">var_code_name</span> <span class="o">!=</span> <span class="n">code_name</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">all_deps</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">arrow</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;&lt;=&quot;</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="p">,</span> <span class="s2">&quot;&lt;-&quot;</span><span class="p">)]:</span>
                    <span class="n">deps</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">for</span> <span class="n">data_dep</span> <span class="ow">in</span> <span class="n">source</span><span class="p">[</span><span class="n">var</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">deps</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                            <span class="n">deps</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">arrow</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">deps</span> <span class="o">+=</span> <span class="s2">&quot;, &quot;</span>
                        <span class="n">deps</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_var</span><span class="p">(</span><span class="n">data_dep</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">deps</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">all_deps</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                            <span class="n">all_deps</span> <span class="o">+=</span> <span class="s2">&quot;;&quot;</span>
                        <span class="n">all_deps</span> <span class="o">+=</span> <span class="n">deps</span>

                <span class="k">if</span> <span class="n">all_deps</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">out</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;    &quot;</span> <span class="o">+</span> 
                        <span class="bp">self</span><span class="o">.</span><span class="n">format_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span> <span class="o">+</span>
                        <span class="n">all_deps</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span>
</pre></div>
</div>
</div>
</div>
<p>Here is a compact string representation of dependencies. We see how the (last) <code class="docutils literal notranslate"><span class="pre">middle()</span> <span class="pre">return</span> <span class="pre">value</span></code> has a data dependency to <code class="docutils literal notranslate"><span class="pre">y</span></code> in Line 1, and to the <code class="docutils literal notranslate"><span class="pre">&lt;test&gt;</span></code> in Line 5.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">middle_deps</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>middle():
    &lt;test&gt; (2) &lt;= z (1), y (1)
    &lt;test&gt; (3) &lt;= x (1), y (1); &lt;- &lt;test&gt; (2)
    &lt;test&gt; (5) &lt;= z (1), x (1); &lt;- &lt;test&gt; (3)
    &lt;middle() return value&gt; (6) &lt;= y (1); &lt;- &lt;test&gt; (5)
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">__repr__()</span></code> method shows a raw form of dependencies, useful for creating dependencies from scratch.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Dependencies</span><span class="p">(</span><span class="n">Dependencies</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">repr_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">location</span> <span class="o">=</span> <span class="n">var</span>
        <span class="n">func</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="n">location</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="s2">, (</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s2">))&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">repr_deps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_set</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">Node</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">var_set</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;set()&quot;</span>

        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;{&quot;</span> <span class="o">+</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">repr_var</span><span class="p">(</span><span class="n">var</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                          <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">var_set</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;}&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">repr_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">vars</span><span class="p">:</span> <span class="n">Dependency</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;{</span><span class="se">\n</span><span class="s2">        &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;,</span><span class="se">\n</span><span class="s2">        &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">repr_var</span><span class="p">(</span><span class="n">var</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">repr_deps</span><span class="p">(</span><span class="nb">vars</span><span class="p">[</span><span class="n">var</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;}&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Represent dependencies as a Python expression&quot;&quot;&quot;</span>
        <span class="c1"># Useful for saving and restoring values</span>
        <span class="k">return</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dependencies(</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                <span class="sa">f</span><span class="s2">&quot;    data=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">repr_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                <span class="sa">f</span><span class="s2">&quot; control=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">repr_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">middle_deps</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dependencies(
    data={
        (&#39;z&#39;, (middle, 1)): set(),
        (&#39;y&#39;, (middle, 1)): set(),
        (&#39;x&#39;, (middle, 1)): set(),
        (&#39;&lt;test&gt;&#39;, (middle, 2)): {(&#39;z&#39;, (middle, 1)), (&#39;y&#39;, (middle, 1))},
        (&#39;&lt;test&gt;&#39;, (middle, 3)): {(&#39;x&#39;, (middle, 1)), (&#39;y&#39;, (middle, 1))},
        (&#39;&lt;test&gt;&#39;, (middle, 5)): {(&#39;z&#39;, (middle, 1)), (&#39;x&#39;, (middle, 1))},
        (&#39;&lt;middle() return value&gt;&#39;, (middle, 6)): {(&#39;y&#39;, (middle, 1))}},
 control={
        (&#39;z&#39;, (middle, 1)): set(),
        (&#39;y&#39;, (middle, 1)): set(),
        (&#39;x&#39;, (middle, 1)): set(),
        (&#39;&lt;test&gt;&#39;, (middle, 2)): set(),
        (&#39;&lt;test&gt;&#39;, (middle, 3)): {(&#39;&lt;test&gt;&#39;, (middle, 2))},
        (&#39;&lt;test&gt;&#39;, (middle, 5)): {(&#39;&lt;test&gt;&#39;, (middle, 3))},
        (&#39;&lt;middle() return value&gt;&#39;, (middle, 6)): {(&#39;&lt;test&gt;&#39;, (middle, 5))}})
</pre></div>
</div>
</div>
</div>
<p>An even more useful representation comes when integrating these dependencies as comments into the code. The method <code class="docutils literal notranslate"><span class="pre">code(item_1,</span> <span class="pre">item_2,</span> <span class="pre">...)</span></code> lists the given (function) items, including their dependencies; <code class="docutils literal notranslate"><span class="pre">code()</span></code> lists <em>all</em> functions contained in the dependencies.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Dependencies</span><span class="p">(</span><span class="n">Dependencies</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">items</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;cd&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List `items` on standard output, including dependencies as comments. </span>
<span class="sd">        If `items` is empty, all included functions are listed.</span>
<span class="sd">        `mode` can contain &#39;c&#39; (draw control dependencies) and &#39;d&#39; (draw data dependencies)</span>
<span class="sd">        (default: &#39;cd&#39;).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Callable</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_functions</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_code</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># The functions in dependencies may be (instrumented) copies</span>
        <span class="c1"># of the original function. Find the function with the same name.</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">item</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_functions</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">fn</span> <span class="o">==</span> <span class="n">item</span> <span class="ow">or</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="n">item</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="n">fn</span>
                <span class="k">break</span>

        <span class="n">all_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_vars</span><span class="p">()</span>
        <span class="n">slice_locations</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">location</span> <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span> <span class="ow">in</span> <span class="n">all_vars</span><span class="p">)</span>

        <span class="n">source_lines</span><span class="p">,</span> <span class="n">first_lineno</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcelines</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

        <span class="n">n</span> <span class="o">=</span> <span class="n">first_lineno</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">source_lines</span><span class="p">:</span>
            <span class="n">line_location</span> <span class="o">=</span> <span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line_location</span> <span class="ow">in</span> <span class="n">slice_locations</span><span class="p">:</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;* &quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">n</span><span class="si">:</span><span class="s2">4</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">mode_control</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">arrow</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="p">,</span> <span class="s1">&#39;&lt;-&#39;</span><span class="p">)</span>
            <span class="p">]:</span>
                <span class="k">if</span> <span class="n">mode_control</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">deps</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">location</span> <span class="o">=</span> <span class="n">var</span>
                    <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="n">line_location</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">dep_var</span> <span class="ow">in</span> <span class="n">source</span><span class="p">[</span><span class="n">var</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">deps</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                                <span class="n">deps</span> <span class="o">=</span> <span class="n">arrow</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">deps</span> <span class="o">+=</span> <span class="s2">&quot;, &quot;</span>
                            <span class="n">deps</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_var</span><span class="p">(</span><span class="n">dep_var</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">deps</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">comment</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="n">comment</span> <span class="o">+=</span> <span class="s2">&quot;; &quot;</span>
                    <span class="n">comment</span> <span class="o">+=</span> <span class="n">deps</span>

            <span class="k">if</span> <span class="n">comment</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;  # &quot;</span> <span class="o">+</span> <span class="n">comment</span>

            <span class="n">print_content</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id1">
<h4>End of Excursion<a class="headerlink" href="#id1" title="Link to this heading">#</a></h4>
<p>The following listing shows such an integration. For each executed line (<code class="docutils literal notranslate"><span class="pre">*</span></code>), we see its data (<code class="docutils literal notranslate"><span class="pre">&lt;=</span></code>) and control (<code class="docutils literal notranslate"><span class="pre">&lt;-</span></code>) dependencies, listing the associated variables and line numbers. The comment</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># &lt;= y (1); &lt;- &lt;test&gt; (5)</span>
</pre></div>
</div>
<p>for Line 6, for instance, states that the return value is data dependent on the value of <code class="docutils literal notranslate"><span class="pre">y</span></code> in Line 1, and control dependent on the test in Line 5.</p>
<p>Again, one can easily follow these dependencies back to track where a value came from (data dependencies) and why a statement was executed (control dependency).</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>*    1 <span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">middle</span>(x, y, z):  <span class=" -Color -Color-White"># type: ignore</span>
*    2     <span class=" -Color -Color-Blue">if</span> y &lt; z:  <span class=" -Color -Color-White"># &lt;= z (1), y (1)</span>
*    3         <span class=" -Color -Color-Blue">if</span> x &lt; y:  <span class=" -Color -Color-White"># &lt;= x (1), y (1); &lt;- &lt;test&gt; (2)</span>
     4             <span class=" -Color -Color-Blue">return</span> y
*    5         <span class=" -Color -Color-Blue">elif</span> x &lt; z:  <span class=" -Color -Color-White"># &lt;= z (1), x (1); &lt;- &lt;test&gt; (3)</span>
*    6             <span class=" -Color -Color-Blue">return</span> y  <span class=" -Color -Color-White"># &lt;= y (1); &lt;- &lt;test&gt; (5)</span>
     7     <span class=" -Color -Color-Blue">else</span>:
     8         <span class=" -Color -Color-Blue">if</span> x &gt; y:
     9             <span class=" -Color -Color-Blue">return</span> y
    10         <span class=" -Color -Color-Blue">elif</span> x &gt; z:
    11             <span class=" -Color -Color-Blue">return</span> x
    12     <span class=" -Color -Color-Blue">return</span> z
</pre></div>
</div>
</div>
</div>
<p>One important aspect of dependencies is that they not only point to specific sources and causes of failures – but that they also <em>rule out</em> parts of program and state as failures.</p>
<ul class="simple">
<li><p>In the above code, Lines 8 and later have no influence on the output, simply because they were not executed.</p></li>
<li><p>Furthermore, we see that we can start our investigation with Line 6, because that is the last one executed.</p></li>
<li><p>The data dependencies tell us that no statement has interfered with the value of <code class="docutils literal notranslate"><span class="pre">y</span></code> between the function call and its return.</p></li>
<li><p>Hence, the error must be in the conditions or the final <code class="docutils literal notranslate"><span class="pre">return</span></code> statement.</p></li>
</ul>
<p>With this in mind, recall that our original invocation was <code class="docutils literal notranslate"><span class="pre">middle(2,</span> <span class="pre">1,</span> <span class="pre">3)</span></code>. Why and how is the above code wrong?</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">Which of the following <code>middle()</code> code lines should be fixed?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">
    
        <input type="radio" name="d11779f6-b293-11f0-938a-6298cf1a5790" id="d11779f6-b293-11f0-938a-6298cf1a5790-1" onclick="clear_selection('d11779f6-b293-11f0-938a-6298cf1a5790')">
        <label id="d11779f6-b293-11f0-938a-6298cf1a5790-1-label" for="d11779f6-b293-11f0-938a-6298cf1a5790-1">Line 2: <code>if y &lt; z:</code></label><br>
    
        <input type="radio" name="d11779f6-b293-11f0-938a-6298cf1a5790" id="d11779f6-b293-11f0-938a-6298cf1a5790-2" onclick="clear_selection('d11779f6-b293-11f0-938a-6298cf1a5790')">
        <label id="d11779f6-b293-11f0-938a-6298cf1a5790-2-label" for="d11779f6-b293-11f0-938a-6298cf1a5790-2">Line 3: <code>if x &lt; y:</code></label><br>
    
        <input type="radio" name="d11779f6-b293-11f0-938a-6298cf1a5790" id="d11779f6-b293-11f0-938a-6298cf1a5790-3" onclick="clear_selection('d11779f6-b293-11f0-938a-6298cf1a5790')">
        <label id="d11779f6-b293-11f0-938a-6298cf1a5790-3-label" for="d11779f6-b293-11f0-938a-6298cf1a5790-3">Line 5: <code>elif x &lt; z:</code></label><br>
    
        <input type="radio" name="d11779f6-b293-11f0-938a-6298cf1a5790" id="d11779f6-b293-11f0-938a-6298cf1a5790-4" onclick="clear_selection('d11779f6-b293-11f0-938a-6298cf1a5790')">
        <label id="d11779f6-b293-11f0-938a-6298cf1a5790-4-label" for="d11779f6-b293-11f0-938a-6298cf1a5790-4">Line 6: <code>return z</code></label><br>
    
    </div>
    </p>
    <input id="d11779f6-b293-11f0-938a-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('d11779f6-b293-11f0-938a-6298cf1a5790', 16, 0, '(1 ** 0 + 1 ** 1) ** (1 ** 2 + 1 ** 3)')">
    <span class="quiz_hint" id="d11779f6-b293-11f0-938a-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
<p>Indeed, from the controlling conditions, we see that <code class="docutils literal notranslate"><span class="pre">y</span> <span class="pre">&lt;</span> <span class="pre">z</span></code>, <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">&gt;=</span> <span class="pre">y</span></code>, and <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">&lt;</span> <span class="pre">z</span></code> all hold. Hence, <code class="docutils literal notranslate"><span class="pre">y</span> <span class="pre">&lt;=</span> <span class="pre">x</span> <span class="pre">&lt;</span> <span class="pre">z</span></code> holds, and it is <code class="docutils literal notranslate"><span class="pre">x</span></code>, not <code class="docutils literal notranslate"><span class="pre">y</span></code>, that should be returned.</p>
</section>
</section>
</section>
<section id="id2">
<h2>Slices<a class="headerlink" href="#id2" title="Link to this heading">#</a></h2>
<p>Given a dependency graph for a particular variable, we can identify the subset of the program that could have influenced it – the so-called <em>slice</em>. In the above code listing, these code locations are highlighted with <code class="docutils literal notranslate"><span class="pre">*</span></code> characters. Only these locations are part of the slice.</p>
<p>Slices are central to debugging for two reasons:</p>
<ul class="simple">
<li><p>First, they <em>rule out</em> those locations of the program that could <em>not</em> have an effect on the failure. Hence, these locations need not be investigated as it comes to searching for the defect. Nor do they need to be considered for a fix, as any change outside the program slice by construction cannot affect the failure.</p></li>
<li><p>Second, they bring together possible origins that may be scattered across the code. Many dependencies in program code are <em>non-local</em>, with references to functions, classes, and modules defined in other locations, files, or libraries. A slice brings together all those locations in a single whole.</p></li>
</ul>
<p>Here is an example of a slice – this time for our well-known <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code> function from <a class="reference internal" href="Intro_Debugging.html"><span class="std std-doc">the introduction to debugging</span></a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">Intro_Debugging</span><span class="w"> </span><span class="kn">import</span> <span class="n">remove_html_markup</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">remove_html_markup</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">remove_html_markup</span>(s):  <span class=" -Color -Color-White"># type: ignore</span>
    tag = <span class=" -Color -Color-Blue">False</span>
    quote = <span class=" -Color -Color-Blue">False</span>
    out = <span class=" -Color -Color-Yellow">&quot;&quot;</span>

    <span class=" -Color -Color-Blue">for</span> c <span class=" -Color -Color-Magenta">in</span> s:
        <span class=" -Color -Color-Blue">assert</span> tag <span class=" -Color -Color-Magenta">or</span> <span class=" -Color -Color-Magenta">not</span> quote

        <span class=" -Color -Color-Blue">if</span> c == <span class=" -Color -Color-Yellow">&#39;&lt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> <span class=" -Color -Color-Magenta">not</span> quote:
            tag = <span class=" -Color -Color-Blue">True</span>
        <span class=" -Color -Color-Blue">elif</span> c == <span class=" -Color -Color-Yellow">&#39;&gt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> <span class=" -Color -Color-Magenta">not</span> quote:
            tag = <span class=" -Color -Color-Blue">False</span>
        <span class=" -Color -Color-Blue">elif</span> (c == <span class=" -Color -Color-Yellow">&#39;&quot;&#39;</span> <span class=" -Color -Color-Magenta">or</span> c == <span class=" -Color -Color-Yellow">&quot;&#39;&quot;</span>) <span class=" -Color -Color-Magenta">and</span> tag:
            quote = <span class=" -Color -Color-Magenta">not</span> quote
        <span class=" -Color -Color-Blue">elif</span> <span class=" -Color -Color-Magenta">not</span> tag:
            out = out + c

    <span class=" -Color -Color-Blue">return</span> out
</pre></div>
</div>
</div>
</div>
<p>When we invoke <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code> as follows…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&lt;foo&gt;bar&lt;/foo&gt;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;bar&#39;
</pre></div>
</div>
</div>
</div>
<p>… we obtain the following dependencies:</p>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="_images/0a80e4684dd3371d62695cdb28b59e696fefff53c4e3f2e287c6689c50efb661.svg" src="_images/0a80e4684dd3371d62695cdb28b59e696fefff53c4e3f2e287c6689c50efb661.svg" />
</div>
</div>
<p>Again, we can read such a graph <em>forward</em> (starting from, say, <code class="docutils literal notranslate"><span class="pre">s</span></code>) or <em>backward</em> (starting from the return value). Starting forward, we see how the passed string <code class="docutils literal notranslate"><span class="pre">s</span></code> flows into the <code class="docutils literal notranslate"><span class="pre">for</span></code> loop, breaking <code class="docutils literal notranslate"><span class="pre">s</span></code> into individual characters <code class="docutils literal notranslate"><span class="pre">c</span></code> that are then checked on various occasions, before flowing into the <code class="docutils literal notranslate"><span class="pre">out</span></code> return value. We also see how the various <code class="docutils literal notranslate"><span class="pre">if</span></code> conditions are all influenced by <code class="docutils literal notranslate"><span class="pre">c</span></code>, <code class="docutils literal notranslate"><span class="pre">tag</span></code>, and <code class="docutils literal notranslate"><span class="pre">quote</span></code>.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">Why does the first line <code>tag = False</code> not influence anything?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">
    
        <input type="radio" name="d15078c8-b293-11f0-938a-6298cf1a5790" id="d15078c8-b293-11f0-938a-6298cf1a5790-1" onclick="clear_selection('d15078c8-b293-11f0-938a-6298cf1a5790')">
        <label id="d15078c8-b293-11f0-938a-6298cf1a5790-1-label" for="d15078c8-b293-11f0-938a-6298cf1a5790-1">Because the input contains only tags</label><br>
    
        <input type="radio" name="d15078c8-b293-11f0-938a-6298cf1a5790" id="d15078c8-b293-11f0-938a-6298cf1a5790-2" onclick="clear_selection('d15078c8-b293-11f0-938a-6298cf1a5790')">
        <label id="d15078c8-b293-11f0-938a-6298cf1a5790-2-label" for="d15078c8-b293-11f0-938a-6298cf1a5790-2">Because <code>tag</code> is set to True with the first character</label><br>
    
        <input type="radio" name="d15078c8-b293-11f0-938a-6298cf1a5790" id="d15078c8-b293-11f0-938a-6298cf1a5790-3" onclick="clear_selection('d15078c8-b293-11f0-938a-6298cf1a5790')">
        <label id="d15078c8-b293-11f0-938a-6298cf1a5790-3-label" for="d15078c8-b293-11f0-938a-6298cf1a5790-3">Because <code>tag</code> is not read by any variable</label><br>
    
        <input type="radio" name="d15078c8-b293-11f0-938a-6298cf1a5790" id="d15078c8-b293-11f0-938a-6298cf1a5790-4" onclick="clear_selection('d15078c8-b293-11f0-938a-6298cf1a5790')">
        <label id="d15078c8-b293-11f0-938a-6298cf1a5790-4-label" for="d15078c8-b293-11f0-938a-6298cf1a5790-4">Because the input contains no tags</label><br>
    
    </div>
    </p>
    <input id="d15078c8-b293-11f0-938a-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('d15078c8-b293-11f0-938a-6298cf1a5790', 4, 0, '(1 &lt;&lt; 1 + 1 &gt;&gt; 1)')">
    <span class="quiz_hint" id="d15078c8-b293-11f0-938a-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
<p>Which are the locations that set <code class="docutils literal notranslate"><span class="pre">tag</span></code> to True? To this end, we compute the slice of <code class="docutils literal notranslate"><span class="pre">tag</span></code> at <code class="docutils literal notranslate"><span class="pre">tag</span> <span class="pre">=</span> <span class="pre">True</span></code>:</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="_images/27be6cd743bf76ad91a28f9abd8f64aaf141c771a12c2ecdbaae1f6280427d2b.svg" src="_images/27be6cd743bf76ad91a28f9abd8f64aaf141c771a12c2ecdbaae1f6280427d2b.svg" />
</div>
</div>
<p>We see where the value of <code class="docutils literal notranslate"><span class="pre">tag</span></code> comes from: from the characters <code class="docutils literal notranslate"><span class="pre">c</span></code> in <code class="docutils literal notranslate"><span class="pre">s</span></code> as well as <code class="docutils literal notranslate"><span class="pre">quote</span></code>, which all cause it to be set. Again, we can combine these dependencies and the listing in a single, compact view. Note, again, that there are no other locations in the code that could possibly have affected <code class="docutils literal notranslate"><span class="pre">tag</span></code> in our run.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   238 <span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">remove_html_markup</span>(s):  <span class=" -Color -Color-White"># type: ignore</span>
   239     tag = <span class=" -Color -Color-Blue">False</span>
   240     quote = <span class=" -Color -Color-Blue">False</span>
   241     out = <span class=" -Color -Color-Yellow">&quot;&quot;</span>
   242 
   243     <span class=" -Color -Color-Blue">for</span> c <span class=" -Color -Color-Magenta">in</span> s:
   244         <span class=" -Color -Color-Blue">assert</span> tag <span class=" -Color -Color-Magenta">or</span> <span class=" -Color -Color-Magenta">not</span> quote
   245 
   246         <span class=" -Color -Color-Blue">if</span> c == <span class=" -Color -Color-Yellow">&#39;&lt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> <span class=" -Color -Color-Magenta">not</span> quote:
   247             tag = <span class=" -Color -Color-Blue">True</span>
   248         <span class=" -Color -Color-Blue">elif</span> c == <span class=" -Color -Color-Yellow">&#39;&gt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> <span class=" -Color -Color-Magenta">not</span> quote:
   249             tag = <span class=" -Color -Color-Blue">False</span>
   250         <span class=" -Color -Color-Blue">elif</span> (c == <span class=" -Color -Color-Yellow">&#39;&quot;&#39;</span> <span class=" -Color -Color-Magenta">or</span> c == <span class=" -Color -Color-Yellow">&quot;&#39;&quot;</span>) <span class=" -Color -Color-Magenta">and</span> tag:
   251             quote = <span class=" -Color -Color-Magenta">not</span> quote
   252         <span class=" -Color -Color-Blue">elif</span> <span class=" -Color -Color-Magenta">not</span> tag:
   253             out = out + c
   254 
   255     <span class=" -Color -Color-Blue">return</span> out
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">How does the slice of <code>tag = True</code> change for a different value of <code>s</code>?</div>
    </p>
    <p>
    <div class="quiz_options" title="Check all that apply.">
    
        <input type="checkbox" name="d1a73226-b293-11f0-938a-6298cf1a5790" id="d1a73226-b293-11f0-938a-6298cf1a5790-1" onclick="clear_selection('d1a73226-b293-11f0-938a-6298cf1a5790')">
        <label id="d1a73226-b293-11f0-938a-6298cf1a5790-1-label" for="d1a73226-b293-11f0-938a-6298cf1a5790-1">Not at all</label><br>
    
        <input type="checkbox" name="d1a73226-b293-11f0-938a-6298cf1a5790" id="d1a73226-b293-11f0-938a-6298cf1a5790-2" onclick="clear_selection('d1a73226-b293-11f0-938a-6298cf1a5790')">
        <label id="d1a73226-b293-11f0-938a-6298cf1a5790-2-label" for="d1a73226-b293-11f0-938a-6298cf1a5790-2">If <code>s</code> contains a quote, the <code>quote</code> slice is included, too</label><br>
    
        <input type="checkbox" name="d1a73226-b293-11f0-938a-6298cf1a5790" id="d1a73226-b293-11f0-938a-6298cf1a5790-3" onclick="clear_selection('d1a73226-b293-11f0-938a-6298cf1a5790')">
        <label id="d1a73226-b293-11f0-938a-6298cf1a5790-3-label" for="d1a73226-b293-11f0-938a-6298cf1a5790-3">If <code>s</code> contains no HTML tag, the slice will be empty</label><br>
    
    </div>
    </p>
    <input id="d1a73226-b293-11f0-938a-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('d1a73226-b293-11f0-938a-6298cf1a5790', 12, 1, '[1, 2, 3][1:]')">
    <span class="quiz_hint" id="d1a73226-b293-11f0-938a-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
<p>Indeed, our dynamic slices reflect dependencies as they occurred within a single execution. As the execution changes, so do the dependencies.</p>
</section>
<section id="tracking-techniques">
<h2>Tracking Techniques<a class="headerlink" href="#tracking-techniques" title="Link to this heading">#</a></h2>
<p>For the remainder of this chapter, let us investigate means to <em>determine such dependencies</em> automatically – by <em>collecting</em> them during program execution. The idea is that with a single Python call, we can collect the dependencies for some computation, and present them to programmers – as graphs or as code annotations, as shown above.</p>
<p>To track dependencies, for every variable, we need to keep track of its <em>origins</em> – where it obtained its value, and which tests controlled its assignments. There are two ways to do so:</p>
<ul class="simple">
<li><p>Wrapping Data Objects</p></li>
<li><p>Wrapping Data Accesses</p></li>
</ul>
<section id="wrapping-data-objects">
<h3>Wrapping Data Objects<a class="headerlink" href="#wrapping-data-objects" title="Link to this heading">#</a></h3>
<p>One way to track origins is to <em>wrap</em> each value in a class that stores both a value and the origin of the value. If a variable <code class="docutils literal notranslate"><span class="pre">x</span></code> is initialized to zero in Line 3, for instance, we could store it as</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">origin</span><span class="o">=&lt;</span><span class="n">Line</span> <span class="mi">3</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div>
</div>
<p>and if it is copied in, say, Line 5 to another variable <code class="docutils literal notranslate"><span class="pre">y</span></code>, we could store this as</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">origin</span><span class="o">=&lt;</span><span class="n">Line</span> <span class="mi">3</span><span class="p">,</span> <span class="n">Line</span> <span class="mi">5</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div>
</div>
<p>Such a scheme would allow us to track origins and dependencies right within the variable.</p>
<p>In a language like Python, it is actually possibly to subclass from basic types. Here’s how we create a <code class="docutils literal notranslate"><span class="pre">MyInt</span></code> subclass of <code class="docutils literal notranslate"><span class="pre">int</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyInt</span><span class="p">(</span><span class="nb">int</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span><span class="p">:</span> <span class="n">MyInt</span> <span class="o">=</span> <span class="n">MyInt</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can access <code class="docutils literal notranslate"><span class="pre">n</span></code> just like any integer:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5, 6)
</pre></div>
</div>
</div>
</div>
<p>However, we can also add extra attributes to it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="s2">&quot;Line 5&quot;</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span><span class="o">.</span><span class="n">origin</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Line 5&#39;
</pre></div>
</div>
</div>
</div>
<p>Such a “wrapping” scheme has the advantage of <em>leaving program code untouched</em> – simply pass “wrapped” objects instead of the original values. However, it also has a number of drawbacks.</p>
<ul class="simple">
<li><p>First, we must make sure that the “wrapper” objects are still compatible with the original values – notably by converting them back whenever needed. (What happens if an internal Python function expects an <code class="docutils literal notranslate"><span class="pre">int</span></code> and gets a <code class="docutils literal notranslate"><span class="pre">MyInt</span></code> instead?)</p></li>
<li><p>Second, we have to make sure that origins do not get lost during computations – which involves overloading operators such as <code class="docutils literal notranslate"><span class="pre">+</span></code>, <code class="docutils literal notranslate"><span class="pre">-</span></code>, <code class="docutils literal notranslate"><span class="pre">*</span></code>, and so on. (Right now, <code class="docutils literal notranslate"><span class="pre">MyInt(1)</span> <span class="pre">+</span> <span class="pre">1</span></code> gives us an <code class="docutils literal notranslate"><span class="pre">int</span></code> object, not a <code class="docutils literal notranslate"><span class="pre">MyInt</span></code>.)</p></li>
<li><p>Third, we have to do this for <em>all</em> data types of a language, which is pretty tedious.</p></li>
<li><p>Fourth and last, however, we want to track whenever a value is assigned to another variable. Python has no support for this, and thus our dependencies will necessarily be incomplete.</p></li>
</ul>
</section>
<section id="wrapping-data-accesses">
<h3>Wrapping Data Accesses<a class="headerlink" href="#wrapping-data-accesses" title="Link to this heading">#</a></h3>
<p>An alternate way of tracking origins is to <em>instrument</em> the source code such that all <em>data read and write operations are tracked</em>. That is, the original data stays unchanged, but we change the code instead.</p>
<p>In essence, for every occurrence of a variable <code class="docutils literal notranslate"><span class="pre">x</span></code> being <em>read</em>, we replace it with</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>  <span class="c1"># returns x</span>
</pre></div>
</div>
<p>and for every occurrence of a value being <em>written</em> to <code class="docutils literal notranslate"><span class="pre">x</span></code>, we replace the value with</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">_data</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="c1"># returns value</span>
</pre></div>
</div>
<p>and let the <code class="docutils literal notranslate"><span class="pre">_data</span></code> object track these reads and writes.</p>
<p>Hence, an assignment such as</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span>
</pre></div>
</div>
<p>would get rewritten to</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">_data</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
</pre></div>
</div>
<p>and with every access to <code class="docutils literal notranslate"><span class="pre">_data</span></code>, we would track</p>
<ol class="arabic simple">
<li><p>the current <em>location</em> in the code, and</p></li>
<li><p>whether the respective variable was read or written.</p></li>
</ol>
<p>For the above statement, we could deduce that <code class="docutils literal notranslate"><span class="pre">b</span></code> and <code class="docutils literal notranslate"><span class="pre">c</span></code> were read, and <code class="docutils literal notranslate"><span class="pre">a</span></code> was written – which makes <code class="docutils literal notranslate"><span class="pre">a</span></code> data dependent on <code class="docutils literal notranslate"><span class="pre">b</span></code> and <code class="docutils literal notranslate"><span class="pre">c</span></code>.</p>
<p>The advantage of such instrumentation is that it works with <em>arbitrary objects</em> (in Python, that is) – we do not care whether <code class="docutils literal notranslate"><span class="pre">a</span></code>, <code class="docutils literal notranslate"><span class="pre">b</span></code>, and <code class="docutils literal notranslate"><span class="pre">c</span></code> would be integers, floats, strings, lists or any other type for which <code class="docutils literal notranslate"><span class="pre">+</span></code> would be defined. Also, the code semantics remain entirely unchanged.</p>
<p>The disadvantage, however, is that it takes a bit of effort to exactly separate reads and writes into individual groups, and that a number of language features have to be handled separately. This is what we do in the remainder of this chapter.</p>
</section>
</section>
<section id="a-data-tracker">
<h2>A Data Tracker<a class="headerlink" href="#a-data-tracker" title="Link to this heading">#</a></h2>
<p>To implement <code class="docutils literal notranslate"><span class="pre">_data</span></code> accesses as shown above, we introduce the <code class="docutils literal notranslate"><span class="pre">DataTracker</span></code> class. As its name suggests, it keeps track of variables being read and written, and provides methods to determine the code location where this took place.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DataTracker</span><span class="p">(</span><span class="n">StackInspector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Track data accesses during execution&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor. If `log` is set, turn on logging.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">set()</span></code> is invoked when a variable is set, as in</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pi</span> <span class="o">=</span> <span class="n">_data</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;pi&#39;</span><span class="p">,</span> <span class="mf">3.1415</span><span class="p">)</span>
</pre></div>
</div>
<p>By default, we simply log the access using name and value. (<code class="docutils literal notranslate"><span class="pre">loads</span></code> will be used later.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DataTracker</span><span class="p">(</span><span class="n">DataTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">loads</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Track setting `name` to `value`.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="n">caller_func</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller_location</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">caller_func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s2">: setting </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">value</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">get()</span></code> is invoked when a variable is retrieved, as in</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pi&#39;</span><span class="p">,</span> <span class="n">pi</span><span class="p">))</span>
</pre></div>
</div>
<p>By default, we simply log the access.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DataTracker</span><span class="p">(</span><span class="n">DataTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Track getting `value` from `name`.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="n">caller_func</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller_location</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">caller_func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s2">: getting </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">value</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s an example of a logging <code class="docutils literal notranslate"><span class="pre">DataTracker</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_test_data</span> <span class="o">=</span> <span class="n">DataTracker</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">_test_data</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;module&gt;:2: setting x
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_test_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;module&gt;:1: getting x
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
</div>
</div>
</section>
<section id="instrumenting-source-code">
<h2>Instrumenting Source Code<a class="headerlink" href="#instrumenting-source-code" title="Link to this heading">#</a></h2>
<p>How do we transform source code such that read and write accesses to variables would be automatically rewritten?  To this end, we inspect the internal representation of source code, namely the <em>abstract syntax trees</em> (ASTs). An AST represents the code as a tree, with specific node types for each syntactical element.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">ast</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">show_ast</span>
</pre></div>
</div>
</div>
</div>
<p>Here is the tree representation for our <code class="docutils literal notranslate"><span class="pre">middle()</span></code> function. It starts with a <code class="docutils literal notranslate"><span class="pre">FunctionDef</span></code> node at the top (with the name <code class="docutils literal notranslate"><span class="pre">&quot;middle&quot;</span></code> and the three arguments <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, <code class="docutils literal notranslate"><span class="pre">z</span></code> as children), followed by a subtree for each of the <code class="docutils literal notranslate"><span class="pre">If</span></code> statements, each of which contains a branch for when their condition evaluates to <code class="docutils literal notranslate"><span class="pre">True</span></code> and a branch for when their condition evaluates to <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">middle_tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">middle</span><span class="p">))</span>
<span class="n">show_ast</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7159efc465b26f9b44c9f3ab5c9ae5cf1d0cec6a24edc52ac2fd6f18bc887365.svg" src="_images/7159efc465b26f9b44c9f3ab5c9ae5cf1d0cec6a24edc52ac2fd6f18bc887365.svg" />
</div>
</div>
<p>At the very bottom of the tree, you can see a number of <code class="docutils literal notranslate"><span class="pre">Name</span></code> nodes, referring individual variables. These are the ones we want to transform.</p>
<section id="tracking-variable-accesses">
<h3>Tracking Variable Accesses<a class="headerlink" href="#tracking-variable-accesses" title="Link to this heading">#</a></h3>
<p>Our goal is to <em>traverse</em> the tree, identify all <code class="docutils literal notranslate"><span class="pre">Name</span></code> nodes, and convert them to respective <code class="docutils literal notranslate"><span class="pre">_data</span></code> accesses.
To this end, we manipulate the AST through the <code class="docutils literal notranslate"><span class="pre">ast</span></code> Python module <code class="docutils literal notranslate"><span class="pre">ast</span></code>. The <a class="reference external" href="http://docs.python.org/3/library/ast">official Python <code class="docutils literal notranslate"><span class="pre">ast</span></code> reference</a> is complete, but a bit brief; the documentation <a class="reference external" href="https://greentreesnakes.readthedocs.io/en/latest/">“Green Tree Snakes - the missing Python AST docs”</a> provides an excellent introduction.</p>
<p>The Python <code class="docutils literal notranslate"><span class="pre">ast</span></code> module provides a class <code class="docutils literal notranslate"><span class="pre">NodeTransformer</span></code> that allows such transformations. By subclassing from it, we provide a method <code class="docutils literal notranslate"><span class="pre">visit_Name()</span></code> that will be invoked for all <code class="docutils literal notranslate"><span class="pre">Name</span></code> nodes – and replace it by a new subtree from <code class="docutils literal notranslate"><span class="pre">make_get_data()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ast</span><span class="w"> </span><span class="kn">import</span> <span class="n">NodeTransformer</span><span class="p">,</span> <span class="n">NodeVisitor</span><span class="p">,</span> <span class="n">Name</span><span class="p">,</span> <span class="n">AST</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">typing</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DATA_TRACKER</span> <span class="o">=</span> <span class="s1">&#39;_data&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">is_internal</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return True if `id` is a built-in function or type&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">id</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">__builtins__</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">typing</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">is_internal</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">is_internal</span><span class="p">(</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">is_internal</span><span class="p">(</span><span class="s1">&#39;Tuple&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TrackGetTransformer</span><span class="p">(</span><span class="n">NodeTransformer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AST</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_internal</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
            <span class="c1"># Do not change built-in names and types</span>
            <span class="k">return</span> <span class="n">node</span>

        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">DATA_TRACKER</span><span class="p">:</span>
            <span class="c1"># Do not change own accesses</span>
            <span class="k">return</span> <span class="n">node</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="n">Load</span><span class="p">):</span>
            <span class="c1"># Only change loads (not stores, not deletions)</span>
            <span class="k">return</span> <span class="n">node</span>

        <span class="n">new_node</span> <span class="o">=</span> <span class="n">make_get_data</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">ast</span><span class="o">.</span><span class="n">copy_location</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_node</span>
</pre></div>
</div>
</div>
</div>
<p>Our function <code class="docutils literal notranslate"><span class="pre">make_get_data(id,</span> <span class="pre">method)</span></code> returns a new subtree equivalent to the Python code <code class="docutils literal notranslate"><span class="pre">_data.method('id',</span> <span class="pre">id)</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ast</span><span class="w"> </span><span class="kn">import</span> <span class="n">Module</span><span class="p">,</span> <span class="n">Load</span><span class="p">,</span> <span class="n">Store</span><span class="p">,</span> \
    <span class="n">Attribute</span><span class="p">,</span> <span class="n">With</span><span class="p">,</span> <span class="n">withitem</span><span class="p">,</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">Call</span><span class="p">,</span> <span class="n">Expr</span><span class="p">,</span> \
    <span class="n">Assign</span><span class="p">,</span> <span class="n">AugAssign</span><span class="p">,</span> <span class="n">AnnAssign</span><span class="p">,</span> <span class="n">Assert</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Starting with Python 3.8, these will become Constant.</span>
<span class="c1"># from ast import Num, Str, NameConstant</span>
<span class="c1"># Use `ast.Num`, `ast.Str`, and `ast.NameConstant` for compatibility</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">make_get_data</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;get&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Call</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">Call</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">Attribute</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">DATA_TRACKER</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">Load</span><span class="p">()),</span> 
                               <span class="n">attr</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">Load</span><span class="p">()),</span>
                <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">Str</span><span class="p">(</span><span class="nb">id</span><span class="p">),</span> <span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">Load</span><span class="p">())],</span>
                <span class="n">keywords</span><span class="o">=</span><span class="p">[])</span>
</pre></div>
</div>
</div>
</div>
<p>This is the tree that <code class="docutils literal notranslate"><span class="pre">make_get_data()</span></code> produces:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_ast</span><span class="p">(</span><span class="n">Module</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="p">[</span><span class="n">make_get_data</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)],</span> <span class="n">type_ignores</span><span class="o">=</span><span class="p">[]))</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/3554319793.py:4: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(id), Name(id=id, ctx=Load())],
</pre></div>
</div>
<img alt="_images/d40814e4c0eac75358402cf03deded854f05bf80b93c889fb44508fe56fb07a1.svg" src="_images/d40814e4c0eac75358402cf03deded854f05bf80b93c889fb44508fe56fb07a1.svg" />
</div>
</div>
<p>How do we know that this is a correct subtree? We can carefully read the <a class="reference external" href="http://docs.python.org/3/library/ast">official Python <code class="docutils literal notranslate"><span class="pre">ast</span></code> reference</a> and then proceed by trial and error (and apply <a class="reference internal" href="DeltaDebugger.html"><span class="std std-doc">delta debugging</span></a> to determine error causes). Or – pro tip! – we can simply take a piece of Python code, parse it and use <code class="docutils literal notranslate"><span class="pre">ast.dump()</span></code> to print out how to construct the resulting AST:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;_data.get(&#39;x&#39;, x)&quot;</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Module(body=[Expr(value=Call(func=Attribute(value=Name(id=&#39;_data&#39;, ctx=Load()), attr=&#39;get&#39;, ctx=Load()), args=[Constant(value=&#39;x&#39;), Name(id=&#39;x&#39;, ctx=Load())]))])
</pre></div>
</div>
</div>
</div>
<p>If you compare the above output with the code of <code class="docutils literal notranslate"><span class="pre">make_get_data()</span></code>, above, you will find out where the source of <code class="docutils literal notranslate"><span class="pre">make_get_data()</span></code> comes from.</p>
<p>Let us put <code class="docutils literal notranslate"><span class="pre">TrackGetTransformer</span></code> to action. Its <code class="docutils literal notranslate"><span class="pre">visit()</span></code> method calls <code class="docutils literal notranslate"><span class="pre">visit_Name()</span></code>, which then in turn transforms the <code class="docutils literal notranslate"><span class="pre">Name</span></code> nodes as we want it. This happens in place.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">TrackGetTransformer</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/3554319793.py:4: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(id), Name(id=id, ctx=Load())],
</pre></div>
</div>
</div>
</div>
<p>To see the effect of our transformations, we introduce a method <code class="docutils literal notranslate"><span class="pre">dump_tree()</span></code> which outputs the tree – and also compiles it to check for any inconsistencies.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">dump_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">tree</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">fix_missing_locations</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>  <span class="c1"># Must run this before compiling</span>
    <span class="n">_</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">tree</span><span class="p">),</span> <span class="s1">&#39;&lt;dump_tree&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We see that our transformer has properly replaced all variable accesses:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dump_tree</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">middle</span>(x, y, z):
    <span class=" -Color -Color-Blue">if</span> _data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y) &lt; _data.get(<span class=" -Color -Color-Yellow">&#39;z&#39;</span>, z):
        <span class=" -Color -Color-Blue">if</span> _data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x) &lt; _data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y):
            <span class=" -Color -Color-Blue">return</span> _data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y)
        <span class=" -Color -Color-Blue">elif</span> _data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x) &lt; _data.get(<span class=" -Color -Color-Yellow">&#39;z&#39;</span>, z):
            <span class=" -Color -Color-Blue">return</span> _data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y)
    <span class=" -Color -Color-Blue">elif</span> _data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x) &gt; _data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y):
        <span class=" -Color -Color-Blue">return</span> _data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y)
    <span class=" -Color -Color-Blue">elif</span> _data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x) &gt; _data.get(<span class=" -Color -Color-Yellow">&#39;z&#39;</span>, z):
        <span class=" -Color -Color-Blue">return</span> _data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x)
    <span class=" -Color -Color-Blue">return</span> _data.get(<span class=" -Color -Color-Yellow">&#39;z&#39;</span>, z)
</pre></div>
</div>
</div>
</div>
<p>Let us now execute this code together with the <code class="docutils literal notranslate"><span class="pre">DataTracker()</span></code> class we previously introduced. The class <code class="docutils literal notranslate"><span class="pre">DataTrackerTester()</span></code> takes a (transformed) tree and a function. Using it as</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">DataTrackerTester</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
    <span class="n">func</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>first executes the code in <em>tree</em> (possibly instrumenting <code class="docutils literal notranslate"><span class="pre">func</span></code>) and then the <code class="docutils literal notranslate"><span class="pre">with</span></code> body. At the end, <code class="docutils literal notranslate"><span class="pre">func</span></code> is restored to its previous (non-instrumented) version.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">types</span><span class="w"> </span><span class="kn">import</span> <span class="n">TracebackType</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DataTrackerTester</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">AST</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor. Execute the code in `tree` while instrumenting `func`.&quot;&quot;&quot;</span>
        <span class="c1"># We pass the source file of `func` such that we can retrieve it</span>
        <span class="c1"># when accessing the location of the new compiled code</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcefile</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">tree</span><span class="p">),</span> <span class="n">source</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make_data_tracker</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DataTracker</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rewrite function&quot;&quot;&quot;</span>
        <span class="n">tracker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_data_tracker</span><span class="p">()</span>
        <span class="nb">globals</span><span class="p">()[</span><span class="n">DATA_TRACKER</span><span class="p">]</span> <span class="o">=</span> <span class="n">tracker</span>
        <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">tracker</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">:</span> <span class="ne">BaseException</span><span class="p">,</span>
                 <span class="n">traceback</span><span class="p">:</span> <span class="n">TracebackType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Restore function&quot;&quot;&quot;</span>
        <span class="nb">globals</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span>
        <span class="k">del</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">DATA_TRACKER</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
<p>Here is our <code class="docutils literal notranslate"><span class="pre">middle()</span></code> function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">middle</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="n">start_line_number</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 1  <span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">middle</span>(x, y, z):  <span class=" -Color -Color-White"># type: ignore</span>
 2      <span class=" -Color -Color-Blue">if</span> y &lt; z:
 3          <span class=" -Color -Color-Blue">if</span> x &lt; y:
 4              <span class=" -Color -Color-Blue">return</span> y
 5          <span class=" -Color -Color-Blue">elif</span> x &lt; z:
 6              <span class=" -Color -Color-Blue">return</span> y
 7      <span class=" -Color -Color-Blue">else</span>:
 8          <span class=" -Color -Color-Blue">if</span> x &gt; y:
 9              <span class=" -Color -Color-Blue">return</span> y
10          <span class=" -Color -Color-Blue">elif</span> x &gt; z:
11              <span class=" -Color -Color-Blue">return</span> x
12      <span class=" -Color -Color-Blue">return</span> z
</pre></div>
</div>
</div>
</div>
<p>And here is our instrumented <code class="docutils literal notranslate"><span class="pre">middle_tree</span></code> executed with a <code class="docutils literal notranslate"><span class="pre">DataTracker</span></code> object. We see how the <code class="docutils literal notranslate"><span class="pre">middle()</span></code> tests access one argument after another.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">DataTrackerTester</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">,</span> <span class="n">middle</span><span class="p">):</span>
    <span class="n">middle</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>middle:2: getting y
middle:2: getting z
middle:3: getting x
middle:3: getting y
middle:5: getting x
middle:5: getting z
middle:6: getting y
</pre></div>
</div>
</div>
</div>
<p>After <code class="docutils literal notranslate"><span class="pre">DataTrackerTester</span></code> is done, <code class="docutils literal notranslate"><span class="pre">middle</span></code> is reverted to its non-instrumented version:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">middle</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
</div>
</div>
<p>For a complete picture of what happens during executions, we implement a number of additional code transformers.</p>
<p>For each assignment statement <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">=</span> <span class="pre">y</span></code>, we change it to <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">=</span> <span class="pre">_data.set('x',</span> <span class="pre">y)</span></code>. This allows <strong>tracking assignments</strong>.</p>
</section>
<section id="excursion-tracking-assignments-and-assertions">
<h3>Excursion: Tracking Assignments and Assertions<a class="headerlink" href="#excursion-tracking-assignments-and-assertions" title="Link to this heading">#</a></h3>
<p>For the remaining transformers, we follow the same steps as for <code class="docutils literal notranslate"><span class="pre">TrackGetTransformer</span></code>, except that our <code class="docutils literal notranslate"><span class="pre">visit_...()</span></code> methods focus on different nodes, and return different subtrees. Here, we focus on assignment nodes.</p>
<p>We want to transform assignments <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">=</span> <span class="pre">value</span></code> into <code class="docutils literal notranslate"><span class="pre">_data.set('x',</span> <span class="pre">value)</span></code> to track assignments to <code class="docutils literal notranslate"><span class="pre">x</span></code>.</p>
<p>If the left-hand side of the assignment is more complex, as in <code class="docutils literal notranslate"><span class="pre">x[y]</span> <span class="pre">=</span> <span class="pre">value</span></code>, we want to ensure the read access to <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> is also tracked. By transforming <code class="docutils literal notranslate"><span class="pre">x[y]</span> <span class="pre">=</span> <span class="pre">value</span></code> into <code class="docutils literal notranslate"><span class="pre">_data.set('x',</span> <span class="pre">value,</span> <span class="pre">loads=(x,</span> <span class="pre">y))</span></code>, we ensure that <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> are marked as read (as the otherwise ignored <code class="docutils literal notranslate"><span class="pre">loads</span></code> argument would be changed to <code class="docutils literal notranslate"><span class="pre">_data.get()</span></code> calls for <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code>).</p>
<p>Using <code class="docutils literal notranslate"><span class="pre">ast.dump()</span></code>, we reveal what the corresponding syntax tree has to look like:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;_data.set(&#39;x&#39;, value, loads=(a, b))&quot;</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Module(body=[Expr(value=Call(func=Attribute(value=Name(id=&#39;_data&#39;, ctx=Load()), attr=&#39;set&#39;, ctx=Load()), args=[Constant(value=&#39;x&#39;), Name(id=&#39;value&#39;, ctx=Load())], keywords=[keyword(arg=&#39;loads&#39;, value=Tuple(elts=[Name(id=&#39;a&#39;, ctx=Load()), Name(id=&#39;b&#39;, ctx=Load())], ctx=Load()))]))])
</pre></div>
</div>
</div>
</div>
<p>Using this structure, we can write a function <code class="docutils literal notranslate"><span class="pre">make_set_data()</span></code> which constructs such a subtree.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">make_set_data</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> 
                  <span class="n">loads</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;set&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Call</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct a subtree _data.`method`(&#39;`id`&#39;, `value`). </span>
<span class="sd">    If `loads` is set to [X1, X2, ...], make it</span>
<span class="sd">    _data.`method`(&#39;`id`&#39;, `value`, loads=(X1, X2, ...))</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">keywords</span><span class="o">=</span><span class="p">[]</span>

    <span class="k">if</span> <span class="n">loads</span><span class="p">:</span>
        <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">keyword</span><span class="p">(</span><span class="n">arg</span><span class="o">=</span><span class="s1">&#39;loads&#39;</span><span class="p">,</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">(</span>
                        <span class="n">elts</span><span class="o">=</span><span class="p">[</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">load</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">Load</span><span class="p">())</span> <span class="k">for</span> <span class="n">load</span> <span class="ow">in</span> <span class="n">loads</span><span class="p">],</span>
                        <span class="n">ctx</span><span class="o">=</span><span class="n">Load</span><span class="p">()</span>
                    <span class="p">))</span>
        <span class="p">]</span>

    <span class="n">new_node</span> <span class="o">=</span> <span class="n">Call</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">Attribute</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">DATA_TRACKER</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">Load</span><span class="p">()),</span>
                                   <span class="n">attr</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">Load</span><span class="p">()),</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">Str</span><span class="p">(</span><span class="nb">id</span><span class="p">),</span> <span class="n">value</span><span class="p">],</span>
                    <span class="n">keywords</span><span class="o">=</span><span class="n">keywords</span><span class="p">)</span>

    <span class="n">ast</span><span class="o">.</span><span class="n">copy_location</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_node</span>
</pre></div>
</div>
</div>
</div>
<p>The problem is, however: How do we get the name of the variable being assigned to? The left-hand side of an assignment can be a complex expression such as <code class="docutils literal notranslate"><span class="pre">x[i]</span></code>. We use the leftmost name of the left-hand side as name to be assigned to.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">LeftmostNameVisitor</span><span class="p">(</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leftmost_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">leftmost_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">leftmost_name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">leftmost_name</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">visitor</span> <span class="o">=</span> <span class="n">LeftmostNameVisitor</span><span class="p">()</span>
    <span class="n">visitor</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="n">leftmost_name</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">leftmost_name</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;a[x] = 25&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;a&#39;
</pre></div>
</div>
</div>
</div>
<p>Python also allows <em>tuple assignments</em>, as in <code class="docutils literal notranslate"><span class="pre">(a,</span> <span class="pre">b,</span> <span class="pre">c)</span> <span class="pre">=</span> <span class="pre">(1,</span> <span class="pre">2,</span> <span class="pre">3)</span></code>. We extract all variables being stored (that is, expressions whose <code class="docutils literal notranslate"><span class="pre">ctx</span></code> attribute is <code class="docutils literal notranslate"><span class="pre">Store()</span></code>) and extract their (leftmost) names.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">StoreVisitor</span><span class="p">(</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;ctx&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="n">Store</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">leftmost_name</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">store_names</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">visitor</span> <span class="o">=</span> <span class="n">StoreVisitor</span><span class="p">()</span>
    <span class="n">visitor</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="n">names</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">store_names</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;a[x], b[y], c = 1, 2, 3&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;a&#39;, &#39;b&#39;, &#39;c&#39;}
</pre></div>
</div>
</div>
</div>
<p>For complex assignments, we also want to access the names read in the left hand side of an expression.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">LoadVisitor</span><span class="p">(</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;ctx&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="n">Load</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">leftmost_name</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">load_names</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">visitor</span> <span class="o">=</span> <span class="n">LoadVisitor</span><span class="p">()</span>
    <span class="n">visitor</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="n">names</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">load_names</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;a[x], b[y], c = 1, 2, 3&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;a&#39;, &#39;b&#39;, &#39;x&#39;, &#39;y&#39;}
</pre></div>
</div>
</div>
</div>
<p>With this, we can now define <code class="docutils literal notranslate"><span class="pre">TrackSetTransformer</span></code> as a transformer for regular assignments. Note that in Python, an assignment can have multiple targets, as in <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">=</span> <span class="pre">b</span> <span class="pre">=</span> <span class="pre">c</span></code>; we assign the data dependencies of <code class="docutils literal notranslate"><span class="pre">c</span></code> to them all.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TrackSetTransformer</span><span class="p">(</span><span class="n">NodeTransformer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Assign</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Assign</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">DATA_TRACKER</span> <span class="o">+</span> <span class="s1">&#39;.set&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">node</span>  <span class="c1"># Do not apply twice</span>

        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
            <span class="n">loads</span> <span class="o">=</span> <span class="n">load_names</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">store_name</span> <span class="ow">in</span> <span class="n">store_names</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
                <span class="n">node</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">make_set_data</span><span class="p">(</span><span class="n">store_name</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> 
                                           <span class="n">loads</span><span class="o">=</span><span class="n">loads</span><span class="p">)</span>
                <span class="n">loads</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">node</span>
</pre></div>
</div>
</div>
</div>
<p>The special form of “augmented assign” needs special treatment. We change statements of the form <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">+=</span> <span class="pre">y</span></code> to <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">+=</span> <span class="pre">_data.augment('x',</span> <span class="pre">y)</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TrackSetTransformer</span><span class="p">(</span><span class="n">TrackSetTransformer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_AugAssign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">AugAssign</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AugAssign</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">DATA_TRACKER</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">node</span>  <span class="c1"># Do not apply twice</span>

        <span class="nb">id</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">leftmost_name</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">))</span>
        <span class="n">node</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">make_set_data</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;augment&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">node</span>
</pre></div>
</div>
</div>
</div>
<p>The corresponding <code class="docutils literal notranslate"><span class="pre">augment()</span></code> method uses a combination of <code class="docutils literal notranslate"><span class="pre">set()</span></code> and <code class="docutils literal notranslate"><span class="pre">get()</span></code> to reflect the semantics.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DataTracker</span><span class="p">(</span><span class="n">DataTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">augment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Track augmenting `name` with `value`.</span>
<span class="sd">        To be overloaded in subclasses.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">value</span>
</pre></div>
</div>
</div>
</div>
<p>“Annotated” assignments come with a type, as in <code class="docutils literal notranslate"><span class="pre">x:</span> <span class="pre">int</span> <span class="pre">=</span> <span class="pre">3</span></code>. We treat them like regular assignments.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TrackSetTransformer</span><span class="p">(</span><span class="n">TrackSetTransformer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_AnnAssign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">AnnAssign</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AnnAssign</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">node</span>  <span class="c1"># just &lt;var&gt;: &lt;type&gt; without value</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">DATA_TRACKER</span> <span class="o">+</span> <span class="s1">&#39;.set&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">node</span>  <span class="c1"># Do not apply twice</span>

        <span class="n">loads</span> <span class="o">=</span> <span class="n">load_names</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">store_name</span> <span class="ow">in</span> <span class="n">store_names</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">):</span>
            <span class="n">node</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">make_set_data</span><span class="p">(</span><span class="n">store_name</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> 
                                       <span class="n">loads</span><span class="o">=</span><span class="n">loads</span><span class="p">)</span>
            <span class="n">loads</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">node</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we treat <em>assertions</em> just as if they were assignments to special variables:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TrackSetTransformer</span><span class="p">(</span><span class="n">TrackSetTransformer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Assert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Assert</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Assert</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">DATA_TRACKER</span> <span class="o">+</span> <span class="s1">&#39;.set&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">node</span>  <span class="c1"># Do not apply twice</span>

        <span class="n">loads</span> <span class="o">=</span> <span class="n">load_names</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">test</span> <span class="o">=</span> <span class="n">make_set_data</span><span class="p">(</span><span class="s2">&quot;&lt;assertion&gt;&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">loads</span><span class="o">=</span><span class="n">loads</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s all of these transformers in action. Our original function has a number of assignments:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">assign_test</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>  <span class="c1"># type: ignore</span>
    <span class="n">forty_two</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span>
    <span class="n">forty_two</span> <span class="o">=</span> <span class="n">forty_two</span> <span class="o">=</span> <span class="mi">42</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">d</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span>
    <span class="n">c</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span><span class="o">.</span><span class="n">attr</span> <span class="o">=</span> <span class="mi">47</span>  <span class="c1"># type: ignore</span>
    <span class="n">a</span> <span class="o">*=</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">forty_two</span><span class="p">,</span> <span class="s2">&quot;Forty-Two&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">assign_tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">assign_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">TrackSetTransformer</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">assign_tree</span><span class="p">)</span>
<span class="n">dump_tree</span><span class="p">(</span><span class="n">assign_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">assign_test</span>(x: <span class=" -Color -Color-Cyan">int</span>) -&gt; Tuple[<span class=" -Color -Color-Cyan">int</span>, <span class=" -Color -Color-Cyan">str</span>]:
    forty_two: <span class=" -Color -Color-Cyan">int</span> = _data.set(<span class=" -Color -Color-Yellow">&#39;forty_two&#39;</span>, <span class=" -Color -Color-Blue">42</span>)
    forty_two = forty_two = _data.set(<span class=" -Color -Color-Yellow">&#39;forty_two&#39;</span>, _data.set(<span class=" -Color -Color-Yellow">&#39;forty_two&#39;</span>, <span class=" -Color -Color-Blue">42</span>))
    a, b = _data.set(<span class=" -Color -Color-Yellow">&#39;b&#39;</span>, _data.set(<span class=" -Color -Color-Yellow">&#39;a&#39;</span>, (<span class=" -Color -Color-Blue">1</span>, <span class=" -Color -Color-Blue">2</span>)))
    c = d = _data.set(<span class=" -Color -Color-Yellow">&#39;d&#39;</span>, _data.set(<span class=" -Color -Color-Yellow">&#39;c&#39;</span>, [a, b]))
    c[d[a]].attr = _data.set(<span class=" -Color -Color-Yellow">&#39;c&#39;</span>, <span class=" -Color -Color-Blue">47</span>, loads=(a, d, c))
    a *= _data.augment(<span class=" -Color -Color-Yellow">&#39;a&#39;</span>, b + <span class=" -Color -Color-Blue">1</span>)
    <span class=" -Color -Color-Blue">assert</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;assertion&gt;&#39;</span>, a &gt; <span class=" -Color -Color-Blue">0</span>, loads=(a,))
    <span class=" -Color -Color-Blue">return</span> (forty_two, <span class=" -Color -Color-Yellow">&#39;Forty-Two&#39;</span>)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/2454789564.py:22: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(id), value],
</pre></div>
</div>
</div>
</div>
<p>If we later apply our transformer for data accesses, we can see that we track all variable reads and writes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">TrackGetTransformer</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">assign_tree</span><span class="p">)</span>
<span class="n">dump_tree</span><span class="p">(</span><span class="n">assign_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">assign_test</span>(x: <span class=" -Color -Color-Cyan">int</span>) -&gt; Tuple[<span class=" -Color -Color-Cyan">int</span>, <span class=" -Color -Color-Cyan">str</span>]:
    forty_two: <span class=" -Color -Color-Cyan">int</span> = _data.set(<span class=" -Color -Color-Yellow">&#39;forty_two&#39;</span>, <span class=" -Color -Color-Blue">42</span>)
    forty_two = forty_two = _data.set(<span class=" -Color -Color-Yellow">&#39;forty_two&#39;</span>, _data.set(<span class=" -Color -Color-Yellow">&#39;forty_two&#39;</span>, <span class=" -Color -Color-Blue">42</span>))
    a, b = _data.set(<span class=" -Color -Color-Yellow">&#39;b&#39;</span>, _data.set(<span class=" -Color -Color-Yellow">&#39;a&#39;</span>, (<span class=" -Color -Color-Blue">1</span>, <span class=" -Color -Color-Blue">2</span>)))
    c = d = _data.set(<span class=" -Color -Color-Yellow">&#39;d&#39;</span>, _data.set(<span class=" -Color -Color-Yellow">&#39;c&#39;</span>, [_data.get(<span class=" -Color -Color-Yellow">&#39;a&#39;</span>, a), _data.get(<span class=" -Color -Color-Yellow">&#39;b&#39;</span>, b)]))
    _data.get(<span class=" -Color -Color-Yellow">&#39;c&#39;</span>, c)[_data.get(<span class=" -Color -Color-Yellow">&#39;d&#39;</span>, d)[_data.get(<span class=" -Color -Color-Yellow">&#39;a&#39;</span>, a)]].attr = _data.set(<span class=" -Color -Color-Yellow">&#39;c&#39;</span>, <span class=" -Color -Color-Blue">47</span>, loads=(_data.get(<span class=" -Color -Color-Yellow">&#39;a&#39;</span>, a), _data.get(<span class=" -Color -Color-Yellow">&#39;d&#39;</span>, d), _data.get(<span class=" -Color -Color-Yellow">&#39;c&#39;</span>, c)))
    a *= _data.augment(<span class=" -Color -Color-Yellow">&#39;a&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;b&#39;</span>, b) + <span class=" -Color -Color-Blue">1</span>)
    <span class=" -Color -Color-Blue">assert</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;assertion&gt;&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;a&#39;</span>, a) &gt; <span class=" -Color -Color-Blue">0</span>, loads=(_data.get(<span class=" -Color -Color-Yellow">&#39;a&#39;</span>, a),))
    <span class=" -Color -Color-Blue">return</span> (_data.get(<span class=" -Color -Color-Yellow">&#39;forty_two&#39;</span>, forty_two), <span class=" -Color -Color-Yellow">&#39;Forty-Two&#39;</span>)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/3554319793.py:4: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(id), Name(id=id, ctx=Load())],
</pre></div>
</div>
</div>
</div>
</section>
<section id="id3">
<h3>End of Excursion<a class="headerlink" href="#id3" title="Link to this heading">#</a></h3>
<p>Each return statement <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">x</span></code> is transformed to <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">_data.set('&lt;return_value&gt;',</span> <span class="pre">x)</span></code>. This allows <strong>tracking return values</strong>.</p>
</section>
<section id="excursion-tracking-return-values">
<h3>Excursion: Tracking Return Values<a class="headerlink" href="#excursion-tracking-return-values" title="Link to this heading">#</a></h3>
<p>Our <code class="docutils literal notranslate"><span class="pre">TrackReturnTransformer</span></code> also makes use of <code class="docutils literal notranslate"><span class="pre">make_set_data()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TrackReturnTransformer</span><span class="p">(</span><span class="n">NodeTransformer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visit_FunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AsyncFunctionDef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">AST</span><span class="p">:</span>
        <span class="n">outer_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># Save current name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_name</span> <span class="o">=</span> <span class="n">outer_name</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visit_AsyncFunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AsyncFunctionDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AST</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit_FunctionDef</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">return_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tp</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;return&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2"> value&gt;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">function_name</span><span class="si">}</span><span class="s2">() </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2"> value&gt;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visit_return_or_yield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">Return</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Yield</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">YieldFrom</span><span class="p">],</span>
                              <span class="n">tp</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;return&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AST</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">DATA_TRACKER</span> <span class="o">+</span> <span class="s1">&#39;.set&#39;</span><span class="p">):</span>
                <span class="n">node</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">make_set_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">return_value</span><span class="p">(</span><span class="n">tp</span><span class="p">),</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Return</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Return</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AST</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit_return_or_yield</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="s2">&quot;return&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Yield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Yield</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AST</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit_return_or_yield</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="s2">&quot;yield&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visit_YieldFrom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">YieldFrom</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AST</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit_return_or_yield</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="s2">&quot;yield&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This is the effect of <code class="docutils literal notranslate"><span class="pre">TrackReturnTransformer</span></code>. We see that all return values are saved, and thus all locations of the corresponding return statements are tracked.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">TrackReturnTransformer</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">)</span>
<span class="n">dump_tree</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">middle</span>(x, y, z):
    <span class=" -Color -Color-Blue">if</span> _data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y) &lt; _data.get(<span class=" -Color -Color-Yellow">&#39;z&#39;</span>, z):
        <span class=" -Color -Color-Blue">if</span> _data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x) &lt; _data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y):
            <span class=" -Color -Color-Blue">return</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;middle() return value&gt;&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y))
        <span class=" -Color -Color-Blue">elif</span> _data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x) &lt; _data.get(<span class=" -Color -Color-Yellow">&#39;z&#39;</span>, z):
            <span class=" -Color -Color-Blue">return</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;middle() return value&gt;&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y))
    <span class=" -Color -Color-Blue">elif</span> _data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x) &gt; _data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y):
        <span class=" -Color -Color-Blue">return</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;middle() return value&gt;&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y))
    <span class=" -Color -Color-Blue">elif</span> _data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x) &gt; _data.get(<span class=" -Color -Color-Yellow">&#39;z&#39;</span>, z):
        <span class=" -Color -Color-Blue">return</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;middle() return value&gt;&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x))
    <span class=" -Color -Color-Blue">return</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;middle() return value&gt;&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;z&#39;</span>, z))
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/2454789564.py:22: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(id), value],
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">DataTrackerTester</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">,</span> <span class="n">middle</span><span class="p">):</span>
    <span class="n">middle</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>middle:2: getting y
middle:2: getting z
middle:3: getting x
middle:3: getting y
middle:5: getting x
middle:5: getting z
middle:6: getting y
middle:6: setting &lt;middle() return value&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="id4">
<h3>End of Excursion<a class="headerlink" href="#id4" title="Link to this heading">#</a></h3>
<p>To track <strong>control dependencies</strong>, for every block controlled by an <code class="docutils literal notranslate"><span class="pre">if</span></code>, <code class="docutils literal notranslate"><span class="pre">while</span></code>, or <code class="docutils literal notranslate"><span class="pre">for</span></code>:</p>
<ol class="arabic simple">
<li><p>We wrap their tests in a <code class="docutils literal notranslate"><span class="pre">_data.test()</span></code> wrapper. This allows us to assign pseudo-variables like <code class="docutils literal notranslate"><span class="pre">&lt;test&gt;</span></code> which hold the conditions.</p></li>
<li><p>We wrap their controlled blocks in a <code class="docutils literal notranslate"><span class="pre">with</span></code> statement. This allows us to track the variables read right before the <code class="docutils literal notranslate"><span class="pre">with</span></code> (= the controlling variables), and to restore the current controlling variables when the block is left.</p></li>
</ol>
<p>A statement</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">cond</span><span class="p">:</span>
    <span class="n">body</span>
</pre></div>
</div>
<p>thus becomes</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">_data</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">cond</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">_data</span><span class="p">:</span>
        <span class="n">body</span>
</pre></div>
</div>
</section>
<section id="excursion-tracking-control">
<h3>Excursion: Tracking Control<a class="headerlink" href="#excursion-tracking-control" title="Link to this heading">#</a></h3>
<p>To modify control statements, we traverse the tree, looking for <code class="docutils literal notranslate"><span class="pre">If</span></code> nodes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TrackControlTransformer</span><span class="p">(</span><span class="n">NodeTransformer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_If</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">If</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">If</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_test</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_with</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">orelse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_with</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">orelse</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>
</pre></div>
</div>
</div>
</div>
<p>The subtrees come from helper functions <code class="docutils literal notranslate"><span class="pre">make_with()</span></code> and <code class="docutils literal notranslate"><span class="pre">make_test()</span></code>. Again, all these subtrees are obtained via <code class="docutils literal notranslate"><span class="pre">ast.dump()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TrackControlTransformer</span><span class="p">(</span><span class="n">TrackControlTransformer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_with</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">stmt</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">stmt</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a subtree &#39;with _data: `block`&#39;&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">block_as_text</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">block_as_text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;with &#39;</span> <span class="o">+</span> <span class="n">DATA_TRACKER</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">block</span>  <span class="c1"># Do not apply twice</span>

        <span class="n">new_node</span> <span class="o">=</span> <span class="n">With</span><span class="p">(</span>
            <span class="n">items</span><span class="o">=</span><span class="p">[</span>
                <span class="n">withitem</span><span class="p">(</span>
                    <span class="n">context_expr</span><span class="o">=</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">DATA_TRACKER</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">Load</span><span class="p">()),</span>
                    <span class="n">optional_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="n">body</span><span class="o">=</span><span class="n">block</span>
        <span class="p">)</span>
        <span class="n">ast</span><span class="o">.</span><span class="n">copy_location</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">new_node</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TrackControlTransformer</span><span class="p">(</span><span class="n">TrackControlTransformer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">expr</span><span class="p">:</span>
        <span class="n">test_as_text</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">test_as_text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">DATA_TRACKER</span> <span class="o">+</span> <span class="s1">&#39;.test&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">test</span>  <span class="c1"># Do not apply twice</span>

        <span class="n">new_test</span> <span class="o">=</span> <span class="n">Call</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">Attribute</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">DATA_TRACKER</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">Load</span><span class="p">()),</span>
                                       <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
                                       <span class="n">ctx</span><span class="o">=</span><span class="n">Load</span><span class="p">()),</span>
                         <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">test</span><span class="p">],</span>
                         <span class="n">keywords</span><span class="o">=</span><span class="p">[])</span>
        <span class="n">ast</span><span class="o">.</span><span class="n">copy_location</span><span class="p">(</span><span class="n">new_test</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_test</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">while</span></code> loops are handled just like <code class="docutils literal notranslate"><span class="pre">if</span></code> constructs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TrackControlTransformer</span><span class="p">(</span><span class="n">TrackControlTransformer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_While</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">While</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">While</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_test</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_with</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">orelse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_with</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">orelse</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">for</span></code> loops gets a different treatment, as there is no condition that would control the body. Still, we ensure that setting the iterator variable is properly tracked.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TrackControlTransformer</span><span class="p">(</span><span class="n">TrackControlTransformer</span><span class="p">):</span>
    <span class="c1"># regular `for` loop</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_For</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">For</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AsyncFor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">AST</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">iter</span> <span class="o">=</span> <span class="n">make_set_data</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">iter</span><span class="p">)</span>

        <span class="c1"># Uncomment if you want iterators to control their bodies</span>
        <span class="c1"># node.body = self.make_with(node.body)</span>
        <span class="c1"># node.orelse = self.make_with(node.orelse)</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="c1"># `for` loops in async functions</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_AsyncFor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AsyncFor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AST</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit_For</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="c1"># `for` clause in comprehensions</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_comprehension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">comprehension</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AST</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">iter</span> <span class="o">=</span> <span class="n">make_set_data</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">iter</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>
</pre></div>
</div>
</div>
</div>
<p>Here is the effect of <code class="docutils literal notranslate"><span class="pre">TrackControlTransformer</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">TrackControlTransformer</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">)</span>
<span class="n">dump_tree</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">middle</span>(x, y, z):
    <span class=" -Color -Color-Blue">if</span> _data.test(_data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y) &lt; _data.get(<span class=" -Color -Color-Yellow">&#39;z&#39;</span>, z)):
        <span class=" -Color -Color-Blue">with</span> _data:
            <span class=" -Color -Color-Blue">if</span> _data.test(_data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x) &lt; _data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y)):
                <span class=" -Color -Color-Blue">with</span> _data:
                    <span class=" -Color -Color-Blue">return</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;middle() return value&gt;&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y))
            <span class=" -Color -Color-Blue">else</span>:
                <span class=" -Color -Color-Blue">with</span> _data:
                    <span class=" -Color -Color-Blue">if</span> _data.test(_data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x) &lt; _data.get(<span class=" -Color -Color-Yellow">&#39;z&#39;</span>, z)):
                        <span class=" -Color -Color-Blue">with</span> _data:
                            <span class=" -Color -Color-Blue">return</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;middle() return value&gt;&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y))
    <span class=" -Color -Color-Blue">else</span>:
        <span class=" -Color -Color-Blue">with</span> _data:
            <span class=" -Color -Color-Blue">if</span> _data.test(_data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x) &gt; _data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y)):
                <span class=" -Color -Color-Blue">with</span> _data:
                    <span class=" -Color -Color-Blue">return</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;middle() return value&gt;&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y))
            <span class=" -Color -Color-Blue">else</span>:
                <span class=" -Color -Color-Blue">with</span> _data:
                    <span class=" -Color -Color-Blue">if</span> _data.test(_data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x) &gt; _data.get(<span class=" -Color -Color-Yellow">&#39;z&#39;</span>, z)):
                        <span class=" -Color -Color-Blue">with</span> _data:
                            <span class=" -Color -Color-Blue">return</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;middle() return value&gt;&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x))
    <span class=" -Color -Color-Blue">return</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;middle() return value&gt;&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;z&#39;</span>, z))
</pre></div>
</div>
</div>
</div>
<p>We extend <code class="docutils literal notranslate"><span class="pre">DataTracker</span></code> to also log these events:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DataTracker</span><span class="p">(</span><span class="n">DataTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cond</span><span class="p">:</span> <span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AST</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test condition `cond`. To be overloaded in subclasses.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="n">caller_func</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller_location</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">caller_func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s2">: testing condition&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cond</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DataTracker</span><span class="p">(</span><span class="n">DataTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enter `with` block. To be overloaded in subclasses.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="n">caller_func</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller_location</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">caller_func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s2">: entering block&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">:</span> <span class="ne">BaseException</span><span class="p">,</span> 
                 <span class="n">traceback</span><span class="p">:</span> <span class="n">TracebackType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Exit `with` block. To be overloaded in subclasses.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="n">caller_func</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller_location</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">caller_func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s2">: exiting block&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">DataTrackerTester</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">,</span> <span class="n">middle</span><span class="p">):</span>
    <span class="n">middle</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>middle:2: getting y
middle:2: getting z
middle:2: testing condition
middle:3: entering block
middle:3: getting x
middle:3: getting y
middle:3: testing condition
middle:5: entering block
middle:5: getting x
middle:5: getting z
middle:5: testing condition
middle:6: entering block
middle:6: getting y
middle:6: setting &lt;middle() return value&gt;
middle:6: exiting block
middle:5: exiting block
middle:3: exiting block
</pre></div>
</div>
</div>
</div>
</section>
<section id="id5">
<h3>End of Excursion<a class="headerlink" href="#id5" title="Link to this heading">#</a></h3>
<p>We also want to be able to <strong>track calls</strong> across multiple functions. To this end, we wrap each call</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">func</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>into</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">_data</span><span class="o">.</span><span class="n">ret</span><span class="p">(</span><span class="n">_data</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">func</span><span class="p">)(</span><span class="n">_data</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="n">arg1</span><span class="p">),</span> <span class="n">_data</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="n">arg2</span><span class="p">),</span> <span class="o">...</span><span class="p">))</span>
</pre></div>
</div>
<p>each of which simply pass through their given argument, but which allow tracking the beginning of calls (<code class="docutils literal notranslate"><span class="pre">call()</span></code>), the computation of arguments (<code class="docutils literal notranslate"><span class="pre">arg()</span></code>), and the return of the call (<code class="docutils literal notranslate"><span class="pre">ret()</span></code>), respectively.</p>
</section>
<section id="excursion-tracking-calls-and-arguments">
<h3>Excursion: Tracking Calls and Arguments<a class="headerlink" href="#excursion-tracking-calls-and-arguments" title="Link to this heading">#</a></h3>
<p>Our <code class="docutils literal notranslate"><span class="pre">TrackCallTransformer</span></code> visits all <code class="docutils literal notranslate"><span class="pre">Call</span></code> nodes, applying the transformations as shown above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TrackCallTransformer</span><span class="p">(</span><span class="n">NodeTransformer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">AST</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                  <span class="n">pos</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">kw</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Call</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return _data.call(`func`)(`node`)&quot;&quot;&quot;</span>
        <span class="n">keywords</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># `Num()` and `Str()` are deprecated in favor of `Constant()`</span>
        <span class="k">if</span> <span class="n">pos</span><span class="p">:</span>
            <span class="n">keywords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">keyword</span><span class="p">(</span><span class="n">arg</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Num</span><span class="p">(</span><span class="n">pos</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">kw</span><span class="p">:</span>
            <span class="n">keywords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">keyword</span><span class="p">(</span><span class="n">arg</span><span class="o">=</span><span class="s1">&#39;kw&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Str</span><span class="p">(</span><span class="n">kw</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">Call</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">Attribute</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">DATA_TRACKER</span><span class="p">,</span>
                                              <span class="n">ctx</span><span class="o">=</span><span class="n">Load</span><span class="p">()),</span>
                                   <span class="n">attr</span><span class="o">=</span><span class="n">func</span><span class="p">,</span>
                                   <span class="n">ctx</span><span class="o">=</span><span class="n">Load</span><span class="p">()),</span>
                     <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">node</span><span class="p">],</span>  <span class="c1"># type: ignore</span>
                     <span class="n">keywords</span><span class="o">=</span><span class="n">keywords</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Call</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Call</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="n">call_as_text</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">call_as_text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">DATA_TRACKER</span> <span class="o">+</span> <span class="s1">&#39;.ret&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">node</span>  <span class="c1"># Already applied</span>

        <span class="n">func_as_text</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">func_as_text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">DATA_TRACKER</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">node</span>  <span class="c1"># Own function</span>

        <span class="n">new_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">):</span>
            <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">make_call</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s1">&#39;arg&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">node</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">expr</span><span class="p">],</span> <span class="n">new_args</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">keywords</span><span class="p">:</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">arg</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">kw</span><span class="p">,</span> <span class="s1">&#39;arg&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">kw</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_call</span><span class="p">(</span><span class="n">kw</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;arg&#39;</span><span class="p">,</span> <span class="n">kw</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>

        <span class="n">node</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_call</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_call</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;ret&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Our example function <code class="docutils literal notranslate"><span class="pre">middle()</span></code> does not contain any calls, but here is a function that invokes <code class="docutils literal notranslate"><span class="pre">middle()</span></code> twice:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">test_call</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">middle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">middle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">call_tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">test_call</span><span class="p">))</span>
<span class="n">dump_tree</span><span class="p">(</span><span class="n">call_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">test_call</span>() -&gt; <span class=" -Color -Color-Cyan">int</span>:
    x = middle(<span class=" -Color -Color-Blue">1</span>, <span class=" -Color -Color-Blue">2</span>, z=middle(<span class=" -Color -Color-Blue">1</span>, <span class=" -Color -Color-Blue">2</span>, <span class=" -Color -Color-Blue">3</span>))
    <span class=" -Color -Color-Blue">return</span> x
</pre></div>
</div>
</div>
</div>
<p>If we invoke <code class="docutils literal notranslate"><span class="pre">TrackCallTransformer</span></code> on this testing function, we get the following transformed code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">TrackCallTransformer</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">call_tree</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/2498757139.py:9: DeprecationWarning: ast.Num is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords.append(keyword(arg=&#39;pos&#39;, value=ast.Num(pos)))
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/2498757139.py:11: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords.append(keyword(arg=&#39;kw&#39;, value=ast.Str(kw)))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dump_tree</span><span class="p">(</span><span class="n">call_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">test_call</span>() -&gt; <span class=" -Color -Color-Cyan">int</span>:
    x = _data.ret(_data.call(middle)(_data.arg(<span class=" -Color -Color-Blue">1</span>, pos=<span class=" -Color -Color-Blue">1</span>), _data.arg(<span class=" -Color -Color-Blue">2</span>, pos=<span class=" -Color -Color-Blue">2</span>), z=_data.arg(_data.ret(_data.call(middle)(_data.arg(<span class=" -Color -Color-Blue">1</span>, pos=<span class=" -Color -Color-Blue">1</span>), _data.arg(<span class=" -Color -Color-Blue">2</span>, pos=<span class=" -Color -Color-Blue">2</span>), _data.arg(<span class=" -Color -Color-Blue">3</span>, pos=<span class=" -Color -Color-Blue">3</span>))), kw=<span class=" -Color -Color-Yellow">&#39;z&#39;</span>)))
    <span class=" -Color -Color-Blue">return</span> x
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f_tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
<span class="n">dump_tree</span><span class="p">(</span><span class="n">f_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">f</span>() -&gt; <span class=" -Color -Color-Cyan">bool</span>:
    <span class=" -Color -Color-Blue">return</span> math.isclose(<span class=" -Color -Color-Blue">1</span>, <span class=" -Color -Color-Blue">1.0</span>)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">TrackCallTransformer</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">f_tree</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/2498757139.py:9: DeprecationWarning: ast.Num is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords.append(keyword(arg=&#39;pos&#39;, value=ast.Num(pos)))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dump_tree</span><span class="p">(</span><span class="n">f_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">f</span>() -&gt; <span class=" -Color -Color-Cyan">bool</span>:
    <span class=" -Color -Color-Blue">return</span> _data.ret(_data.call(math.isclose)(_data.arg(<span class=" -Color -Color-Blue">1</span>, pos=<span class=" -Color -Color-Blue">1</span>), _data.arg(<span class=" -Color -Color-Blue">1.0</span>, pos=<span class=" -Color -Color-Blue">2</span>)))
</pre></div>
</div>
</div>
</div>
<p>As before, our default <code class="docutils literal notranslate"><span class="pre">arg()</span></code>, <code class="docutils literal notranslate"><span class="pre">ret()</span></code>, and <code class="docutils literal notranslate"><span class="pre">call()</span></code> methods simply log the event and pass through the given value.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DataTracker</span><span class="p">(</span><span class="n">DataTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">arg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">pos</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">kw</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Track `value` being passed as argument.</span>
<span class="sd">        `pos` (if given) is the argument position (starting with 1).</span>
<span class="sd">        `kw` (if given) is the argument keyword.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="n">caller_func</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller_location</span><span class="p">()</span>
            <span class="n">info</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">pos</span><span class="p">:</span>
                <span class="n">info</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; #</span><span class="si">{</span><span class="n">pos</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">kw</span><span class="p">:</span>
                <span class="n">info</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">caller_func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s2">: pushing arg</span><span class="si">{</span><span class="n">info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">value</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DataTracker</span><span class="p">(</span><span class="n">DataTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ret</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Track `value` being used as return value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="n">caller_func</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller_location</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">caller_func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s2">: returned from call&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">value</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DataTracker</span><span class="p">(</span><span class="n">DataTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">instrument_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instrument a call to `func`. To be implemented in subclasses.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">func</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Track a call to `func`.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="n">caller_func</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller_location</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">caller_func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s2">: calling </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument_call</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dump_tree</span><span class="p">(</span><span class="n">call_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">test_call</span>() -&gt; <span class=" -Color -Color-Cyan">int</span>:
    x = _data.ret(_data.call(middle)(_data.arg(<span class=" -Color -Color-Blue">1</span>, pos=<span class=" -Color -Color-Blue">1</span>), _data.arg(<span class=" -Color -Color-Blue">2</span>, pos=<span class=" -Color -Color-Blue">2</span>), z=_data.arg(_data.ret(_data.call(middle)(_data.arg(<span class=" -Color -Color-Blue">1</span>, pos=<span class=" -Color -Color-Blue">1</span>), _data.arg(<span class=" -Color -Color-Blue">2</span>, pos=<span class=" -Color -Color-Blue">2</span>), _data.arg(<span class=" -Color -Color-Blue">3</span>, pos=<span class=" -Color -Color-Blue">3</span>))), kw=<span class=" -Color -Color-Yellow">&#39;z&#39;</span>)))
    <span class=" -Color -Color-Blue">return</span> x
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">DataTrackerTester</span><span class="p">(</span><span class="n">call_tree</span><span class="p">,</span> <span class="n">test_call</span><span class="p">):</span>
    <span class="n">test_call</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>test_call:2: calling &lt;function middle at 0x10d554b80&gt;
test_call:2: pushing arg #1
test_call:2: pushing arg #2
test_call:2: calling &lt;function middle at 0x10d554b80&gt;
test_call:2: pushing arg #1
test_call:2: pushing arg #2
test_call:2: pushing arg #3
test_call:2: returned from call
test_call:2: pushing arg &#39;z&#39;
test_call:2: returned from call
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_call</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2
</pre></div>
</div>
</div>
</div>
</section>
<section id="id6">
<h3>End of Excursion<a class="headerlink" href="#id6" title="Link to this heading">#</a></h3>
<p>On the receiving end, for each function argument <code class="docutils literal notranslate"><span class="pre">x</span></code>, we insert a call <code class="docutils literal notranslate"><span class="pre">_data.param('x',</span> <span class="pre">x,</span> <span class="pre">[position</span> <span class="pre">info])</span></code> to initialize <code class="docutils literal notranslate"><span class="pre">x</span></code>. This is useful for <strong>tracking parameters across function calls.</strong></p>
</section>
<section id="excursion-tracking-parameters">
<h3>Excursion: Tracking Parameters<a class="headerlink" href="#excursion-tracking-parameters" title="Link to this heading">#</a></h3>
<p>Again, we use <code class="docutils literal notranslate"><span class="pre">ast.dump()</span></code> to determine the correct syntax tree:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;_data.param(&#39;x&#39;, x, pos=1, last=True)&quot;</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Module(body=[Expr(value=Call(func=Attribute(value=Name(id=&#39;_data&#39;, ctx=Load()), attr=&#39;param&#39;, ctx=Load()), args=[Constant(value=&#39;x&#39;), Name(id=&#39;x&#39;, ctx=Load())], keywords=[keyword(arg=&#39;pos&#39;, value=Constant(value=1)), keyword(arg=&#39;last&#39;, value=Constant(value=True))]))])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TrackParamsTransformer</span><span class="p">(</span><span class="n">NodeTransformer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">visit_FunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="n">named_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">iter_child_nodes</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">arg</span><span class="p">):</span>
                <span class="n">named_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

        <span class="n">create_stmts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">child</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">named_args</span><span class="p">):</span>
            <span class="n">keywords</span><span class="o">=</span><span class="p">[</span><span class="n">keyword</span><span class="p">(</span><span class="n">arg</span><span class="o">=</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Num</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))]</span>
            <span class="k">if</span> <span class="n">child</span> <span class="ow">is</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">vararg</span><span class="p">:</span>
                <span class="n">keywords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">keyword</span><span class="p">(</span><span class="n">arg</span><span class="o">=</span><span class="s1">&#39;vararg&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Str</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">child</span> <span class="ow">is</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">kwarg</span><span class="p">:</span>
                <span class="n">keywords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">keyword</span><span class="p">(</span><span class="n">arg</span><span class="o">=</span><span class="s1">&#39;vararg&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Str</span><span class="p">(</span><span class="s1">&#39;**&#39;</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">named_args</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">keywords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">keyword</span><span class="p">(</span><span class="n">arg</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">,</span>
                                        <span class="n">value</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">NameConstant</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>

            <span class="n">create_stmt</span> <span class="o">=</span> <span class="n">Expr</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="n">Call</span><span class="p">(</span>
                    <span class="n">func</span><span class="o">=</span><span class="n">Attribute</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">DATA_TRACKER</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">Load</span><span class="p">()),</span>
                                   <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;param&#39;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">Load</span><span class="p">()),</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">Str</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">arg</span><span class="p">),</span>
                          <span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">child</span><span class="o">.</span><span class="n">arg</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">Load</span><span class="p">())</span>
                         <span class="p">],</span>
                    <span class="n">keywords</span><span class="o">=</span><span class="n">keywords</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">ast</span><span class="o">.</span><span class="n">copy_location</span><span class="p">(</span><span class="n">create_stmt</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
            <span class="n">create_stmts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">create_stmt</span><span class="p">)</span>

        <span class="n">node</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">stmt</span><span class="p">],</span> <span class="n">create_stmts</span><span class="p">)</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span>
        <span class="k">return</span> <span class="n">node</span>
</pre></div>
</div>
</div>
</div>
<p>This is the effect of <code class="docutils literal notranslate"><span class="pre">TrackParamsTransformer()</span></code>. You see how the first three parameters are all initialized.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">TrackParamsTransformer</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">)</span>
<span class="n">dump_tree</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">middle</span>(x, y, z):
    _data.param(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x, pos=<span class=" -Color -Color-Blue">1</span>)
    _data.param(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y, pos=<span class=" -Color -Color-Blue">2</span>)
    _data.param(<span class=" -Color -Color-Yellow">&#39;z&#39;</span>, z, pos=<span class=" -Color -Color-Blue">3</span>, last=<span class=" -Color -Color-Blue">True</span>)
    <span class=" -Color -Color-Blue">if</span> _data.test(_data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y) &lt; _data.get(<span class=" -Color -Color-Yellow">&#39;z&#39;</span>, z)):
        <span class=" -Color -Color-Blue">with</span> _data:
            <span class=" -Color -Color-Blue">if</span> _data.test(_data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x) &lt; _data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y)):
                <span class=" -Color -Color-Blue">with</span> _data:
                    <span class=" -Color -Color-Blue">return</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;middle() return value&gt;&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y))
            <span class=" -Color -Color-Blue">else</span>:
                <span class=" -Color -Color-Blue">with</span> _data:
                    <span class=" -Color -Color-Blue">if</span> _data.test(_data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x) &lt; _data.get(<span class=" -Color -Color-Yellow">&#39;z&#39;</span>, z)):
                        <span class=" -Color -Color-Blue">with</span> _data:
                            <span class=" -Color -Color-Blue">return</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;middle() return value&gt;&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y))
    <span class=" -Color -Color-Blue">else</span>:
        <span class=" -Color -Color-Blue">with</span> _data:
            <span class=" -Color -Color-Blue">if</span> _data.test(_data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x) &gt; _data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y)):
                <span class=" -Color -Color-Blue">with</span> _data:
                    <span class=" -Color -Color-Blue">return</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;middle() return value&gt;&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y))
            <span class=" -Color -Color-Blue">else</span>:
                <span class=" -Color -Color-Blue">with</span> _data:
                    <span class=" -Color -Color-Blue">if</span> _data.test(_data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x) &gt; _data.get(<span class=" -Color -Color-Yellow">&#39;z&#39;</span>, z)):
                        <span class=" -Color -Color-Blue">with</span> _data:
                            <span class=" -Color -Color-Blue">return</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;middle() return value&gt;&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x))
    <span class=" -Color -Color-Blue">return</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;middle() return value&gt;&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;z&#39;</span>, z))
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:12: DeprecationWarning: ast.Num is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords=[keyword(arg=&#39;pos&#39;, value=ast.Num(n + 1))]
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:25: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(child.arg),
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:19: DeprecationWarning: ast.NameConstant is deprecated and will be removed in Python 3.14; use ast.Constant instead
  value=ast.NameConstant(value=True)))
</pre></div>
</div>
</div>
</div>
<p>By default, the <code class="docutils literal notranslate"><span class="pre">DataTracker</span></code> <code class="docutils literal notranslate"><span class="pre">param()</span></code> method simply calls <code class="docutils literal notranslate"><span class="pre">set()</span></code> to set variables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DataTracker</span><span class="p">(</span><span class="n">DataTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> 
              <span class="n">pos</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">vararg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">last</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        At the beginning of a function, track parameter `name` being set to `value`.</span>
<span class="sd">        `pos` is the position of the argument (starting with 1).</span>
<span class="sd">        `vararg` is &quot;*&quot; if `name` is a vararg parameter (as in *args),</span>
<span class="sd">        and &quot;**&quot; is `name` is a kwargs parameter (as in *kwargs).</span>
<span class="sd">        `last` is True if `name` is the last parameter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="n">caller_func</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller_location</span><span class="p">()</span>
            <span class="n">info</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">info</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; #</span><span class="si">{</span><span class="n">pos</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">caller_func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s2">: initializing </span><span class="si">{</span><span class="n">vararg</span><span class="si">}{</span><span class="n">name</span><span class="si">}{</span><span class="n">info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">DataTrackerTester</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">,</span> <span class="n">middle</span><span class="p">):</span>
    <span class="n">middle</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>middle:12: initializing x #1
middle:12: setting x
middle:12: initializing y #2
middle:12: setting y
middle:12: initializing z #3
middle:12: setting z
middle:2: getting y
middle:2: getting z
middle:2: testing condition
middle:3: entering block
middle:3: getting x
middle:3: getting y
middle:3: testing condition
middle:5: entering block
middle:5: getting x
middle:5: getting z
middle:5: testing condition
middle:6: entering block
middle:6: getting y
middle:6: setting &lt;middle() return value&gt;
middle:6: exiting block
middle:5: exiting block
middle:3: exiting block
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">args_test</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">args_tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">args_test</span><span class="p">))</span>
<span class="n">TrackParamsTransformer</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">args_tree</span><span class="p">)</span>
<span class="n">dump_tree</span><span class="p">(</span><span class="n">args_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">args_test</span>(x, *args, **kwargs):
    _data.param(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x, pos=<span class=" -Color -Color-Blue">1</span>)
    _data.param(<span class=" -Color -Color-Yellow">&#39;args&#39;</span>, args, pos=<span class=" -Color -Color-Blue">2</span>, vararg=<span class=" -Color -Color-Yellow">&#39;*&#39;</span>)
    _data.param(<span class=" -Color -Color-Yellow">&#39;kwargs&#39;</span>, kwargs, pos=<span class=" -Color -Color-Blue">3</span>, vararg=<span class=" -Color -Color-Yellow">&#39;**&#39;</span>, last=<span class=" -Color -Color-Blue">True</span>)
    <span class=" -Color -Color-Cyan">print</span>(x, *args, **kwargs)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:12: DeprecationWarning: ast.Num is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords=[keyword(arg=&#39;pos&#39;, value=ast.Num(n + 1))]
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:25: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(child.arg),
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:14: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords.append(keyword(arg=&#39;vararg&#39;, value=ast.Str(&#39;*&#39;)))
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:16: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords.append(keyword(arg=&#39;vararg&#39;, value=ast.Str(&#39;**&#39;)))
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:19: DeprecationWarning: ast.NameConstant is deprecated and will be removed in Python 3.14; use ast.Constant instead
  value=ast.NameConstant(value=True)))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">DataTrackerTester</span><span class="p">(</span><span class="n">args_tree</span><span class="p">,</span> <span class="n">args_test</span><span class="p">):</span>
    <span class="n">args_test</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>args_test:2: initializing x #1
args_test:2: setting x
args_test:2: initializing *args #2
args_test:2: setting args
args_test:2: initializing **kwargs #3
args_test:2: setting kwargs
1 2 3
</pre></div>
</div>
</div>
</div>
</section>
<section id="id7">
<h3>End of Excursion<a class="headerlink" href="#id7" title="Link to this heading">#</a></h3>
<p>What do we obtain after we have applied all these transformers on <code class="docutils literal notranslate"><span class="pre">middle()</span></code>? We see that the code now contains quite a load of instrumentation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dump_tree</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">middle</span>(x, y, z):
    _data.param(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x, pos=<span class=" -Color -Color-Blue">1</span>)
    _data.param(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y, pos=<span class=" -Color -Color-Blue">2</span>)
    _data.param(<span class=" -Color -Color-Yellow">&#39;z&#39;</span>, z, pos=<span class=" -Color -Color-Blue">3</span>, last=<span class=" -Color -Color-Blue">True</span>)
    <span class=" -Color -Color-Blue">if</span> _data.test(_data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y) &lt; _data.get(<span class=" -Color -Color-Yellow">&#39;z&#39;</span>, z)):
        <span class=" -Color -Color-Blue">with</span> _data:
            <span class=" -Color -Color-Blue">if</span> _data.test(_data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x) &lt; _data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y)):
                <span class=" -Color -Color-Blue">with</span> _data:
                    <span class=" -Color -Color-Blue">return</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;middle() return value&gt;&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y))
            <span class=" -Color -Color-Blue">else</span>:
                <span class=" -Color -Color-Blue">with</span> _data:
                    <span class=" -Color -Color-Blue">if</span> _data.test(_data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x) &lt; _data.get(<span class=" -Color -Color-Yellow">&#39;z&#39;</span>, z)):
                        <span class=" -Color -Color-Blue">with</span> _data:
                            <span class=" -Color -Color-Blue">return</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;middle() return value&gt;&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y))
    <span class=" -Color -Color-Blue">else</span>:
        <span class=" -Color -Color-Blue">with</span> _data:
            <span class=" -Color -Color-Blue">if</span> _data.test(_data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x) &gt; _data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y)):
                <span class=" -Color -Color-Blue">with</span> _data:
                    <span class=" -Color -Color-Blue">return</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;middle() return value&gt;&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y))
            <span class=" -Color -Color-Blue">else</span>:
                <span class=" -Color -Color-Blue">with</span> _data:
                    <span class=" -Color -Color-Blue">if</span> _data.test(_data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x) &gt; _data.get(<span class=" -Color -Color-Yellow">&#39;z&#39;</span>, z)):
                        <span class=" -Color -Color-Blue">with</span> _data:
                            <span class=" -Color -Color-Blue">return</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;middle() return value&gt;&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x))
    <span class=" -Color -Color-Blue">return</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;middle() return value&gt;&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;z&#39;</span>, z))
</pre></div>
</div>
</div>
</div>
<p>And when we execute this code, we see that we can track quite a number of events, while the code semantics stay unchanged.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">DataTrackerTester</span><span class="p">(</span><span class="n">middle_tree</span><span class="p">,</span> <span class="n">middle</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">middle</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">m</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>middle:12: initializing x #1
middle:12: setting x
middle:12: initializing y #2
middle:12: setting y
middle:12: initializing z #3
middle:12: setting z
middle:2: getting y
middle:2: getting z
middle:2: testing condition
middle:3: entering block
middle:3: getting x
middle:3: getting y
middle:3: testing condition
middle:5: entering block
middle:5: getting x
middle:5: getting z
middle:5: testing condition
middle:6: entering block
middle:6: getting y
middle:6: setting &lt;middle() return value&gt;
middle:6: exiting block
middle:5: exiting block
middle:3: exiting block
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
</div>
</div>
</section>
<section id="excursion-transformer-stress-test">
<h3>Excursion: Transformer Stress Test<a class="headerlink" href="#excursion-transformer-stress-test" title="Link to this heading">#</a></h3>
<p>We stress test our transformers by instrumenting, transforming, and compiling a number of modules.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">Assertions</span>  <span class="c1"># minor dependency</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">Debugger</span>  <span class="c1"># minor dependency</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Assertions</span><span class="p">,</span> <span class="n">Debugger</span><span class="p">,</span> <span class="n">inspect</span><span class="p">,</span> <span class="n">ast</span><span class="p">]:</span>
    <span class="n">module_tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module_tree</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span>

    <span class="n">TrackCallTransformer</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">module_tree</span><span class="p">)</span>
    <span class="n">TrackSetTransformer</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">module_tree</span><span class="p">)</span>
    <span class="n">TrackGetTransformer</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">module_tree</span><span class="p">)</span>
    <span class="n">TrackControlTransformer</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">module_tree</span><span class="p">)</span>
    <span class="n">TrackReturnTransformer</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">module_tree</span><span class="p">)</span>
    <span class="n">TrackParamsTransformer</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">module_tree</span><span class="p">)</span>
    <span class="c1"># dump_tree(module_tree)</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">fix_missing_locations</span><span class="p">(</span><span class="n">module_tree</span><span class="p">)</span>  <span class="c1"># Must run this before compiling</span>

    <span class="n">module_code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">module_tree</span><span class="p">,</span> <span class="s1">&#39;&lt;stress_test&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span><span class="si">}</span><span class="s2"> instrumented successfully.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Assertions&#39; instrumented successfully.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/2498757139.py:9: DeprecationWarning: ast.Num is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords.append(keyword(arg=&#39;pos&#39;, value=ast.Num(pos)))
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/2454789564.py:22: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(id), value],
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/3554319793.py:4: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(id), Name(id=id, ctx=Load())],
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:12: DeprecationWarning: ast.Num is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords=[keyword(arg=&#39;pos&#39;, value=ast.Num(n + 1))]
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:19: DeprecationWarning: ast.NameConstant is deprecated and will be removed in Python 3.14; use ast.Constant instead
  value=ast.NameConstant(value=True)))
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:25: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(child.arg),
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:14: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords.append(keyword(arg=&#39;vararg&#39;, value=ast.Str(&#39;*&#39;)))
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/2498757139.py:11: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords.append(keyword(arg=&#39;kw&#39;, value=ast.Str(kw)))
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Debugger&#39; instrumented successfully.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:16: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords.append(keyword(arg=&#39;vararg&#39;, value=ast.Str(&#39;**&#39;)))
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;inspect&#39; instrumented successfully.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;ast&#39; instrumented successfully.
</pre></div>
</div>
</div>
</div>
</section>
<section id="id8">
<h3>End of Excursion<a class="headerlink" href="#id8" title="Link to this heading">#</a></h3>
<p>Our next step will now be not only to <em>log</em> these events, but to actually construct <em>dependencies</em> from them.</p>
</section>
</section>
<section id="tracking-dependencies">
<h2>Tracking Dependencies<a class="headerlink" href="#tracking-dependencies" title="Link to this heading">#</a></h2>
<p>To construct dependencies from variable accesses, we subclass <code class="docutils literal notranslate"><span class="pre">DataTracker</span></code> into <code class="docutils literal notranslate"><span class="pre">DependencyTracker</span></code> – a class that actually keeps track of all these dependencies.  Its constructor initializes a number of variables we will discuss below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DependencyTracker</span><span class="p">(</span><span class="n">DataTracker</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Track dependencies during execution&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor. Arguments are passed to DataTracker.__init__()&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">origins</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Location</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Where current variables were last set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_dependencies</span><span class="p">:</span> <span class="n">Dependency</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># As with Dependencies, above</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_dependencies</span><span class="p">:</span> <span class="n">Dependency</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_read</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List of last read variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_checked_location</span> <span class="o">=</span> <span class="p">(</span><span class="n">StackInspector</span><span class="o">.</span><span class="n">unknown</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ignore_location_change</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[[]]</span>  <span class="c1"># Data stack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[[]]</span>  <span class="c1"># Control stack</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[{}]</span>  <span class="c1"># Argument stack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Current args</span>
</pre></div>
</div>
</div>
</div>
<section id="id9">
<h3>Data Dependencies<a class="headerlink" href="#id9" title="Link to this heading">#</a></h3>
<p>The first job of our <code class="docutils literal notranslate"><span class="pre">DependencyTracker</span></code> is to construct dependencies between <em>read</em> and <em>written</em> variables.</p>
<section id="reading-variables">
<h4>Reading Variables<a class="headerlink" href="#reading-variables" title="Link to this heading">#</a></h4>
<p>As in <code class="docutils literal notranslate"><span class="pre">DataTracker</span></code>, the key method of <code class="docutils literal notranslate"><span class="pre">DependencyTracker</span></code> again is <code class="docutils literal notranslate"><span class="pre">get()</span></code>, invoked as <code class="docutils literal notranslate"><span class="pre">_data.get('x',</span> <span class="pre">x)</span></code> whenever a variable <code class="docutils literal notranslate"><span class="pre">x</span></code> is read. First and foremost, it appends the name of the read variable to the list <code class="docutils literal notranslate"><span class="pre">last_read</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DependencyTracker</span><span class="p">(</span><span class="n">DependencyTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Track a read access for variable `name` with value `value`&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_location</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_read</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_location</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>  <span class="c1"># More on that below</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">y</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_test_data</span> <span class="o">=</span> <span class="n">DependencyTracker</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">_test_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">_test_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;module&gt;:2: getting x
&lt;module&gt;:2: getting y
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_test_data</span><span class="o">.</span><span class="n">last_read</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;x&#39;, &#39;y&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="checking-locations">
<h4>Checking Locations<a class="headerlink" href="#checking-locations" title="Link to this heading">#</a></h4>
<p>However, before appending the read variable to <code class="docutils literal notranslate"><span class="pre">last_read</span></code>, <code class="docutils literal notranslate"><span class="pre">_data.get()</span></code> does one more thing. By invoking <code class="docutils literal notranslate"><span class="pre">check_location()</span></code>, it clears the <code class="docutils literal notranslate"><span class="pre">last_read</span></code> list if we have reached a new line in the execution. This avoids situations such as</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span>
<span class="n">y</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> are, well, read, but do not affect the last line. Therefore, with every new line, the list of last read lines is cleared.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DependencyTracker</span><span class="p">(</span><span class="n">DependencyTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_read</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear set of read variables&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="n">direct_caller</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>  <span class="c1"># type: ignore</span>
            <span class="n">caller_func</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller_location</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">caller_func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s2">: &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;clearing read variables </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_read</span><span class="si">}</span><span class="s2"> &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;(from </span><span class="si">{</span><span class="n">direct_caller</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_read</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_location</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;If we are in a new location, clear set of read variables&quot;&quot;&quot;</span>
        <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller_location</span><span class="p">()</span>
        <span class="n">func</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="n">location</span>
        <span class="n">last_func</span><span class="p">,</span> <span class="n">last_lineno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_checked_location</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_checked_location</span> <span class="o">!=</span> <span class="n">location</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignore_location_change</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ignore_location_change</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">):</span>
                <span class="c1"># Entering list comprehension, eval(), exec(), ...</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">last_func</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">):</span>
                <span class="c1"># Exiting list comprehension, eval(), exec(), ...</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Standard case</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clear_read</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_checked_location</span> <span class="o">=</span> <span class="n">location</span>
</pre></div>
</div>
</div>
</div>
<p>Two methods can suppress this reset of the <code class="docutils literal notranslate"><span class="pre">last_read</span></code> list:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ignore_next_location_change()</span></code> suppresses the reset for the next line. This is useful when returning from a function, when the return value is still in the list of “read” variables.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ignore_location_change()</span></code> suppresses the reset for the current line. This is useful if we already have returned from a function call.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DependencyTracker</span><span class="p">(</span><span class="n">DependencyTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ignore_next_location_change</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ignore_location_change</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ignore_location_change</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_checked_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller_location</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Watch how <code class="docutils literal notranslate"><span class="pre">DependencyTracker</span></code> resets <code class="docutils literal notranslate"><span class="pre">last_read</span></code> when a new line is executed:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_test_data</span> <span class="o">=</span> <span class="n">DependencyTracker</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_test_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">_test_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_test_data</span><span class="o">.</span><span class="n">last_read</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;x&#39;, &#39;y&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">_test_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">_test_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>41
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_test_data</span><span class="o">.</span><span class="n">last_read</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;x&#39;, &#39;y&#39;, &#39;a&#39;, &#39;b&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="setting-variables">
<h4>Setting Variables<a class="headerlink" href="#setting-variables" title="Link to this heading">#</a></h4>
<p>The method <code class="docutils literal notranslate"><span class="pre">set()</span></code> creates dependencies. It is invoked as <code class="docutils literal notranslate"><span class="pre">_data.set('x',</span> <span class="pre">value)</span></code> whenever a variable <code class="docutils literal notranslate"><span class="pre">x</span></code> is set.</p>
<p>First and foremost, it takes the list of variables read <code class="docutils literal notranslate"><span class="pre">last_read</span></code>, and for each of the variables <span class="math notranslate nohighlight">\(v\)</span>, it takes their origin <span class="math notranslate nohighlight">\(o\)</span> (the place where they were last set) and appends the pair (<span class="math notranslate nohighlight">\(v\)</span>, <span class="math notranslate nohighlight">\(o\)</span>) to the list of data dependencies. It then does a similar thing with control dependencies (more on these below), and finally marks (in <code class="docutils literal notranslate"><span class="pre">self.origins</span></code>) the current location of <span class="math notranslate nohighlight">\(v\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DependencyTracker</span><span class="p">(</span><span class="n">DependencyTracker</span><span class="p">):</span>
    <span class="n">TEST</span> <span class="o">=</span> <span class="s1">&#39;&lt;test&gt;&#39;</span>  <span class="c1"># Name of pseudo-variables for testing conditions</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">loads</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a dependency for `name` = `value`&quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">add_dependencies</span><span class="p">(</span><span class="n">dependencies</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">Node</span><span class="p">],</span> 
                             <span class="n">vars_read</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">tp</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Add origins of `vars_read` to `dependencies`.&quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">var_read</span> <span class="ow">in</span> <span class="n">vars_read</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">var_read</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">origins</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">var_read</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEST</span> <span class="ow">and</span> <span class="n">tp</span> <span class="o">==</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span>
                        <span class="c1"># Can&#39;t have data dependencies on conditions</span>
                        <span class="k">continue</span>

                    <span class="n">origin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">origins</span><span class="p">[</span><span class="n">var_read</span><span class="p">]</span>
                    <span class="n">dependencies</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">var_read</span><span class="p">,</span> <span class="n">origin</span><span class="p">))</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
                        <span class="n">origin_func</span><span class="p">,</span> <span class="n">origin_lineno</span> <span class="o">=</span> <span class="n">origin</span>
                        <span class="n">caller_func</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller_location</span><span class="p">()</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">caller_func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s2">: &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;new </span><span class="si">{</span><span class="n">tp</span><span class="si">}</span><span class="s2"> dependency: &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> &lt;= </span><span class="si">{</span><span class="n">var_read</span><span class="si">}</span><span class="s2"> &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">origin_func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">origin_lineno</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_location</span><span class="p">()</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller_location</span><span class="p">()</span>

        <span class="n">add_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dependencies</span><span class="o">.</span><span class="n">setdefault</span>
                         <span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">location</span><span class="p">),</span> <span class="nb">set</span><span class="p">()),</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">last_read</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
        <span class="n">add_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control_dependencies</span><span class="o">.</span><span class="n">setdefault</span>
                         <span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">location</span><span class="p">),</span> <span class="nb">set</span><span class="p">()),</span>
                         <span class="n">cast</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="p">)),</span>
                         <span class="n">tp</span><span class="o">=</span><span class="s2">&quot;control&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">origins</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">location</span>

        <span class="c1"># Reset read info for next line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_read</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="c1"># Next line is a new location</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ignore_location_change</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dependencies</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return dependencies&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Dependencies</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dependencies</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">control_dependencies</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let us illustrate <code class="docutils literal notranslate"><span class="pre">set()</span></code> by example. Here’s a set of variables read and written:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_test_data</span> <span class="o">=</span> <span class="n">DependencyTracker</span><span class="p">()</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">_test_data</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">_test_data</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">_test_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">_test_data</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">_test_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">_test_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>The attribute <code class="docutils literal notranslate"><span class="pre">origins</span></code> saves for each variable where it was last written:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_test_data</span><span class="o">.</span><span class="n">origins</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;x&#39;: (&lt;function __main__.&lt;module&gt;()&gt;, 2),
 &#39;y&#39;: (&lt;function __main__.&lt;module&gt;()&gt;, 3),
 &#39;z&#39;: (&lt;function __main__.&lt;module&gt;()&gt;, 4)}
</pre></div>
</div>
</div>
</div>
<p>The attribute <code class="docutils literal notranslate"><span class="pre">data_dependencies</span></code> tracks for each variable the variables it was read from:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_test_data</span><span class="o">.</span><span class="n">data_dependencies</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{(&#39;x&#39;, (&lt;function __main__.&lt;module&gt;()&gt;, 2)): set(),
 (&#39;y&#39;,
  (&lt;function __main__.&lt;module&gt;()&gt;, 3)): {(&#39;x&#39;,
   (&lt;function __main__.&lt;module&gt;()&gt;, 2))},
 (&#39;z&#39;,
  (&lt;function __main__.&lt;module&gt;()&gt;, 4)): {(&#39;x&#39;,
   (&lt;function __main__.&lt;module&gt;()&gt;, 2)), (&#39;y&#39;,
   (&lt;function __main__.&lt;module&gt;()&gt;, 3))}}
</pre></div>
</div>
</div>
</div>
<p>Hence, the above code already gives us a small dependency graph:</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="_images/cf5755f1b59507d267b429a813aec77450021481ed7a09443242c1282458f8c6.svg" src="_images/cf5755f1b59507d267b429a813aec77450021481ed7a09443242c1282458f8c6.svg" />
</div>
</div>
<p>In the remainder of this section, we define methods to</p>
<ul class="simple">
<li><p>track control dependencies (<code class="docutils literal notranslate"><span class="pre">test()</span></code>, <code class="docutils literal notranslate"><span class="pre">__enter__()</span></code>, <code class="docutils literal notranslate"><span class="pre">__exit__()</span></code>)</p></li>
<li><p>track function calls and returns (<code class="docutils literal notranslate"><span class="pre">call()</span></code>, <code class="docutils literal notranslate"><span class="pre">ret()</span></code>)</p></li>
<li><p>track function arguments (<code class="docutils literal notranslate"><span class="pre">arg()</span></code>, <code class="docutils literal notranslate"><span class="pre">param()</span></code>)</p></li>
<li><p>check the validity of our dependencies (<code class="docutils literal notranslate"><span class="pre">validate()</span></code>).</p></li>
</ul>
<p>Like our <code class="docutils literal notranslate"><span class="pre">get()</span></code> and <code class="docutils literal notranslate"><span class="pre">set()</span></code> methods above, these work by refining the appropriate methods defined in the <code class="docutils literal notranslate"><span class="pre">DataTracker</span></code> class, building on our <code class="docutils literal notranslate"><span class="pre">NodeTransformer</span></code> transformations.</p>
</section>
</section>
<section id="excursion-control-dependencies">
<h3>Excursion: Control Dependencies<a class="headerlink" href="#excursion-control-dependencies" title="Link to this heading">#</a></h3>
<p>Let us detail control dependencies. As discussed with <code class="docutils literal notranslate"><span class="pre">DataTracker()</span></code>, we invoke <code class="docutils literal notranslate"><span class="pre">test()</span></code> methods for all control conditions, and place the controlled blocks into <code class="docutils literal notranslate"><span class="pre">with</span></code> clauses.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">test()</span></code> method simply sets a <code class="docutils literal notranslate"><span class="pre">&lt;test&gt;</span></code> variable; this also places it in <code class="docutils literal notranslate"><span class="pre">last_read</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DependencyTracker</span><span class="p">(</span><span class="n">DependencyTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Track a test for condition `value`&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEST</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>When entering a <code class="docutils literal notranslate"><span class="pre">with</span></code> block, the set of <code class="docutils literal notranslate"><span class="pre">last_read</span></code> variables holds the <code class="docutils literal notranslate"><span class="pre">&lt;test&gt;</span></code> variable read. We save it in the <code class="docutils literal notranslate"><span class="pre">control</span></code> stack, with the effect of any further variables written now being marked as controlled by <code class="docutils literal notranslate"><span class="pre">&lt;test&gt;</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DependencyTracker</span><span class="p">(</span><span class="n">DependencyTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Track entering an if/while/for block&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_read</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_read</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>When we exit the <code class="docutils literal notranslate"><span class="pre">with</span></code> block, we restore earlier <code class="docutils literal notranslate"><span class="pre">last_read</span></code> values, preparing for <code class="docutils literal notranslate"><span class="pre">else</span></code> blocks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DependencyTracker</span><span class="p">(</span><span class="n">DependencyTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">:</span> <span class="ne">BaseException</span><span class="p">,</span>
                 <span class="n">traceback</span><span class="p">:</span> <span class="n">TracebackType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Track exiting an if/while/for block&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_next_location_change</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s an example of all these parts in action:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_test_data</span> <span class="o">=</span> <span class="n">DependencyTracker</span><span class="p">()</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">_test_data</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">_test_data</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">_test_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">_test_data</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">_test_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">_test_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">y</span><span class="p">)):</span>
    <span class="k">with</span> <span class="n">_test_data</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">_test_data</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span>
                           <span class="n">_test_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">_test_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_test_data</span><span class="o">.</span><span class="n">control_dependencies</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{(&#39;x&#39;, (&lt;function __main__.&lt;module&gt;()&gt;, 2)): set(),
 (&#39;y&#39;, (&lt;function __main__.&lt;module&gt;()&gt;, 3)): set(),
 (&#39;&lt;test&gt;&#39;, (&lt;function __main__.&lt;module&gt;()&gt;, 1)): set(),
 (&#39;z&#39;,
  (&lt;function __main__.&lt;module&gt;()&gt;, 3)): {(&#39;&lt;test&gt;&#39;,
   (&lt;function __main__.&lt;module&gt;()&gt;, 1))}}
</pre></div>
</div>
</div>
</div>
<p>The control dependency for <code class="docutils literal notranslate"><span class="pre">z</span></code> is reflected in the dependency graph:</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="_images/08b7fc97aec8e65c94020d3ec1c972537ecdabd5606b17198fa2229f8cb5837e.svg" src="_images/08b7fc97aec8e65c94020d3ec1c972537ecdabd5606b17198fa2229f8cb5837e.svg" />
</div>
</div>
</section>
<section id="id10">
<h3>End of Excursion<a class="headerlink" href="#id10" title="Link to this heading">#</a></h3>
</section>
<section id="excursion-calls-and-returns">
<h3>Excursion: Calls and Returns<a class="headerlink" href="#excursion-calls-and-returns" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
</pre></div>
</div>
</div>
</div>
<p>To handle complex expressions involving functions, we introduce a <em>data stack</em>. Every time we invoke a function <code class="docutils literal notranslate"><span class="pre">func</span></code> (<code class="docutils literal notranslate"><span class="pre">call()</span></code> is invoked), we save the list of current variables read <code class="docutils literal notranslate"><span class="pre">last_read</span></code> on the <code class="docutils literal notranslate"><span class="pre">data</span></code> stack; when we return (<code class="docutils literal notranslate"><span class="pre">ret()</span></code> is invoked), we restore <code class="docutils literal notranslate"><span class="pre">last_read</span></code>. This also ensures that only those variables read while evaluating arguments will flow into the function call.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DependencyTracker</span><span class="p">(</span><span class="n">DependencyTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Track a call of function `func`&quot;&quot;&quot;</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isgeneratorfunction</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_generator</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

        <span class="c1"># Save context</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="n">caller_func</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller_location</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">caller_func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s2">: &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;saving read variables </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_read</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_read</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_next_location_change</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">return</span> <span class="n">func</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DependencyTracker</span><span class="p">(</span><span class="n">DependencyTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ret</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Track a function return&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">ret</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_generator</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ret_generator</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># Restore old context and add return value</span>
        <span class="n">ret_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_read</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">):</span>  <span class="c1"># &quot;&lt;return value&gt;&quot;</span>
                <span class="n">ret_name</span> <span class="o">=</span> <span class="n">var</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ret_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_read</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ret_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="c1"># We return from an uninstrumented function:</span>
            <span class="c1"># Make return value depend on all args</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">deps</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_read</span> <span class="o">+=</span> <span class="n">deps</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_location_change</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="n">caller_func</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller_location</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">caller_func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s2">: &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;restored read variables </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_read</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">value</span>
</pre></div>
</div>
</div>
</div>
<p>Generator functions (those which <code class="docutils literal notranslate"><span class="pre">yield</span></code> a value) are not “called” in the sense that Python transfers control to them; instead, a “call” to a generator function creates a generator that is evaluated on demand. We mark generator function “calls” by saving <code class="docutils literal notranslate"><span class="pre">None</span></code> on the stacks. When the generator function returns the generator, we wrap the generator such that the arguments are being restored when it is invoked.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DependencyTracker</span><span class="p">(</span><span class="n">DependencyTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">in_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;True if we are calling a generator function&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">call_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Track a call of a generator function&quot;&quot;&quot;</span>
        <span class="c1"># Mark the fact that we&#39;re in a generator with `None` values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_generator</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clear_read</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">func</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ret_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Track the return of a generator function&quot;&quot;&quot;</span>
        <span class="c1"># Pop the two &#39;None&#39; values pushed earlier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="n">caller_func</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller_location</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">caller_func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s2">: &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;wrapping generator </span><span class="si">{</span><span class="n">generator</span><span class="si">}</span><span class="s2"> (args=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="c1"># At this point, we already have collected the args.</span>
        <span class="c1"># The returned generator depends on all of them.</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_read</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span>

        <span class="c1"># Wrap the generator such that the args are restored </span>
        <span class="c1"># when it is actually invoked, such that we can map them</span>
        <span class="c1"># to parameters.</span>
        <span class="n">saved_args</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">saved_args</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
                <span class="n">caller_func</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller_location</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">caller_func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s2">: &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;calling generator (args=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ignore_next_location_change</span><span class="p">()</span>
            <span class="k">yield from</span> <span class="n">generator</span>

        <span class="k">return</span> <span class="n">wrapper</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We see an example of how function calls and returns work in conjunction with function arguments, discussed in the next section.</p>
</section>
<section id="id11">
<h3>End of Excursion<a class="headerlink" href="#id11" title="Link to this heading">#</a></h3>
</section>
<section id="excursion-function-arguments">
<h3>Excursion: Function Arguments<a class="headerlink" href="#excursion-function-arguments" title="Link to this heading">#</a></h3>
<p>Finally, we handle parameters and arguments. The <code class="docutils literal notranslate"><span class="pre">args</span></code> stack holds the current stack of function arguments, holding the <code class="docutils literal notranslate"><span class="pre">last_read</span></code> variable for each argument.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DependencyTracker</span><span class="p">(</span><span class="n">DependencyTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">arg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">pos</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">kw</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Track passing an argument `value`</span>
<span class="sd">        (with given position `pos` 1..n or keyword `kw`)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="n">caller_func</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller_location</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">caller_func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s2">: &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;saving args read </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_read</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pos</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_read</span>
        <span class="k">if</span> <span class="n">kw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">kw</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_read</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clear_read</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>When accessing the arguments (with <code class="docutils literal notranslate"><span class="pre">param()</span></code>), we can retrieve this set of read variables for each argument.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DependencyTracker</span><span class="p">(</span><span class="n">DependencyTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
              <span class="n">pos</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">vararg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">last</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Track getting a parameter `name` with value `value`</span>
<span class="sd">        (with given position `pos`).</span>
<span class="sd">        vararg parameters are indicated by setting `varargs` to </span>
<span class="sd">        &#39;*&#39; (*args) or &#39;**&#39; (**kwargs)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_read</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">vararg</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
            <span class="c1"># We over-approximate by setting `args` to _all_ positional args</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">pos</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">last_read</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">vararg</span> <span class="o">==</span> <span class="s1">&#39;**&#39;</span><span class="p">:</span>
            <span class="c1"># We over-approximate by setting `kwargs` to _all_ passed keyword args</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">last_read</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="n">caller_func</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller_location</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">caller_func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s2">: &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;restored params read </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_read</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_location_change</span><span class="p">()</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">last</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_read</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Mark `args` as processed</span>

        <span class="k">return</span> <span class="n">ret</span>
</pre></div>
</div>
</div>
</div>
<p>Let us illustrate all these on a small example.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">call_test</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">47</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sq</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">n</span> <span class="o">*</span> <span class="n">n</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">gen</span><span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="k">yield</span> <span class="n">e</span> <span class="o">*</span> <span class="n">c</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">just_x</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="n">a</span> <span class="o">=</span> <span class="mi">42</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">gen</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">b</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">xs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="p">[</span><span class="n">sq</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">xs</span> <span class="k">if</span> <span class="n">elem</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">just_x</span><span class="p">(</span><span class="n">just_x</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">b</span><span class="p">),</span> <span class="n">ys</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">call_test</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1974
</pre></div>
</div>
</div>
</div>
<p>We apply all our transformers on this code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">call_tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">call_test</span><span class="p">))</span>
<span class="n">TrackCallTransformer</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">call_tree</span><span class="p">)</span>
<span class="n">TrackSetTransformer</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">call_tree</span><span class="p">)</span>
<span class="n">TrackGetTransformer</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">call_tree</span><span class="p">)</span>
<span class="n">TrackControlTransformer</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">call_tree</span><span class="p">)</span>
<span class="n">TrackReturnTransformer</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">call_tree</span><span class="p">)</span>
<span class="n">TrackParamsTransformer</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">call_tree</span><span class="p">)</span>
<span class="n">dump_tree</span><span class="p">(</span><span class="n">call_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">call_test</span>() -&gt; <span class=" -Color -Color-Cyan">int</span>:
    c = _data.set(<span class=" -Color -Color-Yellow">&#39;c&#39;</span>, <span class=" -Color -Color-Blue">47</span>)

    <span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">sq</span>(n: <span class=" -Color -Color-Cyan">int</span>) -&gt; <span class=" -Color -Color-Cyan">int</span>:
        _data.param(<span class=" -Color -Color-Yellow">&#39;n&#39;</span>, n, pos=<span class=" -Color -Color-Blue">1</span>, last=<span class=" -Color -Color-Blue">True</span>)
        <span class=" -Color -Color-Blue">return</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;sq() return value&gt;&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;n&#39;</span>, n) * _data.get(<span class=" -Color -Color-Yellow">&#39;n&#39;</span>, n))

    <span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">gen</span>(e: <span class=" -Color -Color-Cyan">int</span>) -&gt; Generator[<span class=" -Color -Color-Cyan">int</span>, <span class=" -Color -Color-Blue">None</span>, <span class=" -Color -Color-Blue">None</span>]:
        _data.param(<span class=" -Color -Color-Yellow">&#39;e&#39;</span>, e, pos=<span class=" -Color -Color-Blue">1</span>, last=<span class=" -Color -Color-Blue">True</span>)
        <span class=" -Color -Color-Blue">yield</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;gen() yield value&gt;&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;e&#39;</span>, e) * _data.get(<span class=" -Color -Color-Yellow">&#39;c&#39;</span>, c))

    <span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">just_x</span>(x: Any, y: Any) -&gt; Any:
        _data.param(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x, pos=<span class=" -Color -Color-Blue">1</span>)
        _data.param(<span class=" -Color -Color-Yellow">&#39;y&#39;</span>, y, pos=<span class=" -Color -Color-Blue">2</span>, last=<span class=" -Color -Color-Blue">True</span>)
        <span class=" -Color -Color-Blue">return</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;just_x() return value&gt;&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x))
    a = _data.set(<span class=" -Color -Color-Yellow">&#39;a&#39;</span>, <span class=" -Color -Color-Blue">42</span>)
    b = _data.set(<span class=" -Color -Color-Yellow">&#39;b&#39;</span>, _data.ret(_data.call(_data.get(<span class=" -Color -Color-Yellow">&#39;gen&#39;</span>, gen))(_data.arg(_data.get(<span class=" -Color -Color-Yellow">&#39;a&#39;</span>, a), pos=<span class=" -Color -Color-Blue">1</span>))))
    d = _data.set(<span class=" -Color -Color-Yellow">&#39;d&#39;</span>, _data.ret(_data.call(<span class=" -Color -Color-Cyan">list</span>)(_data.arg(_data.get(<span class=" -Color -Color-Yellow">&#39;b&#39;</span>, b), pos=<span class=" -Color -Color-Blue">1</span>)))[<span class=" -Color -Color-Blue">0</span>])
    xs = _data.set(<span class=" -Color -Color-Yellow">&#39;xs&#39;</span>, [<span class=" -Color -Color-Blue">1</span>, <span class=" -Color -Color-Blue">2</span>, <span class=" -Color -Color-Blue">3</span>, <span class=" -Color -Color-Blue">4</span>])
    ys = _data.set(<span class=" -Color -Color-Yellow">&#39;ys&#39;</span>, [_data.ret(_data.call(_data.get(<span class=" -Color -Color-Yellow">&#39;sq&#39;</span>, sq))(_data.arg(_data.get(<span class=" -Color -Color-Yellow">&#39;elem&#39;</span>, elem), pos=<span class=" -Color -Color-Blue">1</span>))) <span class=" -Color -Color-Blue">for</span> elem <span class=" -Color -Color-Magenta">in</span> _data.set(<span class=" -Color -Color-Yellow">&#39;elem&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;xs&#39;</span>, xs)) <span class=" -Color -Color-Blue">if</span> _data.get(<span class=" -Color -Color-Yellow">&#39;elem&#39;</span>, elem) &gt; <span class=" -Color -Color-Blue">2</span>])
    <span class=" -Color -Color-Blue">return</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;call_test() return value&gt;&#39;</span>, _data.ret(_data.call(_data.get(<span class=" -Color -Color-Yellow">&#39;just_x&#39;</span>, just_x))(_data.arg(_data.ret(_data.call(_data.get(<span class=" -Color -Color-Yellow">&#39;just_x&#39;</span>, just_x))(_data.arg(_data.get(<span class=" -Color -Color-Yellow">&#39;d&#39;</span>, d), pos=<span class=" -Color -Color-Blue">1</span>), y=_data.arg(_data.get(<span class=" -Color -Color-Yellow">&#39;b&#39;</span>, b), kw=<span class=" -Color -Color-Yellow">&#39;y&#39;</span>))), pos=<span class=" -Color -Color-Blue">1</span>), _data.arg(_data.get(<span class=" -Color -Color-Yellow">&#39;ys&#39;</span>, ys)[<span class=" -Color -Color-Blue">0</span>], pos=<span class=" -Color -Color-Blue">2</span>))))
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/2498757139.py:9: DeprecationWarning: ast.Num is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords.append(keyword(arg=&#39;pos&#39;, value=ast.Num(pos)))
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/2498757139.py:11: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords.append(keyword(arg=&#39;kw&#39;, value=ast.Str(kw)))
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/2454789564.py:22: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(id), value],
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/3554319793.py:4: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(id), Name(id=id, ctx=Load())],
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:12: DeprecationWarning: ast.Num is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords=[keyword(arg=&#39;pos&#39;, value=ast.Num(n + 1))]
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:19: DeprecationWarning: ast.NameConstant is deprecated and will be removed in Python 3.14; use ast.Constant instead
  value=ast.NameConstant(value=True)))
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:25: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(child.arg),
</pre></div>
</div>
</div>
</div>
<p>Again, we capture the dependencies:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DependencyTrackerTester</span><span class="p">(</span><span class="n">DataTrackerTester</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_data_tracker</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DependencyTracker</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DependencyTracker</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">DependencyTrackerTester</span><span class="p">(</span><span class="n">call_tree</span><span class="p">,</span> <span class="n">call_test</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">call_deps</span><span class="p">:</span>
    <span class="n">call_test</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We see how</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">a</span></code> flows into the generator <code class="docutils literal notranslate"><span class="pre">b</span></code> and into the parameter <code class="docutils literal notranslate"><span class="pre">e</span></code> of <code class="docutils literal notranslate"><span class="pre">gen()</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">xs</span></code> flows into <code class="docutils literal notranslate"><span class="pre">elem</span></code> which in turn flows into the parameter <code class="docutils literal notranslate"><span class="pre">n</span></code> of <code class="docutils literal notranslate"><span class="pre">sq()</span></code>. Both flow into <code class="docutils literal notranslate"><span class="pre">ys</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">just_x()</span></code> returns only its <code class="docutils literal notranslate"><span class="pre">x</span></code> argument.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">call_deps</span><span class="o">.</span><span class="n">dependencies</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7a5d7c83714f7c22bb8a9c4526c3645b46c63a1754f41a2f5905a174fd26f37d.svg" src="_images/7a5d7c83714f7c22bb8a9c4526c3645b46c63a1754f41a2f5905a174fd26f37d.svg" />
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">code()</span></code> view lists each function separately:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">call_deps</span><span class="o">.</span><span class="n">dependencies</span><span class="p">()</span><span class="o">.</span><span class="n">code</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>    10     <span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">just_x</span>(x: Any, y: Any) -&gt; Any:
*   11         <span class=" -Color -Color-Blue">return</span> x  <span class=" -Color -Color-White"># &lt;= &lt;just_x() return value&gt; (11), d (call_test:15), ys (call_test:18), b (call_test:14), x (11)</span>

     4     <span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">sq</span>(n: <span class=" -Color -Color-Cyan">int</span>) -&gt; <span class=" -Color -Color-Cyan">int</span>:
*    5         <span class=" -Color -Color-Blue">return</span> n * n  <span class=" -Color -Color-White"># &lt;= elem (call_test:18), n (5)</span>

     7     <span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">gen</span>(e: <span class=" -Color -Color-Cyan">int</span>) -&gt; Generator[<span class=" -Color -Color-Cyan">int</span>, <span class=" -Color -Color-Blue">None</span>, <span class=" -Color -Color-Blue">None</span>]:
*    8         <span class=" -Color -Color-Blue">yield</span> e * c  <span class=" -Color -Color-White"># &lt;= a (call_test:13), c (call_test:2), e (8)</span>

     1 <span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">call_test</span>() -&gt; <span class=" -Color -Color-Cyan">int</span>:
*    2     c = <span class=" -Color -Color-Blue">47</span>
     3 
     4     <span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">sq</span>(n: <span class=" -Color -Color-Cyan">int</span>) -&gt; <span class=" -Color -Color-Cyan">int</span>:
     5         <span class=" -Color -Color-Blue">return</span> n * n
     6 
     7     <span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">gen</span>(e: <span class=" -Color -Color-Cyan">int</span>) -&gt; Generator[<span class=" -Color -Color-Cyan">int</span>, <span class=" -Color -Color-Blue">None</span>, <span class=" -Color -Color-Blue">None</span>]:
     8         <span class=" -Color -Color-Blue">yield</span> e * c
     9 
    10     <span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">just_x</span>(x: Any, y: Any) -&gt; Any:
    11         <span class=" -Color -Color-Blue">return</span> x
    12 
*   13     a = <span class=" -Color -Color-Blue">42</span>
*   14 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>    b = gen(a)  <span class=" -Color -Color-White"># &lt;= a (13)</span>
*   15     d = <span class=" -Color -Color-Cyan">list</span>(b)[<span class=" -Color -Color-Blue">0</span>]  <span class=" -Color -Color-White"># &lt;= &lt;gen() yield value&gt; (gen:8), b (14)</span>
    16 
*   17     xs = [<span class=" -Color -Color-Blue">1</span>, <span class=" -Color -Color-Blue">2</span>, <span class=" -Color -Color-Blue">3</span>, <span class=" -Color -Color-Blue">4</span>]
*   18     ys = [sq(elem) <span class=" -Color -Color-Blue">for</span> elem <span class=" -Color -Color-Magenta">in</span> xs <span class=" -Color -Color-Blue">if</span> elem &gt; <span class=" -Color -Color-Blue">2</span>]  <span class=" -Color -Color-White"># &lt;= xs (17), elem (18), &lt;sq() return value&gt; (sq:5)</span>
    19 
*   20     <span class=" -Color -Color-Blue">return</span> just_x(just_x(d, y=b), ys[<span class=" -Color -Color-Blue">0</span>])  <span class=" -Color -Color-White"># &lt;= &lt;just_x() return value&gt; (just_x:11)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id12">
<h3>End of Excursion<a class="headerlink" href="#id12" title="Link to this heading">#</a></h3>
</section>
<section id="excursion-diagnostics">
<h3>Excursion: Diagnostics<a class="headerlink" href="#excursion-diagnostics" title="Link to this heading">#</a></h3>
<p>To check the dependencies we obtain, we perform some minimal checks on whether a referenced variable actually also occurs in the source code.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Dependencies</span><span class="p">(</span><span class="n">Dependencies</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform a simple syntactic validation of dependencies&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_vars</span><span class="p">():</span>
            <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">source</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">):</span>
                <span class="k">continue</span>   <span class="c1"># no source</span>

            <span class="k">for</span> <span class="n">dep_var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="p">[</span><span class="n">var</span><span class="p">]:</span>
                <span class="n">dep_name</span><span class="p">,</span> <span class="n">dep_location</span> <span class="o">=</span> <span class="n">dep_var</span>

                <span class="k">if</span> <span class="n">dep_name</span> <span class="o">==</span> <span class="n">DependencyTracker</span><span class="o">.</span><span class="n">TEST</span><span class="p">:</span>
                    <span class="k">continue</span>  <span class="c1"># dependency on &lt;test&gt;</span>

                <span class="k">if</span> <span class="n">dep_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39; value&gt;&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">format_var</span><span class="p">(</span><span class="n">var</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
                                  <span class="sa">f</span><span class="s2">&quot;depends on </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">format_var</span><span class="p">(</span><span class="n">dep_var</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
                                  <span class="sa">f</span><span class="s2">&quot;but </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="si">}</span><span class="s2"> does not &quot;</span>
                                  <span class="sa">f</span><span class="s2">&quot;seem to have a call&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;def&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>   <span class="c1"># function call</span>

                <span class="n">rx</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b&#39;</span> <span class="o">+</span> <span class="n">dep_name</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\b&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rx</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">format_var</span><span class="p">(</span><span class="n">var</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;depends on </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">format_var</span><span class="p">(</span><span class="n">dep_var</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;but </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">dep_name</span><span class="p">)</span><span class="si">}</span><span class="s2"> does not occur &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;in </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">validate()</span></code> is automatically called whenever dependencies are output, so if you see any of its error messages, something may be wrong.</p>
</section>
<section id="id13">
<h3>End of Excursion<a class="headerlink" href="#id13" title="Link to this heading">#</a></h3>
<p>At this point, <code class="docutils literal notranslate"><span class="pre">DependencyTracker</span></code> is complete; we have all in place to track even complex dependencies in instrumented code.</p>
</section>
</section>
<section id="slicing-code">
<h2>Slicing Code<a class="headerlink" href="#slicing-code" title="Link to this heading">#</a></h2>
<p>Let us now put all these pieces together. We have a means to instrument the source code (our various <code class="docutils literal notranslate"><span class="pre">NodeTransformer</span></code> classes) and a means to track dependencies (the <code class="docutils literal notranslate"><span class="pre">DependencyTracker</span></code> class). Now comes the time to put all these things together in a single tool, which we call <code class="docutils literal notranslate"><span class="pre">Slicer</span></code>.</p>
<p>The basic idea of <code class="docutils literal notranslate"><span class="pre">Slicer</span></code> is that you can use it as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Slicer</span><span class="p">(</span><span class="n">func_1</span><span class="p">,</span> <span class="n">func_2</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span> <span class="k">as</span> <span class="n">slicer</span><span class="p">:</span>
    <span class="n">func</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>which first <em>instruments</em> the functions given in the constructor (i.e., replaces their definitions with instrumented counterparts), and then runs the code in the body, calling instrumented functions, and allowing the slicer to collect dependencies. When the body returns, the original definition of the instrumented functions is restored.</p>
<section id="an-instrumenter-base-class">
<h3>An Instrumenter Base Class<a class="headerlink" href="#an-instrumenter-base-class" title="Link to this heading">#</a></h3>
<p>The basic functionality of instrumenting a number of functions (and restoring them at the end of the <code class="docutils literal notranslate"><span class="pre">with</span></code> block) comes in a <code class="docutils literal notranslate"><span class="pre">Instrumenter</span></code> base class. It invokes <code class="docutils literal notranslate"><span class="pre">instrument()</span></code> on all items to instrument; this is to be overloaded in subclasses.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Instrumenter</span><span class="p">(</span><span class="n">StackInspector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Instrument functions for dynamic tracking&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">items_to_instrument</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
                 <span class="nb">globals</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">log</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an instrumenter.</span>
<span class="sd">        `items_to_instrument` is a list of items to instrument.</span>
<span class="sd">        `globals` is a namespace to use (default: caller&#39;s globals())</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items_to_instrument</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">items_to_instrument</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instrumented_items</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">globals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">globals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller_globals</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">globals</span> <span class="o">=</span> <span class="nb">globals</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instrument sources&quot;&quot;&quot;</span>
        <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items_to_instrument</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_items_to_instrument</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">default_items_to_instrument</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">instrument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instrument `item`. To be overloaded in subclasses.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Instrumenting&quot;</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instrumented_items</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">item</span>
</pre></div>
</div>
</div>
</div>
<p>At the end of the <code class="docutils literal notranslate"><span class="pre">with</span></code> block, we restore the given functions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Instrumenter</span><span class="p">(</span><span class="n">Instrumenter</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">:</span> <span class="ne">BaseException</span><span class="p">,</span>
                 <span class="n">traceback</span><span class="p">:</span> <span class="n">TracebackType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Restore sources&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrumented_items</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
</pre></div>
</div>
</div>
</div>
<p>By default, an <code class="docutils literal notranslate"><span class="pre">Instrumenter</span></code> simply outputs a log message:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Instrumenter</span><span class="p">(</span><span class="n">middle</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">ins</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Instrumenting &lt;function middle at 0x10d554b80&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="the-slicer-class">
<h3>The Slicer Class<a class="headerlink" href="#the-slicer-class" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">Slicer</span></code> class comes as a subclass of <code class="docutils literal notranslate"><span class="pre">Instrumenter</span></code>. It sets its own dependency tracker (which can be overwritten by setting the <code class="docutils literal notranslate"><span class="pre">dependency_tracker</span></code> keyword argument).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Slicer</span><span class="p">(</span><span class="n">Instrumenter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Track dependencies in an execution&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">items_to_instrument</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
                 <span class="n">dependency_tracker</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DependencyTracker</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="nb">globals</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">log</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a slicer.</span>
<span class="sd">        `items_to_instrument` are Python functions or modules with source code.</span>
<span class="sd">        `dependency_tracker` is the tracker to be used (default: DependencyTracker).</span>
<span class="sd">        `globals` is the namespace to be used(default: caller&#39;s `globals()`)</span>
<span class="sd">        `log`=True or `log` &gt; 0 turns on logging</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">items_to_instrument</span><span class="p">,</span> <span class="nb">globals</span><span class="o">=</span><span class="nb">globals</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dependency_tracker</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dependency_tracker</span> <span class="o">=</span> <span class="n">DependencyTracker</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="p">(</span><span class="n">log</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependency_tracker</span> <span class="o">=</span> <span class="n">dependency_tracker</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">saved_dependencies</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">default_items_to_instrument</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Need one or more items to instrument&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">parse()</span></code> method parses a given item, returning its AST.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Slicer</span><span class="p">(</span><span class="n">Slicer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AST</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse `item`, returning its AST&quot;&quot;&quot;</span>
        <span class="n">source_lines</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcelines</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source_lines</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">print_content</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="n">start_line_number</span><span class="o">=</span><span class="n">lineno</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">()</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="n">ast</span><span class="o">.</span><span class="n">increment_lineno</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tree</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">transform()</span></code> method applies the list of transformers defined earlier in this chapter.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Slicer</span><span class="p">(</span><span class="n">Slicer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">transformers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">NodeTransformer</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List of transformers to apply. To be extended in subclasses.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">TrackCallTransformer</span><span class="p">(),</span>
            <span class="n">TrackSetTransformer</span><span class="p">(),</span>
            <span class="n">TrackGetTransformer</span><span class="p">(),</span>
            <span class="n">TrackControlTransformer</span><span class="p">(),</span>
            <span class="n">TrackReturnTransformer</span><span class="p">(),</span>
            <span class="n">TrackParamsTransformer</span><span class="p">()</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AST</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply transformers on `tree`. May be extended in subclasses.&quot;&quot;&quot;</span>
        <span class="c1"># Apply transformers</span>
        <span class="k">for</span> <span class="n">transformer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">transformer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>

            <span class="n">transformer</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
            <span class="n">ast</span><span class="o">.</span><span class="n">fix_missing_locations</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">tree</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">()</span>

        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">print_content</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">tree</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">tree</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">execute()</span></code> method executes the transformed tree (such that we get the new definitions). We also make the dependency tracker available for the code in the <code class="docutils literal notranslate"><span class="pre">with</span></code> block.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Slicer</span><span class="p">(</span><span class="n">Slicer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">AST</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compile and execute `tree`. May be extended in subclasses.&quot;&quot;&quot;</span>

        <span class="c1"># We pass the source file of `item` such that we can retrieve it</span>
        <span class="c1"># when accessing the location of the new compiled code</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcefile</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
        <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">tree</span><span class="p">),</span> <span class="n">source</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>

        <span class="c1"># Enable dependency tracker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">DATA_TRACKER</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependency_tracker</span>

        <span class="c1"># Execute the code, resulting in a redefinition of item</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">instrument()</span></code> method puts all these together, first parsing the item into a tree, then transforming and executing the tree.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Slicer</span><span class="p">(</span><span class="n">Slicer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">instrument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instrument `item`, transforming its source code, and re-defining it.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_internal</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="vm">__name__</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">item</span>  <span class="c1"># Do not instrument `print()` and the like</span>

        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isbuiltin</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">item</span>  <span class="c1"># No source code</span>

        <span class="n">item</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">instrument</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

        <span class="n">new_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">new_item</span>
</pre></div>
</div>
</div>
</div>
<p>When we restore the original definition (after the <code class="docutils literal notranslate"><span class="pre">with</span></code> block), we save the dependency tracker again.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Slicer</span><span class="p">(</span><span class="n">Slicer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Restore original code.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">DATA_TRACKER</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saved_dependencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">DATA_TRACKER</span><span class="p">]</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">DATA_TRACKER</span><span class="p">]</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Three convenience functions allow us to see the dependencies as (well) dependencies, as code, and as graph. These simply invoke the respective functions on the saved dependencies.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Slicer</span><span class="p">(</span><span class="n">Slicer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dependencies</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return collected dependencies.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_dependencies</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Dependencies</span><span class="p">({},</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_dependencies</span><span class="o">.</span><span class="n">dependencies</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show code of instrumented items, annotated with dependencies.&quot;&quot;&quot;</span>
        <span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrumented_items</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">first</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">()</span><span class="o">.</span><span class="n">code</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Digraph</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Show dependency graph.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">()</span><span class="o">.</span><span class="n">graph</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_repr_mimebundle_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;If the object is output in Jupyter, render dependencies as a SVG graph&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">()</span><span class="o">.</span><span class="n">_repr_mimebundle_</span><span class="p">(</span><span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let us put <code class="docutils literal notranslate"><span class="pre">Slicer</span></code> into action. We track our <code class="docutils literal notranslate"><span class="pre">middle()</span></code> function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Slicer</span><span class="p">(</span><span class="n">middle</span><span class="p">)</span> <span class="k">as</span> <span class="n">slicer</span><span class="p">:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">middle</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">m</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/3554319793.py:4: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(id), Name(id=id, ctx=Load())],
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/2454789564.py:22: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(id), value],
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:12: DeprecationWarning: ast.Num is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords=[keyword(arg=&#39;pos&#39;, value=ast.Num(n + 1))]
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:25: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(child.arg),
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:19: DeprecationWarning: ast.NameConstant is deprecated and will be removed in Python 3.14; use ast.Constant instead
  value=ast.NameConstant(value=True)))
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
</div>
</div>
<p>These are the dependencies in string form (used when printed):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">slicer</span><span class="o">.</span><span class="n">dependencies</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>middle():
    &lt;test&gt; (2) &lt;= z (12), y (12)
    &lt;test&gt; (3) &lt;= y (12), x (12); &lt;- &lt;test&gt; (2)
    &lt;test&gt; (5) &lt;= z (12), x (12); &lt;- &lt;test&gt; (3)
    &lt;middle() return value&gt; (6) &lt;= y (12); &lt;- &lt;test&gt; (5)
</pre></div>
</div>
</div>
</div>
<p>This is the code form:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">slicer</span><span class="o">.</span><span class="n">code</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     1 <span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">middle</span>(x, y, z):  <span class=" -Color -Color-White"># type: ignore</span>
*    2     <span class=" -Color -Color-Blue">if</span> y &lt; z:  <span class=" -Color -Color-White"># &lt;= z (12), y (12)</span>
*    3         <span class=" -Color -Color-Blue">if</span> x &lt; y:  <span class=" -Color -Color-White"># &lt;= y (12), x (12); &lt;- &lt;test&gt; (2)</span>
     4             <span class=" -Color -Color-Blue">return</span> y
*    5         <span class=" -Color -Color-Blue">elif</span> x &lt; z:  <span class=" -Color -Color-White"># &lt;= z (12), x (12); &lt;- &lt;test&gt; (3)</span>
*    6             <span class=" -Color -Color-Blue">return</span> y  <span class=" -Color -Color-White"># &lt;= y (12); &lt;- &lt;test&gt; (5)</span>
     7     <span class=" -Color -Color-Blue">else</span>:
     8         <span class=" -Color -Color-Blue">if</span> x &gt; y:
     9 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>            <span class=" -Color -Color-Blue">return</span> y
    10         <span class=" -Color -Color-Blue">elif</span> x &gt; z:
    11             <span class=" -Color -Color-Blue">return</span> x
*   12     <span class=" -Color -Color-Blue">return</span> z
</pre></div>
</div>
</div>
</div>
<p>And this is the graph form:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">slicer</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b4a3ea1db320318e75c890ee5ff71fa6523b265cfc30da3d8dfa1e6c12149c5a.svg" src="_images/b4a3ea1db320318e75c890ee5ff71fa6523b265cfc30da3d8dfa1e6c12149c5a.svg" />
</div>
</div>
<p>You can also access the raw <code class="docutils literal notranslate"><span class="pre">repr()</span></code> form, which allows you to reconstruct dependencies at any time. (This is how we showed off dependencies at the beginning of this chapter, before even introducing the code that computes them.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">slicer</span><span class="o">.</span><span class="n">dependencies</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dependencies(
    data={
        (&#39;x&#39;, (middle, 12)): set(),
        (&#39;y&#39;, (middle, 12)): set(),
        (&#39;z&#39;, (middle, 12)): set(),
        (&#39;&lt;test&gt;&#39;, (middle, 2)): {(&#39;z&#39;, (middle, 12)), (&#39;y&#39;, (middle, 12))},
        (&#39;&lt;test&gt;&#39;, (middle, 3)): {(&#39;y&#39;, (middle, 12)), (&#39;x&#39;, (middle, 12))},
        (&#39;&lt;test&gt;&#39;, (middle, 5)): {(&#39;z&#39;, (middle, 12)), (&#39;x&#39;, (middle, 12))},
        (&#39;&lt;middle() return value&gt;&#39;, (middle, 6)): {(&#39;y&#39;, (middle, 12))}},
 control={
        (&#39;x&#39;, (middle, 12)): set(),
        (&#39;y&#39;, (middle, 12)): set(),
        (&#39;z&#39;, (middle, 12)): set(),
        (&#39;&lt;test&gt;&#39;, (middle, 2)): set(),
        (&#39;&lt;test&gt;&#39;, (middle, 3)): {(&#39;&lt;test&gt;&#39;, (middle, 2))},
        (&#39;&lt;test&gt;&#39;, (middle, 5)): {(&#39;&lt;test&gt;&#39;, (middle, 3))},
        (&#39;&lt;middle() return value&gt;&#39;, (middle, 6)): {(&#39;&lt;test&gt;&#39;, (middle, 5))}})
</pre></div>
</div>
</div>
</div>
</section>
<section id="diagnostics">
<h3>Diagnostics<a class="headerlink" href="#diagnostics" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">Slicer</span></code> constructor accepts a <code class="docutils literal notranslate"><span class="pre">log</span></code> argument (default: False), which can be set to show various intermediate results:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">log=True</span></code> (or <code class="docutils literal notranslate"><span class="pre">log=1</span></code>): Show instrumented source code</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">log=2</span></code>: Also log execution</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">log=3</span></code>: Also log individual transformer steps</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">log=4</span></code>: Also log source line numbers</p></li>
</ul>
</section>
</section>
<section id="more-examples">
<h2>More Examples<a class="headerlink" href="#more-examples" title="Link to this heading">#</a></h2>
<p>Let us demonstrate our <code class="docutils literal notranslate"><span class="pre">Slicer</span></code> class on a few more examples.</p>
<section id="square-root">
<h3>Square Root<a class="headerlink" href="#square-root" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">square_root()</span></code> function from <a class="reference internal" href="Assertions.html"><span class="std std-doc">the chapter on assertions</span></a> demonstrates a nice interplay between data and control dependencies.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">Assertions</span><span class="w"> </span><span class="kn">import</span> <span class="n">square_root</span>  <span class="c1"># minor dependency</span>
</pre></div>
</div>
</div>
</div>
<p>Here is the original source code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">square_root</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">square_root</span>(x):  <span class=" -Color -Color-White"># type: ignore</span>
    <span class=" -Color -Color-Blue">assert</span> x &gt;= <span class=" -Color -Color-Blue">0</span>  <span class=" -Color -Color-White"># precondition</span>

    approx = <span class=" -Color -Color-Blue">None</span>
    guess = x / <span class=" -Color -Color-Blue">2</span>
    <span class=" -Color -Color-Blue">while</span> approx != guess:
        approx = guess
        guess = (approx + x / approx) / <span class=" -Color -Color-Blue">2</span>

    <span class=" -Color -Color-Blue">assert</span> math.isclose(approx * approx, x)
    <span class=" -Color -Color-Blue">return</span> approx
</pre></div>
</div>
</div>
</div>
<p>Turning on logging shows the instrumented version:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Slicer</span><span class="p">(</span><span class="n">square_root</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">root_slicer</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Instrumenting &lt;function square_root at 0x10db4ff60&gt;
<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">square_root</span>(x):
    _data.param(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x, pos=<span class=" -Color -Color-Blue">1</span>, last=<span class=" -Color -Color-Blue">True</span>)
    <span class=" -Color -Color-Blue">assert</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;assertion&gt;&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x) &gt;= <span class=" -Color -Color-Blue">0</span>, loads=(_data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x),))
    approx = _data.set(<span class=" -Color -Color-Yellow">&#39;approx&#39;</span>, <span class=" -Color -Color-Blue">None</span>)
    guess = _data.set(<span class=" -Color -Color-Yellow">&#39;guess&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x) / <span class=" -Color -Color-Blue">2</span>)
    <span class=" -Color -Color-Blue">while</span> _data.test(_data.get(<span class=" -Color -Color-Yellow">&#39;approx&#39;</span>, approx) != _data.get(<span class=" -Color -Color-Yellow">&#39;guess&#39;</span>, guess)):
        <span class=" -Color -Color-Blue">with</span> _data:
            approx = _data.set(<span class=" -Color -Color-Yellow">&#39;approx&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;guess&#39;</span>, guess))
            guess = _data.set(<span class=" -Color -Color-Yellow">&#39;guess&#39;</span>, (_data.get(<span class=" -Color -Color-Yellow">&#39;approx&#39;</span>, approx) + _data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x) / _data.get(<span class=" -Color -Color-Yellow">&#39;approx&#39;</span>, approx)) / <span class=" -Color -Color-Blue">2</span>)
    <span class=" -Color -Color-Blue">assert</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;assertion&gt;&#39;</span>, _data.ret(_data.call(_data.get(<span class=" -Color -Color-Yellow">&#39;math&#39;</span>, math).isclose)(_data.arg(_data.get(<span class=" -Color -Color-Yellow">&#39;approx&#39;</span>, approx) * _data.get(<span class=" -Color -Color-Yellow">&#39;approx&#39;</span>, approx), pos=<span class=" -Color -Color-Blue">1</span>), _data.arg(_data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x), pos=<span class=" -Color -Color-Blue">2</span>))), loads=(_data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x), _data.get(<span class=" -Color -Color-Yellow">&#39;math&#39;</span>, math), _data, _data.get(<span class=" -Color -Color-Yellow">&#39;approx&#39;</span>, approx)))
    <span class=" -Color -Color-Blue">return</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;square_root() return value&gt;&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;approx&#39;</span>, approx))
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/2498757139.py:9: DeprecationWarning: ast.Num is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords.append(keyword(arg=&#39;pos&#39;, value=ast.Num(pos)))
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/2454789564.py:22: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(id), value],
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/3554319793.py:4: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(id), Name(id=id, ctx=Load())],
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:12: DeprecationWarning: ast.Num is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords=[keyword(arg=&#39;pos&#39;, value=ast.Num(n + 1))]
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:19: DeprecationWarning: ast.NameConstant is deprecated and will be removed in Python 3.14; use ast.Constant instead
  value=ast.NameConstant(value=True)))
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:25: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(child.arg),
</pre></div>
</div>
</div>
</div>
<p>The dependency graph shows how <code class="docutils literal notranslate"><span class="pre">guess</span></code> and <code class="docutils literal notranslate"><span class="pre">approx</span></code> flow into each other until they are the same.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">root_slicer</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7808b70aaf5909180f3a680d2b4cc9e39fbcecc7a00cc85d764cda6e3b1e5f9a.svg" src="_images/7808b70aaf5909180f3a680d2b4cc9e39fbcecc7a00cc85d764cda6e3b1e5f9a.svg" />
</div>
</div>
<p>Again, we can show the code annotated with dependencies:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">root_slicer</span><span class="o">.</span><span class="n">code</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>    54 <span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">square_root</span>(x):  <span class=" -Color -Color-White"># type: ignore</span>
*   55     <span class=" -Color -Color-Blue">assert</span> x &gt;= <span class=" -Color -Color-Blue">0</span>  <span class=" -Color -Color-White"># precondition  # &lt;= x (64)</span>
    56 
*   57     approx = <span class=" -Color -Color-Blue">None</span>
*   58     guess = x / <span class=" -Color -Color-Blue">2</span>  <span class=" -Color -Color-White"># &lt;= x (64)</span>
*   59     <span class=" -Color -Color-Blue">while</span> approx != guess:  <span class=" -Color -Color-White"># &lt;= guess (58), approx (57), guess (61), approx (60)</span>
*   60         approx = guess  <span class=" -Color -Color-White"># &lt;= guess (58), guess (61); &lt;- &lt;test&gt; (59)</span>
*   61         guess = (approx + x / approx) / <span class=" -Color -Color-Blue">2</span>  <span class=" -Color -Color-White"># &lt;= approx (60), x (64); &lt;- &lt;test&gt; (59)</span>
    62 
*   63     <span class=" -Color -Color-Blue">assert</span> math.isclose(approx * approx, x)  <span class=" -Color -Color-White"># &lt;= approx (60), x (64)</span>
*   64     <span class=" -Color -Color-Blue">return</span> approx  <span class=" -Color -Color-White"># &lt;= approx (60)</span>
</pre></div>
</div>
</div>
</div>
<p>The astute reader may find that a statement <code class="docutils literal notranslate"><span class="pre">assert</span> <span class="pre">p</span></code> does not control the following code, although it would be equivalent to <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">not</span> <span class="pre">p:</span> <span class="pre">raise</span> <span class="pre">Exception</span></code>. Why is that?</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">Why don't <code>assert</code> statements induce control dependencies?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">
    
        <input type="radio" name="d4697a32-b293-11f0-938a-6298cf1a5790" id="d4697a32-b293-11f0-938a-6298cf1a5790-1" onclick="clear_selection('d4697a32-b293-11f0-938a-6298cf1a5790')">
        <label id="d4697a32-b293-11f0-938a-6298cf1a5790-1-label" for="d4697a32-b293-11f0-938a-6298cf1a5790-1">We have no special handling of <code>raise</code> statements</label><br>
    
        <input type="radio" name="d4697a32-b293-11f0-938a-6298cf1a5790" id="d4697a32-b293-11f0-938a-6298cf1a5790-2" onclick="clear_selection('d4697a32-b293-11f0-938a-6298cf1a5790')">
        <label id="d4697a32-b293-11f0-938a-6298cf1a5790-2-label" for="d4697a32-b293-11f0-938a-6298cf1a5790-2">We have no special handling of exceptions</label><br>
    
        <input type="radio" name="d4697a32-b293-11f0-938a-6298cf1a5790" id="d4697a32-b293-11f0-938a-6298cf1a5790-3" onclick="clear_selection('d4697a32-b293-11f0-938a-6298cf1a5790')">
        <label id="d4697a32-b293-11f0-938a-6298cf1a5790-3-label" for="d4697a32-b293-11f0-938a-6298cf1a5790-3">Assertions are not supposed to act as controlling mechanisms</label><br>
    
        <input type="radio" name="d4697a32-b293-11f0-938a-6298cf1a5790" id="d4697a32-b293-11f0-938a-6298cf1a5790-4" onclick="clear_selection('d4697a32-b293-11f0-938a-6298cf1a5790')">
        <label id="d4697a32-b293-11f0-938a-6298cf1a5790-4-label" for="d4697a32-b293-11f0-938a-6298cf1a5790-4">All of the above</label><br>
    
    </div>
    </p>
    <input id="d4697a32-b293-11f0-938a-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('d4697a32-b293-11f0-938a-6298cf1a5790', 16, 0, '(1 * 1 &lt;&lt; 1 * 1 &lt;&lt; 1 * 1)')">
    <span class="quiz_hint" id="d4697a32-b293-11f0-938a-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
<p>Indeed: we treat assertions as “neutral” in the sense that they do not affect the remainder of the program – if they are turned off, they have no effect; and if they are turned on, the remaining program logic should not depend on them. (Our instrumentation also has no special treatment of <code class="docutils literal notranslate"><span class="pre">raise</span></code> or even <code class="docutils literal notranslate"><span class="pre">return</span></code> statements; they should be handled by our <code class="docutils literal notranslate"><span class="pre">with</span></code> blocks, though.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># print(repr(root_slicer))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="removing-html-markup">
<h3>Removing HTML Markup<a class="headerlink" href="#removing-html-markup" title="Link to this heading">#</a></h3>
<p>Let us come to our ongoing example, <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code>. This is how its instrumented code looks like:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Slicer</span><span class="p">(</span><span class="n">remove_html_markup</span><span class="p">)</span> <span class="k">as</span> <span class="n">rhm_slicer</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">remove_html_markup</span><span class="p">(</span><span class="s2">&quot;&lt;foo&gt;bar&lt;/foo&gt;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/2454789564.py:22: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(id), value],
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/3554319793.py:4: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(id), Name(id=id, ctx=Load())],
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:12: DeprecationWarning: ast.Num is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords=[keyword(arg=&#39;pos&#39;, value=ast.Num(n + 1))]
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:19: DeprecationWarning: ast.NameConstant is deprecated and will be removed in Python 3.14; use ast.Constant instead
  value=ast.NameConstant(value=True)))
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:25: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(child.arg),
</pre></div>
</div>
</div>
</div>
<p>The graph is as discussed in the introduction to this chapter:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rhm_slicer</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/52234b2bfcdd4967fe031595ef4fa031cc259c47a0543c7fa6625fdfa3d026d0.svg" src="_images/52234b2bfcdd4967fe031595ef4fa031cc259c47a0543c7fa6625fdfa3d026d0.svg" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># print(repr(rhm_slicer.dependencies()))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rhm_slicer</span><span class="o">.</span><span class="n">code</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   238 <span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">remove_html_markup</span>(s):  <span class=" -Color -Color-White"># type: ignore</span>
*  239     tag = <span class=" -Color -Color-Blue">False</span>
*  240     quote = <span class=" -Color -Color-Blue">False</span>
*  241     out = <span class=" -Color -Color-Yellow">&quot;&quot;</span>
   242 
*  243     <span class=" -Color -Color-Blue">for</span> c <span class=" -Color -Color-Magenta">in</span> s:  <span class=" -Color -Color-White"># &lt;= s (255)</span>
*  244         <span class=" -Color -Color-Blue">assert</span> tag <span class=" -Color -Color-Magenta">or</span> <span class=" -Color -Color-Magenta">not</span> quote  <span class=" -Color -Color-White"># &lt;= tag (239), quote (240), tag (247), tag (249)</span>
   245 
*  246         <span class=" -Color -Color-Blue">if</span> c == <span class=" -Color -Color-Yellow">&#39;&lt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> <span class=" -Color -Color-Magenta">not</span> quote:  <span class=" -Color -Color-White"># &lt;= quote (240), c (243)</span>
*  247             tag = <span class=" -Color -Color-Blue">True</span>  <span class=" -Color -Color-White"># &lt;- &lt;test&gt; (246)</span>
*  248         <span class=" -Color -Color-Blue">elif</span> c == <span class=" -Color -Color-Yellow">&#39;&gt;&#39;</span> <span class=" -Color -Color-Magenta">and</span> <span class=" -Color -Color-Magenta">not</span> quote:  <span class=" -Color -Color-White"># &lt;= quote (240), c (243); &lt;- &lt;test&gt; (246)</span>
*  249             tag = <span class=" -Color -Color-Blue">False</span>  <span class=" -Color -Color-White"># &lt;- &lt;test&gt; (248)</span>
*  250         <span class=" -Color -Color-Blue">elif</span> (c == <span class=" -Color -Color-Yellow">&#39;&quot;&#39;</span> <span class=" -Color -Color-Magenta">or</span> c == <span class=" -Color -Color-Yellow">&quot;&#39;&quot;</span>) <span class=" -Color -Color-Magenta">and</span> tag:  <span class=" -Color -Color-White"># &lt;= c (243); &lt;- &lt;test&gt; (248)</span>
   251             quote = <span class=" -Color -Color-Magenta">not</span> quote
*  252         <span class=" -Color -Color-Blue">elif</span> <span class=" -Color -Color-Magenta">not</span> tag:  <span class=" -Color -Color-White"># &lt;= tag (247), tag (249); &lt;- &lt;test&gt; (250)</span>
*  253             out = out + c  <span class=" -Color -Color-White"># &lt;= out (253), c (243), out (241); &lt;- &lt;test&gt; (252)</span>
   254 
*  255     <span class=" -Color -Color-Blue">return</span> out  <span class=" -Color -Color-White"># &lt;= out (253)</span>
</pre></div>
</div>
</div>
</div>
<p>We can also compute slices over the dependencies:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">start_remove_html_markup</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcelines</span><span class="p">(</span><span class="n">remove_html_markup</span><span class="p">)</span>
<span class="n">start_remove_html_markup</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>238
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">slicing_criterion</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;tag&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">remove_html_markup</span><span class="p">,</span>
                             <span class="n">start_remove_html_markup</span> <span class="o">+</span> <span class="mi">9</span><span class="p">))</span>
<span class="n">tag_deps</span> <span class="o">=</span> <span class="n">rhm_slicer</span><span class="o">.</span><span class="n">dependencies</span><span class="p">()</span><span class="o">.</span><span class="n">backward_slice</span><span class="p">(</span><span class="n">slicing_criterion</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
<span class="n">tag_deps</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8513ed2d0d3fa4ba86a2f76482126a297757bfd43c5084b36e4d1131d210a27f.svg" src="_images/8513ed2d0d3fa4ba86a2f76482126a297757bfd43c5084b36e4d1131d210a27f.svg" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># repr(tag_deps)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="calls-and-augmented-assign">
<h3>Calls and Augmented Assign<a class="headerlink" href="#calls-and-augmented-assign" title="Link to this heading">#</a></h3>
<p>Our last example covers augmented assigns and data flow across function calls. We introduce two simple functions <code class="docutils literal notranslate"><span class="pre">add_to()</span></code> and <code class="docutils literal notranslate"><span class="pre">mul_with()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">add_to</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="n">n</span> <span class="o">+=</span> <span class="n">m</span>
    <span class="k">return</span> <span class="n">n</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">mul_with</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="n">x</span> <span class="o">*=</span> <span class="n">y</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<p>And we put these two together in a single call:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">test_math</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">mul_with</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">add_to</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Slicer</span><span class="p">(</span><span class="n">add_to</span><span class="p">,</span> <span class="n">mul_with</span><span class="p">,</span> <span class="n">test_math</span><span class="p">)</span> <span class="k">as</span> <span class="n">math_slicer</span><span class="p">:</span>
    <span class="n">test_math</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/2454789564.py:22: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(id), value],
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/3554319793.py:4: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(id), Name(id=id, ctx=Load())],
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:12: DeprecationWarning: ast.Num is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords=[keyword(arg=&#39;pos&#39;, value=ast.Num(n + 1))]
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:25: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(child.arg),
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:19: DeprecationWarning: ast.NameConstant is deprecated and will be removed in Python 3.14; use ast.Constant instead
  value=ast.NameConstant(value=True)))
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/2498757139.py:9: DeprecationWarning: ast.Num is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords.append(keyword(arg=&#39;pos&#39;, value=ast.Num(pos)))
</pre></div>
</div>
</div>
</div>
<p>The resulting dependence graph nicely captures the data flow between these calls, notably arguments and parameters:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">math_slicer</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/3262393251.py:21: UserWarning: Warning: y (mul_with:3) depends on &lt;add_to() return value&gt; (add_to:3), but &#39;return x&#39; does not seem to have a call
  warnings.warn(f&quot;Warning: {self.format_var(var)} &quot;
</pre></div>
</div>
<img alt="_images/e3216f5bd408109068bbd4da63233c7b579e5bfaf6ac3ac89d30269a5ab92273.svg" src="_images/e3216f5bd408109068bbd4da63233c7b579e5bfaf6ac3ac89d30269a5ab92273.svg" />
</div>
</div>
<p>These are also reflected in the code view:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">math_slicer</span><span class="o">.</span><span class="n">code</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     1 <span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">test_math</span>() -&gt; <span class=" -Color -Color-Blue">None</span>:
*    2     <span class=" -Color -Color-Blue">return</span> mul_with(<span class=" -Color -Color-Blue">1</span>, add_to(<span class=" -Color -Color-Blue">2</span>, <span class=" -Color -Color-Blue">3</span>))  <span class=" -Color -Color-White"># &lt;= &lt;mul_with() return value&gt; (mul_with:3)</span>

     1 <span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">add_to</span>(n, m):  <span class=" -Color -Color-White"># type: ignore</span>
*    2     n += m  <span class=" -Color -Color-White"># &lt;= m (3), n (3)</span>
*    3     <span class=" -Color -Color-Blue">return</span> n  <span class=" -Color -Color-White"># &lt;= n (2)</span>

     1 <span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">mul_with</span>(x, y):  <span class=" -Color -Color-White"># type: ignore</span>
*    2     x *= y  <span class=" -Color -Color-White"># &lt;= y (3), x (3)</span>
*    3     <span class=" -Color -Color-Blue">return</span> x  <span class=" -Color -Color-White"># &lt;= &lt;add_to() return value&gt; (add_to:3), x (2)</span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/3262393251.py:21: UserWarning: Warning: y (mul_with:3) depends on &lt;add_to() return value&gt; (add_to:3), but &#39;return x&#39; does not seem to have a call
  warnings.warn(f&quot;Warning: {self.format_var(var)} &quot;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="dynamic-instrumentation">
<h2>Dynamic Instrumentation<a class="headerlink" href="#dynamic-instrumentation" title="Link to this heading">#</a></h2>
<p>When initializing <code class="docutils literal notranslate"><span class="pre">Slicer()</span></code>, one has to provide the set of functions to be instrumented. This is because the instrumentation has to take place <em>before</em> the code in the <code class="docutils literal notranslate"><span class="pre">with</span></code> block is executed. Can we determine this list on the fly – while <code class="docutils literal notranslate"><span class="pre">Slicer()</span></code> is executed?</p>
<p>The answer is: Yes, but the solution is a bit hackish – even more so than what we have seen above. In essence, we proceed in two steps:</p>
<ol class="arabic simple">
<li><p>When <code class="docutils literal notranslate"><span class="pre">DynamicSlicer.__init__()</span></code> is called:</p>
<ul class="simple">
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">inspect</span></code> module to determine the source code of the call</p></li>
<li><p>Analyze the enclosed <code class="docutils literal notranslate"><span class="pre">with</span></code> block for function calls</p></li>
<li><p>Instrument these functions</p></li>
</ul>
</li>
<li><p>Whenever a function is about to be called (<code class="docutils literal notranslate"><span class="pre">DataTracker.call()</span></code>)</p>
<ul class="simple">
<li><p>Create an instrumented version of that function</p></li>
<li><p>Have the <code class="docutils literal notranslate"><span class="pre">call()</span></code> method return the instrumented function instead</p></li>
</ul>
</li>
</ol>
<section id="excursion-implementing-dynamic-instrumentation">
<h3>Excursion: Implementing Dynamic Instrumentation<a class="headerlink" href="#excursion-implementing-dynamic-instrumentation" title="Link to this heading">#</a></h3>
<p>We start with the aim of determining the <code class="docutils literal notranslate"><span class="pre">with</span></code> block to which our slicer is applied. The <code class="docutils literal notranslate"><span class="pre">our_with_block()</span></code> method inspects the source code of the <code class="docutils literal notranslate"><span class="pre">Slicer()</span></code> caller, and returns the one <code class="docutils literal notranslate"><span class="pre">with</span></code> block (as an AST) whose source line is currently active.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">WithVisitor</span><span class="p">(</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">withs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">With</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visit_With</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">With</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AST</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">withs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Slicer</span><span class="p">(</span><span class="n">Slicer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">our_with_block</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">With</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the currently active `with` block.&quot;&quot;&quot;</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller_frame</span><span class="p">()</span>
        <span class="n">source_lines</span><span class="p">,</span> <span class="n">starting_lineno</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcelines</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="n">starting_lineno</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">starting_lineno</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">source_lines</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># We only get one `with` line, rather than the full block</span>
            <span class="c1"># This happens in Jupyter notebooks with iPython 8.1.0 and later.</span>
            <span class="c1"># Here&#39;s a hacky workaround to get the cell contents:</span>
            <span class="c1"># https://stackoverflow.com/questions/51566497/getting-the-source-of-an-object-defined-in-a-jupyter-notebook</span>
            <span class="n">source_lines</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">linecache</span><span class="o">.</span><span class="n">getlines</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
            <span class="n">starting_lineno</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">source_ast</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source_lines</span><span class="p">))</span>
        <span class="n">wv</span> <span class="o">=</span> <span class="n">WithVisitor</span><span class="p">()</span>
        <span class="n">wv</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">source_ast</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">with_ast</span> <span class="ow">in</span> <span class="n">wv</span><span class="o">.</span><span class="n">withs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">starting_lineno</span> <span class="o">+</span> <span class="p">(</span><span class="n">with_ast</span><span class="o">.</span><span class="n">lineno</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">with_ast</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot find &#39;with&#39; block&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Within the <code class="docutils literal notranslate"><span class="pre">with</span></code> AST, we can identify all calls:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CallCollector</span><span class="p">(</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calls</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AST</span><span class="p">:</span>
        <span class="n">caller_id</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calls</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">caller_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Slicer</span><span class="p">(</span><span class="n">Slicer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">calls_in_our_with_block</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a set of function names called in the `with` block.&quot;&quot;&quot;</span>
        <span class="n">block_ast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_with_block</span><span class="p">()</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="n">CallCollector</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">stmt</span> <span class="ow">in</span> <span class="n">block_ast</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
            <span class="n">cc</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cc</span><span class="o">.</span><span class="n">calls</span>
</pre></div>
</div>
</div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">funcs_in_our_with_block()</span></code> finally returns a list of all functions used in the <code class="docutils literal notranslate"><span class="pre">with</span></code> block. This is the list of functions we will instrument upfront.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Slicer</span><span class="p">(</span><span class="n">Slicer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">funcs_in_our_with_block</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]:</span>
        <span class="n">funcs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calls_in_our_with_block</span><span class="p">():</span>
            <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_func</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">func</span><span class="p">:</span>
                <span class="n">funcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">funcs</span>
</pre></div>
</div>
</div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">default_items_to_instrument()</span></code> is already provided for dynamic instrumentation – it is invoked whenever no list of functions to instrument is provided. So we have it return the list of functions as computed above.</p>
<p>However, <code class="docutils literal notranslate"><span class="pre">default_items_to_instrument()</span></code> does one more thing: Using the (also provided) <code class="docutils literal notranslate"><span class="pre">instrument_call()</span></code> hook in our dependency tracker, we ensure that all (later) calls are redirected to instrumented functions! This way, if further functions are called, these will be instrumented on the fly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Slicer</span><span class="p">(</span><span class="n">Slicer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">default_items_to_instrument</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]:</span>
        <span class="c1"># In _data.call(), return instrumented function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependency_tracker</span><span class="o">.</span><span class="n">instrument_call</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span>  <span class="c1"># type: ignore</span>

        <span class="c1"># Start instrumenting the functions in our `with` block</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">funcs_in_our_with_block</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id14">
<h3>End of Excursion<a class="headerlink" href="#id14" title="Link to this heading">#</a></h3>
<p>Both these hacks are effective, as shown in the following example. We use the <code class="docutils literal notranslate"><span class="pre">Slicer()</span></code> constructor without arguments; it automatically identifies <code class="docutils literal notranslate"><span class="pre">fun_2()</span></code> as a function in the <code class="docutils literal notranslate"><span class="pre">with</span></code> block. As the instrumented <code class="docutils literal notranslate"><span class="pre">fun2()</span></code> is invoked, its <code class="docutils literal notranslate"><span class="pre">_data.call()</span></code> method instruments the call to <code class="docutils literal notranslate"><span class="pre">fun_1()</span></code> (and ensures the instrumented version is called).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">fun_1</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">fun_2</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">fun_1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Slicer</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">slicer</span><span class="p">:</span>
    <span class="n">fun_2</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Instrumenting &lt;function fun_2 at 0x10e268fe0&gt;
<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">fun_2</span>(x: <span class=" -Color -Color-Cyan">int</span>) -&gt; <span class=" -Color -Color-Cyan">int</span>:
    _data.param(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x, pos=<span class=" -Color -Color-Blue">1</span>, last=<span class=" -Color -Color-Blue">True</span>)
    <span class=" -Color -Color-Blue">return</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;fun_2() return value&gt;&#39;</span>, _data.ret(_data.call(_data.get(<span class=" -Color -Color-Yellow">&#39;fun_1&#39;</span>, fun_1))(_data.arg(_data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x), pos=<span class=" -Color -Color-Blue">1</span>))))

Instrumenting &lt;function fun_1 at 0x10e6c6520&gt;
<span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">fun_1</span>(x: <span class=" -Color -Color-Cyan">int</span>) -&gt; <span class=" -Color -Color-Cyan">int</span>:
    _data.param(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x, pos=<span class=" -Color -Color-Blue">1</span>, last=<span class=" -Color -Color-Blue">True</span>)
    <span class=" -Color -Color-Blue">return</span> _data.set(<span class=" -Color -Color-Yellow">&#39;&lt;fun_1() return value&gt;&#39;</span>, _data.get(<span class=" -Color -Color-Yellow">&#39;x&#39;</span>, x))
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/2498757139.py:9: DeprecationWarning: ast.Num is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords.append(keyword(arg=&#39;pos&#39;, value=ast.Num(pos)))
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/3554319793.py:4: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(id), Name(id=id, ctx=Load())],
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/2454789564.py:22: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(id), value],
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:12: DeprecationWarning: ast.Num is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords=[keyword(arg=&#39;pos&#39;, value=ast.Num(n + 1))]
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:19: DeprecationWarning: ast.NameConstant is deprecated and will be removed in Python 3.14; use ast.Constant instead
  value=ast.NameConstant(value=True)))
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:25: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(child.arg),
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">slicer</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/eb0eeaed068ee9298cd3550b740944189c6fbfa384404d04c66bae436a622981.svg" src="_images/eb0eeaed068ee9298cd3550b740944189c6fbfa384404d04c66bae436a622981.svg" />
</div>
</div>
</section>
</section>
<section id="more-applications">
<h2>More Applications<a class="headerlink" href="#more-applications" title="Link to this heading">#</a></h2>
<p>The main use of dynamic slices is for <em>debugging tools</em>, where they show the origins of individual values. However, beyond facilitating debugging, tracking information flows has a number of additional applications, some of which we briefly sketch here.</p>
<section id="verifying-information-flows">
<h3>Verifying Information Flows<a class="headerlink" href="#verifying-information-flows" title="Link to this heading">#</a></h3>
<p>Using dynamic slices, we can check all the locations where (potentially sensitive) information is used. As an example, consider the following function <code class="docutils literal notranslate"><span class="pre">password_checker()</span></code>, which requests a password from the user and returns <code class="docutils literal notranslate"><span class="pre">True</span></code> if it is the correct one:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="nb">input</span><span class="p">,</span> <span class="n">next_inputs</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">SECRET_HASH_DIGEST</span> <span class="o">=</span> <span class="s1">&#39;59f2da35bcc39525b87932b4cc1f3d68&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">password_checker</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Request a password. Return True if correct.&quot;&quot;&quot;</span>
    <span class="n">secret_password</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter secret password: &quot;</span><span class="p">)</span>
    <span class="n">password_digest</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">secret_password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">password_digest</span> <span class="o">==</span> <span class="n">SECRET_HASH_DIGEST</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<p>(Note that this is a very naive implementation: A true password checker would use the Python <code class="docutils literal notranslate"><span class="pre">getpass</span></code> module to read in a password without echoing it in the clear, and possibly also use a more sophisticated hash function than <code class="docutils literal notranslate"><span class="pre">md5</span></code>.)</p>
<p>From a security perspective, the interesting question we can ask using slicing is: <em>Is the entered password stored in the clear somewhere</em>? For this, we can simply run our slicer to see where the inputs are going:</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;secret123&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Slicer</span><span class="p">()</span> <span class="k">as</span> <span class="n">slicer</span><span class="p">:</span>
    <span class="n">valid_pwd</span> <span class="o">=</span> <span class="n">password_checker</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/2498757139.py:9: DeprecationWarning: ast.Num is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords.append(keyword(arg=&#39;pos&#39;, value=ast.Num(pos)))
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/2454789564.py:22: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(id), value],
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/3554319793.py:4: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(id), Name(id=id, ctx=Load())],
</pre></div>
</div>
<div class="output text_html"><samp>Enter secret password: <b>secret123</b></samp></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">slicer</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/879a580661b778b3940fdc3326240b1f8f519046e52bd60f8a6f4c91907e44d7.svg" src="_images/879a580661b778b3940fdc3326240b1f8f519046e52bd60f8a6f4c91907e44d7.svg" />
</div>
</div>
<p>We see that the password only flows into <code class="docutils literal notranslate"><span class="pre">password_digest</span></code>, where it is already encrypted. If the password were flowing into some other function or variable, we would see this in our slice.</p>
<p>(Note that an attacker may still be able to find out which password was entered, for instance, by checking memory contents.)</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">What is the secret password, actually?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">
    
        <input type="radio" name="d5bafafa-b293-11f0-938a-6298cf1a5790" id="d5bafafa-b293-11f0-938a-6298cf1a5790-1" onclick="clear_selection('d5bafafa-b293-11f0-938a-6298cf1a5790')">
        <label id="d5bafafa-b293-11f0-938a-6298cf1a5790-1-label" for="d5bafafa-b293-11f0-938a-6298cf1a5790-1"><code>'automated'</code></label><br>
    
        <input type="radio" name="d5bafafa-b293-11f0-938a-6298cf1a5790" id="d5bafafa-b293-11f0-938a-6298cf1a5790-2" onclick="clear_selection('d5bafafa-b293-11f0-938a-6298cf1a5790')">
        <label id="d5bafafa-b293-11f0-938a-6298cf1a5790-2-label" for="d5bafafa-b293-11f0-938a-6298cf1a5790-2"><code>'debugging'</code></label><br>
    
        <input type="radio" name="d5bafafa-b293-11f0-938a-6298cf1a5790" id="d5bafafa-b293-11f0-938a-6298cf1a5790-3" onclick="clear_selection('d5bafafa-b293-11f0-938a-6298cf1a5790')">
        <label id="d5bafafa-b293-11f0-938a-6298cf1a5790-3-label" for="d5bafafa-b293-11f0-938a-6298cf1a5790-3"><code>'is'</code></label><br>
    
        <input type="radio" name="d5bafafa-b293-11f0-938a-6298cf1a5790" id="d5bafafa-b293-11f0-938a-6298cf1a5790-4" onclick="clear_selection('d5bafafa-b293-11f0-938a-6298cf1a5790')">
        <label id="d5bafafa-b293-11f0-938a-6298cf1a5790-4-label" for="d5bafafa-b293-11f0-938a-6298cf1a5790-4"><code>'fun'</code></label><br>
    
    </div>
    </p>
    <input id="d5bafafa-b293-11f0-938a-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('d5bafafa-b293-11f0-938a-6298cf1a5790', 4, 0, '')">
    <span class="quiz_hint" id="d5bafafa-b293-11f0-938a-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
</section>
<section id="assessing-test-quality">
<h3>Assessing Test Quality<a class="headerlink" href="#assessing-test-quality" title="Link to this heading">#</a></h3>
<p>Another interesting usage of dynamic slices is to <em>assess test quality</em>. With our <code class="docutils literal notranslate"><span class="pre">square_root()</span></code> function, we have seen that the included assertions well test the arguments and the result for correctness:</p>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>54  <span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">square_root</span>(x):  <span class=" -Color -Color-White"># type: ignore</span>
55      <span class=" -Color -Color-Blue">assert</span> x &gt;= <span class=" -Color -Color-Blue">0</span>  <span class=" -Color -Color-White"># precondition</span>
56  
57      approx = <span class=" -Color -Color-Blue">None</span>
58      guess = x / <span class=" -Color -Color-Blue">2</span>
59      <span class=" -Color -Color-Blue">while</span> approx != guess:
60          approx = guess
61          guess = (approx + x / approx) / <span class=" -Color -Color-Blue">2</span>
62  
63      <span class=" -Color -Color-Blue">assert</span> math.isclose(approx * approx, x)
64      <span class=" -Color -Color-Blue">return</span> approx
</pre></div>
</div>
</div>
</div>
<p>However, a lazy programmer could also omit these tests – or worse yet, include tests that always pass:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">square_root_unchecked</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="k">assert</span> <span class="kc">True</span>  <span class="c1"># &lt;-- new &quot;precondition&quot;</span>

    <span class="n">approx</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">guess</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">while</span> <span class="n">approx</span> <span class="o">!=</span> <span class="n">guess</span><span class="p">:</span>
        <span class="n">approx</span> <span class="o">=</span> <span class="n">guess</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="p">(</span><span class="n">approx</span> <span class="o">+</span> <span class="n">x</span> <span class="o">/</span> <span class="n">approx</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="k">assert</span> <span class="kc">True</span>  <span class="c1"># &lt;-- new &quot;postcondition&quot;</span>
    <span class="k">return</span> <span class="n">approx</span>
</pre></div>
</div>
</div>
</div>
<p>How can one check that the tests supplied actually are effective? This is a problem of “Who watches the watchmen” – we need to find a way to ensure that the tests do their job.</p>
<p>The “classical” way of testing tests is so-called <em>mutation testing</em> – that is, introducing <em>artificial errors</em> into the code to see whether the tests catch them. Mutation testing is effective: The above “weak” tests would not catch any change to the <code class="docutils literal notranslate"><span class="pre">square_root()</span></code> computation code, and hence quickly be determined as ineffective. However, mutation testing is also <em>costly</em>, as tests have to be ran again and again for every small code mutation.</p>
<p>Slices offer a cost-effective alternative to determine the quality of tests. The idea is that if there are statements in the code whose result does <em>not</em> flow into an assertion, then any errors in these statements will go unnoticed. In consequence, the larger the backward slice of an assertion, the higher its ability to catch errors.</p>
<p>We can easily validate this assumption using the two examples, above. Here is the backward slice for the “full” postcondition in <code class="docutils literal notranslate"><span class="pre">square_root()</span></code>. We see that the entire computation code flows into the final postcondition:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">postcondition_lineno</span> <span class="o">=</span> <span class="n">start_square_root</span> <span class="o">+</span> <span class="mi">9</span>
<span class="n">postcondition_lineno</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>63
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Slicer</span><span class="p">()</span> <span class="k">as</span> <span class="n">slicer</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

<span class="n">slicer</span><span class="o">.</span><span class="n">dependencies</span><span class="p">()</span><span class="o">.</span><span class="n">backward_slice</span><span class="p">((</span><span class="n">square_root</span><span class="p">,</span> <span class="n">postcondition_lineno</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/2498757139.py:9: DeprecationWarning: ast.Num is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords.append(keyword(arg=&#39;pos&#39;, value=ast.Num(pos)))
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/2454789564.py:22: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(id), value],
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/3554319793.py:4: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(id), Name(id=id, ctx=Load())],
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:12: DeprecationWarning: ast.Num is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords=[keyword(arg=&#39;pos&#39;, value=ast.Num(n + 1))]
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:19: DeprecationWarning: ast.NameConstant is deprecated and will be removed in Python 3.14; use ast.Constant instead
  value=ast.NameConstant(value=True)))
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:25: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(child.arg),
</pre></div>
</div>
<img alt="_images/b1b835c6b2281d9246b8d9d712f5259206cd1e60f49d8540c9921e17028da194.svg" src="_images/b1b835c6b2281d9246b8d9d712f5259206cd1e60f49d8540c9921e17028da194.svg" />
</div>
</div>
<p>In contrast, the “lazy” assertion in <code class="docutils literal notranslate"><span class="pre">square_root_unchecked()</span></code> has an empty backward slice, showing that it depends on no other value at all:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Slicer</span><span class="p">()</span> <span class="k">as</span> <span class="n">slicer</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root_unchecked</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

<span class="n">slicer</span><span class="o">.</span><span class="n">dependencies</span><span class="p">()</span><span class="o">.</span><span class="n">backward_slice</span><span class="p">((</span><span class="n">square_root</span><span class="p">,</span> <span class="n">postcondition_lineno</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/2454789564.py:22: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(id), value],
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/3554319793.py:4: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(id), Name(id=id, ctx=Load())],
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:12: DeprecationWarning: ast.Num is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords=[keyword(arg=&#39;pos&#39;, value=ast.Num(n + 1))]
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:19: DeprecationWarning: ast.NameConstant is deprecated and will be removed in Python 3.14; use ast.Constant instead
  value=ast.NameConstant(value=True)))
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:25: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(child.arg),
</pre></div>
</div>
<img alt="_images/0e4df06e606b57749dc8038e5ce8a1eee6c39332f775365ae083460fb96d4af4.svg" src="_images/0e4df06e606b57749dc8038e5ce8a1eee6c39332f775365ae083460fb96d4af4.svg" />
</div>
</div>
<p>In \cite{Schuler2011}, Schuler et al. have tried out this technique and found their “checked coverage” to be a sure indicator for the quality of the checks in tests. Using our dynamic slices, you may wish to try this out on Python code.</p>
</section>
<section id="use-in-statistical-debugging">
<h3>Use in Statistical Debugging<a class="headerlink" href="#use-in-statistical-debugging" title="Link to this heading">#</a></h3>
<p>Collecting dynamic slices over several runs allows for <em>correlating dependencies with other execution features</em>, notably <em>failures</em>: “The program fails whenever the value of <code class="docutils literal notranslate"><span class="pre">weekday</span></code> comes from <code class="docutils literal notranslate"><span class="pre">calendar()</span></code>.” We will revisit this idea in <a class="reference internal" href="StatisticalDebugger.html"><span class="std std-doc">the chapter on statistical debugging</span></a>.</p>
</section>
</section>
<section id="things-that-do-not-work">
<h2>Things that do not Work<a class="headerlink" href="#things-that-do-not-work" title="Link to this heading">#</a></h2>
<p>Our slicer (and especially the underlying dependency tracker) is still a proof of concept. A number of Python features are not or only partially supported, and/or hardly tested:</p>
<ul class="simple">
<li><p><strong>Exceptions</strong> can lead to missing or erroneous dependencies. The code assumes that for every <code class="docutils literal notranslate"><span class="pre">call()</span></code>, there is a matching <code class="docutils literal notranslate"><span class="pre">ret()</span></code>; when exceptions break this, dependencies across function calls and arguments may be missing or be assigned incorrectly.</p></li>
<li><p><strong>Multiple definitions on a single line</strong> as in <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">=</span> <span class="pre">y;</span> <span class="pre">x</span> <span class="pre">=</span> <span class="pre">1</span></code> can lead to missing or erroneous dependencies. Our implementation assumes that there is one statement per line.</p></li>
<li><p><strong>If-Expressions</strong> (<code class="docutils literal notranslate"><span class="pre">y</span> <span class="pre">=</span> <span class="pre">1</span> <span class="pre">if</span> <span class="pre">x</span> <span class="pre">else</span> <span class="pre">0</span></code>) do not create control dependencies, as there are no statements to control. Neither do <code class="docutils literal notranslate"><span class="pre">if</span></code> clauses in comprehensions.</p></li>
<li><p><strong>Asynchronous functions</strong> (<code class="docutils literal notranslate"><span class="pre">async</span></code>, <code class="docutils literal notranslate"><span class="pre">await</span></code>) are not tested.</p></li>
</ul>
<p>In these cases, the instrumentation and the underlying dependency tracker may fail to identify control and/or data flows. The semantics of the code, however, should always stay unchanged.</p>
</section>
<section id="lessons-learned">
<h2>Lessons Learned<a class="headerlink" href="#lessons-learned" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>To track the origin of some incorrect value, follow back its <em>dependencies</em>:</p>
<ul>
<li><p><em>Data dependencies</em> indicate where the value came from.</p></li>
<li><p><em>Control dependencies</em> show why a statement was executed.</p></li>
</ul>
</li>
<li><p>A <em>slice</em> is a subset of the code that could have influenced a specific value. It can be computed by transitively following all dependencies.</p></li>
<li><p><em>Instrument code</em> to automatically determine and visualize dependencies.</p></li>
</ul>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Link to this heading">#</a></h2>
<p>In the <a class="reference internal" href="StatisticalDebugger.html"><span class="std std-doc">next chapter</span></a>, we will explore how to make use of <em>multiple</em> passing and failing executions.</p>
</section>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">#</a></h2>
<p>Slicing as computing a subset of a program by means of data and control dependencies was invented by Mark Weiser \cite{Weiser1981}. In his seminal work “Programmers use Slices when Debugging”, \cite{Weiser1982}, Weiser demonstrated how such dependencies are crucial for systematic debugging:</p>
<blockquote>
<div><p>When debugging unfamiliar programs programmers use program pieces called <em>slices</em> which are sets of statements related by their flow of data. The statements in a slice are not necessarily textually contiguous, but may be scattered through a program.</p>
</div></blockquote>
<p>Weiser’s slices (and dependencies) were determined <em>statically</em> from program code. Both Korel and Laski \cite{Korel1988} as well as Agrawal and Horgan \cite{Agrawal1990} introduced <em>dynamic</em> program slicing, building on <em>dynamic</em> dependencies, which would be more specific to a given (failing) run. (The <code class="docutils literal notranslate"><span class="pre">Slicer</span></code> we implement in this chapter is a dynamic slicer.) Tip \cite{Tip1995} gives a survey on program slicing techniques. Chen et al. \cite{Chen2014} describe and evaluate the first dynamic slicer for Python programs (which is independent of our implementation).</p>
<p>One exemplary application of program slices is <a class="reference external" href="https://github.com/amyjko/whyline">the Whyline</a> by Ko and Myers \cite{Ko2004}. The Whyline is a debugging interface for asking questions about program behavior. It allows querying interactively where a particular variable came from (a data dependency) and why or why not specific things took place (control dependencies).</p>
<p>In \cite{Soremekun2021}, Soremekun et al. evaluated the performance of slicing as a fault localization mechanism and found that following dependencies was one of the most successful strategies to determine fault locations. Notably, if programmers first examine at most the top five most suspicious locations from <a class="reference internal" href="StatisticalDebugger.html"><span class="std std-doc">statistical debugging</span></a>, and then switch to dynamic slices, on average, they will need to examine only 15% (12 lines) of the code.</p>
</section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<section id="exercise-1-control-slices">
<h3>Exercise 1: Control Slices<a class="headerlink" href="#exercise-1-control-slices" title="Link to this heading">#</a></h3>
<p>Augment the <code class="docutils literal notranslate"><span class="pre">Slicer</span></code> class with two keyword arguments, <code class="docutils literal notranslate"><span class="pre">include</span></code> and <code class="docutils literal notranslate"><span class="pre">exclude</span></code>, each taking a list of functions to instrument or not to instrument, respectively. These can be helpful when using “automatic” instrumentation.</p>
</section>
<section id="exercise-2-incremental-exploration">
<h3>Exercise 2: Incremental Exploration<a class="headerlink" href="#exercise-2-incremental-exploration" title="Link to this heading">#</a></h3>
<p>This is more of a programming project than a simple exercise. Rather than showing all dependencies as a whole, as we do, build a system that allows the user to <em>explore</em> dependencies interactively.</p>
</section>
<section id="exercise-3-forward-slicing">
<h3>Exercise 3: Forward Slicing<a class="headerlink" href="#exercise-3-forward-slicing" title="Link to this heading">#</a></h3>
<p>Extend <code class="docutils literal notranslate"><span class="pre">Dependencies</span></code> with a variant of <code class="docutils literal notranslate"><span class="pre">backward_slice()</span></code> named <code class="docutils literal notranslate"><span class="pre">forward_slice()</span></code> that, instead of computing the dependencies that go <em>into</em> a location, computes the dependencies that go <em>out</em> of a location.</p>
</section>
<section id="exercise-4-code-with-forward-dependencies">
<h3>Exercise 4: Code with Forward Dependencies<a class="headerlink" href="#exercise-4-code-with-forward-dependencies" title="Link to this heading">#</a></h3>
<p>Create a variant of <code class="docutils literal notranslate"><span class="pre">Dependencies.code()</span></code> that, for each statement <code class="docutils literal notranslate"><span class="pre">s</span></code>, instead of showing a “passive” view (which variables and locations influenced <code class="docutils literal notranslate"><span class="pre">s</span></code>?), shows an “active” view (which variables and locations were influenced by <code class="docutils literal notranslate"><span class="pre">s</span></code>?). For <code class="docutils literal notranslate"><span class="pre">middle()</span></code>, for instance, the first line should show which lines are influenced by <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, and <code class="docutils literal notranslate"><span class="pre">z</span></code>, respectively. Use <code class="docutils literal notranslate"><span class="pre">-&gt;</span></code> for control flows and <code class="docutils literal notranslate"><span class="pre">=&gt;</span></code> for data flows.</p>
</section>
<section id="exercise-5-flow-assertions">
<h3>Exercise 5: Flow Assertions<a class="headerlink" href="#exercise-5-flow-assertions" title="Link to this heading">#</a></h3>
<p>In line with <a class="reference internal" href="#Verifying-Flows-at-Runtime"><span class="xref myst">Verifying Flows at Runtime</span></a>, above, implement a function <code class="docutils literal notranslate"><span class="pre">assert_flow(target,</span> <span class="pre">source)</span></code> that checks at runtime that the data flowing into <code class="docutils literal notranslate"><span class="pre">target</span></code> only comes from the variables named in <code class="docutils literal notranslate"><span class="pre">source</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">assert_flow</span><span class="p">(</span><span class="n">target</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Raise an `AssertionError` if the dependencies of `target`</span>
<span class="sd">    are not equal to `source`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>
    <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">assert_flow()</span></code> would be used in conjunction with <code class="docutils literal notranslate"><span class="pre">Slicer()</span></code> as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">demo4</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">25</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">26</span>
    <span class="n">assert_flow</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">])</span>  <span class="c1"># ensures that `y` depends on `x` only</span>
    <span class="k">return</span> <span class="n">y</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Slicer</span><span class="p">()</span> <span class="k">as</span> <span class="n">slicer</span><span class="p">:</span>
    <span class="n">demo4</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/2498757139.py:9: DeprecationWarning: ast.Num is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords.append(keyword(arg=&#39;pos&#39;, value=ast.Num(pos)))
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/2454789564.py:22: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(id), value],
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/3554319793.py:4: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(id), Name(id=id, ctx=Load())],
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:12: DeprecationWarning: ast.Num is deprecated and will be removed in Python 3.14; use ast.Constant instead
  keywords=[keyword(arg=&#39;pos&#39;, value=ast.Num(n + 1))]
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:25: DeprecationWarning: ast.Str is deprecated and will be removed in Python 3.14; use ast.Constant instead
  args=[ast.Str(child.arg),
/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51412/882995308.py:19: DeprecationWarning: ast.NameConstant is deprecated and will be removed in Python 3.14; use ast.Constant instead
  value=ast.NameConstant(value=True)))
</pre></div>
</div>
</div>
</div>
<p>To check dependencies, have <code class="docutils literal notranslate"><span class="pre">assert_flow()</span></code> check the contents of the <code class="docutils literal notranslate"><span class="pre">_data</span></code> dependency collector as set up by the slicer.</p>
</section>
<section id="exercise-6-checked-coverage">
<h3>Exercise 6: Checked Coverage<a class="headerlink" href="#exercise-6-checked-coverage" title="Link to this heading">#</a></h3>
<p>Implement checked coverage, as sketched in <a class="reference internal" href="#Assessing-Test-Quality"><span class="xref myst">Assessing Test Quality</span></a> above. For every <code class="docutils literal notranslate"><span class="pre">assert</span></code> statement encountered during a run, produce the number of statements it depends upon.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Assertions.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Asserting Expectations</p>
      </div>
    </a>
    <a class="right-next"
       href="DeltaDebugger.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Reducing Failure-Inducing Inputs</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dependencies">Dependencies</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-visualizing-dependencies">Excursion: Visualizing Dependencies</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#a-class-for-dependencies">A Class for Dependencies</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#drawing-dependencies">Drawing Dependencies</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#slices">Slices</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#end-of-excursion">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-dependencies">Data Dependencies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#control-dependencies">Control Dependencies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dependency-graphs">Dependency Graphs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#showing-dependencies-with-code">Showing Dependencies with Code</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-listing-dependencies">Excursion: Listing Dependencies</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">End of Excursion</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Slices</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tracking-techniques">Tracking Techniques</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#wrapping-data-objects">Wrapping Data Objects</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#wrapping-data-accesses">Wrapping Data Accesses</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-data-tracker">A Data Tracker</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#instrumenting-source-code">Instrumenting Source Code</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tracking-variable-accesses">Tracking Variable Accesses</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-tracking-assignments-and-assertions">Excursion: Tracking Assignments and Assertions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-tracking-return-values">Excursion: Tracking Return Values</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-tracking-control">Excursion: Tracking Control</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-tracking-calls-and-arguments">Excursion: Tracking Calls and Arguments</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-tracking-parameters">Excursion: Tracking Parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-transformer-stress-test">Excursion: Transformer Stress Test</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tracking-dependencies">Tracking Dependencies</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">Data Dependencies</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-variables">Reading Variables</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-locations">Checking Locations</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-variables">Setting Variables</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-control-dependencies">Excursion: Control Dependencies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-calls-and-returns">Excursion: Calls and Returns</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-function-arguments">Excursion: Function Arguments</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-diagnostics">Excursion: Diagnostics</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#slicing-code">Slicing Code</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#an-instrumenter-base-class">An Instrumenter Base Class</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-slicer-class">The Slicer Class</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#diagnostics">Diagnostics</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#more-examples">More Examples</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#square-root">Square Root</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#removing-html-markup">Removing HTML Markup</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calls-and-augmented-assign">Calls and Augmented Assign</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dynamic-instrumentation">Dynamic Instrumentation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-dynamic-instrumentation">Excursion: Implementing Dynamic Instrumentation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#more-applications">More Applications</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#verifying-information-flows">Verifying Information Flows</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assessing-test-quality">Assessing Test Quality</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-in-statistical-debugging">Use in Statistical Debugging</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#things-that-do-not-work">Things that do not Work</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-control-slices">Exercise 1: Control Slices</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-incremental-exploration">Exercise 2: Incremental Exploration</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3-forward-slicing">Exercise 3: Forward Slicing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-4-code-with-forward-dependencies">Exercise 4: Code with Forward Dependencies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-5-flow-assertions">Exercise 5: Flow Assertions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-6-checked-coverage">Exercise 6: Checked Coverage</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Andreas Zeller
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <div>
  Copyright &copy; 2021–2025 <a href="https://www.cispa.de/">CISPA Helmholtz Center for Information Security</a>.
  The <strong>content</strong> of this project is licensed under the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
  The <strong>source code</strong> that is part of the content, as well as the source code used to format and display that content is licensed under the <a href="https://github.com/uds-se/debuggingbook/blob/master/LICENSE.md#mit-license">MIT License</a>. <a href="https://cispa.de/en/impressum">Imprint</a>.
  <br>
  <a href="https://cispa.de/en/impressum">Imprint</a> &middot; <a href="/html/index.html#how-do-i-cite-your-work">Cite</a>
</div>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>