
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Asserting Expectations &#8212; The Debugging Book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=d5c2cecb" />
    <link rel="stylesheet" type="text/css" href="_static/mastodon-timeline.css?v=f82c2b23" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Assertions';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Tracking Failure Origins" href="Slicer.html" />
    <link rel="prev" title="How Debuggers Work" href="Debugger.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content"><p>This is a beta version of debuggingbook.org, currently in development. See the <a href="https://debuggingbook.org/classic/"  style="color:white!important;">classic site</a> for the 2024 version.</p></div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/debuggingbook.png" class="logo__image only-light" alt="The Debugging Book - Home"/>
    <script>document.write(`<img src="_static/debuggingbook.png" class="logo__image only-dark" alt="The Debugging Book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    The Debugging Book
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tours.html">Sitemap</a></li>
<li class="toctree-l1"><a class="reference internal" href="Intro_Debugging.html">Introduction to Debugging</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Observing Executions</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tracer.html">Tracing Executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="Debugger.html">How Debuggers Work</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Asserting Expectations</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Flows and Dependencies</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Slicer.html">Tracking Failure Origins</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Reducing Failure Causes</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="DeltaDebugger.html">Reducing Failure-Inducing Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ChangeDebugger.html">Isolating Failure-Inducing Changes</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Abstracting Failures</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="StatisticalDebugger.html">Statistical Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="DynamicInvariants.html">Mining Function Specifications</a></li>
<li class="toctree-l1"><a class="reference internal" href="DDSetDebugger.html">Generalizing Failure Circumstances</a></li>
<li class="toctree-l1"><a class="reference internal" href="Alhazen.html">Learning from Failures</a></li>
<li class="toctree-l1"><a class="reference internal" href="PerformanceDebugger.html">Debugging Performance Issues</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Automatic Repair</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Repairer.html">Repairing Code Automatically</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Debugging in the Large</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tracking.html">Tracking Bugs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ChangeCounter.html">Where the Bugs are</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ExpectError.html">Error Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timer.html">Timer</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timeout.html">Timeout</a></li>
<li class="toctree-l1"><a class="reference internal" href="ClassDiagram.html">Class Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="StackInspector.html">Inspecting Call Stacks</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">About This Book</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ReleaseNotes.html">Release Notes for The Debugging Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="Importing.html">Downloads and Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Guide_for_Authors.html">Guide for Authors</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/uds-se/debuggingbook/master?urlpath=tree/docs/notebooks/Assertions.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/uds-se/debuggingbook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/uds-se/debuggingbook/issues/new?title=Issue%20on%20page%20%2FAssertions.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
    <li><a href="../code/Assertions.py" target="_blank"
       class="btn btn-sm btn-download-source-button dropdown-item"
       title="Download Python code"
       data-bs-placement="left" data-bs-toggle="tooltip"
    >
  

    <span class="btn__icon-container">
      <i class="fas fa-file"></i>
      </span>
    <span class="btn__text-container">.py</span>
    </a>
    </li>
    
      
      
      
      <li><a href="_sources/Assertions.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download notebook"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  
    <li><a href="Importing.html" target="_blank"
       class="btn btn-sm btn-download-source-button dropdown-item"
       title="All downloads"
       data-bs-placement="left" data-bs-toggle="tooltip"
    >
  

    <span class="btn__icon-container">
      <i class="fas fa-file"></i>
      </span>
    <span class="btn__text-container">All downloads</span>
    </a>
    </li>
    </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Asserting Expectations</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introducing-assertions">Introducing Assertions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assertions">Assertions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assertion-diagnostics">Assertion Diagnostics</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-preconditions">Checking Preconditions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-results">Checking Results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assertions-and-tests">Assertions and Tests</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#partial-checks">Partial Checks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assertions-and-documentation">Assertions and Documentation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-assertions-to-trivially-locate-defects">Using Assertions to Trivially Locate Defects</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-data-structures">Checking Data Structures</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#times-and-time-bombs">Times and Time Bombs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#invariant-checkers">Invariant Checkers</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-checked-getters-and-setters-in-python">Excursion: Checked Getters and Setters in Python</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#end-of-excursion">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#large-data-structures">Large Data Structures</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#system-invariants">System Invariants</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-c-memory-model">The C Memory Model</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-a-c-memory-model-simulator">Excursion: A C Memory Model Simulator</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dynamic-memory">Dynamic Memory</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-dynamic-memory-in-c">Excursion: Dynamic Memory in C</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#managed-memory">Managed Memory</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-managed-memory">Excursion: Managed Memory</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-memory-usage-with-valgrind">Checking Memory Usage with Valgrind</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-memory-usage-with-memory-sanitizer">Checking Memory Usage with Memory Sanitizer</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#when-should-invariants-be-checked">When Should Invariants be Checked?</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assertions-are-not-production-code">Assertions are not Production Code</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#for-system-preconditions-use-production-code">For System Preconditions, Use Production Code</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#consider-leaving-some-assertions-on">Consider Leaving Some Assertions On</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-how-your-application-should-handle-internal-errors">Define How Your Application Should Handle Internal Errors</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-storage-assertions">Exercise 1 – Storage Assertions</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#task-1-local-consistency">Task 1 – Local Consistency</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#task-2-global-consistency">Task 2 – Global Consistency</a></li>
</ul>
</li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="asserting-expectations">
<h1>Asserting Expectations<a class="headerlink" href="#asserting-expectations" title="Link to this heading">#</a></h1>
<p>In the previous chapters on <a class="reference internal" href="Tracer.html"><span class="std std-doc">tracing</span></a> and <a class="reference internal" href="Debugger.html"><span class="std std-doc">interactive debugging</span></a>, we have seen how to observe executions. By checking our observations against our expectations, we can find out when and how the program state is faulty. So far, we have assumed that this check would be done by <em>humans</em> – that is, us. However, having this check done by a <em>computer</em>, for instance as part of the execution, is infinitely more rigorous and efficient. In this chapter, we introduce techniques to <em>specify</em> our expectations and to check them at runtime, enabling us to detect faults <em>right as they occur</em>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">YouTubeVideo</span>
<span class="n">YouTubeVideo</span><span class="p">(</span><span class="s2">&quot;9mI9sbKFkwU&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <iframe
            width="640"
            height="360"
            src="https://www.youtube-nocookie.com/embed/9mI9sbKFkwU"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
<p><strong>Prerequisites</strong></p>
<ul class="simple">
<li><p>You should have read the <a class="reference internal" href="Tracer.html"><span class="std std-doc">chapter on tracing executions</span></a>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">bookutils.setup</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">quiz</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">Tracer</span>
</pre></div>
</div>
</div>
</div>
<section id="synopsis">
<h2>Synopsis<a class="headerlink" href="#synopsis" title="Link to this heading">#</a></h2>
<p>To <a class="reference internal" href="Importing.html"><span class="std std-doc">use the code provided in this chapter</span></a>, write</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">debuggingbook.Assertions</span><span class="w"> </span><span class="kn">import</span> <span class="o">&lt;</span><span class="n">identifier</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>and then make use of the following features.</p>
<p><strong>Note</strong>: The examples in this section only work after the rest of the cells have been executed.</p>
<p>This chapter discusses <em>assertions</em> to define <em>assumptions</em> on function inputs and results:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">my_square_root</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="k">assert</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span>
</pre></div>
</div>
</div>
</div>
<p>Notably, assertions detect <em>violations</em> of these assumptions at runtime:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">my_square_root</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/76616918.py&quot;, line 2, in &lt;module&gt;
    y = my_square_root(-1)
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/2617682038.py&quot;, line 2, in my_square_root
    assert x &gt;= 0
           ^^^^^^
AssertionError (expected)
</pre></div>
</div>
</div>
</div>
<p><em>System assertions</em> help to detect invalid memory operations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">managed_mem</span> <span class="o">=</span> <span class="n">ManagedMemory</span><span class="p">()</span>
<span class="n">managed_mem</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p>|Address|<span style="color: blue">0</span>|<span style="color: blue">1</span>|<span style="color: lightgrey">2</span>|<span style="color: lightgrey">3</span>|<span style="color: lightgrey">4</span>|<span style="color: lightgrey">5</span>|<span style="color: lightgrey">6</span>|<span style="color: lightgrey">7</span>|<span style="color: lightgrey">8</span>|<span style="color: lightgrey">9</span>|
|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|
|Allocated| | | | | | | | | | |
|Initialized| | | | | | | | | | |
|Content|-1|0| | | | | | | | |</p>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">managed_mem</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/1296110967.py&quot;, line 2, in &lt;module&gt;
    x = managed_mem[2]
        ~~~~~~~~~~~^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/2465984283.py&quot;, line 3, in __getitem__
    return self.read(address)
           ~~~~~~~~~^^^^^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/2898840933.py&quot;, line 9, in read
    assert self.allocated[address], \
           ~~~~~~~~~~~~~~^^^^^^^^^
AssertionError: Reading from unallocated memory (expected)
</pre></div>
</div>
</div>
</div>
</section>
<section id="introducing-assertions">
<h2>Introducing Assertions<a class="headerlink" href="#introducing-assertions" title="Link to this heading">#</a></h2>
<p><a class="reference internal" href="Tracer.html"><span class="std std-doc">Tracers</span></a> and <a class="reference internal" href="Debugger.html"><span class="std std-doc">Interactive Debuggers</span></a> are very flexible tools that allow you to observe precisely what happens during a program execution. It is still <em>you</em>, however, who has to check program states and traces against your expectations. There is nothing wrong with that – except that checking hundreds of statements or variables can quickly become a pretty boring and tedious task.</p>
<p>Processing and checking large amounts of data is actually precisely what <em>computers were invented for</em>. Hence, we should aim to <em>delegate such checking tasks to our computers</em> as much as we can. This automates another essential part of debugging – maybe even <em>the</em> most essential part.</p>
<section id="assertions">
<h3>Assertions<a class="headerlink" href="#assertions" title="Link to this heading">#</a></h3>
<p>The standard tool for having the computer check specific conditions at runtime is called an <em>assertion</em>. An assertion takes the form</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">condition</span>
</pre></div>
</div>
<p>and states that, at runtime, the computer should check that <code class="docutils literal notranslate"><span class="pre">condition</span></code> holds, e.g. evaluates to True. If the condition holds, then nothing happens:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
</div>
<p>If the condition evaluates to <em>False</em>, however, then the assertion <em>fails</em>, indicating an internal error.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ExpectError</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExpectError</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="k">assert</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/2715578531.py&quot;, line 2, in &lt;module&gt;
    assert False
           ^^^^^
AssertionError (expected)
</pre></div>
</div>
</div>
</div>
<p>A common usage for assertions is for <em>testing</em>. For instance, we can test a square root function as</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">test_square_root</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">square_root</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">square_root</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="o">...</span>
</pre></div>
</div>
</div>
</div>
<p>and <code class="docutils literal notranslate"><span class="pre">test_square_root()</span></code> will fail if <code class="docutils literal notranslate"><span class="pre">square_root()</span></code> returns a wrong value.</p>
<p>Assertions are available in all programming languages. You can even go and implement assertions yourself:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">my_own_assert</span><span class="p">(</span><span class="n">cond</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cond</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span>
</pre></div>
</div>
</div>
</div>
<p>… and get (almost) the same functionality:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">my_own_assert</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/1450148856.py&quot;, line 2, in &lt;module&gt;
    my_own_assert(2 + 2 == 5)
    ~~~~~~~~~~~~~^^^^^^^^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/3374119957.py&quot;, line 3, in my_own_assert
    raise AssertionError
AssertionError (expected)
</pre></div>
</div>
</div>
</div>
</section>
<section id="assertion-diagnostics">
<h3>Assertion Diagnostics<a class="headerlink" href="#assertion-diagnostics" title="Link to this heading">#</a></h3>
<p>In most languages, <em>built-in assertions</em> offer a bit more functionality than what can be obtained with self-defined functions. Most notably, built-in assertions</p>
<ul class="simple">
<li><p>frequently tell <em>which condition</em> failed (<code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">+</span> <span class="pre">2</span> <span class="pre">==</span> <span class="pre">5</span></code>)</p></li>
<li><p>frequently tell <em>where</em> the assertion failed (<code class="docutils literal notranslate"><span class="pre">line</span> <span class="pre">2</span></code>), and</p></li>
<li><p>are <em>optional</em> – that is, they can be turned off to save computation time.</p></li>
</ul>
<p>C and C++, for instance, provide an <code class="docutils literal notranslate"><span class="pre">assert()</span></code> function that does all this:</p>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;testassert.c&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s1">&#39;.h&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Cyan">#include</span><span class=" -Color -Color-White"> &lt;stdio.h&gt;</span>
<span class=" -Color -Color-Cyan">#include</span><span class=" -Color -Color-White"> &quot;assert.h&quot;</span>

<span class=" -Color -Color-Cyan">int</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">main</span>(<span class=" -Color -Color-Cyan">int</span><span class=" -Color -Color-White"> </span>argc,<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Cyan">char</span><span class=" -Color -Color-White"> </span>*argv[])<span class=" -Color -Color-White"> </span>{
<span class=" -Color -Color-White">    </span>assert(<span class=" -Color -Color-Blue">2</span><span class=" -Color -Color-White"> </span>+<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">2</span><span class=" -Color -Color-White"> </span>==<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">5</span>);
<span class=" -Color -Color-White">    </span>printf(<span class=" -Color -Color-Yellow">&quot;Foo\n&quot;</span>);
}
</pre></div>
</div>
</div>
</div>
<p>If we compile this function and execute it, the assertion (expectedly) fails:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>cc<span class="w"> </span>-g<span class="w"> </span>-o<span class="w"> </span>testassert<span class="w"> </span>testassert.c
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>./testassert
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Assertion failed: (2 + 2 == 5), function main, file testassert.c, line 6.
</pre></div>
</div>
</div>
</div>
<p>How would the C <code class="docutils literal notranslate"><span class="pre">assert()</span></code> function be able to report the condition and the current location? In fact, <code class="docutils literal notranslate"><span class="pre">assert()</span></code> is commonly implemented as a <em>macro</em> that besides checking the condition, also turns it into a <em>string</em> for a potential error message. Additional macros such as <code class="docutils literal notranslate"><span class="pre">__FILE__</span></code> and <code class="docutils literal notranslate"><span class="pre">__LINE__</span></code> expand into the current location and line, which can then all be used in the assertion error message.</p>
<p>A very simple definition of <code class="docutils literal notranslate"><span class="pre">assert()</span></code> that provides the above diagnostics looks like this:</p>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;assert.h&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s1">&#39;.h&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Cyan">#include</span><span class=" -Color -Color-White"> &lt;stdio.h&gt;</span>
<span class=" -Color -Color-Cyan">#include</span><span class=" -Color -Color-White"> &lt;stdlib.h&gt;</span>

<span class=" -Color -Color-Cyan">#ifndef NDEBUG</span>
<span class=" -Color -Color-Cyan">#define assert(cond) \</span>
<span class=" -Color -Color-Cyan">    if (!(cond)) { \</span>
<span class=" -Color -Color-Cyan">        fprintf(stderr, &quot;Assertion failed: %s, function %s, file %s, line %d&quot;, \</span>
<span class=" -Color -Color-Cyan">            #cond, __func__, __FILE__, __LINE__); \</span>
<span class=" -Color -Color-Cyan">        exit(1); \</span>
<span class=" -Color -Color-Cyan">    }</span>
<span class=" -Color -Color-Cyan">#else</span>
<span class=" -Color -Color-Cyan">#define assert(cond) ((void) 0)</span>
<span class=" -Color -Color-Cyan">#endif</span>
</pre></div>
</div>
</div>
</div>
<p>(If you think that this is cryptic, you should have a look at an <a class="reference external" href="https://github.com/bminor/glibc/blob/master/assert/assert.h"><em>actual</em> <code class="docutils literal notranslate"><span class="pre">&lt;assert.h&gt;</span></code> header file</a>.)</p>
<p>This header file reveals another important property of assertions – they can be <em>turned off</em>. In C and C++, defining the preprocessor variable <code class="docutils literal notranslate"><span class="pre">NDEBUG</span></code> (“no debug”) turns off assertions, replacing them with a statement that does nothing. The <code class="docutils literal notranslate"><span class="pre">NDEBUG</span></code> variable can be set during compilation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>cc<span class="w"> </span>-DNDEBUG<span class="w"> </span>-g<span class="w"> </span>-o<span class="w"> </span>testassert<span class="w"> </span>testassert.c
</pre></div>
</div>
</div>
</div>
<p>And, as you can see, the assertion has no effect anymore:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>./testassert
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Foo
</pre></div>
</div>
</div>
</div>
<p>In Python, assertions can also be turned off, by invoking the <code class="docutils literal notranslate"><span class="pre">python</span></code> interpreter with the <code class="docutils literal notranslate"><span class="pre">-O</span></code> (“optimize”) flag:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;assert 2 + 2 == 5; print(&quot;Foo&quot;)&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File <span class=" -Color -Color-Magenta">&quot;&lt;string&gt;&quot;</span>, line <span class=" -Color -Color-Magenta">1</span>, in <span class=" -Color -Color-Magenta">&lt;module&gt;</span>
    assert <span class=" -Color -Color-Bold -Color-Bold-Red">2 + 2 == 5</span>; print(&quot;Foo&quot;)
           <span class=" -Color -Color-Bold -Color-Bold-Red">^^^^^^^^^^</span>
<span class=" -Color -Color-Bold -Color-Bold-Magenta">AssertionError</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>-O<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;assert 2 + 2 == 5; print(&quot;Foo&quot;)&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Foo
</pre></div>
</div>
</div>
</div>
<p>In comparison, which language wins in the amount of assertion diagnostics? Have a look at the information Python provides. If, after defining <code class="docutils literal notranslate"><span class="pre">fun()</span></code> as</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">assert</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">5</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">If we invoke <code>fun()</code> and the assertion fails, which information do we get?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">
    
        <input type="radio" name="c5097b82-b293-11f0-94a2-6298cf1a5790" id="c5097b82-b293-11f0-94a2-6298cf1a5790-1" onclick="clear_selection('c5097b82-b293-11f0-94a2-6298cf1a5790')">
        <label id="c5097b82-b293-11f0-94a2-6298cf1a5790-1-label" for="c5097b82-b293-11f0-94a2-6298cf1a5790-1">The failing condition (<code>2 + 2 == 5</code>)</label><br>
    
        <input type="radio" name="c5097b82-b293-11f0-94a2-6298cf1a5790" id="c5097b82-b293-11f0-94a2-6298cf1a5790-2" onclick="clear_selection('c5097b82-b293-11f0-94a2-6298cf1a5790')">
        <label id="c5097b82-b293-11f0-94a2-6298cf1a5790-2-label" for="c5097b82-b293-11f0-94a2-6298cf1a5790-2">The location of the assertion in the program</label><br>
    
        <input type="radio" name="c5097b82-b293-11f0-94a2-6298cf1a5790" id="c5097b82-b293-11f0-94a2-6298cf1a5790-3" onclick="clear_selection('c5097b82-b293-11f0-94a2-6298cf1a5790')">
        <label id="c5097b82-b293-11f0-94a2-6298cf1a5790-3-label" for="c5097b82-b293-11f0-94a2-6298cf1a5790-3">The list of callers</label><br>
    
        <input type="radio" name="c5097b82-b293-11f0-94a2-6298cf1a5790" id="c5097b82-b293-11f0-94a2-6298cf1a5790-4" onclick="clear_selection('c5097b82-b293-11f0-94a2-6298cf1a5790')">
        <label id="c5097b82-b293-11f0-94a2-6298cf1a5790-4-label" for="c5097b82-b293-11f0-94a2-6298cf1a5790-4">All of the above</label><br>
    
    </div>
    </p>
    <input id="c5097b82-b293-11f0-94a2-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('c5097b82-b293-11f0-94a2-6298cf1a5790', 16, 0, '123456789 % 5')">
    <span class="quiz_hint" id="c5097b82-b293-11f0-94a2-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
<p>Indeed, a failed assertion (like any exception in Python) provides us with lots of debugging information, even including the source code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">fun</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/2842303881.py&quot;, line 2, in &lt;module&gt;
    fun()
    ~~~^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/3649916634.py&quot;, line 2, in fun
    assert 2 + 2 == 5
           ^^^^^^^^^^
AssertionError (expected)
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="checking-preconditions">
<h2>Checking Preconditions<a class="headerlink" href="#checking-preconditions" title="Link to this heading">#</a></h2>
<p>Assertions show their true power when they are not used in a test, but used in a program instead, because that is when they can check not only <em>one</em> run, but actually <em>all</em> runs.</p>
<p>The classic example for the use of assertions is a <em>square root</em> program, implementing the function <span class="math notranslate nohighlight">\(\sqrt{x}\)</span>.  (Let’s assume for a moment that the environment does not already have one.)</p>
<p>We want to ensure that <code class="docutils literal notranslate"><span class="pre">square_root()</span></code> is always called with correct arguments. For this purpose, we set up an assertion:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">square_root</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="k">assert</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span>
    <span class="o">...</span>   <span class="c1"># compute square root in y</span>
</pre></div>
</div>
</div>
</div>
<p>This assertion is called the <em>precondition</em>. A precondition is checked at the beginning of a function.  It checks whether all the conditions for using the function are met.</p>
<p>So, if we call <code class="docutils literal notranslate"><span class="pre">square_root()</span></code> with an bad argument, we will get an exception. This holds for <em>any</em> call, ever.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">square_root</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/3162937341.py&quot;, line 2, in &lt;module&gt;
    square_root(-1)
    ~~~~~~~~~~~^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/1081921329.py&quot;, line 2, in square_root
    assert x &gt;= 0
           ^^^^^^
AssertionError (expected)
</pre></div>
</div>
</div>
</div>
<p>For a dynamically typed language like Python, an assertion could actually also check that the argument has the correct type. For <code class="docutils literal notranslate"><span class="pre">square_root()</span></code>, we could ensure that <code class="docutils literal notranslate"><span class="pre">x</span></code> actually has a numeric type:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">square_root</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span>
    <span class="o">...</span>   <span class="c1"># compute square root in y</span>
</pre></div>
</div>
</div>
</div>
<p>And while calls with the correct types just work…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">square_root</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">square_root</span><span class="p">(</span><span class="mf">4.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>… a call with an illegal type will raise a revealing diagnostic:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">square_root</span><span class="p">(</span><span class="s1">&#39;4&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/2953341793.py&quot;, line 2, in &lt;module&gt;
    square_root(&#39;4&#39;)
    ~~~~~~~~~~~^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/1840548601.py&quot;, line 2, in square_root
    assert isinstance(x, (int, float))
           ~~~~~~~~~~^^^^^^^^^^^^^^^^^
AssertionError (expected)
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">If we did not check for the type of <code>x</code>, would the assertion <code>x &gt;= 0</code> still catch a bad call?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">
    
        <input type="radio" name="c50ef42c-b293-11f0-94a2-6298cf1a5790" id="c50ef42c-b293-11f0-94a2-6298cf1a5790-1" onclick="clear_selection('c50ef42c-b293-11f0-94a2-6298cf1a5790')">
        <label id="c50ef42c-b293-11f0-94a2-6298cf1a5790-1-label" for="c50ef42c-b293-11f0-94a2-6298cf1a5790-1">Yes, since <code>&gt;=</code> is only defined between numbers</label><br>
    
        <input type="radio" name="c50ef42c-b293-11f0-94a2-6298cf1a5790" id="c50ef42c-b293-11f0-94a2-6298cf1a5790-2" onclick="clear_selection('c50ef42c-b293-11f0-94a2-6298cf1a5790')">
        <label id="c50ef42c-b293-11f0-94a2-6298cf1a5790-2-label" for="c50ef42c-b293-11f0-94a2-6298cf1a5790-2">No, because an empty list or string would evaluate to 0</label><br>
    
    </div>
    </p>
    <input id="c50ef42c-b293-11f0-94a2-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('c50ef42c-b293-11f0-94a2-6298cf1a5790', 2, 0, '0b10 - 0b01')">
    <span class="quiz_hint" id="c50ef42c-b293-11f0-94a2-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
<p>Fortunately (for us Python users), the assertion <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">&gt;=</span> <span class="pre">0</span></code> would already catch a number of invalid types, because (in contrast to, say, JavaScript), Python has no implicit conversion of strings or structures to integers:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="s1">&#39;4&#39;</span> <span class="o">&gt;=</span> <span class="mi">0</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/2976301596.py&quot;, line 2, in &lt;module&gt;
    &#39;4&#39; &gt;= 0  # type: ignore
    ^^^^^^^^
TypeError: &#39;&gt;=&#39; not supported between instances of &#39;str&#39; and &#39;int&#39; (expected)
</pre></div>
</div>
</div>
</div>
</section>
<section id="checking-results">
<h2>Checking Results<a class="headerlink" href="#checking-results" title="Link to this heading">#</a></h2>
<p>While a precondition ensures that the <em>argument</em> to a function is correct, a <em>postcondition</em> checks the <em>result</em> of this very function (assuming the precondition held in the first place). For our <code class="docutils literal notranslate"><span class="pre">square_root()</span></code> function, we can check that the result <span class="math notranslate nohighlight">\(y = \sqrt{x}\)</span> is correct by checking that <span class="math notranslate nohighlight">\(y^2 = x\)</span> holds:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">square_root</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="k">assert</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span>
    <span class="o">...</span>   <span class="c1"># compute square root in y</span>
    <span class="k">assert</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y</span> <span class="o">==</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<p>In practice, we might encounter problems with this assertion. What might these be?</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">Why could the assertion fail despite <code>square_root()</code> being correct?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">
    
        <input type="radio" name="c510eaac-b293-11f0-94a2-6298cf1a5790" id="c510eaac-b293-11f0-94a2-6298cf1a5790-1" onclick="clear_selection('c510eaac-b293-11f0-94a2-6298cf1a5790')">
        <label id="c510eaac-b293-11f0-94a2-6298cf1a5790-1-label" for="c510eaac-b293-11f0-94a2-6298cf1a5790-1">We need to compute <code>y ** 2</code>, not <code>y * y</code></label><br>
    
        <input type="radio" name="c510eaac-b293-11f0-94a2-6298cf1a5790" id="c510eaac-b293-11f0-94a2-6298cf1a5790-2" onclick="clear_selection('c510eaac-b293-11f0-94a2-6298cf1a5790')">
        <label id="c510eaac-b293-11f0-94a2-6298cf1a5790-2-label" for="c510eaac-b293-11f0-94a2-6298cf1a5790-2">We may encounter rounding errors</label><br>
    
        <input type="radio" name="c510eaac-b293-11f0-94a2-6298cf1a5790" id="c510eaac-b293-11f0-94a2-6298cf1a5790-3" onclick="clear_selection('c510eaac-b293-11f0-94a2-6298cf1a5790')">
        <label id="c510eaac-b293-11f0-94a2-6298cf1a5790-3-label" for="c510eaac-b293-11f0-94a2-6298cf1a5790-3">The value of <code>x</code> may have changed during computation</label><br>
    
        <input type="radio" name="c510eaac-b293-11f0-94a2-6298cf1a5790" id="c510eaac-b293-11f0-94a2-6298cf1a5790-4" onclick="clear_selection('c510eaac-b293-11f0-94a2-6298cf1a5790')">
        <label id="c510eaac-b293-11f0-94a2-6298cf1a5790-4-label" for="c510eaac-b293-11f0-94a2-6298cf1a5790-4">The interpreter / compiler may be buggy</label><br>
    
    </div>
    </p>
    <input id="c510eaac-b293-11f0-94a2-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('c510eaac-b293-11f0-94a2-6298cf1a5790', 4, 0, '0b110011 - 0o61')">
    <span class="quiz_hint" id="c510eaac-b293-11f0-94a2-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
<p>Technically speaking, there could be many things that <em>also</em> could cause the assertion to fail (cosmic radiation, operating system bugs, secret service bugs, anything) – but the by far most important reason is indeed rounding errors. Here’s a simple example, using the Python built-in square root function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.0000000000000004
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">==</span> <span class="mf">2.0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>False
</pre></div>
</div>
</div>
</div>
<p>If you want to compare two floating-point values, you need to provide an <em>epsilon value</em> denoting the margin of error.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">square_root</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="k">assert</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span>
    <span class="o">...</span>   <span class="c1"># compute square root in y</span>
    <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">0.000001</span>
    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">y</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">epsilon</span>
</pre></div>
</div>
</div>
</div>
<p>In Python, the function <code class="docutils literal notranslate"><span class="pre">math.isclose(x,</span> <span class="pre">y)</span></code> also does the job, by default ensuring that the two values are the same within about 9 decimal digits:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">),</span> <span class="mf">2.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p>So let’s use <code class="docutils literal notranslate"><span class="pre">math.isclose()</span></code> for our revised postcondition:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">square_root</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="k">assert</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span>
    <span class="o">...</span>   <span class="c1"># compute square root in y</span>
    <span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let us try out this postcondition by using an actual implementation. The <a class="reference external" href="https://en.wikipedia.org/wiki/Newton%27s_method">Newton–Raphson method</a> is an efficient way to compute square roots:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">square_root</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="k">assert</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span>  <span class="c1"># precondition</span>

    <span class="n">approx</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">guess</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">while</span> <span class="n">approx</span> <span class="o">!=</span> <span class="n">guess</span><span class="p">:</span>
        <span class="n">approx</span> <span class="o">=</span> <span class="n">guess</span>
        <span class="n">guess</span> <span class="o">=</span> <span class="p">(</span><span class="n">approx</span> <span class="o">+</span> <span class="n">x</span> <span class="o">/</span> <span class="n">approx</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">approx</span> <span class="o">*</span> <span class="n">approx</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">approx</span>
</pre></div>
</div>
</div>
</div>
<p>Apparently, this implementation does the job:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">square_root</span><span class="p">(</span><span class="mf">4.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.0
</pre></div>
</div>
</div>
</div>
<p>However, it is not just this call that produces the correct result – <em>all</em> calls will produce the correct result. (If the postcondition assertion does not fail, that is.) So, a call like</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">square_root</span><span class="p">(</span><span class="mf">12345.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>111.1080555135405
</pre></div>
</div>
</div>
</div>
<p>does not require us to <em>manually</em> check the result – the postcondition assertion already has done that for us, and will continue to do so forever.</p>
<section id="assertions-and-tests">
<h3>Assertions and Tests<a class="headerlink" href="#assertions-and-tests" title="Link to this heading">#</a></h3>
<p>Having assertions right in the code gives us an easy means to <em>test</em> it – if we can feed sufficiently many inputs into the code without the postcondition ever failing, we can increase our confidence. Let us try this out with our <code class="docutils literal notranslate"><span class="pre">square_root()</span></code> function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10000</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">square_root</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Note again that we do not have to check the value of <code class="docutils literal notranslate"><span class="pre">y</span></code> – the <code class="docutils literal notranslate"><span class="pre">square_root()</span></code> postcondition already did that for us.</p>
<p>Instead of enumerating input values, we could also use random (non-negative) numbers; even totally random numbers could work if we filter out those tests where the precondition already fails. If you are interested in such <em>test generation techniques</em>, the <a class="reference internal" href="#fuzzingbook.org"><span class="xref myst">Fuzzing Book</span></a> is a great reference for you.</p>
<p>Modern program verification tools even can <em>prove</em> that your program will always meet its assertions. But for all this, you need to have <em>explicit</em> and <em>formal</em> assertions in the first place.</p>
<p>For those interested in testing and verification, here is a quiz for you:</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">Is there a value for x that satisfies the precondition, but fails the postcondition?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">
    
        <input type="radio" name="c5183424-b293-11f0-94a2-6298cf1a5790" id="c5183424-b293-11f0-94a2-6298cf1a5790-1" onclick="clear_selection('c5183424-b293-11f0-94a2-6298cf1a5790')">
        <label id="c5183424-b293-11f0-94a2-6298cf1a5790-1-label" for="c5183424-b293-11f0-94a2-6298cf1a5790-1">Yes</label><br>
    
        <input type="radio" name="c5183424-b293-11f0-94a2-6298cf1a5790" id="c5183424-b293-11f0-94a2-6298cf1a5790-2" onclick="clear_selection('c5183424-b293-11f0-94a2-6298cf1a5790')">
        <label id="c5183424-b293-11f0-94a2-6298cf1a5790-2-label" for="c5183424-b293-11f0-94a2-6298cf1a5790-2">No</label><br>
    
    </div>
    </p>
    <input id="c5183424-b293-11f0-94a2-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('c5183424-b293-11f0-94a2-6298cf1a5790', 2, 0, 'int(&quot;Y&quot; in &quot;Yes&quot;)')">
    <span class="quiz_hint" id="c5183424-b293-11f0-94a2-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
<p>This is indeed something a test generator or program verifier might be able to find with <em>zero</em> effort.</p>
</section>
<section id="partial-checks">
<h3>Partial Checks<a class="headerlink" href="#partial-checks" title="Link to this heading">#</a></h3>
<p>In the case of <code class="docutils literal notranslate"><span class="pre">square_root()</span></code>, our postcondition is <em>total</em> – if it passes, then the result is correct (within the <code class="docutils literal notranslate"><span class="pre">epsilon</span></code> boundaries, that is). In practice, however, it is not always easy to provide such a total check. As an example, consider our <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code> function from the <a class="reference internal" href="Intro_Debugging.html"><span class="std std-doc">Introduction to Debugging</span></a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">remove_html_markup</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">quote</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;&lt;&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">quote</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;&gt;&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">quote</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;&quot;&#39;</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;&#39;&quot;</span> <span class="ow">and</span> <span class="n">tag</span><span class="p">:</span>
            <span class="n">quote</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">quote</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">tag</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">out</span> <span class="o">+</span> <span class="n">c</span>

    <span class="k">return</span> <span class="n">out</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">remove_html_markup</span><span class="p">(</span><span class="s2">&quot;I am a text with &lt;strong&gt;HTML markup&lt;/strong&gt;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;I am a text with HTML markup&#39;
</pre></div>
</div>
</div>
</div>
<p>The precondition for <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code> is trivial – it accepts any string. (Strictly speaking, a precondition <code class="docutils literal notranslate"><span class="pre">assert</span> <span class="pre">isinstance(s,</span> <span class="pre">str)</span></code> could prevent it from being called with some other collection such as a list.)</p>
<p>The challenge, however, is the <em>postcondition</em>. How do we check that <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code> produces the correct result?</p>
<ul class="simple">
<li><p>We could check it against some other implementation that removes HTML markup – but if we already do have such a “golden” implementation, why bother implementing it again?</p></li>
<li><p>After a change, we could also check it against some earlier version to prevent <em>regression</em> – that is, losing functionality that was there before. But how would we know the earlier version was correct? (And if it was, why change it?)</p></li>
</ul>
<p>If we do not aim for ensuring full correctness, our postcondition can also check for <em>partial properties</em>. For instance, a postcondition for <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code> may simply ensure that the result no longer contains any markup:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">remove_html_markup</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">quote</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;&lt;&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">quote</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;&gt;&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">quote</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;&quot;&#39;</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;&#39;&quot;</span> <span class="ow">and</span> <span class="n">tag</span><span class="p">:</span>
            <span class="n">quote</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">quote</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">tag</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">out</span> <span class="o">+</span> <span class="n">c</span>

    <span class="c1"># postcondition</span>
    <span class="k">assert</span> <span class="s1">&#39;&lt;&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out</span> <span class="ow">and</span> <span class="s1">&#39;&gt;&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out</span>

    <span class="k">return</span> <span class="n">out</span>
</pre></div>
</div>
</div>
</div>
<p>Besides doing a good job at checking results, the postcondition also does a good job in documenting what <code class="docutils literal notranslate"><span class="pre">remove_html_markup()</span></code> actually does.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">Which of these inputs causes the assertion to fail?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">
    
        <input type="radio" name="c51ad8d2-b293-11f0-94a2-6298cf1a5790" id="c51ad8d2-b293-11f0-94a2-6298cf1a5790-1" onclick="clear_selection('c51ad8d2-b293-11f0-94a2-6298cf1a5790')">
        <label id="c51ad8d2-b293-11f0-94a2-6298cf1a5790-1-label" for="c51ad8d2-b293-11f0-94a2-6298cf1a5790-1"><code>&lt;foo&gt;bar&lt;/foo&gt;</code></label><br>
    
        <input type="radio" name="c51ad8d2-b293-11f0-94a2-6298cf1a5790" id="c51ad8d2-b293-11f0-94a2-6298cf1a5790-2" onclick="clear_selection('c51ad8d2-b293-11f0-94a2-6298cf1a5790')">
        <label id="c51ad8d2-b293-11f0-94a2-6298cf1a5790-2-label" for="c51ad8d2-b293-11f0-94a2-6298cf1a5790-2"><code>"foo"</code></label><br>
    
        <input type="radio" name="c51ad8d2-b293-11f0-94a2-6298cf1a5790" id="c51ad8d2-b293-11f0-94a2-6298cf1a5790-3" onclick="clear_selection('c51ad8d2-b293-11f0-94a2-6298cf1a5790')">
        <label id="c51ad8d2-b293-11f0-94a2-6298cf1a5790-3-label" for="c51ad8d2-b293-11f0-94a2-6298cf1a5790-3"><code>&gt;foo&lt;</code></label><br>
    
        <input type="radio" name="c51ad8d2-b293-11f0-94a2-6298cf1a5790" id="c51ad8d2-b293-11f0-94a2-6298cf1a5790-4" onclick="clear_selection('c51ad8d2-b293-11f0-94a2-6298cf1a5790')">
        <label id="c51ad8d2-b293-11f0-94a2-6298cf1a5790-4-label" for="c51ad8d2-b293-11f0-94a2-6298cf1a5790-4"><code>"x &gt; y"</code></label><br>
    
    </div>
    </p>
    <input id="c51ad8d2-b293-11f0-94a2-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('c51ad8d2-b293-11f0-94a2-6298cf1a5790', 16, 0, '1 + 1 -(-1) + (1 * -1) + 1 ** (1 - 1) + 1')">
    <span class="quiz_hint" id="c51ad8d2-b293-11f0-94a2-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
<p>Indeed. Our (partial) assertion does <em>not</em> detect this error:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&quot;foo&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;foo&#39;
</pre></div>
</div>
</div>
</div>
<p>But it detects this one:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">remove_html_markup</span><span class="p">(</span><span class="s1">&#39;&quot;x &gt; y&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/1913183346.py&quot;, line 2, in &lt;module&gt;
    remove_html_markup(&#39;&quot;x &gt; y&quot;&#39;)
    ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/2717035104.py&quot;, line 17, in remove_html_markup
    assert &#39;&lt;&#39; not in out and &#39;&gt;&#39; not in out
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError (expected)
</pre></div>
</div>
</div>
</div>
</section>
<section id="assertions-and-documentation">
<h3>Assertions and Documentation<a class="headerlink" href="#assertions-and-documentation" title="Link to this heading">#</a></h3>
<p>In contrast to “standard” documentation such as</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">square_root()</span></code> expects a non-negative number <code class="docutils literal notranslate"><span class="pre">x</span></code>; its result is <span class="math notranslate nohighlight">\(\sqrt{x}\)</span>.</p>
</div></blockquote>
<p>assertions have a big advantage: They are <em>formal</em> – and thus have an unambiguous semantics. Notably, we can understand what a function does <em>uniquely by reading its pre- and postconditions</em>. Here is an example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">some_obscure_function</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
    <span class="k">assert</span> <span class="n">x</span> <span class="o">==</span> <span class="n">y</span> <span class="o">==</span> <span class="n">z</span> <span class="ow">or</span> <span class="n">result</span> <span class="o">&gt;</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">x</span> <span class="o">==</span> <span class="n">y</span> <span class="o">==</span> <span class="n">z</span> <span class="ow">or</span> <span class="n">result</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">What does this function do?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">
    
        <input type="radio" name="c51d3122-b293-11f0-94a2-6298cf1a5790" id="c51d3122-b293-11f0-94a2-6298cf1a5790-1" onclick="clear_selection('c51d3122-b293-11f0-94a2-6298cf1a5790')">
        <label id="c51d3122-b293-11f0-94a2-6298cf1a5790-1-label" for="c51d3122-b293-11f0-94a2-6298cf1a5790-1">It returns the minimum value out of <code>x</code>, <code>y</code>, <code>z</code></label><br>
    
        <input type="radio" name="c51d3122-b293-11f0-94a2-6298cf1a5790" id="c51d3122-b293-11f0-94a2-6298cf1a5790-2" onclick="clear_selection('c51d3122-b293-11f0-94a2-6298cf1a5790')">
        <label id="c51d3122-b293-11f0-94a2-6298cf1a5790-2-label" for="c51d3122-b293-11f0-94a2-6298cf1a5790-2">It returns the middle value out of <code>x</code>, <code>y</code>, <code>z</code></label><br>
    
        <input type="radio" name="c51d3122-b293-11f0-94a2-6298cf1a5790" id="c51d3122-b293-11f0-94a2-6298cf1a5790-3" onclick="clear_selection('c51d3122-b293-11f0-94a2-6298cf1a5790')">
        <label id="c51d3122-b293-11f0-94a2-6298cf1a5790-3-label" for="c51d3122-b293-11f0-94a2-6298cf1a5790-3">It returns the maximum value out of <code>x</code>, <code>y</code>, <code>z</code></label><br>
    
    </div>
    </p>
    <input id="c51d3122-b293-11f0-94a2-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('c51d3122-b293-11f0-94a2-6298cf1a5790', 4, 0, 'int(0.5 ** math.cos(math.pi))')">
    <span class="quiz_hint" id="c51d3122-b293-11f0-94a2-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
<p>Indeed, this would be a useful (and bug-revealing!) postcondition for one of our showcase functions in the <a class="reference internal" href="StatisticalDebugger.html"><span class="std std-doc">chapter on statistical debugging</span></a>.</p>
</section>
<section id="using-assertions-to-trivially-locate-defects">
<h3>Using Assertions to Trivially Locate Defects<a class="headerlink" href="#using-assertions-to-trivially-locate-defects" title="Link to this heading">#</a></h3>
<p>The final benefit of assertions, and possibly even the most important in the context of this book, is <em>how much assertions help</em> with locating defects.
Indeed, with proper assertions, it is almost trivial to locate the one function that is responsible for a failure.</p>
<p>Consider the following situation. Assume I have</p>
<ul class="simple">
<li><p>a function <code class="docutils literal notranslate"><span class="pre">f()</span></code> whose precondition is satisfied, calling</p></li>
<li><p>a function <code class="docutils literal notranslate"><span class="pre">g()</span></code> whose precondition is violated and raises an exception.</p></li>
</ul>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">Which function is faulty here?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">
    
        <input type="radio" name="c51de644-b293-11f0-94a2-6298cf1a5790" id="c51de644-b293-11f0-94a2-6298cf1a5790-1" onclick="clear_selection('c51de644-b293-11f0-94a2-6298cf1a5790')">
        <label id="c51de644-b293-11f0-94a2-6298cf1a5790-1-label" for="c51de644-b293-11f0-94a2-6298cf1a5790-1"><code>g()</code> because it raises an exception</label><br>
    
        <input type="radio" name="c51de644-b293-11f0-94a2-6298cf1a5790" id="c51de644-b293-11f0-94a2-6298cf1a5790-2" onclick="clear_selection('c51de644-b293-11f0-94a2-6298cf1a5790')">
        <label id="c51de644-b293-11f0-94a2-6298cf1a5790-2-label" for="c51de644-b293-11f0-94a2-6298cf1a5790-2"><code>f()</code> because it violates the precondition of <code>g()</code></label><br>
    
        <input type="radio" name="c51de644-b293-11f0-94a2-6298cf1a5790" id="c51de644-b293-11f0-94a2-6298cf1a5790-3" onclick="clear_selection('c51de644-b293-11f0-94a2-6298cf1a5790')">
        <label id="c51de644-b293-11f0-94a2-6298cf1a5790-3-label" for="c51de644-b293-11f0-94a2-6298cf1a5790-3">Both <code>f()</code> and <code>g()</code> because they are incompatible</label><br>
    
        <input type="radio" name="c51de644-b293-11f0-94a2-6298cf1a5790" id="c51de644-b293-11f0-94a2-6298cf1a5790-4" onclick="clear_selection('c51de644-b293-11f0-94a2-6298cf1a5790')">
        <label id="c51de644-b293-11f0-94a2-6298cf1a5790-4-label" for="c51de644-b293-11f0-94a2-6298cf1a5790-4">None of the above</label><br>
    
    </div>
    </p>
    <input id="c51de644-b293-11f0-94a2-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('c51de644-b293-11f0-94a2-6298cf1a5790', 4, 0, 'math.factorial(int(math.tau / math.pi))')">
    <span class="quiz_hint" id="c51de644-b293-11f0-94a2-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
<p>The rule is very simple: If some function <code class="docutils literal notranslate"><span class="pre">func()</span></code> is called with its preconditions satisfied, and the postcondition of <code class="docutils literal notranslate"><span class="pre">func()</span></code> fail, then the fault in the program state must have originated at some point between these two events. Assuming that all functions called by <code class="docutils literal notranslate"><span class="pre">func()</span></code> also are correct (because their postconditions held), the defect <em>can only be in the code of <code class="docutils literal notranslate"><span class="pre">func()</span></code>.</em></p>
<p>What pre- and postconditions imply is actually often called a <em>contract</em> between caller and callee:</p>
<ul class="simple">
<li><p>The caller promises to satisfy the <em>precondition</em> of the callee,
whereas</p></li>
<li><p>the callee promises to satisfy its own <em>postcondition</em>, delivering a correct result.</p></li>
</ul>
<p>In the above setting, <code class="docutils literal notranslate"><span class="pre">f()</span></code> is the caller, and <code class="docutils literal notranslate"><span class="pre">g()</span></code> is the callee; but as <code class="docutils literal notranslate"><span class="pre">f()</span></code> violates the precondition of <code class="docutils literal notranslate"><span class="pre">g()</span></code>, it has not kept its promises. Hence, <code class="docutils literal notranslate"><span class="pre">f()</span></code> violates the contract and is at fault. <code class="docutils literal notranslate"><span class="pre">f()</span></code> thus  needs to be fixed.</p>
</section>
</section>
<section id="checking-data-structures">
<h2>Checking Data Structures<a class="headerlink" href="#checking-data-structures" title="Link to this heading">#</a></h2>
<p>Let us get back to debugging.  In debugging, assertions serve two purposes:</p>
<ul class="simple">
<li><p>They immediately detect bugs (if they fail)</p></li>
<li><p>They immediately rule out <em>specific parts of code and state</em> (if they pass)</p></li>
</ul>
<p>This latter part is particularly interesting, as it allows us to focus our search on the lesser checked aspects of code and state.</p>
<p>When we say “code <em>and</em> state”, what do we mean? Actually, assertions can not quickly check several executions of a function, but also <em>large amounts of data</em>, detecting faults in data <em>at the moment they are introduced</em>.</p>
<section id="times-and-time-bombs">
<h3>Times and Time Bombs<a class="headerlink" href="#times-and-time-bombs" title="Link to this heading">#</a></h3>
<p>Let us illustrate this by an example.  Let’s assume we want a <code class="docutils literal notranslate"><span class="pre">Time</span></code> class that represents the time of day. Its constructor takes the current time using hours, minutes, and seconds. (Note that this is a deliberately simple example – real-world classes for representing time are way more complex.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Time</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hours</span> <span class="o">=</span> <span class="n">hours</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_minutes</span> <span class="o">=</span> <span class="n">minutes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seconds</span> <span class="o">=</span> <span class="n">seconds</span>
</pre></div>
</div>
</div>
</div>
<p>To access the individual elements, we introduce a few getters:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Time</span><span class="p">(</span><span class="n">Time</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">hours</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hours</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">minutes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_minutes</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">seconds</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seconds</span>
</pre></div>
</div>
</div>
</div>
<p>We allow printing out time, using the <a class="reference external" href="https://en.wikipedia.org/wiki/ISO_8601">ISO 8601 format</a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Time</span><span class="p">(</span><span class="n">Time</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hours</span><span class="p">()</span><span class="si">:</span><span class="s2">02</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">minutes</span><span class="p">()</span><span class="si">:</span><span class="s2">02</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">seconds</span><span class="p">()</span><span class="si">:</span><span class="s2">02</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>Three minutes to midnight can thus be represented as</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">t</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>23:57:00
</pre></div>
</div>
</div>
</div>
<p>Unfortunately, there’s nothing in our <code class="docutils literal notranslate"><span class="pre">Time</span></code> class that prevents blatant misuse.  We can easily set up a time with negative numbers, for instance:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">t</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-1:00:00
</pre></div>
</div>
</div>
</div>
<p>Such a thing <em>may</em> have some semantics (relative time, maybe?), but it’s not exactly conforming to ISO format.</p>
<p>Even worse, we can even <em>construct</em> a <code class="docutils literal notranslate"><span class="pre">Time</span></code> object with strings as numbers.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="s2">&quot;High noon&quot;</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
</div>
<p>and this will be included verbatim the moment we try to print it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>  <span class="c1"># This fails in Python 3.9</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>High noon:00:00
</pre></div>
</div>
</div>
</div>
<p>For now, everything will be fine - but what happens when some other program tries to parse this time? Or processes a log file with a timestamp like this?</p>
<p>In fact, what we have here is a <em>time bomb</em> – a fault in the program state that can sleep for ages until someone steps on it. These are hard to debug, because one has to figure out when the time bomb was set – which can be thousands or millions of lines earlier in the program. Since in the absence of type checking, <em>any</em> assignment to a <code class="docutils literal notranslate"><span class="pre">Time</span></code> object could be the culprit – so good luck with the search.</p>
<p>This is again where assertions save the day. What you need is an <em>assertion that checks whether the data is correct</em>. For instance, we could revise our constructor such that it checks for correct arguments:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Time</span><span class="p">(</span><span class="n">Time</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">hours</span> <span class="o">&lt;=</span> <span class="mi">23</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">minutes</span> <span class="o">&lt;=</span> <span class="mi">59</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">seconds</span> <span class="o">&lt;=</span> <span class="mi">60</span>  <span class="c1"># Includes leap seconds (ISO8601)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_hours</span> <span class="o">=</span> <span class="n">hours</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_minutes</span> <span class="o">=</span> <span class="n">minutes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seconds</span> <span class="o">=</span> <span class="n">seconds</span>
</pre></div>
</div>
</div>
</div>
<p>These conditions check whether <code class="docutils literal notranslate"><span class="pre">hours</span></code>, <code class="docutils literal notranslate"><span class="pre">minutes</span></code>, and <code class="docutils literal notranslate"><span class="pre">seconds</span></code> are within the right range. They are called <em>data invariants</em> (or short <em>invariants</em>) because they hold for the given data (notably, the internal attributes) at all times.</p>
<p>Note the unusual syntax for range checks (this is a Python special), and the fact that seconds can range from 0 to 60.  That’s because there’s not only leap years, but also leap seconds.</p>
<p>With this revised constructor, we now get errors as soon as we pass an invalid parameter:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="o">-</span><span class="mi">23</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/283236387.py&quot;, line 2, in &lt;module&gt;
    t = Time(-23, 0, 0)
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/559831374.py&quot;, line 3, in __init__
    assert 0 &lt;= hours &lt;= 23
           ^^^^^^^^^^^^^^^^
AssertionError (expected)
</pre></div>
</div>
</div>
</div>
<p>Hence, <em>any</em> attempt to set <em>any</em> Time object to an illegal state will be immediately detected. In other words, the time bomb defuses itself at the moment it is being set.</p>
<p>This means that when we are debugging, and search for potential faults in the state that could have caused the current failure, we can now rule out <code class="docutils literal notranslate"><span class="pre">Time</span></code> as a culprit, allowing us to focus on other parts of the state.</p>
<p>The more of the state we have checked with invariants,</p>
<ul class="simple">
<li><p>the less state we have to examine,</p></li>
<li><p>the fewer possible causes we have to investigate,</p></li>
<li><p>the faster we are done with determining the defect.</p></li>
</ul>
</section>
<section id="invariant-checkers">
<h3>Invariant Checkers<a class="headerlink" href="#invariant-checkers" title="Link to this heading">#</a></h3>
<p>For invariants to be effective, they have to be checked at all times. If we introduce a method that changes the state, then this method will also have to ensure that the invariant is satisfied:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Time</span><span class="p">(</span><span class="n">Time</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_hours</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hours</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">hours</span> <span class="o">&lt;=</span> <span class="mi">23</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hours</span> <span class="o">=</span> <span class="n">hours</span>
</pre></div>
</div>
</div>
</div>
<p>This also implies that state changes should go through methods, not direct accesses to attributes. If some code changes the attributes of your object directly, without going through the method that could check for consistency, then it will be much harder for you to a) detect the source of the problem and b) even detect that a problem exists.</p>
<section id="excursion-checked-getters-and-setters-in-python">
<h4>Excursion: Checked Getters and Setters in Python<a class="headerlink" href="#excursion-checked-getters-and-setters-in-python" title="Link to this heading">#</a></h4>
<p>In Python, the <code class="docutils literal notranslate"><span class="pre">&#64;property</span></code> decorator offers a handy way to implement checkers, even for otherwise direct accesses to attributes. It allows defining specific “getter” and “setter” functions for individual properties that would even be invoked when a (seemingly) attribute is accessed.</p>
<p>Using <code class="docutils literal notranslate"><span class="pre">&#64;property</span></code>, our <code class="docutils literal notranslate"><span class="pre">Time</span></code> class could look like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyTime</span><span class="p">(</span><span class="n">Time</span><span class="p">):</span>
    <span class="nd">@property</span>  <span class="c1"># type: ignore</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">hours</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hours</span>

    <span class="nd">@hours</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">hours</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_hours</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">new_hours</span> <span class="o">&lt;=</span> <span class="mi">23</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hours</span> <span class="o">=</span> <span class="n">new_hours</span>
</pre></div>
</div>
</div>
</div>
<p>To access the current hour, we no longer go through a specific “getter” function; instead, we access a synthesized attribute that – behind the scenes – invokes the “getter” function marked with <code class="docutils literal notranslate"><span class="pre">&#64;property</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_time</span> <span class="o">=</span> <span class="n">MyTime</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">my_time</span><span class="o">.</span><span class="n">hours</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>11
</pre></div>
</div>
</div>
</div>
<p>If we “assign” to the attribute, the “setter” function is called in the background;</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_time</span><span class="o">.</span><span class="n">hours</span> <span class="o">=</span> <span class="mi">12</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
</div>
<p>We see this immediately when trying to assign an illegal value:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">my_time</span><span class="o">.</span><span class="n">hours</span> <span class="o">=</span> <span class="mi">25</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/91299477.py&quot;, line 2, in &lt;module&gt;
    my_time.hours = 25  # type: ignore
    ^^^^^^^^^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/2658705698.py&quot;, line 8, in hours
    assert 0 &lt;= new_hours &lt;= 23
           ^^^^^^^^^^^^^^^^^^^^
AssertionError (expected)
</pre></div>
</div>
</div>
</div>
<p>If you build large infrastructures in Python, you can use these features to implement</p>
<ul class="simple">
<li><p>attributes that are <em>checked</em> every time they are accessed or changed;</p></li>
<li><p>attributes that are easier to remember than a large slew of getter and setter functions.</p></li>
</ul>
<p>In this book, we do not have that many attributes, and we try to use not too many Python-specific features, so we usually go without <code class="docutils literal notranslate"><span class="pre">&#64;property</span></code>. But for Python aficionados, and especially those who care about runtime checks, checked property accesses are a boon.</p>
</section>
<section id="end-of-excursion">
<h4>End of Excursion<a class="headerlink" href="#end-of-excursion" title="Link to this heading">#</a></h4>
<p>If we have several methods that can alter an object, it can be helpful to factor out invariant checking into its own method. Such a method can also be called to check for inconsistencies that might have been introduced without going through one of the methods – e.g. by direct object access, memory manipulation, or memory corruption.</p>
<p>By convention, methods that check invariants have the name <code class="docutils literal notranslate"><span class="pre">repOK()</span></code>, since they check whether the internal representation is okay, and return True if so.</p>
<p>Here’s a <code class="docutils literal notranslate"><span class="pre">repOK()</span></code> method for <code class="docutils literal notranslate"><span class="pre">Time</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Time</span><span class="p">(</span><span class="n">Time</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">repOK</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hours</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">23</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minutes</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">59</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seconds</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">60</span>
        <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
</div>
<p>We can integrate this method right into our constructor and our setter:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Time</span><span class="p">(</span><span class="n">Time</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hours</span> <span class="o">=</span> <span class="n">hours</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_minutes</span> <span class="o">=</span> <span class="n">minutes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seconds</span> <span class="o">=</span> <span class="n">seconds</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">repOK</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_hours</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hours</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hours</span> <span class="o">=</span> <span class="n">hours</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">repOK</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="o">-</span><span class="mi">23</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/283236387.py&quot;, line 2, in &lt;module&gt;
    t = Time(-23, 0, 0)
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/346828762.py&quot;, line 6, in __init__
    assert self.repOK()
           ~~~~~~~~~~^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/478898990.py&quot;, line 3, in repOK
    assert 0 &lt;= self.hours() &lt;= 23
           ^^^^^^^^^^^^^^^^^^^^^^^
AssertionError (expected)
</pre></div>
</div>
</div>
</div>
<p>Having a single method that checks everything can be beneficial, as it may explicitly check for more faulty states. For instance, it is still permissible to pass a floating-point number for hours and minutes, again breaking the Time representation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Time</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.5:00:00
</pre></div>
</div>
</div>
</div>
<p>(Strictly speaking, ISO 8601 <em>does</em> allow fractional parts for seconds and even for hours and minutes – but still wants two leading digits before the fraction separator. Plus, the comma is the “preferred” fraction separator. In short, you won’t be making too many friends using times formatted like the one above.)</p>
<p>We can extend our <code class="docutils literal notranslate"><span class="pre">repOK()</span></code> method to check for correct types, too.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Time</span><span class="p">(</span><span class="n">Time</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">repOK</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hours</span><span class="p">(),</span> <span class="nb">int</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minutes</span><span class="p">(),</span> <span class="nb">int</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seconds</span><span class="p">(),</span> <span class="nb">int</span><span class="p">)</span>

        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hours</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">23</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minutes</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">59</span>
        <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seconds</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">60</span>
        <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Time</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>14:00:00
</pre></div>
</div>
</div>
</div>
<p>This now also catches other type errors:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="s2">&quot;After midnight&quot;</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/119323666.py&quot;, line 2, in &lt;module&gt;
    t = Time(&quot;After midnight&quot;)  # type: ignore
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/346828762.py&quot;, line 6, in __init__
    assert self.repOK()
           ~~~~~~~~~~^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/1587012707.py&quot;, line 3, in repOK
    assert isinstance(self.hours(), int)
           ~~~~~~~~~~^^^^^^^^^^^^^^^^^^^
AssertionError (expected)
</pre></div>
</div>
</div>
</div>
<p>Our <code class="docutils literal notranslate"><span class="pre">repOK()</span></code> method can also be used in combination with pre- and postconditions. Typically, you’d like to make it part of the pre- and postcondition checks.</p>
<p>Assume you want to implement an <code class="docutils literal notranslate"><span class="pre">advance()</span></code> method that adds a number of seconds to the current time. The preconditions and postconditions can be easily defined:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Time</span><span class="p">(</span><span class="n">Time</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">seconds_since_midnight</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hours</span><span class="p">()</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">minutes</span><span class="p">()</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">seconds</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">advance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seconds_offset</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">old_seconds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seconds_since_midnight</span><span class="p">()</span>

        <span class="o">...</span>  <span class="c1"># Advance the clock</span>

        <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seconds_since_midnight</span><span class="p">()</span> <span class="o">==</span>
                <span class="p">(</span><span class="n">old_seconds</span> <span class="o">+</span> <span class="n">seconds_offset</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>But you’d really like <code class="docutils literal notranslate"><span class="pre">advance()</span></code> to check the state before <em>and</em> after its execution – again using <code class="docutils literal notranslate"><span class="pre">repOK()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">BetterTime</span><span class="p">(</span><span class="n">Time</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">advance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seconds_offset</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">repOK</span><span class="p">()</span>
        <span class="n">old_seconds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seconds_since_midnight</span><span class="p">()</span>

        <span class="o">...</span>  <span class="c1"># Advance the clock</span>

        <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seconds_since_midnight</span><span class="p">()</span> <span class="o">==</span>
                <span class="p">(</span><span class="n">old_seconds</span> <span class="o">+</span> <span class="n">seconds_offset</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">))</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">repOK</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The first postcondition ensures that <code class="docutils literal notranslate"><span class="pre">advance()</span></code> produces the desired result; the second one ensures that the internal state is still okay.</p>
</section>
</section>
<section id="large-data-structures">
<h3>Large Data Structures<a class="headerlink" href="#large-data-structures" title="Link to this heading">#</a></h3>
<p>Invariants are especially useful if you have a large, complex data structure which is very hard to track in a conventional debugger.</p>
<p>Let’s assume you have a <a class="reference external" href="https://en.wikipedia.org/wiki/Red%E2%80%93black_tree">red-black search tree</a> for storing and searching data.  Red-black trees are among the most efficient data structures for representing associative arrays (also known as mappings); they are self-balancing and guarantee search, insertion, and deletion in logarithmic time. They also are among the most ugly to debug.</p>
<p>What is a red-black tree? Here is an example from Wikipedia:</p>
<p><img alt="Red-Black Tree" src="https://upload.wikimedia.org/wikipedia/commons/6/66/Red-black_tree_example.svg" /></p>
<p>As you can see, there are red nodes and black nodes (giving the tree its name). We can define a class <code class="docutils literal notranslate"><span class="pre">RedBlackTrees</span></code> and implement all the necessary operations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">RedBlackTree</span><span class="p">:</span>
    <span class="n">RED</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>
    <span class="n">BLACK</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span>
    <span class="o">...</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell tag_remove-input docutils container">
</div>
<p>However, before we start coding, it would be a good idea to <em>first</em> reason about the invariants of a red-black tree. Indeed, a red-black tree has a number of important properties that hold at all times – for instance, that the root node be black or that the tree be balanced. When we implement a red-black tree, these <em>invariants</em> can be encoded into a <code class="docutils literal notranslate"><span class="pre">repOK()</span></code> method:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">RedBlackTree</span><span class="p">(</span><span class="n">RedBlackTree</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">repOK</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootHasNoParent</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootIsBlack</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">redNodesHaveOnlyBlackChildren</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">equalNumberOfBlackNodesOnSubtrees</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">treeIsAcyclic</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentsAreConsistent</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
</div>
<p>Each of these helper methods are checkers in their own right:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">RedBlackTree</span><span class="p">(</span><span class="n">RedBlackTree</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">rootHasNoParent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rootIsBlack</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="o">.</span><span class="n">color</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">BLACK</span>
    <span class="o">...</span>
</pre></div>
</div>
</div>
</div>
<p>With all these helpers, our <code class="docutils literal notranslate"><span class="pre">repOK()</span></code> method will become very rigorous – but all this rigor is very much needed. Just for fun, check out the <a class="reference external" href="https://en.wikipedia.org/wiki/Red%E2%80%93black_tree">description of red-black trees on Wikipedia</a>. The description of how insertion or deletion work is 4 to 5 pages long (each!), with dozens of special cases that all have to be handled properly. If you ever face the task of implementing such a data structure, be sure to (1) write a <code class="docutils literal notranslate"><span class="pre">repOK()</span></code> method such as the above, and (2) call it before and after each method that alters the tree:</p>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">RedBlackTree</span><span class="p">(</span><span class="n">RedBlackTree</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">repOK</span><span class="p">()</span>
        <span class="o">...</span>  <span class="c1"># four pages of code</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">repOK</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">repOK</span><span class="p">()</span>
        <span class="o">...</span>  <span class="c1"># five pages of code</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">repOK</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Such checks will make your tree run much slower – essentially, instead of logarithmic time complexity, we now have linear time complexity, as the entire tree is traversed with each change – but you will find any bugs much, much faster. Once your tree goes in production, you can deactivate <code class="docutils literal notranslate"><span class="pre">repOK()</span></code> by default, using some debugging switch to turn it on again should the need ever arise:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">RedBlackTree</span><span class="p">(</span><span class="n">RedBlackTree</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkRepOK</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="o">...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkRepOK</span> <span class="o">=</span> <span class="n">checkRepOK</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">repOK</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkRepOK</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootHasNoParent</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootIsBlack</span><span class="p">()</span>
        <span class="o">...</span>
        <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
</div>
<p>Just don’t delete it – future maintainers of your code will be forever grateful that you have documented your assumptions and given them a means to quickly check their code.</p>
</section>
</section>
<section id="system-invariants">
<h2>System Invariants<a class="headerlink" href="#system-invariants" title="Link to this heading">#</a></h2>
<p>When interacting with the operating system, there are a number of rules that programs must follow, lest they get themselves (or the system) in some state where they cannot execute properly anymore.</p>
<ul class="simple">
<li><p>If you work with files, every file that you open also must be closed; otherwise, you will deplete resources.</p></li>
<li><p>If you create temporary files, be sure to delete them after use; otherwise, you will consume disk space.</p></li>
<li><p>If you work with locks, be sure to release locks after use; otherwise, your system may end up in a deadlock.</p></li>
</ul>
<p>One area in which it is particularly easy to make mistakes is <em>memory usage</em>. In Python, memory is maintained by the Python interpreter, and all memory accesses are checked at runtime. Accessing a non-existing element of a string, for instance, will raise a memory error:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="s2">&quot;foo&quot;</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/295675708.py&quot;, line 3, in &lt;module&gt;
    &quot;foo&quot;[index]
    ~~~~~^^^^^^^
IndexError: string index out of range (expected)
</pre></div>
</div>
</div>
</div>
<p>The very same expression in a C program, though, will yield <em>undefined behavior</em> – which means that anything can happen. Let us explore a couple of C programs with undefined behavior.</p>
<section id="the-c-memory-model">
<h3>The C Memory Model<a class="headerlink" href="#the-c-memory-model" title="Link to this heading">#</a></h3>
<p>We start with a simple C program which uses the same invalid index as our Python expression, above. What does this program do?</p>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;testoverflow.c&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>#include<span class=" -Color -Color-White"> </span>&lt;stdio.h&gt;

//<span class=" -Color -Color-White"> </span>Access<span class=" -Color -Color-White"> </span>memory<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">out</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">of</span><span class=" -Color -Color-White"> </span>bounds
<span class=" -Color -Color-Green">int</span><span class=" -Color -Color-White"> </span>main(<span class=" -Color -Color-Green">int</span><span class=" -Color -Color-White"> </span>argc,<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">char</span><span class=" -Color -Color-White"> </span>*argv[])<span class=" -Color -Color-White"> </span>{
<span class=" -Color -Color-White">    </span><span class=" -Color -Color-Green">int</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">index</span><span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">10</span>;
<span class=" -Color -Color-White">    </span><span class=" -Color -Color-Blue">return</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;foo&quot;</span>[index];<span class=" -Color -Color-White">  </span>//<span class=" -Color -Color-White"> </span>BOOM
}
</pre></div>
</div>
</div>
</div>
<p>In our example, the program will read from a random chunk or memory, which may exist or not. In most cases, nothing at all will happen – which is a bad thing, because you won’t realize that your program has a defect.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>cc<span class="w"> </span>-g<span class="w"> </span>-o<span class="w"> </span>testoverflow<span class="w"> </span>testoverflow.c
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>./testoverflow
</pre></div>
</div>
</div>
</div>
<p>To see what is going on behind the scenes, let us have a look at the C memory model.</p>
<section id="excursion-a-c-memory-model-simulator">
<h4>Excursion: A C Memory Model Simulator<a class="headerlink" href="#excursion-a-c-memory-model-simulator" title="Link to this heading">#</a></h4>
<p>We build a little simulation of C memory. A <code class="docutils literal notranslate"><span class="pre">Memory</span></code> item stands for a block of continuous memory, which we can access by address using <code class="docutils literal notranslate"><span class="pre">read()</span></code> and <code class="docutils literal notranslate"><span class="pre">write()</span></code>. The <code class="docutils literal notranslate"><span class="pre">__repr__()</span></code> method shows memory contents as a string.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Memory</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">)]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">address</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">address</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mem</span><span class="p">:</span> <span class="n">Memory</span> <span class="o">=</span> <span class="n">Memory</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mem</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[None, None, None, None, None, None, None, None, None, None]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mem</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mem</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;a&#39;, None, None, None, None, None, None, None, None, None]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mem</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;a&#39;
</pre></div>
</div>
</div>
</div>
<p>We introduce <code class="docutils literal notranslate"><span class="pre">[index]</span></code> syntax for easy read and write:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Memory</span><span class="p">(</span><span class="n">Memory</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mem_with_index</span><span class="p">:</span> <span class="n">Memory</span> <span class="o">=</span> <span class="n">Memory</span><span class="p">()</span>
<span class="n">mem_with_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mem_with_index</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[None, &#39;a&#39;, None, None, None, None, None, None, None, None]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mem_with_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;a&#39;
</pre></div>
</div>
</div>
</div>
<p>Here are some more advanced methods to show memory cntents. The <code class="docutils literal notranslate"><span class="pre">repr()</span></code> and <code class="docutils literal notranslate"><span class="pre">_repr_markdown_()</span></code> methods display memory as a table. In a notebook, we can simply evaluate the memory to see the table.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">Markdown</span><span class="p">,</span> <span class="n">HTML</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Memory</span><span class="p">(</span><span class="n">Memory</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">show_header</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;|Address|&quot;</span>
        <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">|&quot;</span>
        <span class="k">return</span> <span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">show_sep</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;|:---|&quot;</span>
        <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;:---|&quot;</span>
        <span class="k">return</span> <span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">show_contents</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;|Content|&quot;</span>
        <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">address</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">contents</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span><span class="si">}</span><span class="s2">|&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot; |&quot;</span>
        <span class="k">return</span> <span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_header</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_sep</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_contents</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_repr_markdown_</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mem_with_table</span><span class="p">:</span> <span class="n">Memory</span> <span class="o">=</span> <span class="n">Memory</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mem_with_table</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
    <span class="n">mem_with_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">i</span>
<span class="n">mem_with_table</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p>|Address|0|1|2|3|4|5|6|7|8|9|
|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|
|Content|0|10|20|30|40|50|60|70|80|90|</p>
</div>
</div>
</section>
<section id="id1">
<h4>End of Excursion<a class="headerlink" href="#id1" title="Link to this heading">#</a></h4>
<p>In C, memory comes as a single block of bytes at continuous addresses. Let us assume we have a memory of only 20 bytes (duh!) and the string “foo” is stored at address 5:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mem_with_table</span><span class="p">:</span> <span class="n">Memory</span> <span class="o">=</span> <span class="n">Memory</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="n">mem_with_table</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;f&#39;</span>
<span class="n">mem_with_table</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span>
<span class="n">mem_with_table</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span>
<span class="n">mem_with_table</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p>|Address|0|1|2|3|4|5|6|7|8|9|10|11|12|13|14|15|16|17|18|19|
|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|
|Content| | | | | |’f’|’o’|’o’| | | | | | | | | | | | |</p>
</div>
</div>
<p>When we try to access <code class="docutils literal notranslate"><span class="pre">&quot;foo&quot;[10]</span></code>, we try to read the memory location at address 15 – which may exist (or not), and which may have arbitrary contents, based on whatever previous instructions left there. From there on, the behavior of our program is undefined.</p>
<p>Such <em>buffer overflows</em> can also come as <em>writes</em> into memory locations – and thus overwrite the item that happens to be at the location of interest. If the item at address 15 happens to be, say, a flag controlling administrator access, then setting it to a non-zero value can come handy for an attacker.</p>
</section>
</section>
<section id="dynamic-memory">
<h3>Dynamic Memory<a class="headerlink" href="#dynamic-memory" title="Link to this heading">#</a></h3>
<p>A second source of errors in C programs is the use of dynamic memory – that is, memory allocated and deallocated at run-time. In C, the function <code class="docutils literal notranslate"><span class="pre">malloc()</span></code> returns a continuous block of memory of a given size; the function <code class="docutils literal notranslate"><span class="pre">free()</span></code> returns it back to the system.</p>
<p>After a block has been <code class="docutils literal notranslate"><span class="pre">free()</span></code>’d, it must no longer be used, as the memory might already be in use by some other function (or program!) again. Here’s a piece of code that violates this assumption:</p>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;testuseafterfree.c&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Cyan">#include</span><span class=" -Color -Color-White"> &lt;stdlib.h&gt;</span>

<span class=" -Color -Color-White">// Access a chunk of memory after it has been given back to the system</span>
<span class=" -Color -Color-Cyan">int</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">main</span>(<span class=" -Color -Color-Cyan">int</span><span class=" -Color -Color-White"> </span>argc,<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Cyan">char</span><span class=" -Color -Color-White"> </span>*argv[])<span class=" -Color -Color-White"> </span>{
<span class=" -Color -Color-White">    </span><span class=" -Color -Color-Cyan">int</span><span class=" -Color -Color-White"> </span>*array<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span>malloc(<span class=" -Color -Color-Blue">100</span><span class=" -Color -Color-White"> </span>*<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">sizeof</span>(<span class=" -Color -Color-Cyan">int</span>));
<span class=" -Color -Color-White">    </span>free(array);
<span class=" -Color -Color-White">    </span><span class=" -Color -Color-Blue">return</span><span class=" -Color -Color-White"> </span>array[<span class=" -Color -Color-Blue">10</span>];<span class=" -Color -Color-White">  // BOOM</span>
}
</pre></div>
</div>
</div>
</div>
<p>Again, if we compile and execute this program, nothing tells us that we have just entered undefined behavior:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>cc<span class="w"> </span>-g<span class="w"> </span>-o<span class="w"> </span>testuseafterfree<span class="w"> </span>testuseafterfree.c
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>./testuseafterfree
</pre></div>
</div>
</div>
</div>
<p>What’s going on behind the scenes here?</p>
<section id="excursion-dynamic-memory-in-c">
<h4>Excursion: Dynamic Memory in C<a class="headerlink" href="#excursion-dynamic-memory-in-c" title="Link to this heading">#</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">DynamicMemory</span></code> introduces dynamic memory allocation <code class="docutils literal notranslate"><span class="pre">allocate()</span></code> and deallocation <code class="docutils literal notranslate"><span class="pre">free()</span></code>, using a list of allocated blocks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DynamicMemory</span><span class="p">(</span><span class="n">Memory</span><span class="p">):</span>
    <span class="c1"># Address at which our list of blocks starts</span>
    <span class="n">BLOCK_LIST_START</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="c1"># Before each block, we reserve two items:</span>
        <span class="c1"># One pointing to the next block (-1 = END)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">BLOCK_LIST_START</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># One giving the length of the current block (&lt;0: freed)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">BLOCK_LIST_START</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Allocate a block of memory&quot;&quot;&quot;</span>
        <span class="c1"># traverse block list </span>
        <span class="c1"># until we find a free block of appropriate size</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BLOCK_LIST_START</span>

        <span class="k">while</span> <span class="n">chunk</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">next_chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">chunk</span><span class="p">]</span>
            <span class="n">chunk_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">chunk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">chunk_length</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">chunk_length</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">block_size</span><span class="p">:</span>
                <span class="c1"># Reuse this free block</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">chunk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">chunk_length</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">chunk</span> <span class="o">+</span> <span class="mi">2</span>

            <span class="k">if</span> <span class="n">next_chunk</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># End of list - allocate new block</span>
                <span class="n">next_chunk</span> <span class="o">=</span> <span class="n">chunk</span> <span class="o">+</span> <span class="n">block_size</span> <span class="o">+</span> <span class="mi">2</span>
                <span class="k">if</span> <span class="n">next_chunk</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">chunk</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_chunk</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">chunk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">block_size</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">next_chunk</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">next_chunk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">chunk</span> <span class="o">+</span> <span class="mi">2</span>
                <span class="k">return</span> <span class="n">base</span>

            <span class="c1"># Go to next block</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">next_chunk</span>

        <span class="k">raise</span> <span class="ne">MemoryError</span><span class="p">(</span><span class="s2">&quot;Out of Memory&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">free</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Free a block of memory&quot;&quot;&quot;</span>
        <span class="c1"># Mark block as available</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">base</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">chunk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">chunk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>In our table, we highlight free blocks in gray:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DynamicMemory</span><span class="p">(</span><span class="n">DynamicMemory</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">show_header</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;|Address|&quot;</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BLOCK_LIST_START</span>
        <span class="n">allocated</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># States and colors</span>
        <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">address</span> <span class="o">==</span> <span class="n">chunk</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span>
                <span class="n">next_chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">address</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">address</span> <span class="o">==</span> <span class="n">chunk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span>
                <span class="n">allocated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">address</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="n">next_chunk</span>
            <span class="k">elif</span> <span class="n">allocated</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;lightgrey&quot;</span>

            <span class="n">item</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&lt;span style=&quot;color: </span><span class="si">{</span><span class="n">color</span><span class="si">}</span><span class="s1">&quot;&gt;</span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s1">&lt;/span&gt;&#39;</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">|&quot;</span>
        <span class="k">return</span> <span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dynamic_mem</span><span class="p">:</span> <span class="n">DynamicMemory</span> <span class="o">=</span> <span class="n">DynamicMemory</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dynamic_mem</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p>|Address|<span style="color: blue">0</span>|<span style="color: blue">1</span>|<span style="color: lightgrey">2</span>|<span style="color: lightgrey">3</span>|<span style="color: lightgrey">4</span>|<span style="color: lightgrey">5</span>|<span style="color: lightgrey">6</span>|<span style="color: lightgrey">7</span>|<span style="color: lightgrey">8</span>|<span style="color: lightgrey">9</span>|
|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|
|Content|-1|0| | | | | | | | |</p>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dynamic_mem</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dynamic_mem</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p>|Address|<span style="color: blue">0</span>|<span style="color: blue">1</span>|<span style="color: black">2</span>|<span style="color: black">3</span>|<span style="color: blue">4</span>|<span style="color: blue">5</span>|<span style="color: lightgrey">6</span>|<span style="color: lightgrey">7</span>|<span style="color: lightgrey">8</span>|<span style="color: lightgrey">9</span>|
|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|
|Content|4|2| | |-1|0| | | | |</p>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dynamic_mem</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dynamic_mem</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p>|Address|<span style="color: blue">0</span>|<span style="color: blue">1</span>|<span style="color: black">2</span>|<span style="color: black">3</span>|<span style="color: blue">4</span>|<span style="color: blue">5</span>|<span style="color: black">6</span>|<span style="color: black">7</span>|<span style="color: blue">8</span>|<span style="color: blue">9</span>|
|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|
|Content|4|2| | |8|2| | |-1|0|</p>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dynamic_mem</span><span class="o">.</span><span class="n">free</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dynamic_mem</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p>|Address|<span style="color: blue">0</span>|<span style="color: blue">1</span>|<span style="color: lightgrey">2</span>|<span style="color: lightgrey">3</span>|<span style="color: blue">4</span>|<span style="color: blue">5</span>|<span style="color: black">6</span>|<span style="color: black">7</span>|<span style="color: blue">8</span>|<span style="color: blue">9</span>|
|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|
|Content|4|-2| | |8|2| | |-1|0|</p>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dynamic_mem</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dynamic_mem</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p>|Address|<span style="color: blue">0</span>|<span style="color: blue">1</span>|<span style="color: black">2</span>|<span style="color: black">3</span>|<span style="color: blue">4</span>|<span style="color: blue">5</span>|<span style="color: black">6</span>|<span style="color: black">7</span>|<span style="color: blue">8</span>|<span style="color: blue">9</span>|
|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|
|Content|4|2| | |8|2| | |-1|0|</p>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">dynamic_mem</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/381644293.py&quot;, line 2, in &lt;module&gt;
    dynamic_mem.allocate(1)
    ~~~~~~~~~~~~~~~~~~~~^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/2922652606.py&quot;, line 45, in allocate
    raise MemoryError(&quot;Out of Memory&quot;)
MemoryError: Out of Memory (expected)
</pre></div>
</div>
</div>
</div>
</section>
<section id="id2">
<h4>End of Excursion<a class="headerlink" href="#id2" title="Link to this heading">#</a></h4>
<p>Dynamic memory is allocated as part of our main memory. The following table shows unallocated memory in gray and allocated memory in black:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dynamic_mem</span><span class="p">:</span> <span class="n">DynamicMemory</span> <span class="o">=</span> <span class="n">DynamicMemory</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
<span class="n">dynamic_mem</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p>|Address|<span style="color: blue">0</span>|<span style="color: blue">1</span>|<span style="color: lightgrey">2</span>|<span style="color: lightgrey">3</span>|<span style="color: lightgrey">4</span>|<span style="color: lightgrey">5</span>|<span style="color: lightgrey">6</span>|<span style="color: lightgrey">7</span>|<span style="color: lightgrey">8</span>|<span style="color: lightgrey">9</span>|<span style="color: lightgrey">10</span>|<span style="color: lightgrey">11</span>|<span style="color: lightgrey">12</span>|
|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|
|Content|-1|0| | | | | | | | | | | |</p>
</div>
</div>
<p>The numbers already stored (-1 and 0) are part of our dynamic memory housekeeping (highlighted in blue); they stand for the next block of memory and the length of the current block, respectively.</p>
<p>Let us allocate a block of 3 bytes. Our (simulated) allocation mechanism places these at the first continuous block available:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p1</span> <span class="o">=</span> <span class="n">dynamic_mem</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">p1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2
</pre></div>
</div>
</div>
</div>
<p>We see that a block of 3 items is allocated at address 2. The two numbers before that address (5 and 3) indicate the beginning of the next block as well as the length of the current one.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dynamic_mem</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p>|Address|<span style="color: blue">0</span>|<span style="color: blue">1</span>|<span style="color: black">2</span>|<span style="color: black">3</span>|<span style="color: black">4</span>|<span style="color: blue">5</span>|<span style="color: blue">6</span>|<span style="color: lightgrey">7</span>|<span style="color: lightgrey">8</span>|<span style="color: lightgrey">9</span>|<span style="color: lightgrey">10</span>|<span style="color: lightgrey">11</span>|<span style="color: lightgrey">12</span>|
|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|
|Content|5|3| | | |-1|0| | | | | | |</p>
</div>
</div>
<p>Let us allocate some more.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p2</span> <span class="o">=</span> <span class="n">dynamic_mem</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">p2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7
</pre></div>
</div>
</div>
</div>
<p>We can make use of that memory:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dynamic_mem</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">123</span>
<span class="n">dynamic_mem</span><span class="p">[</span><span class="n">p2</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dynamic_mem</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p>|Address|<span style="color: blue">0</span>|<span style="color: blue">1</span>|<span style="color: black">2</span>|<span style="color: black">3</span>|<span style="color: black">4</span>|<span style="color: blue">5</span>|<span style="color: blue">6</span>|<span style="color: black">7</span>|<span style="color: black">8</span>|<span style="color: black">9</span>|<span style="color: black">10</span>|<span style="color: blue">11</span>|<span style="color: blue">12</span>|
|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|
|Content|5|3|123| | |11|4|’x’| | | |-1|0|</p>
</div>
</div>
<p>When we free memory, the block is marked as free by giving it a negative length:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dynamic_mem</span><span class="o">.</span><span class="n">free</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dynamic_mem</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p>|Address|<span style="color: blue">0</span>|<span style="color: blue">1</span>|<span style="color: lightgrey">2</span>|<span style="color: lightgrey">3</span>|<span style="color: lightgrey">4</span>|<span style="color: blue">5</span>|<span style="color: blue">6</span>|<span style="color: black">7</span>|<span style="color: black">8</span>|<span style="color: black">9</span>|<span style="color: black">10</span>|<span style="color: blue">11</span>|<span style="color: blue">12</span>|
|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|
|Content|5|-3|123| | |11|4|’x’| | | |-1|0|</p>
</div>
</div>
<p>Note that freeing memory does not clear memory; the item at <code class="docutils literal notranslate"><span class="pre">p1</span></code> is still there. And we can also still access it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dynamic_mem</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>123
</pre></div>
</div>
</div>
</div>
<p>But if, in the meantime, some other part of the program requests more memory and uses it…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p3</span> <span class="o">=</span> <span class="n">dynamic_mem</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">dynamic_mem</span><span class="p">[</span><span class="n">p3</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span>
<span class="n">dynamic_mem</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p>|Address|<span style="color: blue">0</span>|<span style="color: blue">1</span>|<span style="color: black">2</span>|<span style="color: black">3</span>|<span style="color: black">4</span>|<span style="color: blue">5</span>|<span style="color: blue">6</span>|<span style="color: black">7</span>|<span style="color: black">8</span>|<span style="color: black">9</span>|<span style="color: black">10</span>|<span style="color: blue">11</span>|<span style="color: blue">12</span>|
|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|
|Content|5|3|’y’| | |11|4|’x’| | | |-1|0|</p>
</div>
</div>
<p>… then the memory at <code class="docutils literal notranslate"><span class="pre">p1</span></code> may simply be overwritten.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dynamic_mem</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;y&#39;
</pre></div>
</div>
</div>
</div>
<p>An even worse effect comes into play if one accidentally overwrites the dynamic memory allocation information; this can easily corrupt the entire memory management. In our case, such corrupted memory can lead to an endless loop when trying to allocate more memory:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ExpectError</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExpectTimeout</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dynamic_mem</span><span class="p">[</span><span class="n">p3</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dynamic_mem</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p>|Address|<span style="color: blue">0</span>|<span style="color: blue">1</span>|<span style="color: black">2</span>|<span style="color: black">3</span>|<span style="color: black">4</span>|<span style="color: blue">5</span>|<span style="color: blue">6</span>|<span style="color: black">7</span>|<span style="color: black">8</span>|<span style="color: black">9</span>|<span style="color: black">10</span>|<span style="color: black">11</span>|<span style="color: black">12</span>|
|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|
|Content|5|3|’y’| | |0|4|’x’| | | |-1|0|</p>
</div>
</div>
<p>When <code class="docutils literal notranslate"><span class="pre">allocate()</span></code> traverses the list of blocks, it will enter an endless loop between the block starting at address 0 (pointing to the next block at 5) and the block at address 5 (pointing back to 0).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectTimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">dynamic_mem</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/2188947149.py&quot;, line 2, in &lt;module&gt;
    dynamic_mem.allocate(1)
    ~~~~~~~~~~~~~~~~~~~~^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/2922652606.py&quot;, line 20, in allocate
    while chunk &lt; self.size:
          ^^^^^^^^^^^^^^^^^
  File &quot;Timeout.ipynb&quot;, line 43, in timeout_handler
    raise TimeoutError()
TimeoutError (expected)
</pre></div>
</div>
</div>
</div>
<p>Real-world <code class="docutils literal notranslate"><span class="pre">malloc()</span></code> and <code class="docutils literal notranslate"><span class="pre">free()</span></code> implementations suffer from similar problems. As stated above: As soon as undefined behavior is reached, anything may happen.</p>
</section>
</section>
<section id="managed-memory">
<h3>Managed Memory<a class="headerlink" href="#managed-memory" title="Link to this heading">#</a></h3>
<p>The solution to all these problems is to <em>keep track of memory</em>, specifically</p>
<ul class="simple">
<li><p>which parts of memory have been <em>allocated</em>, and</p></li>
<li><p>which parts of memory have been <em>initialized</em>.</p></li>
</ul>
<p>To this end, we introduce two extra flags for each address:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">allocated</span></code> flag tells whether an address has been allocated; the <code class="docutils literal notranslate"><span class="pre">allocate()</span></code> method sets them, and <code class="docutils literal notranslate"><span class="pre">free()</span></code> clears them again.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">initialized</span></code> flag tells whether an address has been written to. This is cleared as part of <code class="docutils literal notranslate"><span class="pre">allocate()</span></code>.</p></li>
</ul>
<p>With these, we can run a number of checks:</p>
<ul class="simple">
<li><p>When <em>writing</em> into memory and <em>freeing</em> memory, we can check whether the address has been <em>allocated</em>; and</p></li>
<li><p>When <em>reading</em> from memory, we can check whether the address has been allocated and <em>initialized</em>.</p></li>
</ul>
<p>Both of these should effectively prevent memory errors.</p>
<section id="excursion-managed-memory">
<h4>Excursion: Managed Memory<a class="headerlink" href="#excursion-managed-memory" title="Link to this heading">#</a></h4>
<p>We create a simulation of managed memory. <code class="docutils literal notranslate"><span class="pre">ManagedMemory</span></code> keeps track of every address whether it is initialized and allocated.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ManagedMemory</span><span class="p">(</span><span class="n">DynamicMemory</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocated</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<p>This allows memory access functions to run a number of extra checks:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ManagedMemory</span><span class="p">(</span><span class="n">ManagedMemory</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocated</span><span class="p">[</span><span class="n">address</span><span class="p">],</span> \
            <span class="s2">&quot;Writing into unallocated memory&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">address</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span><span class="p">[</span><span class="n">address</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocated</span><span class="p">[</span><span class="n">address</span><span class="p">],</span> \
            <span class="s2">&quot;Reading from unallocated memory&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span><span class="p">[</span><span class="n">address</span><span class="p">],</span> \
            <span class="s2">&quot;Reading from uninitialized memory&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">address</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Dynamic memory functions are set up such that they keep track of these flags.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ManagedMemory</span><span class="p">(</span><span class="n">ManagedMemory</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">block_size</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">block_size</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allocated</span><span class="p">[</span><span class="n">base</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span><span class="p">[</span><span class="n">base</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">base</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">free</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocated</span><span class="p">[</span><span class="n">base</span><span class="p">],</span> \
            <span class="s2">&quot;Freeing memory that is already freed&quot;</span>
        <span class="n">block_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">base</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">block_size</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allocated</span><span class="p">[</span><span class="n">base</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span><span class="p">[</span><span class="n">base</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">free</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let us highlight these flags when printing out the table:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ManagedMemory</span><span class="p">(</span><span class="n">ManagedMemory</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">show_contents</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">show_allocated</span><span class="p">()</span> <span class="o">+</span> 
               <span class="bp">self</span><span class="o">.</span><span class="n">show_initialized</span><span class="p">()</span> <span class="o">+</span>
            <span class="n">DynamicMemory</span><span class="o">.</span><span class="n">show_contents</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">show_allocated</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;|Allocated|&quot;</span>
        <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocated</span><span class="p">[</span><span class="n">address</span><span class="p">]:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;Y|&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot; |&quot;</span>
        <span class="k">return</span> <span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">show_initialized</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;|Initialized|&quot;</span>
        <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span><span class="p">[</span><span class="n">address</span><span class="p">]:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;Y|&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot; |&quot;</span>
        <span class="k">return</span> <span class="n">out</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id3">
<h4>End of Excursion<a class="headerlink" href="#id3" title="Link to this heading">#</a></h4>
<p>Here comes a simple simulation of managed memory. After we create memory, all addresses are neither allocated nor initialized:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">managed_mem</span><span class="p">:</span> <span class="n">ManagedMemory</span> <span class="o">=</span> <span class="n">ManagedMemory</span><span class="p">()</span>
<span class="n">managed_mem</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p>|Address|<span style="color: blue">0</span>|<span style="color: blue">1</span>|<span style="color: lightgrey">2</span>|<span style="color: lightgrey">3</span>|<span style="color: lightgrey">4</span>|<span style="color: lightgrey">5</span>|<span style="color: lightgrey">6</span>|<span style="color: lightgrey">7</span>|<span style="color: lightgrey">8</span>|<span style="color: lightgrey">9</span>|
|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|
|Allocated| | | | | | | | | | |
|Initialized| | | | | | | | | | |
|Content|-1|0| | | | | | | | |</p>
</div>
</div>
<p>Let us allocate some elements. We see that the first three bytes are now marked as allocated:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">managed_mem</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">managed_mem</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p>|Address|<span style="color: blue">0</span>|<span style="color: blue">1</span>|<span style="color: black">2</span>|<span style="color: black">3</span>|<span style="color: black">4</span>|<span style="color: blue">5</span>|<span style="color: blue">6</span>|<span style="color: lightgrey">7</span>|<span style="color: lightgrey">8</span>|<span style="color: lightgrey">9</span>|
|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|
|Allocated| | |Y|Y|Y| | | | | |
|Initialized| | | | | | | | | | |
|Content|5|3| | | |-1|0| | | |</p>
</div>
</div>
<p>After writing into memory, the respective addresses are marked as “initialized”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">managed_mem</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">managed_mem</span><span class="p">[</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">managed_mem</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p>|Address|<span style="color: blue">0</span>|<span style="color: blue">1</span>|<span style="color: black">2</span>|<span style="color: black">3</span>|<span style="color: black">4</span>|<span style="color: blue">5</span>|<span style="color: blue">6</span>|<span style="color: lightgrey">7</span>|<span style="color: lightgrey">8</span>|<span style="color: lightgrey">9</span>|
|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|
|Allocated| | |Y|Y|Y| | | | | |
|Initialized| | |Y|Y| | | | | | |
|Content|5|3|10|20| |-1|0| | | |</p>
</div>
</div>
<p>Attempting to read uninitialized memory fails:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">managed_mem</span><span class="p">[</span><span class="n">p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/1363131886.py&quot;, line 2, in &lt;module&gt;
    x = managed_mem[p + 2]
        ~~~~~~~~~~~^^^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/2465984283.py&quot;, line 3, in __getitem__
    return self.read(address)
           ~~~~~~~~~^^^^^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/2898840933.py&quot;, line 11, in read
    assert self.initialized[address], \
           ~~~~~~~~~~~~~~~~^^^^^^^^^
AssertionError: Reading from uninitialized memory (expected)
</pre></div>
</div>
</div>
</div>
<p>When we free the block again, it is marked as not allocated:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">managed_mem</span><span class="o">.</span><span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="n">managed_mem</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p>|Address|<span style="color: blue">0</span>|<span style="color: blue">1</span>|<span style="color: lightgrey">2</span>|<span style="color: lightgrey">3</span>|<span style="color: lightgrey">4</span>|<span style="color: blue">5</span>|<span style="color: blue">6</span>|<span style="color: lightgrey">7</span>|<span style="color: lightgrey">8</span>|<span style="color: lightgrey">9</span>|
|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|:—|
|Allocated| | | | | | | | | | |
|Initialized| | | | | | | | | | |
|Content|5|-3|10|20| |-1|0| | | |</p>
</div>
</div>
<p>And accessing any element of the free’d block will yield an error:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">managed_mem</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/4208287712.py&quot;, line 2, in &lt;module&gt;
    managed_mem[p] = 10
    ~~~~~~~~~~~^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/2465984283.py&quot;, line 6, in __setitem__
    self.write(address, item)
    ~~~~~~~~~~^^^^^^^^^^^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/2898840933.py&quot;, line 3, in write
    assert self.allocated[address], \
           ~~~~~~~~~~~~~~^^^^^^^^^
AssertionError: Writing into unallocated memory (expected)
</pre></div>
</div>
</div>
</div>
<p>Freeing the same block twice also yields an error:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">managed_mem</span><span class="o">.</span><span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/3645412891.py&quot;, line 2, in &lt;module&gt;
    managed_mem.free(p)
    ~~~~~~~~~~~~~~~~^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_51171/193494573.py&quot;, line 10, in free
    assert self.allocated[base], \
           ~~~~~~~~~~~~~~^^^^^^
AssertionError: Freeing memory that is already freed (expected)
</pre></div>
</div>
</div>
</div>
<p>With this, we now have a mechanism in place to fully detect memory issues in languages such as C.</p>
<p>Obviously, keeping track of whether memory is allocated/initialized or not requires some extra memory – and also some extra computation time, as read and write accesses have to be checked first. During testing, however, such effort may quickly pay off, as memory bugs can be quickly discovered.</p>
<p>To detect memory errors, a number of tools have been developed. The first class of tools <em>interprets</em> the instructions of the executable code, tracking all memory accesses. For each memory access, they can check whether the memory accessed <em>exists</em> and has been <em>initialized</em> at some point.</p>
</section>
</section>
<section id="checking-memory-usage-with-valgrind">
<h3>Checking Memory Usage with Valgrind<a class="headerlink" href="#checking-memory-usage-with-valgrind" title="Link to this heading">#</a></h3>
<p>The <a class="reference external" href="https://www.valgrind.org">Valgrind</a> tool allows <em>interpreting</em> executable code, thus tracking each and every memory access. You can use Valgrind to execute any program from the command-line, and it will check all memory accesses during execution.</p>
<!-- Installing ValGrind on macOS: https://github.com/LouisBrunner/valgrind-macos/ -->
<p>Here’s what happens if we run Valgrind on our <code class="docutils literal notranslate"><span class="pre">testuseafterfree</span></code> program:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;testuseafterfree.c&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Cyan">#include</span><span class=" -Color -Color-White"> &lt;stdlib.h&gt;</span>

<span class=" -Color -Color-White">// Access a chunk of memory after it has been given back to the system</span>
<span class=" -Color -Color-Cyan">int</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">main</span>(<span class=" -Color -Color-Cyan">int</span><span class=" -Color -Color-White"> </span>argc,<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Cyan">char</span><span class=" -Color -Color-White"> </span>*argv[])<span class=" -Color -Color-White"> </span>{
<span class=" -Color -Color-White">    </span><span class=" -Color -Color-Cyan">int</span><span class=" -Color -Color-White"> </span>*array<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span>malloc(<span class=" -Color -Color-Blue">100</span><span class=" -Color -Color-White"> </span>*<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">sizeof</span>(<span class=" -Color -Color-Cyan">int</span>));
<span class=" -Color -Color-White">    </span>free(array);
<span class=" -Color -Color-White">    </span><span class=" -Color -Color-Blue">return</span><span class=" -Color -Color-White"> </span>array[<span class=" -Color -Color-Blue">10</span>];<span class=" -Color -Color-White">  // BOOM</span>
}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>valgrind<span class="w"> </span>./testuseafterfree
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>==77== Memcheck, a memory error detector
==77== Copyright (C) 2002-2017, and GNU GPL&#39;d, by Julian Seward et al.
==77== Using Valgrind-3.13.0 and LibVEX; rerun with -h for copyright info
==77== Command: ./testuseafterfree
==77== 
==77== Invalid read of size 4
==77==    at 0x1086B7: main (testuseafterfree.c:8)
==77==  Address 0x522f068 is 40 bytes inside a block of size 400 free&#39;d
==77==    at 0x4C32D3B: free (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==77==    by 0x1086B2: main (testuseafterfree.c:7)
==77==  Block was alloc&#39;d at
==77==    at 0x4C31B0F: malloc (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==77==    by 0x1086A2: main (testuseafterfree.c:6)
==77== 
==77== 
==77== HEAP SUMMARY:
==77==     in use at exit: 0 bytes in 0 blocks
==77==   total heap usage: 1 allocs, 1 frees, 400 bytes allocated
==77== 
==77== All heap blocks were freed -- no leaks are possible
==77== 
==77== For counts of detected and suppressed errors, rerun with: -v
==77== ERROR SUMMARY: 1 errors from 1 contexts (suppressed: 0 from 0)
</pre></div>
</div>
</div>
</div>
<p>We see that Valgrind has detected the issue (“Invalid read of size 4”) during execution; it also reported the current stack trace (and hence the location at which the error occurred). Note that the program continues execution even after the error occurred; should further errors occur, Valgrind will report these, too.</p>
<p>Being an interpreter, Valgrind slows down execution of programs dramatically. However, it requires no recompilation and thus can work on code (and libraries) whose source code is not available.</p>
<p>Valgrind is not perfect, though. For our <code class="docutils literal notranslate"><span class="pre">testoverflow</span></code> program, it fails to detect the illegal access:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;testoverflow.c&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>#include<span class=" -Color -Color-White"> </span>&lt;stdio.h&gt;

//<span class=" -Color -Color-White"> </span>Access<span class=" -Color -Color-White"> </span>memory<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">out</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">of</span><span class=" -Color -Color-White"> </span>bounds
<span class=" -Color -Color-Green">int</span><span class=" -Color -Color-White"> </span>main(<span class=" -Color -Color-Green">int</span><span class=" -Color -Color-White"> </span>argc,<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">char</span><span class=" -Color -Color-White"> </span>*argv[])<span class=" -Color -Color-White"> </span>{
<span class=" -Color -Color-White">    </span><span class=" -Color -Color-Green">int</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">index</span><span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">10</span>;
<span class=" -Color -Color-White">    </span><span class=" -Color -Color-Blue">return</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&quot;foo&quot;</span>[index];<span class=" -Color -Color-White">  </span>//<span class=" -Color -Color-White"> </span>BOOM
}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>valgrind<span class="w"> </span>./testoverflow
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>==78== Memcheck, a memory error detector
==78== Copyright (C) 2002-2017, and GNU GPL&#39;d, by Julian Seward et al.
==78== Using Valgrind-3.13.0 and LibVEX; rerun with -h for copyright info
==78== Command: ./testoverflow
==78== 
==78== 
==78== HEAP SUMMARY:
==78==     in use at exit: 0 bytes in 0 blocks
==78==   total heap usage: 0 allocs, 0 frees, 0 bytes allocated
==78== 
==78== All heap blocks were freed -- no leaks are possible
==78== 
==78== For counts of detected and suppressed errors, rerun with: -v
==78== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)
</pre></div>
</div>
</div>
</div>
<p>This is because at compile time, the information about the length of the <code class="docutils literal notranslate"><span class="pre">&quot;foo&quot;</span></code> string is no longer available – all Valgrind sees is a read access into the static data portion of the executable that may be valid or invalid. To actually detect such errors, we need to hook into the compiler.</p>
</section>
<section id="checking-memory-usage-with-memory-sanitizer">
<h3>Checking Memory Usage with Memory Sanitizer<a class="headerlink" href="#checking-memory-usage-with-memory-sanitizer" title="Link to this heading">#</a></h3>
<p>The second class of tools to detect memory issues are <em>address sanitizers</em>. An address sanitizer injects memory-checking code into the program <em>during compilation</em>. This means that every access will be checked – but this time, the code still runs on the processor itself, meaning that the speed is much less reduced.</p>
<p>Here is an example of how to use the address sanitizer of the Clang C compiler:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>cc<span class="w"> </span>-fsanitize<span class="o">=</span>address<span class="w"> </span>-o<span class="w"> </span>testuseafterfree<span class="w"> </span>testuseafterfree.c
</pre></div>
</div>
</div>
</div>
<p>At the very first moment we have an out-of-bounds access, the program aborts with a diagnostic message – in our case already during <code class="docutils literal notranslate"><span class="pre">read_overflow()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>./testuseafterfree
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=================================================================
<span class=" -Color -Color-Bold -Color-Bold-Red">==51274==ERROR: AddressSanitizer: heap-use-after-free on address 0x614000000068 at pc 0x00010414c61c bp 0x00016bcb2730 sp 0x00016bcb2728</span>
<span class=" -Color -Color-Bold -Color-Bold-Blue">READ of size 4 at 0x614000000068 thread T0</span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>    #0 0x00010414c618 in main+0x88 (testuseafterfree:arm64+0x100000618)
    #1 0x0001870c1d50 in start+0x1c0c (dyld:arm64e+0x3d50)

<span class=" -Color -Color-Bold -Color-Bold-Green">0x614000000068 is located 40 bytes inside of 400-byte region [0x614000000040,0x6140000001d0)</span>

</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold -Color-Bold-Magenta">freed by thread T0 here:</span>
    #0 0x000104811400 in free+0x7c (libclang_rt.asan_osx_dynamic.dylib:arm64e+0x3d400)
    #1 0x00010414c5c8 in main+0x38 (testuseafterfree:arm64+0x1000005c8)
    #2 0x0001870c1d50 in start+0x1c0c (dyld:arm64e+0x3d50)

<span class=" -Color -Color-Bold -Color-Bold-Magenta">previously allocated by thread T0 here:</span>
    #0 0x00010481130c in malloc+0x78 (libclang_rt.asan_osx_dynamic.dylib:arm64e+0x3d30c)
    #1 0x00010414c5bc in main+0x2c (testuseafterfree:arm64+0x1000005bc)
    #2 0x0001870c1d50 in start+0x1c0c (dyld:arm64e+0x3d50)

SUMMARY: AddressSanitizer: heap-use-after-free (testuseafterfree:arm64+0x100000618) in main+0x88
Shadow bytes around the buggy address:
  0x613ffffffd80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x613ffffffe00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x613ffffffe80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x613fffffff00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x613fffffff80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
=&gt;0x614000000000: <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span>[<span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span>]<span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span>
  0x614000000080: <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span>
  0x614000000100: <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span>
  0x614000000180: <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span>
  0x614000000200: <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span>
  0x614000000280: <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span> <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span>
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07 
  Heap left redzone:       <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span>
  Freed heap region:       <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span>
  Stack left redzone:      <span class=" -Color -Color-Bold -Color-Bold-Red">f1</span>
  Stack mid redzone:       <span class=" -Color -Color-Bold -Color-Bold-Red">f2</span>
  Stack right redzone:     <span class=" -Color -Color-Bold -Color-Bold-Red">f3</span>
  Stack after return:      <span class=" -Color -Color-Bold -Color-Bold-Magenta">f5</span>
  Stack use after scope:   <span class=" -Color -Color-Bold -Color-Bold-Magenta">f8</span>
  Global redzone:          <span class=" -Color -Color-Bold -Color-Bold-Red">f9</span>
  Global init order:       <span class=" -Color -Color-Bold -Color-Bold-Cyan">f6</span>
  Poisoned by user:        <span class=" -Color -Color-Bold -Color-Bold-Blue">f7</span>
  Container overflow:      <span class=" -Color -Color-Bold -Color-Bold-Blue">fc</span>
  Array cookie:            <span class=" -Color -Color-Bold -Color-Bold-Red">ac</span>
  Intra object redzone:    <span class=" -Color -Color-Bold -Color-Bold-Yellow">bb</span>
  ASan internal:           <span class=" -Color -Color-Bold -Color-Bold-Yellow">fe</span>
  Left alloca redzone:     <span class=" -Color -Color-Bold -Color-Bold-Blue">ca</span>
  Right alloca redzone:    <span class=" -Color -Color-Bold -Color-Bold-Blue">cb</span>
==51274==ABORTING
</pre></div>
</div>
</div>
</div>
<p>Likewise, if we apply the address sanitizer on <code class="docutils literal notranslate"><span class="pre">testoverflow</span></code>, we also immediately get an error:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>cc<span class="w"> </span>-fsanitize<span class="o">=</span>address<span class="w"> </span>-o<span class="w"> </span>testoverflow<span class="w"> </span>testoverflow.c
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>./testoverflow
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=================================================================
<span class=" -Color -Color-Bold -Color-Bold-Red">==51291==ERROR: AddressSanitizer: global-buffer-overflow on address 0x00010267094a at pc 0x000102670884 bp 0x00016d78e750 sp 0x00016d78e748</span>
<span class=" -Color -Color-Bold -Color-Bold-Blue">READ of size 1 at 0x00010267094a thread T0</span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>    #0 0x000102670880 in main+0x78 (testoverflow:arm64+0x100000880)
    #1 0x0001870c1d50 in start+0x1c0c (dyld:arm64e+0x3d50)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold -Color-Bold-Green">0x00010267094a is located 6 bytes after global variable &#39;.str&#39; defined in &#39;testoverflow.c&#39; (0x000102670940) of size 4</span>
  &#39;.str&#39; is ascii string &#39;foo&#39;
SUMMARY: AddressSanitizer: global-buffer-overflow (testoverflow:arm64+0x100000880) in main+0x78
Shadow bytes around the buggy address:
  0x000102670680: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x000102670700: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x000102670780: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x000102670800: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x000102670880: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
=&gt;0x000102670900: 00 00 00 00 00 00 00 00 04[<span class=" -Color -Color-Bold -Color-Bold-Red">f9</span>]<span class=" -Color -Color-Bold -Color-Bold-Red">f9</span> <span class=" -Color -Color-Bold -Color-Bold-Red">f9</span> 00 00 00 00
  0x000102670980: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x000102670a00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x000102670a80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x000102670b00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x000102670b80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07 
  Heap left redzone:       <span class=" -Color -Color-Bold -Color-Bold-Red">fa</span>
  Freed heap region:       <span class=" -Color -Color-Bold -Color-Bold-Magenta">fd</span>
  Stack left redzone:      <span class=" -Color -Color-Bold -Color-Bold-Red">f1</span>
  Stack mid redzone:       <span class=" -Color -Color-Bold -Color-Bold-Red">f2</span>
  Stack right redzone:     <span class=" -Color -Color-Bold -Color-Bold-Red">f3</span>
  Stack after return:      <span class=" -Color -Color-Bold -Color-Bold-Magenta">f5</span>
  Stack use after scope:   <span class=" -Color -Color-Bold -Color-Bold-Magenta">f8</span>
  Global redzone:          <span class=" -Color -Color-Bold -Color-Bold-Red">f9</span>
  Global init order:       <span class=" -Color -Color-Bold -Color-Bold-Cyan">f6</span>
  Poisoned by user:        <span class=" -Color -Color-Bold -Color-Bold-Blue">f7</span>
  Container overflow:      <span class=" -Color -Color-Bold -Color-Bold-Blue">fc</span>
  Array cookie:            <span class=" -Color -Color-Bold -Color-Bold-Red">ac</span>
  Intra object redzone:    <span class=" -Color -Color-Bold -Color-Bold-Yellow">bb</span>
  ASan internal:           <span class=" -Color -Color-Bold -Color-Bold-Yellow">fe</span>
  Left alloca redzone:     <span class=" -Color -Color-Bold -Color-Bold-Blue">ca</span>
  Right alloca redzone:    <span class=" -Color -Color-Bold -Color-Bold-Blue">cb</span>
==51291==ABORTING
</pre></div>
</div>
</div>
</div>
<p>Since the address sanitizer monitors each and every read and write, as well as usage of <code class="docutils literal notranslate"><span class="pre">free()</span></code>, it will require some effort to create a bug that it won’t catch. Also, while Valgrind runs the program ten times slower and more, the performance penalty for memory sanitization is much much lower. Sanitizers can also help in finding data races, memory leaks, and all other sorts of undefined behavior. As <a class="reference external" href="https://lemire.me/blog/2016/04/20/no-more-leaks-with-sanitize-flags-in-gcc-and-clang/">Daniel Lemire puts it</a>:</p>
<blockquote>
<div><p>Really, if you are using gcc or clang and you are not using these flags, you are not being serious.</p>
</div></blockquote>
</section>
</section>
<section id="when-should-invariants-be-checked">
<h2>When Should Invariants be Checked?<a class="headerlink" href="#when-should-invariants-be-checked" title="Link to this heading">#</a></h2>
<p>We have seen that during testing and debugging, invariants should be checked <em>as much as possible</em>, thus narrowing down the time it takes to detect a violation to a minimum. The easiest way to get there is to have them checked as <em>postcondition</em> in the constructor and any other method that sets the state of an object.</p>
<p>If you have means to alter the state of an object outside of these methods – for instance, by directly writing to memory, or by writing to internal attributes –, then you may have to check them even more frequently. Using the <a class="reference internal" href="Tracer.html"><span class="std std-doc">tracing infrastructure</span></a>, for instance, you can have the tracer invoke <code class="docutils literal notranslate"><span class="pre">repOK()</span></code> with each and every line executed, thereby again directly pinpointing the moment the state gets corrupted. While this will slow down execution tremendously, it is still better to have the computer do the work than you stepping backwards and forwards through an execution.</p>
<p>Another question is whether assertions should remain active even in production code. Assertions take time, and this may be too much for production.</p>
<section id="assertions-are-not-production-code">
<h3>Assertions are not Production Code<a class="headerlink" href="#assertions-are-not-production-code" title="Link to this heading">#</a></h3>
<p>First of all, assertions are <em>not</em> production code – the rest of the code should not be impacted by any assertion being on or off. If you write code like</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="nb">map</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
</pre></div>
</div>
<p>your assertion will have a side effect, namely removing a location from the map.  If one turns assertions off, the side effect will be turned off as well.  You need to change this into</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">locationRemoved</span> <span class="o">=</span> <span class="nb">map</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">locationRemoved</span>
</pre></div>
</div>
</section>
<section id="for-system-preconditions-use-production-code">
<h3>For System Preconditions, Use Production Code<a class="headerlink" href="#for-system-preconditions-use-production-code" title="Link to this heading">#</a></h3>
<p>Consequently, you should not rely on assertions for <em>system preconditions</em>  – that is, conditions that are necessary to keep the system running. System input (or anything that could be controlled by another party) still has to be validated by production code, not assertions. Critical conditions have to be checked by production code, not (only) assertions.</p>
<p>If you have code such as</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;open&quot;</span><span class="p">,</span> <span class="s2">&quot;close&quot;</span><span class="p">,</span> <span class="s2">&quot;exit&quot;</span><span class="p">}</span>
<span class="n">exec</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</pre></div>
</div>
<p>then having the assertion document and check your assumptions is fine. However, if you turn the assertion off in production code, it will only be a matter of time until somebody sets <code class="docutils literal notranslate"><span class="pre">command</span></code> to <code class="docutils literal notranslate"><span class="pre">'system(&quot;/bin/sh&quot;)'</span></code> and all of a sudden takes control over your system.</p>
</section>
<section id="consider-leaving-some-assertions-on">
<h3>Consider Leaving Some Assertions On<a class="headerlink" href="#consider-leaving-some-assertions-on" title="Link to this heading">#</a></h3>
<p>The main reason for turning assertions off is efficiency. However, <em>failing early is better than having bad data and not failing.</em> Think carefully which assertions have a high impact on execution time, and turn these off first. Assertions that have little to no impact on resources can be left on.</p>
<p>As an example, here’s a piece of code that handles traffic in a simulation. The <code class="docutils literal notranslate"><span class="pre">light</span></code> variable can be either <code class="docutils literal notranslate"><span class="pre">RED</span></code>, <code class="docutils literal notranslate"><span class="pre">AMBER</span></code>, or <code class="docutils literal notranslate"><span class="pre">GREEN</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">light</span> <span class="o">==</span> <span class="n">RED</span><span class="p">:</span>
   <span class="n">traffic</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
<span class="k">elif</span> <span class="n">light</span> <span class="o">==</span> <span class="n">AMBER</span><span class="p">:</span>
   <span class="n">traffic</span><span class="o">.</span><span class="n">prepare_to_stop</span><span class="p">()</span>
<span class="k">elif</span> <span class="n">light</span> <span class="o">==</span> <span class="n">GREEN</span><span class="p">:</span>
   <span class="n">traffic</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
   <span class="k">pass</span>   <span class="c1"># This can&#39;t happen!</span>
</pre></div>
</div>
<p>Having an assertion</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">light</span> <span class="ow">in</span> <span class="p">[</span><span class="n">RED</span><span class="p">,</span> <span class="n">AMBER</span><span class="p">,</span> <span class="n">GREEN</span><span class="p">]</span>
</pre></div>
</div>
<p>in your code will eat some (minor) resources. However, adding a line</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="kc">False</span>
</pre></div>
</div>
<p>in the place of the <code class="docutils literal notranslate"><span class="pre">This</span> <span class="pre">can't</span> <span class="pre">happen!</span></code> line, above, will still catch errors, but require no resources at all.</p>
<p>If you have very critical software, it may be wise to actually pay the extra penalty for assertions (notably system assertions) rather than sacrifice reliability for performance. Keeping a memory sanitizer on even in production can have a small impact on performance, but will catch plenty of errors before some corrupted data (and even some attacks) have bad effects downstream.</p>
</section>
<section id="define-how-your-application-should-handle-internal-errors">
<h3>Define How Your Application Should Handle Internal Errors<a class="headerlink" href="#define-how-your-application-should-handle-internal-errors" title="Link to this heading">#</a></h3>
<p>By default, failing assertions are not exactly user-friendly – the diagnosis they provide is of interest to the code maintainers only.  Think of how your application should handle internal errors as discovered by assertions (or the runtime system). Simply exiting (as assertions on C do) may not be the best option for critical software. Think about implementing your own assert functions with appropriate recovery methods.</p>
</section>
</section>
<section id="lessons-learned">
<h2>Lessons Learned<a class="headerlink" href="#lessons-learned" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><em>Assertions</em> are powerful tools to have the computer check invariants during execution:</p>
<ul>
<li><p><em>Preconditions</em> check whether the arguments to a function are correct</p></li>
<li><p><em>Postconditions</em> check whether the result of a function is correct</p></li>
<li><p><em>Data Invariants</em> allow checking data structures for integrity</p></li>
</ul>
</li>
<li><p>Since assertions can be turned off for optimization, they should</p>
<ul>
<li><p>not <em>change correct operation</em> in any way</p></li>
<li><p>not do <em>any work that your application requires for correct operation</em></p></li>
<li><p>not be used as a <em>replacement for errors that can possibly happen</em>; create permanent checks (and own exceptions) for these</p></li>
</ul>
</li>
<li><p><em>System assertions</em> are powerful tools to monitor the integrity of the runtime system (notably memory)</p></li>
<li><p>The more assertions,</p>
<ul>
<li><p>the earlier errors are detected</p></li>
<li><p>the easier it is to locate defects</p></li>
<li><p>the better the guidance towards failure causes during debugging</p></li>
</ul>
</li>
</ul>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell tag_remove-input docutils container">
</div>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Link to this heading">#</a></h2>
<p>In the next chapters, we will learn how to</p>
<ul class="simple">
<li><p><a class="reference internal" href="PerformanceDebugger.html"><span class="std std-doc">identify performance issues</span></a></p></li>
<li><p><a class="reference internal" href="Slicer.html"><span class="std std-doc">check flows and dependencies</span></a></p></li>
</ul>
</section>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">#</a></h2>
<p>The usage of <em>assertions</em> goes back to the earliest days of programming. In 1947, Neumann and Goldstine defined <em>assertion boxes</em> that would check the limits of specific variables. In his 1949 talk <a class="reference external" href="http://www.turingarchive.org/browse.php/B/8">“Checking a Large Routine”</a>, Alan Turing suggested</p>
<blockquote>
<div><p>How can one check a large routine in the sense of making sure that it’s right? In order that the man who checks may not have too difficult a task, the programmer should make a number of definite <em>assertions</em> which can be checked individually, and from which the correctness of the whole program easily follows.</p>
</div></blockquote>
<p><a class="reference external" href="https://valgrind.org">Valgrind</a> originated as an academic tool which has seen lots of industrial usage. A <a class="reference external" href="https://www.valgrind.org/docs/pubs.html">list of papers</a> is available on the Valgrind page.</p>
<p>The <a class="reference external" href="http://clang.llvm.org/docs/AddressSanitizer.html">Address Sanitizer</a> discussed in this chapter was developed at Google; the <a class="reference external" href="https://www.usenix.org/system/files/conference/atc12/atc12-final39.pdf">paper by Serebryany</a> discusses several details.</p>
</section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<section id="exercise-1-storage-assertions">
<h3>Exercise 1 – Storage Assertions<a class="headerlink" href="#exercise-1-storage-assertions" title="Link to this heading">#</a></h3>
<p>The Python <a class="reference external" href="https://docs.python.org/3/library/shelve.html"><code class="docutils literal notranslate"><span class="pre">shelve</span></code></a> module provides a simple interface for permanent storage of Python objects:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">shelve</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">shelve</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;mydb&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;123&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">123</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;123&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>123
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">shelve</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;mydb&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;123&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>123
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Based on <code class="docutils literal notranslate"><span class="pre">shelve</span></code>, we can implement a class <code class="docutils literal notranslate"><span class="pre">ObjectStorage</span></code> that uses a context manager (a <code class="docutils literal notranslate"><span class="pre">with</span></code> block) to ensure the shelve database is always closed - also in presence of exceptions:</p>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">types</span><span class="w"> </span><span class="kn">import</span> <span class="n">TracebackType</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Storage</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbname</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbname</span> <span class="o">=</span> <span class="n">dbname</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">shelve</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbname</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_tp</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">:</span> <span class="ne">BaseException</span><span class="p">,</span> 
                 <span class="n">exc_traceback</span><span class="p">:</span> <span class="n">TracebackType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Storage</span><span class="p">(</span><span class="s1">&#39;mydb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">storage</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">storage</span><span class="p">[</span><span class="s1">&#39;123&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>123
</pre></div>
</div>
</div>
</div>
<section id="task-1-local-consistency">
<h4>Task 1 – Local Consistency<a class="headerlink" href="#task-1-local-consistency" title="Link to this heading">#</a></h4>
<p>Extend <code class="docutils literal notranslate"><span class="pre">Storage</span></code> with assertions that ensure that after adding an element, it also can be retrieved with the same value.</p>
<p><strong>Solution.</strong> One single assertion suffices:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Storage</span><span class="p">(</span><span class="n">Storage</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="task-2-global-consistency">
<h4>Task 2 – Global Consistency<a class="headerlink" href="#task-2-global-consistency" title="Link to this heading">#</a></h4>
<p>Extend <code class="docutils literal notranslate"><span class="pre">Storage</span></code> with a “shadow dictionary” which holds elements in memory storage, too. Have a <code class="docutils literal notranslate"><span class="pre">repOK()</span></code> method that memory storage and <code class="docutils literal notranslate"><span class="pre">shelve</span></code> storage are identical at all times.</p>
<p><strong>Solution.</strong> Here is a possible implementation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ShadowStorage</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbname</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbname</span> <span class="o">=</span> <span class="n">dbname</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">shelve</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memdb</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memdb</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">repOK</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_tp</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">:</span> <span class="ne">BaseException</span><span class="p">,</span> 
                 <span class="n">exc_traceback</span><span class="p">:</span> <span class="n">TracebackType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">repOK</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">repOK</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memdb</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">repOK</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">repOK</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">memdb</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dbname</span><span class="si">}</span><span class="s2">: Differing keys&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">memdb</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">memdb</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> \
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dbname</span><span class="si">}</span><span class="s2">: Differing values for </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ShadowStorage</span><span class="p">(</span><span class="s1">&#39;mydb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">storage</span><span class="p">:</span>
    <span class="n">storage</span><span class="p">[</span><span class="s1">&#39;456&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">456</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">storage</span><span class="p">[</span><span class="s1">&#39;123&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>123
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell tag_remove-input docutils container">
</div>
</section>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Debugger.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">How Debuggers Work</p>
      </div>
    </a>
    <a class="right-next"
       href="Slicer.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Tracking Failure Origins</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introducing-assertions">Introducing Assertions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assertions">Assertions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assertion-diagnostics">Assertion Diagnostics</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-preconditions">Checking Preconditions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-results">Checking Results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assertions-and-tests">Assertions and Tests</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#partial-checks">Partial Checks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assertions-and-documentation">Assertions and Documentation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-assertions-to-trivially-locate-defects">Using Assertions to Trivially Locate Defects</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-data-structures">Checking Data Structures</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#times-and-time-bombs">Times and Time Bombs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#invariant-checkers">Invariant Checkers</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-checked-getters-and-setters-in-python">Excursion: Checked Getters and Setters in Python</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#end-of-excursion">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#large-data-structures">Large Data Structures</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#system-invariants">System Invariants</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-c-memory-model">The C Memory Model</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-a-c-memory-model-simulator">Excursion: A C Memory Model Simulator</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dynamic-memory">Dynamic Memory</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-dynamic-memory-in-c">Excursion: Dynamic Memory in C</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#managed-memory">Managed Memory</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-managed-memory">Excursion: Managed Memory</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-memory-usage-with-valgrind">Checking Memory Usage with Valgrind</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-memory-usage-with-memory-sanitizer">Checking Memory Usage with Memory Sanitizer</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#when-should-invariants-be-checked">When Should Invariants be Checked?</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assertions-are-not-production-code">Assertions are not Production Code</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#for-system-preconditions-use-production-code">For System Preconditions, Use Production Code</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#consider-leaving-some-assertions-on">Consider Leaving Some Assertions On</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-how-your-application-should-handle-internal-errors">Define How Your Application Should Handle Internal Errors</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-storage-assertions">Exercise 1 – Storage Assertions</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#task-1-local-consistency">Task 1 – Local Consistency</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#task-2-global-consistency">Task 2 – Global Consistency</a></li>
</ul>
</li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Andreas Zeller
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <div>
  Copyright &copy; 2021–2025 <a href="https://www.cispa.de/">CISPA Helmholtz Center for Information Security</a>.
  The <strong>content</strong> of this project is licensed under the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
  The <strong>source code</strong> that is part of the content, as well as the source code used to format and display that content is licensed under the <a href="https://github.com/uds-se/debuggingbook/blob/master/LICENSE.md#mit-license">MIT License</a>.
  <br>
  <a href="https://cispa.de/en/impressum">Imprint</a> &middot; <a href="/html/index.html#how-do-i-cite-your-work">Cite</a>
</div>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>